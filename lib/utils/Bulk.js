"use strict";

require("source-map-support/register");

class Bulk {
  constructor(limit, bulkAction, onProgress, total) {
    this.limit = limit;
    this.itemsTotal = total;
    this.bulkAction = bulkAction;
    this.onProgress = onProgress;
    this.itemsPending = 0;
    this.itemsDone = 0;
    this._buffer = [];
  }

  flush() {
    if (this._buffer.length > 0) {
      let bulkItems = this._buffer.concat();

      this._buffer = [];
      let l = bulkItems.length;
      this.itemsPending += l;
      Promise.resolve(this.bulkAction(bulkItems)).then(() => {
        this.itemsDone += l;

        if (this.onProgress) {
          this.onProgress(this.itemsPending, this.itemsDone, this.itemsTotal);
        }
      });
    }
  }

  add(item) {
    this._buffer.push(item);

    if (this._buffer.length >= this.limit) {
      this.flush();
    }
  }

  async waitToEnd_(interval, maxRounds) {
    return waitUntil_(() => this.itemsDone >= this.itemsPending, interval, maxRounds);
  }

}

module.exports = Bulk;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9CdWxrLmpzIl0sIm5hbWVzIjpbIkJ1bGsiLCJjb25zdHJ1Y3RvciIsImxpbWl0IiwiYnVsa0FjdGlvbiIsIm9uUHJvZ3Jlc3MiLCJ0b3RhbCIsIml0ZW1zVG90YWwiLCJpdGVtc1BlbmRpbmciLCJpdGVtc0RvbmUiLCJfYnVmZmVyIiwiZmx1c2giLCJsZW5ndGgiLCJidWxrSXRlbXMiLCJjb25jYXQiLCJsIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ0aGVuIiwiYWRkIiwiaXRlbSIsInB1c2giLCJ3YWl0VG9FbmRfIiwiaW50ZXJ2YWwiLCJtYXhSb3VuZHMiLCJ3YWl0VW50aWxfIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQU4sQ0FBVztBQUNQQyxFQUFBQSxXQUFXLENBQUNDLEtBQUQsRUFBUUMsVUFBUixFQUFvQkMsVUFBcEIsRUFBZ0NDLEtBQWhDLEVBQXVDO0FBQzlDLFNBQUtILEtBQUwsR0FBYUEsS0FBYjtBQUNBLFNBQUtJLFVBQUwsR0FBa0JELEtBQWxCO0FBQ0EsU0FBS0YsVUFBTCxHQUFrQkEsVUFBbEI7QUFDQSxTQUFLQyxVQUFMLEdBQWtCQSxVQUFsQjtBQUVBLFNBQUtHLFlBQUwsR0FBb0IsQ0FBcEI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCLENBQWpCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLEVBQWY7QUFDSDs7QUFFREMsRUFBQUEsS0FBSyxHQUFHO0FBQ0osUUFBSSxLQUFLRCxPQUFMLENBQWFFLE1BQWIsR0FBc0IsQ0FBMUIsRUFBNkI7QUFDekIsVUFBSUMsU0FBUyxHQUFHLEtBQUtILE9BQUwsQ0FBYUksTUFBYixFQUFoQjs7QUFDQSxXQUFLSixPQUFMLEdBQWUsRUFBZjtBQUVBLFVBQUlLLENBQUMsR0FBR0YsU0FBUyxDQUFDRCxNQUFsQjtBQUNBLFdBQUtKLFlBQUwsSUFBcUJPLENBQXJCO0FBRUFDLE1BQUFBLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQixLQUFLYixVQUFMLENBQWdCUyxTQUFoQixDQUFoQixFQUE0Q0ssSUFBNUMsQ0FBaUQsTUFBTTtBQUNuRCxhQUFLVCxTQUFMLElBQWtCTSxDQUFsQjs7QUFFQSxZQUFJLEtBQUtWLFVBQVQsRUFBcUI7QUFDakIsZUFBS0EsVUFBTCxDQUFnQixLQUFLRyxZQUFyQixFQUFtQyxLQUFLQyxTQUF4QyxFQUFtRCxLQUFLRixVQUF4RDtBQUNIO0FBQ0osT0FORDtBQU9IO0FBQ0o7O0FBRURZLEVBQUFBLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ04sU0FBS1YsT0FBTCxDQUFhVyxJQUFiLENBQWtCRCxJQUFsQjs7QUFFQSxRQUFJLEtBQUtWLE9BQUwsQ0FBYUUsTUFBYixJQUF1QixLQUFLVCxLQUFoQyxFQUF1QztBQUNuQyxXQUFLUSxLQUFMO0FBQ0g7QUFDSjs7QUFFRCxRQUFNVyxVQUFOLENBQWlCQyxRQUFqQixFQUEyQkMsU0FBM0IsRUFBc0M7QUFDbEMsV0FBT0MsVUFBVSxDQUFDLE1BQU0sS0FBS2hCLFNBQUwsSUFBa0IsS0FBS0QsWUFBOUIsRUFBNENlLFFBQTVDLEVBQXNEQyxTQUF0RCxDQUFqQjtBQUNIOztBQXhDTTs7QUEyQ1hFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFCLElBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgQnVsayB7XG4gICAgY29uc3RydWN0b3IobGltaXQsIGJ1bGtBY3Rpb24sIG9uUHJvZ3Jlc3MsIHRvdGFsKSB7XG4gICAgICAgIHRoaXMubGltaXQgPSBsaW1pdDsgXG4gICAgICAgIHRoaXMuaXRlbXNUb3RhbCA9IHRvdGFsO1xuICAgICAgICB0aGlzLmJ1bGtBY3Rpb24gPSBidWxrQWN0aW9uO1xuICAgICAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBvblByb2dyZXNzO1xuXG4gICAgICAgIHRoaXMuaXRlbXNQZW5kaW5nID0gMDtcbiAgICAgICAgdGhpcy5pdGVtc0RvbmUgPSAwO1xuICAgICAgICB0aGlzLl9idWZmZXIgPSBbXTsgICAgICAgICAgICAgIFxuICAgIH1cblxuICAgIGZsdXNoKCkgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLl9idWZmZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IGJ1bGtJdGVtcyA9IHRoaXMuX2J1ZmZlci5jb25jYXQoKTtcbiAgICAgICAgICAgIHRoaXMuX2J1ZmZlciA9IFtdO1xuXG4gICAgICAgICAgICBsZXQgbCA9IGJ1bGtJdGVtcy5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLml0ZW1zUGVuZGluZyArPSBsO1xuXG4gICAgICAgICAgICBQcm9taXNlLnJlc29sdmUodGhpcy5idWxrQWN0aW9uKGJ1bGtJdGVtcykpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaXRlbXNEb25lICs9IGw7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5vblByb2dyZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Qcm9ncmVzcyh0aGlzLml0ZW1zUGVuZGluZywgdGhpcy5pdGVtc0RvbmUsIHRoaXMuaXRlbXNUb3RhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGQoaXRlbSkge1xuICAgICAgICB0aGlzLl9idWZmZXIucHVzaChpdGVtKTtcblxuICAgICAgICBpZiAodGhpcy5fYnVmZmVyLmxlbmd0aCA+PSB0aGlzLmxpbWl0KSB7XG4gICAgICAgICAgICB0aGlzLmZsdXNoKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyB3YWl0VG9FbmRfKGludGVydmFsLCBtYXhSb3VuZHMpIHtcbiAgICAgICAgcmV0dXJuIHdhaXRVbnRpbF8oKCkgPT4gdGhpcy5pdGVtc0RvbmUgPj0gdGhpcy5pdGVtc1BlbmRpbmcsIGludGVydmFsLCBtYXhSb3VuZHMpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBCdWxrOyJdfQ==