"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const OolCodeGen = require('../../../lang/OolCodeGen');

const OolUtils = require('../../../lang/OolUtils');

class MySQLReverseEngineering {
  constructor(context, connector) {
    this.logger = context.logger;
    this.connector = connector;
    this.reverseRules = this.connector.options.reverseRules || {};
    this.saveDatabaseMeta = this.connector.options.saveDatabaseMeta || false;
  }

  async reverse_(outputDir) {
    this.logger.log('verbose', `Reverse engineering against ${this.connector.driver} database "${this.connector.database}" ...`);
    fs.ensureDirSync(outputDir);
    let tables = await this.connector.execute_("select * from information_schema.tables where table_schema = ?", [this.connector.database]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(outputDir, this.connector.database + '.meta.json'), JSON.stringify(tables, null, 2));
    }

    let entities = [],
        mapOfEntities = {};
    let entitiesOolPath = path.join(outputDir, 'entities');
    fs.ensureDirSync(entitiesOolPath);
    await Util.eachAsync_(tables, async table => {
      let entityName = this._entityNaming(table.TABLE_NAME);

      entities.push({
        entity: entityName
      });
      mapOfEntities[entityName] = await this.extractTable_(entityName, table, entitiesOolPath);
    });

    this._refineEntityRelationships(mapOfEntities);

    _.forOwn(mapOfEntities, ({
      types,
      entityInfo
    }, entityName) => {
      let entity = {
        type: types,
        entity: {
          [entityName]: entityInfo
        }
      };
      let entityContent = OolCodeGen.transform(entity);
      let entityFile = path.join(entitiesOolPath, entityName + '.ool');
      fs.writeFileSync(entityFile + '.json', JSON.stringify(entity, null, 2));
      fs.writeFileSync(entityFile, entityContent);
      this.logger.log('info', `Extracted entity definition file "${entityFile}".`);
    });

    let schemaName = this._schemaNaming(this.connector.database);

    let json = {
      "namespace": ["entities/**"],
      "schema": {
        [schemaName]: {
          "entities": entities
        }
      }
    };
    let schemaContent = OolCodeGen.transform(json);
    let schemaFile = path.join(outputDir, schemaName + '.ool');
    fs.writeFileSync(schemaFile + '.json', JSON.stringify(json, null, 2));
    fs.writeFileSync(schemaFile, schemaContent);
    this.logger.log('info', `Extracted schema entry file "${schemaFile}".`);
  }

  async extractTable_(entityName, table, extractedOolPath) {
    let columns = await this.connector.execute_("select * from information_schema.columns where table_schema = ? and table_name = ?", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.meta.json'), JSON.stringify(columns, null, 2));
    }

    let {
      features,
      fields,
      types
    } = this._processFields(table, columns);

    let indexInfo = await this.connector.execute_("SHOW INDEXES FROM ??", [table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(indexInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.index.json'), JSON.stringify(indexInfo, null, 2));
    }

    let {
      pk,
      indexes,
      mapNameToIndex
    } = this._processIndexes(indexInfo);

    if (!(pk.length > 0)) {
      throw new Error("Assertion failed: pk.length > 0");
    }

    let referencesInfo = await this.connector.execute_("SELECT * FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE `REFERENCED_TABLE_SCHEMA` = ? AND `TABLE_NAME` = ? AND `REFERENCED_TABLE_NAME` IS NOT NULL", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(referencesInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.ref.json'), JSON.stringify(referencesInfo, null, 2));
    }

    let associations = await this._processReferences_(referencesInfo, mapNameToIndex, fields);
    let entityInfo = {
      comment: table.TABLE_COMMENT,
      features,
      fields,
      associations,
      key: pk.length > 1 ? pk : pk[0],
      indexes
    };

    if (entityName !== table.TABLE_NAME) {
      entityInfo.code = table.TABLE_NAME;
    }

    return {
      types,
      entityInfo
    };
  }

  async _processReferences_(referencesInfo, mapNameToIndex, fields) {
    let associations = [];
    let l = referencesInfo.length;

    for (let i = 0; i < l; i++) {
      let ref = referencesInfo[i];
      let [refTableKey] = await this.connector.execute_("SHOW INDEXES FROM ?? WHERE `Key_name` = 'PRIMARY'", [ref.REFERENCED_TABLE_NAME]);

      if (refTableKey.Column_name.toLowerCase() !== ref.REFERENCED_COLUMN_NAME.toLowerCase()) {
        throw new Error(`Foreign key "${ref.COLUMN_NAME}" not reference to the primary key.`);
      }

      let unique = false;
      let fkInfo = mapNameToIndex[ref.CONSTRAINT_NAME];

      if (fkInfo) {
        if (fkInfo.length > 1) {
          throw new Error(`Combination foreign key is not supported: "${ref.CONSTRAINT_NAME}"`);
        }

        unique = fkInfo[0].Non_unique === 0;
      }

      let fkColName = this._fieldNaming(ref.COLUMN_NAME);

      if (unique) {
        associations.push({
          type: 'belongsTo',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      } else {
        associations.push({
          type: 'hasMany',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      }

      delete fields[fkColName];
    }

    return associations;
  }

  _processIndexes(indexInfo) {
    let pk = [],
        indexes = [];
    let mapNameToIndex = {};
    indexInfo.forEach(i => {
      Util.putIntoBucket(mapNameToIndex, i.Key_name, i);
    });

    _.forOwn(mapNameToIndex, (fields, name) => {
      if (name === 'PRIMARY') {
        pk.push(fields.map(f => this._fieldNaming(f.Column_name)));
      } else {
        indexes.push({
          name: name,
          fields: fields.map(f => this._fieldNaming(f.Column_name)),
          unique: fields[0].Non_unique === 0,
          nullable: fields[0].Null === 'YES'
        });
      }
    });

    return {
      pk,
      indexes,
      mapNameToIndex
    };
  }

  _processFields(table, columns) {
    let features = [],
        fields = {},
        types = {};
    columns.forEach(col => {
      let fieldName = this._fieldNaming(col.COLUMN_NAME);

      if (col.EXTRA === 'auto_increment') {
        let featureInfo = {
          "name": "autoId",
          "options": table.AUTO_INCREMENT ? {
            "startFrom": table.AUTO_INCREMENT
          } : {}
        };

        if (fieldName !== 'id') {
          featureInfo.options.name = fieldName;
        }

        features.push(featureInfo);
        return;
      }

      if (col.COLUMN_DEFAULT === 'CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "createTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (col.EXTRA === 'on update CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "updateTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (fieldName === 'isDeleted' && col.COLUMN_TYPE === 'tinyint(1)') {
        let featureInfo = {
          "name": "logicalDeletion"
        };
        features.push(featureInfo);
        return;
      }

      let fieldInfo = this._mysqlTypeToOolType(table, col, fieldName, types);

      if (col.IS_NULLABLE === 'YES') {
        fieldInfo.optional = true;
      }

      if (col.COLUMN_DEFAULT) {
        fieldInfo.default = col.COLUMN_DEFAULT;
      }

      if (col.COLUMN_COMMENT) {
        fieldInfo.comment = col.COLUMN_COMMENT;
      }

      fields[fieldName] = fieldInfo;
    });
    return {
      features,
      fields,
      types
    };
  }

  _fieldNaming(name) {
    if (this.reverseRules.fieldNaming) {
      return this.reverseRules.fieldNamin(name);
    }

    return OolUtils.fieldNaming(name);
  }

  _entityNaming(name) {
    if (this.reverseRules.entityNaming) {
      return this.reverseRules.entityNaming(name);
    }

    return OolUtils.entityNaming(name);
  }

  _schemaNaming(name) {
    if (this.reverseRules.schemaNaming) {
      return this.reverseRules.schemaNaming(name);
    }

    return OolUtils.schemaNaming(name);
  }

  _mysqlTypeToOolType(table, col, fieldName, types) {
    let applicableRule = _.find(this.reverseRules.columnTypeConversion, rule => rule.test(table, col));

    if (applicableRule) {
      return applicableRule.apply(table, col);
    }

    let typeInfo = {};

    if (col.COLUMN_NAME !== fieldName) {
      typeInfo.code = col.COLUMN_NAME;
    }

    switch (col.DATA_TYPE) {
      case 'varchar':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'char':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.fixedLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'bigint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 18;
        typeInfo.bytes = 8;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'int':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 10;
        typeInfo.bytes = 4;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'mediumint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 7;
        typeInfo.bytes = 3;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'smallint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 4;
        typeInfo.bytes = 2;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'tinyint':
        if (_.startsWith(col.COLUMN_TYPE, 'tinyint(1)')) {
          typeInfo.type = 'boolean';
        } else {
          typeInfo.type = 'integer';
          typeInfo.digits = col.NUMERIC_PRECISION || 2;
          typeInfo.bytes = 1;
          if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        }

        break;

      case 'enum':
        let left = col.COLUMN_TYPE.indexOf('(');
        let right = col.COLUMN_TYPE.lastIndexOf(')');

        let typeName = table.TABLE_NAME + _.upperFirst(col.COLUMN_NAME);

        types[typeName] = {
          type: 'enum',
          values: col.COLUMN_TYPE.substring(left + 1, right).split(',').map(v => v.substr(1, v.length - 2))
        };
        typeInfo.type = typeName;
        break;

      case 'text':
        typeInfo.type = 'text';
        typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        break;

      case 'datetime':
      case 'timestamp':
        typeInfo.type = 'datetime';
        break;

      case 'decimal':
        typeInfo.type = 'decimal';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      case 'float':
        typeInfo.type = 'float';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      default:
        console.log(col);
        throw new Error('To be implemented.');
    }

    return typeInfo;
  }

  _refineEntityRelationships(mapOfEntities) {
    let entityAssoc = {};

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      if (_.isEmpty(entityInfo.associations)) return;
      entityInfo.associations.forEach(({
        type,
        from,
        entity
      }) => {
        let refedEntity = mapOfEntities[entity];

        let backRef = _.find(refedEntity.associations, assoc => assoc.entity === name);

        if (type === 'hasMany') {
          if (!backRef) {
            Util.putIntoBucket(entityAssoc, name, {
              type: 'refersTo',
              from,
              entity
            });
            return;
          }

          console.log(entityInfo);
          throw new Error(`Back reference: ${backRef.entity} ${backRef.type} ${name}`);
        } else if (type === 'belongsTo') {
          Util.putIntoBucket(entityAssoc, name, {
            type,
            from,
            entity
          });

          if (!backRef) {
            Util.putIntoBucket(entityAssoc, entity, {
              type: 'hasMany',
              entity: name
            });
            return;
          }
        } else {
          throw new Error('Unexpected association type: ' + type);
        }
      });
    });

    _.forOwn(entityAssoc, (associations, name) => {
      let {
        entityInfo
      } = mapOfEntities[name];
      let keyAssocs;

      if (Array.isArray(entityInfo.key) && entityInfo.key.length === 2) {
        keyAssocs = _.filter(associations, assoc => entityInfo.key.indexOf(assoc.from) !== -1);

        if (keyAssocs.length === 2) {
          this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
        }
      }

      entityInfo.indexes.forEach(({
        fields
      }) => {
        if (fields.length === 2) {
          keyAssocs = _.filter(associations, assoc => fields.indexOf(assoc.from) !== -1);

          if (keyAssocs.length === 2) {
            this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
          }
        }
      });
    });

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      entityInfo.associations = entityAssoc[name];
    });
  }

  _makeEntityManyToMany(entityName1, entityName2, entityAssoc) {
    Util.putIntoBucket(entityAssoc, entityName1, {
      type: 'hasMany',
      entity: entityName2
    });
    Util.putIntoBucket(entityAssoc, entityName2, {
      type: 'hasMany',
      entity: entityName1
    });
  }

}

module.exports = MySQLReverseEngineering;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbGVyL2RhdGFiYXNlL215c3FsL1JldmVyc2VFbmdpbmVlcmluZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJPb2xDb2RlR2VuIiwiT29sVXRpbHMiLCJNeVNRTFJldmVyc2VFbmdpbmVlcmluZyIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImNvbm5lY3RvciIsImxvZ2dlciIsInJldmVyc2VSdWxlcyIsIm9wdGlvbnMiLCJzYXZlRGF0YWJhc2VNZXRhIiwicmV2ZXJzZV8iLCJvdXRwdXREaXIiLCJsb2ciLCJkcml2ZXIiLCJkYXRhYmFzZSIsImVuc3VyZURpclN5bmMiLCJ0YWJsZXMiLCJleGVjdXRlXyIsIndyaXRlRmlsZVN5bmMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVudGl0aWVzIiwibWFwT2ZFbnRpdGllcyIsImVudGl0aWVzT29sUGF0aCIsImVhY2hBc3luY18iLCJ0YWJsZSIsImVudGl0eU5hbWUiLCJfZW50aXR5TmFtaW5nIiwiVEFCTEVfTkFNRSIsInB1c2giLCJlbnRpdHkiLCJleHRyYWN0VGFibGVfIiwiX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMiLCJmb3JPd24iLCJ0eXBlcyIsImVudGl0eUluZm8iLCJ0eXBlIiwiZW50aXR5Q29udGVudCIsInRyYW5zZm9ybSIsImVudGl0eUZpbGUiLCJzY2hlbWFOYW1lIiwiX3NjaGVtYU5hbWluZyIsImpzb24iLCJzY2hlbWFDb250ZW50Iiwic2NoZW1hRmlsZSIsImV4dHJhY3RlZE9vbFBhdGgiLCJjb2x1bW5zIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJfcHJvY2Vzc0ZpZWxkcyIsImluZGV4SW5mbyIsImlzRW1wdHkiLCJwayIsImluZGV4ZXMiLCJtYXBOYW1lVG9JbmRleCIsIl9wcm9jZXNzSW5kZXhlcyIsImxlbmd0aCIsInJlZmVyZW5jZXNJbmZvIiwiYXNzb2NpYXRpb25zIiwiX3Byb2Nlc3NSZWZlcmVuY2VzXyIsImNvbW1lbnQiLCJUQUJMRV9DT01NRU5UIiwia2V5IiwiY29kZSIsImwiLCJpIiwicmVmIiwicmVmVGFibGVLZXkiLCJSRUZFUkVOQ0VEX1RBQkxFX05BTUUiLCJDb2x1bW5fbmFtZSIsInRvTG93ZXJDYXNlIiwiUkVGRVJFTkNFRF9DT0xVTU5fTkFNRSIsIkVycm9yIiwiQ09MVU1OX05BTUUiLCJ1bmlxdWUiLCJma0luZm8iLCJDT05TVFJBSU5UX05BTUUiLCJOb25fdW5pcXVlIiwiZmtDb2xOYW1lIiwiX2ZpZWxkTmFtaW5nIiwiZnJvbSIsImZvckVhY2giLCJwdXRJbnRvQnVja2V0IiwiS2V5X25hbWUiLCJuYW1lIiwibWFwIiwiZiIsIm51bGxhYmxlIiwiTnVsbCIsImNvbCIsImZpZWxkTmFtZSIsIkVYVFJBIiwiZmVhdHVyZUluZm8iLCJBVVRPX0lOQ1JFTUVOVCIsIkNPTFVNTl9ERUZBVUxUIiwiQ09MVU1OX1RZUEUiLCJmaWVsZEluZm8iLCJfbXlzcWxUeXBlVG9Pb2xUeXBlIiwiSVNfTlVMTEFCTEUiLCJvcHRpb25hbCIsImRlZmF1bHQiLCJDT0xVTU5fQ09NTUVOVCIsImZpZWxkTmFtaW5nIiwiZmllbGROYW1pbiIsImVudGl0eU5hbWluZyIsInNjaGVtYU5hbWluZyIsImFwcGxpY2FibGVSdWxlIiwiZmluZCIsImNvbHVtblR5cGVDb252ZXJzaW9uIiwicnVsZSIsInRlc3QiLCJhcHBseSIsInR5cGVJbmZvIiwiREFUQV9UWVBFIiwiQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIIiwibWF4TGVuZ3RoIiwiZml4ZWRMZW5ndGgiLCJkaWdpdHMiLCJOVU1FUklDX1BSRUNJU0lPTiIsImJ5dGVzIiwiZW5kc1dpdGgiLCJ1bnNpZ25lZCIsInN0YXJ0c1dpdGgiLCJsZWZ0IiwiaW5kZXhPZiIsInJpZ2h0IiwibGFzdEluZGV4T2YiLCJ0eXBlTmFtZSIsInVwcGVyRmlyc3QiLCJ2YWx1ZXMiLCJzdWJzdHJpbmciLCJzcGxpdCIsInYiLCJzdWJzdHIiLCJ0b3RhbERpZ2l0cyIsImRlY2ltYWxEaWdpdHMiLCJOVU1FUklDX1NDQUxFIiwiY29uc29sZSIsImVudGl0eUFzc29jIiwicmVmZWRFbnRpdHkiLCJiYWNrUmVmIiwiYXNzb2MiLCJrZXlBc3NvY3MiLCJBcnJheSIsImlzQXJyYXkiLCJmaWx0ZXIiLCJfbWFrZUVudGl0eU1hbnlUb01hbnkiLCJlbnRpdHlOYW1lMSIsImVudGl0eU5hbWUyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZRixJQUFsQjs7QUFDQSxNQUFNRyxVQUFVLEdBQUdKLE9BQU8sQ0FBQywwQkFBRCxDQUExQjs7QUFDQSxNQUFNSyxRQUFRLEdBQUdMLE9BQU8sQ0FBQyx3QkFBRCxDQUF4Qjs7QUFFQSxNQUFNTSx1QkFBTixDQUE4QjtBQUMxQkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLFNBQVYsRUFBcUI7QUFDNUIsU0FBS0MsTUFBTCxHQUFjRixPQUFPLENBQUNFLE1BQXRCO0FBQ0EsU0FBS0QsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLRSxZQUFMLEdBQW9CLEtBQUtGLFNBQUwsQ0FBZUcsT0FBZixDQUF1QkQsWUFBdkIsSUFBdUMsRUFBM0Q7QUFDQSxTQUFLRSxnQkFBTCxHQUF3QixLQUFLSixTQUFMLENBQWVHLE9BQWYsQ0FBdUJDLGdCQUF2QixJQUEyQyxLQUFuRTtBQUNIOztBQUVELFFBQU1DLFFBQU4sQ0FBZUMsU0FBZixFQUEwQjtBQUN0QixTQUFLTCxNQUFMLENBQVlNLEdBQVosQ0FBZ0IsU0FBaEIsRUFBNEIsK0JBQThCLEtBQUtQLFNBQUwsQ0FBZVEsTUFBTyxjQUFhLEtBQUtSLFNBQUwsQ0FBZVMsUUFBUyxPQUFySDtBQUVBZixJQUFBQSxFQUFFLENBQUNnQixhQUFI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SUFBQUEsSUFBSSxDQUFDc0YsYUFBTCxDQUFtQndELFdBQW5CLEVBQWdDUyxXQUFoQyxFQUE2QztBQUFFL0csTUFBQUEsSUFBSSxFQUFFLFNBQVI7QUFBbUJOLE1BQUFBLE1BQU0sRUFBRXNIO0FBQTNCLEtBQTdDO0FBQ0F4SixJQUFBQSxJQUFJLENBQUNzRixhQUFMLENBQW1Cd0QsV0FBbkIsRUFBZ0NVLFdBQWhDLEVBQTZDO0FBQUVoSCxNQUFBQSxJQUFJLEVBQUUsU0FBUjtBQUFtQk4sTUFBQUEsTUFBTSxFQUFFcUg7QUFBM0IsS0FBN0M7QUFDSDs7QUFoY3lCOztBQW1jOUJFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJKLHVCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgZnMgfSA9IFV0aWw7XG5jb25zdCBPb2xDb2RlR2VuID0gcmVxdWlyZSgnLi4vLi4vLi4vbGFuZy9Pb2xDb2RlR2VuJyk7XG5jb25zdCBPb2xVdGlscyA9IHJlcXVpcmUoJy4uLy4uLy4uL2xhbmcvT29sVXRpbHMnKTtcblxuY2xhc3MgTXlTUUxSZXZlcnNlRW5naW5lZXJpbmcge1xuICAgIGNvbnN0cnVjdG9yKGNvbnRleHQsIGNvbm5lY3Rvcikge1xuICAgICAgICB0aGlzLmxvZ2dlciA9IGNvbnRleHQubG9nZ2VyO1xuICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjsgICAgICAgIFxuXG4gICAgICAgIHRoaXMucmV2ZXJzZVJ1bGVzID0gdGhpcy5jb25uZWN0b3Iub3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwge307ICAgICAgIFxuICAgICAgICB0aGlzLnNhdmVEYXRhYmFzZU1ldGEgPSB0aGlzLmNvbm5lY3Rvci5vcHRpb25zLnNhdmVEYXRhYmFzZU1ldGEgfHwgZmFsc2U7XG4gICAgfVxuXG4gICAgYXN5bmMgcmV2ZXJzZV8ob3V0cHV0RGlyKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZygndmVyYm9zZScsIGBSZXZlcnNlIGVuZ2luZWVyaW5nIGFnYWluc3QgJHt0aGlzLmNvbm5lY3Rvci5kcml2ZXJ9IGRhdGFiYXNlIFwiJHt0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZX1cIiAuLi5gKTtcblxuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKG91dHB1dERpcik7XG5cbiAgICAgICAgbGV0IHRhYmxlcyA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwic2VsZWN0ICogZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIHdoZXJlIHRhYmxlX3NjaGVtYSA9ID9cIiwgWyB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSBdKTsgICAgICAgIFxuXG4gICAgICAgIGlmICh0aGlzLnNhdmVEYXRhYmFzZU1ldGEpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKG91dHB1dERpciwgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UgKyAnLm1ldGEuanNvbicpLCBKU09OLnN0cmluZ2lmeSh0YWJsZXMsIG51bGwsIDIpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBlbnRpdGllcyA9IFtdLCBtYXBPZkVudGl0aWVzID0ge307XG4gICAgICAgIFxuICAgICAgICBsZXQgZW50aXRpZXNPb2xQYXRoID0gcGF0aC5qb2luKG91dHB1dERpciwgJ2VudGl0aWVzJyk7XG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMoZW50aXRpZXNPb2xQYXRoKTtcblxuICAgICAgICBhd2FpdCBVdGlsLmVhY2hBc3luY18odGFibGVzLCBhc3luYyB0YWJsZSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IHRoaXMuX2VudGl0eU5hbWluZyh0YWJsZS5UQUJMRV9OQU1FKTtcblxuICAgICAgICAgICAgZW50aXRpZXMucHVzaCh7IGVudGl0eTogZW50aXR5TmFtZSB9KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgbWFwT2ZFbnRpdGllc1tlbnRpdHlOYW1lXSA9IGF3YWl0IHRoaXMuZXh0cmFjdFRhYmxlXyhlbnRpdHlOYW1lLCB0YWJsZSwgZW50aXRpZXNPb2xQYXRoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fcmVmaW5lRW50aXR5UmVsYXRpb25zaGlwcyhtYXBPZkVudGl0aWVzKTtcblxuICAgICAgICBfLmZvck93bihtYXBPZkVudGl0aWVzLCAoeyB0eXBlcywgZW50aXR5SW5mbyB9LCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZW50aXR5ID0ge1xuICAgICAgICAgICAgICAgIHR5cGU6IHR5cGVzLFxuICAgICAgICAgICAgICAgIGVudGl0eToge1xuICAgICAgICAgICAgICAgICAgICBbZW50aXR5TmFtZV06IGVudGl0eUluZm9cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgIFxuICAgICAgICAgICAgbGV0IGVudGl0eUNvbnRlbnQgPSBPb2xDb2RlR2VuLnRyYW5zZm9ybShlbnRpdHkpO1xuICAgICAgICAgICAgbGV0IGVudGl0eUZpbGUgPSBwYXRoLmpvaW4oZW50aXRpZXNPb2xQYXRoLCBlbnRpdHlOYW1lICsgJy5vb2wnKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZW50aXR5RmlsZSArICcuanNvbicsIEpTT04uc3RyaW5naWZ5KGVudGl0eSwgbnVsbCwgMikpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhlbnRpdHlGaWxlLCBlbnRpdHlDb250ZW50KTtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGBFeHRyYWN0ZWQgZW50aXR5IGRlZmluaXRpb24gZmlsZSBcIiR7ZW50aXR5RmlsZX1cIi5gKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHNjaGVtYU5hbWUgPSB0aGlzLl9zY2hlbWFOYW1pbmcodGhpcy5jb25uZWN0b3IuZGF0YWJhc2UpO1xuXG4gICAgICAgIGxldCBqc29uID0ge1xuICAgICAgICAgICAgXCJuYW1lc3BhY2VcIjogW1xuICAgICAgICAgICAgICAgIFwiZW50aXRpZXMvKipcIlxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFwic2NoZW1hXCI6IHtcbiAgICAgICAgICAgICAgICBbc2NoZW1hTmFtZV06IHtcbiAgICAgICAgICAgICAgICAgICAgXCJlbnRpdGllc1wiOiBlbnRpdGllcyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgc2NoZW1hQ29udGVudCA9IE9vbENvZGVHZW4udHJhbnNmb3JtKGpzb24pO1xuICAgICAgICBsZXQgc2NoZW1hRmlsZSA9IHBhdGguam9pbihvdXRwdXREaXIsIHNjaGVtYU5hbWUgKyAnLm9vbCcpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNjaGVtYUZpbGUgKyAnLmpzb24nLCBKU09OLnN0cmluZ2lmeShqc29uLCBudWxsLCAyKSk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoc2NoZW1hRmlsZSwgc2NoZW1hQ29udGVudCk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGBFeHRyYWN0ZWQgc2NoZW1hIGVudHJ5IGZpbGUgXCIke3NjaGVtYUZpbGV9XCIuYCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZXh0cmFjdFRhYmxlXyhlbnRpdHlOYW1lLCB0YWJsZSwgZXh0cmFjdGVkT29sUGF0aCkge1xuICAgICAgICBsZXQgY29sdW1ucyA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwic2VsZWN0ICogZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEuY29sdW1ucyB3aGVyZSB0YWJsZV9zY2hlbWEgPSA/IGFuZCB0YWJsZV9uYW1lID0gP1wiLFxuICAgICAgICAgICAgW3RoaXMuY29ubmVjdG9yLmRhdGFiYXNlLCB0YWJsZS5UQUJMRV9OQU1FXSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oZXh0cmFjdGVkT29sUGF0aCwgdGFibGUuVEFCTEVfTkFNRSArICcubWV0YS5qc29uJyksIEpTT04uc3RyaW5naWZ5KGNvbHVtbnMsIG51bGwsIDIpKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgbGV0IHsgZmVhdHVyZXMsIGZpZWxkcywgdHlwZXMgfSA9IHRoaXMuX3Byb2Nlc3NGaWVsZHModGFibGUsIGNvbHVtbnMpO1xuXG4gICAgICAgIGxldCBpbmRleEluZm8gPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcIlNIT1cgSU5ERVhFUyBGUk9NID8/XCIsIFsgdGFibGUuVEFCTEVfTkFNRSBdKTtcblxuICAgICAgICBpZiAodGhpcy5zYXZlRGF0YWJhc2VNZXRhICYmICFfLmlzRW1wdHkoaW5kZXhJbmZvKSkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oZXh0cmFjdGVkT29sUGF0aCwgdGFibGUuVEFCTEVfTkFNRSArICcuaW5kZXguanNvbicpLCBKU09OLnN0cmluZ2lmeShpbmRleEluZm8sIG51bGwsIDIpKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgeyBwaywgaW5kZXhlcywgbWFwTmFtZVRvSW5kZXggfSA9IHRoaXMuX3Byb2Nlc3NJbmRleGVzKGluZGV4SW5mbyk7XG5cbiAgICAgICAgYXNzZXJ0OiBway5sZW5ndGggPiAwOyAgICAgICAgXG5cbiAgICAgICAgbGV0IHJlZmVyZW5jZXNJbmZvID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJTRUxFQ1QgKiBGUk9NIElORk9STUFUSU9OX1NDSEVNQS5LRVlfQ09MVU1OX1VTQUdFIFdIRVJFIGBSRUZFUkVOQ0VEX1RBQkxFX1NDSEVNQWAgPSA/IEFORCBgVEFCTEVfTkFNRWAgPSA/IEFORCBgUkVGRVJFTkNFRF9UQUJMRV9OQU1FYCBJUyBOT1QgTlVMTFwiLFxuICAgICAgICAgICAgWyB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSwgdGFibGUuVEFCTEVfTkFNRSBdKTtcblxuICAgICAgICBpZiAodGhpcy5zYXZlRGF0YWJhc2VNZXRhICYmICFfLmlzRW1wdHkocmVmZXJlbmNlc0luZm8pKSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihleHRyYWN0ZWRPb2xQYXRoLCB0YWJsZS5UQUJMRV9OQU1FICsgJy5yZWYuanNvbicpLCBKU09OLnN0cmluZ2lmeShyZWZlcmVuY2VzSW5mbywgbnVsbCwgMikpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBhd2FpdCB0aGlzLl9wcm9jZXNzUmVmZXJlbmNlc18ocmVmZXJlbmNlc0luZm8sIG1hcE5hbWVUb0luZGV4LCBmaWVsZHMpO1xuXG4gICAgICAgIGxldCBlbnRpdHlJbmZvID0geyAgICAgICAgICAgIFxuICAgICAgICAgICAgY29tbWVudDogdGFibGUuVEFCTEVfQ09NTUVOVCxcbiAgICAgICAgICAgIGZlYXR1cmVzLFxuICAgICAgICAgICAgZmllbGRzLFxuICAgICAgICAgICAgYXNzb2NpYXRpb25zLFxuICAgICAgICAgICAga2V5IDogcGsubGVuZ3RoID4gMSA/IHBrIDogcGtbMF0sXG4gICAgICAgICAgICBpbmRleGVzXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGVudGl0eU5hbWUgIT09IHRhYmxlLlRBQkxFX05BTUUpIHtcbiAgICAgICAgICAgIGVudGl0eUluZm8uY29kZSA9IHRhYmxlLlRBQkxFX05BTUU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyB0eXBlcywgZW50aXR5SW5mbyB9O1xuICAgIH1cblxuICAgIGFzeW5jIF9wcm9jZXNzUmVmZXJlbmNlc18ocmVmZXJlbmNlc0luZm8sIG1hcE5hbWVUb0luZGV4LCBmaWVsZHMpIHtcbiAgICAgICAgbGV0IGFzc29jaWF0aW9ucyA9IFtdO1xuXG4gICAgICAgIGxldCBsID0gcmVmZXJlbmNlc0luZm8ubGVuZ3RoO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBsZXQgcmVmID0gcmVmZXJlbmNlc0luZm9baV07XG5cbiAgICAgICAgICAgIGxldCBbcmVmVGFibGVLZXldID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJTSE9XIElOREVYRVMgRlJPTSA/PyBXSEVSRSBgS2V5X25hbWVgID0gJ1BSSU1BUlknXCIsIFtyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FXSk7XG5cbiAgICAgICAgICAgIGlmIChyZWZUYWJsZUtleS5Db2x1bW5fbmFtZS50b0xvd2VyQ2FzZSgpICE9PSByZWYuUkVGRVJFTkNFRF9DT0xVTU5fTkFNRS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGb3JlaWduIGtleSBcIiR7cmVmLkNPTFVNTl9OQU1FfVwiIG5vdCByZWZlcmVuY2UgdG8gdGhlIHByaW1hcnkga2V5LmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdW5pcXVlID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGxldCBma0luZm8gPSBtYXBOYW1lVG9JbmRleFtyZWYuQ09OU1RSQUlOVF9OQU1FXTsgXG4gICAgICAgICAgICBpZiAoZmtJbmZvKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZrSW5mby5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29tYmluYXRpb24gZm9yZWlnbiBrZXkgaXMgbm90IHN1cHBvcnRlZDogXCIke3JlZi5DT05TVFJBSU5UX05BTUV9XCJgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB1bmlxdWUgPSBma0luZm9bMF0uTm9uX3VuaXF1ZSA9PT0gMDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZrQ29sTmFtZSA9IHRoaXMuX2ZpZWxkTmFtaW5nKHJlZi5DT0xVTU5fTkFNRSk7XG5cbiAgICAgICAgICAgIGlmICh1bmlxdWUpIHtcbiAgICAgICAgICAgICAgICBhc3NvY2lhdGlvbnMucHVzaCh7IHR5cGU6ICdiZWxvbmdzVG8nLCBmcm9tOiBma0NvbE5hbWUsIGVudGl0eTogdGhpcy5fZW50aXR5TmFtaW5nKHJlZi5SRUZFUkVOQ0VEX1RBQkxFX05BTUUpIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhc3NvY2lhdGlvbnMucHVzaCh7IHR5cGU6ICdoYXNNYW55JywgZnJvbTogZmtDb2xOYW1lLCAgZW50aXR5OiB0aGlzLl9lbnRpdHlOYW1pbmcocmVmLlJFRkVSRU5DRURfVEFCTEVfTkFNRSkgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRlbGV0ZSBmaWVsZHNbZmtDb2xOYW1lXTsvLyA9IHsgdHlwZTogJyRhc3NvY2lhdGlvbicsIGNvZGU6IGZpZWxkc1tma0NvbE5hbWVdLmNvZGUgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhc3NvY2lhdGlvbnM7XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NJbmRleGVzKGluZGV4SW5mbykge1xuICAgICAgICBsZXQgcGsgPSBbXSwgaW5kZXhlcyA9IFtdO1xuXG4gICAgICAgIGxldCBtYXBOYW1lVG9JbmRleCA9IHt9O1xuXG4gICAgICAgIGluZGV4SW5mby5mb3JFYWNoKGkgPT4ge1xuICAgICAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KG1hcE5hbWVUb0luZGV4LCBpLktleV9uYW1lLCBpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwTmFtZVRvSW5kZXgsIChmaWVsZHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSAnUFJJTUFSWScpIHtcbiAgICAgICAgICAgICAgICBway5wdXNoKGZpZWxkcy5tYXAoZiA9PiB0aGlzLl9maWVsZE5hbWluZyhmLkNvbHVtbl9uYW1lKSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbmRleGVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IGZpZWxkcy5tYXAoZiA9PiB0aGlzLl9maWVsZE5hbWluZyhmLkNvbHVtbl9uYW1lKSksXG4gICAgICAgICAgICAgICAgICAgIHVuaXF1ZTogZmllbGRzWzBdLk5vbl91bmlxdWUgPT09IDAsXG4gICAgICAgICAgICAgICAgICAgIG51bGxhYmxlOiBmaWVsZHNbMF0uTnVsbCA9PT0gJ1lFUydcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHsgcGssIGluZGV4ZXMsIG1hcE5hbWVUb0luZGV4IH07XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NGaWVsZHModGFibGUsIGNvbHVtbnMpIHtcbiAgICAgICAgbGV0IGZlYXR1cmVzID0gW10sIGZpZWxkcyA9IHt9LCB0eXBlcyA9IHt9O1xuXG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaChjb2wgPT4ge1xuICAgICAgICAgICAgbGV0IGZpZWxkTmFtZSA9IHRoaXMuX2ZpZWxkTmFtaW5nKGNvbC5DT0xVTU5fTkFNRSk7XG4gICAgICAgICAgICBpZiAoY29sLkVYVFJBID09PSAnYXV0b19pbmNyZW1lbnQnKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJhdXRvSWRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHRhYmxlLkFVVE9fSU5DUkVNRU5UID8geyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzdGFydEZyb21cIjogdGFibGUuQVVUT19JTkNSRU1FTlRcbiAgICAgICAgICAgICAgICAgICAgfSA6IHt9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgIT09ICdpZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZUluZm8ub3B0aW9ucy5uYW1lID0gZmllbGROYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0RFRkFVTFQgPT09ICdDVVJSRU5UX1RJTUVTVEFNUCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcImNyZWF0ZVRpbWVzdGFtcFwiXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuRVhUUkEgPT09ICdvbiB1cGRhdGUgQ1VSUkVOVF9USU1FU1RBTVAnKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJ1cGRhdGVUaW1lc3RhbXBcIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaChmZWF0dXJlSW5mbyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZmllbGROYW1lID09PSAnaXNEZWxldGVkJyAmJiBjb2wuQ09MVU1OX1RZUEUgPT09ICd0aW55aW50KDEpJykge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlSW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwibG9naWNhbERlbGV0aW9uXCJcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZpZWxkSW5mbyA9IHRoaXMuX215c3FsVHlwZVRvT29sVHlwZSh0YWJsZSwgY29sLCBmaWVsZE5hbWUsIHR5cGVzKTtcblxuICAgICAgICAgICAgaWYgKGNvbC5JU19OVUxMQUJMRSA9PT0gJ1lFUycpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8ub3B0aW9uYWwgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29sLkNPTFVNTl9ERUZBVUxUKSB7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvLmRlZmF1bHQgPSBjb2wuQ09MVU1OX0RFRkFVTFQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0NPTU1FTlQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uY29tbWVudCA9IGNvbC5DT0xVTU5fQ09NTUVOVDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZmllbGRzW2ZpZWxkTmFtZV0gPSBmaWVsZEluZm87XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB7IGZlYXR1cmVzLCBmaWVsZHMsIHR5cGVzIH07XG4gICAgfVxuXG4gICAgX2ZpZWxkTmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLmZpZWxkTmFtaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXZlcnNlUnVsZXMuZmllbGROYW1pbihuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5maWVsZE5hbWluZyhuYW1lKTtcbiAgICB9XG5cbiAgICBfZW50aXR5TmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLmVudGl0eU5hbWluZykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZVJ1bGVzLmVudGl0eU5hbWluZyhuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5lbnRpdHlOYW1pbmcobmFtZSk7XG4gICAgfVxuXG4gICAgX3NjaGVtYU5hbWluZyhuYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLnJldmVyc2VSdWxlcy5zY2hlbWFOYW1pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJldmVyc2VSdWxlcy5zY2hlbWFOYW1pbmcobmFtZSk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gT29sVXRpbHMuc2NoZW1hTmFtaW5nKG5hbWUpO1xuICAgIH1cblxuICAgIF9teXNxbFR5cGVUb09vbFR5cGUodGFibGUsIGNvbCwgZmllbGROYW1lLCB0eXBlcykge1xuICAgICAgICBsZXQgYXBwbGljYWJsZVJ1bGUgPSBfLmZpbmQodGhpcy5yZXZlcnNlUnVsZXMuY29sdW1uVHlwZUNvbnZlcnNpb24sIHJ1bGUgPT4gcnVsZS50ZXN0KHRhYmxlLCBjb2wpKTtcbiAgICAgICAgaWYgKGFwcGxpY2FibGVSdWxlKSB7XG4gICAgICAgICAgICByZXR1cm4gYXBwbGljYWJsZVJ1bGUuYXBwbHkodGFibGUsIGNvbCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCB0eXBlSW5mbyA9IHt9OyAgICAgICAgXG4gICAgICAgIGlmIChjb2wuQ09MVU1OX05BTUUgIT09IGZpZWxkTmFtZSkge1xuICAgICAgICAgICAgdHlwZUluZm8uY29kZSA9IGNvbC5DT0xVTU5fTkFNRTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN3aXRjaCAoY29sLkRBVEFfVFlQRSkge1xuICAgICAgICAgICAgY2FzZSAndmFyY2hhcic6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICBpZiAoY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSCkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5tYXhMZW5ndGggPSBjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnY2hhcic6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICBpZiAoY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSCkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5maXhlZExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdiaWdpbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDE4O1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmJ5dGVzID0gODtcbiAgICAgICAgICAgICAgICBpZiAoXy5lbmRzV2l0aChjb2wuQ09MVU1OX1RZUEUsICcgdW5zaWduZWQnKSkgdHlwZUluZm8udW5zaWduZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdpbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDEwO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmJ5dGVzID0gNDtcbiAgICAgICAgICAgICAgICBpZiAoXy5lbmRzV2l0aChjb2wuQ09MVU1OX1RZUEUsICcgdW5zaWduZWQnKSkgdHlwZUluZm8udW5zaWduZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdtZWRpdW1pbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDc7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAzO1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3NtYWxsaW50JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2ludGVnZXInO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTiB8fCA0O1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmJ5dGVzID0gMjtcbiAgICAgICAgICAgICAgICBpZiAoXy5lbmRzV2l0aChjb2wuQ09MVU1OX1RZUEUsICcgdW5zaWduZWQnKSkgdHlwZUluZm8udW5zaWduZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICd0aW55aW50JzpcbiAgICAgICAgICAgICAgICBpZiAoXy5zdGFydHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJ3RpbnlpbnQoMSknKSkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2Jvb2xlYW4nO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTiB8fCAyO1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5ieXRlcyA9IDE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcbiAgICAgICAgICAgICAgICBsZXQgbGVmdCA9IGNvbC5DT0xVTU5fVFlQRS5pbmRleE9mKCcoJyk7XG4gICAgICAgICAgICAgICAgbGV0IHJpZ2h0ID0gY29sLkNPTFVNTl9UWVBFLmxhc3RJbmRleE9mKCcpJyk7XG5cbiAgICAgICAgICAgICAgICBsZXQgdHlwZU5hbWUgPSB0YWJsZS5UQUJMRV9OQU1FICsgXy51cHBlckZpcnN0KGNvbC5DT0xVTU5fTkFNRSk7XG5cbiAgICAgICAgICAgICAgICB0eXBlc1t0eXBlTmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlbnVtJyxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzOiBjb2wuQ09MVU1OX1RZUEUuc3Vic3RyaW5nKGxlZnQgKyAxLCByaWdodCkuc3BsaXQoJywnKS5tYXAodiA9PiB2LnN1YnN0cigxLCB2Lmxlbmd0aCAtIDIpKVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gdHlwZU5hbWU7XG5cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5tYXhMZW5ndGggPSBjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdkYXRldGltZSc6XG4gICAgICAgICAgICBjYXNlICd0aW1lc3RhbXAnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnZGF0ZXRpbWUnO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdkZWNpbWFsJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2RlY2ltYWwnO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnRvdGFsRGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRlY2ltYWxEaWdpdHMgPSBjb2wuTlVNRVJJQ19TQ0FMRTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnZmxvYXQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnZmxvYXQnO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnRvdGFsRGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRlY2ltYWxEaWdpdHMgPSBjb2wuTlVNRVJJQ19TQ0FMRTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb2wpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVG8gYmUgaW1wbGVtZW50ZWQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvL18uZmluZCh0aGlzLnJldmVyc2VSdWxlcy5jb2x1bW5UeXBlT3B0aW1pemF0aW9uLCBydWxlID0+IHJ1bGUudGVzdCh0YWJsZSwgY29sKSk7XG5cbiAgICAgICAgcmV0dXJuIHR5cGVJbmZvO1xuICAgIH1cblxuICAgIF9yZWZpbmVFbnRpdHlSZWxhdGlvbnNoaXBzKG1hcE9mRW50aXRpZXMpIHtcbiAgICAgICAgbGV0IGVudGl0eUFzc29jID0ge307XG5cbiAgICAgICAgLy8xc3Qgcm91bmRcbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGVudGl0eUluZm8uYXNzb2NpYXRpb25zKSkgcmV0dXJuOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucy5mb3JFYWNoKCh7IHR5cGUsIGZyb20sIGVudGl0eSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHJlZmVkRW50aXR5ID0gbWFwT2ZFbnRpdGllc1tlbnRpdHldO1xuICAgICAgICAgICAgICAgIGxldCBiYWNrUmVmID0gXy5maW5kKHJlZmVkRW50aXR5LmFzc29jaWF0aW9ucywgYXNzb2MgPT4gYXNzb2MuZW50aXR5ID09PSBuYW1lKTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGFzTWFueScpIHsgICBcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIWJhY2tSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vb25lLXNpZGUgcmVsYXRpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgbmFtZSwgeyB0eXBlOiAncmVmZXJzVG8nLCBmcm9tLCBlbnRpdHkgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvL3RvZG86XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVudGl0eUluZm8pO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2sgcmVmZXJlbmNlOiAke2JhY2tSZWYuZW50aXR5fSAke2JhY2tSZWYudHlwZX0gJHtuYW1lfWApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmVsb25nc1RvJykge1xuXG4gICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgbmFtZSwgeyB0eXBlLCBmcm9tLCBlbnRpdHkgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFiYWNrUmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL29uZS1zaWRlIHJlbGF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIGVudGl0eSwgeyB0eXBlOiAnaGFzTWFueScsIGVudGl0eTogbmFtZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgYXNzb2NpYXRpb24gdHlwZTogJyArIHR5cGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIC8vMm5kIHJvdW5kXG4gICAgICAgIF8uZm9yT3duKGVudGl0eUFzc29jLCAoYXNzb2NpYXRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBlbnRpdHlJbmZvIH0gPSBtYXBPZkVudGl0aWVzW25hbWVdO1xuXG4gICAgICAgICAgICBsZXQga2V5QXNzb2NzO1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRpdHlJbmZvLmtleSkgJiYgZW50aXR5SW5mby5rZXkubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAga2V5QXNzb2NzID0gXy5maWx0ZXIoYXNzb2NpYXRpb25zLCBhc3NvYyA9PiBlbnRpdHlJbmZvLmtleS5pbmRleE9mKGFzc29jLmZyb20pICE9PSAtMSk7XG4gICAgICAgICAgICAgICAgaWYgKGtleUFzc29jcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFrZUVudGl0eU1hbnlUb01hbnkoa2V5QXNzb2NzWzBdLmVudGl0eSwga2V5QXNzb2NzWzFdLmVudGl0eSwgZW50aXR5QXNzb2MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5SW5mby5pbmRleGVzLmZvckVhY2goKHsgZmllbGRzIH0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBrZXlBc3NvY3MgPSBfLmZpbHRlcihhc3NvY2lhdGlvbnMsIGFzc29jID0+IGZpZWxkcy5pbmRleE9mKGFzc29jLmZyb20pICE9PSAtMSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChrZXlBc3NvY3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYWtlRW50aXR5TWFueVRvTWFueShrZXlBc3NvY3NbMF0uZW50aXR5LCBrZXlBc3NvY3NbMV0uZW50aXR5LCBlbnRpdHlBc3NvYyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucyA9IGVudGl0eUFzc29jW25hbWVdO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfbWFrZUVudGl0eU1hbnlUb01hbnkoZW50aXR5TmFtZTEsIGVudGl0eU5hbWUyLCBlbnRpdHlBc3NvYykge1xuICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIGVudGl0eU5hbWUxLCB7IHR5cGU6ICdoYXNNYW55JywgZW50aXR5OiBlbnRpdHlOYW1lMiB9KTtcbiAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KGVudGl0eUFzc29jLCBlbnRpdHlOYW1lMiwgeyB0eXBlOiAnaGFzTWFueScsIGVudGl0eTogZW50aXR5TmFtZTEgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMUmV2ZXJzZUVuZ2luZWVyaW5nOyJdfQ==