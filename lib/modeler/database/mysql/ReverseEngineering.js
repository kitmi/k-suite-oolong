"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const OolCodeGen = require('../../../lang/OolCodeGen');

const OolUtils = require('../../../lang/OolUtils');

class MySQLReverseEngineering {
  constructor(context, connector) {
    this.logger = context.logger;
    this.connector = connector;
    this.reverseRules = this.connector.options.reverseRules || {};
    this.saveDatabaseMeta = this.connector.options.saveDatabaseMeta || false;
  }

  async reverse_(outputDir) {
    this.logger.log('verbose', `Reverse engineering against ${this.connector.driver} database "${this.connector.database}" ...`);
    fs.ensureDirSync(outputDir);
    let tables = await this.connector.execute_("select * from information_schema.tables where table_schema = ?", [this.connector.database]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(outputDir, this.connector.database + '.meta.json'), JSON.stringify(tables, null, 2));
    }

    let entities = [],
        mapOfEntities = {};
    let entitiesOolPath = path.join(outputDir, 'entities');
    fs.ensureDirSync(entitiesOolPath);
    await Util.eachAsync_(tables, async table => {
      let entityName = this._entityNaming(table.TABLE_NAME);

      entities.push({
        entity: entityName
      });
      mapOfEntities[entityName] = await this.extractTable_(entityName, table, entitiesOolPath);
    });

    this._refineEntityRelationships(mapOfEntities);

    _.forOwn(mapOfEntities, ({
      types,
      entityInfo
    }, entityName) => {
      let entity = {
        type: types,
        entity: {
          [entityName]: entityInfo
        }
      };
      let entityContent = OolCodeGen.transform(entity);
      let entityFile = path.join(entitiesOolPath, entityName + '.ool');
      fs.writeFileSync(entityFile + '.json', JSON.stringify(entity, null, 2));
      fs.writeFileSync(entityFile, entityContent);
      this.logger.log('info', `Extracted entity definition file "${entityFile}".`);
    });

    let schemaName = this._schemaNaming(this.connector.database);

    let json = {
      "namespace": ["entities/**"],
      "schema": {
        [schemaName]: {
          "entities": entities
        }
      }
    };
    let schemaContent = OolCodeGen.transform(json);
    let schemaFile = path.join(outputDir, schemaName + '.ool');
    fs.writeFileSync(schemaFile + '.json', JSON.stringify(json, null, 2));
    fs.writeFileSync(schemaFile, schemaContent);
    this.logger.log('info', `Extracted schema entry file "${schemaFile}".`);
  }

  async extractTable_(entityName, table, extractedOolPath) {
    let columns = await this.connector.execute_("select * from information_schema.columns where table_schema = ? and table_name = ?", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.meta.json'), JSON.stringify(columns, null, 2));
    }

    let {
      features,
      fields,
      types
    } = this._processFields(table, columns);

    let indexInfo = await this.connector.execute_("SHOW INDEXES FROM ??", [table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(indexInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.index.json'), JSON.stringify(indexInfo, null, 2));
    }

    let {
      pk,
      indexes,
      mapNameToIndex
    } = this._processIndexes(indexInfo);

    if (!(pk.length > 0)) {
      throw new Error("Assertion failed: pk.length > 0");
    }

    let referencesInfo = await this.connector.execute_("SELECT * FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE `REFERENCED_TABLE_SCHEMA` = ? AND `TABLE_NAME` = ? AND `REFERENCED_TABLE_NAME` IS NOT NULL", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(referencesInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.ref.json'), JSON.stringify(referencesInfo, null, 2));
    }

    let associations = await this._processReferences_(referencesInfo, mapNameToIndex, fields);
    let entityInfo = {
      comment: table.TABLE_COMMENT,
      features,
      fields,
      associations,
      key: pk.length > 1 ? pk : pk[0],
      indexes
    };

    if (entityName !== table.TABLE_NAME) {
      entityInfo.code = table.TABLE_NAME;
    }

    return {
      types,
      entityInfo
    };
  }

  async _processReferences_(referencesInfo, mapNameToIndex, fields) {
    let associations = [];
    let l = referencesInfo.length;

    for (let i = 0; i < l; i++) {
      let ref = referencesInfo[i];
      let [refTableKey] = await this.connector.execute_("SHOW INDEXES FROM ?? WHERE `Key_name` = 'PRIMARY'", [ref.REFERENCED_TABLE_NAME]);

      if (refTableKey.Column_name.toLowerCase() !== ref.REFERENCED_COLUMN_NAME.toLowerCase()) {
        throw new Error(`Foreign key "${ref.COLUMN_NAME}" not reference to the primary key.`);
      }

      let unique = false;
      let fkInfo = mapNameToIndex[ref.CONSTRAINT_NAME];

      if (fkInfo) {
        if (fkInfo.length > 1) {
          throw new Error(`Combination foreign key is not supported: "${ref.CONSTRAINT_NAME}"`);
        }

        unique = fkInfo[0].Non_unique === 0;
      }

      let fkColName = this._fieldNaming(ref.COLUMN_NAME);

      if (unique) {
        associations.push({
          type: 'belongsTo',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      } else {
        associations.push({
          type: 'hasMany',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      }

      delete fields[fkColName];
    }

    return associations;
  }

  _processIndexes(indexInfo) {
    let pk = [],
        indexes = [];
    let mapNameToIndex = {};
    indexInfo.forEach(i => {
      Util.putIntoBucket(mapNameToIndex, i.Key_name, i);
    });

    _.forOwn(mapNameToIndex, (fields, name) => {
      if (name === 'PRIMARY') {
        pk.push(fields.map(f => this._fieldNaming(f.Column_name)));
      } else {
        indexes.push({
          name: name,
          fields: fields.map(f => this._fieldNaming(f.Column_name)),
          unique: fields[0].Non_unique === 0,
          nullable: fields[0].Null === 'YES'
        });
      }
    });

    return {
      pk,
      indexes,
      mapNameToIndex
    };
  }

  _processFields(table, columns) {
    let features = [],
        fields = {},
        types = {};
    columns.forEach(col => {
      let fieldName = this._fieldNaming(col.COLUMN_NAME);

      if (col.EXTRA === 'auto_increment') {
        let featureInfo = {
          "name": "autoId",
          "options": table.AUTO_INCREMENT ? {
            "startFrom": table.AUTO_INCREMENT
          } : {}
        };

        if (fieldName !== 'id') {
          featureInfo.options.name = fieldName;
        }

        features.push(featureInfo);
        return;
      }

      if (col.COLUMN_DEFAULT === 'CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "createTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (col.EXTRA === 'on update CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "updateTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (fieldName === 'isDeleted' && col.COLUMN_TYPE === 'tinyint(1)') {
        let featureInfo = {
          "name": "logicalDeletion"
        };
        features.push(featureInfo);
        return;
      }

      let fieldInfo = this._mysqlTypeToOolType(table, col, fieldName, types);

      if (col.IS_NULLABLE === 'YES') {
        fieldInfo.optional = true;
      }

      if (col.COLUMN_DEFAULT) {
        fieldInfo.default = col.COLUMN_DEFAULT;
      }

      if (col.COLUMN_COMMENT) {
        fieldInfo.comment = col.COLUMN_COMMENT;
      }

      fields[fieldName] = fieldInfo;
    });
    return {
      features,
      fields,
      types
    };
  }

  _fieldNaming(name) {
    if (this.reverseRules.fieldNaming) {
      return this.reverseRules.fieldNamin(name);
    }

    return OolUtils.fieldNaming(name);
  }

  _entityNaming(name) {
    if (this.reverseRules.entityNaming) {
      return this.reverseRules.entityNaming(name);
    }

    return OolUtils.entityNaming(name);
  }

  _schemaNaming(name) {
    if (this.reverseRules.schemaNaming) {
      return this.reverseRules.schemaNaming(name);
    }

    return OolUtils.schemaNaming(name);
  }

  _mysqlTypeToOolType(table, col, fieldName, types) {
    let applicableRule = _.find(this.reverseRules.columnTypeConversion, rule => rule.test(table, col));

    if (applicableRule) {
      return applicableRule.apply(table, col);
    }

    let typeInfo = {};

    if (col.COLUMN_NAME !== fieldName) {
      typeInfo.code = col.COLUMN_NAME;
    }

    switch (col.DATA_TYPE) {
      case 'varchar':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'char':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.fixedLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'bigint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 18;
        typeInfo.bytes = 8;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'int':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 10;
        typeInfo.bytes = 4;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'mediumint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 7;
        typeInfo.bytes = 3;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'smallint':
        typeInfo.type = 'integer';
        typeInfo.digits = col.NUMERIC_PRECISION || 4;
        typeInfo.bytes = 2;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'tinyint':
        if (_.startsWith(col.COLUMN_TYPE, 'tinyint(1)')) {
          typeInfo.type = 'boolean';
        } else {
          typeInfo.type = 'integer';
          typeInfo.digits = col.NUMERIC_PRECISION || 2;
          typeInfo.bytes = 1;
          if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        }

        break;

      case 'enum':
        let left = col.COLUMN_TYPE.indexOf('(');
        let right = col.COLUMN_TYPE.lastIndexOf(')');

        let typeName = table.TABLE_NAME + _.upperFirst(col.COLUMN_NAME);

        types[typeName] = {
          type: 'enum',
          values: col.COLUMN_TYPE.substring(left + 1, right).split(',').map(v => v.substr(1, v.length - 2))
        };
        typeInfo.type = typeName;
        break;

      case 'text':
        typeInfo.type = 'text';
        typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        break;

      case 'datetime':
      case 'timestamp':
        typeInfo.type = 'datetime';
        break;

      case 'decimal':
        typeInfo.type = 'number';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        typeInfo.exact = true;
        break;

      case 'float':
        typeInfo.type = 'number';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      default:
        console.log(col);
        throw new Error('To be implemented.');
    }

    return typeInfo;
  }

  _refineEntityRelationships(mapOfEntities) {
    let entityAssoc = {};

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      if (_.isEmpty(entityInfo.associations)) return;
      entityInfo.associations.forEach(({
        type,
        from,
        entity
      }) => {
        let refedEntity = mapOfEntities[entity];

        let backRef = _.find(refedEntity.associations, assoc => assoc.entity === name);

        if (type === 'hasMany') {
          if (!backRef) {
            Util.putIntoBucket(entityAssoc, name, {
              type: 'refersTo',
              from,
              entity
            });
            return;
          }

          console.log(entityInfo);
          throw new Error(`Back reference: ${backRef.entity} ${backRef.type} ${name}`);
        } else if (type === 'belongsTo') {
          Util.putIntoBucket(entityAssoc, name, {
            type,
            from,
            entity
          });

          if (!backRef) {
            Util.putIntoBucket(entityAssoc, entity, {
              type: 'hasMany',
              entity: name
            });
            return;
          }
        } else {
          throw new Error('Unexpected association type: ' + type);
        }
      });
    });

    _.forOwn(entityAssoc, (associations, name) => {
      let {
        entityInfo
      } = mapOfEntities[name];
      let keyAssocs;

      if (Array.isArray(entityInfo.key) && entityInfo.key.length === 2) {
        keyAssocs = _.filter(associations, assoc => entityInfo.key.indexOf(assoc.from) !== -1);

        if (keyAssocs.length === 2) {
          this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
        }
      }

      entityInfo.indexes.forEach(({
        fields
      }) => {
        if (fields.length === 2) {
          keyAssocs = _.filter(associations, assoc => fields.indexOf(assoc.from) !== -1);

          if (keyAssocs.length === 2) {
            this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
          }
        }
      });
    });

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      entityInfo.associations = entityAssoc[name];
    });
  }

  _makeEntityManyToMany(entityName1, entityName2, entityAssoc) {
    Util.putIntoBucket(entityAssoc, entityName1, {
      type: 'hasMany',
      entity: entityName2
    });
    Util.putIntoBucket(entityAssoc, entityName2, {
      type: 'hasMany',
      entity: entityName1
    });
  }

}

module.exports = MySQLReverseEngineering;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbGVyL2RhdGFiYXNlL215c3FsL1JldmVyc2VFbmdpbmVlcmluZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJPb2xDb2RlR2VuIiwiT29sVXRpbHMiLCJNeVNRTFJldmVyc2VFbmdpbmVlcmluZyIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImNvbm5lY3RvciIsImxvZ2dlciIsInJldmVyc2VSdWxlcyIsIm9wdGlvbnMiLCJzYXZlRGF0YWJhc2VNZXRhIiwicmV2ZXJzZV8iLCJvdXRwdXREaXIiLCJsb2ciLCJkcml2ZXIiLCJkYXRhYmFzZSIsImVuc3VyZURpclN5bmMiLCJ0YWJsZXMiLCJleGVjdXRlXyIsIndyaXRlRmlsZVN5bmMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVudGl0aWVzIiwibWFwT2ZFbnRpdGllcyIsImVudGl0aWVzT29sUGF0aCIsImVhY2hBc3luY18iLCJ0YWJsZSIsImVudGl0eU5hbWUiLCJfZW50aXR5TmFtaW5nIiwiVEFCTEVfTkFNRSIsInB1c2giLCJlbnRpdHkiLCJleHRyYWN0VGFibGVfIiwiX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMiLCJmb3JPd24iLCJ0eXBlcyIsImVudGl0eUluZm8iLCJ0eXBlIiwiZW50aXR5Q29udGVudCIsInRyYW5zZm9ybSIsImVudGl0eUZpbGUiLCJzY2hlbWFOYW1lIiwiX3NjaGVtYU5hbWluZyIsImpzb24iLCJzY2hlbWFDb250ZW50Iiwic2NoZW1hRmlsZSIsImV4dHJhY3RlZE9vbFBhdGgiLCJjb2x1bW5zIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJfcHJvY2Vzc0ZpZWxkcyIsImluZGV4SW5mbyIsImlzRW1wdHkiLCJwayIsImluZGV4ZXMiLCJtYXBOYW1lVG9JbmRleCIsIl9wcm9jZXNzSW5kZXhlcyIsImxlbmd0aCIsInJlZmVyZW5jZXNJbmZvIiwiYXNzb2NpYXRpb25zIiwiX3Byb2Nlc3NSZWZlcmVuY2VzXyIsImNvbW1lbnQiLCJUQUJMRV9DT01NRU5UIiwia2V5IiwiY29kZSIsImwiLCJpIiwicmVmIiwicmVmVGFibGVLZXkiLCJSRUZFUkVOQ0VEX1RBQkxFX05BTUUiLCJDb2x1bW5fbmFtZSIsInRvTG93ZXJDYXNlIiwiUkVGRVJFTkNFRF9DT0xVTU5fTkFNRSIsIkVycm9yIiwiQ09MVU1OX05BTUUiLCJ1bmlxdWUiLCJma0luZm8iLCJDT05TVFJBSU5UX05BTUUiLCJOb25fdW5pcXVlIiwiZmtDb2xOYW1lIiwiX2ZpZWxkTmFtaW5nIiwiZnJvbSIsImZvckVhY2giLCJwdXRJbnRvQnVja2V0IiwiS2V5X25hbWUiLCJuYW1lIiwibWFwIiwiZiIsIm51bGxhYmxlIiwiTnVsbCIsImNvbCIsImZpZWxkTmFtZSIsIkVYVFJBIiwiZmVhdHVyZUluZm8iLCJBVVRPX0lOQ1JFTUVOVCIsIkNPTFVNTl9ERUZBVUxUIiwiQ09MVU1OX1RZUEUiLCJmaWVsZEluZm8iLCJfbXlzcWxUeXBlVG9Pb2xUeXBlIiwiSVNfTlVMTEFCTEUiLCJvcHRpb25hbCIsImRlZmF1bHQiLCJDT0xVTU5fQ09NTUVOVCIsImZpZWxkTmFtaW5nIiwiZmllbGROYW1pbiIsImVudGl0eU5hbWluZyIsInNjaGVtYU5hbWluZyIsImFwcGxpY2FibGVSdWxlIiwiZmluZCIsImNvbHVtblR5cGVDb252ZXJzaW9uIiwicnVsZSIsInRlc3QiLCJhcHBseSIsInR5cGVJbmZvIiwiREFUQV9UWVBFIiwiQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIIiwibWF4TGVuZ3RoIiwiZml4ZWRMZW5ndGgiLCJkaWdpdHMiLCJOVU1FUklDX1BSRUNJU0lPTiIsImJ5dGVzIiwiZW5kc1dpdGgiLCJ1bnNpZ25lZCIsInN0YXJ0c1dpdGgiLCJsZWZ0IiwiaW5kZXhPZiIsInJpZ2h0IiwibGFzdEluZGV4T2YiLCJ0eXBlTmFtZSIsInVwcGVyRmlyc3QiLCJ2YWx1ZXMiLCJzdWJzdHJpbmciLCJzcGxpdCIsInYiLCJzdWJzdHIiLCJ0b3RhbERpZ2l0cyIsImRlY2ltYWxEaWdpdHMiLCJOVU1FUklDX1NDQUxFIiwiZXhhY3QiLCJjb25zb2xlIiwiZW50aXR5QXNzb2MiLCJyZWZlZEVudGl0eSIsImJhY2tSZWYiLCJhc3NvYyIsImtleUFzc29jcyIsIkFycmF5IiwiaXNBcnJheSIsImZpbHRlciIsIl9tYWtlRW50aXR5TWFueVRvTWFueSIsImVudGl0eU5hbWUxIiwiZW50aXR5TmFtZTIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlGLElBQWxCOztBQUNBLE1BQU1HLFVBQVUsR0FBR0osT0FBTyxDQUFDLDBCQUFELENBQTFCOztBQUNBLE1BQU1LLFFBQVEsR0FBR0wsT0FBTyxDQUFDLHdCQUFELENBQXhCOztBQUVBLE1BQU1NLHVCQUFOLENBQThCO0FBQzFCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVUMsU0FBVixFQUFxQjtBQUM1QixTQUFLQyxNQUFMLEdBQWNGLE9BQU8sQ0FBQ0UsTUFBdEI7QUFDQSxTQUFLRCxTQUFMLEdBQWlCQSxTQUFqQjtBQUVBLFNBQUtFLFlBQUwsR0FBb0IsS0FBS0YsU0FBTCxDQUFlRyxPQUFmLENBQXVCRCxZQUF2QixJQUF1QyxFQUEzRDtBQUNBLFNBQUtFLGdCQUFMLEdBQXdCLEtBQUtKLFNBQUwsQ0FBZUcsT0FBZixDQUF1QkMsZ0JBQXZCLElBQTJDLEtBQW5FO0FBQ0g7O0FBRUQsUUFBTUMsUUFBTixDQUFlQyxTQUFmLEVBQTBCO0FBQ3RCLFNBQUtMLE1BQUwsQ0FBWU0sR0FBWixDQUFnQixTQUFoQixFQUE0QiwrQkFBOEIsS0FBS1AsU0FBTCxDQUFlUSxNQUFPLGNBQWEsS0FBS1IsU0FBTCxDQUFlUyxRQUFTLE9BQXJIO0FBRUFmLElBQUFBLEVBQUUsQ0FB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LENBQUNDLFdBQUQsRUFBY0MsV0FBZCxFQUEyQlYsV0FBM0IsRUFBd0M7QUFDekQvSSxJQUFBQSxJQUFJLENBQUNzRixhQUFMLENBQW1CeUQsV0FBbkIsRUFBZ0NTLFdBQWhDLEVBQTZDO0FBQUVoSCxNQUFBQSxJQUFJLEVBQUUsU0FBUjtBQUFtQk4sTUFBQUEsTUFBTSxFQUFFdUg7QUFBM0IsS0FBN0M7QUFDQXpKLElBQUFBLElBQUksQ0FBQ3NGLGFBQUwsQ0FBbUJ5RCxXQUFuQixFQUFnQ1UsV0FBaEMsRUFBNkM7QUFBRWpILE1BQUFBLElBQUksRUFBRSxTQUFSO0FBQW1CTixNQUFBQSxNQUFNLEVBQUVzSDtBQUEzQixLQUE3QztBQUNIOztBQWpjeUI7O0FBb2M5QkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEosdUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IE9vbENvZGVHZW4gPSByZXF1aXJlKCcuLi8uLi8uLi9sYW5nL09vbENvZGVHZW4nKTtcbmNvbnN0IE9vbFV0aWxzID0gcmVxdWlyZSgnLi4vLi4vLi4vbGFuZy9Pb2xVdGlscycpO1xuXG5jbGFzcyBNeVNRTFJldmVyc2VFbmdpbmVlcmluZyB7XG4gICAgY29uc3RydWN0b3IoY29udGV4dCwgY29ubmVjdG9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyID0gY29udGV4dC5sb2dnZXI7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOyAgICAgICAgXG5cbiAgICAgICAgdGhpcy5yZXZlcnNlUnVsZXMgPSB0aGlzLmNvbm5lY3Rvci5vcHRpb25zLnJldmVyc2VSdWxlcyB8fCB7fTsgICAgICAgXG4gICAgICAgIHRoaXMuc2F2ZURhdGFiYXNlTWV0YSA9IHRoaXMuY29ubmVjdG9yLm9wdGlvbnMuc2F2ZURhdGFiYXNlTWV0YSB8fCBmYWxzZTtcbiAgICB9XG5cbiAgICBhc3luYyByZXZlcnNlXyhvdXRwdXREaXIpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKCd2ZXJib3NlJywgYFJldmVyc2UgZW5naW5lZXJpbmcgYWdhaW5zdCAke3RoaXMuY29ubmVjdG9yLmRyaXZlcn0gZGF0YWJhc2UgXCIke3RoaXMuY29ubmVjdG9yLmRhdGFiYXNlfVwiIC4uLmApO1xuXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMob3V0cHV0RGlyKTtcblxuICAgICAgICBsZXQgdGFibGVzID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJzZWxlY3QgKiBmcm9tIGluZm9ybWF0aW9uX3NjaGVtYS50YWJsZXMgd2hlcmUgdGFibGVfc2NoZW1hID0gP1wiLCBbIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlIF0pOyAgICAgICAgXG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4ob3V0cHV0RGlyLCB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSArICcubWV0YS5qc29uJyksIEpTT04uc3RyaW5naWZ5KHRhYmxlcywgbnVsbCwgMikpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVudGl0aWVzID0gW10sIG1hcE9mRW50aXRpZXMgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIGxldCBlbnRpdGllc09vbFBhdGggPSBwYXRoLmpvaW4ob3V0cHV0RGlyLCAnZW50aXRpZXMnKTtcbiAgICAgICAgZnMuZW5zdXJlRGlyU3luYyhlbnRpdGllc09vbFBhdGgpO1xuXG4gICAgICAgIGF3YWl0IFV0aWwuZWFjaEFzeW5jXyh0YWJsZXMsIGFzeW5jIHRhYmxlID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gdGhpcy5fZW50aXR5TmFtaW5nKHRhYmxlLlRBQkxFX05BTUUpO1xuXG4gICAgICAgICAgICBlbnRpdGllcy5wdXNoKHsgZW50aXR5OiBlbnRpdHlOYW1lIH0pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBtYXBPZkVudGl0aWVzW2VudGl0eU5hbWVdID0gYXdhaXQgdGhpcy5leHRyYWN0VGFibGVfKGVudGl0eU5hbWUsIHRhYmxlLCBlbnRpdGllc09vbFBhdGgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9yZWZpbmVFbnRpdHlSZWxhdGlvbnNoaXBzKG1hcE9mRW50aXRpZXMpO1xuXG4gICAgICAgIF8uZm9yT3duKG1hcE9mRW50aXRpZXMsICh7IHR5cGVzLCBlbnRpdHlJbmZvIH0sIGVudGl0eU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBlbnRpdHkgPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogdHlwZXMsXG4gICAgICAgICAgICAgICAgZW50aXR5OiB7XG4gICAgICAgICAgICAgICAgICAgIFtlbnRpdHlOYW1lXTogZW50aXR5SW5mb1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgXG4gICAgICAgICAgICBsZXQgZW50aXR5Q29udGVudCA9IE9vbENvZGVHZW4udHJhbnNmb3JtKGVudGl0eSk7XG4gICAgICAgICAgICBsZXQgZW50aXR5RmlsZSA9IHBhdGguam9pbihlbnRpdGllc09vbFBhdGgsIGVudGl0eU5hbWUgKyAnLm9vbCcpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhlbnRpdHlGaWxlICsgJy5qc29uJywgSlNPTi5zdHJpbmdpZnkoZW50aXR5LCBudWxsLCAyKSk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGVudGl0eUZpbGUsIGVudGl0eUNvbnRlbnQpO1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgYEV4dHJhY3RlZCBlbnRpdHkgZGVmaW5pdGlvbiBmaWxlIFwiJHtlbnRpdHlGaWxlfVwiLmApO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgc2NoZW1hTmFtZSA9IHRoaXMuX3NjaGVtYU5hbWluZyh0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSk7XG5cbiAgICAgICAgbGV0IGpzb24gPSB7XG4gICAgICAgICAgICBcIm5hbWVzcGFjZVwiOiBbXG4gICAgICAgICAgICAgICAgXCJlbnRpdGllcy8qKlwiXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgXCJzY2hlbWFcIjoge1xuICAgICAgICAgICAgICAgIFtzY2hlbWFOYW1lXToge1xuICAgICAgICAgICAgICAgICAgICBcImVudGl0aWVzXCI6IGVudGl0aWVzICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBzY2hlbWFDb250ZW50ID0gT29sQ29kZUdlbi50cmFuc2Zvcm0oanNvbik7XG4gICAgICAgIGxldCBzY2hlbWFGaWxlID0gcGF0aC5qb2luKG91dHB1dERpciwgc2NoZW1hTmFtZSArICcub29sJyk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoc2NoZW1hRmlsZSArICcuanNvbicsIEpTT04uc3RyaW5naWZ5KGpzb24sIG51bGwsIDIpKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhzY2hlbWFGaWxlLCBzY2hlbWFDb250ZW50KTtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgYEV4dHJhY3RlZCBzY2hlbWEgZW50cnkgZmlsZSBcIiR7c2NoZW1hRmlsZX1cIi5gKTtcbiAgICB9XG5cbiAgICBhc3luYyBleHRyYWN0VGFibGVfKGVudGl0eU5hbWUsIHRhYmxlLCBleHRyYWN0ZWRPb2xQYXRoKSB7XG4gICAgICAgIGxldCBjb2x1bW5zID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJzZWxlY3QgKiBmcm9tIGluZm9ybWF0aW9uX3NjaGVtYS5jb2x1bW5zIHdoZXJlIHRhYmxlX3NjaGVtYSA9ID8gYW5kIHRhYmxlX25hbWUgPSA/XCIsXG4gICAgICAgICAgICBbdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UsIHRhYmxlLlRBQkxFX05BTUVdKTtcblxuICAgICAgICBpZiAodGhpcy5zYXZlRGF0YWJhc2VNZXRhKSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihleHRyYWN0ZWRPb2xQYXRoLCB0YWJsZS5UQUJMRV9OQU1FICsgJy5tZXRhLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkoY29sdW1ucywgbnVsbCwgMikpO1xuICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICBsZXQgeyBmZWF0dXJlcywgZmllbGRzLCB0eXBlcyB9ID0gdGhpcy5fcHJvY2Vzc0ZpZWxkcyh0YWJsZSwgY29sdW1ucyk7XG5cbiAgICAgICAgbGV0IGluZGV4SW5mbyA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwiU0hPVyBJTkRFWEVTIEZST00gPz9cIiwgWyB0YWJsZS5UQUJMRV9OQU1FIF0pO1xuXG4gICAgICAgIGlmICh0aGlzLnNhdmVEYXRhYmFzZU1ldGEgJiYgIV8uaXNFbXB0eShpbmRleEluZm8pKSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihleHRyYWN0ZWRPb2xQYXRoLCB0YWJsZS5UQUJMRV9OQU1FICsgJy5pbmRleC5qc29uJyksIEpTT04uc3RyaW5naWZ5KGluZGV4SW5mbywgbnVsbCwgMikpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIGxldCB7IHBrLCBpbmRleGVzLCBtYXBOYW1lVG9JbmRleCB9ID0gdGhpcy5fcHJvY2Vzc0luZGV4ZXMoaW5kZXhJbmZvKTtcblxuICAgICAgICBhc3NlcnQ6IHBrLmxlbmd0aCA+IDA7ICAgICAgICBcblxuICAgICAgICBsZXQgcmVmZXJlbmNlc0luZm8gPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcIlNFTEVDVCAqIEZST00gSU5GT1JNQVRJT05fU0NIRU1BLktFWV9DT0xVTU5fVVNBR0UgV0hFUkUgYFJFRkVSRU5DRURfVEFCTEVfU0NIRU1BYCA9ID8gQU5EIGBUQUJMRV9OQU1FYCA9ID8gQU5EIGBSRUZFUkVOQ0VEX1RBQkxFX05BTUVgIElTIE5PVCBOVUxMXCIsXG4gICAgICAgICAgICBbIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlLCB0YWJsZS5UQUJMRV9OQU1FIF0pO1xuXG4gICAgICAgIGlmICh0aGlzLnNhdmVEYXRhYmFzZU1ldGEgJiYgIV8uaXNFbXB0eShyZWZlcmVuY2VzSW5mbykpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGV4dHJhY3RlZE9vbFBhdGgsIHRhYmxlLlRBQkxFX05BTUUgKyAnLnJlZi5qc29uJyksIEpTT04uc3RyaW5naWZ5KHJlZmVyZW5jZXNJbmZvLCBudWxsLCAyKSk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgbGV0IGFzc29jaWF0aW9ucyA9IGF3YWl0IHRoaXMuX3Byb2Nlc3NSZWZlcmVuY2VzXyhyZWZlcmVuY2VzSW5mbywgbWFwTmFtZVRvSW5kZXgsIGZpZWxkcyk7XG5cbiAgICAgICAgbGV0IGVudGl0eUluZm8gPSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBjb21tZW50OiB0YWJsZS5UQUJMRV9DT01NRU5ULFxuICAgICAgICAgICAgZmVhdHVyZXMsXG4gICAgICAgICAgICBmaWVsZHMsXG4gICAgICAgICAgICBhc3NvY2lhdGlvbnMsXG4gICAgICAgICAgICBrZXkgOiBway5sZW5ndGggPiAxID8gcGsgOiBwa1swXSxcbiAgICAgICAgICAgIGluZGV4ZXNcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoZW50aXR5TmFtZSAhPT0gdGFibGUuVEFCTEVfTkFNRSkge1xuICAgICAgICAgICAgZW50aXR5SW5mby5jb2RlID0gdGFibGUuVEFCTEVfTkFNRTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7IHR5cGVzLCBlbnRpdHlJbmZvIH07XG4gICAgfVxuXG4gICAgYXN5bmMgX3Byb2Nlc3NSZWZlcmVuY2VzXyhyZWZlcmVuY2VzSW5mbywgbWFwTmFtZVRvSW5kZXgsIGZpZWxkcykge1xuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gW107XG5cbiAgICAgICAgbGV0IGwgPSByZWZlcmVuY2VzSW5mby5sZW5ndGg7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsOyBpKyspIHtcbiAgICAgICAgICAgIGxldCByZWYgPSByZWZlcmVuY2VzSW5mb1tpXTtcblxuICAgICAgICAgICAgbGV0IFtyZWZUYWJsZUtleV0gPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcIlNIT1cgSU5ERVhFUyBGUk9NID8/IFdIRVJFIGBLZXlfbmFtZWAgPSAnUFJJTUFSWSdcIiwgW3JlZi5SRUZFUkVOQ0VEX1RBQkxFX05BTUVdKTtcblxuICAgICAgICAgICAgaWYgKHJlZlRhYmxlS2V5LkNvbHVtbl9uYW1lLnRvTG93ZXJDYXNlKCkgIT09IHJlZi5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZvcmVpZ24ga2V5IFwiJHtyZWYuQ09MVU1OX05BTUV9XCIgbm90IHJlZmVyZW5jZSB0byB0aGUgcHJpbWFyeSBrZXkuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCB1bmlxdWUgPSBmYWxzZTtcblxuICAgICAgICAgICAgbGV0IGZrSW5mbyA9IG1hcE5hbWVUb0luZGV4W3JlZi5DT05TVFJBSU5UX05BTUVdOyBcbiAgICAgICAgICAgIGlmIChma0luZm8pIHtcbiAgICAgICAgICAgICAgICBpZiAoZmtJbmZvLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb21iaW5hdGlvbiBmb3JlaWduIGtleSBpcyBub3Qgc3VwcG9ydGVkOiBcIiR7cmVmLkNPTlNUUkFJTlRfTkFNRX1cImApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHVuaXF1ZSA9IGZrSW5mb1swXS5Ob25fdW5pcXVlID09PSAwO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZmtDb2xOYW1lID0gdGhpcy5fZmllbGROYW1pbmcocmVmLkNPTFVNTl9OQU1FKTtcblxuICAgICAgICAgICAgaWYgKHVuaXF1ZSkge1xuICAgICAgICAgICAgICAgIGFzc29jaWF0aW9ucy5wdXNoKHsgdHlwZTogJ2JlbG9uZ3NUbycsIGZyb206IGZrQ29sTmFtZSwgZW50aXR5OiB0aGlzLl9lbnRpdHlOYW1pbmcocmVmLlJFRkVSRU5DRURfVEFCTEVfTkFNRSkgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFzc29jaWF0aW9ucy5wdXNoKHsgdHlwZTogJ2hhc01hbnknLCBmcm9tOiBma0NvbE5hbWUsICBlbnRpdHk6IHRoaXMuX2VudGl0eU5hbWluZyhyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKSB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIGZpZWxkc1tma0NvbE5hbWVdOy8vID0geyB0eXBlOiAnJGFzc29jaWF0aW9uJywgY29kZTogZmllbGRzW2ZrQ29sTmFtZV0uY29kZSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFzc29jaWF0aW9ucztcbiAgICB9XG5cbiAgICBfcHJvY2Vzc0luZGV4ZXMoaW5kZXhJbmZvKSB7XG4gICAgICAgIGxldCBwayA9IFtdLCBpbmRleGVzID0gW107XG5cbiAgICAgICAgbGV0IG1hcE5hbWVUb0luZGV4ID0ge307XG5cbiAgICAgICAgaW5kZXhJbmZvLmZvckVhY2goaSA9PiB7XG4gICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQobWFwTmFtZVRvSW5kZXgsIGkuS2V5X25hbWUsIGkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBfLmZvck93bihtYXBOYW1lVG9JbmRleCwgKGZpZWxkcywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdQUklNQVJZJykge1xuICAgICAgICAgICAgICAgIHBrLnB1c2goZmllbGRzLm1hcChmID0+IHRoaXMuX2ZpZWxkTmFtaW5nKGYuQ29sdW1uX25hbWUpKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluZGV4ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkczogZmllbGRzLm1hcChmID0+IHRoaXMuX2ZpZWxkTmFtaW5nKGYuQ29sdW1uX25hbWUpKSxcbiAgICAgICAgICAgICAgICAgICAgdW5pcXVlOiBmaWVsZHNbMF0uTm9uX3VuaXF1ZSA9PT0gMCxcbiAgICAgICAgICAgICAgICAgICAgbnVsbGFibGU6IGZpZWxkc1swXS5OdWxsID09PSAnWUVTJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4geyBwaywgaW5kZXhlcywgbWFwTmFtZVRvSW5kZXggfTtcbiAgICB9XG5cbiAgICBfcHJvY2Vzc0ZpZWxkcyh0YWJsZSwgY29sdW1ucykge1xuICAgICAgICBsZXQgZmVhdHVyZXMgPSBbXSwgZmllbGRzID0ge30sIHR5cGVzID0ge307XG5cbiAgICAgICAgY29sdW1ucy5mb3JFYWNoKGNvbCA9PiB7XG4gICAgICAgICAgICBsZXQgZmllbGROYW1lID0gdGhpcy5fZmllbGROYW1pbmcoY29sLkNPTFVNTl9OQU1FKTtcbiAgICAgICAgICAgIGlmIChjb2wuRVhUUkEgPT09ICdhdXRvX2luY3JlbWVudCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcImF1dG9JZFwiLFxuICAgICAgICAgICAgICAgICAgICBcIm9wdGlvbnNcIjogdGFibGUuQVVUT19JTkNSRU1FTlQgPyB7ICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBcInN0YXJ0RnJvbVwiOiB0YWJsZS5BVVRPX0lOQ1JFTUVOVFxuICAgICAgICAgICAgICAgICAgICB9IDoge31cbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSAhPT0gJ2lkJykge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlSW5mby5vcHRpb25zLm5hbWUgPSBmaWVsZE5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5DT0xVTU5fREVGQVVMVCA9PT0gJ0NVUlJFTlRfVElNRVNUQU1QJykge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlSW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwiY3JlYXRlVGltZXN0YW1wXCJcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5FWFRSQSA9PT0gJ29uIHVwZGF0ZSBDVVJSRU5UX1RJTUVTVEFNUCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcInVwZGF0ZVRpbWVzdGFtcFwiXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgPT09ICdpc0RlbGV0ZWQnICYmIGNvbC5DT0xVTU5fVFlQRSA9PT0gJ3RpbnlpbnQoMSknKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJsb2dpY2FsRGVsZXRpb25cIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaChmZWF0dXJlSW5mbyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZmllbGRJbmZvID0gdGhpcy5fbXlzcWxUeXBlVG9Pb2xUeXBlKHRhYmxlLCBjb2wsIGZpZWxkTmFtZSwgdHlwZXMpO1xuXG4gICAgICAgICAgICBpZiAoY29sLklTX05VTExBQkxFID09PSAnWUVTJykge1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mby5vcHRpb25hbCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0RFRkFVTFQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uZGVmYXVsdCA9IGNvbC5DT0xVTU5fREVGQVVMVDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbC5DT0xVTU5fQ09NTUVOVCkge1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mby5jb21tZW50ID0gY29sLkNPTFVNTl9DT01NRU5UO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWVsZHNbZmllbGROYW1lXSA9IGZpZWxkSW5mbztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHsgZmVhdHVyZXMsIGZpZWxkcywgdHlwZXMgfTtcbiAgICB9XG5cbiAgICBfZmllbGROYW1pbmcobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlUnVsZXMuZmllbGROYW1pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJldmVyc2VSdWxlcy5maWVsZE5hbWluKG5hbWUpO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIE9vbFV0aWxzLmZpZWxkTmFtaW5nKG5hbWUpO1xuICAgIH1cblxuICAgIF9lbnRpdHlOYW1pbmcobmFtZSkge1xuICAgICAgICBpZiAodGhpcy5yZXZlcnNlUnVsZXMuZW50aXR5TmFtaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXZlcnNlUnVsZXMuZW50aXR5TmFtaW5nKG5hbWUpO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIE9vbFV0aWxzLmVudGl0eU5hbWluZyhuYW1lKTtcbiAgICB9XG5cbiAgICBfc2NoZW1hTmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLnNjaGVtYU5hbWluZykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZVJ1bGVzLnNjaGVtYU5hbWluZyhuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5zY2hlbWFOYW1pbmcobmFtZSk7XG4gICAgfVxuXG4gICAgX215c3FsVHlwZVRvT29sVHlwZSh0YWJsZSwgY29sLCBmaWVsZE5hbWUsIHR5cGVzKSB7XG4gICAgICAgIGxldCBhcHBsaWNhYmxlUnVsZSA9IF8uZmluZCh0aGlzLnJldmVyc2VSdWxlcy5jb2x1bW5UeXBlQ29udmVyc2lvbiwgcnVsZSA9PiBydWxlLnRlc3QodGFibGUsIGNvbCkpO1xuICAgICAgICBpZiAoYXBwbGljYWJsZVJ1bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBhcHBsaWNhYmxlUnVsZS5hcHBseSh0YWJsZSwgY29sKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IHR5cGVJbmZvID0ge307ICAgICAgICBcbiAgICAgICAgaWYgKGNvbC5DT0xVTU5fTkFNRSAhPT0gZmllbGROYW1lKSB7XG4gICAgICAgICAgICB0eXBlSW5mby5jb2RlID0gY29sLkNPTFVNTl9OQU1FO1xuICAgICAgICB9XG5cbiAgICAgICAgc3dpdGNoIChjb2wuREFUQV9UWVBFKSB7XG4gICAgICAgICAgICBjYXNlICd2YXJjaGFyJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLm1heExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdjaGFyJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLmZpeGVkTGVuZ3RoID0gY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2JpZ2ludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMTg7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSA4O1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2ludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMTA7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSA0O1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ21lZGl1bWludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgNztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5ieXRlcyA9IDM7XG4gICAgICAgICAgICAgICAgaWYgKF8uZW5kc1dpdGgoY29sLkNPTFVNTl9UWVBFLCAnIHVuc2lnbmVkJykpIHR5cGVJbmZvLnVuc2lnbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnc21hbGxpbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50ZWdlcic7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDQ7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAyO1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3RpbnlpbnQnOlxuICAgICAgICAgICAgICAgIGlmIChfLnN0YXJ0c1dpdGgoY29sLkNPTFVNTl9UWVBFLCAndGlueWludCgxKScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnYm9vbGVhbic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnRlZ2VyJztcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDI7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLmJ5dGVzID0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZW5kc1dpdGgoY29sLkNPTFVNTl9UWVBFLCAnIHVuc2lnbmVkJykpIHR5cGVJbmZvLnVuc2lnbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxuICAgICAgICAgICAgICAgIGxldCBsZWZ0ID0gY29sLkNPTFVNTl9UWVBFLmluZGV4T2YoJygnKTtcbiAgICAgICAgICAgICAgICBsZXQgcmlnaHQgPSBjb2wuQ09MVU1OX1RZUEUubGFzdEluZGV4T2YoJyknKTtcblxuICAgICAgICAgICAgICAgIGxldCB0eXBlTmFtZSA9IHRhYmxlLlRBQkxFX05BTUUgKyBfLnVwcGVyRmlyc3QoY29sLkNPTFVNTl9OQU1FKTtcblxuICAgICAgICAgICAgICAgIHR5cGVzW3R5cGVOYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2VudW0nLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IGNvbC5DT0xVTU5fVFlQRS5zdWJzdHJpbmcobGVmdCArIDEsIHJpZ2h0KS5zcGxpdCgnLCcpLm1hcCh2ID0+IHYuc3Vic3RyKDEsIHYubGVuZ3RoIC0gMikpXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSB0eXBlTmFtZTtcblxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLm1heExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2RhdGV0aW1lJzpcbiAgICAgICAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdkYXRldGltZSc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2RlY2ltYWwnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnbnVtYmVyJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50b3RhbERpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTjtcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kZWNpbWFsRGlnaXRzID0gY29sLk5VTUVSSUNfU0NBTEU7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZXhhY3QgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdmbG9hdCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdudW1iZXInO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnRvdGFsRGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRlY2ltYWxEaWdpdHMgPSBjb2wuTlVNRVJJQ19TQ0FMRTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjb2wpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVG8gYmUgaW1wbGVtZW50ZWQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvL18uZmluZCh0aGlzLnJldmVyc2VSdWxlcy5jb2x1bW5UeXBlT3B0aW1pemF0aW9uLCBydWxlID0+IHJ1bGUudGVzdCh0YWJsZSwgY29sKSk7XG5cbiAgICAgICAgcmV0dXJuIHR5cGVJbmZvO1xuICAgIH1cblxuICAgIF9yZWZpbmVFbnRpdHlSZWxhdGlvbnNoaXBzKG1hcE9mRW50aXRpZXMpIHtcbiAgICAgICAgbGV0IGVudGl0eUFzc29jID0ge307XG5cbiAgICAgICAgLy8xc3Qgcm91bmRcbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGVudGl0eUluZm8uYXNzb2NpYXRpb25zKSkgcmV0dXJuOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucy5mb3JFYWNoKCh7IHR5cGUsIGZyb20sIGVudGl0eSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHJlZmVkRW50aXR5ID0gbWFwT2ZFbnRpdGllc1tlbnRpdHldO1xuICAgICAgICAgICAgICAgIGxldCBiYWNrUmVmID0gXy5maW5kKHJlZmVkRW50aXR5LmFzc29jaWF0aW9ucywgYXNzb2MgPT4gYXNzb2MuZW50aXR5ID09PSBuYW1lKTtcblxuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnaGFzTWFueScpIHsgICBcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIWJhY2tSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vb25lLXNpZGUgcmVsYXRpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgbmFtZSwgeyB0eXBlOiAncmVmZXJzVG8nLCBmcm9tLCBlbnRpdHkgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvL3RvZG86XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVudGl0eUluZm8pO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2sgcmVmZXJlbmNlOiAke2JhY2tSZWYuZW50aXR5fSAke2JhY2tSZWYudHlwZX0gJHtuYW1lfWApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYmVsb25nc1RvJykge1xuXG4gICAgICAgICAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgbmFtZSwgeyB0eXBlLCBmcm9tLCBlbnRpdHkgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFiYWNrUmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL29uZS1zaWRlIHJlbGF0aW9uICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIGVudGl0eSwgeyB0eXBlOiAnaGFzTWFueScsIGVudGl0eTogbmFtZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgYXNzb2NpYXRpb24gdHlwZTogJyArIHR5cGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIC8vMm5kIHJvdW5kXG4gICAgICAgIF8uZm9yT3duKGVudGl0eUFzc29jLCAoYXNzb2NpYXRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBlbnRpdHlJbmZvIH0gPSBtYXBPZkVudGl0aWVzW25hbWVdO1xuXG4gICAgICAgICAgICBsZXQga2V5QXNzb2NzO1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlbnRpdHlJbmZvLmtleSkgJiYgZW50aXR5SW5mby5rZXkubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAga2V5QXNzb2NzID0gXy5maWx0ZXIoYXNzb2NpYXRpb25zLCBhc3NvYyA9PiBlbnRpdHlJbmZvLmtleS5pbmRleE9mKGFzc29jLmZyb20pICE9PSAtMSk7XG4gICAgICAgICAgICAgICAgaWYgKGtleUFzc29jcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFrZUVudGl0eU1hbnlUb01hbnkoa2V5QXNzb2NzWzBdLmVudGl0eSwga2V5QXNzb2NzWzFdLmVudGl0eSwgZW50aXR5QXNzb2MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5SW5mby5pbmRleGVzLmZvckVhY2goKHsgZmllbGRzIH0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBrZXlBc3NvY3MgPSBfLmZpbHRlcihhc3NvY2lhdGlvbnMsIGFzc29jID0+IGZpZWxkcy5pbmRleE9mKGFzc29jLmZyb20pICE9PSAtMSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChrZXlBc3NvY3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYWtlRW50aXR5TWFueVRvTWFueShrZXlBc3NvY3NbMF0uZW50aXR5LCBrZXlBc3NvY3NbMV0uZW50aXR5LCBlbnRpdHlBc3NvYyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgZW50aXR5SW5mbyB9LCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBlbnRpdHlJbmZvLmFzc29jaWF0aW9ucyA9IGVudGl0eUFzc29jW25hbWVdO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfbWFrZUVudGl0eU1hbnlUb01hbnkoZW50aXR5TmFtZTEsIGVudGl0eU5hbWUyLCBlbnRpdHlBc3NvYykge1xuICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIGVudGl0eU5hbWUxLCB7IHR5cGU6ICdoYXNNYW55JywgZW50aXR5OiBlbnRpdHlOYW1lMiB9KTtcbiAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KGVudGl0eUFzc29jLCBlbnRpdHlOYW1lMiwgeyB0eXBlOiAnaGFzTWFueScsIGVudGl0eTogZW50aXR5TmFtZTEgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMUmV2ZXJzZUVuZ2luZWVyaW5nOyJdfQ==