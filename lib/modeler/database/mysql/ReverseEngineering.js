"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const OolCodeGen = require('../../../lang/OolCodeGen');

const OolUtils = require('../../../lang/OolUtils');

class MySQLReverseEngineering {
  constructor(context, connector) {
    this.logger = context.logger;
    this.connector = connector;
    this.reverseRules = this.connector.options.reverseRules || {};
    this.saveDatabaseMeta = this.connector.options.saveDatabaseMeta || false;
  }

  async reverse_(outputDir) {
    this.logger.log('verbose', `Reverse engineering against ${this.connector.driver} database "${this.connector.database}" ...`);
    fs.ensureDirSync(outputDir);
    let tables = await this.connector.execute_("select * from information_schema.tables where table_schema = ?", [this.connector.database]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(outputDir, this.connector.database + '.meta.json'), JSON.stringify(tables, null, 2));
    }

    let entities = [],
        mapOfEntities = {};
    let entitiesOolPath = path.join(outputDir, 'entities');
    fs.ensureDirSync(entitiesOolPath);
    await Util.eachAsync_(tables, async table => {
      let entityName = this._entityNaming(table.TABLE_NAME);

      entities.push({
        entity: entityName
      });
      mapOfEntities[entityName] = await this.extractTable_(entityName, table, entitiesOolPath);
    });

    this._refineEntityRelationships(mapOfEntities);

    _.forOwn(mapOfEntities, ({
      types,
      entityInfo
    }, entityName) => {
      let entity = {
        type: types,
        entity: {
          [entityName]: entityInfo
        }
      };
      let entityContent = OolCodeGen.transform(entity);
      let entityFile = path.join(entitiesOolPath, entityName + '.ool');
      fs.writeFileSync(entityFile + '.json', JSON.stringify(entity, null, 2));
      fs.writeFileSync(entityFile, entityContent);
      this.logger.log('info', `Extracted entity definition file "${entityFile}".`);
    });

    let schemaName = this._schemaNaming(this.connector.database);

    let json = {
      "namespace": ["entities/**"],
      "schema": {
        [schemaName]: {
          "entities": entities
        }
      }
    };
    let schemaContent = OolCodeGen.transform(json);
    let schemaFile = path.join(outputDir, schemaName + '.ool');
    fs.writeFileSync(schemaFile + '.json', JSON.stringify(json, null, 2));
    fs.writeFileSync(schemaFile, schemaContent);
    this.logger.log('info', `Extracted schema entry file "${schemaFile}".`);
  }

  async extractTable_(entityName, table, extractedOolPath) {
    let columns = await this.connector.execute_("select * from information_schema.columns where table_schema = ? and table_name = ?", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.meta.json'), JSON.stringify(columns, null, 2));
    }

    let {
      features,
      fields,
      types
    } = this._processFields(table, columns);

    let indexInfo = await this.connector.execute_("SHOW INDEXES FROM ??", [table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(indexInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.index.json'), JSON.stringify(indexInfo, null, 2));
    }

    let {
      pk,
      indexes,
      mapNameToIndex
    } = this._processIndexes(indexInfo);

    if (!(pk.length > 0)) {
      throw new Error("Assertion failed: pk.length > 0");
    }

    let referencesInfo = await this.connector.execute_("SELECT * FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE `REFERENCED_TABLE_SCHEMA` = ? AND `TABLE_NAME` = ? AND `REFERENCED_TABLE_NAME` IS NOT NULL", [this.connector.database, table.TABLE_NAME]);

    if (this.saveDatabaseMeta && !_.isEmpty(referencesInfo)) {
      fs.writeFileSync(path.join(extractedOolPath, table.TABLE_NAME + '.ref.json'), JSON.stringify(referencesInfo, null, 2));
    }

    let associations = await this._processReferences_(referencesInfo, mapNameToIndex, fields);
    let entityInfo = {
      comment: table.TABLE_COMMENT,
      features,
      fields,
      associations,
      key: pk.length > 1 ? pk : pk[0],
      indexes
    };

    if (entityName !== table.TABLE_NAME) {
      entityInfo.code = table.TABLE_NAME;
    }

    return {
      types,
      entityInfo
    };
  }

  async _processReferences_(referencesInfo, mapNameToIndex, fields) {
    let associations = [];
    let l = referencesInfo.length;

    for (let i = 0; i < l; i++) {
      let ref = referencesInfo[i];
      let [refTableKey] = await this.connector.execute_("SHOW INDEXES FROM ?? WHERE `Key_name` = 'PRIMARY'", [ref.REFERENCED_TABLE_NAME]);

      if (refTableKey.Column_name.toLowerCase() !== ref.REFERENCED_COLUMN_NAME.toLowerCase()) {
        throw new Error(`Foreign key "${ref.COLUMN_NAME}" not reference to the primary key.`);
      }

      let unique = false;
      let fkInfo = mapNameToIndex[ref.CONSTRAINT_NAME];

      if (fkInfo) {
        if (fkInfo.length > 1) {
          throw new Error(`Combination foreign key is not supported: "${ref.CONSTRAINT_NAME}"`);
        }

        unique = fkInfo[0].Non_unique === 0;
      }

      let fkColName = this._fieldNaming(ref.COLUMN_NAME);

      if (unique) {
        associations.push({
          type: 'belongsTo',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      } else {
        associations.push({
          type: 'hasMany',
          from: fkColName,
          entity: this._entityNaming(ref.REFERENCED_TABLE_NAME)
        });
      }

      fields[fkColName] = {
        type: '$association',
        code: fields[fkColName].code
      };
    }

    return associations;
  }

  _processIndexes(indexInfo) {
    let pk = [],
        indexes = [];
    let mapNameToIndex = {};
    indexInfo.forEach(i => {
      Util.putIntoBucket(mapNameToIndex, i.Key_name, i);
    });

    _.forOwn(mapNameToIndex, (fields, name) => {
      if (name === 'PRIMARY') {
        pk.push(fields.map(f => this._fieldNaming(f.Column_name)));
      } else {
        indexes.push({
          name: name,
          fields: fields.map(f => this._fieldNaming(f.Column_name)),
          unique: fields[0].Non_unique === 0,
          nullable: fields[0].Null === 'YES'
        });
      }
    });

    return {
      pk,
      indexes,
      mapNameToIndex
    };
  }

  _processFields(table, columns) {
    let features = [],
        fields = {},
        types = {};
    columns.forEach(col => {
      let fieldName = this._fieldNaming(col.COLUMN_NAME);

      if (col.EXTRA === 'auto_increment') {
        let featureInfo = {
          "name": "autoId",
          "options": table.AUTO_INCREMENT ? {
            "startFrom": table.AUTO_INCREMENT
          } : {}
        };

        if (fieldName !== 'id') {
          featureInfo.options.name = fieldName;
        }

        features.push(featureInfo);
        return;
      }

      if (col.COLUMN_DEFAULT === 'CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "createTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (col.EXTRA === 'on update CURRENT_TIMESTAMP') {
        let featureInfo = {
          "name": "updateTimestamp"
        };
        features.push(featureInfo);
        return;
      }

      if (fieldName === 'isDeleted' && col.COLUMN_TYPE === 'tinyint(1)') {
        let featureInfo = {
          "name": "logicalDeletion"
        };
        features.push(featureInfo);
        return;
      }

      let fieldInfo = this._mysqlTypeToOolType(table, col, fieldName, types);

      if (col.IS_NULLABLE === 'YES') {
        fieldInfo.optional = true;
      }

      if (col.COLUMN_DEFAULT) {
        fieldInfo.default = col.COLUMN_DEFAULT;
      }

      if (col.COLUMN_COMMENT) {
        fieldInfo.comment = col.COLUMN_COMMENT;
      }

      fields[fieldName] = fieldInfo;
    });
    return {
      features,
      fields,
      types
    };
  }

  _fieldNaming(name) {
    if (this.reverseRules.fieldNaming) {
      return this.reverseRules.fieldNamin(name);
    }

    return OolUtils.fieldNaming(name);
  }

  _entityNaming(name) {
    if (this.reverseRules.entityNaming) {
      return this.reverseRules.entityNaming(name);
    }

    return OolUtils.entityNaming(name);
  }

  _schemaNaming(name) {
    if (this.reverseRules.schemaNaming) {
      return this.reverseRules.schemaNaming(name);
    }

    return OolUtils.schemaNaming(name);
  }

  _mysqlTypeToOolType(table, col, fieldName, types) {
    let applicableRule = _.find(this.reverseRules.columnTypeConversion, rule => rule.test(table, col));

    if (applicableRule) {
      return applicableRule.apply(table, col);
    }

    let typeInfo = {};

    if (col.COLUMN_NAME !== fieldName) {
      typeInfo.code = col.COLUMN_NAME;
    }

    switch (col.DATA_TYPE) {
      case 'varchar':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'char':
        typeInfo.type = 'text';

        if (col.CHARACTER_MAXIMUM_LENGTH) {
          typeInfo.fixedLength = col.CHARACTER_MAXIMUM_LENGTH;
        }

        break;

      case 'bigint':
        typeInfo.type = 'int';
        typeInfo.digits = col.NUMERIC_PRECISION || 18;
        typeInfo.bytes = 8;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'int':
        typeInfo.type = 'int';
        typeInfo.digits = col.NUMERIC_PRECISION || 10;
        typeInfo.bytes = 4;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'mediumint':
        typeInfo.type = 'int';
        typeInfo.digits = col.NUMERIC_PRECISION || 7;
        typeInfo.bytes = 3;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'smallint':
        typeInfo.type = 'int';
        typeInfo.digits = col.NUMERIC_PRECISION || 4;
        typeInfo.bytes = 2;
        if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        break;

      case 'tinyint':
        if (_.startsWith(col.COLUMN_TYPE, 'tinyint(1)')) {
          typeInfo.type = 'bool';
        } else {
          typeInfo.type = 'int';
          typeInfo.digits = col.NUMERIC_PRECISION || 2;
          typeInfo.bytes = 1;
          if (_.endsWith(col.COLUMN_TYPE, ' unsigned')) typeInfo.unsigned = true;
        }

        break;

      case 'enum':
        let left = col.COLUMN_TYPE.indexOf('(');
        let right = col.COLUMN_TYPE.lastIndexOf(')');

        let typeName = table.TABLE_NAME + _.upperFirst(col.COLUMN_NAME);

        types[typeName] = {
          type: 'enum',
          values: col.COLUMN_TYPE.substring(left + 1, right).split(',').map(v => v.substr(1, v.length - 2))
        };
        typeInfo.type = typeName;
        break;

      case 'text':
        typeInfo.type = 'text';
        typeInfo.maxLength = col.CHARACTER_MAXIMUM_LENGTH;
        break;

      case 'datetime':
      case 'timestamp':
        typeInfo.type = 'datetime';
        break;

      case 'decimal':
        typeInfo.type = 'decimal';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      case 'float':
        typeInfo.type = 'float';
        typeInfo.totalDigits = col.NUMERIC_PRECISION;
        typeInfo.decimalDigits = col.NUMERIC_SCALE;
        break;

      default:
        console.log(col);
        throw new Error('To be implemented.');
    }

    return typeInfo;
  }

  _refineEntityRelationships(mapOfEntities) {
    let entityAssoc = {};

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      if (_.isEmpty(entityInfo.associations)) return;
      entityInfo.associations.forEach(({
        type,
        from,
        entity
      }) => {
        let refedEntity = mapOfEntities[entity];

        let backRef = _.find(refedEntity.associations, assoc => assoc.entity === name);

        if (type === 'hasMany') {
          if (!backRef) {
            Util.putIntoBucket(entityAssoc, name, {
              type: 'refersTo',
              from,
              entity
            });
            return;
          }

          console.log(entityInfo);
          throw new Error(`Back reference: ${backRef.entity} ${backRef.type} ${name}`);
        } else if (type === 'belongsTo') {
          Util.putIntoBucket(entityAssoc, name, {
            type,
            from,
            entity
          });

          if (!backRef) {
            Util.putIntoBucket(entityAssoc, entity, {
              type: 'hasMany',
              entity: name
            });
            return;
          }
        } else {
          throw new Error('Unexpected association type: ' + type);
        }
      });
    });

    _.forOwn(entityAssoc, (associations, name) => {
      let {
        entityInfo
      } = mapOfEntities[name];
      let keyAssocs;

      if (Array.isArray(entityInfo.key) && entityInfo.key.length === 2) {
        keyAssocs = _.filter(associations, assoc => entityInfo.key.indexOf(assoc.from) !== -1);

        if (keyAssocs.length === 2) {
          this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
        }
      }

      entityInfo.indexes.forEach(({
        fields
      }) => {
        if (fields.length === 2) {
          keyAssocs = _.filter(associations, assoc => fields.indexOf(assoc.from) !== -1);

          if (keyAssocs.length === 2) {
            this._makeEntityManyToMany(keyAssocs[0].entity, keyAssocs[1].entity, entityAssoc);
          }
        }
      });
    });

    _.forOwn(mapOfEntities, ({
      entityInfo
    }, name) => {
      entityInfo.associations = entityAssoc[name];
    });
  }

  _makeEntityManyToMany(entityName1, entityName2, entityAssoc) {
    Util.putIntoBucket(entityAssoc, entityName1, {
      type: 'hasMany',
      entity: entityName2
    });
    Util.putIntoBucket(entityAssoc, entityName2, {
      type: 'hasMany',
      entity: entityName1
    });
  }

}

module.exports = MySQLReverseEngineering;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2RlbGVyL2RhdGFiYXNlL215c3FsL1JldmVyc2VFbmdpbmVlcmluZy5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJPb2xDb2RlR2VuIiwiT29sVXRpbHMiLCJNeVNRTFJldmVyc2VFbmdpbmVlcmluZyIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImNvbm5lY3RvciIsImxvZ2dlciIsInJldmVyc2VSdWxlcyIsIm9wdGlvbnMiLCJzYXZlRGF0YWJhc2VNZXRhIiwicmV2ZXJzZV8iLCJvdXRwdXREaXIiLCJsb2ciLCJkcml2ZXIiLCJkYXRhYmFzZSIsImVuc3VyZURpclN5bmMiLCJ0YWJsZXMiLCJleGVjdXRlXyIsIndyaXRlRmlsZVN5bmMiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVudGl0aWVzIiwibWFwT2ZFbnRpdGllcyIsImVudGl0aWVzT29sUGF0aCIsImVhY2hBc3luY18iLCJ0YWJsZSIsImVudGl0eU5hbWUiLCJfZW50aXR5TmFtaW5nIiwiVEFCTEVfTkFNRSIsInB1c2giLCJlbnRpdHkiLCJleHRyYWN0VGFibGVfIiwiX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMiLCJmb3JPd24iLCJ0eXBlcyIsImVudGl0eUluZm8iLCJ0eXBlIiwiZW50aXR5Q29udGVudCIsInRyYW5zZm9ybSIsImVudGl0eUZpbGUiLCJzY2hlbWFOYW1lIiwiX3NjaGVtYU5hbWluZyIsImpzb24iLCJzY2hlbWFDb250ZW50Iiwic2NoZW1hRmlsZSIsImV4dHJhY3RlZE9vbFBhdGgiLCJjb2x1bW5zIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJfcHJvY2Vzc0ZpZWxkcyIsImluZGV4SW5mbyIsImlzRW1wdHkiLCJwayIsImluZGV4ZXMiLCJtYXBOYW1lVG9JbmRleCIsIl9wcm9jZXNzSW5kZXhlcyIsImxlbmd0aCIsInJlZmVyZW5jZXNJbmZvIiwiYXNzb2NpYXRpb25zIiwiX3Byb2Nlc3NSZWZlcmVuY2VzXyIsImNvbW1lbnQiLCJUQUJMRV9DT01NRU5UIiwia2V5IiwiY29kZSIsImwiLCJpIiwicmVmIiwicmVmVGFibGVLZXkiLCJSRUZFUkVOQ0VEX1RBQkxFX05BTUUiLCJDb2x1bW5fbmFtZSIsInRvTG93ZXJDYXNlIiwiUkVGRVJFTkNFRF9DT0xVTU5fTkFNRSIsIkVycm9yIiwiQ09MVU1OX05BTUUiLCJ1bmlxdWUiLCJma0luZm8iLCJDT05TVFJBSU5UX05BTUUiLCJOb25fdW5pcXVlIiwiZmtDb2xOYW1lIiwiX2ZpZWxkTmFtaW5nIiwiZnJvbSIsImZvckVhY2giLCJwdXRJbnRvQnVja2V0IiwiS2V5X25hbWUiLCJuYW1lIiwibWFwIiwiZiIsIm51bGxhYmxlIiwiTnVsbCIsImNvbCIsImZpZWxkTmFtZSIsIkVYVFJBIiwiZmVhdHVyZUluZm8iLCJBVVRPX0lOQ1JFTUVOVCIsIkNPTFVNTl9ERUZBVUxUIiwiQ09MVU1OX1RZUEUiLCJmaWVsZEluZm8iLCJfbXlzcWxUeXBlVG9Pb2xUeXBlIiwiSVNfTlVMTEFCTEUiLCJvcHRpb25hbCIsImRlZmF1bHQiLCJDT0xVTU5fQ09NTUVOVCIsImZpZWxkTmFtaW5nIiwiZmllbGROYW1pbiIsImVudGl0eU5hbWluZyIsInNjaGVtYU5hbWluZyIsImFwcGxpY2FibGVSdWxlIiwiZmluZCIsImNvbHVtblR5cGVDb252ZXJzaW9uIiwicnVsZSIsInRlc3QiLCJhcHBseSIsInR5cGVJbmZvIiwiREFUQV9UWVBFIiwiQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIIiwibWF4TGVuZ3RoIiwiZml4ZWRMZW5ndGgiLCJkaWdpdHMiLCJOVU1FUklDX1BSRUNJU0lPTiIsImJ5dGVzIiwiZW5kc1dpdGgiLCJ1bnNpZ25lZCIsInN0YXJ0c1dpdGgiLCJsZWZ0IiwiaW5kZXhPZiIsInJpZ2h0IiwibGFzdEluZGV4T2YiLCJ0eXBlTmFtZSIsInVwcGVyRmlyc3QiLCJ2YWx1ZXMiLCJzdWJzdHJpbmciLCJzcGxpdCIsInYiLCJzdWJzdHIiLCJ0b3RhbERpZ2l0cyIsImRlY2ltYWxEaWdpdHMiLCJOVU1FUklDX1NDQUxFIiwiY29uc29sZSIsImVudGl0eUFzc29jIiwicmVmZWRFbnRpdHkiLCJiYWNrUmVmIiwiYXNzb2MiLCJrZXlBc3NvY3MiLCJBcnJheSIsImlzQXJyYXkiLCJmaWx0ZXIiLCJfbWFrZUVudGl0eU1hbnlUb01hbnkiLCJlbnRpdHlOYW1lMSIsImVudGl0eU5hbWUyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZRixJQUFsQjs7QUFDQSxNQUFNRyxVQUFVLEdBQUdKLE9BQU8sQ0FBQywwQkFBRCxDQUExQjs7QUFDQSxNQUFNSyxRQUFRLEdBQUdMLE9BQU8sQ0FBQyx3QkFBRCxDQUF4Qjs7QUFFQSxNQUFNTSx1QkFBTixDQUE4QjtBQUMxQkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLFNBQVYsRUFBcUI7QUFDNUIsU0FBS0MsTUFBTCxHQUFjRixPQUFPLENBQUNFLE1BQXRCO0FBQ0EsU0FBS0QsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLRSxZQUFMLEdBQW9CLEtBQUtGLFNBQUwsQ0FBZUcsT0FBZixDQUF1QkQsWUFBdkIsSUFBdUMsRUFBM0Q7QUFDQSxTQUFLRSxnQkFBTCxHQUF3QixLQUFLSixTQUFMLENBQWVHLE9BQWYsQ0FBdUJDLGdCQUF2QixJQUEyQyxLQUFuRTtBQUNIOztBQUVELFFBQU1DLFFBQU4sQ0FBZUMsU0FBZixFQUEwQjtBQUN0QixTQUFLTCxNQUFMLENBQVlNLEdBQVosQ0FBZ0IsU0FBaEIsRUFBNEIsK0JBQThCLEtBQUtQLFNBQUwsQ0FBZVEsTUFBTyxjQUFhLEtBQUtSLFNBQUwsQ0FBZVMsUUFBUyxPQUFySDtBQUVBZixJQUFBQSxFQUFFLENBQUNnQixhQUFI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Q3RELElBQUQsQ0FBckM7QUFDSCxLQUZEO0FBR0g7O0FBRUQ4RCxFQUFBQSxxQkFBcUIsQ0FBQ0MsV0FBRCxFQUFjQyxXQUFkLEVBQTJCVixXQUEzQixFQUF3QztBQUN6RDlJLElBQUFBLElBQUksQ0FBQ3NGLGFBQUwsQ0FBbUJ3RCxXQUFuQixFQUFnQ1MsV0FBaEMsRUFBNkM7QUFBRS9HLE1BQUFBLElBQUksRUFBRSxTQUFSO0FBQW1CTixNQUFBQSxNQUFNLEVBQUVzSDtBQUEzQixLQUE3QztBQUNBeEosSUFBQUEsSUFBSSxDQUFDc0YsYUFBTCxDQUFtQndELFdBQW5CLEVBQWdDVSxXQUFoQyxFQUE2QztBQUFFaEgsTUFBQUEsSUFBSSxFQUFFLFNBQVI7QUFBbUJOLE1BQUFBLE1BQU0sRUFBRXFIO0FBQTNCLEtBQTdDO0FBQ0g7O0FBaGN5Qjs7QUFtYzlCRSxNQUFNLENBQUNDLE9BQVAsR0FBaUJySix1QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIGZzIH0gPSBVdGlsO1xuY29uc3QgT29sQ29kZUdlbiA9IHJlcXVpcmUoJy4uLy4uLy4uL2xhbmcvT29sQ29kZUdlbicpO1xuY29uc3QgT29sVXRpbHMgPSByZXF1aXJlKCcuLi8uLi8uLi9sYW5nL09vbFV0aWxzJyk7XG5cbmNsYXNzIE15U1FMUmV2ZXJzZUVuZ2luZWVyaW5nIHtcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjtcbiAgICAgICAgdGhpcy5jb25uZWN0b3IgPSBjb25uZWN0b3I7ICAgICAgICBcblxuICAgICAgICB0aGlzLnJldmVyc2VSdWxlcyA9IHRoaXMuY29ubmVjdG9yLm9wdGlvbnMucmV2ZXJzZVJ1bGVzIHx8IHt9OyAgICAgICBcbiAgICAgICAgdGhpcy5zYXZlRGF0YWJhc2VNZXRhID0gdGhpcy5jb25uZWN0b3Iub3B0aW9ucy5zYXZlRGF0YWJhc2VNZXRhIHx8IGZhbHNlO1xuICAgIH1cblxuICAgIGFzeW5jIHJldmVyc2VfKG91dHB1dERpcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCBgUmV2ZXJzZSBlbmdpbmVlcmluZyBhZ2FpbnN0ICR7dGhpcy5jb25uZWN0b3IuZHJpdmVyfSBkYXRhYmFzZSBcIiR7dGhpcy5jb25uZWN0b3IuZGF0YWJhc2V9XCIgLi4uYCk7XG5cbiAgICAgICAgZnMuZW5zdXJlRGlyU3luYyhvdXRwdXREaXIpO1xuXG4gICAgICAgIGxldCB0YWJsZXMgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcInNlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLnRhYmxlcyB3aGVyZSB0YWJsZV9zY2hlbWEgPSA/XCIsIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UgXSk7ICAgICAgICBcblxuICAgICAgICBpZiAodGhpcy5zYXZlRGF0YWJhc2VNZXRhKSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihvdXRwdXREaXIsIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlICsgJy5tZXRhLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkodGFibGVzLCBudWxsLCAyKSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZW50aXRpZXMgPSBbXSwgbWFwT2ZFbnRpdGllcyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgbGV0IGVudGl0aWVzT29sUGF0aCA9IHBhdGguam9pbihvdXRwdXREaXIsICdlbnRpdGllcycpO1xuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKGVudGl0aWVzT29sUGF0aCk7XG5cbiAgICAgICAgYXdhaXQgVXRpbC5lYWNoQXN5bmNfKHRhYmxlcywgYXN5bmMgdGFibGUgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSB0aGlzLl9lbnRpdHlOYW1pbmcodGFibGUuVEFCTEVfTkFNRSk7XG5cbiAgICAgICAgICAgIGVudGl0aWVzLnB1c2goeyBlbnRpdHk6IGVudGl0eU5hbWUgfSk7ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIG1hcE9mRW50aXRpZXNbZW50aXR5TmFtZV0gPSBhd2FpdCB0aGlzLmV4dHJhY3RUYWJsZV8oZW50aXR5TmFtZSwgdGFibGUsIGVudGl0aWVzT29sUGF0aCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3JlZmluZUVudGl0eVJlbGF0aW9uc2hpcHMobWFwT2ZFbnRpdGllcyk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwT2ZFbnRpdGllcywgKHsgdHlwZXMsIGVudGl0eUluZm8gfSwgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlcyxcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgW2VudGl0eU5hbWVdOiBlbnRpdHlJbmZvXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICBcbiAgICAgICAgICAgIGxldCBlbnRpdHlDb250ZW50ID0gT29sQ29kZUdlbi50cmFuc2Zvcm0oZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBlbnRpdHlGaWxlID0gcGF0aC5qb2luKGVudGl0aWVzT29sUGF0aCwgZW50aXR5TmFtZSArICcub29sJyk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGVudGl0eUZpbGUgKyAnLmpzb24nLCBKU09OLnN0cmluZ2lmeShlbnRpdHksIG51bGwsIDIpKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZW50aXR5RmlsZSwgZW50aXR5Q29udGVudCk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgRXh0cmFjdGVkIGVudGl0eSBkZWZpbml0aW9uIGZpbGUgXCIke2VudGl0eUZpbGV9XCIuYCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBzY2hlbWFOYW1lID0gdGhpcy5fc2NoZW1hTmFtaW5nKHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlKTtcblxuICAgICAgICBsZXQganNvbiA9IHtcbiAgICAgICAgICAgIFwibmFtZXNwYWNlXCI6IFtcbiAgICAgICAgICAgICAgICBcImVudGl0aWVzLyoqXCJcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBcInNjaGVtYVwiOiB7XG4gICAgICAgICAgICAgICAgW3NjaGVtYU5hbWVdOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiZW50aXRpZXNcIjogZW50aXRpZXMgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IHNjaGVtYUNvbnRlbnQgPSBPb2xDb2RlR2VuLnRyYW5zZm9ybShqc29uKTtcbiAgICAgICAgbGV0IHNjaGVtYUZpbGUgPSBwYXRoLmpvaW4ob3V0cHV0RGlyLCBzY2hlbWFOYW1lICsgJy5vb2wnKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhzY2hlbWFGaWxlICsgJy5qc29uJywgSlNPTi5zdHJpbmdpZnkoanNvbiwgbnVsbCwgMikpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHNjaGVtYUZpbGUsIHNjaGVtYUNvbnRlbnQpO1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgRXh0cmFjdGVkIHNjaGVtYSBlbnRyeSBmaWxlIFwiJHtzY2hlbWFGaWxlfVwiLmApO1xuICAgIH1cblxuICAgIGFzeW5jIGV4dHJhY3RUYWJsZV8oZW50aXR5TmFtZSwgdGFibGUsIGV4dHJhY3RlZE9vbFBhdGgpIHtcbiAgICAgICAgbGV0IGNvbHVtbnMgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhcInNlbGVjdCAqIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLmNvbHVtbnMgd2hlcmUgdGFibGVfc2NoZW1hID0gPyBhbmQgdGFibGVfbmFtZSA9ID9cIixcbiAgICAgICAgICAgIFt0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSwgdGFibGUuVEFCTEVfTkFNRV0pO1xuXG4gICAgICAgIGlmICh0aGlzLnNhdmVEYXRhYmFzZU1ldGEpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGV4dHJhY3RlZE9vbFBhdGgsIHRhYmxlLlRBQkxFX05BTUUgKyAnLm1ldGEuanNvbicpLCBKU09OLnN0cmluZ2lmeShjb2x1bW5zLCBudWxsLCAyKSk7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIGxldCB7IGZlYXR1cmVzLCBmaWVsZHMsIHR5cGVzIH0gPSB0aGlzLl9wcm9jZXNzRmllbGRzKHRhYmxlLCBjb2x1bW5zKTtcblxuICAgICAgICBsZXQgaW5kZXhJbmZvID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oXCJTSE9XIElOREVYRVMgRlJPTSA/P1wiLCBbIHRhYmxlLlRBQkxFX05BTUUgXSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSAmJiAhXy5pc0VtcHR5KGluZGV4SW5mbykpIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGV4dHJhY3RlZE9vbFBhdGgsIHRhYmxlLlRBQkxFX05BTUUgKyAnLmluZGV4Lmpzb24nKSwgSlNPTi5zdHJpbmdpZnkoaW5kZXhJbmZvLCBudWxsLCAyKSk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgbGV0IHsgcGssIGluZGV4ZXMsIG1hcE5hbWVUb0luZGV4IH0gPSB0aGlzLl9wcm9jZXNzSW5kZXhlcyhpbmRleEluZm8pO1xuXG4gICAgICAgIGFzc2VydDogcGsubGVuZ3RoID4gMDsgICAgICAgIFxuXG4gICAgICAgIGxldCByZWZlcmVuY2VzSW5mbyA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwiU0VMRUNUICogRlJPTSBJTkZPUk1BVElPTl9TQ0hFTUEuS0VZX0NPTFVNTl9VU0FHRSBXSEVSRSBgUkVGRVJFTkNFRF9UQUJMRV9TQ0hFTUFgID0gPyBBTkQgYFRBQkxFX05BTUVgID0gPyBBTkQgYFJFRkVSRU5DRURfVEFCTEVfTkFNRWAgSVMgTk9UIE5VTExcIixcbiAgICAgICAgICAgIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UsIHRhYmxlLlRBQkxFX05BTUUgXSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2F2ZURhdGFiYXNlTWV0YSAmJiAhXy5pc0VtcHR5KHJlZmVyZW5jZXNJbmZvKSkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oZXh0cmFjdGVkT29sUGF0aCwgdGFibGUuVEFCTEVfTkFNRSArICcucmVmLmpzb24nKSwgSlNPTi5zdHJpbmdpZnkocmVmZXJlbmNlc0luZm8sIG51bGwsIDIpKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gYXdhaXQgdGhpcy5fcHJvY2Vzc1JlZmVyZW5jZXNfKHJlZmVyZW5jZXNJbmZvLCBtYXBOYW1lVG9JbmRleCwgZmllbGRzKTtcblxuICAgICAgICBsZXQgZW50aXR5SW5mbyA9IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRhYmxlLlRBQkxFX0NPTU1FTlQsXG4gICAgICAgICAgICBmZWF0dXJlcyxcbiAgICAgICAgICAgIGZpZWxkcyxcbiAgICAgICAgICAgIGFzc29jaWF0aW9ucyxcbiAgICAgICAgICAgIGtleSA6IHBrLmxlbmd0aCA+IDEgPyBwayA6IHBrWzBdLFxuICAgICAgICAgICAgaW5kZXhlc1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChlbnRpdHlOYW1lICE9PSB0YWJsZS5UQUJMRV9OQU1FKSB7XG4gICAgICAgICAgICBlbnRpdHlJbmZvLmNvZGUgPSB0YWJsZS5UQUJMRV9OQU1FO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHsgdHlwZXMsIGVudGl0eUluZm8gfTtcbiAgICB9XG5cbiAgICBhc3luYyBfcHJvY2Vzc1JlZmVyZW5jZXNfKHJlZmVyZW5jZXNJbmZvLCBtYXBOYW1lVG9JbmRleCwgZmllbGRzKSB7XG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBbXTtcblxuICAgICAgICBsZXQgbCA9IHJlZmVyZW5jZXNJbmZvLmxlbmd0aDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgICAgICAgbGV0IHJlZiA9IHJlZmVyZW5jZXNJbmZvW2ldO1xuXG4gICAgICAgICAgICBsZXQgW3JlZlRhYmxlS2V5XSA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKFwiU0hPVyBJTkRFWEVTIEZST00gPz8gV0hFUkUgYEtleV9uYW1lYCA9ICdQUklNQVJZJ1wiLCBbcmVmLlJFRkVSRU5DRURfVEFCTEVfTkFNRV0pO1xuXG4gICAgICAgICAgICBpZiAocmVmVGFibGVLZXkuQ29sdW1uX25hbWUudG9Mb3dlckNhc2UoKSAhPT0gcmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRm9yZWlnbiBrZXkgXCIke3JlZi5DT0xVTU5fTkFNRX1cIiBub3QgcmVmZXJlbmNlIHRvIHRoZSBwcmltYXJ5IGtleS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHVuaXF1ZSA9IGZhbHNlO1xuXG4gICAgICAgICAgICBsZXQgZmtJbmZvID0gbWFwTmFtZVRvSW5kZXhbcmVmLkNPTlNUUkFJTlRfTkFNRV07IFxuICAgICAgICAgICAgaWYgKGZrSW5mbykge1xuICAgICAgICAgICAgICAgIGlmIChma0luZm8ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbWJpbmF0aW9uIGZvcmVpZ24ga2V5IGlzIG5vdCBzdXBwb3J0ZWQ6IFwiJHtyZWYuQ09OU1RSQUlOVF9OQU1FfVwiYCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdW5pcXVlID0gZmtJbmZvWzBdLk5vbl91bmlxdWUgPT09IDA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBma0NvbE5hbWUgPSB0aGlzLl9maWVsZE5hbWluZyhyZWYuQ09MVU1OX05BTUUpO1xuXG4gICAgICAgICAgICBpZiAodW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NpYXRpb25zLnB1c2goeyB0eXBlOiAnYmVsb25nc1RvJywgZnJvbTogZmtDb2xOYW1lLCBlbnRpdHk6IHRoaXMuX2VudGl0eU5hbWluZyhyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKSB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXNzb2NpYXRpb25zLnB1c2goeyB0eXBlOiAnaGFzTWFueScsIGZyb206IGZrQ29sTmFtZSwgIGVudGl0eTogdGhpcy5fZW50aXR5TmFtaW5nKHJlZi5SRUZFUkVOQ0VEX1RBQkxFX05BTUUpIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWVsZHNbZmtDb2xOYW1lXSA9IHsgdHlwZTogJyRhc3NvY2lhdGlvbicsIGNvZGU6IGZpZWxkc1tma0NvbE5hbWVdLmNvZGUgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhc3NvY2lhdGlvbnM7XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NJbmRleGVzKGluZGV4SW5mbykge1xuICAgICAgICBsZXQgcGsgPSBbXSwgaW5kZXhlcyA9IFtdO1xuXG4gICAgICAgIGxldCBtYXBOYW1lVG9JbmRleCA9IHt9O1xuXG4gICAgICAgIGluZGV4SW5mby5mb3JFYWNoKGkgPT4ge1xuICAgICAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KG1hcE5hbWVUb0luZGV4LCBpLktleV9uYW1lLCBpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgXy5mb3JPd24obWFwTmFtZVRvSW5kZXgsIChmaWVsZHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSAnUFJJTUFSWScpIHtcbiAgICAgICAgICAgICAgICBway5wdXNoKGZpZWxkcy5tYXAoZiA9PiB0aGlzLl9maWVsZE5hbWluZyhmLkNvbHVtbl9uYW1lKSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbmRleGVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IGZpZWxkcy5tYXAoZiA9PiB0aGlzLl9maWVsZE5hbWluZyhmLkNvbHVtbl9uYW1lKSksXG4gICAgICAgICAgICAgICAgICAgIHVuaXF1ZTogZmllbGRzWzBdLk5vbl91bmlxdWUgPT09IDAsXG4gICAgICAgICAgICAgICAgICAgIG51bGxhYmxlOiBmaWVsZHNbMF0uTnVsbCA9PT0gJ1lFUydcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHsgcGssIGluZGV4ZXMsIG1hcE5hbWVUb0luZGV4IH07XG4gICAgfVxuXG4gICAgX3Byb2Nlc3NGaWVsZHModGFibGUsIGNvbHVtbnMpIHtcbiAgICAgICAgbGV0IGZlYXR1cmVzID0gW10sIGZpZWxkcyA9IHt9LCB0eXBlcyA9IHt9O1xuXG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaChjb2wgPT4ge1xuICAgICAgICAgICAgbGV0IGZpZWxkTmFtZSA9IHRoaXMuX2ZpZWxkTmFtaW5nKGNvbC5DT0xVTU5fTkFNRSk7XG4gICAgICAgICAgICBpZiAoY29sLkVYVFJBID09PSAnYXV0b19pbmNyZW1lbnQnKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJhdXRvSWRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJvcHRpb25zXCI6IHRhYmxlLkFVVE9fSU5DUkVNRU5UID8geyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJzdGFydEZyb21cIjogdGFibGUuQVVUT19JTkNSRU1FTlRcbiAgICAgICAgICAgICAgICAgICAgfSA6IHt9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgIT09ICdpZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZUluZm8ub3B0aW9ucy5uYW1lID0gZmllbGROYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0RFRkFVTFQgPT09ICdDVVJSRU5UX1RJTUVTVEFNUCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZUluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcImNyZWF0ZVRpbWVzdGFtcFwiXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKGZlYXR1cmVJbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuRVhUUkEgPT09ICdvbiB1cGRhdGUgQ1VSUkVOVF9USU1FU1RBTVAnKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJ1cGRhdGVUaW1lc3RhbXBcIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaChmZWF0dXJlSW5mbyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZmllbGROYW1lID09PSAnaXNEZWxldGVkJyAmJiBjb2wuQ09MVU1OX1RZUEUgPT09ICd0aW55aW50KDEpJykge1xuICAgICAgICAgICAgICAgIGxldCBmZWF0dXJlSW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwibG9naWNhbERlbGV0aW9uXCJcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goZmVhdHVyZUluZm8pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZpZWxkSW5mbyA9IHRoaXMuX215c3FsVHlwZVRvT29sVHlwZSh0YWJsZSwgY29sLCBmaWVsZE5hbWUsIHR5cGVzKTtcblxuICAgICAgICAgICAgaWYgKGNvbC5JU19OVUxMQUJMRSA9PT0gJ1lFUycpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8ub3B0aW9uYWwgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29sLkNPTFVNTl9ERUZBVUxUKSB7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvLmRlZmF1bHQgPSBjb2wuQ09MVU1OX0RFRkFVTFQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb2wuQ09MVU1OX0NPTU1FTlQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uY29tbWVudCA9IGNvbC5DT0xVTU5fQ09NTUVOVDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZmllbGRzW2ZpZWxkTmFtZV0gPSBmaWVsZEluZm87XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB7IGZlYXR1cmVzLCBmaWVsZHMsIHR5cGVzIH07XG4gICAgfVxuXG4gICAgX2ZpZWxkTmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLmZpZWxkTmFtaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXZlcnNlUnVsZXMuZmllbGROYW1pbihuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5maWVsZE5hbWluZyhuYW1lKTtcbiAgICB9XG5cbiAgICBfZW50aXR5TmFtaW5nKG5hbWUpIHtcbiAgICAgICAgaWYgKHRoaXMucmV2ZXJzZVJ1bGVzLmVudGl0eU5hbWluZykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZVJ1bGVzLmVudGl0eU5hbWluZyhuYW1lKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBPb2xVdGlscy5lbnRpdHlOYW1pbmcobmFtZSk7XG4gICAgfVxuXG4gICAgX3NjaGVtYU5hbWluZyhuYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLnJldmVyc2VSdWxlcy5zY2hlbWFOYW1pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJldmVyc2VSdWxlcy5zY2hlbWFOYW1pbmcobmFtZSk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gT29sVXRpbHMuc2NoZW1hTmFtaW5nKG5hbWUpO1xuICAgIH1cblxuICAgIF9teXNxbFR5cGVUb09vbFR5cGUodGFibGUsIGNvbCwgZmllbGROYW1lLCB0eXBlcykge1xuICAgICAgICBsZXQgYXBwbGljYWJsZVJ1bGUgPSBfLmZpbmQodGhpcy5yZXZlcnNlUnVsZXMuY29sdW1uVHlwZUNvbnZlcnNpb24sIHJ1bGUgPT4gcnVsZS50ZXN0KHRhYmxlLCBjb2wpKTtcbiAgICAgICAgaWYgKGFwcGxpY2FibGVSdWxlKSB7XG4gICAgICAgICAgICByZXR1cm4gYXBwbGljYWJsZVJ1bGUuYXBwbHkodGFibGUsIGNvbCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCB0eXBlSW5mbyA9IHt9OyAgICAgICAgXG4gICAgICAgIGlmIChjb2wuQ09MVU1OX05BTUUgIT09IGZpZWxkTmFtZSkge1xuICAgICAgICAgICAgdHlwZUluZm8uY29kZSA9IGNvbC5DT0xVTU5fTkFNRTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN3aXRjaCAoY29sLkRBVEFfVFlQRSkge1xuICAgICAgICAgICAgY2FzZSAndmFyY2hhcic6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICBpZiAoY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSCkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5tYXhMZW5ndGggPSBjb2wuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RIO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnY2hhcic6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICBpZiAoY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSCkge1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5maXhlZExlbmd0aCA9IGNvbC5DSEFSQUNURVJfTUFYSU1VTV9MRU5HVEg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlICdiaWdpbnQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnaW50JztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMTg7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSA4O1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2ludCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnQnO1xuICAgICAgICAgICAgICAgIHR5cGVJbmZvLmRpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTiB8fCAxMDtcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5ieXRlcyA9IDQ7XG4gICAgICAgICAgICAgICAgaWYgKF8uZW5kc1dpdGgoY29sLkNPTFVNTl9UWVBFLCAnIHVuc2lnbmVkJykpIHR5cGVJbmZvLnVuc2lnbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnbWVkaXVtaW50JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2ludCc7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDc7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAzO1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3NtYWxsaW50JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2ludCc7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uZGlnaXRzID0gY29sLk5VTUVSSUNfUFJFQ0lTSU9OIHx8IDQ7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAyO1xuICAgICAgICAgICAgICAgIGlmIChfLmVuZHNXaXRoKGNvbC5DT0xVTU5fVFlQRSwgJyB1bnNpZ25lZCcpKSB0eXBlSW5mby51bnNpZ25lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3RpbnlpbnQnOlxuICAgICAgICAgICAgICAgIGlmIChfLnN0YXJ0c1dpdGgoY29sLkNPTFVNTl9UWVBFLCAndGlueWludCgxKScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAnYm9vbCc7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdpbnQnO1xuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mby5kaWdpdHMgPSBjb2wuTlVNRVJJQ19QUkVDSVNJT04gfHwgMjtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm8uYnl0ZXMgPSAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5lbmRzV2l0aChjb2wuQ09MVU1OX1RZUEUsICcgdW5zaWduZWQnKSkgdHlwZUluZm8udW5zaWduZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnZW51bSc6XG4gICAgICAgICAgICAgICAgbGV0IGxlZnQgPSBjb2wuQ09MVU1OX1RZUEUuaW5kZXhPZignKCcpO1xuICAgICAgICAgICAgICAgIGxldCByaWdodCA9IGNvbC5DT0xVTU5fVFlQRS5sYXN0SW5kZXhPZignKScpO1xuXG4gICAgICAgICAgICAgICAgbGV0IHR5cGVOYW1lID0gdGFibGUuVEFCTEVfTkFNRSArIF8udXBwZXJGaXJzdChjb2wuQ09MVU1OX05BTUUpO1xuXG4gICAgICAgICAgICAgICAgdHlwZXNbdHlwZU5hbWVdID0ge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZW51bScsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlczogY29sLkNPTFVNTl9UWVBFLnN1YnN0cmluZyhsZWZ0ICsgMSwgcmlnaHQpLnNwbGl0KCcsJykubWFwKHYgPT4gdi5zdWJzdHIoMSwgdi5sZW5ndGggLSAyKSlcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9IHR5cGVOYW1lO1xuXG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxuICAgICAgICAgICAgICAgIHR5cGVJbmZvLnR5cGUgPSAndGV4dCc7XG4gICAgICAgICAgICAgICAgdHlwZUluZm8ubWF4TGVuZ3RoID0gY29sLkNIQVJBQ1RFUl9NQVhJTVVNX0xFTkdUSDtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnZGF0ZXRpbWUnOlxuICAgICAgICAgICAgY2FzZSAndGltZXN0YW1wJzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2RhdGV0aW1lJztcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAnZGVjaW1hbCc6XG4gICAgICAgICAgICAgICAgdHlwZUluZm8udHlwZSA9ICdkZWNpbWFsJztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50b3RhbERpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTjtcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kZWNpbWFsRGlnaXRzID0gY29sLk5VTUVSSUNfU0NBTEU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2Zsb2F0JzpcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50eXBlID0gJ2Zsb2F0JztcbiAgICAgICAgICAgICAgICB0eXBlSW5mby50b3RhbERpZ2l0cyA9IGNvbC5OVU1FUklDX1BSRUNJU0lPTjtcbiAgICAgICAgICAgICAgICB0eXBlSW5mby5kZWNpbWFsRGlnaXRzID0gY29sLk5VTUVSSUNfU0NBTEU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coY29sKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RvIGJlIGltcGxlbWVudGVkLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9fLmZpbmQodGhpcy5yZXZlcnNlUnVsZXMuY29sdW1uVHlwZU9wdGltaXphdGlvbiwgcnVsZSA9PiBydWxlLnRlc3QodGFibGUsIGNvbCkpO1xuXG4gICAgICAgIHJldHVybiB0eXBlSW5mbztcbiAgICB9XG5cbiAgICBfcmVmaW5lRW50aXR5UmVsYXRpb25zaGlwcyhtYXBPZkVudGl0aWVzKSB7XG4gICAgICAgIGxldCBlbnRpdHlBc3NvYyA9IHt9O1xuXG4gICAgICAgIC8vMXN0IHJvdW5kXG4gICAgICAgIF8uZm9yT3duKG1hcE9mRW50aXRpZXMsICh7IGVudGl0eUluZm8gfSwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaXNFbXB0eShlbnRpdHlJbmZvLmFzc29jaWF0aW9ucykpIHJldHVybjsgICAgICAgICAgICBcblxuICAgICAgICAgICAgZW50aXR5SW5mby5hc3NvY2lhdGlvbnMuZm9yRWFjaCgoeyB0eXBlLCBmcm9tLCBlbnRpdHkgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCByZWZlZEVudGl0eSA9IG1hcE9mRW50aXRpZXNbZW50aXR5XTtcbiAgICAgICAgICAgICAgICBsZXQgYmFja1JlZiA9IF8uZmluZChyZWZlZEVudGl0eS5hc3NvY2lhdGlvbnMsIGFzc29jID0+IGFzc29jLmVudGl0eSA9PT0gbmFtZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2hhc01hbnknKSB7ICAgXG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFiYWNrUmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL29uZS1zaWRlIHJlbGF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIG5hbWUsIHsgdHlwZTogJ3JlZmVyc1RvJywgZnJvbSwgZW50aXR5IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy90b2RvOlxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlbnRpdHlJbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBCYWNrIHJlZmVyZW5jZTogJHtiYWNrUmVmLmVudGl0eX0gJHtiYWNrUmVmLnR5cGV9ICR7bmFtZX1gKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2JlbG9uZ3NUbycpIHtcblxuICAgICAgICAgICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQoZW50aXR5QXNzb2MsIG5hbWUsIHsgdHlwZSwgZnJvbSwgZW50aXR5IH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghYmFja1JlZikge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9vbmUtc2lkZSByZWxhdGlvbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KGVudGl0eUFzc29jLCBlbnRpdHksIHsgdHlwZTogJ2hhc01hbnknLCBlbnRpdHk6IG5hbWUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIGFzc29jaWF0aW9uIHR5cGU6ICcgKyB0eXBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTsgICAgICAgICAgICBcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAvLzJuZCByb3VuZFxuICAgICAgICBfLmZvck93bihlbnRpdHlBc3NvYywgKGFzc29jaWF0aW9ucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHsgZW50aXR5SW5mbyB9ID0gbWFwT2ZFbnRpdGllc1tuYW1lXTtcblxuICAgICAgICAgICAgbGV0IGtleUFzc29jcztcblxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZW50aXR5SW5mby5rZXkpICYmIGVudGl0eUluZm8ua2V5Lmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGtleUFzc29jcyA9IF8uZmlsdGVyKGFzc29jaWF0aW9ucywgYXNzb2MgPT4gZW50aXR5SW5mby5rZXkuaW5kZXhPZihhc3NvYy5mcm9tKSAhPT0gLTEpO1xuICAgICAgICAgICAgICAgIGlmIChrZXlBc3NvY3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX21ha2VFbnRpdHlNYW55VG9NYW55KGtleUFzc29jc1swXS5lbnRpdHksIGtleUFzc29jc1sxXS5lbnRpdHksIGVudGl0eUFzc29jKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVudGl0eUluZm8uaW5kZXhlcy5mb3JFYWNoKCh7IGZpZWxkcyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAga2V5QXNzb2NzID0gXy5maWx0ZXIoYXNzb2NpYXRpb25zLCBhc3NvYyA9PiBmaWVsZHMuaW5kZXhPZihhc3NvYy5mcm9tKSAhPT0gLTEpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoa2V5QXNzb2NzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFrZUVudGl0eU1hbnlUb01hbnkoa2V5QXNzb2NzWzBdLmVudGl0eSwga2V5QXNzb2NzWzFdLmVudGl0eSwgZW50aXR5QXNzb2MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIF8uZm9yT3duKG1hcE9mRW50aXRpZXMsICh7IGVudGl0eUluZm8gfSwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgZW50aXR5SW5mby5hc3NvY2lhdGlvbnMgPSBlbnRpdHlBc3NvY1tuYW1lXTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX21ha2VFbnRpdHlNYW55VG9NYW55KGVudGl0eU5hbWUxLCBlbnRpdHlOYW1lMiwgZW50aXR5QXNzb2MpIHtcbiAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KGVudGl0eUFzc29jLCBlbnRpdHlOYW1lMSwgeyB0eXBlOiAnaGFzTWFueScsIGVudGl0eTogZW50aXR5TmFtZTIgfSk7XG4gICAgICAgIFV0aWwucHV0SW50b0J1Y2tldChlbnRpdHlBc3NvYywgZW50aXR5TmFtZTIsIHsgdHlwZTogJ2hhc01hbnknLCBlbnRpdHk6IGVudGl0eU5hbWUxIH0pO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTFJldmVyc2VFbmdpbmVlcmluZzsiXX0=