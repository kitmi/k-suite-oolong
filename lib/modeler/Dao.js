"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  pascalCase,
  replaceAll,
  putIntoBucket
} = require('rk-utils');

const swig = require('swig-templates');

const OolTypes = require('../lang/OolTypes');

const OolUtil = require('../lang/OolUtils');

const JsLang = require('./util/ast.js');

const OolToAst = require('./util/oolToAst.js');

const Snippets = require('./dao/snippets');

const ChainableType = [OolToAst.AST_BLK_VALIDATOR_CALL, OolToAst.AST_BLK_PROCESSOR_CALL, OolToAst.AST_BLK_ACTIVATOR_CALL];

const getFieldName = t => t.split('.').pop();

const isChainable = (current, next) => ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;

const chainCall = (lastBlock, lastType, currentBlock, currentType) => {
  if (lastBlock) {
    if (lastType === 'ValidatorCall') {
      if (!(currentType === 'ValidatorCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock = JsLang.astBinExp(lastBlock, '&&', currentBlock);
    } else {
      if (!(currentType === 'ModifierCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock.arguments[0] = lastBlock;
    }
  }

  return currentBlock;
};

const asyncMethodNaming = name => name + '_';

const indentLines = (lines, indentation) => lines.split('\n').map((line, i) => i === 0 ? line : _.repeat(' ', indentation) + line).join('\n');

const OOL_MODIFIER_RETURN = {
  [OolTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],
  [OolTypes.Modifier.PROCESSOR]: args => [JsLang.astReturn(JsLang.astId(args[0]))],
  [OolTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId("undefined"))]
};

class DaoModeler {
  constructor(context, connector) {
    this.logger = context.logger;
    this.outputPath = context.modelOutputPath;
    this.connector = connector;
  }

  modeling_(schema) {
    this.logger.log('info', 'Generating entity models for schema "' + schema.name + '"...');

    this._generateSchemaModel(schema);

    this._generateEntityModel(schema);
  }

  _generateSchemaModel(schema) {
    let capitalized = pascalCase(schema.name);
    let locals = {
      driver: this.connector.driver,
      className: capitalized,
      schemaName: schema.name
    };
    let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'Database.js.swig');
    let classCode = swig.renderFile(classTemplate, locals);
    let modelFilePath = path.resolve(this.outputPath, capitalized + '.js');
    fs.ensureFileSync(modelFilePath);
    fs.writeFileSync(modelFilePath, classCode);
    this.logger.log('info', 'Generated database model: ' + modelFilePath);
  }

  _generateEntityModel(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let capitalized = pascalCase(entityInstanceName);
      let sharedContext = {
        mapOfFunctorToFile: {},
        newFunctorFiles: []
      };

      let {
        ast: astClassMain,
        fieldReferences
      } = this._processFieldModifiers(entity, sharedContext);

      astClassMain = [astClassMain];
      let uniqueKeys = [_.castArray(entity.key)];

      if (entity.indexes) {
        entity.indexes.forEach(index => {
          if (index.unique) {
            uniqueKeys.push(index.fields);
          }
        });
      }

      let modelMeta = {
        schemaName: schema.name,
        name: entityInstanceName,
        keyField: entity.key,
        fields: _.mapValues(entity.fields, f => f.toJSON()),
        features: entity.features || {},
        uniqueKeys
      };

      if (!_.isEmpty(entity.indexes)) {
        modelMeta.indexes = entity.indexes;
      }

      if (!_.isEmpty(entity.features)) {
        modelMeta.features = entity.features;
      }

      if (!_.isEmpty(entity.associations)) {
        modelMeta.associations = entity.associations;
      }

      if (!_.isEmpty(fieldReferences)) {
        modelMeta.fieldDependencies = fieldReferences;
      }

      if (entity.interfaces) {
        let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);

        astClassMain = astClassMain.concat(astInterfaces);
      }

      let importLines = [];

      if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {
        _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {
          importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, fileName)));
        });
      }

      if (!_.isEmpty(sharedContext.newFunctorFiles)) {
        _.each(sharedContext.newFunctorFiles, entry => {
          this._generateFunctionTemplateFile(schema, entry);
        });
      }

      let locals = {
        imports: importLines.join('\n'),
        className: capitalized,
        entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),
        classBody: indentLines(astClassMain.map(block => JsLang.astToCode(block)).join('\n\n'), 8),
        functors: indentLines(JsLang.astToCode(JsLang.astValue(_.reduce(sharedContext.newFunctorFiles, (result, functor) => {
          result['$' + functor.functionName] = JsLang.astId(functor.functionName);
          return result;
        }, {}))), 4)
      };
      let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'EntityModel.js.swig');
      let classCode = swig.renderFile(classTemplate, locals);
      let modelFilePath = path.resolve(this.outputPath, schema.name, capitalized + '.js');
      fs.ensureFileSync(modelFilePath);
      fs.writeFileSync(modelFilePath, classCode);
      this.logger.log('info', 'Generated entity model: ' + modelFilePath);
    });
  }

  _processFieldModifiers(entity, sharedContext) {
    let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
    compileContext.variables['raw'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['i18n'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['connector'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['latest'] = {
      source: 'context'
    };
    const allFinished = OolToAst.createTopoId(compileContext, 'done.');
    let fieldReferences = {};

    _.forOwn(entity.fields, (field, fieldName) => {
      let topoId = OolToAst.compileField(fieldName, field, compileContext);
      OolToAst.dependsOn(compileContext, topoId, allFinished);

      if (field.writeOnce || field.freezeAfterNonDefault) {
        putIntoBucket(fieldReferences, fieldName, fieldName);
      }
    });

    let deps = compileContext.topoSort.sort();
    this.logger.verbose('All dependencies:\n' + JSON.stringify(deps, null, 2));
    deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));
    this.logger.verbose('All necessary source code:\n' + JSON.stringify(deps, null, 2));
    let methodBodyValidateAndFill = [],
        lastFieldsGroup,
        methodBodyCache = [],
        lastBlock,
        lastAstType;

    const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {
      let fields = (requireTargetField ? [fieldName] : []).concat(references);
      let checker = fields.join(',');

      if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {
        methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
        methodBodyCache = [];
      }

      methodBodyCache = methodBodyCache.concat(astCache);
      lastFieldsGroup = {
        fieldName,
        references,
        requireTargetField,
        checker
      };
    };

    _.each(deps, (dep, i) => {
      let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
      let astBlock = compileContext.astMap[dep];
      let targetFieldName = getFieldName(sourceMap.target);

      if (sourceMap.references) {
        let fieldReference = fieldReferences[targetFieldName];

        if (!fieldReference) {
          fieldReferences[targetFieldName] = fieldReference = [];
        }

        sourceMap.references.forEach(ref => {
          if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);
        });
      }

      if (lastBlock) {
        astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);
        lastBlock = undefined;
      }

      if (i < deps.length - 1) {
        let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);

        if (isChainable(sourceMap, nextType)) {
          lastBlock = astBlock;
          lastAstType = sourceMap.type;
          return;
        }
      }

      if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
        let astCache = Snippets._validateCheck(targetFieldName, astBlock);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);
      } else {
        throw new Error('To be implemented.');
      }
    });

    if (!_.isEmpty(methodBodyCache)) {
      methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
    }

    return {
      ast: JsLang.astMemberMethod(asyncMethodNaming('applyModifiers'), ['context', 'isUpdating'], Snippets._applyModifiersHeader.concat(methodBodyValidateAndFill).concat([JsLang.astReturn(JsLang.astId('context'))]), false, true, true, 'Applying predefined modifiers to entity fields.'),
      fieldReferences
    };
  }

  _generateFunctionTemplateFile(schema, {
    functionName,
    functorType,
    fileName,
    args
  }) {
    let filePath = path.resolve(this.outputPath, schema.name, fileName);

    if (fs.existsSync(filePath)) {
      this.logger.log('info', `${_.upperFirst(functorType)} "${fileName}" exists. File generating skipped.`);
      return;
    }

    let ast = JsLang.astProgram();
    JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));
    JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(functionName)));
    fs.ensureFileSync(filePath);
    fs.writeFileSync(filePath, JsLang.astToCode(ast));
    this.logger.log('info', `Generated ${functorType} file: ${filePath}`);
  }

  _buildInterfaces(entity, modelMetaInit, sharedContext) {
    let ast = [];

    _.forOwn(entity.interfaces, (method, name) => {
      this.logger.info('Building interface: ' + name);
      let astBody = [JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta.interfaces.' + name), true, false, 'Retrieving the meta data')];
      let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
      let paramMeta;

      if (method.accept) {
        paramMeta = this._processParams(method.accept, compileContext);
      }

      modelMetaInit['interfaces'] || (modelMetaInit['interfaces'] = {});
      modelMetaInit['interfaces'][name] = {
        params: Object.values(paramMeta)
      };

      _.each(method.implementation, (operation, index) => {
        OolToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);
      });

      if (method.return) {
        OolToAst.compileExceptionalReturn(method.return, compileContext);
      }

      let deps = compileContext.topoSort.sort();
      deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));

      _.each(deps, dep => {
        let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
        let astBlock = compileContext.astMap[dep];
        let targetFieldName = sourceMap.target;

        if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
          astBlock = Snippets._validateCheck(targetFieldName, astBlock);
        } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);
          }
        } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);
          }
        }

        astBody = astBody.concat(_.castArray(astBlock));
      });

      ast.push(JsLang.astMemberMethod(asyncMethodNaming(name), Object.keys(paramMeta), astBody, false, true, true, replaceAll(_.kebabCase(name), '-', ' ')));
    });

    return ast;
  }

  _processParams(acceptParams, compileContext) {
    let paramMeta = {};
    acceptParams.forEach((param, i) => {
      OolToAst.compileParam(i, param, compileContext);
      paramMeta[param.name] = param;
      compileContext.variables[param.name] = {
        source: 'argument'
      };
    });
    return paramMeta;
  }

}

module.exports = DaoModeler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbGVyL0Rhby5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsInBhc2NhbENhc2UiLCJyZXBsYWNlQWxsIiwicHV0SW50b0J1Y2tldCIsInN3aWciLCJPb2xUeXBlcyIsIk9vbFV0aWwiLCJKc0xhbmciLCJPb2xUb0FzdCIsIlNuaXBwZXRzIiwiQ2hhaW5hYmxlVHlwZSIsIkFTVF9CTEtfVkFMSURBVE9SX0NBTEwiLCJBU1RfQkxLX1BST0NFU1NPUl9DQUxMIiwiQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCIsImdldEZpZWxkTmFtZSIsInQiLCJzcGxpdCIsInBvcCIsImlzQ2hhaW5hYmxlIiwiY3VycmVudCIsIm5leHQiLCJpbmRleE9mIiwidHlwZSIsInRhcmdldCIsImNoYWluQ2FsbCIsImxhc3RCbG9jayIsImxhc3RUeXBlIiwiY3VycmVudEJsb2NrIiwiY3VycmVudFR5cGUiLCJhc3RCaW5FeHAiLCJhcmd1bWVudHMiLCJhc3luY01ldGhvZE5hbWluZyIsIm5hbWUiLCJpbmRlbnRMaW5lcyIsImxpbmVzIiwiaW5kZW50YXRpb24iLCJtYXAiLCJsaW5lIiwiaSIsInJlcGVhdCIsImpvaW4iLCJPT0xfTU9ESUZJRVJfUkVUVVJOIiwiTW9kaWZpZXIiLCJWQUxJREFUT1IiLCJhc3RSZXR1cm4iLCJQUk9DRVNTT1IiLCJhcmdzIiwiYXN0SWQiLCJBQ1RJVkFUT1IiLCJEYW9Nb2RlbGVyIiwiY29uc3RydWN0b3IiLCJjb250ZXh0IiwiY29ubmVjdG9yIiwibG9nZ2VyIiwib3V0cHV0UGF0aCIsIm1vZGVsT3V0cHV0UGF0aCIsIm1vZGVsaW5nXyIsInNjaGVtYSIsImxvZyIsIl9nZW5lcmF0ZVNjaGVtYU1vZGVsIiwiX2dlbmVyYXRlRW50aXR5TW9kZWwiLCJjYXBpdGFsaXplZCIsImxvY2FscyIsImRyaXZlciIsImNsYXNzTmFtZSIsInNjaGVtYU5hbWUiLCJjbGFzc1RlbXBsYXRlIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImNsYXNzQ29kZSIsInJlbmRlckZpbGUiLCJtb2RlbEZpbGVQYXRoIiwiZW5zdXJlRmlsZVN5bmMiLCJ3cml0ZUZpbGVTeW5jIiwiZm9yT3duIiwiZW50aXRpZXMiLCJlbnRpdHkiLCJlbnRpdHlJbnN0YW5jZU5hbWUiLCJzaGFyZWRDb250ZXh0IiwibWFwT2ZGdW5jdG9yVG9GaWxlIiwibmV3RnVuY3RvckZpbGVzIiwiYXN0IiwiYXN0Q2xhc3NNYWluIiwiZmllbGRSZWZlcmVuY2VzIiwiX3Byb2Nlc3NGaWVsZE1vZGlmaWVycyIsInVuaXF1ZUtleXMiLCJjYXN0QXJyYXkiLCJrZXkiLCJpbmRleGVzIiwiZm9yRWFjaCIsImluZGV4IiwidW5pcXVlIiwicHVzaCIsImZpZWxkcyIsIm1vZGVsTWV0YSIsImtleUZpZWxkIiwibWFwVmFsdWVzIiwiZiIsInRvSlNPTiIsImZlYXR1cmVzIiwiaXNFbXB0eSIsImFzc29jaWF0aW9ucyIsImZpZWxkRGVwZW5kZW5jaWVzIiwiaW50ZXJmYWNlcyIsImFzdEludGVyZmFjZXMiLCJfYnVpbGRJbnRlcmZhY2VzIiwiY29uY2F0IiwiaW1wb3J0TGluZXMiLCJmaWxlTmFtZSIsImZ1bmN0aW9uTmFtZSIsImFzdFRvQ29kZSIsImFzdFJlcXVpcmUiLCJlYWNoIiwiZW50cnkiLCJfZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZSIsImltcG9ydHMiLCJlbnRpdHlNZXRhIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsYXNzQm9keSIsImJsb2NrIiwiZnVuY3RvcnMiLCJhc3RWYWx1ZSIsInJlZHVjZSIsInJlc3VsdCIsImZ1bmN0b3IiLCJjb21waWxlQ29udGV4dCIsImNyZWF0ZUNvbXBpbGVDb250ZXh0Iiwib29sTW9kdWxlIiwidmFyaWFibGVzIiwic291cmNlIiwiZmluYWxpemVkIiwiYWxsRmluaXNoZWQiLCJjcmVhdGVUb3BvSWQiLCJmaWVsZCIsImZpZWxkTmFtZSIsInRvcG9JZCIsImNvbXBpbGVGaWVsZCIsImRlcGVuZHNPbiIsIndyaXRlT25jZSIsImZyZWV6ZUFmdGVyTm9uRGVmYXVsdCIsImRlcHMiLCJ0b3BvU29ydCIsInNvcnQiLCJ2ZXJib3NlIiwiZmlsdGVyIiwiZGVwIiwibWFwT2ZUb2tlblRvTWV0YSIsImhhcyIsIm1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwiLCJsYXN0RmllbGRzR3JvdXAiLCJtZXRob2RCb2R5Q2FjaGUiLCJsYXN0QXN0VHlwZSIsIl9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSIsInJlZmVyZW5jZXMiLCJhc3RDYWNoZSIsInJlcXVpcmVUYXJnZXRGaWVsZCIsImNoZWNrZXIiLCJfZmllbGRSZXF1aXJlbWVudENoZWNrIiwic291cmNlTWFwIiwiZ2V0IiwiYXN0QmxvY2siLCJhc3RNYXAiLCJ0YXJnZXRGaWVsZE5hbWUiLCJmaWVsZFJlZmVyZW5jZSIsInJlZiIsInVuZGVmaW5lZCIsImxlbmd0aCIsIm5leHRUeXBlIiwiX3ZhbGlkYXRlQ2hlY2siLCJhc3RBc3NpZ24iLCJhc3RWYXJSZWYiLCJFcnJvciIsImFzdE1lbWJlck1ldGhvZCIsIl9hcHBseU1vZGlmaWVyc0hlYWRlciIsImZ1bmN0b3JUeXBlIiwiZmlsZVBhdGgiLCJleGlzdHNTeW5jIiwidXBwZXJGaXJzdCIsImFzdFByb2dyYW0iLCJhc3RQdXNoSW5Cb2R5IiwiYXN0RnVuY3Rpb24iLCJtb2RlbE1ldGFJbml0IiwibWV0aG9kIiwiaW5mbyIsImFzdEJvZHkiLCJhc3RWYXJEZWNsYXJlIiwicGFyYW1NZXRhIiwiYWNjZXB0IiwiX3Byb2Nlc3NQYXJhbXMiLCJwYXJhbXMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJpbXBsZW1lbnRhdGlvbiIsIm9wZXJhdGlvbiIsImNvbXBpbGVEYk9wZXJhdGlvbiIsIm1haW5TdGFydElkIiwicmV0dXJuIiwiY29tcGlsZUV4Y2VwdGlvbmFsUmV0dXJuIiwibmVlZERlY2xhcmUiLCJrZXlzIiwia2ViYWJDYXNlIiwiYWNjZXB0UGFyYW1zIiwicGFyYW0iLCJjb21waWxlUGFyYW0iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1h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QUEsU0FBUyxDQUFDZ0IsS0FBSyxDQUFDM0ssSUFBUCxDQUFULEdBQXdCMkssS0FBeEI7QUFDQTdFLE1BQUFBLGNBQWMsQ0FBQ0csU0FBZixDQUF5QjBFLEtBQUssQ0FBQzNLLElBQS9CLElBQXVDO0FBQUVrRyxRQUFBQSxNQUFNLEVBQUU7QUFBVixPQUF2QztBQUNILEtBSkQ7QUFNQSxXQUFPeUQsU0FBUDtBQUNIOztBQXJlWTs7QUF3ZWpCa0IsTUFBTSxDQUFDQyxPQUFQLEdBQWlCN0osVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIHBhc2NhbENhc2UsIHJlcGxhY2VBbGwsIHB1dEludG9CdWNrZXQgfSAgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3Qgc3dpZyAgPSByZXF1aXJlKCdzd2lnLXRlbXBsYXRlcycpO1xuXG5jb25zdCBPb2xUeXBlcyA9IHJlcXVpcmUoJy4uL2xhbmcvT29sVHlwZXMnKTtcbmNvbnN0IE9vbFV0aWwgPSByZXF1aXJlKCcuLi9sYW5nL09vbFV0aWxzJyk7XG5jb25zdCBKc0xhbmcgPSByZXF1aXJlKCcuL3V0aWwvYXN0LmpzJyk7XG5jb25zdCBPb2xUb0FzdCA9IHJlcXVpcmUoJy4vdXRpbC9vb2xUb0FzdC5qcycpO1xuY29uc3QgU25pcHBldHMgPSByZXF1aXJlKCcuL2Rhby9zbmlwcGV0cycpO1xuXG5jb25zdCBDaGFpbmFibGVUeXBlID0gW1xuICAgIE9vbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwsIFxuICAgIE9vbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwsXG4gICAgT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTFxuXTtcblxuY29uc3QgZ2V0RmllbGROYW1lID0gdCA9PiB0LnNwbGl0KCcuJykucG9wKCk7XG5jb25zdCBpc0NoYWluYWJsZSA9IChjdXJyZW50LCBuZXh0KSA9PiBDaGFpbmFibGVUeXBlLmluZGV4T2YoY3VycmVudC50eXBlKSA+IC0xXG4gICAgJiYgY3VycmVudC50YXJnZXQgPT09IG5leHQudGFyZ2V0XG4gICAgJiYgbmV4dC50eXBlID09PSBjdXJyZW50LnR5cGU7XG5jb25zdCBjaGFpbkNhbGwgPSAobGFzdEJsb2NrLCBsYXN0VHlwZSwgY3VycmVudEJsb2NrLCBjdXJyZW50VHlwZSkgPT4ge1xuICAgIGlmIChsYXN0QmxvY2spIHtcbiAgICAgICAgaWYgKGxhc3RUeXBlID09PSAnVmFsaWRhdG9yQ2FsbCcpIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdWYWxpZGF0b3JDYWxsJywgJ1VuZXhwZWN0ZWQgY3VycmVudFR5cGUnO1xuXG4gICAgICAgICAgICBjdXJyZW50QmxvY2sgPSBKc0xhbmcuYXN0QmluRXhwKGxhc3RCbG9jaywgJyYmJywgY3VycmVudEJsb2NrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdNb2RpZmllckNhbGwnLCAnVW5leHBlY3RlZCBjdXJyZW50VHlwZSc7XG5cbiAgICAgICAgICAgIGN1cnJlbnRCbG9jay5hcmd1bWVudHNbMF0gPSBsYXN0QmxvY2s7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY3VycmVudEJsb2NrO1xufTtcbmNvbnN0IGFzeW5jTWV0aG9kTmFtaW5nID0gKG5hbWUpID0+IG5hbWUgKyAnXyc7XG5cbmNvbnN0IGluZGVudExpbmVzID0gKGxpbmVzLCBpbmRlbnRhdGlvbikgPT4gbGluZXMuc3BsaXQoJ1xcbicpLm1hcCgobGluZSwgaSkgPT4gaSA9PT0gMCA/IGxpbmUgOiAoXy5yZXBlYXQoJyAnLCBpbmRlbnRhdGlvbikgKyBsaW5lKSkuam9pbignXFxuJyk7XG5cbmNvbnN0IE9PTF9NT0RJRklFUl9SRVRVUk4gPSB7XG4gICAgW09vbFR5cGVzLk1vZGlmaWVyLlZBTElEQVRPUl06ICgpID0+IFsgSnNMYW5nLmFzdFJldHVybih0cnVlKSBdLFxuICAgIFtPb2xUeXBlcy5Nb2RpZmllci5QUk9DRVNTT1JdOiBhcmdzID0+IFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoYXJnc1swXSkpIF0sXG4gICAgW09vbFR5cGVzLk1vZGlmaWVyLkFDVElWQVRPUl06ICgpID0+IFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoXCJ1bmRlZmluZWRcIikpIF1cbn07XG5cbi8qKlxuICogT29sb25nIGRhdGFiYXNlIGFjY2VzcyBvYmplY3QgKERBTykgbW9kZWxlci5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBEYW9Nb2RlbGVyIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdCAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5tb2RlbE91dHB1dFBhdGggLSBHZW5lcmF0ZWQgbW9kZWwgb3V0cHV0IHBhdGhcbiAgICAgKiBAcGFyYW0ge0Nvbm5lY3Rvcn0gY29ubmVjdG9yICAgICAgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29udGV4dCwgY29ubmVjdG9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyID0gY29udGV4dC5sb2dnZXI7ICAgICAgIFxuICAgICAgICB0aGlzLm91dHB1dFBhdGggPSBjb250ZXh0Lm1vZGVsT3V0cHV0UGF0aDtcblxuICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjsgICAgICAgIFxuICAgIH1cblxuICAgIG1vZGVsaW5nXyhzY2hlbWEpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRpbmcgZW50aXR5IG1vZGVscyBmb3Igc2NoZW1hIFwiJyArIHNjaGVtYS5uYW1lICsgJ1wiLi4uJyk7XG5cbiAgICAgICAgdGhpcy5fZ2VuZXJhdGVTY2hlbWFNb2RlbChzY2hlbWEpO1xuICAgICAgICB0aGlzLl9nZW5lcmF0ZUVudGl0eU1vZGVsKHNjaGVtYSk7XG4gICAgICAgIC8vdGhpcy5fZ2VuZXJhdGVWaWV3TW9kZWwoKTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVTY2hlbWFNb2RlbChzY2hlbWEpIHtcbiAgICAgICAgbGV0IGNhcGl0YWxpemVkID0gcGFzY2FsQ2FzZShzY2hlbWEubmFtZSk7XG5cbiAgICAgICAgbGV0IGxvY2FscyA9IHtcbiAgICAgICAgICAgIGRyaXZlcjogdGhpcy5jb25uZWN0b3IuZHJpdmVyLFxuICAgICAgICAgICAgY2xhc3NOYW1lOiBjYXBpdGFsaXplZCxcbiAgICAgICAgICAgIHNjaGVtYU5hbWU6IHNjaGVtYS5uYW1lXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGNsYXNzVGVtcGxhdGUgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnZGF0YWJhc2UnLCB0aGlzLmNvbm5lY3Rvci5kcml2ZXIsICdEYXRhYmFzZS5qcy5zd2lnJyk7XG4gICAgICAgIGxldCBjbGFzc0NvZGUgPSBzd2lnLnJlbmRlckZpbGUoY2xhc3NUZW1wbGF0ZSwgbG9jYWxzKTtcblxuICAgICAgICBsZXQgbW9kZWxGaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLm91dHB1dFBhdGgsIGNhcGl0YWxpemVkICsgJy5qcycpO1xuICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtb2RlbEZpbGVQYXRoLCBjbGFzc0NvZGUpO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgZGF0YWJhc2UgbW9kZWw6ICcgKyBtb2RlbEZpbGVQYXRoKTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVFbnRpdHlNb2RlbChzY2hlbWEpIHtcbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLmVudGl0aWVzLCAoZW50aXR5LCBlbnRpdHlJbnN0YW5jZU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXBpdGFsaXplZCA9IHBhc2NhbENhc2UoZW50aXR5SW5zdGFuY2VOYW1lKTsgICAgICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgLy9zaGFyZWQgaW5mb3JtYXRpb24gd2l0aCBtb2RlbCBDUlVEIGFuZCBjdXN0b21pemVkIGludGVyZmFjZXNcbiAgICAgICAgICAgIGxldCBzaGFyZWRDb250ZXh0ID0ge1xuICAgICAgICAgICAgICAgIG1hcE9mRnVuY3RvclRvRmlsZToge30sXG4gICAgICAgICAgICAgICAgbmV3RnVuY3RvckZpbGVzOiBbXVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHsgYXN0OiBhc3RDbGFzc01haW4sIGZpZWxkUmVmZXJlbmNlcyB9ID0gdGhpcy5fcHJvY2Vzc0ZpZWxkTW9kaWZpZXJzKGVudGl0eSwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgICAgICBhc3RDbGFzc01haW4gPSBbIGFzdENsYXNzTWFpbiBdO1xuXG4gICAgICAgICAgICAvL3ByZXBhcmUgbWV0YSBkYXRhXG4gICAgICAgICAgICBsZXQgdW5pcXVlS2V5cyA9IFsgXy5jYXN0QXJyYXkoZW50aXR5LmtleSkgXTtcblxuICAgICAgICAgICAgaWYgKGVudGl0eS5pbmRleGVzKSB7XG4gICAgICAgICAgICAgICAgZW50aXR5LmluZGV4ZXMuZm9yRWFjaChpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleC51bmlxdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZUtleXMucHVzaChpbmRleC5maWVsZHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBtb2RlbE1ldGEgPSB7XG4gICAgICAgICAgICAgICAgc2NoZW1hTmFtZTogc2NoZW1hLm5hbWUsXG4gICAgICAgICAgICAgICAgbmFtZTogZW50aXR5SW5zdGFuY2VOYW1lLFxuICAgICAgICAgICAgICAgIGtleUZpZWxkOiBlbnRpdHkua2V5LFxuICAgICAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXMoZW50aXR5LmZpZWxkcywgZiA9PiBmLnRvSlNPTigpKSxcbiAgICAgICAgICAgICAgICBmZWF0dXJlczogZW50aXR5LmZlYXR1cmVzIHx8IHt9LFxuICAgICAgICAgICAgICAgIHVuaXF1ZUtleXNcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5pbmRleGVzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5pbmRleGVzID0gZW50aXR5LmluZGV4ZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuZmVhdHVyZXMgPSBlbnRpdHkuZmVhdHVyZXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmFzc29jaWF0aW9ucyA9IGVudGl0eS5hc3NvY2lhdGlvbnM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGZpZWxkUmVmZXJlbmNlcykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuZmllbGREZXBlbmRlbmNpZXMgPSBmaWVsZFJlZmVyZW5jZXM7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vYnVpbGQgY3VzdG9taXplZCBpbnRlcmZhY2VzICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZW50aXR5LmludGVyZmFjZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0SW50ZXJmYWNlcyA9IHRoaXMuX2J1aWxkSW50ZXJmYWNlcyhlbnRpdHksIG1vZGVsTWV0YSwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgICAgICAvL2xldCBhc3RDbGFzcyA9IGFzdENsYXNzTWFpblthc3RDbGFzc01haW4ubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3RDbGFzcywgYXN0SW50ZXJmYWNlcyk7XG4gICAgICAgICAgICAgICAgYXN0Q2xhc3NNYWluID0gYXN0Q2xhc3NNYWluLmNvbmNhdChhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGltcG9ydExpbmVzID0gW107XG5cbiAgICAgICAgICAgIC8vZ2VuZXJhdGUgZnVuY3RvcnMgaWYgYW55XG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShzaGFyZWRDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSkpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihzaGFyZWRDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSwgKGZpbGVOYW1lLCBmdW5jdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0TGluZXMucHVzaChKc0xhbmcuYXN0VG9Db2RlKEpzTGFuZy5hc3RSZXF1aXJlKGZ1bmN0aW9uTmFtZSwgZmlsZU5hbWUpKSlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoc2hhcmVkQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMpKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNoYXJlZENvbnRleHQubmV3RnVuY3RvckZpbGVzLCBlbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUoc2NoZW1hLCBlbnRyeSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy9hc3NlbWJsZSB0aGUgc291cmNlIGNvZGUgZmlsZVxuICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIGFzdENsYXNzTWFpbik7XG5cbiAgICAgICAgICAgIC8vSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBlbnRpdHkuZmllbGRzLm1hcCgodiwgaykgPT4gSnNMYW5nLmFzdEFzc2lnbihjYXBpdGFsaXplZCArICcuRl8nICsgXy5zbmFrZUNhc2UoaykudG9VcHBlckNhc2UoKSwgaykpKTsgICBcblxuICAgICAgICAgICAgbGV0IGxvY2FscyA9IHtcbiAgICAgICAgICAgICAgICBpbXBvcnRzOiBpbXBvcnRMaW5lcy5qb2luKCdcXG4nKSxcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6IGNhcGl0YWxpemVkLFxuICAgICAgICAgICAgICAgIGVudGl0eU1ldGE6IGluZGVudExpbmVzKEpTT04uc3RyaW5naWZ5KG1vZGVsTWV0YSwgbnVsbCwgNCksIDQpLFxuICAgICAgICAgICAgICAgIGNsYXNzQm9keTogaW5kZW50TGluZXMoYXN0Q2xhc3NNYWluLm1hcChibG9jayA9PiBKc0xhbmcuYXN0VG9Db2RlKGJsb2NrKSkuam9pbignXFxuXFxuJyksIDgpLFxuICAgICAgICAgICAgICAgIGZ1bmN0b3JzOiBpbmRlbnRMaW5lcyhKc0xhbmcuYXN0VG9Db2RlKEpzTGFuZy5hc3RWYWx1ZShfLnJlZHVjZShzaGFyZWRDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcywgKHJlc3VsdCwgZnVuY3RvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbJyQnICsgZnVuY3Rvci5mdW5jdGlvbk5hbWVdID0gSnNMYW5nLmFzdElkKGZ1bmN0b3IuZnVuY3Rpb25OYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9LCB7fSkpKSwgNCkgXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgY2xhc3NUZW1wbGF0ZSA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdkYXRhYmFzZScsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgJ0VudGl0eU1vZGVsLmpzLnN3aWcnKTtcbiAgICAgICAgICAgIGxldCBjbGFzc0NvZGUgPSBzd2lnLnJlbmRlckZpbGUoY2xhc3NUZW1wbGF0ZSwgbG9jYWxzKTtcblxuICAgICAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBzY2hlbWEubmFtZSwgY2FwaXRhbGl6ZWQgKyAnLmpzJyk7XG4gICAgICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCwgY2xhc3NDb2RlKTtcblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCBlbnRpdHkgbW9kZWw6ICcgKyBtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIC8qXG4gICAgX2dlbmVyYXRlVmlld01vZGVsKHNjaGVtYSwgZGJTZXJ2aWNlKSB7ICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLnZpZXdzLCAodmlld0luZm8sIHZpZXdOYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdCdWlsZGluZyB2aWV3OiAnICsgdmlld05hbWUpO1xuXG4gICAgICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBfLnVwcGVyRmlyc3Qodmlld05hbWUpO1xuXG4gICAgICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oKTtcblxuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0UmVxdWlyZSgnTW93YScsICdtb3dhJykpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnVXRpbCcsIEpzTGFuZy5hc3RWYXJSZWYoJ01vd2EuVXRpbCcpLCB0cnVlKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCdfJywgSnNMYW5nLmFzdFZhclJlZignVXRpbC5fJyksIHRydWUpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoJ1ZpZXcnLCAnbW93YS9saWIvb29sb25nL3J1bnRpbWUvdmlldycpKTtcblxuICAgICAgICAgICAgbGV0IGNvbXBpbGVDb250ZXh0ID0gT29sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQodmlld05hbWUsIGRiU2VydmljZS5zZXJ2aWNlSWQsIHRoaXMubG9nZ2VyKTtcblxuICAgICAgICAgICAgY29tcGlsZUNvbnRleHQubW9kZWxWYXJzLmFkZCh2aWV3SW5mby5lbnRpdHkpO1xuXG4gICAgICAgICAgICBsZXQgcGFyYW1NZXRhO1xuXG4gICAgICAgICAgICBpZiAodmlld0luZm8ucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1NZXRhID0gdGhpcy5fcHJvY2Vzc1BhcmFtcyh2aWV3SW5mby5wYXJhbXMsIGNvbXBpbGVDb250ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHZpZXdNZXRhID0ge1xuICAgICAgICAgICAgICAgIGlzTGlzdDogdmlld0luZm8uaXNMaXN0LFxuICAgICAgICAgICAgICAgIHBhcmFtczogcGFyYW1NZXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgdmlld0JvZHlUb3BvSWQgPSBPb2xUb0FzdC5jcmVhdGVUb3BvSWQoY29tcGlsZUNvbnRleHQsICckdmlldycpO1xuICAgICAgICAgICAgT29sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCBjb21waWxlQ29udGV4dC5tYWluU3RhcnRJZCwgdmlld0JvZHlUb3BvSWQpO1xuXG4gICAgICAgICAgICBsZXQgdmlld01vZGVsZXIgPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2Rhby92aWV3JywgZGJTZXJ2aWNlLmRiVHlwZSArICcuanMnKSk7XG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC5hc3RNYXBbdmlld0JvZHlUb3BvSWRdID0gdmlld01vZGVsZXIoZGJTZXJ2aWNlLCB2aWV3TmFtZSwgdmlld0luZm8pO1xuICAgICAgICAgICAgT29sVG9Bc3QuYWRkQ29kZUJsb2NrKGNvbXBpbGVDb250ZXh0LCB2aWV3Qm9keVRvcG9JZCwge1xuICAgICAgICAgICAgICAgIHR5cGU6IE9vbFRvQXN0LkFTVF9CTEtfVklFV19PUEVSQVRJT05cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgcmV0dXJuVG9wb0lkID0gT29sVG9Bc3QuY3JlYXRlVG9wb0lkKGNvbXBpbGVDb250ZXh0LCAnJHJldHVybjp2YWx1ZScpO1xuICAgICAgICAgICAgT29sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCB2aWV3Qm9keVRvcG9JZCwgcmV0dXJuVG9wb0lkKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmNvbXBpbGVSZXR1cm4ocmV0dXJuVG9wb0lkLCB7XG4gICAgICAgICAgICAgICAgXCJvb2xUeXBlXCI6IFwiT2JqZWN0UmVmZXJlbmNlXCIsXG4gICAgICAgICAgICAgICAgXCJuYW1lXCI6IFwidmlld0RhdGFcIlxuICAgICAgICAgICAgfSwgY29tcGlsZUNvbnRleHQpO1xuXG4gICAgICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBuZWNlc3Nhcnkgc291cmNlIGNvZGU6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgbGV0IGFzdERvTG9hZE1haW4gPSBbXG4gICAgICAgICAgICAgICAgSnNMYW5nLmFzdFZhckRlY2xhcmUoJyRtZXRhJywgSnNMYW5nLmFzdFZhclJlZigndGhpcy5tZXRhJyksIHRydWUsIGZhbHNlLCAnUmV0cmlldmluZyB0aGUgbWV0YSBkYXRhJylcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIF8uZWFjaChkZXBzLCBkZXAgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBhc3RNZXRhID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwKTtcblxuICAgICAgICAgICAgICAgIGxldCBhc3RCbG9jayA9IGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdO1xuICAgICAgICAgICAgICAgIGFzc2VydDogYXN0QmxvY2ssICdFbXB0eSBhc3QgYmxvY2snO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzdE1ldGEudHlwZSA9PT0gJ01vZGlmaWVyQ2FsbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkTmFtZSA9IGdldEZpZWxkTmFtZShhc3RNZXRhLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihhc3RNZXRhLnRhcmdldCksIGFzdEJsb2NrLCBgTW9kaWZ5aW5nICR7ZmllbGROYW1lfWApO1xuICAgICAgICAgICAgICAgICAgICBhc3REb0xvYWRNYWluLnB1c2goYXN0Q2FjaGUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXN0RG9Mb2FkTWFpbiA9IGFzdERvTG9hZE1haW4uY29uY2F0KF8uY2FzdEFycmF5KGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29tcGlsZUNvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlKSkge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGNvbXBpbGVDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSwgKGZpbGVOYW1lLCBmdW5jdGlvbk5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0UmVxdWlyZShmdW5jdGlvbk5hbWUsICcuJyArIGZpbGVOYW1lKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbXBpbGVDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcykpIHtcbiAgICAgICAgICAgICAgICBfLmVhY2goY29tcGlsZUNvbnRleHQubmV3RnVuY3RvckZpbGVzLCBlbnRyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUoZGJTZXJ2aWNlLCBlbnRyeSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdENsYXNzRGVjbGFyZShjYXBpdGFsaXplZCwgJ1ZpZXcnLCBbXG4gICAgICAgICAgICAgICAgSnNMYW5nLmFzdE1lbWJlck1ldGhvZCgnX2RvTG9hZCcsIE9iamVjdC5rZXlzKHBhcmFtTWV0YSksXG4gICAgICAgICAgICAgICAgICAgIGFzdERvTG9hZE1haW4sXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlLCB0cnVlLCBmYWxzZSwgJ1BvcHVsYXRlIHZpZXcgZGF0YSdcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICBdLCBgJHtjYXBpdGFsaXplZH0gdmlld2ApKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEFzc2lnbihjYXBpdGFsaXplZCArICcubWV0YScsIEpzTGFuZy5hc3RWYWx1ZSh2aWV3TWV0YSkpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEFzc2lnbignbW9kdWxlLmV4cG9ydHMnLCBKc0xhbmcuYXN0VmFyUmVmKGNhcGl0YWxpemVkKSkpO1xuXG4gICAgICAgICAgICBsZXQgbW9kZWxGaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLm91dHB1dFBhdGgsIGRiU2VydmljZS5kYlR5cGUsIGRiU2VydmljZS5uYW1lLCAndmlld3MnLCB2aWV3TmFtZSArICcuanMnKTtcbiAgICAgICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtb2RlbEZpbGVQYXRoICsgJy5qc29uJywgSlNPTi5zdHJpbmdpZnkoYXN0LCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIERhb01vZGVsZXIuX2V4cG9ydFNvdXJjZUNvZGUoYXN0LCBtb2RlbEZpbGVQYXRoKTtcblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCB2aWV3IG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgKi9cblxuICAgIF9wcm9jZXNzRmllbGRNb2RpZmllcnMoZW50aXR5LCBzaGFyZWRDb250ZXh0KSB7XG4gICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IE9vbFRvQXN0LmNyZWF0ZUNvbXBpbGVDb250ZXh0KGVudGl0eS5vb2xNb2R1bGUubmFtZSwgdGhpcy5sb2dnZXIsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ3JhdyddID0geyBzb3VyY2U6ICdjb250ZXh0JywgZmluYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1snaTE4biddID0geyBzb3VyY2U6ICdjb250ZXh0JywgZmluYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1snY29ubmVjdG9yJ10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydsYXRlc3QnXSA9IHsgc291cmNlOiAnY29udGV4dCcgfTtcblxuICAgICAgICBjb25zdCBhbGxGaW5pc2hlZCA9IE9vbFRvQXN0LmNyZWF0ZVRvcG9JZChjb21waWxlQ29udGV4dCwgJ2RvbmUuJyk7XG5cbiAgICAgICAgLy9tYXAgb2YgZmllbGQgbmFtZSB0byBkZXBlbmRlbmNpZXNcbiAgICAgICAgbGV0IGZpZWxkUmVmZXJlbmNlcyA9IHt9O1xuXG4gICAgICAgIF8uZm9yT3duKGVudGl0eS5maWVsZHMsIChmaWVsZCwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgdG9wb0lkID0gT29sVG9Bc3QuY29tcGlsZUZpZWxkKGZpZWxkTmFtZSwgZmllbGQsIGNvbXBpbGVDb250ZXh0KTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgdG9wb0lkLCBhbGxGaW5pc2hlZCk7XG5cbiAgICAgICAgICAgIGlmIChmaWVsZC53cml0ZU9uY2UgfHwgZmllbGQuZnJlZXplQWZ0ZXJOb25EZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgcHV0SW50b0J1Y2tldChmaWVsZFJlZmVyZW5jZXMsIGZpZWxkTmFtZSwgZmllbGROYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IGRlcHMgPSBjb21waWxlQ29udGV4dC50b3BvU29ydC5zb3J0KCk7XG4gICAgICAgIHRoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICB0aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgbGV0IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwgPSBbXSwgbGFzdEZpZWxkc0dyb3VwLCBcbiAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IFtdLCBcbiAgICAgICAgICAgIGxhc3RCbG9jaywgbGFzdEFzdFR5cGU7Ly8sIGhhc1ZhbGlkYXRvciA9IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IF9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSA9IGZ1bmN0aW9uIChmaWVsZE5hbWUsIHJlZmVyZW5jZXMsIGFzdENhY2hlLCByZXF1aXJlVGFyZ2V0RmllbGQpIHsgXG4gICAgICAgICAgICBsZXQgZmllbGRzID0gKHJlcXVpcmVUYXJnZXRGaWVsZCA/IFsgZmllbGROYW1lIF0gOiBbXSkuY29uY2F0KHJlZmVyZW5jZXMpO1xuICAgICAgICAgICAgbGV0IGNoZWNrZXIgPSBmaWVsZHMuam9pbignLCcpO1xuXG4gICAgICAgICAgICBpZiAobGFzdEZpZWxkc0dyb3VwICYmIGxhc3RGaWVsZHNHcm91cC5jaGVja2VyICE9PSBjaGVja2VyKSB7XG4gICAgICAgICAgICAgICAgbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCA9IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwuY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICBTbmlwcGV0cy5fZmllbGRSZXF1aXJlbWVudENoZWNrKGxhc3RGaWVsZHNHcm91cC5maWVsZE5hbWUsIGxhc3RGaWVsZHNHcm91cC5yZWZlcmVuY2VzLCBtZXRob2RCb2R5Q2FjaGUsIGxhc3RGaWVsZHNHcm91cC5yZXF1aXJlVGFyZ2V0RmllbGQpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlID0gbWV0aG9kQm9keUNhY2hlLmNvbmNhdChhc3RDYWNoZSk7XG4gICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAgPSB7XG4gICAgICAgICAgICAgICAgZmllbGROYW1lLFxuICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMsXG4gICAgICAgICAgICAgICAgcmVxdWlyZVRhcmdldEZpZWxkLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjaGVja2VyLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vY29uc29sZS5kaXIoY29tcGlsZUNvbnRleHQuYXN0TWFwWydtb2JpbGV+aXNNb2JpbGVQaG9uZTphcmdbMV18PnN0cmluZ0Rhc2hlcml6ZSddLCB7IGRlcHRoOiA4IH0pOyBcblxuICAgICAgICBfLmVhY2goZGVwcywgKGRlcCwgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNvdXJjZU1hcCA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG4gICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcblxuICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkTmFtZSA9IGdldEZpZWxkTmFtZShzb3VyY2VNYXAudGFyZ2V0KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5yZWZlcmVuY2VzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZpZWxkUmVmZXJlbmNlID0gZmllbGRSZWZlcmVuY2VzW3RhcmdldEZpZWxkTmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKCFmaWVsZFJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFJlZmVyZW5jZXNbdGFyZ2V0RmllbGROYW1lXSA9IGZpZWxkUmVmZXJlbmNlID0gW107XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc291cmNlTWFwLnJlZmVyZW5jZXMuZm9yRWFjaChyZWYgPT4geyBpZiAoZmllbGRSZWZlcmVuY2UuaW5kZXhPZihyZWYpID09PSAtMSkgZmllbGRSZWZlcmVuY2UucHVzaChyZWYpOyB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGxhc3RCbG9jaykge1xuICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gY2hhaW5DYWxsKGxhc3RCbG9jaywgbGFzdEFzdFR5cGUsIGFzdEJsb2NrLCBzb3VyY2VNYXAudHlwZSk7XG4gICAgICAgICAgICAgICAgbGFzdEJsb2NrID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaSA8IGRlcHMubGVuZ3RoLTEpIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dFR5cGUgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXBzW2krMV0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzQ2hhaW5hYmxlKHNvdXJjZU1hcCwgbmV4dFR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RCbG9jayA9IGFzdEJsb2NrO1xuICAgICAgICAgICAgICAgICAgICBsYXN0QXN0VHlwZSA9IHNvdXJjZU1hcC50eXBlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoc291cmNlTWFwLnR5cGUgPT09IE9vbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAvL2hhc1ZhbGlkYXRvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gU25pcHBldHMuX3ZhbGlkYXRlQ2hlY2sodGFyZ2V0RmllbGROYW1lLCBhc3RCbG9jayk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgc291cmNlTWFwLnJlZmVyZW5jZXMsIGFzdENhY2hlLCB0cnVlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBBY3RpdmF0aW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUbyBiZSBpbXBsZW1lbnRlZC4nKTtcbiAgICAgICAgICAgICAgICAvL2FzdEJsb2NrID0gXy5jYXN0QXJyYXkoYXN0QmxvY2spOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvL19tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSh0YXJnZXRGaWVsZE5hbWUsIFtdLCBhc3RCbG9jayk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyogQ2hhbmdlZCB0byB0aHJvdyBlcnJvciBpbnN0ZWFkIG9mIHJldHVybmluZyBhIGVycm9yIG9iamVjdFxuICAgICAgICBpZiAoaGFzVmFsaWRhdG9yKSB7XG4gICAgICAgICAgICBsZXQgZGVjbGFyZSA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKHZhbGlkU3RhdGVOYW1lLCBmYWxzZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5Q3JlYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5VXBkYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShtZXRob2RCb2R5Q2FjaGUpKSB7XG4gICAgICAgICAgICBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsID0gbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbC5jb25jYXQoXG4gICAgICAgICAgICAgICAgU25pcHBldHMuX2ZpZWxkUmVxdWlyZW1lbnRDaGVjayhsYXN0RmllbGRzR3JvdXAuZmllbGROYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgbGFzdEZpZWxkc0dyb3VwLnJlZmVyZW5jZXMsIFxuICAgICAgICAgICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUsIFxuICAgICAgICAgICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAucmVxdWlyZVRhcmdldEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICB9ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKlxuICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oZmFsc2UpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RDbGFzc0RlY2xhcmUoJ0FiYycsICdNb2RlbCcsIFtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ3ByZXBhcmVFbnRpdHlEYXRhXycpLCBbICdjb250ZXh0JyBdLFxuICAgICAgICAgICAgU25pcHBldHMuX2RvVmFsaWRhdGVBbmRGaWxsSGVhZGVyLmNvbmNhdChtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsKS5jb25jYXQoWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZCgnY29udGV4dCcpKSBdKSxcbiAgICAgICAgICAgIGZhbHNlLCB0cnVlLCB0cnVlXG4gICAgICAgICldLCAnY29tbWVudCcpKTtcbiAgICAgICAgKi9cblxuICAgICAgICByZXR1cm4geyBhc3Q6IEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ2FwcGx5TW9kaWZpZXJzJyksIFsgJ2NvbnRleHQnLCAnaXNVcGRhdGluZycgXSxcbiAgICAgICAgICAgIFNuaXBwZXRzLl9hcHBseU1vZGlmaWVyc0hlYWRlci5jb25jYXQobWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCkuY29uY2F0KFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoJ2NvbnRleHQnKSkgXSksXG4gICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgJ0FwcGx5aW5nIHByZWRlZmluZWQgbW9kaWZpZXJzIHRvIGVudGl0eSBmaWVsZHMuJ1xuICAgICAgICApLCBmaWVsZFJlZmVyZW5jZXMgfTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShzY2hlbWEsIHsgZnVuY3Rpb25OYW1lLCBmdW5jdG9yVHlwZSwgZmlsZU5hbWUsIGFyZ3MgfSkge1xuICAgICAgICBsZXQgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICB0aGlzLm91dHB1dFBhdGgsXG4gICAgICAgICAgICBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgIGZpbGVOYW1lXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAvL3RvZG86IGFuYWx5c2UgY29kZSwgY29tcGFyZSBhcmd1bWVudHNcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGAkeyBfLnVwcGVyRmlyc3QoZnVuY3RvclR5cGUpIH0gXCIke2ZpbGVOYW1lfVwiIGV4aXN0cy4gRmlsZSBnZW5lcmF0aW5nIHNraXBwZWQuYCk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3QgPSBKc0xhbmcuYXN0UHJvZ3JhbSgpO1xuICAgICAgICBcbiAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0RnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBhcmdzLCBPT0xfTU9ESUZJRVJfUkVUVVJOW2Z1bmN0b3JUeXBlXShhcmdzKSkpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oJ21vZHVsZS5leHBvcnRzJywgSnNMYW5nLmFzdFZhclJlZihmdW5jdGlvbk5hbWUpKSk7XG5cbiAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMoZmlsZVBhdGgpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBKc0xhbmcuYXN0VG9Db2RlKGFzdCkpO1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgR2VuZXJhdGVkICR7IGZ1bmN0b3JUeXBlIH0gZmlsZTogJHtmaWxlUGF0aH1gKTtcbiAgICB9XG5cbiAgICBfYnVpbGRJbnRlcmZhY2VzKGVudGl0eSwgbW9kZWxNZXRhSW5pdCwgc2hhcmVkQ29udGV4dCkge1xuICAgICAgICBsZXQgYXN0ID0gW107XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXR5LmludGVyZmFjZXMsIChtZXRob2QsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oJ0J1aWxkaW5nIGludGVyZmFjZTogJyArIG5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgYXN0Qm9keSA9IFtcbiAgICAgICAgICAgICAgICBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnJG1ldGEnLCBKc0xhbmcuYXN0VmFyUmVmKCd0aGlzLm1ldGEuaW50ZXJmYWNlcy4nICsgbmFtZSksIHRydWUsIGZhbHNlLCAnUmV0cmlldmluZyB0aGUgbWV0YSBkYXRhJylcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IE9vbFRvQXN0LmNyZWF0ZUNvbXBpbGVDb250ZXh0KGVudGl0eS5vb2xNb2R1bGUubmFtZSwgdGhpcy5sb2dnZXIsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYW1NZXRhO1xuXG4gICAgICAgICAgICBpZiAobWV0aG9kLmFjY2VwdCkge1xuICAgICAgICAgICAgICAgIHBhcmFtTWV0YSA9IHRoaXMuX3Byb2Nlc3NQYXJhbXMobWV0aG9kLmFjY2VwdCwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL21ldGFkYXRhXG4gICAgICAgICAgICBtb2RlbE1ldGFJbml0WydpbnRlcmZhY2VzJ10gfHwgKG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXSA9IHt9KTtcbiAgICAgICAgICAgIG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXVtuYW1lXSA9IHsgcGFyYW1zOiBPYmplY3QudmFsdWVzKHBhcmFtTWV0YSkgfTtcblxuICAgICAgICAgICAgXy5lYWNoKG1ldGhvZC5pbXBsZW1lbnRhdGlvbiwgKG9wZXJhdGlvbiwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAvL2xldCBsYXN0VG9wb0lkID0gXG4gICAgICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZURiT3BlcmF0aW9uKGluZGV4LCBvcGVyYXRpb24sIGNvbXBpbGVDb250ZXh0LCBjb21waWxlQ29udGV4dC5tYWluU3RhcnRJZCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QucmV0dXJuKSB7XG4gICAgICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZUV4Y2VwdGlvbmFsUmV0dXJuKG1ldGhvZC5yZXR1cm4sIGNvbXBpbGVDb250ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRlcHMgPSBjb21waWxlQ29udGV4dC50b3BvU29ydC5zb3J0KCk7XG4gICAgICAgICAgICAvL3RoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgICAgIC8vdGhpcy5sb2dnZXIudmVyYm9zZSgnQWxsIG5lY2Vzc2FyeSBzb3VyY2UgY29kZTpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBfLmVhY2goZGVwcywgZGVwID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc291cmNlTWFwID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwKTtcbiAgICAgICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcblxuICAgICAgICAgICAgICAgIC8vdGhpcy5sb2dnZXIudmVyYm9zZSgnQ29kZSBwb2ludCBcIicgKyBkZXAgKyAnXCI6XFxuJyArIEpTT04uc3RyaW5naWZ5KHNvdXJjZU1hcCwgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkTmFtZSA9IHNvdXJjZU1hcC50YXJnZXQ7IC8vZ2V0RmllbGROYW1lKHNvdXJjZU1hcC50YXJnZXQpOyAgICAgIFxuXG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC50eXBlID09PSBPb2xUb0FzdC5BU1RfQkxLX1ZBTElEQVRPUl9DQUxMKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBTbmlwcGV0cy5fdmFsaWRhdGVDaGVjayh0YXJnZXRGaWVsZE5hbWUsIGFzdEJsb2NrKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlTWFwLnR5cGUgPT09IE9vbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5uZWVkRGVjbGFyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0VmFyRGVjbGFyZShKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQpLCBhc3RCbG9jaywgZmFsc2UsIGZhbHNlLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLm5lZWREZWNsYXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCksIGFzdEJsb2NrLCBmYWxzZSwgZmFsc2UsIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCwgdHJ1ZSksIGFzdEJsb2NrLCBgQWN0aXZhdGluZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXN0Qm9keSA9IGFzdEJvZHkuY29uY2F0KF8uY2FzdEFycmF5KGFzdEJsb2NrKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXN0LnB1c2goSnNMYW5nLmFzdE1lbWJlck1ldGhvZChhc3luY01ldGhvZE5hbWluZyhuYW1lKSwgT2JqZWN0LmtleXMocGFyYW1NZXRhKSwgYXN0Qm9keSwgZmFsc2UsIHRydWUsIHRydWUsIHJlcGxhY2VBbGwoXy5rZWJhYkNhc2UobmFtZSksICctJywgJyAnKSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXN0O1xuICAgIH07XG5cbiAgICBfcHJvY2Vzc1BhcmFtcyhhY2NlcHRQYXJhbXMsIGNvbXBpbGVDb250ZXh0KSB7XG4gICAgICAgIGxldCBwYXJhbU1ldGEgPSB7fTtcblxuICAgICAgICBhY2NlcHRQYXJhbXMuZm9yRWFjaCgocGFyYW0sIGkpID0+IHtcbiAgICAgICAgICAgIE9vbFRvQXN0LmNvbXBpbGVQYXJhbShpLCBwYXJhbSwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgcGFyYW1NZXRhW3BhcmFtLm5hbWVdID0gcGFyYW07XG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbcGFyYW0ubmFtZV0gPSB7IHNvdXJjZTogJ2FyZ3VtZW50JyB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcGFyYW1NZXRhO1xuICAgIH07XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGFvTW9kZWxlcjsiXX0=