"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  pascalCase,
  replaceAll,
  putIntoBucket
} = require('rk-utils');

const swig = require('swig-templates');

const OolTypes = require('../lang/OolTypes');

const OolUtil = require('../lang/OolUtils');

const JsLang = require('./util/ast.js');

const OolToAst = require('./util/oolToAst.js');

const Snippets = require('./dao/snippets');

const ChainableType = [OolToAst.AST_BLK_VALIDATOR_CALL, OolToAst.AST_BLK_PROCESSOR_CALL, OolToAst.AST_BLK_ACTIVATOR_CALL];

const getFieldName = t => t.split('.').pop();

const isChainable = (current, next) => ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;

const chainCall = (lastBlock, lastType, currentBlock, currentType) => {
  if (lastBlock) {
    if (lastType === 'ValidatorCall') {
      if (!(currentType === 'ValidatorCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock = JsLang.astBinExp(lastBlock, '&&', currentBlock);
    } else {
      if (!(currentType === 'ModifierCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock.arguments[0] = lastBlock;
    }
  }

  return currentBlock;
};

const asyncMethodNaming = name => name + '_';

const indentLines = (lines, indentation) => lines.split('\n').map((line, i) => i === 0 ? line : _.repeat(' ', indentation) + line).join('\n');

const OOL_MODIFIER_RETURN = {
  [OolTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],
  [OolTypes.Modifier.PROCESSOR]: args => [JsLang.astReturn(JsLang.astId(args[0]))],
  [OolTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId("undefined"))]
};

class DaoModeler {
  constructor(context, connector) {
    this.logger = context.logger;
    this.outputPath = context.modelOutputPath;
    this.connector = connector;
  }

  modeling_(schema) {
    this.logger.log('info', 'Generating entity models for schema "' + schema.name + '"...');

    this._generateSchemaModel(schema);

    this._generateEntityModel(schema);
  }

  _generateSchemaModel(schema) {
    let capitalized = pascalCase(schema.name);
    let locals = {
      driver: this.connector.driver,
      className: capitalized,
      schemaName: schema.name
    };
    let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'Database.js.swig');
    let classCode = swig.renderFile(classTemplate, locals);
    let modelFilePath = path.resolve(this.outputPath, capitalized + '.js');
    fs.ensureFileSync(modelFilePath);
    fs.writeFileSync(modelFilePath, classCode);
    this.logger.log('info', 'Generated database model: ' + modelFilePath);
  }

  _generateEntityModel(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let capitalized = pascalCase(entityInstanceName);
      let sharedContext = {
        mapOfFunctorToFile: {},
        newFunctorFiles: []
      };

      let {
        ast: astClassMain,
        fieldReferences
      } = this._processFieldModifiers(entity, sharedContext);

      astClassMain = [astClassMain];
      let uniqueKeys = [_.castArray(entity.key)];

      if (entity.indexes) {
        entity.indexes.forEach(index => {
          if (index.unique) {
            uniqueKeys.push(index.fields);
          }
        });
      }

      let modelMeta = {
        schemaName: schema.name,
        name: entityInstanceName,
        keyField: entity.key,
        fields: _.mapValues(entity.fields, f => f.toJSON()),
        features: entity.features || {},
        uniqueKeys
      };

      if (!_.isEmpty(entity.indexes)) {
        modelMeta.indexes = entity.indexes;
      }

      if (!_.isEmpty(entity.features)) {
        modelMeta.features = entity.features;
      }

      if (!_.isEmpty(entity.associations)) {
        modelMeta.associations = entity.associations;
      }

      if (!_.isEmpty(fieldReferences)) {
        modelMeta.fieldDependencies = fieldReferences;
      }

      if (entity.interfaces) {
        let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);

        astClassMain = astClassMain.concat(astInterfaces);
      }

      let importLines = [];

      if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {
        _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {
          importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, fileName)));
        });
      }

      if (!_.isEmpty(sharedContext.newFunctorFiles)) {
        _.each(sharedContext.newFunctorFiles, entry => {
          this._generateFunctionTemplateFile(schema, entry);
        });
      }

      let locals = {
        imports: importLines.join('\n'),
        className: capitalized,
        entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),
        classBody: indentLines(astClassMain.map(block => JsLang.astToCode(block)).join('\n\n'), 8),
        functors: indentLines(JsLang.astToCode(JsLang.astValue(_.reduce(sharedContext.newFunctorFiles, (result, functor) => {
          result['$' + functor.functionName] = JsLang.astId(functor.functionName);
          return result;
        }, {}))), 4)
      };
      let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'EntityModel.js.swig');
      let classCode = swig.renderFile(classTemplate, locals);
      let modelFilePath = path.resolve(this.outputPath, schema.name, capitalized + '.js');
      fs.ensureFileSync(modelFilePath);
      fs.writeFileSync(modelFilePath, classCode);
      this.logger.log('info', 'Generated entity model: ' + modelFilePath);
    });
  }

  _processFieldModifiers(entity, sharedContext) {
    let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
    compileContext.variables['raw'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['i18n'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['connector'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['latest'] = {
      source: 'context'
    };
    const allFinished = OolToAst.createTopoId(compileContext, 'done.');
    let fieldReferences = {};

    _.forOwn(entity.fields, (field, fieldName) => {
      let topoId = OolToAst.compileField(fieldName, field, compileContext);
      OolToAst.dependsOn(compileContext, topoId, allFinished);

      if (field.writeOnce || field.freezeAfterNonDefault) {
        putIntoBucket(fieldReferences, fieldName, fieldName);
      }
    });

    let deps = compileContext.topoSort.sort();
    deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));
    let methodBodyValidateAndFill = [],
        lastFieldsGroup,
        methodBodyCache = [],
        lastBlock,
        lastAstType;

    const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {
      let fields = (requireTargetField ? [fieldName] : []).concat(references);
      let checker = fields.join(',');

      if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {
        methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
        methodBodyCache = [];
      }

      methodBodyCache = methodBodyCache.concat(astCache);
      lastFieldsGroup = {
        fieldName,
        references,
        requireTargetField,
        checker
      };
    };

    _.each(deps, (dep, i) => {
      let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
      let astBlock = compileContext.astMap[dep];
      let targetFieldName = getFieldName(sourceMap.target);

      if (sourceMap.references) {
        let fieldReference = fieldReferences[targetFieldName];

        if (!fieldReference) {
          fieldReferences[targetFieldName] = fieldReference = [];
        }

        sourceMap.references.forEach(ref => {
          if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);
        });
      }

      if (lastBlock) {
        astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);
        lastBlock = undefined;
      }

      if (i < deps.length - 1) {
        let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);

        if (isChainable(sourceMap, nextType)) {
          lastBlock = astBlock;
          lastAstType = sourceMap.type;
          return;
        }
      }

      if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
        let astCache = Snippets._validateCheck(targetFieldName, astBlock);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);
      } else {
        throw new Error('To be implemented.');
      }
    });

    if (!_.isEmpty(methodBodyCache)) {
      methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
    }

    return {
      ast: JsLang.astMemberMethod(asyncMethodNaming('applyModifiers'), ['context', 'isUpdating'], Snippets._applyModifiersHeader.concat(methodBodyValidateAndFill).concat([JsLang.astReturn(JsLang.astId('context'))]), false, true, true, 'Applying predefined modifiers to entity fields.'),
      fieldReferences
    };
  }

  _generateFunctionTemplateFile(schema, {
    functionName,
    functorType,
    fileName,
    args
  }) {
    let filePath = path.resolve(this.outputPath, schema.name, fileName);

    if (fs.existsSync(filePath)) {
      this.logger.log('info', `${_.upperFirst(functorType)} "${fileName}" exists. File generating skipped.`);
      return;
    }

    let ast = JsLang.astProgram();
    JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));
    JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(functionName)));
    fs.ensureFileSync(filePath);
    fs.writeFileSync(filePath, JsLang.astToCode(ast));
    this.logger.log('info', `Generated ${functorType} file: ${filePath}`);
  }

  _buildInterfaces(entity, modelMetaInit, sharedContext) {
    let ast = [];

    _.forOwn(entity.interfaces, (method, name) => {
      this.logger.info('Building interface: ' + name);
      let astBody = [JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta.interfaces.' + name), true, false, 'Retrieving the meta data')];
      let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
      let paramMeta;

      if (method.accept) {
        paramMeta = this._processParams(method.accept, compileContext);
      }

      modelMetaInit['interfaces'] || (modelMetaInit['interfaces'] = {});
      modelMetaInit['interfaces'][name] = {
        params: Object.values(paramMeta)
      };

      _.each(method.implementation, (operation, index) => {
        OolToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);
      });

      if (method.return) {
        OolToAst.compileExceptionalReturn(method.return, compileContext);
      }

      let deps = compileContext.topoSort.sort();
      deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));

      _.each(deps, dep => {
        let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
        let astBlock = compileContext.astMap[dep];
        let targetFieldName = sourceMap.target;

        if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
          astBlock = Snippets._validateCheck(targetFieldName, astBlock);
        } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);
          }
        } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);
          }
        }

        astBody = astBody.concat(_.castArray(astBlock));
      });

      ast.push(JsLang.astMemberMethod(asyncMethodNaming(name), Object.keys(paramMeta), astBody, false, true, true, replaceAll(_.kebabCase(name), '-', ' ')));
    });

    return ast;
  }

  _processParams(acceptParams, compileContext) {
    let paramMeta = {};
    acceptParams.forEach((param, i) => {
      OolToAst.compileParam(i, param, compileContext);
      paramMeta[param.name] = param;
      compileContext.variables[param.name] = {
        source: 'argument'
      };
    });
    return paramMeta;
  }

}

module.exports = DaoModeler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbGVyL0Rhby5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsInBhc2NhbENhc2UiLCJyZXBsYWNlQWxsIiwicHV0SW50b0J1Y2tldCIsInN3aWciLCJPb2xUeXBlcyIsIk9vbFV0aWwiLCJKc0xhbmciLCJPb2xUb0FzdCIsIlNuaXBwZXRzIiwiQ2hhaW5hYmxlVHlwZSIsIkFTVF9CTEtfVkFMSURBVE9SX0NBTEwiLCJBU1RfQkxLX1BST0NFU1NPUl9DQUxMIiwiQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCIsImdldEZpZWxkTmFtZSIsInQiLCJzcGxpdCIsInBvcCIsImlzQ2hhaW5hYmxlIiwiY3VycmVudCIsIm5leHQiLCJpbmRleE9mIiwidHlwZSIsInRhcmdldCIsImNoYWluQ2FsbCIsImxhc3RCbG9jayIsImxhc3RUeXBlIiwiY3VycmVudEJsb2NrIiwiY3VycmVudFR5cGUiLCJhc3RCaW5FeHAiLCJhcmd1bWVudHMiLCJhc3luY01ldGhvZE5hbWluZyIsIm5hbWUiLCJpbmRlbnRMaW5lcyIsImxpbmVzIiwiaW5kZW50YXRpb24iLCJtYXAiLCJsaW5lIiwiaSIsInJlcGVhdCIsImpvaW4iLCJPT0xfTU9ESUZJRVJfUkVUVVJOIiwiTW9kaWZpZXIiLCJWQUxJREFUT1IiLCJhc3RSZXR1cm4iLCJQUk9DRVNTT1IiLCJhcmdzIiwiYXN0SWQiLCJBQ1RJVkFUT1IiLCJEYW9Nb2RlbGVyIiwiY29uc3RydWN0b3IiLCJjb250ZXh0IiwiY29ubmVjdG9yIiwibG9nZ2VyIiwib3V0cHV0UGF0aCIsIm1vZGVsT3V0cHV0UGF0aCIsIm1vZGVsaW5nXyIsInNjaGVtYSIsImxvZyIsIl9nZW5lcmF0ZVNjaGVtYU1vZGVsIiwiX2dlbmVyYXRlRW50aXR5TW9kZWwiLCJjYXBpdGFsaXplZCIsImxvY2FscyIsImRyaXZlciIsImNsYXNzTmFtZSIsInNjaGVtYU5hbWUiLCJjbGFzc1RlbXBsYXRlIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImNsYXNzQ29kZSIsInJlbmRlckZpbGUiLCJtb2RlbEZpbGVQYXRoIiwiZW5zdXJlRmlsZVN5bmMiLCJ3cml0ZUZpbGVTeW5jIiwiZm9yT3duIiwiZW50aXRpZXMiLCJlbnRpdHkiLCJlbnRpdHlJbnN0YW5jZU5hbWUiLCJzaGFyZWRDb250ZXh0IiwibWFwT2ZGdW5jdG9yVG9GaWxlIiwibmV3RnVuY3RvckZpbGVzIiwiYXN0IiwiYXN0Q2xhc3NNYWluIiwiZmllbGRSZWZlcmVuY2VzIiwiX3Byb2Nlc3NGaWVsZE1vZGlmaWVycyIsInVuaXF1ZUtleXMiLCJjYXN0QXJyYXkiLCJrZXkiLCJpbmRleGVzIiwiZm9yRWFjaCIsImluZGV4IiwidW5pcXVlIiwicHVzaCIsImZpZWxkcyIsIm1vZGVsTWV0YSIsImtleUZpZWxkIiwibWFwVmFsdWVzIiwiZiIsInRvSlNPTiIsImZlYXR1cmVzIiwiaXNFbXB0eSIsImFzc29jaWF0aW9ucyIsImZpZWxkRGVwZW5kZW5jaWVzIiwiaW50ZXJmYWNlcyIsImFzdEludGVyZmFjZXMiLCJfYnVpbGRJbnRlcmZhY2VzIiwiY29uY2F0IiwiaW1wb3J0TGluZXMiLCJmaWxlTmFtZSIsImZ1bmN0aW9uTmFtZSIsImFzdFRvQ29kZSIsImFzdFJlcXVpcmUiLCJlYWNoIiwiZW50cnkiLCJfZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZSIsImltcG9ydHMiLCJlbnRpdHlNZXRhIiwiSlNPTiIsInN0cmluZ2lmeSIsImNsYXNzQm9keSIsImJsb2NrIiwiZnVuY3RvcnMiLCJhc3RWYWx1ZSIsInJlZHVjZSIsInJlc3VsdCIsImZ1bmN0b3IiLCJjb21waWxlQ29udGV4dCIsImNyZWF0ZUNvbXBpbGVDb250ZXh0Iiwib29sTW9kdWxlIiwidmFyaWFibGVzIiwic291cmNlIiwiZmluYWxpemVkIiwiYWxsRmluaXNoZWQiLCJjcmVhdGVUb3BvSWQiLCJmaWVsZCIsImZpZWxkTmFtZSIsInRvcG9JZCIsImNvbXBpbGVGaWVsZCIsImRlcGVuZHNPbiIsIndyaXRlT25jZSIsImZyZWV6ZUFmdGVyTm9uRGVmYXVsdCIsImRlcHMiLCJ0b3BvU29ydCIsInNvcnQiLCJmaWx0ZXIiLCJkZXAiLCJtYXBPZlRva2VuVG9NZXRhIiwiaGFzIiwibWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCIsImxhc3RGaWVsZHNHcm91cCIsIm1ldGhvZEJvZHlDYWNoZSIsImxhc3RBc3RUeXBlIiwiX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlIiwicmVmZXJlbmNlcyIsImFzdENhY2hlIiwicmVxdWlyZVRhcmdldEZpZWxkIiwiY2hlY2tlciIsIl9maWVsZFJlcXVpcmVtZW50Q2hlY2siLCJzb3VyY2VNYXAiLCJnZXQiLCJhc3RCbG9jayIsImFzdE1hcCIsInRhcmdldEZpZWxkTmFtZSIsImZpZWxkUmVmZXJlbmNlIiwicmVmIiwidW5kZWZpbmVkIiwibGVuZ3RoIiwibmV4dFR5cGUiLCJfdmFsaWRhdGVDaGVjayIsImFzdEFzc2lnbiIsImFzdFZhclJlZiIsIkVycm9yIiwiYXN0TWVtYmVyTWV0aG9kIiwiX2FwcGx5TW9kaWZpZXJzSGVhZGVyIiwiZnVuY3RvclR5cGUiLCJmaWxlUGF0aCIsImV4aXN0c1N5bmMiLCJ1cHBlckZpcnN0IiwiYXN0UHJvZ3JhbSIsImFzdFB1c2hJbkJvZHkiLCJhc3RGdW5jdGlvbiIsIm1vZGVsTWV0YUluaXQiLCJtZXRob2QiLCJpbmZvIiwiYXN0Qm9keSIsImFzdFZhckRlY2xhcmUiLCJwYXJhbU1ldGEiLCJhY2NlcHQiLCJfcHJvY2Vzc1BhcmFtcyIsInBhcmFtcyIsIk9iamVjdCIsInZhbHVlcyIsImltcGxlbWVudGF0aW9uIiwib3BlcmF0aW9uIiwiY29tcGlsZURiT3BlcmF0aW9uIiwibWFpblN0YXJ0SWQiLCJyZXR1cm4iLCJjb21waWxlRXhjZXB0aW9uYWxSZXR1cm4iLCJuZWVkRGVjbGFyZSIsImtleXMiLCJrZWJhYkNhc2UiLCJhY2NlcHRQYXJhbXMiLCJwYXJhbSIsImNvbXBpbGVQYXJhbSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJB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aUI1SixVQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgcGFzY2FsQ2FzZSwgcmVwbGFjZUFsbCwgcHV0SW50b0J1Y2tldCB9ICA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBzd2lnICA9IHJlcXVpcmUoJ3N3aWctdGVtcGxhdGVzJyk7XG5cbmNvbnN0IE9vbFR5cGVzID0gcmVxdWlyZSgnLi4vbGFuZy9Pb2xUeXBlcycpO1xuY29uc3QgT29sVXRpbCA9IHJlcXVpcmUoJy4uL2xhbmcvT29sVXRpbHMnKTtcbmNvbnN0IEpzTGFuZyA9IHJlcXVpcmUoJy4vdXRpbC9hc3QuanMnKTtcbmNvbnN0IE9vbFRvQXN0ID0gcmVxdWlyZSgnLi91dGlsL29vbFRvQXN0LmpzJyk7XG5jb25zdCBTbmlwcGV0cyA9IHJlcXVpcmUoJy4vZGFvL3NuaXBwZXRzJyk7XG5cbmNvbnN0IENoYWluYWJsZVR5cGUgPSBbXG4gICAgT29sVG9Bc3QuQVNUX0JMS19WQUxJREFUT1JfQ0FMTCwgXG4gICAgT29sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCxcbiAgICBPb2xUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMXG5dO1xuXG5jb25zdCBnZXRGaWVsZE5hbWUgPSB0ID0+IHQuc3BsaXQoJy4nKS5wb3AoKTtcbmNvbnN0IGlzQ2hhaW5hYmxlID0gKGN1cnJlbnQsIG5leHQpID0+IENoYWluYWJsZVR5cGUuaW5kZXhPZihjdXJyZW50LnR5cGUpID4gLTFcbiAgICAmJiBjdXJyZW50LnRhcmdldCA9PT0gbmV4dC50YXJnZXRcbiAgICAmJiBuZXh0LnR5cGUgPT09IGN1cnJlbnQudHlwZTtcbmNvbnN0IGNoYWluQ2FsbCA9IChsYXN0QmxvY2ssIGxhc3RUeXBlLCBjdXJyZW50QmxvY2ssIGN1cnJlbnRUeXBlKSA9PiB7XG4gICAgaWYgKGxhc3RCbG9jaykge1xuICAgICAgICBpZiAobGFzdFR5cGUgPT09ICdWYWxpZGF0b3JDYWxsJykge1xuICAgICAgICAgICAgYXNzZXJ0OiBjdXJyZW50VHlwZSA9PT0gJ1ZhbGlkYXRvckNhbGwnLCAnVW5leHBlY3RlZCBjdXJyZW50VHlwZSc7XG5cbiAgICAgICAgICAgIGN1cnJlbnRCbG9jayA9IEpzTGFuZy5hc3RCaW5FeHAobGFzdEJsb2NrLCAnJiYnLCBjdXJyZW50QmxvY2spO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXNzZXJ0OiBjdXJyZW50VHlwZSA9PT0gJ01vZGlmaWVyQ2FsbCcsICdVbmV4cGVjdGVkIGN1cnJlbnRUeXBlJztcblxuICAgICAgICAgICAgY3VycmVudEJsb2NrLmFyZ3VtZW50c1swXSA9IGxhc3RCbG9jaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50QmxvY2s7XG59O1xuY29uc3QgYXN5bmNNZXRob2ROYW1pbmcgPSAobmFtZSkgPT4gbmFtZSArICdfJztcblxuY29uc3QgaW5kZW50TGluZXMgPSAobGluZXMsIGluZGVudGF0aW9uKSA9PiBsaW5lcy5zcGxpdCgnXFxuJykubWFwKChsaW5lLCBpKSA9PiBpID09PSAwID8gbGluZSA6IChfLnJlcGVhdCgnICcsIGluZGVudGF0aW9uKSArIGxpbmUpKS5qb2luKCdcXG4nKTtcblxuY29uc3QgT09MX01PRElGSUVSX1JFVFVSTiA9IHtcbiAgICBbT29sVHlwZXMuTW9kaWZpZXIuVkFMSURBVE9SXTogKCkgPT4gWyBKc0xhbmcuYXN0UmV0dXJuKHRydWUpIF0sXG4gICAgW09vbFR5cGVzLk1vZGlmaWVyLlBST0NFU1NPUl06IGFyZ3MgPT4gWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZChhcmdzWzBdKSkgXSxcbiAgICBbT29sVHlwZXMuTW9kaWZpZXIuQUNUSVZBVE9SXTogKCkgPT4gWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZChcInVuZGVmaW5lZFwiKSkgXVxufTtcblxuLyoqXG4gKiBPb2xvbmcgZGF0YWJhc2UgYWNjZXNzIG9iamVjdCAoREFPKSBtb2RlbGVyLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIERhb01vZGVsZXIge1xuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAgICAgKiBAcHJvcGVydHkge0xvZ2dlcn0gY29udGV4dC5sb2dnZXIgLSBMb2dnZXIgb2JqZWN0ICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0Lm1vZGVsT3V0cHV0UGF0aCAtIEdlbmVyYXRlZCBtb2RlbCBvdXRwdXQgcGF0aFxuICAgICAqIEBwYXJhbSB7Q29ubmVjdG9yfSBjb25uZWN0b3IgICAgICBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjsgICAgICAgXG4gICAgICAgIHRoaXMub3V0cHV0UGF0aCA9IGNvbnRleHQubW9kZWxPdXRwdXRQYXRoO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOyAgICAgICAgXG4gICAgfVxuXG4gICAgbW9kZWxpbmdfKHNjaGVtYSkge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCAnR2VuZXJhdGluZyBlbnRpdHkgbW9kZWxzIGZvciBzY2hlbWEgXCInICsgc2NoZW1hLm5hbWUgKyAnXCIuLi4nKTtcblxuICAgICAgICB0aGlzLl9nZW5lcmF0ZVNjaGVtYU1vZGVsKHNjaGVtYSk7XG4gICAgICAgIHRoaXMuX2dlbmVyYXRlRW50aXR5TW9kZWwoc2NoZW1hKTtcbiAgICAgICAgLy90aGlzLl9nZW5lcmF0ZVZpZXdNb2RlbCgpO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZVNjaGVtYU1vZGVsKHNjaGVtYSkge1xuICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBwYXNjYWxDYXNlKHNjaGVtYS5uYW1lKTtcblxuICAgICAgICBsZXQgbG9jYWxzID0ge1xuICAgICAgICAgICAgZHJpdmVyOiB0aGlzLmNvbm5lY3Rvci5kcml2ZXIsXG4gICAgICAgICAgICBjbGFzc05hbWU6IGNhcGl0YWxpemVkLFxuICAgICAgICAgICAgc2NoZW1hTmFtZTogc2NoZW1hLm5hbWVcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgY2xhc3NUZW1wbGF0ZSA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdkYXRhYmFzZScsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgJ0RhdGFiYXNlLmpzLnN3aWcnKTtcbiAgICAgICAgbGV0IGNsYXNzQ29kZSA9IHN3aWcucmVuZGVyRmlsZShjbGFzc1RlbXBsYXRlLCBsb2NhbHMpO1xuXG4gICAgICAgIGxldCBtb2RlbEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0UGF0aCwgY2FwaXRhbGl6ZWQgKyAnLmpzJyk7XG4gICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgsIGNsYXNzQ29kZSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCBkYXRhYmFzZSBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUVudGl0eU1vZGVsKHNjaGVtYSkge1xuICAgICAgICBfLmZvck93bihzY2hlbWEuZW50aXRpZXMsIChlbnRpdHksIGVudGl0eUluc3RhbmNlTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhcGl0YWxpemVkID0gcGFzY2FsQ2FzZShlbnRpdHlJbnN0YW5jZU5hbWUpOyAgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL3NoYXJlZCBpbmZvcm1hdGlvbiB3aXRoIG1vZGVsIENSVUQgYW5kIGN1c3RvbWl6ZWQgaW50ZXJmYWNlc1xuICAgICAgICAgICAgbGV0IHNoYXJlZENvbnRleHQgPSB7XG4gICAgICAgICAgICAgICAgbWFwT2ZGdW5jdG9yVG9GaWxlOiB7fSxcbiAgICAgICAgICAgICAgICBuZXdGdW5jdG9yRmlsZXM6IFtdXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgeyBhc3Q6IGFzdENsYXNzTWFpbiwgZmllbGRSZWZlcmVuY2VzIH0gPSB0aGlzLl9wcm9jZXNzRmllbGRNb2RpZmllcnMoZW50aXR5LCBzaGFyZWRDb250ZXh0KTtcbiAgICAgICAgICAgIGFzdENsYXNzTWFpbiA9IFsgYXN0Q2xhc3NNYWluIF07XG5cbiAgICAgICAgICAgIC8vcHJlcGFyZSBtZXRhIGRhdGFcbiAgICAgICAgICAgIGxldCB1bmlxdWVLZXlzID0gWyBfLmNhc3RBcnJheShlbnRpdHkua2V5KSBdO1xuXG4gICAgICAgICAgICBpZiAoZW50aXR5LmluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICBlbnRpdHkuaW5kZXhlcy5mb3JFYWNoKGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4LnVuaXF1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdW5pcXVlS2V5cy5wdXNoKGluZGV4LmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IG1vZGVsTWV0YSA9IHtcbiAgICAgICAgICAgICAgICBzY2hlbWFOYW1lOiBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBlbnRpdHlJbnN0YW5jZU5hbWUsXG4gICAgICAgICAgICAgICAga2V5RmllbGQ6IGVudGl0eS5rZXksXG4gICAgICAgICAgICAgICAgZmllbGRzOiBfLm1hcFZhbHVlcyhlbnRpdHkuZmllbGRzLCBmID0+IGYudG9KU09OKCkpLFxuICAgICAgICAgICAgICAgIGZlYXR1cmVzOiBlbnRpdHkuZmVhdHVyZXMgfHwge30sXG4gICAgICAgICAgICAgICAgdW5pcXVlS2V5c1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmluZGV4ZXMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmluZGV4ZXMgPSBlbnRpdHkuaW5kZXhlcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmZlYXR1cmVzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5mZWF0dXJlcyA9IGVudGl0eS5mZWF0dXJlcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmFzc29jaWF0aW9ucykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuYXNzb2NpYXRpb25zID0gZW50aXR5LmFzc29jaWF0aW9ucztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZmllbGRSZWZlcmVuY2VzKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5maWVsZERlcGVuZGVuY2llcyA9IGZpZWxkUmVmZXJlbmNlcztcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgLy9idWlsZCBjdXN0b21pemVkIGludGVyZmFjZXMgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChlbnRpdHkuaW50ZXJmYWNlcykge1xuICAgICAgICAgICAgICAgIGxldCBhc3RJbnRlcmZhY2VzID0gdGhpcy5fYnVpbGRJbnRlcmZhY2VzKGVudGl0eSwgbW9kZWxNZXRhLCBzaGFyZWRDb250ZXh0KTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGFzdEludGVyZmFjZXMpO1xuICAgICAgICAgICAgICAgIC8vbGV0IGFzdENsYXNzID0gYXN0Q2xhc3NNYWluW2FzdENsYXNzTWFpbi5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICAvL0pzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdENsYXNzLCBhc3RJbnRlcmZhY2VzKTtcbiAgICAgICAgICAgICAgICBhc3RDbGFzc01haW4gPSBhc3RDbGFzc01haW4uY29uY2F0KGFzdEludGVyZmFjZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgaW1wb3J0TGluZXMgPSBbXTtcblxuICAgICAgICAgICAgLy9nZW5lcmF0ZSBmdW5jdG9ycyBpZiBhbnlcbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHNoYXJlZENvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlKSkge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKHNoYXJlZENvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlLCAoZmlsZU5hbWUsIGZ1bmN0aW9uTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpbXBvcnRMaW5lcy5wdXNoKEpzTGFuZy5hc3RUb0NvZGUoSnNMYW5nLmFzdFJlcXVpcmUoZnVuY3Rpb25OYW1lLCBmaWxlTmFtZSkpKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShzaGFyZWRDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcykpIHtcbiAgICAgICAgICAgICAgICBfLmVhY2goc2hhcmVkQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMsIGVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShzY2hlbWEsIGVudHJ5KTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvL2Fzc2VtYmxlIHRoZSBzb3VyY2UgY29kZSBmaWxlXG4gICAgICAgICAgICAvL0pzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgYXN0Q2xhc3NNYWluKTtcblxuICAgICAgICAgICAgLy9Kc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIGVudGl0eS5maWVsZHMubWFwKCh2LCBrKSA9PiBKc0xhbmcuYXN0QXNzaWduKGNhcGl0YWxpemVkICsgJy5GXycgKyBfLnNuYWtlQ2FzZShrKS50b1VwcGVyQ2FzZSgpLCBrKSkpOyAgIFxuXG4gICAgICAgICAgICBsZXQgbG9jYWxzID0ge1xuICAgICAgICAgICAgICAgIGltcG9ydHM6IGltcG9ydExpbmVzLmpvaW4oJ1xcbicpLFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogY2FwaXRhbGl6ZWQsXG4gICAgICAgICAgICAgICAgZW50aXR5TWV0YTogaW5kZW50TGluZXMoSlNPTi5zdHJpbmdpZnkobW9kZWxNZXRhLCBudWxsLCA0KSwgNCksXG4gICAgICAgICAgICAgICAgY2xhc3NCb2R5OiBpbmRlbnRMaW5lcyhhc3RDbGFzc01haW4ubWFwKGJsb2NrID0+IEpzTGFuZy5hc3RUb0NvZGUoYmxvY2spKS5qb2luKCdcXG5cXG4nKSwgOCksXG4gICAgICAgICAgICAgICAgZnVuY3RvcnM6IGluZGVudExpbmVzKEpzTGFuZy5hc3RUb0NvZGUoSnNMYW5nLmFzdFZhbHVlKF8ucmVkdWNlKHNoYXJlZENvbnRleHQubmV3RnVuY3RvckZpbGVzLCAocmVzdWx0LCBmdW5jdG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnJCcgKyBmdW5jdG9yLmZ1bmN0aW9uTmFtZV0gPSBKc0xhbmcuYXN0SWQoZnVuY3Rvci5mdW5jdGlvbk5hbWUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH0sIHt9KSkpLCA0KSBcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCBjbGFzc1RlbXBsYXRlID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2RhdGFiYXNlJywgdGhpcy5jb25uZWN0b3IuZHJpdmVyLCAnRW50aXR5TW9kZWwuanMuc3dpZycpO1xuICAgICAgICAgICAgbGV0IGNsYXNzQ29kZSA9IHN3aWcucmVuZGVyRmlsZShjbGFzc1RlbXBsYXRlLCBsb2NhbHMpO1xuXG4gICAgICAgICAgICBsZXQgbW9kZWxGaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLm91dHB1dFBhdGgsIHNjaGVtYS5uYW1lLCBjYXBpdGFsaXplZCArICcuanMnKTtcbiAgICAgICAgICAgIGZzLmVuc3VyZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhtb2RlbEZpbGVQYXRoLCBjbGFzc0NvZGUpO1xuXG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGVudGl0eSBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgLypcbiAgICBfZ2VuZXJhdGVWaWV3TW9kZWwoc2NoZW1hLCBkYlNlcnZpY2UpIHsgICAgICAgIFxuICAgICAgICBfLmZvck93bihzY2hlbWEudmlld3MsICh2aWV3SW5mbywgdmlld05hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oJ0J1aWxkaW5nIHZpZXc6ICcgKyB2aWV3TmFtZSk7XG5cbiAgICAgICAgICAgIGxldCBjYXBpdGFsaXplZCA9IF8udXBwZXJGaXJzdCh2aWV3TmFtZSk7XG5cbiAgICAgICAgICAgIGxldCBhc3QgPSBKc0xhbmcuYXN0UHJvZ3JhbSgpO1xuXG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RSZXF1aXJlKCdNb3dhJywgJ21vd2EnKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCdVdGlsJywgSnNMYW5nLmFzdFZhclJlZignTW93YS5VdGlsJyksIHRydWUpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFZhckRlY2xhcmUoJ18nLCBKc0xhbmcuYXN0VmFyUmVmKCdVdGlsLl8nKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0UmVxdWlyZSgnVmlldycsICdtb3dhL2xpYi9vb2xvbmcvcnVudGltZS92aWV3JykpO1xuXG4gICAgICAgICAgICBsZXQgY29tcGlsZUNvbnRleHQgPSBPb2xUb0FzdC5jcmVhdGVDb21waWxlQ29udGV4dCh2aWV3TmFtZSwgZGJTZXJ2aWNlLnNlcnZpY2VJZCwgdGhpcy5sb2dnZXIpO1xuXG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC5tb2RlbFZhcnMuYWRkKHZpZXdJbmZvLmVudGl0eSk7XG5cbiAgICAgICAgICAgIGxldCBwYXJhbU1ldGE7XG5cbiAgICAgICAgICAgIGlmICh2aWV3SW5mby5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICBwYXJhbU1ldGEgPSB0aGlzLl9wcm9jZXNzUGFyYW1zKHZpZXdJbmZvLnBhcmFtcywgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdmlld01ldGEgPSB7XG4gICAgICAgICAgICAgICAgaXNMaXN0OiB2aWV3SW5mby5pc0xpc3QsXG4gICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbU1ldGFcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCB2aWV3Qm9keVRvcG9JZCA9IE9vbFRvQXN0LmNyZWF0ZVRvcG9JZChjb21waWxlQ29udGV4dCwgJyR2aWV3Jyk7XG4gICAgICAgICAgICBPb2xUb0FzdC5kZXBlbmRzT24oY29tcGlsZUNvbnRleHQsIGNvbXBpbGVDb250ZXh0Lm1haW5TdGFydElkLCB2aWV3Qm9keVRvcG9JZCk7XG5cbiAgICAgICAgICAgIGxldCB2aWV3TW9kZWxlciA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4vZGFvL3ZpZXcnLCBkYlNlcnZpY2UuZGJUeXBlICsgJy5qcycpKTtcbiAgICAgICAgICAgIGNvbXBpbGVDb250ZXh0LmFzdE1hcFt2aWV3Qm9keVRvcG9JZF0gPSB2aWV3TW9kZWxlcihkYlNlcnZpY2UsIHZpZXdOYW1lLCB2aWV3SW5mbyk7XG4gICAgICAgICAgICBPb2xUb0FzdC5hZGRDb2RlQmxvY2soY29tcGlsZUNvbnRleHQsIHZpZXdCb2R5VG9wb0lkLCB7XG4gICAgICAgICAgICAgICAgdHlwZTogT29sVG9Bc3QuQVNUX0JMS19WSUVXX09QRVJBVElPTlxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxldCByZXR1cm5Ub3BvSWQgPSBPb2xUb0FzdC5jcmVhdGVUb3BvSWQoY29tcGlsZUNvbnRleHQsICckcmV0dXJuOnZhbHVlJyk7XG4gICAgICAgICAgICBPb2xUb0FzdC5kZXBlbmRzT24oY29tcGlsZUNvbnRleHQsIHZpZXdCb2R5VG9wb0lkLCByZXR1cm5Ub3BvSWQpO1xuICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZVJldHVybihyZXR1cm5Ub3BvSWQsIHtcbiAgICAgICAgICAgICAgICBcIm9vbFR5cGVcIjogXCJPYmplY3RSZWZlcmVuY2VcIixcbiAgICAgICAgICAgICAgICBcIm5hbWVcIjogXCJ2aWV3RGF0YVwiXG4gICAgICAgICAgICB9LCBjb21waWxlQ29udGV4dCk7XG5cbiAgICAgICAgICAgIGxldCBkZXBzID0gY29tcGlsZUNvbnRleHQudG9wb1NvcnQuc29ydCgpO1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIudmVyYm9zZSgnQWxsIGRlcGVuZGVuY2llczpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIudmVyYm9zZSgnQWxsIG5lY2Vzc2FyeSBzb3VyY2UgY29kZTpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBsZXQgYXN0RG9Mb2FkTWFpbiA9IFtcbiAgICAgICAgICAgICAgICBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnJG1ldGEnLCBKc0xhbmcuYXN0VmFyUmVmKCd0aGlzLm1ldGEnKSwgdHJ1ZSwgZmFsc2UsICdSZXRyaWV2aW5nIHRoZSBtZXRhIGRhdGEnKVxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgXy5lYWNoKGRlcHMsIGRlcCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGFzdE1ldGEgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXApO1xuXG4gICAgICAgICAgICAgICAgbGV0IGFzdEJsb2NrID0gY29tcGlsZUNvbnRleHQuYXN0TWFwW2RlcF07XG4gICAgICAgICAgICAgICAgYXNzZXJ0OiBhc3RCbG9jaywgJ0VtcHR5IGFzdCBibG9jayc7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXN0TWV0YS50eXBlID09PSAnTW9kaWZpZXJDYWxsJykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGROYW1lID0gZ2V0RmllbGROYW1lKGFzdE1ldGEudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKGFzdE1ldGEudGFyZ2V0KSwgYXN0QmxvY2ssIGBNb2RpZnlpbmcgJHtmaWVsZE5hbWV9YCk7XG4gICAgICAgICAgICAgICAgICAgIGFzdERvTG9hZE1haW4ucHVzaChhc3RDYWNoZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhc3REb0xvYWRNYWluID0gYXN0RG9Mb2FkTWFpbi5jb25jYXQoXy5jYXN0QXJyYXkoY29tcGlsZUNvbnRleHQuYXN0TWFwW2RlcF0pKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb21waWxlQ29udGV4dC5tYXBPZkZ1bmN0b3JUb0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24oY29tcGlsZUNvbnRleHQubWFwT2ZGdW5jdG9yVG9GaWxlLCAoZmlsZU5hbWUsIGZ1bmN0aW9uTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RSZXF1aXJlKGZ1bmN0aW9uTmFtZSwgJy4nICsgZmlsZU5hbWUpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29tcGlsZUNvbnRleHQubmV3RnVuY3RvckZpbGVzKSkge1xuICAgICAgICAgICAgICAgIF8uZWFjaChjb21waWxlQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMsIGVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShkYlNlcnZpY2UsIGVudHJ5KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0Q2xhc3NEZWNsYXJlKGNhcGl0YWxpemVkLCAnVmlldycsIFtcbiAgICAgICAgICAgICAgICBKc0xhbmcuYXN0TWVtYmVyTWV0aG9kKCdfZG9Mb2FkJywgT2JqZWN0LmtleXMocGFyYW1NZXRhKSxcbiAgICAgICAgICAgICAgICAgICAgYXN0RG9Mb2FkTWFpbixcbiAgICAgICAgICAgICAgICAgICAgZmFsc2UsIHRydWUsIGZhbHNlLCAnUG9wdWxhdGUgdmlldyBkYXRhJ1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIF0sIGAke2NhcGl0YWxpemVkfSB2aWV3YCkpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0QXNzaWduKGNhcGl0YWxpemVkICsgJy5tZXRhJywgSnNMYW5nLmFzdFZhbHVlKHZpZXdNZXRhKSkpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0QXNzaWduKCdtb2R1bGUuZXhwb3J0cycsIEpzTGFuZy5hc3RWYXJSZWYoY2FwaXRhbGl6ZWQpKSk7XG5cbiAgICAgICAgICAgIGxldCBtb2RlbEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0UGF0aCwgZGJTZXJ2aWNlLmRiVHlwZSwgZGJTZXJ2aWNlLm5hbWUsICd2aWV3cycsIHZpZXdOYW1lICsgJy5qcycpO1xuICAgICAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGggKyAnLmpzb24nLCBKU09OLnN0cmluZ2lmeShhc3QsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgRGFvTW9kZWxlci5fZXhwb3J0U291cmNlQ29kZShhc3QsIG1vZGVsRmlsZVBhdGgpO1xuXG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIHZpZXcgbW9kZWw6ICcgKyBtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICAqL1xuXG4gICAgX3Byb2Nlc3NGaWVsZE1vZGlmaWVycyhlbnRpdHksIHNoYXJlZENvbnRleHQpIHtcbiAgICAgICAgbGV0IGNvbXBpbGVDb250ZXh0ID0gT29sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQoZW50aXR5Lm9vbE1vZHVsZS5uYW1lLCB0aGlzLmxvZ2dlciwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1sncmF3J10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydpMThuJ10gPSB7IHNvdXJjZTogJ2NvbnRleHQnLCBmaW5hbGl6ZWQ6IHRydWUgfTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydjb25uZWN0b3InXSA9IHsgc291cmNlOiAnY29udGV4dCcsIGZpbmFsaXplZDogdHJ1ZSB9O1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ2xhdGVzdCddID0geyBzb3VyY2U6ICdjb250ZXh0JyB9O1xuXG4gICAgICAgIGNvbnN0IGFsbEZpbmlzaGVkID0gT29sVG9Bc3QuY3JlYXRlVG9wb0lkKGNvbXBpbGVDb250ZXh0LCAnZG9uZS4nKTtcblxuICAgICAgICAvL21hcCBvZiBmaWVsZCBuYW1lIHRvIGRlcGVuZGVuY2llc1xuICAgICAgICBsZXQgZmllbGRSZWZlcmVuY2VzID0ge307XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXR5LmZpZWxkcywgKGZpZWxkLCBmaWVsZE5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCB0b3BvSWQgPSBPb2xUb0FzdC5jb21waWxlRmllbGQoZmllbGROYW1lLCBmaWVsZCwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgT29sVG9Bc3QuZGVwZW5kc09uKGNvbXBpbGVDb250ZXh0LCB0b3BvSWQsIGFsbEZpbmlzaGVkKTtcblxuICAgICAgICAgICAgaWYgKGZpZWxkLndyaXRlT25jZSB8fCBmaWVsZC5mcmVlemVBZnRlck5vbkRlZmF1bHQpIHtcbiAgICAgICAgICAgICAgICBwdXRJbnRvQnVja2V0KGZpZWxkUmVmZXJlbmNlcywgZmllbGROYW1lLCBmaWVsZE5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgLy90aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgZGVwZW5kZW5jaWVzOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgLy90aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgbGV0IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwgPSBbXSwgbGFzdEZpZWxkc0dyb3VwLCBcbiAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IFtdLCBcbiAgICAgICAgICAgIGxhc3RCbG9jaywgbGFzdEFzdFR5cGU7Ly8sIGhhc1ZhbGlkYXRvciA9IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IF9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSA9IGZ1bmN0aW9uIChmaWVsZE5hbWUsIHJlZmVyZW5jZXMsIGFzdENhY2hlLCByZXF1aXJlVGFyZ2V0RmllbGQpIHsgXG4gICAgICAgICAgICBsZXQgZmllbGRzID0gKHJlcXVpcmVUYXJnZXRGaWVsZCA/IFsgZmllbGROYW1lIF0gOiBbXSkuY29uY2F0KHJlZmVyZW5jZXMpO1xuICAgICAgICAgICAgbGV0IGNoZWNrZXIgPSBmaWVsZHMuam9pbignLCcpO1xuXG4gICAgICAgICAgICBpZiAobGFzdEZpZWxkc0dyb3VwICYmIGxhc3RGaWVsZHNHcm91cC5jaGVja2VyICE9PSBjaGVja2VyKSB7XG4gICAgICAgICAgICAgICAgbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCA9IG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwuY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICBTbmlwcGV0cy5fZmllbGRSZXF1aXJlbWVudENoZWNrKGxhc3RGaWVsZHNHcm91cC5maWVsZE5hbWUsIGxhc3RGaWVsZHNHcm91cC5yZWZlcmVuY2VzLCBtZXRob2RCb2R5Q2FjaGUsIGxhc3RGaWVsZHNHcm91cC5yZXF1aXJlVGFyZ2V0RmllbGQpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlID0gbWV0aG9kQm9keUNhY2hlLmNvbmNhdChhc3RDYWNoZSk7XG4gICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAgPSB7XG4gICAgICAgICAgICAgICAgZmllbGROYW1lLFxuICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMsXG4gICAgICAgICAgICAgICAgcmVxdWlyZVRhcmdldEZpZWxkLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjaGVja2VyLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vY29uc29sZS5kaXIoY29tcGlsZUNvbnRleHQuYXN0TWFwWydtb2JpbGV+aXNNb2JpbGVQaG9uZTphcmdbMV18PnN0cmluZ0Rhc2hlcml6ZSddLCB7IGRlcHRoOiA4IH0pOyBcblxuICAgICAgICBfLmVhY2goZGVwcywgKGRlcCwgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNvdXJjZU1hcCA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG4gICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcblxuICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkTmFtZSA9IGdldEZpZWxkTmFtZShzb3VyY2VNYXAudGFyZ2V0KTsgICAgICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5yZWZlcmVuY2VzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGZpZWxkUmVmZXJlbmNlID0gZmllbGRSZWZlcmVuY2VzW3RhcmdldEZpZWxkTmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKCFmaWVsZFJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZFJlZmVyZW5jZXNbdGFyZ2V0RmllbGROYW1lXSA9IGZpZWxkUmVmZXJlbmNlID0gW107XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgc291cmNlTWFwLnJlZmVyZW5jZXMuZm9yRWFjaChyZWYgPT4geyBpZiAoZmllbGRSZWZlcmVuY2UuaW5kZXhPZihyZWYpID09PSAtMSkgZmllbGRSZWZlcmVuY2UucHVzaChyZWYpOyB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGxhc3RCbG9jaykge1xuICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gY2hhaW5DYWxsKGxhc3RCbG9jaywgbGFzdEFzdFR5cGUsIGFzdEJsb2NrLCBzb3VyY2VNYXAudHlwZSk7XG4gICAgICAgICAgICAgICAgbGFzdEJsb2NrID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaSA8IGRlcHMubGVuZ3RoLTEpIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dFR5cGUgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXBzW2krMV0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzQ2hhaW5hYmxlKHNvdXJjZU1hcCwgbmV4dFR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RCbG9jayA9IGFzdEJsb2NrO1xuICAgICAgICAgICAgICAgICAgICBsYXN0QXN0VHlwZSA9IHNvdXJjZU1hcC50eXBlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoc291cmNlTWFwLnR5cGUgPT09IE9vbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAvL2hhc1ZhbGlkYXRvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gU25pcHBldHMuX3ZhbGlkYXRlQ2hlY2sodGFyZ2V0RmllbGROYW1lLCBhc3RCbG9jayk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgc291cmNlTWFwLnJlZmVyZW5jZXMsIGFzdENhY2hlLCB0cnVlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIGxldCBhc3RDYWNoZSA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBBY3RpdmF0aW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUbyBiZSBpbXBsZW1lbnRlZC4nKTtcbiAgICAgICAgICAgICAgICAvL2FzdEJsb2NrID0gXy5jYXN0QXJyYXkoYXN0QmxvY2spOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvL19tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSh0YXJnZXRGaWVsZE5hbWUsIFtdLCBhc3RCbG9jayk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyogQ2hhbmdlZCB0byB0aHJvdyBlcnJvciBpbnN0ZWFkIG9mIHJldHVybmluZyBhIGVycm9yIG9iamVjdFxuICAgICAgICBpZiAoaGFzVmFsaWRhdG9yKSB7XG4gICAgICAgICAgICBsZXQgZGVjbGFyZSA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKHZhbGlkU3RhdGVOYW1lLCBmYWxzZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5Q3JlYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgICAgICBtZXRob2RCb2R5VXBkYXRlLnVuc2hpZnQoZGVjbGFyZSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eShtZXRob2RCb2R5Q2FjaGUpKSB7XG4gICAgICAgICAgICBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsID0gbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbC5jb25jYXQoXG4gICAgICAgICAgICAgICAgU25pcHBldHMuX2ZpZWxkUmVxdWlyZW1lbnRDaGVjayhsYXN0RmllbGRzR3JvdXAuZmllbGROYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgbGFzdEZpZWxkc0dyb3VwLnJlZmVyZW5jZXMsIFxuICAgICAgICAgICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUsIFxuICAgICAgICAgICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAucmVxdWlyZVRhcmdldEZpZWxkXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICB9ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKlxuICAgICAgICBsZXQgYXN0ID0gSnNMYW5nLmFzdFByb2dyYW0oZmFsc2UpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RDbGFzc0RlY2xhcmUoJ0FiYycsICdNb2RlbCcsIFtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ3ByZXBhcmVFbnRpdHlEYXRhXycpLCBbICdjb250ZXh0JyBdLFxuICAgICAgICAgICAgU25pcHBldHMuX2RvVmFsaWRhdGVBbmRGaWxsSGVhZGVyLmNvbmNhdChtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsKS5jb25jYXQoWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZCgnY29udGV4dCcpKSBdKSxcbiAgICAgICAgICAgIGZhbHNlLCB0cnVlLCB0cnVlXG4gICAgICAgICldLCAnY29tbWVudCcpKTtcbiAgICAgICAgKi9cblxuICAgICAgICByZXR1cm4geyBhc3Q6IEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoYXN5bmNNZXRob2ROYW1pbmcoJ2FwcGx5TW9kaWZpZXJzJyksIFsgJ2NvbnRleHQnLCAnaXNVcGRhdGluZycgXSxcbiAgICAgICAgICAgIFNuaXBwZXRzLl9hcHBseU1vZGlmaWVyc0hlYWRlci5jb25jYXQobWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCkuY29uY2F0KFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoJ2NvbnRleHQnKSkgXSksXG4gICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgJ0FwcGx5aW5nIHByZWRlZmluZWQgbW9kaWZpZXJzIHRvIGVudGl0eSBmaWVsZHMuJ1xuICAgICAgICApLCBmaWVsZFJlZmVyZW5jZXMgfTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVGdW5jdGlvblRlbXBsYXRlRmlsZShzY2hlbWEsIHsgZnVuY3Rpb25OYW1lLCBmdW5jdG9yVHlwZSwgZmlsZU5hbWUsIGFyZ3MgfSkge1xuICAgICAgICBsZXQgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICB0aGlzLm91dHB1dFBhdGgsXG4gICAgICAgICAgICBzY2hlbWEubmFtZSxcbiAgICAgICAgICAgIGZpbGVOYW1lXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAvL3RvZG86IGFuYWx5c2UgY29kZSwgY29tcGFyZSBhcmd1bWVudHNcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGAkeyBfLnVwcGVyRmlyc3QoZnVuY3RvclR5cGUpIH0gXCIke2ZpbGVOYW1lfVwiIGV4aXN0cy4gRmlsZSBnZW5lcmF0aW5nIHNraXBwZWQuYCk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3QgPSBKc0xhbmcuYXN0UHJvZ3JhbSgpO1xuICAgICAgICBcbiAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0RnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBhcmdzLCBPT0xfTU9ESUZJRVJfUkVUVVJOW2Z1bmN0b3JUeXBlXShhcmdzKSkpO1xuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oJ21vZHVsZS5leHBvcnRzJywgSnNMYW5nLmFzdFZhclJlZihmdW5jdGlvbk5hbWUpKSk7XG5cbiAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMoZmlsZVBhdGgpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBKc0xhbmcuYXN0VG9Db2RlKGFzdCkpO1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgR2VuZXJhdGVkICR7IGZ1bmN0b3JUeXBlIH0gZmlsZTogJHtmaWxlUGF0aH1gKTtcbiAgICB9XG5cbiAgICBfYnVpbGRJbnRlcmZhY2VzKGVudGl0eSwgbW9kZWxNZXRhSW5pdCwgc2hhcmVkQ29udGV4dCkge1xuICAgICAgICBsZXQgYXN0ID0gW107XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXR5LmludGVyZmFjZXMsIChtZXRob2QsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oJ0J1aWxkaW5nIGludGVyZmFjZTogJyArIG5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgYXN0Qm9keSA9IFtcbiAgICAgICAgICAgICAgICBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnJG1ldGEnLCBKc0xhbmcuYXN0VmFyUmVmKCd0aGlzLm1ldGEuaW50ZXJmYWNlcy4nICsgbmFtZSksIHRydWUsIGZhbHNlLCAnUmV0cmlldmluZyB0aGUgbWV0YSBkYXRhJylcbiAgICAgICAgICAgIF07XG5cbiAgICAgICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IE9vbFRvQXN0LmNyZWF0ZUNvbXBpbGVDb250ZXh0KGVudGl0eS5vb2xNb2R1bGUubmFtZSwgdGhpcy5sb2dnZXIsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYW1NZXRhO1xuXG4gICAgICAgICAgICBpZiAobWV0aG9kLmFjY2VwdCkge1xuICAgICAgICAgICAgICAgIHBhcmFtTWV0YSA9IHRoaXMuX3Byb2Nlc3NQYXJhbXMobWV0aG9kLmFjY2VwdCwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL21ldGFkYXRhXG4gICAgICAgICAgICBtb2RlbE1ldGFJbml0WydpbnRlcmZhY2VzJ10gfHwgKG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXSA9IHt9KTtcbiAgICAgICAgICAgIG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXVtuYW1lXSA9IHsgcGFyYW1zOiBPYmplY3QudmFsdWVzKHBhcmFtTWV0YSkgfTtcblxuICAgICAgICAgICAgXy5lYWNoKG1ldGhvZC5pbXBsZW1lbnRhdGlvbiwgKG9wZXJhdGlvbiwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAvL2xldCBsYXN0VG9wb0lkID0gXG4gICAgICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZURiT3BlcmF0aW9uKGluZGV4LCBvcGVyYXRpb24sIGNvbXBpbGVDb250ZXh0LCBjb21waWxlQ29udGV4dC5tYWluU3RhcnRJZCk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QucmV0dXJuKSB7XG4gICAgICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZUV4Y2VwdGlvbmFsUmV0dXJuKG1ldGhvZC5yZXR1cm4sIGNvbXBpbGVDb250ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGRlcHMgPSBjb21waWxlQ29udGV4dC50b3BvU29ydC5zb3J0KCk7XG4gICAgICAgICAgICAvL3RoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICAgICAgZGVwcyA9IGRlcHMuZmlsdGVyKGRlcCA9PiBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmhhcyhkZXApKTtcbiAgICAgICAgICAgIC8vdGhpcy5sb2dnZXIudmVyYm9zZSgnQWxsIG5lY2Vzc2FyeSBzb3VyY2UgY29kZTpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBfLmVhY2goZGVwcywgZGVwID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc291cmNlTWFwID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwKTtcbiAgICAgICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcblxuICAgICAgICAgICAgICAgIC8vdGhpcy5sb2dnZXIudmVyYm9zZSgnQ29kZSBwb2ludCBcIicgKyBkZXAgKyAnXCI6XFxuJyArIEpTT04uc3RyaW5naWZ5KHNvdXJjZU1hcCwgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkTmFtZSA9IHNvdXJjZU1hcC50YXJnZXQ7IC8vZ2V0RmllbGROYW1lKHNvdXJjZU1hcC50YXJnZXQpOyAgICAgIFxuXG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC50eXBlID09PSBPb2xUb0FzdC5BU1RfQkxLX1ZBTElEQVRPUl9DQUxMKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBTbmlwcGV0cy5fdmFsaWRhdGVDaGVjayh0YXJnZXRGaWVsZE5hbWUsIGFzdEJsb2NrKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlTWFwLnR5cGUgPT09IE9vbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZU1hcC5uZWVkRGVjbGFyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0VmFyRGVjbGFyZShKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQpLCBhc3RCbG9jaywgZmFsc2UsIGZhbHNlLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLm5lZWREZWNsYXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCksIGFzdEJsb2NrLCBmYWxzZSwgZmFsc2UsIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCwgdHJ1ZSksIGFzdEJsb2NrLCBgQWN0aXZhdGluZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXN0Qm9keSA9IGFzdEJvZHkuY29uY2F0KF8uY2FzdEFycmF5KGFzdEJsb2NrKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXN0LnB1c2goSnNMYW5nLmFzdE1lbWJlck1ldGhvZChhc3luY01ldGhvZE5hbWluZyhuYW1lKSwgT2JqZWN0LmtleXMocGFyYW1NZXRhKSwgYXN0Qm9keSwgZmFsc2UsIHRydWUsIHRydWUsIHJlcGxhY2VBbGwoXy5rZWJhYkNhc2UobmFtZSksICctJywgJyAnKSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXN0O1xuICAgIH07XG5cbiAgICBfcHJvY2Vzc1BhcmFtcyhhY2NlcHRQYXJhbXMsIGNvbXBpbGVDb250ZXh0KSB7XG4gICAgICAgIGxldCBwYXJhbU1ldGEgPSB7fTtcblxuICAgICAgICBhY2NlcHRQYXJhbXMuZm9yRWFjaCgocGFyYW0sIGkpID0+IHtcbiAgICAgICAgICAgIE9vbFRvQXN0LmNvbXBpbGVQYXJhbShpLCBwYXJhbSwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgcGFyYW1NZXRhW3BhcmFtLm5hbWVdID0gcGFyYW07XG4gICAgICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbcGFyYW0ubmFtZV0gPSB7IHNvdXJjZTogJ2FyZ3VtZW50JyB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcGFyYW1NZXRhO1xuICAgIH07XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGFvTW9kZWxlcjsiXX0=