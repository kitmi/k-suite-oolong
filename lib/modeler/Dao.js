"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  pascalCase,
  replaceAll,
  putIntoBucket
} = require('rk-utils');

const swig = require('swig-templates');

const OolTypes = require('../lang/OolTypes');

const JsLang = require('./util/ast.js');

const OolToAst = require('./util/oolToAst.js');

const Snippets = require('./dao/snippets');

const ChainableType = [OolToAst.AST_BLK_VALIDATOR_CALL, OolToAst.AST_BLK_PROCESSOR_CALL, OolToAst.AST_BLK_ACTIVATOR_CALL];

const getFieldName = t => t.split('.').pop();

const isChainable = (current, next) => ChainableType.indexOf(current.type) > -1 && current.target === next.target && next.type === current.type;

const chainCall = (lastBlock, lastType, currentBlock, currentType) => {
  if (lastBlock) {
    if (lastType === 'ValidatorCall') {
      if (!(currentType === 'ValidatorCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock = JsLang.astBinExp(lastBlock, '&&', currentBlock);
    } else {
      if (!(currentType === 'ModifierCall')) {
        throw new Error('Unexpected currentType');
      }

      currentBlock.arguments[0] = lastBlock;
    }
  }

  return currentBlock;
};

const asyncMethodNaming = name => name + '_';

const indentLines = (lines, indentation) => lines.split('\n').map((line, i) => i === 0 ? line : _.repeat(' ', indentation) + line).join('\n');

const OOL_MODIFIER_RETURN = {
  [OolTypes.Modifier.VALIDATOR]: () => [JsLang.astReturn(true)],
  [OolTypes.Modifier.PROCESSOR]: args => [JsLang.astReturn(JsLang.astId(args[0]))],
  [OolTypes.Modifier.ACTIVATOR]: () => [JsLang.astReturn(JsLang.astId("undefined"))]
};

class DaoModeler {
  constructor(context, connector) {
    this.logger = context.logger;
    this.outputPath = context.modelOutputPath;
    this.manifestPath = context.manifestOutputPath;
    this.connector = connector;
  }

  modeling_(schema) {
    this.logger.log('info', 'Generating entity models for schema "' + schema.name + '"...');

    this._generateSchemaModel(schema);

    this._generateEntityModel(schema);

    if (this.manifestPath) {
      this._generateEntityManifest(schema);
    }
  }

  _generateSchemaModel(schema) {
    let capitalized = pascalCase(schema.name);
    let locals = {
      driver: this.connector.driver,
      className: capitalized,
      schemaName: schema.name
    };
    let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'Database.js.swig');
    let classCode = swig.renderFile(classTemplate, locals);
    let modelFilePath = path.resolve(this.outputPath, capitalized + '.js');
    fs.ensureFileSync(modelFilePath);
    fs.writeFileSync(modelFilePath, classCode);
    this.logger.log('info', 'Generated database model: ' + modelFilePath);
  }

  _generateEntityModel(schema) {
    _.forOwn(schema.entities, (entity, entityInstanceName) => {
      let capitalized = pascalCase(entityInstanceName);
      let sharedContext = {
        mapOfFunctorToFile: {},
        newFunctorFiles: []
      };

      let {
        ast: astClassMain,
        fieldReferences
      } = this._processFieldModifiers(entity, sharedContext);

      astClassMain = [astClassMain];
      let uniqueKeys = [_.castArray(entity.key)];

      if (entity.indexes) {
        entity.indexes.forEach(index => {
          if (index.unique) {
            uniqueKeys.push(index.fields);
          }
        });
      }

      let modelMeta = {
        schemaName: schema.name,
        name: entityInstanceName,
        keyField: entity.key,
        fields: _.mapValues(entity.fields, f => f.toJSON()),
        features: entity.features || {},
        uniqueKeys
      };

      if (!_.isEmpty(entity.indexes)) {
        modelMeta.indexes = entity.indexes;
      }

      if (!_.isEmpty(entity.features)) {
        modelMeta.features = entity.features;
      }

      if (!_.isEmpty(entity.associations)) {
        modelMeta.associations = entity.associations;
      }

      if (!_.isEmpty(fieldReferences)) {
        modelMeta.fieldDependencies = fieldReferences;
      }

      if (entity.interfaces) {
        let astInterfaces = this._buildInterfaces(entity, modelMeta, sharedContext);

        astClassMain = astClassMain.concat(astInterfaces);
      }

      let importLines = [];

      if (!_.isEmpty(sharedContext.mapOfFunctorToFile)) {
        _.forOwn(sharedContext.mapOfFunctorToFile, (fileName, functionName) => {
          importLines.push(JsLang.astToCode(JsLang.astRequire(functionName, fileName)));
        });
      }

      if (!_.isEmpty(sharedContext.newFunctorFiles)) {
        _.each(sharedContext.newFunctorFiles, entry => {
          this._generateFunctionTemplateFile(schema, entry);
        });
      }

      let locals = {
        imports: importLines.join('\n'),
        className: capitalized,
        entityMeta: indentLines(JSON.stringify(modelMeta, null, 4), 4),
        classBody: indentLines(astClassMain.map(block => JsLang.astToCode(block)).join('\n\n'), 8),
        functors: indentLines(JsLang.astToCode(JsLang.astValue(_.reduce(sharedContext.newFunctorFiles, (result, functor) => {
          result['$' + functor.functionName] = JsLang.astId(functor.functionName);
          return result;
        }, {}))), 4)
      };
      let classTemplate = path.resolve(__dirname, 'database', this.connector.driver, 'EntityModel.js.swig');
      let classCode = swig.renderFile(classTemplate, locals);
      let modelFilePath = path.resolve(this.outputPath, schema.name, capitalized + '.js');
      fs.ensureFileSync(modelFilePath);
      fs.writeFileSync(modelFilePath, classCode);
      this.logger.log('info', 'Generated entity model: ' + modelFilePath);
    });
  }

  _generateEntityManifest(schema) {
    let entities = _.mapValues(schema.entities, e => ({}));

    let outputFilePath = path.resolve(this.manifestPath, schema.name + '.manifest.json');
    fs.ensureFileSync(outputFilePath);
    fs.writeFileSync(outputFilePath, JSON.stringify(entities, null, 4));
    this.logger.log('info', 'Generated schema manifest: ' + outputFilePath);
  }

  _processFieldModifiers(entity, sharedContext) {
    let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
    compileContext.variables['raw'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['i18n'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['connector'] = {
      source: 'context',
      finalized: true
    };
    compileContext.variables['latest'] = {
      source: 'context'
    };
    const allFinished = OolToAst.createTopoId(compileContext, 'done.');
    let fieldReferences = {};

    _.forOwn(entity.fields, (field, fieldName) => {
      let topoId = OolToAst.compileField(fieldName, field, compileContext);
      OolToAst.dependsOn(compileContext, topoId, allFinished);

      if (field.writeOnce || field.freezeAfterNonDefault) {
        putIntoBucket(fieldReferences, fieldName, fieldName);
      }
    });

    let deps = compileContext.topoSort.sort();
    deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));
    let methodBodyValidateAndFill = [],
        lastFieldsGroup,
        methodBodyCache = [],
        lastBlock,
        lastAstType;

    const _mergeDoValidateAndFillCode = function (fieldName, references, astCache, requireTargetField) {
      let fields = (requireTargetField ? [fieldName] : []).concat(references);
      let checker = fields.join(',');

      if (lastFieldsGroup && lastFieldsGroup.checker !== checker) {
        methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
        methodBodyCache = [];
      }

      methodBodyCache = methodBodyCache.concat(astCache);
      lastFieldsGroup = {
        fieldName,
        references,
        requireTargetField,
        checker
      };
    };

    _.each(deps, (dep, i) => {
      let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
      let astBlock = compileContext.astMap[dep];
      let targetFieldName = getFieldName(sourceMap.target);

      if (sourceMap.references) {
        let fieldReference = fieldReferences[targetFieldName];

        if (!fieldReference) {
          fieldReferences[targetFieldName] = fieldReference = [];
        }

        sourceMap.references.forEach(ref => {
          if (fieldReference.indexOf(ref) === -1) fieldReference.push(ref);
        });
      }

      if (lastBlock) {
        astBlock = chainCall(lastBlock, lastAstType, astBlock, sourceMap.type);
        lastBlock = undefined;
      }

      if (i < deps.length - 1) {
        let nextType = compileContext.mapOfTokenToMeta.get(deps[i + 1]);

        if (isChainable(sourceMap, nextType)) {
          lastBlock = astBlock;
          lastAstType = sourceMap.type;
          return;
        }
      }

      if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
        let astCache = Snippets._validateCheck(targetFieldName, astBlock);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, true);
      } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
        let astCache = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);

        _mergeDoValidateAndFillCode(targetFieldName, sourceMap.references, astCache, false);
      } else {
        throw new Error('To be implemented.');
      }
    });

    if (!_.isEmpty(methodBodyCache)) {
      methodBodyValidateAndFill = methodBodyValidateAndFill.concat(Snippets._fieldRequirementCheck(lastFieldsGroup.fieldName, lastFieldsGroup.references, methodBodyCache, lastFieldsGroup.requireTargetField));
    }

    return {
      ast: JsLang.astMemberMethod(asyncMethodNaming('applyModifiers'), ['context', 'isUpdating'], Snippets._applyModifiersHeader.concat(methodBodyValidateAndFill).concat([JsLang.astReturn(JsLang.astId('context'))]), false, true, true, 'Applying predefined modifiers to entity fields.'),
      fieldReferences
    };
  }

  _generateFunctionTemplateFile(schema, {
    functionName,
    functorType,
    fileName,
    args
  }) {
    let filePath = path.resolve(this.outputPath, schema.name, fileName);

    if (fs.existsSync(filePath)) {
      this.logger.log('info', `${_.upperFirst(functorType)} "${fileName}" exists. File generating skipped.`);
      return;
    }

    let ast = JsLang.astProgram();
    JsLang.astPushInBody(ast, JsLang.astFunction(functionName, args, OOL_MODIFIER_RETURN[functorType](args)));
    JsLang.astPushInBody(ast, JsLang.astAssign('module.exports', JsLang.astVarRef(functionName)));
    fs.ensureFileSync(filePath);
    fs.writeFileSync(filePath, JsLang.astToCode(ast));
    this.logger.log('info', `Generated ${functorType} file: ${filePath}`);
  }

  _buildInterfaces(entity, modelMetaInit, sharedContext) {
    let ast = [];

    _.forOwn(entity.interfaces, (method, name) => {
      this.logger.info('Building interface: ' + name);
      let astBody = [JsLang.astVarDeclare('$meta', JsLang.astVarRef('this.meta.interfaces.' + name), true, false, 'Retrieving the meta data')];
      let compileContext = OolToAst.createCompileContext(entity.oolModule.name, this.logger, sharedContext);
      let paramMeta;

      if (method.accept) {
        paramMeta = this._processParams(method.accept, compileContext);
      }

      modelMetaInit['interfaces'] || (modelMetaInit['interfaces'] = {});
      modelMetaInit['interfaces'][name] = {
        params: Object.values(paramMeta)
      };

      _.each(method.implementation, (operation, index) => {
        OolToAst.compileDbOperation(index, operation, compileContext, compileContext.mainStartId);
      });

      if (method.return) {
        OolToAst.compileExceptionalReturn(method.return, compileContext);
      }

      let deps = compileContext.topoSort.sort();
      deps = deps.filter(dep => compileContext.mapOfTokenToMeta.has(dep));

      _.each(deps, dep => {
        let sourceMap = compileContext.mapOfTokenToMeta.get(dep);
        let astBlock = compileContext.astMap[dep];
        let targetFieldName = sourceMap.target;

        if (sourceMap.type === OolToAst.AST_BLK_VALIDATOR_CALL) {
          astBlock = Snippets._validateCheck(targetFieldName, astBlock);
        } else if (sourceMap.type === OolToAst.AST_BLK_PROCESSOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Processing "${targetFieldName}"`);
          }
        } else if (sourceMap.type === OolToAst.AST_BLK_ACTIVATOR_CALL) {
          if (sourceMap.needDeclare) {
            astBlock = JsLang.astVarDeclare(JsLang.astVarRef(sourceMap.target), astBlock, false, false, `Processing "${targetFieldName}"`);
          } else {
            astBlock = JsLang.astAssign(JsLang.astVarRef(sourceMap.target, true), astBlock, `Activating "${targetFieldName}"`);
          }
        }

        astBody = astBody.concat(_.castArray(astBlock));
      });

      ast.push(JsLang.astMemberMethod(asyncMethodNaming(name), Object.keys(paramMeta), astBody, false, true, true, replaceAll(_.kebabCase(name), '-', ' ')));
    });

    return ast;
  }

  _processParams(acceptParams, compileContext) {
    let paramMeta = {};
    acceptParams.forEach((param, i) => {
      OolToAst.compileParam(i, param, compileContext);
      paramMeta[param.name] = param;
      compileContext.variables[param.name] = {
        source: 'argument'
      };
    });
    return paramMeta;
  }

}

module.exports = DaoModeler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlbGVyL0Rhby5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsInBhc2NhbENhc2UiLCJyZXBsYWNlQWxsIiwicHV0SW50b0J1Y2tldCIsInN3aWciLCJPb2xUeXBlcyIsIkpzTGFuZyIsIk9vbFRvQXN0IiwiU25pcHBldHMiLCJDaGFpbmFibGVUeXBlIiwiQVNUX0JMS19WQUxJREFUT1JfQ0FMTCIsIkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwiLCJBU1RfQkxLX0FDVElWQVRPUl9DQUxMIiwiZ2V0RmllbGROYW1lIiwidCIsInNwbGl0IiwicG9wIiwiaXNDaGFpbmFibGUiLCJjdXJyZW50IiwibmV4dCIsImluZGV4T2YiLCJ0eXBlIiwidGFyZ2V0IiwiY2hhaW5DYWxsIiwibGFzdEJsb2NrIiwibGFzdFR5cGUiLCJjdXJyZW50QmxvY2siLCJjdXJyZW50VHlwZSIsImFzdEJpbkV4cCIsImFyZ3VtZW50cyIsImFzeW5jTWV0aG9kTmFtaW5nIiwibmFtZSIsImluZGVudExpbmVzIiwibGluZXMiLCJpbmRlbnRhdGlvbiIsIm1hcCIsImxpbmUiLCJpIiwicmVwZWF0Iiwiam9pbiIsIk9PTF9NT0RJRklFUl9SRVRVUk4iLCJNb2RpZmllciIsIlZBTElEQVRPUiIsImFzdFJldHVybiIsIlBST0NFU1NPUiIsImFyZ3MiLCJhc3RJZCIsIkFDVElWQVRPUiIsIkRhb01vZGVsZXIiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJjb25uZWN0b3IiLCJsb2dnZXIiLCJvdXRwdXRQYXRoIiwibW9kZWxPdXRwdXRQYXRoIiwibWFuaWZlc3RQYXRoIiwibWFuaWZlc3RPdXRwdXRQYXRoIiwibW9kZWxpbmdfIiwic2NoZW1hIiwibG9nIiwiX2dlbmVyYXRlU2NoZW1hTW9kZWwiLCJfZ2VuZXJhdGVFbnRpdHlNb2RlbCIsIl9nZW5lcmF0ZUVudGl0eU1hbmlmZXN0IiwiY2FwaXRhbGl6ZWQiLCJsb2NhbHMiLCJkcml2ZXIiLCJjbGFzc05hbWUiLCJzY2hlbWFOYW1lIiwiY2xhc3NUZW1wbGF0ZSIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJjbGFzc0NvZGUiLCJyZW5kZXJGaWxlIiwibW9kZWxGaWxlUGF0aCIsImVuc3VyZUZpbGVTeW5jIiwid3JpdGVGaWxlU3luYyIsImZvck93biIsImVudGl0aWVzIiwiZW50aXR5IiwiZW50aXR5SW5zdGFuY2VOYW1lIiwic2hhcmVkQ29udGV4dCIsIm1hcE9mRnVuY3RvclRvRmlsZSIsIm5ld0Z1bmN0b3JGaWxlcyIsImFzdCIsImFzdENsYXNzTWFpbiIsImZpZWxkUmVmZXJlbmNlcyIsIl9wcm9jZXNzRmllbGRNb2RpZmllcnMiLCJ1bmlxdWVLZXlzIiwiY2FzdEFycmF5Iiwia2V5IiwiaW5kZXhlcyIsImZvckVhY2giLCJpbmRleCIsInVuaXF1ZSIsInB1c2giLCJmaWVsZHMiLCJtb2RlbE1ldGEiLCJrZXlGaWVsZCIsIm1hcFZhbHVlcyIsImYiLCJ0b0pTT04iLCJmZWF0dXJlcyIsImlzRW1wdHkiLCJhc3NvY2lhdGlvbnMiLCJmaWVsZERlcGVuZGVuY2llcyIsImludGVyZmFjZXMiLCJhc3RJbnRlcmZhY2VzIiwiX2J1aWxkSW50ZXJmYWNlcyIsImNvbmNhdCIsImltcG9ydExpbmVzIiwiZmlsZU5hbWUiLCJmdW5jdGlvbk5hbWUiLCJhc3RUb0NvZGUiLCJhc3RSZXF1aXJlIiwiZWFjaCIsImVudHJ5IiwiX2dlbmVyYXRlRnVuY3Rpb25UZW1wbGF0ZUZpbGUiLCJpbXBvcnRzIiwiZW50aXR5TWV0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjbGFzc0JvZHkiLCJibG9jayIsImZ1bmN0b3JzIiwiYXN0VmFsdWUiLCJyZWR1Y2UiLCJyZXN1bHQiLCJmdW5jdG9yIiwiZSIsIm91dHB1dEZpbGVQYXRoIiwiY29tcGlsZUNvbnRleHQiLCJjcmVhdGVDb21waWxlQ29udGV4dCIsIm9vbE1vZHVsZSIsInZhcmlhYmxlcyIsInNvdXJjZSIsImZpbmFsaXplZCIsImFsbEZpbmlzaGVkIiwiY3JlYXRlVG9wb0lkIiwiZmllbGQiLCJmaWVsZE5hbWUiLCJ0b3BvSWQiLCJjb21waWxlRmllbGQiLCJkZXBlbmRzT24iLCJ3cml0ZU9uY2UiLCJmcmVlemVBZnRlck5vbkRlZmF1bHQiLCJkZXBzIiwidG9wb1NvcnQiLCJzb3J0IiwiZmlsdGVyIiwiZGVwIiwibWFwT2ZUb2tlblRvTWV0YSIsImhhcyIsIm1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwiLCJsYXN0RmllbGRzR3JvdXAiLCJtZXRob2RCb2R5Q2FjaGUiLCJsYXN0QXN0VHlwZSIsIl9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSIsInJlZmVyZW5jZXMiLCJhc3RDYWNoZSIsInJlcXVpcmVUYXJnZXRGaWVsZCIsImNoZWNrZXIiLCJfZmllbGRSZXF1aXJlbWVudENoZWNrIiwic291cmNlTWFwIiwiZ2V0IiwiYXN0QmxvY2siLCJhc3RNYXAiLCJ0YXJnZXRGaWVsZE5hbWUiLCJmaWVsZFJlZmVyZW5jZSIsInJlZiIsInVuZGVmaW5lZCIsImxlbmd0aCIsIm5leHRUeXBlIiwiX3ZhbGlkYXRlQ2hlY2siLCJhc3RBc3NpZ24iLCJhc3RWYXJSZWYiLCJFcnJvciIsImFzdE1lbWJlck1ldGhvZCIsIl9hcHBseU1vZGlmaWVyc0hlYWRlciIsImZ1bmN0b3JUeXBlIiwiZmlsZVBhdGgiLCJleGlzdHNTeW5jIiwidXBwZXJGaXJzdCIsImFzdFByb2dyYW0iLCJhc3RQdXNoSW5Cb2R5IiwiYXN0RnVuY3Rpb24iLCJtb2RlbE1ldGFJbml0IiwibWV0aG9kIiwiaW5mbyIsImFzdEJvZHkiLCJhc3RWYXJEZWNsYXJlIiwicGFyYW1NZXRhIiwiYWNjZXB0IiwiX3Byb2Nlc3NQYXJhbXMiLCJwYXJhbXMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJpbXBsZW1lbnRhdGlvbiIsIm9wZXJhdGlvbiIsImNvbXBpbGVEYk9wZXJhdGlvbiIsIm1haW5TdGFydElkIiwicmV0dXJuIiwiY29tcGlsZUV4Y2VwdGlvbmFsUmV0dXJuIiwibmVlZERlY2xhcmUiLCJrZXlzIiwia2ViYWJDYXNlIiwiYWNjZXB0UGFyYW1zIiwicGFyYW0iLCJjb21waWxlUGFyYW0iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsVUFBVDtBQUFxQkMsRUFBQUEsVUFBckI7QUFBaUNDLEVBQUFBO0FBQWpDLElBQW9ETCxPQUFPLENBQUMsVUFBRCxDQUFqRTs7QUFDQSxNQUFNTSxJQUFJLEdBQUlOLE9BQU8sQ0FBQyxnQkFBRCxDQUFyQjs7QUFFQSxNQUFNTyxRQUFRLEdBQUdQLE9BQU8sQ0FBQyxrQkFBRCxDQUF4Qjs7QUFDQSxNQUFNUSxNQUFNLEdBQUdSLE9BQU8sQ0FBQyxlQUFELENBQXRCOztBQUNBLE1BQU1TLFFBQVEsR0FBR1QsT0FBTyxDQUFDLG9CQUFELENBQXhCOztBQUNBLE1BQU1VLFFBQVEsR0FBR1YsT0FBTyxDQUFDLGdCQUFELENBQXhCOztBQUVBLE1BQU1XLGFBQWEsR0FBRyxDQUNsQkYsUUFBUSxDQUFDRyxzQkFEUyxFQUVsQkgsUUFBUSxDQUFDSSxzQkFGUyxFQUdsQkosUUFBUSxDQUFDSyxzQkFIUyxDQUF0Qjs7QUFNQSxNQUFNQyxZQUFZLEdBQUdDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxLQUFGLENBQVEsR0FBUixFQUFhQyxHQUFiLEVBQTFCOztBQUNBLE1BQU1DLFdBQVcsR0FBRyxDQUFDQyxPQUFELEVBQVVDLElBQVYsS0FBbUJWLGFBQWEsQ0FBQ1csT0FBZCxDQUFzQkYsT0FBTyxDQUFDRyxJQUE5QixJQUFzQyxDQUFDLENBQXZDLElBQ2hDSCxPQUFPLENBQUNJLE1BQVIsS0FBbUJILElBQUksQ0FBQ0csTUFEUSxJQUVoQ0gsSUFBSSxDQUFDRSxJQUFMLEtBQWNILE9BQU8sQ0FBQ0csSUFGN0I7O0FBR0EsTUFBTUUsU0FBUyxHQUFHLENBQUNDLFNBQUQsRUFBWUMsUUFBWixFQUFz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RixLQUFqRixFQUF3RixJQUF4RixFQUE4RixJQUE5RixFQUFvRzFMLFVBQVUsQ0FBQ0gsQ0FBQyxDQUFDNk0sU0FBRixDQUFZN0ssSUFBWixDQUFELEVBQW9CLEdBQXBCLEVBQXlCLEdBQXpCLENBQTlHLENBQVQ7QUFDSCxLQWhFRDs7QUFrRUEsV0FBT29ELEdBQVA7QUFDSDs7QUFFRDZHLEVBQUFBLGNBQWMsQ0FBQ2EsWUFBRCxFQUFlM0UsY0FBZixFQUErQjtBQUN6QyxRQUFJNEQsU0FBUyxHQUFHLEVBQWhCO0FBRUFlLElBQUFBLFlBQVksQ0FBQ2xILE9BQWIsQ0FBcUIsQ0FBQ21ILEtBQUQsRUFBUXpLLENBQVIsS0FBYztBQUMvQjlCLE1BQUFBLFFBQVEsQ0FBQ3dNLFlBQVQsQ0FBc0IxSyxDQUF0QixFQUF5QnlLLEtBQXpCLEVBQWdDNUUsY0FBaEM7QUFDQTRELE1BQUFBLFNBQVMsQ0FBQ2dCLEtBQUssQ0FBQy9LLElBQVAsQ0FBVCxHQUF3QitLLEtBQXhCO0FBQ0E1RSxNQUFBQSxjQUFjLENBQUNHLFNBQWYsQ0FBeUJ5RSxLQUFLLENBQUMvSyxJQUEvQixJQUF1QztBQUFFdUcsUUFBQUEsTUFBTSxFQUFFO0FBQVYsT0FBdkM7QUFDSCxLQUpEO0FBTUEsV0FBT3dELFNBQVA7QUFDSDs7QUFyZlk7O0FBd2ZqQmtCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpLLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBwYXNjYWxDYXNlLCByZXBsYWNlQWxsLCBwdXRJbnRvQnVja2V0IH0gID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHN3aWcgID0gcmVxdWlyZSgnc3dpZy10ZW1wbGF0ZXMnKTtcblxuY29uc3QgT29sVHlwZXMgPSByZXF1aXJlKCcuLi9sYW5nL09vbFR5cGVzJyk7XG5jb25zdCBKc0xhbmcgPSByZXF1aXJlKCcuL3V0aWwvYXN0LmpzJyk7XG5jb25zdCBPb2xUb0FzdCA9IHJlcXVpcmUoJy4vdXRpbC9vb2xUb0FzdC5qcycpO1xuY29uc3QgU25pcHBldHMgPSByZXF1aXJlKCcuL2Rhby9zbmlwcGV0cycpO1xuXG5jb25zdCBDaGFpbmFibGVUeXBlID0gW1xuICAgIE9vbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwsIFxuICAgIE9vbFRvQXN0LkFTVF9CTEtfUFJPQ0VTU09SX0NBTEwsXG4gICAgT29sVG9Bc3QuQVNUX0JMS19BQ1RJVkFUT1JfQ0FMTFxuXTtcblxuY29uc3QgZ2V0RmllbGROYW1lID0gdCA9PiB0LnNwbGl0KCcuJykucG9wKCk7XG5jb25zdCBpc0NoYWluYWJsZSA9IChjdXJyZW50LCBuZXh0KSA9PiBDaGFpbmFibGVUeXBlLmluZGV4T2YoY3VycmVudC50eXBlKSA+IC0xXG4gICAgJiYgY3VycmVudC50YXJnZXQgPT09IG5leHQudGFyZ2V0XG4gICAgJiYgbmV4dC50eXBlID09PSBjdXJyZW50LnR5cGU7XG5jb25zdCBjaGFpbkNhbGwgPSAobGFzdEJsb2NrLCBsYXN0VHlwZSwgY3VycmVudEJsb2NrLCBjdXJyZW50VHlwZSkgPT4ge1xuICAgIGlmIChsYXN0QmxvY2spIHtcbiAgICAgICAgaWYgKGxhc3RUeXBlID09PSAnVmFsaWRhdG9yQ2FsbCcpIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdWYWxpZGF0b3JDYWxsJywgJ1VuZXhwZWN0ZWQgY3VycmVudFR5cGUnO1xuXG4gICAgICAgICAgICBjdXJyZW50QmxvY2sgPSBKc0xhbmcuYXN0QmluRXhwKGxhc3RCbG9jaywgJyYmJywgY3VycmVudEJsb2NrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFzc2VydDogY3VycmVudFR5cGUgPT09ICdNb2RpZmllckNhbGwnLCAnVW5leHBlY3RlZCBjdXJyZW50VHlwZSc7XG5cbiAgICAgICAgICAgIGN1cnJlbnRCbG9jay5hcmd1bWVudHNbMF0gPSBsYXN0QmxvY2s7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY3VycmVudEJsb2NrO1xufTtcbmNvbnN0IGFzeW5jTWV0aG9kTmFtaW5nID0gKG5hbWUpID0+IG5hbWUgKyAnXyc7XG5cbmNvbnN0IGluZGVudExpbmVzID0gKGxpbmVzLCBpbmRlbnRhdGlvbikgPT4gbGluZXMuc3BsaXQoJ1xcbicpLm1hcCgobGluZSwgaSkgPT4gaSA9PT0gMCA/IGxpbmUgOiAoXy5yZXBlYXQoJyAnLCBpbmRlbnRhdGlvbikgKyBsaW5lKSkuam9pbignXFxuJyk7XG5cbmNvbnN0IE9PTF9NT0RJRklFUl9SRVRVUk4gPSB7XG4gICAgW09vbFR5cGVzLk1vZGlmaWVyLlZBTElEQVRPUl06ICgpID0+IFsgSnNMYW5nLmFzdFJldHVybih0cnVlKSBdLFxuICAgIFtPb2xUeXBlcy5Nb2RpZmllci5QUk9DRVNTT1JdOiBhcmdzID0+IFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoYXJnc1swXSkpIF0sXG4gICAgW09vbFR5cGVzLk1vZGlmaWVyLkFDVElWQVRPUl06ICgpID0+IFsgSnNMYW5nLmFzdFJldHVybihKc0xhbmcuYXN0SWQoXCJ1bmRlZmluZWRcIikpIF1cbn07XG5cbi8qKlxuICogT29sb25nIGRhdGFiYXNlIGFjY2VzcyBvYmplY3QgKERBTykgbW9kZWxlci5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBEYW9Nb2RlbGVyIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdCAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5tb2RlbE91dHB1dFBhdGggLSBHZW5lcmF0ZWQgbW9kZWwgb3V0cHV0IHBhdGhcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5tYW5pZmVzdE91dHB1dFBhdGggLSBFbnRpdGllcyBtYW5pZmVzdCBvdXRwdXQgcGF0aFxuICAgICAqIEBwYXJhbSB7Q29ubmVjdG9yfSBjb25uZWN0b3IgICAgICBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjsgICAgICAgXG4gICAgICAgIHRoaXMub3V0cHV0UGF0aCA9IGNvbnRleHQubW9kZWxPdXRwdXRQYXRoO1xuICAgICAgICB0aGlzLm1hbmlmZXN0UGF0aCA9IGNvbnRleHQubWFuaWZlc3RPdXRwdXRQYXRoO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yOyAgICAgICAgXG4gICAgfVxuXG4gICAgbW9kZWxpbmdfKHNjaGVtYSkge1xuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCAnR2VuZXJhdGluZyBlbnRpdHkgbW9kZWxzIGZvciBzY2hlbWEgXCInICsgc2NoZW1hLm5hbWUgKyAnXCIuLi4nKTtcblxuICAgICAgICB0aGlzLl9nZW5lcmF0ZVNjaGVtYU1vZGVsKHNjaGVtYSk7XG4gICAgICAgIHRoaXMuX2dlbmVyYXRlRW50aXR5TW9kZWwoc2NoZW1hKTtcbiAgICAgICAgLy90aGlzLl9nZW5lcmF0ZVZpZXdNb2RlbCgpO1xuXG4gICAgICAgIGlmICh0aGlzLm1hbmlmZXN0UGF0aCkge1xuICAgICAgICAgICAgdGhpcy5fZ2VuZXJhdGVFbnRpdHlNYW5pZmVzdChzY2hlbWEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlU2NoZW1hTW9kZWwoc2NoZW1hKSB7XG4gICAgICAgIGxldCBjYXBpdGFsaXplZCA9IHBhc2NhbENhc2Uoc2NoZW1hLm5hbWUpO1xuXG4gICAgICAgIGxldCBsb2NhbHMgPSB7XG4gICAgICAgICAgICBkcml2ZXI6IHRoaXMuY29ubmVjdG9yLmRyaXZlcixcbiAgICAgICAgICAgIGNsYXNzTmFtZTogY2FwaXRhbGl6ZWQsXG4gICAgICAgICAgICBzY2hlbWFOYW1lOiBzY2hlbWEubmFtZVxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBjbGFzc1RlbXBsYXRlID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2RhdGFiYXNlJywgdGhpcy5jb25uZWN0b3IuZHJpdmVyLCAnRGF0YWJhc2UuanMuc3dpZycpO1xuICAgICAgICBsZXQgY2xhc3NDb2RlID0gc3dpZy5yZW5kZXJGaWxlKGNsYXNzVGVtcGxhdGUsIGxvY2Fscyk7XG5cbiAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBjYXBpdGFsaXplZCArICcuanMnKTtcbiAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCwgY2xhc3NDb2RlKTtcblxuICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCAnR2VuZXJhdGVkIGRhdGFiYXNlIG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgfVxuXG4gICAgX2dlbmVyYXRlRW50aXR5TW9kZWwoc2NoZW1hKSB7XG4gICAgICAgIF8uZm9yT3duKHNjaGVtYS5lbnRpdGllcywgKGVudGl0eSwgZW50aXR5SW5zdGFuY2VOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FwaXRhbGl6ZWQgPSBwYXNjYWxDYXNlKGVudGl0eUluc3RhbmNlTmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vc2hhcmVkIGluZm9ybWF0aW9uIHdpdGggbW9kZWwgQ1JVRCBhbmQgY3VzdG9taXplZCBpbnRlcmZhY2VzXG4gICAgICAgICAgICBsZXQgc2hhcmVkQ29udGV4dCA9IHtcbiAgICAgICAgICAgICAgICBtYXBPZkZ1bmN0b3JUb0ZpbGU6IHt9LFxuICAgICAgICAgICAgICAgIG5ld0Z1bmN0b3JGaWxlczogW11cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCB7IGFzdDogYXN0Q2xhc3NNYWluLCBmaWVsZFJlZmVyZW5jZXMgfSA9IHRoaXMuX3Byb2Nlc3NGaWVsZE1vZGlmaWVycyhlbnRpdHksIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgYXN0Q2xhc3NNYWluID0gWyBhc3RDbGFzc01haW4gXTtcblxuICAgICAgICAgICAgLy9wcmVwYXJlIG1ldGEgZGF0YVxuICAgICAgICAgICAgbGV0IHVuaXF1ZUtleXMgPSBbIF8uY2FzdEFycmF5KGVudGl0eS5rZXkpIF07XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkuaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIGVudGl0eS5pbmRleGVzLmZvckVhY2goaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgudW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVLZXlzLnB1c2goaW5kZXguZmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgbW9kZWxNZXRhID0ge1xuICAgICAgICAgICAgICAgIHNjaGVtYU5hbWU6IHNjaGVtYS5uYW1lLFxuICAgICAgICAgICAgICAgIG5hbWU6IGVudGl0eUluc3RhbmNlTmFtZSxcbiAgICAgICAgICAgICAgICBrZXlGaWVsZDogZW50aXR5LmtleSxcbiAgICAgICAgICAgICAgICBmaWVsZHM6IF8ubWFwVmFsdWVzKGVudGl0eS5maWVsZHMsIGYgPT4gZi50b0pTT04oKSksXG4gICAgICAgICAgICAgICAgZmVhdHVyZXM6IGVudGl0eS5mZWF0dXJlcyB8fCB7fSxcbiAgICAgICAgICAgICAgICB1bmlxdWVLZXlzXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuaW5kZXhlcykpIHtcbiAgICAgICAgICAgICAgICBtb2RlbE1ldGEuaW5kZXhlcyA9IGVudGl0eS5pbmRleGVzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuZmVhdHVyZXMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmZlYXR1cmVzID0gZW50aXR5LmZlYXR1cmVzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShlbnRpdHkuYXNzb2NpYXRpb25zKSkge1xuICAgICAgICAgICAgICAgIG1vZGVsTWV0YS5hc3NvY2lhdGlvbnMgPSBlbnRpdHkuYXNzb2NpYXRpb25zO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShmaWVsZFJlZmVyZW5jZXMpKSB7XG4gICAgICAgICAgICAgICAgbW9kZWxNZXRhLmZpZWxkRGVwZW5kZW5jaWVzID0gZmllbGRSZWZlcmVuY2VzO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL2J1aWxkIGN1c3RvbWl6ZWQgaW50ZXJmYWNlcyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGVudGl0eS5pbnRlcmZhY2VzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzdEludGVyZmFjZXMgPSB0aGlzLl9idWlsZEludGVyZmFjZXMoZW50aXR5LCBtb2RlbE1ldGEsIHNoYXJlZENvbnRleHQpO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coYXN0SW50ZXJmYWNlcyk7XG4gICAgICAgICAgICAgICAgLy9sZXQgYXN0Q2xhc3MgPSBhc3RDbGFzc01haW5bYXN0Q2xhc3NNYWluLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgICAgIC8vSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0Q2xhc3MsIGFzdEludGVyZmFjZXMpO1xuICAgICAgICAgICAgICAgIGFzdENsYXNzTWFpbiA9IGFzdENsYXNzTWFpbi5jb25jYXQoYXN0SW50ZXJmYWNlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBpbXBvcnRMaW5lcyA9IFtdO1xuXG4gICAgICAgICAgICAvL2dlbmVyYXRlIGZ1bmN0b3JzIGlmIGFueVxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoc2hhcmVkQ29udGV4dC5tYXBPZkZ1bmN0b3JUb0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24oc2hhcmVkQ29udGV4dC5tYXBPZkZ1bmN0b3JUb0ZpbGUsIChmaWxlTmFtZSwgZnVuY3Rpb25OYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGltcG9ydExpbmVzLnB1c2goSnNMYW5nLmFzdFRvQ29kZShKc0xhbmcuYXN0UmVxdWlyZShmdW5jdGlvbk5hbWUsIGZpbGVOYW1lKSkpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KHNoYXJlZENvbnRleHQubmV3RnVuY3RvckZpbGVzKSkge1xuICAgICAgICAgICAgICAgIF8uZWFjaChzaGFyZWRDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcywgZW50cnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZW5lcmF0ZUZ1bmN0aW9uVGVtcGxhdGVGaWxlKHNjaGVtYSwgZW50cnkpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vYXNzZW1ibGUgdGhlIHNvdXJjZSBjb2RlIGZpbGVcbiAgICAgICAgICAgIC8vSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBhc3RDbGFzc01haW4pO1xuXG4gICAgICAgICAgICAvL0pzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgZW50aXR5LmZpZWxkcy5tYXAoKHYsIGspID0+IEpzTGFuZy5hc3RBc3NpZ24oY2FwaXRhbGl6ZWQgKyAnLkZfJyArIF8uc25ha2VDYXNlKGspLnRvVXBwZXJDYXNlKCksIGspKSk7ICAgXG5cbiAgICAgICAgICAgIGxldCBsb2NhbHMgPSB7XG4gICAgICAgICAgICAgICAgaW1wb3J0czogaW1wb3J0TGluZXMuam9pbignXFxuJyksXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiBjYXBpdGFsaXplZCxcbiAgICAgICAgICAgICAgICBlbnRpdHlNZXRhOiBpbmRlbnRMaW5lcyhKU09OLnN0cmluZ2lmeShtb2RlbE1ldGEsIG51bGwsIDQpLCA0KSxcbiAgICAgICAgICAgICAgICBjbGFzc0JvZHk6IGluZGVudExpbmVzKGFzdENsYXNzTWFpbi5tYXAoYmxvY2sgPT4gSnNMYW5nLmFzdFRvQ29kZShibG9jaykpLmpvaW4oJ1xcblxcbicpLCA4KSxcbiAgICAgICAgICAgICAgICBmdW5jdG9yczogaW5kZW50TGluZXMoSnNMYW5nLmFzdFRvQ29kZShKc0xhbmcuYXN0VmFsdWUoXy5yZWR1Y2Uoc2hhcmVkQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMsIChyZXN1bHQsIGZ1bmN0b3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0WyckJyArIGZ1bmN0b3IuZnVuY3Rpb25OYW1lXSA9IEpzTGFuZy5hc3RJZChmdW5jdG9yLmZ1bmN0aW9uTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfSwge30pKSksIDQpIFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IGNsYXNzVGVtcGxhdGUgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnZGF0YWJhc2UnLCB0aGlzLmNvbm5lY3Rvci5kcml2ZXIsICdFbnRpdHlNb2RlbC5qcy5zd2lnJyk7XG4gICAgICAgICAgICBsZXQgY2xhc3NDb2RlID0gc3dpZy5yZW5kZXJGaWxlKGNsYXNzVGVtcGxhdGUsIGxvY2Fscyk7XG5cbiAgICAgICAgICAgIGxldCBtb2RlbEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMub3V0cHV0UGF0aCwgc2NoZW1hLm5hbWUsIGNhcGl0YWxpemVkICsgJy5qcycpO1xuICAgICAgICAgICAgZnMuZW5zdXJlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCk7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG1vZGVsRmlsZVBhdGgsIGNsYXNzQ29kZSk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgZW50aXR5IG1vZGVsOiAnICsgbW9kZWxGaWxlUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUVudGl0eU1hbmlmZXN0KHNjaGVtYSkge1xuICAgICAgICBsZXQgZW50aXRpZXMgPSBfLm1hcFZhbHVlcyhzY2hlbWEuZW50aXRpZXMsIGUgPT4gKHt9KSk7XG5cbiAgICAgICAgbGV0IG91dHB1dEZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMubWFuaWZlc3RQYXRoLCBzY2hlbWEubmFtZSArICcubWFuaWZlc3QuanNvbicpO1xuICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhvdXRwdXRGaWxlUGF0aCk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMob3V0cHV0RmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KGVudGl0aWVzLCBudWxsLCA0KSk7XG5cbiAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgJ0dlbmVyYXRlZCBzY2hlbWEgbWFuaWZlc3Q6ICcgKyBvdXRwdXRGaWxlUGF0aCk7XG59XG5cbiAgICAvKlxuICAgIF9nZW5lcmF0ZVZpZXdNb2RlbChzY2hlbWEsIGRiU2VydmljZSkgeyAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKHNjaGVtYS52aWV3cywgKHZpZXdJbmZvLCB2aWV3TmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnQnVpbGRpbmcgdmlldzogJyArIHZpZXdOYW1lKTtcblxuICAgICAgICAgICAgbGV0IGNhcGl0YWxpemVkID0gXy51cHBlckZpcnN0KHZpZXdOYW1lKTtcblxuICAgICAgICAgICAgbGV0IGFzdCA9IEpzTGFuZy5hc3RQcm9ncmFtKCk7XG5cbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoJ01vd2EnLCAnbW93YScpKTtcbiAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFZhckRlY2xhcmUoJ1V0aWwnLCBKc0xhbmcuYXN0VmFyUmVmKCdNb3dhLlV0aWwnKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgSnNMYW5nLmFzdFB1c2hJbkJvZHkoYXN0LCBKc0xhbmcuYXN0VmFyRGVjbGFyZSgnXycsIEpzTGFuZy5hc3RWYXJSZWYoJ1V0aWwuXycpLCB0cnVlKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RSZXF1aXJlKCdWaWV3JywgJ21vd2EvbGliL29vbG9uZy9ydW50aW1lL3ZpZXcnKSk7XG5cbiAgICAgICAgICAgIGxldCBjb21waWxlQ29udGV4dCA9IE9vbFRvQXN0LmNyZWF0ZUNvbXBpbGVDb250ZXh0KHZpZXdOYW1lLCBkYlNlcnZpY2Uuc2VydmljZUlkLCB0aGlzLmxvZ2dlcik7XG5cbiAgICAgICAgICAgIGNvbXBpbGVDb250ZXh0Lm1vZGVsVmFycy5hZGQodmlld0luZm8uZW50aXR5KTtcblxuICAgICAgICAgICAgbGV0IHBhcmFtTWV0YTtcblxuICAgICAgICAgICAgaWYgKHZpZXdJbmZvLnBhcmFtcykge1xuICAgICAgICAgICAgICAgIHBhcmFtTWV0YSA9IHRoaXMuX3Byb2Nlc3NQYXJhbXModmlld0luZm8ucGFyYW1zLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCB2aWV3TWV0YSA9IHtcbiAgICAgICAgICAgICAgICBpc0xpc3Q6IHZpZXdJbmZvLmlzTGlzdCxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHBhcmFtTWV0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHZpZXdCb2R5VG9wb0lkID0gT29sVG9Bc3QuY3JlYXRlVG9wb0lkKGNvbXBpbGVDb250ZXh0LCAnJHZpZXcnKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgY29tcGlsZUNvbnRleHQubWFpblN0YXJ0SWQsIHZpZXdCb2R5VG9wb0lkKTtcblxuICAgICAgICAgICAgbGV0IHZpZXdNb2RlbGVyID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi9kYW8vdmlldycsIGRiU2VydmljZS5kYlR5cGUgKyAnLmpzJykpO1xuICAgICAgICAgICAgY29tcGlsZUNvbnRleHQuYXN0TWFwW3ZpZXdCb2R5VG9wb0lkXSA9IHZpZXdNb2RlbGVyKGRiU2VydmljZSwgdmlld05hbWUsIHZpZXdJbmZvKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmFkZENvZGVCbG9jayhjb21waWxlQ29udGV4dCwgdmlld0JvZHlUb3BvSWQsIHtcbiAgICAgICAgICAgICAgICB0eXBlOiBPb2xUb0FzdC5BU1RfQkxLX1ZJRVdfT1BFUkFUSU9OXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IHJldHVyblRvcG9JZCA9IE9vbFRvQXN0LmNyZWF0ZVRvcG9JZChjb21waWxlQ29udGV4dCwgJyRyZXR1cm46dmFsdWUnKTtcbiAgICAgICAgICAgIE9vbFRvQXN0LmRlcGVuZHNPbihjb21waWxlQ29udGV4dCwgdmlld0JvZHlUb3BvSWQsIHJldHVyblRvcG9JZCk7XG4gICAgICAgICAgICBPb2xUb0FzdC5jb21waWxlUmV0dXJuKHJldHVyblRvcG9JZCwge1xuICAgICAgICAgICAgICAgIFwib29sVHlwZVwiOiBcIk9iamVjdFJlZmVyZW5jZVwiLFxuICAgICAgICAgICAgICAgIFwibmFtZVwiOiBcInZpZXdEYXRhXCJcbiAgICAgICAgICAgIH0sIGNvbXBpbGVDb250ZXh0KTtcblxuICAgICAgICAgICAgbGV0IGRlcHMgPSBjb21waWxlQ29udGV4dC50b3BvU29ydC5zb3J0KCk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgZGVwZW5kZW5jaWVzOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGRlcHMgPSBkZXBzLmZpbHRlcihkZXAgPT4gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5oYXMoZGVwKSk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIGxldCBhc3REb0xvYWRNYWluID0gW1xuICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCckbWV0YScsIEpzTGFuZy5hc3RWYXJSZWYoJ3RoaXMubWV0YScpLCB0cnVlLCBmYWxzZSwgJ1JldHJpZXZpbmcgdGhlIG1ldGEgZGF0YScpXG4gICAgICAgICAgICBdO1xuXG4gICAgICAgICAgICBfLmVhY2goZGVwcywgZGVwID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgYXN0TWV0YSA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgYXN0QmxvY2sgPSBjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6IGFzdEJsb2NrLCAnRW1wdHkgYXN0IGJsb2NrJztcblxuICAgICAgICAgICAgICAgIGlmIChhc3RNZXRhLnR5cGUgPT09ICdNb2RpZmllckNhbGwnKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWVsZE5hbWUgPSBnZXRGaWVsZE5hbWUoYXN0TWV0YS50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoYXN0TWV0YS50YXJnZXQpLCBhc3RCbG9jaywgYE1vZGlmeWluZyAke2ZpZWxkTmFtZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgYXN0RG9Mb2FkTWFpbi5wdXNoKGFzdENhY2hlKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFzdERvTG9hZE1haW4gPSBhc3REb0xvYWRNYWluLmNvbmNhdChfLmNhc3RBcnJheShjb21waWxlQ29udGV4dC5hc3RNYXBbZGVwXSkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbXBpbGVDb250ZXh0Lm1hcE9mRnVuY3RvclRvRmlsZSkpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihjb21waWxlQ29udGV4dC5tYXBPZkZ1bmN0b3JUb0ZpbGUsIChmaWxlTmFtZSwgZnVuY3Rpb25OYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdFJlcXVpcmUoZnVuY3Rpb25OYW1lLCAnLicgKyBmaWxlTmFtZSkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb21waWxlQ29udGV4dC5uZXdGdW5jdG9yRmlsZXMpKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKGNvbXBpbGVDb250ZXh0Lm5ld0Z1bmN0b3JGaWxlcywgZW50cnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZW5lcmF0ZUZ1bmN0aW9uVGVtcGxhdGVGaWxlKGRiU2VydmljZSwgZW50cnkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RDbGFzc0RlY2xhcmUoY2FwaXRhbGl6ZWQsICdWaWV3JywgW1xuICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RNZW1iZXJNZXRob2QoJ19kb0xvYWQnLCBPYmplY3Qua2V5cyhwYXJhbU1ldGEpLFxuICAgICAgICAgICAgICAgICAgICBhc3REb0xvYWRNYWluLFxuICAgICAgICAgICAgICAgICAgICBmYWxzZSwgdHJ1ZSwgZmFsc2UsICdQb3B1bGF0ZSB2aWV3IGRhdGEnXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgXSwgYCR7Y2FwaXRhbGl6ZWR9IHZpZXdgKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oY2FwaXRhbGl6ZWQgKyAnLm1ldGEnLCBKc0xhbmcuYXN0VmFsdWUodmlld01ldGEpKSk7XG4gICAgICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RBc3NpZ24oJ21vZHVsZS5leHBvcnRzJywgSnNMYW5nLmFzdFZhclJlZihjYXBpdGFsaXplZCkpKTtcblxuICAgICAgICAgICAgbGV0IG1vZGVsRmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5vdXRwdXRQYXRoLCBkYlNlcnZpY2UuZGJUeXBlLCBkYlNlcnZpY2UubmFtZSwgJ3ZpZXdzJywgdmlld05hbWUgKyAnLmpzJyk7XG4gICAgICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhtb2RlbEZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMobW9kZWxGaWxlUGF0aCArICcuanNvbicsIEpTT04uc3RyaW5naWZ5KGFzdCwgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBEYW9Nb2RlbGVyLl9leHBvcnRTb3VyY2VDb2RlKGFzdCwgbW9kZWxGaWxlUGF0aCk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsICdHZW5lcmF0ZWQgdmlldyBtb2RlbDogJyArIG1vZGVsRmlsZVBhdGgpO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgICovXG5cbiAgICBfcHJvY2Vzc0ZpZWxkTW9kaWZpZXJzKGVudGl0eSwgc2hhcmVkQ29udGV4dCkge1xuICAgICAgICBsZXQgY29tcGlsZUNvbnRleHQgPSBPb2xUb0FzdC5jcmVhdGVDb21waWxlQ29udGV4dChlbnRpdHkub29sTW9kdWxlLm5hbWUsIHRoaXMubG9nZ2VyLCBzaGFyZWRDb250ZXh0KTtcbiAgICAgICAgY29tcGlsZUNvbnRleHQudmFyaWFibGVzWydyYXcnXSA9IHsgc291cmNlOiAnY29udGV4dCcsIGZpbmFsaXplZDogdHJ1ZSB9O1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ2kxOG4nXSA9IHsgc291cmNlOiAnY29udGV4dCcsIGZpbmFsaXplZDogdHJ1ZSB9O1xuICAgICAgICBjb21waWxlQ29udGV4dC52YXJpYWJsZXNbJ2Nvbm5lY3RvciddID0geyBzb3VyY2U6ICdjb250ZXh0JywgZmluYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1snbGF0ZXN0J10gPSB7IHNvdXJjZTogJ2NvbnRleHQnIH07XG5cbiAgICAgICAgY29uc3QgYWxsRmluaXNoZWQgPSBPb2xUb0FzdC5jcmVhdGVUb3BvSWQoY29tcGlsZUNvbnRleHQsICdkb25lLicpO1xuXG4gICAgICAgIC8vbWFwIG9mIGZpZWxkIG5hbWUgdG8gZGVwZW5kZW5jaWVzXG4gICAgICAgIGxldCBmaWVsZFJlZmVyZW5jZXMgPSB7fTtcblxuICAgICAgICBfLmZvck93bihlbnRpdHkuZmllbGRzLCAoZmllbGQsIGZpZWxkTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHRvcG9JZCA9IE9vbFRvQXN0LmNvbXBpbGVGaWVsZChmaWVsZE5hbWUsIGZpZWxkLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICBPb2xUb0FzdC5kZXBlbmRzT24oY29tcGlsZUNvbnRleHQsIHRvcG9JZCwgYWxsRmluaXNoZWQpO1xuXG4gICAgICAgICAgICBpZiAoZmllbGQud3JpdGVPbmNlIHx8IGZpZWxkLmZyZWV6ZUFmdGVyTm9uRGVmYXVsdCkge1xuICAgICAgICAgICAgICAgIHB1dEludG9CdWNrZXQoZmllbGRSZWZlcmVuY2VzLCBmaWVsZE5hbWUsIGZpZWxkTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBkZXBzID0gY29tcGlsZUNvbnRleHQudG9wb1NvcnQuc29ydCgpO1xuICAgICAgICAvL3RoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBkZXBlbmRlbmNpZXM6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICAvL3RoaXMubG9nZ2VyLnZlcmJvc2UoJ0FsbCBuZWNlc3Nhcnkgc291cmNlIGNvZGU6XFxuJyArIEpTT04uc3RyaW5naWZ5KGRlcHMsIG51bGwsIDIpKTtcblxuICAgICAgICBsZXQgbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbCA9IFtdLCBsYXN0RmllbGRzR3JvdXAsIFxuICAgICAgICAgICAgbWV0aG9kQm9keUNhY2hlID0gW10sIFxuICAgICAgICAgICAgbGFzdEJsb2NrLCBsYXN0QXN0VHlwZTsvLywgaGFzVmFsaWRhdG9yID0gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlID0gZnVuY3Rpb24gKGZpZWxkTmFtZSwgcmVmZXJlbmNlcywgYXN0Q2FjaGUsIHJlcXVpcmVUYXJnZXRGaWVsZCkgeyBcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSAocmVxdWlyZVRhcmdldEZpZWxkID8gWyBmaWVsZE5hbWUgXSA6IFtdKS5jb25jYXQocmVmZXJlbmNlcyk7XG4gICAgICAgICAgICBsZXQgY2hlY2tlciA9IGZpZWxkcy5qb2luKCcsJyk7XG5cbiAgICAgICAgICAgIGlmIChsYXN0RmllbGRzR3JvdXAgJiYgbGFzdEZpZWxkc0dyb3VwLmNoZWNrZXIgIT09IGNoZWNrZXIpIHtcbiAgICAgICAgICAgICAgICBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsID0gbWV0aG9kQm9keVZhbGlkYXRlQW5kRmlsbC5jb25jYXQoXG4gICAgICAgICAgICAgICAgICAgIFNuaXBwZXRzLl9maWVsZFJlcXVpcmVtZW50Q2hlY2sobGFzdEZpZWxkc0dyb3VwLmZpZWxkTmFtZSwgbGFzdEZpZWxkc0dyb3VwLnJlZmVyZW5jZXMsIG1ldGhvZEJvZHlDYWNoZSwgbGFzdEZpZWxkc0dyb3VwLnJlcXVpcmVUYXJnZXRGaWVsZClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSA9IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBtZXRob2RCb2R5Q2FjaGUgPSBtZXRob2RCb2R5Q2FjaGUuY29uY2F0KGFzdENhY2hlKTtcbiAgICAgICAgICAgIGxhc3RGaWVsZHNHcm91cCA9IHtcbiAgICAgICAgICAgICAgICBmaWVsZE5hbWUsXG4gICAgICAgICAgICAgICAgcmVmZXJlbmNlcyxcbiAgICAgICAgICAgICAgICByZXF1aXJlVGFyZ2V0RmllbGQsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNoZWNrZXIsXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLy9jb25zb2xlLmRpcihjb21waWxlQ29udGV4dC5hc3RNYXBbJ21vYmlsZX5pc01vYmlsZVBob25lOmFyZ1sxXXw+c3RyaW5nRGFzaGVyaXplJ10sIHsgZGVwdGg6IDggfSk7IFxuXG4gICAgICAgIF8uZWFjaChkZXBzLCAoZGVwLCBpKSA9PiB7XG4gICAgICAgICAgICBsZXQgc291cmNlTWFwID0gY29tcGlsZUNvbnRleHQubWFwT2ZUb2tlblRvTWV0YS5nZXQoZGVwKTtcbiAgICAgICAgICAgIGxldCBhc3RCbG9jayA9IGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdO1xuXG4gICAgICAgICAgICBsZXQgdGFyZ2V0RmllbGROYW1lID0gZ2V0RmllbGROYW1lKHNvdXJjZU1hcC50YXJnZXQpOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBpZiAoc291cmNlTWFwLnJlZmVyZW5jZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgZmllbGRSZWZlcmVuY2UgPSBmaWVsZFJlZmVyZW5jZXNbdGFyZ2V0RmllbGROYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAoIWZpZWxkUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkUmVmZXJlbmNlc1t0YXJnZXRGaWVsZE5hbWVdID0gZmllbGRSZWZlcmVuY2UgPSBbXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzb3VyY2VNYXAucmVmZXJlbmNlcy5mb3JFYWNoKHJlZiA9PiB7IGlmIChmaWVsZFJlZmVyZW5jZS5pbmRleE9mKHJlZikgPT09IC0xKSBmaWVsZFJlZmVyZW5jZS5wdXNoKHJlZik7IH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobGFzdEJsb2NrKSB7XG4gICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBjaGFpbkNhbGwobGFzdEJsb2NrLCBsYXN0QXN0VHlwZSwgYXN0QmxvY2ssIHNvdXJjZU1hcC50eXBlKTtcbiAgICAgICAgICAgICAgICBsYXN0QmxvY2sgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpIDwgZGVwcy5sZW5ndGgtMSkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0VHlwZSA9IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuZ2V0KGRlcHNbaSsxXSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNDaGFpbmFibGUoc291cmNlTWFwLCBuZXh0VHlwZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEJsb2NrID0gYXN0QmxvY2s7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RBc3RUeXBlID0gc291cmNlTWFwLnR5cGU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19WQUxJREFUT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgIC8vaGFzVmFsaWRhdG9yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBsZXQgYXN0Q2FjaGUgPSBTbmlwcGV0cy5fdmFsaWRhdGVDaGVjayh0YXJnZXRGaWVsZE5hbWUsIGFzdEJsb2NrKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBfbWVyZ2VEb1ZhbGlkYXRlQW5kRmlsbENvZGUodGFyZ2V0RmllbGROYW1lLCBzb3VyY2VNYXAucmVmZXJlbmNlcywgYXN0Q2FjaGUsIHRydWUpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZU1hcC50eXBlID09PSBPb2xUb0FzdC5BU1RfQkxLX1BST0NFU1NPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIF9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSh0YXJnZXRGaWVsZE5hbWUsIHNvdXJjZU1hcC5yZWZlcmVuY2VzLCBhc3RDYWNoZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZU1hcC50eXBlID09PSBPb2xUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFzdENhY2hlID0gSnNMYW5nLmFzdEFzc2lnbihKc0xhbmcuYXN0VmFyUmVmKHNvdXJjZU1hcC50YXJnZXQsIHRydWUpLCBhc3RCbG9jaywgYEFjdGl2YXRpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIF9tZXJnZURvVmFsaWRhdGVBbmRGaWxsQ29kZSh0YXJnZXRGaWVsZE5hbWUsIHNvdXJjZU1hcC5yZWZlcmVuY2VzLCBhc3RDYWNoZSwgZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RvIGJlIGltcGxlbWVudGVkLicpO1xuICAgICAgICAgICAgICAgIC8vYXN0QmxvY2sgPSBfLmNhc3RBcnJheShhc3RCbG9jayk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vX21lcmdlRG9WYWxpZGF0ZUFuZEZpbGxDb2RlKHRhcmdldEZpZWxkTmFtZSwgW10sIGFzdEJsb2NrKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvKiBDaGFuZ2VkIHRvIHRocm93IGVycm9yIGluc3RlYWQgb2YgcmV0dXJuaW5nIGEgZXJyb3Igb2JqZWN0XG4gICAgICAgIGlmIChoYXNWYWxpZGF0b3IpIHtcbiAgICAgICAgICAgIGxldCBkZWNsYXJlID0gSnNMYW5nLmFzdFZhckRlY2xhcmUodmFsaWRTdGF0ZU5hbWUsIGZhbHNlKTtcbiAgICAgICAgICAgIG1ldGhvZEJvZHlDcmVhdGUudW5zaGlmdChkZWNsYXJlKTtcbiAgICAgICAgICAgIG1ldGhvZEJvZHlVcGRhdGUudW5zaGlmdChkZWNsYXJlKTtcbiAgICAgICAgfVxuICAgICAgICAqL1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KG1ldGhvZEJvZHlDYWNoZSkpIHtcbiAgICAgICAgICAgIG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwgPSBtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsLmNvbmNhdChcbiAgICAgICAgICAgICAgICBTbmlwcGV0cy5fZmllbGRSZXF1aXJlbWVudENoZWNrKGxhc3RGaWVsZHNHcm91cC5maWVsZE5hbWUsIFxuICAgICAgICAgICAgICAgICAgICBsYXN0RmllbGRzR3JvdXAucmVmZXJlbmNlcywgXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZEJvZHlDYWNoZSwgXG4gICAgICAgICAgICAgICAgICAgIGxhc3RGaWVsZHNHcm91cC5yZXF1aXJlVGFyZ2V0RmllbGRcbiAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgIH0gICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qXG4gICAgICAgIGxldCBhc3QgPSBKc0xhbmcuYXN0UHJvZ3JhbShmYWxzZSk7XG4gICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdENsYXNzRGVjbGFyZSgnQWJjJywgJ01vZGVsJywgW1xuICAgICAgICAgICAgSnNMYW5nLmFzdE1lbWJlck1ldGhvZChhc3luY01ldGhvZE5hbWluZygncHJlcGFyZUVudGl0eURhdGFfJyksIFsgJ2NvbnRleHQnIF0sXG4gICAgICAgICAgICBTbmlwcGV0cy5fZG9WYWxpZGF0ZUFuZEZpbGxIZWFkZXIuY29uY2F0KG1ldGhvZEJvZHlWYWxpZGF0ZUFuZEZpbGwpLmNvbmNhdChbIEpzTGFuZy5hc3RSZXR1cm4oSnNMYW5nLmFzdElkKCdjb250ZXh0JykpIF0pLFxuICAgICAgICAgICAgZmFsc2UsIHRydWUsIHRydWVcbiAgICAgICAgKV0sICdjb21tZW50JykpO1xuICAgICAgICAqL1xuXG4gICAgICAgIHJldHVybiB7IGFzdDogSnNMYW5nLmFzdE1lbWJlck1ldGhvZChhc3luY01ldGhvZE5hbWluZygnYXBwbHlNb2RpZmllcnMnKSwgWyAnY29udGV4dCcsICdpc1VwZGF0aW5nJyBdLFxuICAgICAgICAgICAgU25pcHBldHMuX2FwcGx5TW9kaWZpZXJzSGVhZGVyLmNvbmNhdChtZXRob2RCb2R5VmFsaWRhdGVBbmRGaWxsKS5jb25jYXQoWyBKc0xhbmcuYXN0UmV0dXJuKEpzTGFuZy5hc3RJZCgnY29udGV4dCcpKSBdKSxcbiAgICAgICAgICAgIGZhbHNlLCB0cnVlLCB0cnVlLCAnQXBwbHlpbmcgcHJlZGVmaW5lZCBtb2RpZmllcnMgdG8gZW50aXR5IGZpZWxkcy4nXG4gICAgICAgICksIGZpZWxkUmVmZXJlbmNlcyB9O1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZUZ1bmN0aW9uVGVtcGxhdGVGaWxlKHNjaGVtYSwgeyBmdW5jdGlvbk5hbWUsIGZ1bmN0b3JUeXBlLCBmaWxlTmFtZSwgYXJncyB9KSB7XG4gICAgICAgIGxldCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShcbiAgICAgICAgICAgIHRoaXMub3V0cHV0UGF0aCxcbiAgICAgICAgICAgIHNjaGVtYS5uYW1lLFxuICAgICAgICAgICAgZmlsZU5hbWVcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIC8vdG9kbzogYW5hbHlzZSBjb2RlLCBjb21wYXJlIGFyZ3VtZW50c1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgYCR7IF8udXBwZXJGaXJzdChmdW5jdG9yVHlwZSkgfSBcIiR7ZmlsZU5hbWV9XCIgZXhpc3RzLiBGaWxlIGdlbmVyYXRpbmcgc2tpcHBlZC5gKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzdCA9IEpzTGFuZy5hc3RQcm9ncmFtKCk7XG4gICAgICAgIFxuICAgICAgICBKc0xhbmcuYXN0UHVzaEluQm9keShhc3QsIEpzTGFuZy5hc3RGdW5jdGlvbihmdW5jdGlvbk5hbWUsIGFyZ3MsIE9PTF9NT0RJRklFUl9SRVRVUk5bZnVuY3RvclR5cGVdKGFyZ3MpKSk7XG4gICAgICAgIEpzTGFuZy5hc3RQdXNoSW5Cb2R5KGFzdCwgSnNMYW5nLmFzdEFzc2lnbignbW9kdWxlLmV4cG9ydHMnLCBKc0xhbmcuYXN0VmFyUmVmKGZ1bmN0aW9uTmFtZSkpKTtcblxuICAgICAgICBmcy5lbnN1cmVGaWxlU3luYyhmaWxlUGF0aCk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIEpzTGFuZy5hc3RUb0NvZGUoYXN0KSk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGBHZW5lcmF0ZWQgJHsgZnVuY3RvclR5cGUgfSBmaWxlOiAke2ZpbGVQYXRofWApO1xuICAgIH1cblxuICAgIF9idWlsZEludGVyZmFjZXMoZW50aXR5LCBtb2RlbE1ldGFJbml0LCBzaGFyZWRDb250ZXh0KSB7XG4gICAgICAgIGxldCBhc3QgPSBbXTtcblxuICAgICAgICBfLmZvck93bihlbnRpdHkuaW50ZXJmYWNlcywgKG1ldGhvZCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnQnVpbGRpbmcgaW50ZXJmYWNlOiAnICsgbmFtZSk7XG5cbiAgICAgICAgICAgIGxldCBhc3RCb2R5ID0gW1xuICAgICAgICAgICAgICAgIEpzTGFuZy5hc3RWYXJEZWNsYXJlKCckbWV0YScsIEpzTGFuZy5hc3RWYXJSZWYoJ3RoaXMubWV0YS5pbnRlcmZhY2VzLicgKyBuYW1lKSwgdHJ1ZSwgZmFsc2UsICdSZXRyaWV2aW5nIHRoZSBtZXRhIGRhdGEnKVxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgbGV0IGNvbXBpbGVDb250ZXh0ID0gT29sVG9Bc3QuY3JlYXRlQ29tcGlsZUNvbnRleHQoZW50aXR5Lm9vbE1vZHVsZS5uYW1lLCB0aGlzLmxvZ2dlciwgc2hhcmVkQ29udGV4dCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBwYXJhbU1ldGE7XG5cbiAgICAgICAgICAgIGlmIChtZXRob2QuYWNjZXB0KSB7XG4gICAgICAgICAgICAgICAgcGFyYW1NZXRhID0gdGhpcy5fcHJvY2Vzc1BhcmFtcyhtZXRob2QuYWNjZXB0LCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vbWV0YWRhdGFcbiAgICAgICAgICAgIG1vZGVsTWV0YUluaXRbJ2ludGVyZmFjZXMnXSB8fCAobW9kZWxNZXRhSW5pdFsnaW50ZXJmYWNlcyddID0ge30pO1xuICAgICAgICAgICAgbW9kZWxNZXRhSW5pdFsnaW50ZXJmYWNlcyddW25hbWVdID0geyBwYXJhbXM6IE9iamVjdC52YWx1ZXMocGFyYW1NZXRhKSB9O1xuXG4gICAgICAgICAgICBfLmVhY2gobWV0aG9kLmltcGxlbWVudGF0aW9uLCAob3BlcmF0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vbGV0IGxhc3RUb3BvSWQgPSBcbiAgICAgICAgICAgICAgICBPb2xUb0FzdC5jb21waWxlRGJPcGVyYXRpb24oaW5kZXgsIG9wZXJhdGlvbiwgY29tcGlsZUNvbnRleHQsIGNvbXBpbGVDb250ZXh0Lm1haW5TdGFydElkKTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKG1ldGhvZC5yZXR1cm4pIHtcbiAgICAgICAgICAgICAgICBPb2xUb0FzdC5jb21waWxlRXhjZXB0aW9uYWxSZXR1cm4obWV0aG9kLnJldHVybiwgY29tcGlsZUNvbnRleHQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZGVwcyA9IGNvbXBpbGVDb250ZXh0LnRvcG9Tb3J0LnNvcnQoKTtcbiAgICAgICAgICAgIC8vdGhpcy5sb2dnZXIudmVyYm9zZSgnQWxsIGRlcGVuZGVuY2llczpcXG4nICsgSlNPTi5zdHJpbmdpZnkoZGVwcywgbnVsbCwgMikpO1xuXG4gICAgICAgICAgICBkZXBzID0gZGVwcy5maWx0ZXIoZGVwID0+IGNvbXBpbGVDb250ZXh0Lm1hcE9mVG9rZW5Ub01ldGEuaGFzKGRlcCkpO1xuICAgICAgICAgICAgLy90aGlzLmxvZ2dlci52ZXJib3NlKCdBbGwgbmVjZXNzYXJ5IHNvdXJjZSBjb2RlOlxcbicgKyBKU09OLnN0cmluZ2lmeShkZXBzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgIF8uZWFjaChkZXBzLCBkZXAgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzb3VyY2VNYXAgPSBjb21waWxlQ29udGV4dC5tYXBPZlRva2VuVG9NZXRhLmdldChkZXApO1xuICAgICAgICAgICAgICAgIGxldCBhc3RCbG9jayA9IGNvbXBpbGVDb250ZXh0LmFzdE1hcFtkZXBdO1xuXG4gICAgICAgICAgICAgICAgLy90aGlzLmxvZ2dlci52ZXJib3NlKCdDb2RlIHBvaW50IFwiJyArIGRlcCArICdcIjpcXG4nICsgSlNPTi5zdHJpbmdpZnkoc291cmNlTWFwLCBudWxsLCAyKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0RmllbGROYW1lID0gc291cmNlTWFwLnRhcmdldDsgLy9nZXRGaWVsZE5hbWUoc291cmNlTWFwLnRhcmdldCk7ICAgICAgXG5cbiAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLnR5cGUgPT09IE9vbFRvQXN0LkFTVF9CTEtfVkFMSURBVE9SX0NBTEwpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IFNuaXBwZXRzLl92YWxpZGF0ZUNoZWNrKHRhcmdldEZpZWxkTmFtZSwgYXN0QmxvY2spO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzb3VyY2VNYXAudHlwZSA9PT0gT29sVG9Bc3QuQVNUX0JMS19QUk9DRVNTT1JfQ0FMTCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwLm5lZWREZWNsYXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RWYXJEZWNsYXJlKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCksIGFzdEJsb2NrLCBmYWxzZSwgZmFsc2UsIGBQcm9jZXNzaW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXN0QmxvY2sgPSBKc0xhbmcuYXN0QXNzaWduKEpzTGFuZy5hc3RWYXJSZWYoc291cmNlTWFwLnRhcmdldCwgdHJ1ZSksIGFzdEJsb2NrLCBgUHJvY2Vzc2luZyBcIiR7dGFyZ2V0RmllbGROYW1lfVwiYCk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZU1hcC50eXBlID09PSBPb2xUb0FzdC5BU1RfQkxLX0FDVElWQVRPUl9DQUxMKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzb3VyY2VNYXAubmVlZERlY2xhcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzdEJsb2NrID0gSnNMYW5nLmFzdFZhckRlY2xhcmUoSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0KSwgYXN0QmxvY2ssIGZhbHNlLCBmYWxzZSwgYFByb2Nlc3NpbmcgXCIke3RhcmdldEZpZWxkTmFtZX1cImApOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhc3RCbG9jayA9IEpzTGFuZy5hc3RBc3NpZ24oSnNMYW5nLmFzdFZhclJlZihzb3VyY2VNYXAudGFyZ2V0LCB0cnVlKSwgYXN0QmxvY2ssIGBBY3RpdmF0aW5nIFwiJHt0YXJnZXRGaWVsZE5hbWV9XCJgKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBhc3RCb2R5ID0gYXN0Qm9keS5jb25jYXQoXy5jYXN0QXJyYXkoYXN0QmxvY2spKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhc3QucHVzaChKc0xhbmcuYXN0TWVtYmVyTWV0aG9kKGFzeW5jTWV0aG9kTmFtaW5nKG5hbWUpLCBPYmplY3Qua2V5cyhwYXJhbU1ldGEpLCBhc3RCb2R5LCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgcmVwbGFjZUFsbChfLmtlYmFiQ2FzZShuYW1lKSwgJy0nLCAnICcpKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhc3Q7XG4gICAgfTtcblxuICAgIF9wcm9jZXNzUGFyYW1zKGFjY2VwdFBhcmFtcywgY29tcGlsZUNvbnRleHQpIHtcbiAgICAgICAgbGV0IHBhcmFtTWV0YSA9IHt9O1xuXG4gICAgICAgIGFjY2VwdFBhcmFtcy5mb3JFYWNoKChwYXJhbSwgaSkgPT4ge1xuICAgICAgICAgICAgT29sVG9Bc3QuY29tcGlsZVBhcmFtKGksIHBhcmFtLCBjb21waWxlQ29udGV4dCk7XG4gICAgICAgICAgICBwYXJhbU1ldGFbcGFyYW0ubmFtZV0gPSBwYXJhbTtcbiAgICAgICAgICAgIGNvbXBpbGVDb250ZXh0LnZhcmlhYmxlc1twYXJhbS5uYW1lXSA9IHsgc291cmNlOiAnYXJndW1lbnQnIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwYXJhbU1ldGE7XG4gICAgfTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEYW9Nb2RlbGVyOyJdfQ==