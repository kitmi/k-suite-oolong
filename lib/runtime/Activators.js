"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  OolongUsageError
} = require('./Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc, options) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      return undefined;
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new OolongUsageError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new OolongUsageError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new OolongUsageError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      if (options && options.useCache) {
        remoteEntity = await model.db.model(assocMeta.entity).cached_(assocMeta.key, interAssoc ? [interAssoc] : null, context.connOptions)[assocValue];
      } else {
        let findOptions = {
          $query: {
            [assocMeta.key]: assocValue
          }
        };

        if (interAssoc) {
          findOptions.$associations = [interAssoc];
        }

        await model.ensureTransaction_(context);
        remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      }

      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new OolongUsageError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL0FjdGl2YXRvcnMuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJPb2xvbmdVc2FnZUVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsImRhdGV0aW1lQWRkIiwibW9kZWwiLCJjb250ZXh0Iiwic3RhcnRUaW1lIiwiZHVyYXRpb24iLCJwbHVzIiwiaXNFcXVhbCIsInZhbHVlMSIsInZhbHVlMiIsInRyaWdnZXJVcGRhdGUiLCJ2YWx1ZSIsImNvbmRpdGlvbiIsInN1bSIsImFyZ3MiLCJyZWR1Y2UiLCJ2IiwibXVsdGlwbHkiLCJtdWx0aXBsaWVyIiwibXVsdGlwbGljYW5kIiwicG9wdWxhdGUiLCJhc3NvYyIsIm9wdGlvbnMiLCJwYXJ0cyIsInNwbGl0IiwibGVuZ3RoIiwic2VsZWN0ZWRGaWVsZCIsInBvcCIsInJlbW90ZUFzc29jIiwiam9pbiIsImxvY2FsQXNzb2MiLCJzaGlmdCIsImludGVyQXNzb2MiLCJsYXRlc3QiLCJoYXNPd25Qcm9wZXJ0eSIsInVuZGVmaW5lZCIsImFzc29jVmFsdWUiLCJpc05pbCIsIm1ldGEiLCJuYW1lIiwiYXNzb2NNZXRhIiwiYXNzb2NpYXRpb25zIiwibGlzdCIsInJlbW90ZUVudGl0eSIsInBvcHVsYXRlZCIsInVzZUNhY2hlIiwiZGIiLCJlbnRpdHkiLCJjYWNoZWRfIiwia2V5IiwiY29ubk9wdGlvbnMiLCJmaW5kT3B0aW9ucyIsIiRxdWVyeSIsIiRhc3NvY2lhdGlvbnMiLCJlbnN1cmVUcmFuc2FjdGlvbl8iLCJmaW5kT25lXyIsImN1cnJlbnRBc3NvYyIsIm5leHRBc3NvYyIsIkFycmF5IiwiaXNBcnJheSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQXVCRCxPQUFPLENBQUMsVUFBRCxDQUFwQzs7QUFFQUUsTUFBTSxDQUFDQyxPQUFQ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QjtBQUNBWSxRQUFBQSxZQUFZLEdBQUdBLFlBQVksQ0FBQyxNQUFJYyxTQUFMLENBQTNCOztBQUZxQixhQUdiLENBQUNDLEtBQUssQ0FBQ0MsT0FBTixDQUFjaEIsWUFBZCxDQUhZO0FBQUE7QUFBQTs7QUFLckJhLFFBQUFBLFlBQVksR0FBR0EsWUFBWSxHQUFDLEdBQWIsR0FBaUJDLFNBQWhDO0FBQ0F0RCxRQUFBQSxPQUFPLENBQUN5QyxTQUFSLENBQWtCWSxZQUFsQixJQUFrQ2IsWUFBbEM7QUFDSDtBQUNKOztBQUVELFFBQUksQ0FBQ0EsWUFBWSxDQUFDVCxjQUFiLENBQTRCUixhQUE1QixDQUFMLEVBQWlEO0FBQzdDLFlBQU0sSUFBSTVCLGdCQUFKLENBQXNCLElBQUc0QixhQUFjLDJDQUEwQ0UsV0FBWSxnQkFBZTFCLEtBQUssQ0FBQ29DLElBQU4sQ0FBV0MsSUFBSyxJQUE1SCxDQUFOO0FBQ0g7O0FBRUQsV0FBT0ksWUFBWSxDQUFDakIsYUFBRCxDQUFuQjtBQUNIO0FBcEZZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgT29sb25nVXNhZ2VFcnJvciB9ID0gcmVxdWlyZSgnLi9FcnJvcnMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgZGF0ZXRpbWVBZGQ6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgc3RhcnRUaW1lLCBkdXJhdGlvbikge1xuICAgICAgICByZXR1cm4gc3RhcnRUaW1lLnBsdXMoZHVyYXRpb24pO1xuICAgIH0sXG5cbiAgICBpc0VxdWFsOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlMSwgdmFsdWUyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTEgPT09IHZhbHVlMjtcbiAgICB9LFxuXG4gICAgdHJpZ2dlclVwZGF0ZTogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZSwgY29uZGl0aW9uKSB7XG4gICAgICAgIHJldHVybiBjb25kaXRpb24gPyB2YWx1ZSA6IG51bGw7XG4gICAgfSxcblxuICAgIHN1bTogKG1vZGVsLCBjb250ZXh0LCAuLi5hcmdzKSA9PiBhcmdzLnJlZHVjZSgoc3VtLCB2KSA9PiBzdW0gKz0gdiwgMCksXG5cbiAgICBtdWx0aXBseTogKG1vZGVsLCBjb250ZXh0LCBtdWx0aXBsaWVyLCBtdWx0aXBsaWNhbmQpID0+IG11bHRpcGxpZXIqbXVsdGlwbGljYW5kLFxuXG4gICAgcG9wdWxhdGU6IGFzeW5jIChtb2RlbCwgY29udGV4dCwgYXNzb2MsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2Muc3BsaXQoJy4nKTtcbiAgICAgICAgYXNzZXJ0OiBwYXJ0cy5sZW5ndGggPiAxO1xuXG4gICAgICAgIGxldCBzZWxlY3RlZEZpZWxkID0gcGFydHMucG9wKCk7XG4gICAgICAgIGxldCByZW1vdGVBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgbGV0IGxvY2FsQXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICBsZXQgaW50ZXJBc3NvYztcbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpbnRlckFzc29jID0gcGFydHMuam9pbignLicpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIWNvbnRleHQubGF0ZXN0Lmhhc093blByb3BlcnR5KGxvY2FsQXNzb2MpKSB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFzc29jVmFsdWUgPSBjb250ZXh0LmxhdGVzdFtsb2NhbEFzc29jXTtcbiAgICAgICAgaWYgKF8uaXNOaWwoYXNzb2NWYWx1ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBUaGUgdmFsdWUgb2YgcmVmZXJlbmNlZCBhc3NvY2lhdGlvbiBcIiR7bG9jYWxBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIiBzaG91bGQgbm90IGJlIG51bGwuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXNzb2NNZXRhID0gbW9kZWwubWV0YS5hc3NvY2lhdGlvbnNbbG9jYWxBc3NvY107XG4gICAgICAgIGlmICghYXNzb2NNZXRhKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgXCIke2xvY2FsQXNzb2N9XCIgaXMgbm90IGFuIGFzc29jaWF0aW9uIGZpZWxkIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFzc29jTWV0YS5saXN0KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgXCIke2xvY2FsQXNzb2N9XCIgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIgaXMgYSBsaXN0LXN0eWxlIGFzc29jaWF0aW9uIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIGJ1aWx0LWluIHBvcHVsYXRlIEFjdGl2YXRvcnMuYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL2xvY2FsIGNhY2hlIGluIGNvbnRleHQsIHNoYXJlZCBieSBvdGhlciBmaWVsZHMgaWYgYW55IFxuICAgICAgICBsZXQgcmVtb3RlRW50aXR5ID0gY29udGV4dC5wb3B1bGF0ZWQgJiYgY29udGV4dC5wb3B1bGF0ZWRbcmVtb3RlQXNzb2NdO1xuICAgICAgICBpZiAoIXJlbW90ZUVudGl0eSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy51c2VDYWNoZSkge1xuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IGF3YWl0IG1vZGVsLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpLmNhY2hlZF8oYXNzb2NNZXRhLmtleSwgaW50ZXJBc3NvYyA/IFsgaW50ZXJBc3NvYyBdIDogbnVsbCwgY29udGV4dC5jb25uT3B0aW9ucylbYXNzb2NWYWx1ZV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBmaW5kT3B0aW9ucyA9IHsgJHF1ZXJ5OiB7IFthc3NvY01ldGEua2V5XTogYXNzb2NWYWx1ZSB9IH07XG5cbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJBc3NvYykge1xuICAgICAgICAgICAgICAgICAgICBmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb25zID0gWyBpbnRlckFzc29jIF07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXdhaXQgbW9kZWwuZW5zdXJlVHJhbnNhY3Rpb25fKGNvbnRleHQpO1xuXG4gICAgICAgICAgICAgICAgcmVtb3RlRW50aXR5ID0gYXdhaXQgbW9kZWwuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSkuZmluZE9uZV8oZmluZE9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZCB8fCAoY29udGV4dC5wb3B1bGF0ZWQgPSB7fSk7XG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtsb2NhbEFzc29jXSA9IHJlbW90ZUVudGl0eTtcblxuICAgICAgICAgICAgbGV0IGN1cnJlbnRBc3NvYyA9IGxvY2FsQXNzb2M7XG4gICAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0QXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IHJlbW90ZUVudGl0eVsnOicrbmV4dEFzc29jXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6ICFBcnJheS5pc0FycmF5KHJlbW90ZUVudGl0eSk7XG5cbiAgICAgICAgICAgICAgICBjdXJyZW50QXNzb2MgPSBjdXJyZW50QXNzb2MrJy4nK25leHRBc3NvYztcbiAgICAgICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtjdXJyZW50QXNzb2NdID0gcmVtb3RlRW50aXR5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcmVtb3RlRW50aXR5Lmhhc093blByb3BlcnR5KHNlbGVjdGVkRmllbGQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgXCIke3NlbGVjdGVkRmllbGR9XCIgaXMgbm90IGEgZmllbGQgb2YgcmVtb3RlIGFzc29jaWF0aW9uIFwiJHtyZW1vdGVBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZW1vdGVFbnRpdHlbc2VsZWN0ZWRGaWVsZF07XG4gICAgfVxufTsiXX0=