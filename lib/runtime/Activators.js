"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  OolongUsageError
} = require('./Errors');

module.exports = {
  datetimeAdd: function (model, context, startTime, duration) {
    return startTime.plus(duration);
  },
  isEqual: function (model, context, value1, value2) {
    return value1 === value2;
  },
  triggerUpdate: function (model, context, value, condition) {
    return condition ? value : null;
  },
  sum: (model, context, ...args) => args.reduce((sum, v) => sum += v, 0),
  multiply: (model, context, multiplier, multiplicand) => multiplier * multiplicand,
  populate: async (model, context, assoc) => {
    let parts = assoc.split('.');

    if (!(parts.length > 1)) {
      throw new Error("Assertion failed: parts.length > 1");
    }

    let selectedField = parts.pop();
    let remoteAssoc = parts.join('.');
    let localAssoc = parts.shift();
    let interAssoc;

    if (parts.length > 0) {
      interAssoc = parts.join('.');
    }

    if (!context.latest.hasOwnProperty(localAssoc)) {
      throw new OolongUsageError(`Referenced field "${localAssoc}" of entity "${model.meta.name}" not found in latest context.`);
    }

    let assocValue = context.latest[localAssoc];

    if (_.isNil(assocValue)) {
      throw new OolongUsageError(`The value of referenced association "${localAssoc}" of entity "${model.meta.name}" should not be null.`);
    }

    let assocMeta = model.meta.associations[localAssoc];

    if (!assocMeta) {
      throw new OolongUsageError(`"${localAssoc}" is not an association field of entity "${model.meta.name}".`);
    }

    if (assocMeta.list) {
      throw new OolongUsageError(`"${localAssoc}" entity "${model.meta.name}" is a list-style association which is not supported by the built-in populate Activators.`);
    }

    let remoteEntity = context.populated && context.populated[remoteAssoc];

    if (!remoteEntity) {
      let findOptions = {
        $query: {
          [assocMeta.key]: assocValue
        }
      };

      if (interAssoc) {
        findOptions.$associations = [interAssoc];
      }

      await model.ensureTransaction_(context);
      remoteEntity = await model.db.model(assocMeta.entity).findOne_(findOptions, context.connOptions);
      context.populated || (context.populated = {});
      context.populated[localAssoc] = remoteEntity;
      let currentAssoc = localAssoc;

      while (parts.length > 0) {
        let nextAssoc = parts.shift();
        remoteEntity = remoteEntity[':' + nextAssoc];

        if (!!Array.isArray(remoteEntity)) {
          throw new Error("Assertion failed: !Array.isArray(remoteEntity)");
        }

        currentAssoc = currentAssoc + '.' + nextAssoc;
        context.populated[currentAssoc] = remoteEntity;
      }
    }

    if (!remoteEntity.hasOwnProperty(selectedField)) {
      throw new OolongUsageError(`"${selectedField}" is not a field of remote association "${remoteAssoc}" of entity "${model.meta.name}".`);
    }

    return remoteEntity[selectedField];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL0FjdGl2YXRvcnMuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJPb2xvbmdVc2FnZUVycm9yIiwibW9kdWxlIiwiZXhwb3J0cyIsImRhdGV0aW1lQWRkIiwibW9kZWwiLCJjb250ZXh0Iiwic3RhcnRUaW1lIiwiZHVyYXRpb24iLCJwbHVzIiwiaXNFcXVhbCIsInZhbHVlMSIsInZhbHVlMiIsInRyaWdnZXJVcGRhdGUiLCJ2YWx1ZSIsImNvbmRpdGlvbiIsInN1bSIsImFyZ3MiLCJyZWR1Y2UiLCJ2IiwibXVsdGlwbHkiLCJtdWx0aXBsaWVyIiwibXVsdGlwbGljYW5kIiwicG9wdWxhdGUiLCJhc3NvYyIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJzZWxlY3RlZEZpZWxkIiwicG9wIiwicmVtb3RlQXNzb2MiLCJqb2luIiwibG9jYWxBc3NvYyIsInNoaWZ0IiwiaW50ZXJBc3NvYyIsImxhdGVzdCIsImhhc093blByb3BlcnR5IiwibWV0YSIsIm5hbWUiLCJhc3NvY1ZhbHVlIiwiaXNOaWwiLCJhc3NvY01ldGEiLCJhc3NvY2lhdGlvbnMiLCJsaXN0IiwicmVtb3RlRW50aXR5IiwicG9wdWxhdGVkIiwiZmluZE9wdGlvbnMiLCIkcXVlcnkiLCJrZXkiLCIkYXNzb2NpYXRpb25zIiwiZW5zdXJlVHJhbnNhY3Rpb25fIiwiZGIiLCJlbnRpdHkiLCJmaW5kT25lXyIsImNvbm5PcHRpb25zIiwiY3VycmVudEFzc29jIiwibmV4dEFzc29jIiwiQXJyYXkiLCJpc0FycmF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBdUJELE9BQU8sQ0FBQyxVQUFELENBQXBDOztBQUVBRSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYkMsRUFBQUEsV0FBVyxFQUFFLFVBQVVDLEtBQVYsRUFB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LENBQTRCUixhQUE1QixDQUFMLEVBQWlEO0FBQzdDLFlBQU0sSUFBSTNCLGdCQUFKLENBQXNCLElBQUcyQixhQUFjLDJDQUEwQ0UsV0FBWSxnQkFBZXpCLEtBQUssQ0FBQ2dDLElBQU4sQ0FBV0MsSUFBSyxJQUE1SCxDQUFOO0FBQ0g7O0FBRUQsV0FBT00sWUFBWSxDQUFDaEIsYUFBRCxDQUFuQjtBQUNIO0FBOUVZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgT29sb25nVXNhZ2VFcnJvciB9ID0gcmVxdWlyZSgnLi9FcnJvcnMnKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgZGF0ZXRpbWVBZGQ6IGZ1bmN0aW9uIChtb2RlbCwgY29udGV4dCwgc3RhcnRUaW1lLCBkdXJhdGlvbikge1xuICAgICAgICByZXR1cm4gc3RhcnRUaW1lLnBsdXMoZHVyYXRpb24pO1xuICAgIH0sXG5cbiAgICBpc0VxdWFsOiBmdW5jdGlvbiAobW9kZWwsIGNvbnRleHQsIHZhbHVlMSwgdmFsdWUyKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTEgPT09IHZhbHVlMjtcbiAgICB9LFxuXG4gICAgdHJpZ2dlclVwZGF0ZTogZnVuY3Rpb24gKG1vZGVsLCBjb250ZXh0LCB2YWx1ZSwgY29uZGl0aW9uKSB7XG4gICAgICAgIHJldHVybiBjb25kaXRpb24gPyB2YWx1ZSA6IG51bGw7XG4gICAgfSxcblxuICAgIHN1bTogKG1vZGVsLCBjb250ZXh0LCAuLi5hcmdzKSA9PiBhcmdzLnJlZHVjZSgoc3VtLCB2KSA9PiBzdW0gKz0gdiwgMCksXG5cbiAgICBtdWx0aXBseTogKG1vZGVsLCBjb250ZXh0LCBtdWx0aXBsaWVyLCBtdWx0aXBsaWNhbmQpID0+IG11bHRpcGxpZXIqbXVsdGlwbGljYW5kLFxuXG4gICAgcG9wdWxhdGU6IGFzeW5jIChtb2RlbCwgY29udGV4dCwgYXNzb2MpID0+IHtcbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2Muc3BsaXQoJy4nKTtcbiAgICAgICAgYXNzZXJ0OiBwYXJ0cy5sZW5ndGggPiAxO1xuXG4gICAgICAgIGxldCBzZWxlY3RlZEZpZWxkID0gcGFydHMucG9wKCk7XG4gICAgICAgIGxldCByZW1vdGVBc3NvYyA9IHBhcnRzLmpvaW4oJy4nKTtcbiAgICAgICAgbGV0IGxvY2FsQXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICBsZXQgaW50ZXJBc3NvYztcbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpbnRlckFzc29jID0gcGFydHMuam9pbignLicpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIWNvbnRleHQubGF0ZXN0Lmhhc093blByb3BlcnR5KGxvY2FsQXNzb2MpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgUmVmZXJlbmNlZCBmaWVsZCBcIiR7bG9jYWxBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIiBub3QgZm91bmQgaW4gbGF0ZXN0IGNvbnRleHQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXNzb2NWYWx1ZSA9IGNvbnRleHQubGF0ZXN0W2xvY2FsQXNzb2NdO1xuICAgICAgICBpZiAoXy5pc05pbChhc3NvY1ZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoYFRoZSB2YWx1ZSBvZiByZWZlcmVuY2VkIGFzc29jaWF0aW9uIFwiJHtsb2NhbEFzc29jfVwiIG9mIGVudGl0eSBcIiR7bW9kZWwubWV0YS5uYW1lfVwiIHNob3VsZCBub3QgYmUgbnVsbC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhc3NvY01ldGEgPSBtb2RlbC5tZXRhLmFzc29jaWF0aW9uc1tsb2NhbEFzc29jXTtcbiAgICAgICAgaWYgKCFhc3NvY01ldGEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBcIiR7bG9jYWxBc3NvY31cIiBpcyBub3QgYW4gYXNzb2NpYXRpb24gZmllbGQgb2YgZW50aXR5IFwiJHttb2RlbC5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXNzb2NNZXRhLmxpc3QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBcIiR7bG9jYWxBc3NvY31cIiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIiBpcyBhIGxpc3Qtc3R5bGUgYXNzb2NpYXRpb24gd2hpY2ggaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgYnVpbHQtaW4gcG9wdWxhdGUgQWN0aXZhdG9ycy5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCByZW1vdGVFbnRpdHkgPSBjb250ZXh0LnBvcHVsYXRlZCAmJiBjb250ZXh0LnBvcHVsYXRlZFtyZW1vdGVBc3NvY107XG4gICAgICAgIGlmICghcmVtb3RlRW50aXR5KSB7XG4gICAgICAgICAgICBsZXQgZmluZE9wdGlvbnMgPSB7ICRxdWVyeTogeyBbYXNzb2NNZXRhLmtleV06IGFzc29jVmFsdWUgfSB9O1xuXG4gICAgICAgICAgICBpZiAoaW50ZXJBc3NvYykge1xuICAgICAgICAgICAgICAgIGZpbmRPcHRpb25zLiRhc3NvY2lhdGlvbnMgPSBbIGludGVyQXNzb2MgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgbW9kZWwuZW5zdXJlVHJhbnNhY3Rpb25fKGNvbnRleHQpO1xuXG4gICAgICAgICAgICByZW1vdGVFbnRpdHkgPSBhd2FpdCBtb2RlbC5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KS5maW5kT25lXyhmaW5kT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZCB8fCAoY29udGV4dC5wb3B1bGF0ZWQgPSB7fSk7XG4gICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtsb2NhbEFzc29jXSA9IHJlbW90ZUVudGl0eTtcblxuICAgICAgICAgICAgbGV0IGN1cnJlbnRBc3NvYyA9IGxvY2FsQXNzb2M7XG4gICAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGxldCBuZXh0QXNzb2MgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgICAgIHJlbW90ZUVudGl0eSA9IHJlbW90ZUVudGl0eVsnOicrbmV4dEFzc29jXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6ICFBcnJheS5pc0FycmF5KHJlbW90ZUVudGl0eSk7XG5cbiAgICAgICAgICAgICAgICBjdXJyZW50QXNzb2MgPSBjdXJyZW50QXNzb2MrJy4nK25leHRBc3NvYztcbiAgICAgICAgICAgICAgICBjb250ZXh0LnBvcHVsYXRlZFtjdXJyZW50QXNzb2NdID0gcmVtb3RlRW50aXR5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcmVtb3RlRW50aXR5Lmhhc093blByb3BlcnR5KHNlbGVjdGVkRmllbGQpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcihgXCIke3NlbGVjdGVkRmllbGR9XCIgaXMgbm90IGEgZmllbGQgb2YgcmVtb3RlIGFzc29jaWF0aW9uIFwiJHtyZW1vdGVBc3NvY31cIiBvZiBlbnRpdHkgXCIke21vZGVsLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZW1vdGVFbnRpdHlbc2VsZWN0ZWRGaWVsZF07XG4gICAgfVxufTsiXX0=