"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util._;

const Errors = require('./Errors');

const Generators = require('./Generators');

const Types = require('./types');

const {
  DataValidationError,
  OolongUsageError,
  DsOperationError
} = Errors;

const Features = require('./entityFeatures');

const Rules = require('../enum/Rules');

const {
  isNothing
} = require('../utils/lang');

class EntityModel {
  constructor(rawData) {
    if (rawData) {
      Object.assign(this, rawData);
    }
  }

  get $pkValues() {
    return _.pick(this, _.castArray(this.constructor.meta.keyField));
  }

  static populate(data) {
    let ModelClass = this;
    return new ModelClass(data);
  }

  static getUniqueKeyFieldsFrom(data) {
    return _.find(this.meta.uniqueKeys, fields => _.every(fields, f => !_.isNil(data[f])));
  }

  static getUniqueKeyValuePairsFrom(data) {
    if (!_.isPlainObject(data)) {
      throw new Error("Function  precondition failed: _.isPlainObject(data)");
    }

    let ukFields = this.getUniqueKeyFieldsFrom(data);
    return _.pick(data, ukFields);
  }

  static async findOne_(findOptions, connOptions) {
    if (!findOptions) {
      throw new Error("Function  precondition failed: findOptions");
    }

    findOptions = this._prepareQueries(findOptions, true);
    let context = {
      findOptions,
      connOptions
    };
    await Features.applyRules_(Rules.RULE_BEFORE_FIND, this, context);

    if (findOptions.$association) {
      findOptions.$association = this._prepareAssociations(findOptions.$association);
    }

    return this._safeExecute_(async context => {
      let records = await this.db.connector.find_(this.meta.name, context.findOptions, context.connOptions);
      if (!records) throw new DsOperationError('connector.find_() returns undefined data record.');

      if (findOptions.$association) {
        if (records[0].length === 0) return undefined;
        records = this._mapRecordsToObjects(records, findOptions.$association);
      } else if (records.length === 0) {
        return undefined;
      }

      if (!(records.length === 1)) {
        throw new Error("Assertion failed: records.length === 1");
      }

      let result = records[0];
      if (context.findOptions.$unboxing) return result;
      return this.populate(result);
    }, context);
  }

  static async findAll_(findOptions, connOptions) {
    findOptions = this._prepareQueries(findOptions);
    let context = {
      findOptions,
      connOptions
    };
    await Features.applyRules_(Rules.RULE_BEFORE_FIND, this, context);

    if (findOptions.$association) {
      findOptions.$association = this._prepareAssociations(findOptions.$association);
    }

    return this._safeExecute_(async context => {
      let records = await this.db.connector.find_(this.meta.name, context.findOptions, context.connOptions);
      if (!records) throw new DsOperationError('connector.find_() returns undefined data record.');

      if (findOptions.$association) {
        records = this._mapRecordsToObjects(records, findOptions.$association);
      }

      if (context.findOptions.$unboxing) return records;
      return records.map(row => this.populate(row));
    }, context);
  }

  static async create_(data, createOptions, connOptions) {
    createOptions || (createOptions = {});

    let [raw, associations] = this._extractAssociations(data);

    let context = {
      raw,
      createOptions,
      connOptions
    };
    let needCreateAssocs = false;

    if (!_.isEmpty(associations)) {
      needCreateAssocs = true;
    }

    return this._safeExecute_(async context => {
      if (needCreateAssocs) {
        if (!context.connOptions || !context.connOptions.connection) {
          context.connOptions || (context.connOptions = {});
          context.connOptions.connection = await this.db.connector.beginTransaction_();
        }
      }

      await this._prepareEntityData_(context);
      await Features.applyRules_(Rules.RULE_BEFORE_CREATE, this, context);
      context.result = await this.db.connector.create_(this.meta.name, context.latest, context.connOptions);
      await this.afterCreate_(context);

      if (needCreateAssocs) {
        await this._createAssocs_(context, associations);
      }

      return createOptions.$unboxing ? context.latest : this.populate(context.latest);
    }, context);
  }

  static async update_(data, updateOptions, connOptions) {
    if (updateOptions && updateOptions.$byPassReadOnly) {
      throw new OolongUsageError('Unexpected usage.', {
        entity: this.meta.name,
        reason: '$byPassReadOnly option is not allow to be set from public update_ method.',
        updateOptions
      });
    }

    return this._update_(data, updateOptions, connOptions);
  }

  static async _update_(data, updateOptions, connOptions) {
    if (!updateOptions) {
      let conditionFields = this.getUniqueKeyFieldsFrom(data);

      if (_.isEmpty(conditionFields)) {
        throw new OolongUsageError('Primary key value(s) or at least one group of unique key value(s) is required for updating an entity.');
      }

      updateOptions = {
        $query: _.pick(data, conditionFields)
      };
      data = _.omit(data, conditionFields);
    }

    updateOptions = this._prepareQueries(updateOptions, true);
    let context = {
      raw: data,
      updateOptions,
      connOptions
    };
    return this._safeExecute_(async context => {
      await this._prepareEntityData_(context, true);
      await Features.applyRules_(Rules.RULE_BEFORE_UPDATE, this, context);
      context.result = await this.db.connector.update_(this.meta.name, context.latest, context.updateOptions.$query, context.connOptions);
      await this.afterUpdate_(context);
      return updateOptions.$unboxing ? context.latest : this.populate(context.latest);
    }, context);
  }

  static async delete_(deleteOptions, connOptions) {
    if (!deleteOptions) {
      throw new Error("Function  precondition failed: deleteOptions");
    }

    deleteOptions = this._prepareQueries(deleteOptions, true);

    if (_.isEmpty(deleteOptions.$query)) {
      throw new OolongUsageError('Empty condition is not allowed for deleting an entity.');
    }

    if (this.meta.features.logicalDeletion && !deleteOptions.$physicalDeletion) {
      let {
        field,
        value
      } = this.meta.features.logicalDeletion;
      return this._update_({
        [field]: value
      }, {
        $query: deleteOptions.$query,
        $retrieveUpdated: deleteOptions.$retrieveDeleted,
        $unboxing: deleteOptions.$unboxing,
        $byPassReadOnly: new Set([field])
      });
    }

    let context = {
      deleteOptions,
      connOptions
    };
    return this._safeExecute_(async context => {
      await this.beforeDelete_(context);
      context.result = await this.db.connector.delete_(this.meta.name, context.deleteOptions.$query, context.connOptions);
      return deleteOptions.$unboxing ? context.existing : this.populate(context.existing);
    }, context);
  }

  static _containsUniqueKey(data) {
    return _.find(this.meta.uniqueKeys, fields => _.every(fields, f => !_.isNil(data[f])));
  }

  static _ensureContainsUniqueKey(condition) {
    let containsUniqueKey = this._containsUniqueKey(condition);

    if (!containsUniqueKey) {
      throw new OolongUsageError('Unexpected usage.', {
        entity: this.meta.name,
        reason: 'Single record operation requires condition to be containing unique key.',
        condition
      });
    }
  }

  static async _prepareEntityData_(context, isUpdating = false) {
    let meta = this.meta;
    let i18n = this.i18n;
    let {
      name,
      fields
    } = meta;
    let {
      raw
    } = context;
    let latest = {},
        existing;
    context.latest = latest;

    if (!context.i18n) {
      context.i18n = i18n;
    }

    if (isUpdating && this._dependsOnExistingData(raw)) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      existing = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
      context.existing = existing;
    }

    await Util.eachAsync_(fields, async (fieldInfo, fieldName) => {
      if (fieldName in raw) {
        if (fieldInfo.readOnly) {
          if (!isUpdating || !context.updateOptions.$byPassReadOnly.has(fieldName)) {
            throw new DataValidationError(`Read-only field "${fieldName}" is not allowed to be set by manual input.`, {
              entity: name,
              fieldInfo: fieldInfo
            });
          }
        }

        if (isUpdating && fieldInfo.freezeAfterNonDefault) {
          if (!existing) {
            throw new Error('"freezeAfterNonDefault" qualifier requires existing data.');
          }

          if (existing[fieldName] !== fieldInfo.default) {
            throw new DataValidationError(`FreezeAfterNonDefault field "${fieldName}" is not allowed to be changed.`, {
              entity: name,
              fieldInfo: fieldInfo
            });
          }
        }

        if (isUpdating && fieldInfo.writeOnce) {
          if (!existing) {
            throw new Error('"writeOnce" qualifier requires existing data.');
          }

          if (!_.isNil(existing[fieldName])) {
            throw new DataValidationError(`Write-once field "${fieldName}" is not allowed to be update once it was set.`, {
              entity: name,
              fieldInfo: fieldInfo
            });
          }
        }

        if (isNothing(raw[fieldName])) {
          if (!fieldInfo.optional) {
            throw new DataValidationError(`The "${fieldName}" value of "${name}" entity cannot be null.`, {
              entity: name,
              fieldInfo: fieldInfo
            });
          }

          latest[fieldName] = null;
        } else {
          latest[fieldName] = Types.sanitize(raw[fieldName], fieldInfo, i18n);
        }

        return;
      }

      if (isUpdating) {
        if (fieldInfo.forceUpdate) {
          if (fieldInfo.updateByDb) {
            return;
          }

          if (fieldInfo.auto) {
            latest[fieldName] = await Generators.default(fieldInfo, i18n);
            return;
          }

          throw new DataValidationError(`"${fieldName}" of "${name}" enttiy is required for each update.`, {
            entity: name,
            fieldInfo: fieldInfo
          });
        }

        return;
      }

      if (!fieldInfo.createByDb) {
        if (fieldInfo.hasOwnProperty('default')) {
          latest[fieldName] = fieldInfo.default;
        } else if (fieldInfo.optional) {
          return;
        } else if (fieldInfo.auto) {
          latest[fieldName] = await Generators.default(fieldInfo, i18n);
        } else {
          throw new DataValidationError(`"${fieldName}" of "${name}" entity is required.`, {
            entity: name,
            fieldInfo: fieldInfo
          });
        }
      }
    });
    await Features.applyRules_(Rules.RULE_AFTER_VALIDATION, this, context);
    await this.applyModifiers_(context, isUpdating);
    this.serialize(context.latest);
    return context;
  }

  static async _safeExecute_(executor, context) {
    executor = executor.bind(this);

    if (context.connOptions && context.connOptions.connection) {
      return executor(context);
    }

    try {
      let result = await executor(context);
      context.connOptions && context.connOptions.connection && (await this.db.connector.commit_(context.connOptions.connection));
      return result;
    } catch (error) {
      context.connOptions && context.connOptions.connection && (await this.db.connector.rollback_(context.connOptions.connection));
      throw error;
    }
  }

  static _dependsOnExistingData(input) {
    let deps = this.meta.fieldDependencies;
    let hasDepends = false;

    if (deps) {
      hasDepends = _.find(deps, (dep, fieldName) => {
        if (fieldName in input) {
          return _.find(dep, d => {
            let [stage, field] = d.split('.');
            return (stage === 'latest' || stage === 'existng') && _.isNil(input[field]);
          });
        }

        return false;
      });

      if (hasDepends) {
        return true;
      }
    }

    let atLeastOneNotNull = this.meta.features.atLeastOneNotNull;

    if (atLeastOneNotNull) {
      hasDepends = _.find(atLeastOneNotNull, fields => _.find(fields, field => field in input && _.isNil(input[field])));

      if (hasDepends) {
        return true;
      }
    }

    return false;
  }

  static _hasReservedKeys(obj) {
    return _.find(obj, (v, k) => k[0] === '$');
  }

  static _prepareQueries(options, forSingleRecord = false) {
    if (options && !options.$query && !this._hasReservedKeys(options)) {
      options = {
        $query: options
      };
    }

    if (forSingleRecord) {
      if (!_.isPlainObject(options.$query)) {
        if (Array.isArray(this.meta.keyField)) {
          throw new OolongUsageError('Cannot use a singular value as condition to query against a entity with combined primary key.');
        }

        options.$query = {
          [this.meta.keyField]: options.$query
        };
      } else {
        this._ensureContainsUniqueKey(options.$query);
      }
    }

    return options || {};
  }

  static _prepareAssociations() {
    throw new Error('Should be override by driver-specific subclass.');
  }

  static _mapRecordsToObjects() {
    throw new Error('Should be override by driver-specific subclass.');
  }

  static _extractAssociations(data) {
    throw new Error('Should be override by driver-specific subclass.');
  }

  static async _createAssocs_(context, assocs) {
    throw new Error('Should be override by driver-specific subclass.');
  }

}

module.exports = EntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL0VudGl0eU1vZGVsLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsIkVycm9ycyIsIkdlbmVyYXRvcnMiLCJUeXBlcyIsIkRhdGFWYWxpZGF0aW9uRXJyb3IiLCJPb2xvbmdVc2FnZUVycm9yIiwiRHNPcGVyYXRpb25FcnJvciIsIkZlYXR1cmVzIiwiUnVsZXMiLCJpc05vdGhpbmciLCJFbnRpdHlNb2RlbCIsImNvbnN0cnVjdG9yIiwicmF3RGF0YSIsIk9iamVjdCIsImFzc2lnbiIsIiRwa1ZhbHVlcyIsInBpY2siLCJjYXN0QXJyYXkiLCJtZXRhIiwia2V5RmllbGQiLCJwb3B1bGF0ZSIsImRhdGEiLCJNb2RlbENsYXNzIiwiZ2V0VW5pcXVlS2V5RmllbGRzRnJvbSIsImZpbmQiLCJ1bmlxdWVLZXlzIiwiZmllbGRzIiwiZXZlcnkiLCJmIiwiaXNOaWwiLCJnZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbSIsImlzUGxhaW5PYmplY3QiLCJ1a0ZpZWxkcyIsImZpbmRPbmVfIiwiZmluZE9wdGlvbnMiLCJjb25uT3B0aW9ucyIsIl9wcmVwYXJlUXVlcmllcyIsImNvbnRleHQiLCJhcHBseVJ1bGVzXyIsIlJVTEVfQkVGT1JFX0ZJTkQiLCIkYXNzb2NpYXRpb24iLCJfcHJlcGFyZUFzc29jaWF0aW9ucyIsIl9zYWZlRXhlY3V0ZV8iLCJyZWNvcmRzIiwiZGIiLCJjb25uZWN0b3IiLCJmaW5kXyIsIm5hbWUiLCJsZW5ndGgiLCJ1bmRlZmluZWQiLCJfbWFwUmVjb3Jkc1RvT2JqZWN0cyIsInJlc3VsdCIsIiR1bmJveGluZyIsImZpbmRBbGxfIiwibWFwIiwicm93IiwiY3JlYXRlXyIsImNyZWF0ZU9wdGlvbnMiLCJyYXciLCJhc3NvY2lhdGlvbnMiLCJfZXh0cmFjdEFzc29jaWF0aW9ucyIsIm5lZWRDcmVhdGVBc3NvY3MiLCJpc0VtcHR5IiwiY29ubmVjdGlvbiIsImJlZ2luVHJhbnNhY3Rpb25fIiwiX3ByZXBhcmVFbnRpdHlEYXRhXyIsIlJVTEVfQkVGT1JFX0NSRUFURSIsImxhdGVzdCIsImFmdGVyQ3JlYXRlXyIsIl9jcmVhdGVBc3NvY3NfIiwidXBkYXRlXyIsInVwZGF0ZU9wdGlvbnMiLCIkYnlQYXNzUmVhZE9ubHkiLCJlbnRpdHkiLCJyZWFzb24iLCJfdXBkYXRlXyIsImNvbmRpdGlvbkZpZWxkcyIsIiRxdWVyeSIsIm9taXQiLCJSVUxFX0JFRk9SRV9VUERBVEUiLCJhZnRlclVwZGF0ZV8iLCJkZWxldGVfIiwiZGVsZXRlT3B0aW9ucyIsImZlYXR1cmVzIiwibG9naWNhbERlbGV0aW9uIiwiJHBoeXNpY2FsRGVsZXRpb24iLCJmaWVsZCIsInZhbHVlIiwiJHJldHJpZXZlVXBkYXRlZCIsIiRyZXRyaWV2ZURlbGV0ZWQiLCJTZXQiLCJiZWZvcmVEZWxldGVfIiwiZXhpc3RpbmciLCJfY29udGFpbnNVbmlxdWVLZXkiLCJfZW5zdXJlQ29udGFpbnNVbmlxdWVLZXkiLCJjb25kaXRpb24iLCJjb250YWluc1VuaXF1ZUtleSIsImlzVXBkYXRpbmciLCJpMThuIiwiX2RlcGVuZHNPbkV4aXN0aW5nRGF0YSIsImVhY2hBc3luY18iLCJmaWVsZEluZm8iLCJmaWVsZE5hbWUiLCJyZWFkT25seSIsImhhcyIsImZyZWV6ZUFmdGVyTm9uRGVmYXVsdCIsImRlZmF1bHQiLCJ3cml0ZU9uY2UiLCJvcHRpb25hbCIsInNhbml0aXplIiwiZm9yY2VVcGRhdGUiLCJ1cGRhdGVCeURiIiwiYXV0byIsImNyZWF0ZUJ5RGIiLCJoYXNPd25Qcm9wZXJ0eSIsIlJVTEVfQUZURVJfVkFMSURBVElPTiIsImFwcGx5TW9kaWZpZXJzXyIsInNlcmlhbGl6ZSIsImV4ZWN1dG9yIiwiYmluZCIsImNvbW1pdF8iLCJlcnJvciIsInJvbGxiYWNrXyIsImlucHV0IiwiZGVwcyIsImZpZWxkRGVwZW5kZW5jaWVzIiwiaGFzRGVwZW5kcyIsImRlcCIsImQiLCJzdGFnZSIsInNwbGl0IiwiYXRMZWFzdE9uZU5vdE51bGwiLCJfaGFzUmVzZXJ2ZWRLZXlzIiwib2JqIiwidiIsImsiLCJvcHRpb25zIiwiZm9yU2luZ2xlUmVjb3JkIiwiQXJyYXkiLCJpc0FycmF5IiwiRXJyb3IiLCJhc3NvY3MiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQVFGLElBQUksQ0FBQ0UsQ0FBbkI7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUF0Qjs7QUFDQSxNQUFNRyxVQUFVLEdBQUdILE9BQU8sQ0FBQyxjQUFELENBQTFCOztBQUNBLE1BQU1JLEtBQUssR0FBR0osT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFSyxFQUFBQSxtQkFBRjtBQUF1QkMsRUFBQUEsZ0JBQXZCO0FBQXlDQyxFQUFBQTtBQUF6QyxJQUE4REwsTUFBcEU7O0FBQ0EsTUFBTU0sUUFBUSxHQUFHUixPQUFPLENBQUMsa0JBQUQsQ0FBeEI7O0FBQ0EsTUFBTVMsS0FBSyxHQUFHVCxPQUFPLENBQUMsZUFBRCxDQUFyQjs7QUFFQSxNQUFNO0FBQUVVLEVBQUFBO0FBQUYsSUFBZ0JWLE9BQU8sQ0FBQyxlQUFELENBQTdCOztBQU1BLE1BQU1XLFdBQU4sQ0FBa0I7QUFJZEMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVU7QUFDakIsUUFBSUEsT0FBSixFQUFhO0FBRVRDLE1BQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLElBQWQsRUFBb0JGLE9BQXBCO0FBQ0g7QUFDSjs7QUFLRCxNQUFJRyxTQUFKLEdBQWdCO0FBQ1osV0FBT2YsQ0FBQyxDQUFDZ0IsSUFBRixDQUFPLElBQVAsRUFBYWhCLENBQUMsQ0FBQ2lCLFNBQUYsQ0FBWSxLQUFLTixXQUFMLENBQWlCTyxJQUFqQixDQUFzQkMsUUFBbEMsQ0FBYixDQUFQO0FBQ0g7O0FBT0QsU0FBT0MsUUFBUCxDQUFnQkMsSUFBaEIsRUFBc0I7QUFDbEIs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Q2xDLFlBQUk2RCxLQUFLLENBQUNDLE9BQU4sQ0FBYyxLQUFLekgsSUFBTCxDQUFVQyxRQUF4QixDQUFKLEVBQXVDO0FBQ25DLGdCQUFNLElBQUlkLGdCQUFKLENBQXFCLCtGQUFyQixDQUFOO0FBQ0g7O0FBRURtSSxRQUFBQSxPQUFPLENBQUMzRCxNQUFSLEdBQWlCO0FBQUUsV0FBQyxLQUFLM0QsSUFBTCxDQUFVQyxRQUFYLEdBQXNCcUgsT0FBTyxDQUFDM0Q7QUFBaEMsU0FBakI7QUFDSCxPQU5ELE1BTU87QUFDSCxhQUFLaUIsd0JBQUwsQ0FBOEIwQyxPQUFPLENBQUMzRCxNQUF0QztBQUNIO0FBQ0o7O0FBRUQsV0FBTzJELE9BQU8sSUFBSSxFQUFsQjtBQUNIOztBQUVELFNBQU8vRixvQkFBUCxHQUE4QjtBQUMxQixVQUFNLElBQUltRyxLQUFKLENBQVUsaURBQVYsQ0FBTjtBQUNIOztBQUVELFNBQU8xRixvQkFBUCxHQUE4QjtBQUMxQixVQUFNLElBQUkwRixLQUFKLENBQVUsaURBQVYsQ0FBTjtBQUNIOztBQUVELFNBQU9oRixvQkFBUCxDQUE0QnZDLElBQTVCLEVBQWtDO0FBQzlCLFVBQU0sSUFBSXVILEtBQUosQ0FBVSxpREFBVixDQUFOO0FBQ0g7O0FBRUQsZUFBYXZFLGNBQWIsQ0FBNEJoQyxPQUE1QixFQUFxQ3dHLE1BQXJDLEVBQTZDO0FBQ3pDLFVBQU0sSUFBSUQsS0FBSixDQUFVLGlEQUFWLENBQU47QUFDSDs7QUFua0JhOztBQXNrQmxCRSxNQUFNLENBQUNDLE9BQVAsR0FBaUJySSxXQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXyB9ID0gVXRpbC5fO1xuY29uc3QgRXJyb3JzID0gcmVxdWlyZSgnLi9FcnJvcnMnKTtcbmNvbnN0IEdlbmVyYXRvcnMgPSByZXF1aXJlKCcuL0dlbmVyYXRvcnMnKTtcbmNvbnN0IFR5cGVzID0gcmVxdWlyZSgnLi90eXBlcycpO1xuY29uc3QgeyBEYXRhVmFsaWRhdGlvbkVycm9yLCBPb2xvbmdVc2FnZUVycm9yLCBEc09wZXJhdGlvbkVycm9yIH0gPSBFcnJvcnM7XG5jb25zdCBGZWF0dXJlcyA9IHJlcXVpcmUoJy4vZW50aXR5RmVhdHVyZXMnKTtcbmNvbnN0IFJ1bGVzID0gcmVxdWlyZSgnLi4vZW51bS9SdWxlcycpO1xuXG5jb25zdCB7IGlzTm90aGluZyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuXG4vKipcbiAqIEJhc2UgZW50aXR5IG1vZGVsIGNsYXNzLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIEVudGl0eU1vZGVsIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbcmF3RGF0YV0gLSBSYXcgZGF0YSBvYmplY3QgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IocmF3RGF0YSkge1xuICAgICAgICBpZiAocmF3RGF0YSkge1xuICAgICAgICAgICAgLy9vbmx5IHBpY2sgdGhvc2UgdGhhdCBhcmUgZmllbGRzIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIHJhd0RhdGEpO1xuICAgICAgICB9IFxuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBHZXQgYW4gb2JqZWN0IG9mIHRoZSBwcmltYXJ5IGtleSB2YWx1ZXMuXG4gICAgICovXG4gICAgZ2V0ICRwa1ZhbHVlcygpIHtcbiAgICAgICAgcmV0dXJuIF8ucGljayh0aGlzLCBfLmNhc3RBcnJheSh0aGlzLmNvbnN0cnVjdG9yLm1ldGEua2V5RmllbGQpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3B1bGF0ZSBkYXRhIGZyb20gZGF0YWJhc2UuXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEByZXR1cm4ge0VudGl0eU1vZGVsfVxuICAgICAqL1xuICAgIHN0YXRpYyBwb3B1bGF0ZShkYXRhKSB7XG4gICAgICAgIGxldCBNb2RlbENsYXNzID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBNb2RlbENsYXNzKGRhdGEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBmaWVsZCBuYW1lcyBhcnJheSBvZiBhIHVuaXF1ZSBrZXkgZnJvbSBpbnB1dCBkYXRhLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gSW5wdXQgZGF0YS5cbiAgICAgKi9cbiAgICBzdGF0aWMgZ2V0VW5pcXVlS2V5RmllbGRzRnJvbShkYXRhKSB7XG4gICAgICAgIHJldHVybiBfLmZpbmQodGhpcy5tZXRhLnVuaXF1ZUtleXMsIGZpZWxkcyA9PiBfLmV2ZXJ5KGZpZWxkcywgZiA9PiAhXy5pc05pbChkYXRhW2ZdKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBrZXktdmFsdWUgcGFpcnMgb2YgYSB1bmlxdWUga2V5IGZyb20gaW5wdXQgZGF0YS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIElucHV0IGRhdGEuXG4gICAgICovXG4gICAgc3RhdGljIGdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tKGRhdGEpIHsgIFxuICAgICAgICBwcmU6IF8uaXNQbGFpbk9iamVjdChkYXRhKTsgICAgXG4gICAgICAgIFxuICAgICAgICBsZXQgdWtGaWVsZHMgPSB0aGlzLmdldFVuaXF1ZUtleUZpZWxkc0Zyb20oZGF0YSk7XG4gICAgICAgIHJldHVybiBfLnBpY2soZGF0YSwgdWtGaWVsZHMpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBGaW5kIG9uZSByZWNvcmQsIHJldHVybnMgYSBtb2RlbCBvYmplY3QgY29udGFpbmluZyB0aGUgcmVjb3JkIG9yIHVuZGVmaW5lZCBpZiBub3RoaW5nIGZvdW5kLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fGFycmF5fSBjb25kaXRpb24gLSBRdWVyeSBjb25kaXRpb24sIGtleS12YWx1ZSBwYWlyIHdpbGwgYmUgam9pbmVkIHdpdGggJ0FORCcsIGFycmF5IGVsZW1lbnQgd2lsbCBiZSBqb2luZWQgd2l0aCAnT1InLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbZmluZE9wdGlvbnNdIC0gZmluZE9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uXSAtIEpvaW5pbmdzXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtmaW5kT3B0aW9ucy4kcHJvamVjdGlvbl0gLSBTZWxlY3RlZCBmaWVsZHNcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2ZpbmRPcHRpb25zLiRxdWVyeV0gLSBFeHRyYSBjb25kaXRpb25cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2ZpbmRPcHRpb25zLiRncm91cEJ5XSAtIEdyb3VwIGJ5IGZpZWxkc1xuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbZmluZE9wdGlvbnMuJG9yZGVyQnldIC0gT3JkZXIgYnkgZmllbGRzXG4gICAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtmaW5kT3B0aW9ucy4kb2Zmc2V0XSAtIE9mZnNldFxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbZmluZE9wdGlvbnMuJGxpbWl0XSAtIExpbWl0ICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtmaW5kT3B0aW9ucy4kdW5ib3hpbmc9ZmFsc2VdIC0gV2hlbiBmZXRjaEFycmF5ID0gdHJ1ZSwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGRpcmVjdGx5IHdpdGhvdXQgY3JlYXRpbmcgbW9kZWwgb2JqZWN0cy5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtmaW5kT3B0aW9ucy4kaW5jbHVkZURlbGV0ZWQ9ZmFsc2VdIC0gSW5jbHVkZSB0aG9zZSBtYXJrZWQgYXMgbG9naWNhbCBkZWxldGVkLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY29ubk9wdGlvbnNdXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb25uT3B0aW9ucy5jb25uZWN0aW9uXVxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBmaW5kT25lXyhmaW5kT3B0aW9ucywgY29ubk9wdGlvbnMpIHsgXG4gICAgICAgIHByZTogZmluZE9wdGlvbnM7XG5cbiAgICAgICAgZmluZE9wdGlvbnMgPSB0aGlzLl9wcmVwYXJlUXVlcmllcyhmaW5kT3B0aW9ucywgdHJ1ZSAvKiBmb3Igc2luZ2xlIHJlY29yZCAqLyk7XG4gICAgICAgIFxuICAgICAgICBsZXQgY29udGV4dCA9IHsgICAgICAgICAgICAgXG4gICAgICAgICAgICBmaW5kT3B0aW9ucyxcbiAgICAgICAgICAgIGNvbm5PcHRpb25zXG4gICAgICAgIH07IFxuXG4gICAgICAgIGF3YWl0IEZlYXR1cmVzLmFwcGx5UnVsZXNfKFJ1bGVzLlJVTEVfQkVGT1JFX0ZJTkQsIHRoaXMsIGNvbnRleHQpOyAgXG5cbiAgICAgICAgaWYgKGZpbmRPcHRpb25zLiRhc3NvY2lhdGlvbikge1xuICAgICAgICAgICAgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uID0gdGhpcy5fcHJlcGFyZUFzc29jaWF0aW9ucyhmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3NhZmVFeGVjdXRlXyhhc3luYyAoY29udGV4dCkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJlY29yZHMgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5maW5kXyhcbiAgICAgICAgICAgICAgICB0aGlzLm1ldGEubmFtZSwgXG4gICAgICAgICAgICAgICAgY29udGV4dC5maW5kT3B0aW9ucywgXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9uc1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmICghcmVjb3JkcykgdGhyb3cgbmV3IERzT3BlcmF0aW9uRXJyb3IoJ2Nvbm5lY3Rvci5maW5kXygpIHJldHVybnMgdW5kZWZpbmVkIGRhdGEgcmVjb3JkLicpO1xuXG4gICAgICAgICAgICBpZiAoZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKSB7ICBcbiAgICAgICAgICAgICAgICAvL3Jvd3MsIGNvbG91bW5zLCBhbGlhc01hcCAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHJlY29yZHNbMF0ubGVuZ3RoID09PSAwKSByZXR1cm4gdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICAgICAgcmVjb3JkcyA9IHRoaXMuX21hcFJlY29yZHNUb09iamVjdHMocmVjb3JkcywgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVjb3Jkcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhc3NlcnQ6IHJlY29yZHMubGVuZ3RoID09PSAxO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHJlY29yZHNbMF07XG5cbiAgICAgICAgICAgIGlmIChjb250ZXh0LmZpbmRPcHRpb25zLiR1bmJveGluZykgcmV0dXJuIHJlc3VsdDtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9wdWxhdGUocmVzdWx0KTtcbiAgICAgICAgfSwgY29udGV4dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCByZWNvcmRzIG1hdGNoaW5nIHRoZSBjb25kaXRpb24sIHJldHVybnMgYW4gYXJyYXkgb2YgbW9kZWwgb2JqZWN0IG9yIGFuIGFycmF5IG9mIHJlY29yZHMgZGlyZWN0bHkgaWYgJHVuYm94aW5nID0gdHJ1ZS4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbZmluZE9wdGlvbnNdIC0gZmluZE9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uXSAtIEpvaW5pbmdzXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtmaW5kT3B0aW9ucy4kcHJvamVjdGlvbl0gLSBTZWxlY3RlZCBmaWVsZHNcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2ZpbmRPcHRpb25zLiRxdWVyeV0gLSBFeHRyYSBjb25kaXRpb25cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2ZpbmRPcHRpb25zLiRncm91cEJ5XSAtIEdyb3VwIGJ5IGZpZWxkc1xuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbZmluZE9wdGlvbnMuJG9yZGVyQnldIC0gT3JkZXIgYnkgZmllbGRzXG4gICAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtmaW5kT3B0aW9ucy4kb2Zmc2V0XSAtIE9mZnNldFxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbZmluZE9wdGlvbnMuJGxpbWl0XSAtIExpbWl0ICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtmaW5kT3B0aW9ucy4kdW5ib3hpbmc9ZmFsc2VdIC0gV2hlbiBmZXRjaEFycmF5ID0gdHJ1ZSwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGRpcmVjdGx5IHdpdGhvdXQgY3JlYXRpbmcgbW9kZWwgb2JqZWN0cy5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtmaW5kT3B0aW9ucy4kaW5jbHVkZURlbGV0ZWQ9ZmFsc2VdIC0gSW5jbHVkZSB0aG9zZSBtYXJrZWQgYXMgbG9naWNhbCBkZWxldGVkLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY29ubk9wdGlvbnNdXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb25uT3B0aW9ucy5jb25uZWN0aW9uXVxuICAgICAqIEByZXR1cm5zIHthcnJheX1cbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgZmluZEFsbF8oZmluZE9wdGlvbnMsIGNvbm5PcHRpb25zKSB7XG4gICAgICAgIGZpbmRPcHRpb25zID0gdGhpcy5fcHJlcGFyZVF1ZXJpZXMoZmluZE9wdGlvbnMpO1xuXG4gICAgICAgIGxldCBjb250ZXh0ID0geyAgICAgICAgICAgICBcbiAgICAgICAgICAgIGZpbmRPcHRpb25zLFxuICAgICAgICAgICAgY29ubk9wdGlvbnNcbiAgICAgICAgfTsgXG5cbiAgICAgICAgYXdhaXQgRmVhdHVyZXMuYXBwbHlSdWxlc18oUnVsZXMuUlVMRV9CRUZPUkVfRklORCwgdGhpcywgY29udGV4dCk7ICBcblxuICAgICAgICBpZiAoZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKSB7XG4gICAgICAgICAgICBmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb24gPSB0aGlzLl9wcmVwYXJlQXNzb2NpYXRpb25zKGZpbmRPcHRpb25zLiRhc3NvY2lhdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fc2FmZUV4ZWN1dGVfKGFzeW5jIChjb250ZXh0KSA9PiB7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJlY29yZHMgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5maW5kXyhcbiAgICAgICAgICAgICAgICB0aGlzLm1ldGEubmFtZSwgXG4gICAgICAgICAgICAgICAgY29udGV4dC5maW5kT3B0aW9ucywgXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9uc1xuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKCFyZWNvcmRzKSB0aHJvdyBuZXcgRHNPcGVyYXRpb25FcnJvcignY29ubmVjdG9yLmZpbmRfKCkgcmV0dXJucyB1bmRlZmluZWQgZGF0YSByZWNvcmQuJyk7XG5cbiAgICAgICAgICAgIGlmIChmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb24pIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmVjb3JkcyA9IHRoaXMuX21hcFJlY29yZHNUb09iamVjdHMocmVjb3JkcywgZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbnRleHQuZmluZE9wdGlvbnMuJHVuYm94aW5nKSByZXR1cm4gcmVjb3JkcztcblxuICAgICAgICAgICAgcmV0dXJuIHJlY29yZHMubWFwKHJvdyA9PiB0aGlzLnBvcHVsYXRlKHJvdykpO1xuICAgICAgICB9LCBjb250ZXh0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5IHdpdGggZ2l2ZW4gZGF0YS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEVudGl0eSBkYXRhIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY3JlYXRlT3B0aW9uc10gLSBDcmVhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkPWZhbHNlXSAtIFJldHJpZXZlIHRoZSBuZXdseSBjcmVhdGVkIHJlY29yZCBmcm9tIGRiLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NyZWF0ZU9wdGlvbnMuJHVuYm94aW5nPWZhbHNlXSAtIFdoZW4gZmV0Y2hBcnJheSA9IHRydWUsIHRoZSByZXN1bHQgd2lsbCBiZSByZXR1cm5lZCBkaXJlY3RseSB3aXRob3V0IGNyZWF0aW5nIG1vZGVsIG9iamVjdHMuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtjb25uT3B0aW9uc11cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2Nvbm5PcHRpb25zLmNvbm5lY3Rpb25dXG4gICAgICogQHJldHVybnMge0VudGl0eU1vZGVsfVxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBjcmVhdGVfKGRhdGEsIGNyZWF0ZU9wdGlvbnMsIGNvbm5PcHRpb25zKSB7XG4gICAgICAgIGNyZWF0ZU9wdGlvbnMgfHwgKGNyZWF0ZU9wdGlvbnMgPSB7fSk7XG5cbiAgICAgICAgbGV0IFsgcmF3LCBhc3NvY2lhdGlvbnMgXSA9IHRoaXMuX2V4dHJhY3RBc3NvY2lhdGlvbnMoZGF0YSk7XG5cbiAgICAgICAgbGV0IGNvbnRleHQgPSB7IFxuICAgICAgICAgICAgcmF3LCBcbiAgICAgICAgICAgIGNyZWF0ZU9wdGlvbnMsXG4gICAgICAgICAgICBjb25uT3B0aW9uc1xuICAgICAgICB9OyAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGxldCBuZWVkQ3JlYXRlQXNzb2NzID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoYXNzb2NpYXRpb25zKSkge1xuICAgICAgICAgICAgbmVlZENyZWF0ZUFzc29jcyA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fc2FmZUV4ZWN1dGVfKGFzeW5jIChjb250ZXh0KSA9PiB7XG4gICAgICAgICAgICBpZiAobmVlZENyZWF0ZUFzc29jcykge1xuICAgICAgICAgICAgICAgIGlmICghY29udGV4dC5jb25uT3B0aW9ucyB8fCAhY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zIHx8IChjb250ZXh0LmNvbm5PcHRpb25zID0ge30pO1xuICAgIFxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5iZWdpblRyYW5zYWN0aW9uXygpOyAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gLy8gZWxzZSBhbHJlYWR5IGluIGEgdHJhbnNhY3Rpb24gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fcHJlcGFyZUVudGl0eURhdGFfKGNvbnRleHQpOyAgICAgICAgICBcblxuICAgICAgICAgICAgYXdhaXQgRmVhdHVyZXMuYXBwbHlSdWxlc18oUnVsZXMuUlVMRV9CRUZPUkVfQ1JFQVRFLCB0aGlzLCBjb250ZXh0KTsgICAgXG5cbiAgICAgICAgICAgIGNvbnRleHQucmVzdWx0ID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuY3JlYXRlXyhcbiAgICAgICAgICAgICAgICB0aGlzLm1ldGEubmFtZSwgXG4gICAgICAgICAgICAgICAgY29udGV4dC5sYXRlc3QsIFxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnNcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYWZ0ZXJDcmVhdGVfKGNvbnRleHQpO1xuXG4gICAgICAgICAgICBpZiAobmVlZENyZWF0ZUFzc29jcykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2NyZWF0ZUFzc29jc18oY29udGV4dCwgYXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZU9wdGlvbnMuJHVuYm94aW5nID8gY29udGV4dC5sYXRlc3QgOiB0aGlzLnBvcHVsYXRlKGNvbnRleHQubGF0ZXN0KTtcbiAgICAgICAgfSwgY29udGV4dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eSB3aXRoIGdpdmVuIGRhdGEuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFbnRpdHkgZGF0YSB3aXRoIGF0IGxlYXN0IG9uZSB1bmlxdWUga2V5IChwYWlyKSBnaXZlblxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9uc10gLSBVcGRhdGUgb3B0aW9uc1xuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9ucy4kcXVlcnldIC0gRXh0cmEgY29uZGl0aW9uXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkPWZhbHNlXSAtIFJldHJpZXZlIHRoZSB1cGRhdGVkIGVudGl0eSBmcm9tIGRhdGFiYXNlXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kdW5ib3hpbmc9ZmFsc2VdIC0gV2hlbiBmZXRjaEFycmF5ID0gdHJ1ZSwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGRpcmVjdGx5IHdpdGhvdXQgY3JlYXRpbmcgbW9kZWwgb2JqZWN0cy5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2Nvbm5PcHRpb25zXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29ubk9wdGlvbnMuY29ubmVjdGlvbl1cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVfKGRhdGEsIHVwZGF0ZU9wdGlvbnMsIGNvbm5PcHRpb25zKSB7XG4gICAgICAgIGlmICh1cGRhdGVPcHRpb25zICYmIHVwZGF0ZU9wdGlvbnMuJGJ5UGFzc1JlYWRPbmx5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignVW5leHBlY3RlZCB1c2FnZS4nLCB7IFxuICAgICAgICAgICAgICAgIGVudGl0eTogdGhpcy5tZXRhLm5hbWUsIFxuICAgICAgICAgICAgICAgIHJlYXNvbjogJyRieVBhc3NSZWFkT25seSBvcHRpb24gaXMgbm90IGFsbG93IHRvIGJlIHNldCBmcm9tIHB1YmxpYyB1cGRhdGVfIG1ldGhvZC4nLFxuICAgICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnNcbiAgICAgICAgICAgIH0pOyAgICAgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlXyhkYXRhLCB1cGRhdGVPcHRpb25zLCBjb25uT3B0aW9ucyk7XG4gICAgfVxuICAgIFxuICAgIHN0YXRpYyBhc3luYyBfdXBkYXRlXyhkYXRhLCB1cGRhdGVPcHRpb25zLCBjb25uT3B0aW9ucykge1xuICAgICAgICBpZiAoIXVwZGF0ZU9wdGlvbnMpIHtcbiAgICAgICAgICAgIGxldCBjb25kaXRpb25GaWVsZHMgPSB0aGlzLmdldFVuaXF1ZUtleUZpZWxkc0Zyb20oZGF0YSk7XG4gICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGNvbmRpdGlvbkZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignUHJpbWFyeSBrZXkgdmFsdWUocykgb3IgYXQgbGVhc3Qgb25lIGdyb3VwIG9mIHVuaXF1ZSBrZXkgdmFsdWUocykgaXMgcmVxdWlyZWQgZm9yIHVwZGF0aW5nIGFuIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMgPSB7ICRxdWVyeTogXy5waWNrKGRhdGEsIGNvbmRpdGlvbkZpZWxkcykgfTtcbiAgICAgICAgICAgIGRhdGEgPSBfLm9taXQoZGF0YSwgY29uZGl0aW9uRmllbGRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHVwZGF0ZU9wdGlvbnMgPSB0aGlzLl9wcmVwYXJlUXVlcmllcyh1cGRhdGVPcHRpb25zLCB0cnVlIC8qIGZvciBzaW5nbGUgcmVjb3JkICovKTtcblxuICAgICAgICBsZXQgY29udGV4dCA9IHsgXG4gICAgICAgICAgICByYXc6IGRhdGEsIFxuICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyxcbiAgICAgICAgICAgIGNvbm5PcHRpb25zXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5fc2FmZUV4ZWN1dGVfKGFzeW5jIChjb250ZXh0KSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9wcmVwYXJlRW50aXR5RGF0YV8oY29udGV4dCwgdHJ1ZSAvKiBpcyB1cGRhdGluZyAqLyk7ICAgICAgICAgIFxuXG4gICAgICAgICAgICBhd2FpdCBGZWF0dXJlcy5hcHBseVJ1bGVzXyhSdWxlcy5SVUxFX0JFRk9SRV9VUERBVEUsIHRoaXMsIGNvbnRleHQpOyAgICAgXG5cbiAgICAgICAgICAgIGNvbnRleHQucmVzdWx0ID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IudXBkYXRlXyhcbiAgICAgICAgICAgICAgICB0aGlzLm1ldGEubmFtZSwgXG4gICAgICAgICAgICAgICAgY29udGV4dC5sYXRlc3QsIFxuICAgICAgICAgICAgICAgIGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcXVlcnksXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9uc1xuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZnRlclVwZGF0ZV8oY29udGV4dCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB1cGRhdGVPcHRpb25zLiR1bmJveGluZyA/IGNvbnRleHQubGF0ZXN0IDogdGhpcy5wb3B1bGF0ZShjb250ZXh0LmxhdGVzdCk7XG4gICAgICAgIH0sIGNvbnRleHQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkgd2l0aCBnaXZlbiBkYXRhLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtkZWxldGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtkZWxldGVPcHRpb25zLiRxdWVyeV0gLSBFeHRyYSBjb25kaXRpb25cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtkZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQ9ZmFsc2VdIC0gUmV0cmlldmUgdGhlIHVwZGF0ZWQgZW50aXR5IGZyb20gZGF0YWJhc2VcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtkZWxldGVPcHRpb25zLiR1bmJveGluZz1mYWxzZV0gLSBXaGVuIGZldGNoQXJyYXkgPSB0cnVlLCB0aGUgcmVzdWx0IHdpbGwgYmUgcmV0dXJuZWQgZGlyZWN0bHkgd2l0aG91dCBjcmVhdGluZyBtb2RlbCBvYmplY3RzLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2RlbGV0ZU9wdGlvbnMuJHBoeXNpY2FsRGVsZXRpb249ZmFsc2VdIC0gV2hlbiBmZXRjaEFycmF5ID0gdHJ1ZSwgdGhlIHJlc3VsdCB3aWxsIGJlIHJldHVybmVkIGRpcmVjdGx5IHdpdGhvdXQgY3JlYXRpbmcgbW9kZWwgb2JqZWN0cy5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2Nvbm5PcHRpb25zXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29ubk9wdGlvbnMuY29ubmVjdGlvbl0gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGRlbGV0ZV8oZGVsZXRlT3B0aW9ucywgY29ubk9wdGlvbnMpIHtcbiAgICAgICAgcHJlOiBkZWxldGVPcHRpb25zO1xuXG4gICAgICAgIGRlbGV0ZU9wdGlvbnMgPSB0aGlzLl9wcmVwYXJlUXVlcmllcyhkZWxldGVPcHRpb25zLCB0cnVlIC8qIGZvciBzaW5nbGUgcmVjb3JkICovKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KGRlbGV0ZU9wdGlvbnMuJHF1ZXJ5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoJ0VtcHR5IGNvbmRpdGlvbiBpcyBub3QgYWxsb3dlZCBmb3IgZGVsZXRpbmcgYW4gZW50aXR5LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMubWV0YS5mZWF0dXJlcy5sb2dpY2FsRGVsZXRpb24gJiYgIWRlbGV0ZU9wdGlvbnMuJHBoeXNpY2FsRGVsZXRpb24pIHtcbiAgICAgICAgICAgIGxldCB7IGZpZWxkLCB2YWx1ZSB9ID0gdGhpcy5tZXRhLmZlYXR1cmVzLmxvZ2ljYWxEZWxldGlvbjtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVfKHsgW2ZpZWxkXTogdmFsdWUgfSwgeyBcbiAgICAgICAgICAgICAgICAkcXVlcnk6IGRlbGV0ZU9wdGlvbnMuJHF1ZXJ5LCBcbiAgICAgICAgICAgICAgICAkcmV0cmlldmVVcGRhdGVkOiBkZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQsXG4gICAgICAgICAgICAgICAgJHVuYm94aW5nOiBkZWxldGVPcHRpb25zLiR1bmJveGluZyxcbiAgICAgICAgICAgICAgICAkYnlQYXNzUmVhZE9ubHk6IG5ldyBTZXQoW2ZpZWxkXSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsZXQgY29udGV4dCA9IHsgXG4gICAgICAgICAgICBkZWxldGVPcHRpb25zLFxuICAgICAgICAgICAgY29ubk9wdGlvbnNcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLl9zYWZlRXhlY3V0ZV8oYXN5bmMgKGNvbnRleHQpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYmVmb3JlRGVsZXRlXyhjb250ZXh0KTtcblxuICAgICAgICAgICAgY29udGV4dC5yZXN1bHQgPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5kZWxldGVfKFxuICAgICAgICAgICAgICAgIHRoaXMubWV0YS5uYW1lLCAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29udGV4dC5kZWxldGVPcHRpb25zLiRxdWVyeSxcbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gZGVsZXRlT3B0aW9ucy4kdW5ib3hpbmcgPyBjb250ZXh0LmV4aXN0aW5nIDogdGhpcy5wb3B1bGF0ZShjb250ZXh0LmV4aXN0aW5nKTtcbiAgICAgICAgfSwgY29udGV4dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIGRhdGEgcmVjb3JkIGNvbnRhaW5zIHByaW1hcnkga2V5IG9yIGF0IGxlYXN0IG9uZSB1bmlxdWUga2V5IHBhaXIuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICovXG4gICAgc3RhdGljIF9jb250YWluc1VuaXF1ZUtleShkYXRhKSB7XG4gICAgICAgIHJldHVybiBfLmZpbmQodGhpcy5tZXRhLnVuaXF1ZUtleXMsIGZpZWxkcyA9PiBfLmV2ZXJ5KGZpZWxkcywgZiA9PiAhXy5pc05pbChkYXRhW2ZdKSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEVuc3VyZSB0aGUgY29uZGl0aW9uIGNvbnRhaW5zIG9uZSBvZiB0aGUgdW5pcXVlIGtleXMuXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICovXG4gICAgc3RhdGljIF9lbnN1cmVDb250YWluc1VuaXF1ZUtleShjb25kaXRpb24pIHtcbiAgICAgICAgbGV0IGNvbnRhaW5zVW5pcXVlS2V5ID0gdGhpcy5fY29udGFpbnNVbmlxdWVLZXkoY29uZGl0aW9uKTtcblxuICAgICAgICBpZiAoIWNvbnRhaW5zVW5pcXVlS2V5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignVW5leHBlY3RlZCB1c2FnZS4nLCB7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHRoaXMubWV0YS5uYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgcmVhc29uOiAnU2luZ2xlIHJlY29yZCBvcGVyYXRpb24gcmVxdWlyZXMgY29uZGl0aW9uIHRvIGJlIGNvbnRhaW5pbmcgdW5pcXVlIGtleS4nLFxuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb25cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIFByZXBhcmUgdmFsaWQgYW5kIHNhbml0aXplZCBlbnRpdHkgZGF0YSBmb3Igc2VuZGluZyB0byBkYXRhYmFzZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dCAtIE9wZXJhdGlvbiBjb250ZXh0LlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0LnJhdyAtIFJhdyBpbnB1dCBkYXRhLlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29udGV4dC5jb25uT3B0aW9uc11cbiAgICAgKiBAcGFyYW0ge2Jvb2x9IGlzVXBkYXRpbmcgLSBGbGFnIGZvciB1cGRhdGluZyBleGlzdGluZyBlbnRpdHkuXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIF9wcmVwYXJlRW50aXR5RGF0YV8oY29udGV4dCwgaXNVcGRhdGluZyA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBtZXRhID0gdGhpcy5tZXRhO1xuICAgICAgICBsZXQgaTE4biA9IHRoaXMuaTE4bjtcbiAgICAgICAgbGV0IHsgbmFtZSwgZmllbGRzIH0gPSBtZXRhOyAgICAgICAgXG5cbiAgICAgICAgbGV0IHsgcmF3IH0gPSBjb250ZXh0O1xuICAgICAgICBsZXQgbGF0ZXN0ID0ge30sIGV4aXN0aW5nO1xuICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGxhdGVzdDsgICAgICAgXG5cbiAgICAgICAgaWYgKCFjb250ZXh0LmkxOG4pIHtcbiAgICAgICAgICAgIGNvbnRleHQuaTE4biA9IGkxOG47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXNVcGRhdGluZyAmJiB0aGlzLl9kZXBlbmRzT25FeGlzdGluZ0RhdGEocmF3KSkge1xuICAgICAgICAgICAgaWYgKCFjb250ZXh0LmNvbm5PcHRpb25zIHx8ICFjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucyB8fCAoY29udGV4dC5jb25uT3B0aW9ucyA9IHt9KTtcblxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmJlZ2luVHJhbnNhY3Rpb25fKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IC8vIGVsc2UgYWxyZWFkeSBpbiBhIHRyYW5zYWN0aW9uICAgICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGV4aXN0aW5nID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlIH0sIGNvbnRleHQuY29ubk9wdGlvbnMpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGV4aXN0aW5nOyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICBhd2FpdCBVdGlsLmVhY2hBc3luY18oZmllbGRzLCBhc3luYyAoZmllbGRJbmZvLCBmaWVsZE5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmIChmaWVsZE5hbWUgaW4gcmF3KSB7XG4gICAgICAgICAgICAgICAgLy9maWVsZCB2YWx1ZSBnaXZlbiBpbiByYXcgZGF0YVxuICAgICAgICAgICAgICAgIGlmIChmaWVsZEluZm8ucmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1VwZGF0aW5nIHx8ICFjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJGJ5UGFzc1JlYWRPbmx5LmhhcyhmaWVsZE5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL3JlYWQgb25seSwgbm90IGFsbG93IHRvIHNldCBieSBpbnB1dCB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERhdGFWYWxpZGF0aW9uRXJyb3IoYFJlYWQtb25seSBmaWVsZCBcIiR7ZmllbGROYW1lfVwiIGlzIG5vdCBhbGxvd2VkIHRvIGJlIHNldCBieSBtYW51YWwgaW5wdXQuYCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eTogbmFtZSwgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZEluZm86IGZpZWxkSW5mbyBcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSAgXG5cbiAgICAgICAgICAgICAgICBpZiAoaXNVcGRhdGluZyAmJiBmaWVsZEluZm8uZnJlZXplQWZ0ZXJOb25EZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogZXhpc3RpbmcsICdcImZyZWV6ZUFmdGVyTm9uRGVmYXVsdFwiIHF1YWxpZmllciByZXF1aXJlcyBleGlzdGluZyBkYXRhLic7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nW2ZpZWxkTmFtZV0gIT09IGZpZWxkSW5mby5kZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2ZyZWV6ZUFmdGVyTm9uRGVmYXVsdCwgbm90IGFsbG93IHRvIGNoYW5nZSBpZiB2YWx1ZSBpcyBub24tZGVmYXVsdFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERhdGFWYWxpZGF0aW9uRXJyb3IoYEZyZWV6ZUFmdGVyTm9uRGVmYXVsdCBmaWVsZCBcIiR7ZmllbGROYW1lfVwiIGlzIG5vdCBhbGxvd2VkIHRvIGJlIGNoYW5nZWQuYCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eTogbmFtZSwgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZEluZm86IGZpZWxkSW5mbyBcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGlzVXBkYXRpbmcgJiYgZmllbGRJbmZvLndyaXRlT25jZSkgeyAgICAgXG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogZXhpc3RpbmcsICdcIndyaXRlT25jZVwiIHF1YWxpZmllciByZXF1aXJlcyBleGlzdGluZyBkYXRhLic7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc05pbChleGlzdGluZ1tmaWVsZE5hbWVdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERhdGFWYWxpZGF0aW9uRXJyb3IoYFdyaXRlLW9uY2UgZmllbGQgXCIke2ZpZWxkTmFtZX1cIiBpcyBub3QgYWxsb3dlZCB0byBiZSB1cGRhdGUgb25jZSBpdCB3YXMgc2V0LmAsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRJbmZvOiBmaWVsZEluZm8gXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy9zYW5pdGl6ZSBmaXJzdFxuICAgICAgICAgICAgICAgIGlmIChpc05vdGhpbmcocmF3W2ZpZWxkTmFtZV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghZmllbGRJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGF0YVZhbGlkYXRpb25FcnJvcihgVGhlIFwiJHtmaWVsZE5hbWV9XCIgdmFsdWUgb2YgXCIke25hbWV9XCIgZW50aXR5IGNhbm5vdCBiZSBudWxsLmAsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRJbmZvOiBmaWVsZEluZm8gXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGxhdGVzdFtmaWVsZE5hbWVdID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsYXRlc3RbZmllbGROYW1lXSA9IFR5cGVzLnNhbml0aXplKHJhd1tmaWVsZE5hbWVdLCBmaWVsZEluZm8sIGkxOG4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vbm90IGdpdmVuIGluIHJhdyBkYXRhXG4gICAgICAgICAgICBpZiAoaXNVcGRhdGluZykge1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZEluZm8uZm9yY2VVcGRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgLy9oYXMgZm9yY2UgdXBkYXRlIHBvbGljeSwgZS5nLiB1cGRhdGVUaW1lc3RhbXBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkSW5mby51cGRhdGVCeURiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvL3JlcXVpcmUgZ2VuZXJhdG9yIHRvIHJlZnJlc2ggYXV0byBnZW5lcmF0ZWQgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkSW5mby5hdXRvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXRlc3RbZmllbGROYW1lXSA9IGF3YWl0IEdlbmVyYXRvcnMuZGVmYXVsdChmaWVsZEluZm8sIGkxOG4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEYXRhVmFsaWRhdGlvbkVycm9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgYFwiJHtmaWVsZE5hbWV9XCIgb2YgXCIke25hbWV9XCIgZW50dGl5IGlzIHJlcXVpcmVkIGZvciBlYWNoIHVwZGF0ZS5gLCB7ICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5OiBuYW1lLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRJbmZvOiBmaWVsZEluZm9cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTsgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgLy9uZXcgcmVjb3JkXG4gICAgICAgICAgICBpZiAoIWZpZWxkSW5mby5jcmVhdGVCeURiKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkSW5mby5oYXNPd25Qcm9wZXJ0eSgnZGVmYXVsdCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vaGFzIGRlZmF1bHQgc2V0dGluZyBpbiBtZXRhIGRhdGFcbiAgICAgICAgICAgICAgICAgICAgbGF0ZXN0W2ZpZWxkTmFtZV0gPSBmaWVsZEluZm8uZGVmYXVsdDtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmllbGRJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkSW5mby5hdXRvKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vYXV0b21hdGljYWxseSBnZW5lcmF0ZWRcbiAgICAgICAgICAgICAgICAgICAgbGF0ZXN0W2ZpZWxkTmFtZV0gPSBhd2FpdCBHZW5lcmF0b3JzLmRlZmF1bHQoZmllbGRJbmZvLCBpMThuKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vbWlzc2luZyByZXF1aXJlZFxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGF0YVZhbGlkYXRpb25FcnJvcihgXCIke2ZpZWxkTmFtZX1cIiBvZiBcIiR7bmFtZX1cIiBlbnRpdHkgaXMgcmVxdWlyZWQuYCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5OiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRJbmZvOiBmaWVsZEluZm8gXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gLy8gZWxzZSBkZWZhdWx0IHZhbHVlIHNldCBieSBkYXRhYmFzZSBvciBieSBydWxlc1xuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBGZWF0dXJlcy5hcHBseVJ1bGVzXyhSdWxlcy5SVUxFX0FGVEVSX1ZBTElEQVRJT04sIHRoaXMsIGNvbnRleHQpOyAgICBcblxuICAgICAgICBhd2FpdCB0aGlzLmFwcGx5TW9kaWZpZXJzXyhjb250ZXh0LCBpc1VwZGF0aW5nKTtcblxuICAgICAgICB0aGlzLnNlcmlhbGl6ZShjb250ZXh0LmxhdGVzdCk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRleHQ7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9zYWZlRXhlY3V0ZV8oZXhlY3V0b3IsIGNvbnRleHQpIHtcbiAgICAgICAgZXhlY3V0b3IgPSBleGVjdXRvci5iaW5kKHRoaXMpO1xuXG4gICAgICAgIGlmIChjb250ZXh0LmNvbm5PcHRpb25zICYmIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbikge1xuICAgICAgICAgICAgIHJldHVybiBleGVjdXRvcihjb250ZXh0KTtcbiAgICAgICAgfSBcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dG9yKGNvbnRleHQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvL2lmIHRoZSBleGVjdXRvciBoYXZlIGluaXRpYXRlZCBhIHRyYW5zYWN0aW9uXG4gICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zICYmIFxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiAmJiBcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5jb21taXRfKGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbik7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgLy93ZSBoYXZlIHRvIHJvbGxiYWNrIGlmIGVycm9yIG9jY3VycmVkIGluIGEgdHJhbnNhY3Rpb25cbiAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMgJiYgXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uICYmIFxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLnJvbGxiYWNrXyhjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pOyAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gXG4gICAgfVxuXG4gICAgc3RhdGljIF9kZXBlbmRzT25FeGlzdGluZ0RhdGEoaW5wdXQpIHtcbiAgICAgICAgLy9jaGVjayBtb2RpZmllciBkZXBlbmRlbmNpZXNcbiAgICAgICAgbGV0IGRlcHMgPSB0aGlzLm1ldGEuZmllbGREZXBlbmRlbmNpZXM7XG4gICAgICAgIGxldCBoYXNEZXBlbmRzID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGRlcHMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGhhc0RlcGVuZHMgPSBfLmZpbmQoZGVwcywgKGRlcCwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSBpbiBpbnB1dCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy5maW5kKGRlcCwgZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgWyBzdGFnZSwgZmllbGQgXSA9IGQuc3BsaXQoJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoc3RhZ2UgPT09ICdsYXRlc3QnIHx8IHN0YWdlID09PSAnZXhpc3RuZycpICYmIF8uaXNOaWwoaW5wdXRbZmllbGRdKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChoYXNEZXBlbmRzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvL2NoZWNrIGJ5IHNwZWNpYWwgcnVsZXNcbiAgICAgICAgbGV0IGF0TGVhc3RPbmVOb3ROdWxsID0gdGhpcy5tZXRhLmZlYXR1cmVzLmF0TGVhc3RPbmVOb3ROdWxsO1xuICAgICAgICBpZiAoYXRMZWFzdE9uZU5vdE51bGwpIHtcbiAgICAgICAgICAgIGhhc0RlcGVuZHMgPSBfLmZpbmQoYXRMZWFzdE9uZU5vdE51bGwsIGZpZWxkcyA9PiBfLmZpbmQoZmllbGRzLCBmaWVsZCA9PiAoZmllbGQgaW4gaW5wdXQpICYmIF8uaXNOaWwoaW5wdXRbZmllbGRdKSkpO1xuICAgICAgICAgICAgaWYgKGhhc0RlcGVuZHMpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2hhc1Jlc2VydmVkS2V5cyhvYmopIHtcbiAgICAgICAgcmV0dXJuIF8uZmluZChvYmosICh2LCBrKSA9PiBrWzBdID09PSAnJCcpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfcHJlcGFyZVF1ZXJpZXMob3B0aW9ucywgZm9yU2luZ2xlUmVjb3JkID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgIW9wdGlvbnMuJHF1ZXJ5ICYmICF0aGlzLl9oYXNSZXNlcnZlZEtleXMob3B0aW9ucykpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7ICRxdWVyeTogb3B0aW9ucyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGZvclNpbmdsZVJlY29yZCkge1xuICAgICAgICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3Qob3B0aW9ucy4kcXVlcnkpKSB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5tZXRhLmtleUZpZWxkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignQ2Fubm90IHVzZSBhIHNpbmd1bGFyIHZhbHVlIGFzIGNvbmRpdGlvbiB0byBxdWVyeSBhZ2FpbnN0IGEgZW50aXR5IHdpdGggY29tYmluZWQgcHJpbWFyeSBrZXkuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgICAgIG9wdGlvbnMuJHF1ZXJ5ID0geyBbdGhpcy5tZXRhLmtleUZpZWxkXTogb3B0aW9ucy4kcXVlcnkgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZW5zdXJlQ29udGFpbnNVbmlxdWVLZXkob3B0aW9ucy4kcXVlcnkpO1xuICAgICAgICAgICAgfSAgICAgICAgXG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHJldHVybiBvcHRpb25zIHx8IHt9O1xuICAgIH1cblxuICAgIHN0YXRpYyBfcHJlcGFyZUFzc29jaWF0aW9ucygpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgYmUgb3ZlcnJpZGUgYnkgZHJpdmVyLXNwZWNpZmljIHN1YmNsYXNzLicpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfbWFwUmVjb3Jkc1RvT2JqZWN0cygpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgYmUgb3ZlcnJpZGUgYnkgZHJpdmVyLXNwZWNpZmljIHN1YmNsYXNzLicpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZXh0cmFjdEFzc29jaWF0aW9ucyhkYXRhKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignU2hvdWxkIGJlIG92ZXJyaWRlIGJ5IGRyaXZlci1zcGVjaWZpYyBzdWJjbGFzcy4nKTsgICAgXG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9jcmVhdGVBc3NvY3NfKGNvbnRleHQsIGFzc29jcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nob3VsZCBiZSBvdmVycmlkZSBieSBkcml2ZXItc3BlY2lmaWMgc3ViY2xhc3MuJyk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVudGl0eU1vZGVsOyJdfQ==