"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static serialize(dataRecord) {
    _.forOwn(dataRecord, (value, fieldName) => {
      let fieldMeta = this.meta.fields[fieldName];

      if (fieldMeta.type === 'datetime') {
        if (typeof value === 'object' && value.oolType === 'SymbolToken') {
          if (value.name === 'now') {
            dataRecord[fieldName] = this.db.connector.raw('NOW()');
          }
        }

        if (value instanceof DateTime) {
          dataRecord[fieldName] = value.toISO({
            includeOffset: false
          });
        }
      } else if (fieldMeta.type === 'boolean') {
        dataRecord[fieldName] = dataRecord[fieldName] ? 1 : 0;
      }
    });
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(associations) {
    associations = associations.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor,
        isList: assocInfo.isList,
        optional: assocInfo.optional
      };

      if (assocInfo.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;

        if (assocInfo.connectedBy) {
          detail.entity = assocInfo.connectedBy;
          detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;
          detail.subAssociations = [{
            entity: remoteEntityName,
            keyField: remoteEntity.meta.keyField,
            joinType: 'LEFT JOIN',
            anchor: remoteEntityName,
            localField: remoteEntityName,
            remoteField: remoteEntity.meta.keyField,
            isList: false
          }];
        }
      } else {
        detail.localField = anchor;
        detail.remoteField = remoteEntity.meta.keyField;
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = {
        entity: remoteEntity,
        detail
      };
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            console.log(associations);
            console.log(anchor);
            console.log('rowKey', rowKey);
            console.log('subIndexes', subIndexes);
            throw new Error('');
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];
            let subObject = {
              [col.name]: value
            };
            tableCache[col.table] = subObject;
            setValueByPath(result, nodePath, subObject);
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJEYXRlVGltZSIsIkVudGl0eU1vZGVsIiwiQnVzaW5lc3NFcnJvciIsIk15U1FMRW50aXR5TW9kZWwiLCJoYXNBdXRvSW5jcmVtZW50IiwiYXV0b0lkIiwibWV0YSIsImZlYXR1cmVzIiwiZmllbGRzIiwiZmllbGQiLCJhdXRvSW5jcmVtZW50SWQiLCJzZXJpYWxpemUiLCJkYXRhUmVjb3JkIiwiZm9yT3duIiwidmFsdWUiLCJmaWVsZE5hbWUiLCJmaWVsZE1ldGEiLCJ0eXBlIiwib29sVHlwZSIsIm5hbWUiLCJkYiIsImNvbm5lY3RvciIsInJhdyIsInRvSVNPIiwiaW5jbHVkZU9mZnNldCIsImNyZWF0ZV8iLCJhcmdzIiwiZXJyb3IiLCJlcnJvckNvZGUiLCJjb2RlIiwibWVzc2FnZSIsInVwZGF0ZV8iLCJhZnRlckNyZWF0ZV8iLCJjb250ZXh0IiwiaW5zZXJ0SWQiLCJyZXN1bHQiLCJsYXRlc3QiLCJjcmVhdGVPcHRpb25zIiwiJHJldHJpZXZlQ3JlYXRlZCIsImNvbmRpdGlvbiIsImdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tIiwiZmluZE9uZV8iLCIkcXVlcnkiLCIkdW5ib3hpbmciLCJjb25uT3B0aW9ucyIsImFmdGVyVXBkYXRlXyIsInVwZGF0ZU9wdGlvbnMiLCIkcmV0cmlldmVVcGRhdGVkIiwiYmVmb3JlRGVsZXRlXyIsImRlbGV0ZU9wdGlvbnMiLCIkcmV0cmlldmVEZWxldGVkIiwiY29ubmVjdGlvbiIsImJlZ2luVHJhbnNhY3Rpb25fIiwiZXhpc3RpbmciLCJfcHJlcGFyZUFzc29jaWF0aW9ucyIsImFzc29jaWF0aW9ucyIsImNvbmNhdCIsInNvcnQiLCJjYWNoZSIsImhpZXJhcmNoeSIsImZvckVhY2giLCJhc3NvYyIsInJlbW90ZUVudGl0eSIsImJhc2UiLCJhbmNob3IiLCJhc3NvY0luZm8iLCJfZ2V0UmVsYXRlZEVudGl0eSIsInJlbW90ZUVudGl0eU5hbWUiLCJkZXRhaWwiLCJlbnRpdHkiLCJrZXlGaWVsZCIsImpvaW5UeXBlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJsb2NhbEZpZWxkIiwicmVtb3RlRmllbGQiLCJjb25uZWN0ZWRCeSIsIm1vZGVsIiwic3ViQXNzb2NpYXRpb25zIiwicHVzaCIsImFzc29jUGF0aCIsInBhcnRzIiwic3BsaXQiLCJzbGljZSIsImpvaW4iLCJjYWNoZU5vZGUiLCJsYXN0IiwicG9wIiwiY3VycmVudCIsImN1cnJlbnRBc3NvY0luZm8iLCJsZW5ndGgiLCJzaGlmdCIsIl9tYXBSZWNvcmRzVG9PYmplY3RzIiwicm93cyIsImNvbHVtbnMiLCJhbGlhc01hcCIsIm1haW5JbmRleCIsIm1lcmdlUmVjb3JkIiwiZXhpc3RpbmdSb3ciLCJyb3dPYmplY3QiLCJlYWNoIiwia2V5Iiwic3ViT2JqIiwic3ViSW5kZXhlcyIsInJvd0tleSIsImlzTmlsIiwiZXhpc3RpbmdTdWJSb3ciLCJjb25zb2xlIiwibG9nIiwiRXJyb3IiLCJzdWJJbmRleCIsImJ1aWxkU3ViSW5kZXhlcyIsInJlZHVjZSIsImluZGV4ZXMiLCJzdWJPYmplY3QiLCJhcnJheU9mT2JqcyIsInJvdyIsInRhYmxlQ2FjaGUiLCJpIiwiY29sIiwidGFibGUiLCJidWNrZXQiLCJub2RlUGF0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUF3QkgsSUFBOUI7O0FBRUEsTUFBTTtBQUFFSSxFQUFBQTtBQUFGLElBQWVILE9BQU8sQ0FBQyxPQUFELENBQTVCOztBQUNBLE1BQU1JLFdBQVcsR0FBR0osT0FBTyxDQUFDLG1CQUFELENBQTNCOztBQUNBLE1BQU07QUFBRUssRUFB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cXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIHNldFZhbHVlQnlQYXRoIH0gPSBVdGlsO1xuXG5jb25zdCB7IERhdGVUaW1lIH0gPSByZXF1aXJlKCdsdXhvbicpO1xuY29uc3QgRW50aXR5TW9kZWwgPSByZXF1aXJlKCcuLi8uLi9FbnRpdHlNb2RlbCcpO1xuY29uc3QgeyBCdXNpbmVzc0Vycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBNeVNRTCBlbnRpdHkgbW9kZWwgY2xhc3MuXG4gKi9cbmNsYXNzIE15U1FMRW50aXR5TW9kZWwgZXh0ZW5kcyBFbnRpdHlNb2RlbCB7ICAgIFxuICAgIHN0YXRpYyBnZXQgaGFzQXV0b0luY3JlbWVudCgpIHtcbiAgICAgICAgbGV0IGF1dG9JZCA9IHRoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG4gICAgICAgIHJldHVybiBhdXRvSWQgJiYgdGhpcy5tZXRhLmZpZWxkc1thdXRvSWQuZmllbGRdLmF1dG9JbmNyZW1lbnRJZDsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VyaWFsaXplIHZhbHVlIGludG8gZGF0YWJhc2UgYWNjZXB0YWJsZSBmb3JtYXQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFSZWNvcmQgXG4gICAgICovXG4gICAgc3RhdGljIHNlcmlhbGl6ZShkYXRhUmVjb3JkKSB7XG4gICAgICAgIF8uZm9yT3duKGRhdGFSZWNvcmQsICh2YWx1ZSwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZmllbGRNZXRhID0gdGhpcy5tZXRhLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZmllbGRNZXRhLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5vb2xUeXBlID09PSAnU3ltYm9sVG9rZW4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5uYW1lID09PSAnbm93Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdGhpcy5kYi5jb25uZWN0b3IucmF3KCdOT1coKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZVRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkTWV0YS50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPSBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPyAxIDogMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGNyZWF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLmNyZWF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSArIGAgd2hpbGUgY3JlYXRpbmcgYSBuZXcgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci51cGRhdGVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBQb3N0IGNyZWF0ZSBwcm9jZXNzaW5nLlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuY3JlYXRlT3B0aW9uc10gLSBDcmVhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSBjcmVhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJDcmVhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzQXV0b0luY3JlbWVudCkge1xuICAgICAgICAgICAgbGV0IHsgaW5zZXJ0SWQgfSA9IGNvbnRleHQucmVzdWx0O1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZC5maWVsZF0gPSBpbnNlcnRJZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmNyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZCkge1xuICAgICAgICAgICAgbGV0IGNvbmRpdGlvbiA9IHRoaXMuZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20oY29udGV4dC5sYXRlc3QpO1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3QgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb25kaXRpb24sICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdCB1cGRhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFt1cGRhdGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFt1cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IHVwZGF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlclVwZGF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCZWZvcmUgZGVsZXRpbmcgYW4gZW50aXR5LlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuZGVsZXRlT3B0aW9uc10gLSBEZWxldGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkXSAtIFJldHJpZXZlIHRoZSByZWNlbnRseSBkZWxldGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYmVmb3JlRGVsZXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFjb250ZXh0LmNvbm5PcHRpb25zIHx8ICFjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zIHx8IChjb250ZXh0LmNvbm5PcHRpb25zID0ge30pO1xuXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuYmVnaW5UcmFuc2FjdGlvbl8oKTsgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyogICAgICBlbnRpdHk6IDxyZW1vdGUgZW50aXR5PlxuICAgICAqICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU58SU5ORVIgSk9JTnxGVUxMIE9VVEVSIEpPSU4nXG4gICAgICogICAgICBhbmNob3I6ICdsb2NhbCBwcm9wZXJ0eSB0byBwbGFjZSB0aGUgcmVtb3RlIGVudGl0eSdcbiAgICAgKiAgICAgIGxvY2FsRmllbGQ6IDxsb2NhbCBmaWVsZCB0byBqb2luPlxuICAgICAqICAgICAgcmVtb3RlRmllbGQ6IDxyZW1vdGUgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHN1YkFzc29jaWF0aW9uczogeyAuLi4gfSAgKi9cbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoYXNzb2NpYXRpb25zKSB7ICAgXG4gICAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQoKS5zb3J0KCk7XG4gICAgICAgIGxldCBjYWNoZSA9IHt9LCBoaWVyYXJjaHkgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGFzc29jaWF0aW9ucy5mb3JFYWNoKGFzc29jID0+IHtcbiAgICAgICAgICAgIGxldCBbIHJlbW90ZUVudGl0eSwgYmFzZSwgYW5jaG9yLCBhc3NvY0luZm8gXSA9IHRoaXMuX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2MsIGNhY2hlKTtcbiAgICAgICAgICAgIGFzc2VydDogYXNzb2NJbmZvO1xuXG4gICAgICAgICAgICBsZXQgcmVtb3RlRW50aXR5TmFtZSA9IHJlbW90ZUVudGl0eS5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgIGxldCBkZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgYW5jaG9yLFxuICAgICAgICAgICAgICAgIGlzTGlzdDogYXNzb2NJbmZvLmlzTGlzdCxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogYXNzb2NJbmZvLm9wdGlvbmFsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5lbnRpdHkgPSBhc3NvY0luZm8uY29ubmVjdGVkQnk7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5rZXlGaWVsZCA9IHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KS5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5jaG9yOiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsRmllbGQ6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlRmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzTGlzdDogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gYW5jaG9yO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2FjaGVbYmFzZV0pIHtcbiAgICAgICAgICAgICAgICBpZiAoY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zLnB1c2goZGV0YWlsKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zID0gWyBkZXRhaWwgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhpZXJhcmNoeS5wdXNoKGRldGFpbCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhY2hlW2Fzc29jXSA9IHtcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eSxcbiAgICAgICAgICAgICAgICBkZXRhaWxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBoaWVyYXJjaHk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXRSZWxhdGVkRW50aXR5KGFzc29jUGF0aCwgY2FjaGUpIHsgICAgICAgIFxuICAgICAgICBsZXQgcGFydHMgPSBhc3NvY1BhdGguc3BsaXQoJy4nKTsgICAgICAgIFxuICAgICAgICBsZXQgYmFzZSA9IHBhcnRzLnNsaWNlKDAsIC0xKS5qb2luKCcuJyk7ICAgICAgICBcblxuICAgICAgICBsZXQgY2FjaGVOb2RlID0gY2FjaGVbYmFzZV07XG4gICAgICAgIGlmIChjYWNoZU5vZGUpIHtcbiAgICAgICAgICAgIGxldCBsYXN0ID0gcGFydHMucG9wKCk7XG4gICAgICAgICAgICBsZXQgYXNzb2NJbmZvID0gY2FjaGVOb2RlLmVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tsYXN0XTtcbiAgICAgICAgICAgIGlmICghYXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBbIHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmVudGl0eSksIGJhc2UsIGxhc3QsIGFzc29jSW5mbyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMsIGN1cnJlbnQsIGN1cnJlbnRBc3NvY0luZm87XG5cbiAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgY3VycmVudEFzc29jSW5mbyA9IGVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tjdXJyZW50XTtcbiAgICAgICAgICAgIGlmICghY3VycmVudEFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIG9mIFwiJHt0aGlzLm1ldGEubmFtZX1cIiBlbnRpdHk6ICR7YXNzb2NQYXRofWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbnRpdHkgPSB0aGlzLmRiLm1vZGVsKGN1cnJlbnRBc3NvY0luZm8uZW50aXR5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbIGVudGl0eSwgYmFzZSwgY3VycmVudCwgY3VycmVudEFzc29jSW5mbyBdO1xuICAgIH1cblxuICAgIHN0YXRpYyBfbWFwUmVjb3Jkc1RvT2JqZWN0cyhbcm93cywgY29sdW1ucywgYWxpYXNNYXBdLCBoaWVyYXJjaHkpIHtcbiAgICAgICAgbGV0IG1haW5JbmRleCA9IHt9O1xuXG4gICAgICAgIGZ1bmN0aW9uIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGFzc29jaWF0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKGFzc29jaWF0aW9ucywgKHsga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQga2V5ID0gJzonICsgYW5jaG9yOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqID0gcm93T2JqZWN0W2tleV1cbiAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXhlcyA9IGV4aXN0aW5nUm93LnN1YkluZGV4ZXNba2V5XTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcm93S2V5ID0gc3ViT2JqW2tleUZpZWxkXTtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChyb3dLZXkpKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBsZXQgZXhpc3RpbmdTdWJSb3cgPSBzdWJJbmRleGVzICYmIHN1YkluZGV4ZXNbcm93S2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdTdWJSb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdTdWJSb3csIHN1Yk9iaiwgc3ViQXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTGlzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGFuY2hvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygncm93S2V5Jywgcm93S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWJJbmRleGVzJywgc3ViSW5kZXhlcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93LnJvd09iamVjdFtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XS5wdXNoKHN1Yk9iaik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqIF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iaiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqLCBzdWJBc3NvY2lhdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlc1tyb3dLZXldID0gc3ViSW5kZXg7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIGFzc29jaWF0aW9ucy5yZWR1Y2UoKGluZGV4ZXMsIHsga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBrZXkgPSAnOicrYW5jaG9yO1xuICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSByb3dPYmplY3Rba2V5XTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmplY3QgXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChpc0xpc3QpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChzdWJPYmplY3Rba2V5RmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W2tleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqZWN0IF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleUZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gcm93T2JqZWN0W2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChzdWJPYmplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXguc3ViSW5kZXhlcyA9IGJ1aWxkU3ViSW5kZXhlcyhzdWJPYmplY3QsIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpbmRleGVzW2tleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBbc3ViT2JqZWN0W2tleUZpZWxkXV06IHN1YkluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ZXM7XG4gICAgICAgICAgICB9LCB7fSk7ICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFycmF5T2ZPYmpzID0gW107XG5cbiAgICAgICAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XG4gICAgICAgICAgICBsZXQgcm93T2JqZWN0ID0ge307IC8vIGhhc2gtc3R5bGUgZGF0YSByb3dcbiAgICAgICAgICAgIGxldCB0YWJsZUNhY2hlID0ge307IC8vIGZyb20gYWxpYXMgdG8gY2hpbGQgcHJvcCBvZiByb3dPYmplY3RcblxuICAgICAgICAgICAgcm93LnJlZHVjZSgocmVzdWx0LCB2YWx1ZSwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2wgPSBjb2x1bW5zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChjb2wudGFibGUgPT09ICdBJykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbY29sLm5hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBidWNrZXQgPSB0YWJsZUNhY2hlW2NvbC50YWJsZV07ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1Y2tldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0W2NvbC5uYW1lXSA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZVBhdGggPSBhbGlhc01hcFtjb2wudGFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHsgW2NvbC5uYW1lXTogdmFsdWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlQ2FjaGVbY29sLnRhYmxlXSA9IHN1Yk9iamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlQnlQYXRoKHJlc3VsdCwgbm9kZVBhdGgsIHN1Yk9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSwgcm93T2JqZWN0KTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcm93S2V5ID0gcm93T2JqZWN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG4gICAgICAgICAgICBsZXQgZXhpc3RpbmdSb3cgPSBtYWluSW5kZXhbcm93S2V5XTtcbiAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdykge1xuICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGhpZXJhcmNoeSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFycmF5T2ZPYmpzLnB1c2gocm93T2JqZWN0KTtcbiAgICAgICAgICAgICAgICBtYWluSW5kZXhbcm93S2V5XSA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdCwgXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXM6IGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGhpZXJhcmNoeSlcbiAgICAgICAgICAgICAgICB9OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFycmF5T2ZPYmpzO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTEVudGl0eU1vZGVsOyJdfQ==