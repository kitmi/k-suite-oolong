"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

const Types = require('../../types');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static _translateSymbolToken(name) {
    if (name === 'now') {
      return this.db.connector.raw('NOW()');
    }

    throw new Error('not support');
  }

  static _serialize(value) {
    if (typeof value === 'boolean') return value ? 1 : 0;

    if (value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  }

  static _serializeByType(value, info) {
    if (info.type === 'boolean') {
      return value ? 1 : 0;
    }

    if (info.type === 'datetime' && value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    if (info.type === 'array' && Array.isArray(value)) {
      if (info.csv) {
        return Types.ARRAY.toCsv(value);
      } else {
        return Types.ARRAY.serialize(value);
      }
    }

    return value;
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity. Detail: ' + error.message);
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async updateOne_(...args) {
    try {
      return await super.updateOne_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async beforeCreate_(context) {
    return true;
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      let retrieveOptions = _.isPlainObject(context.createOptions.$retrieveCreated) ? context.createOptions.$retrieveCreated : {};
      context.latest = await this.findOne_({ ...retrieveOptions,
        $query: condition
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      let condition = {
        $query: context.updateOptions.$query
      };

      if (context.updateOptions.$byPassEnsureUnique) {
        condition.$byPassEnsureUnique = context.updateOptions.$byPassEnsureUnique;
      }

      let retrieveOptions = {};

      if (_.isPlainObject(context.updateOptions.$retrieveUpdated)) {
        retrieveOptions = context.updateOptions.$retrieveUpdated;
      } else if (context.updateOptions.$relationships) {
        retrieveOptions.$relationships = context.updateOptions.$relationships;
      }

      context.latest = await this.findOne_({ ...retrieveOptions,
        ...condition
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdateMany_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      let retrieveOptions = {};

      if (_.isPlainObject(context.updateOptions.$retrieveUpdated)) {
        retrieveOptions = context.updateOptions.$retrieveUpdated;
      } else if (context.updateOptions.$relationships) {
        retrieveOptions.$relationships = context.updateOptions.$relationships;
      }

      context.latest = await this.findAll_({ ...retrieveOptions,
        $query: context.updateOptions.$query
      }, context.connOptions);
    }

    return true;
  }

  static async afterDelete_(context) {
    return true;
  }

  static async afterDeleteMany_(context) {
    return true;
  }

  static async afterFindAll_(context, records) {
    if (context.findOptions.$toDictionary) return records.reduce((table, v) => {
      table[v[this.meta.keyField]] = v;
      return table;
    }, {});
    return records;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      let retrieveOptions = _.isPlainObject(context.deleteOptions.$retrieveDeleted) ? context.deleteOptions.$retrieveDeleted : {};
      context.existing = await this.findOne_({ ...retrieveOptions,
        $query: context.deleteOptions.$query
      }, context.connOptions);
    }
  }

  static async beforeDeleteMany_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      let retrieveOptions = _.isPlainObject(context.deleteOptions.$retrieveDeleted) ? context.deleteOptions.$retrieveDeleted : {};
      context.existing = await this.findAll_({ ...retrieveOptions,
        $query: context.deleteOptions.$query
      }, context.connOptions);
    }
  }

  static _prepareAssociations(findOptions) {
    let associations = _.uniq(findOptions.$association).sort();

    let assocTable = {},
        counter = 0,
        cache = {};
    associations.forEach(assoc => {
      if (_.isPlainObject(assoc)) {
        assoc = this._translateSchemaNameToDb(assoc);
        let alias = assoc.alias;

        if (!assoc.alias) {
          alias = ':join' + ++counter;
        }

        assocTable[alias] = {
          entity: assoc.entity,
          joinType: assoc.type,
          output: assoc.output,
          key: assoc.key,
          alias,
          on: assoc.on,
          ...(assoc.dataset ? this.db.connector.buildQuery(assoc.entity, this._prepareQueries({ ...assoc.dataset,
            $variables: findOptions.$variables
          })) : {})
        };
      } else {
        this._loadAssocIntoTable(assocTable, cache, assoc);
      }
    });
    return assocTable;
  }

  static _loadAssocIntoTable(assocTable, cache, assoc) {
    if (cache[assoc]) return cache[assoc];
    let lastPos = assoc.lastIndexOf('.');
    let result;

    if (lastPos === -1) {
      let assocInfo = { ...this.meta.associations[assoc]
      };

      if (!assocInfo) {
        throw new BusinessError(`Entity "${this.meta.name}" does not have the association "${assoc}".`);
      }

      result = cache[assoc] = assocTable[assoc] = { ...this._translateSchemaNameToDb(assocInfo)
      };
    } else {
      let base = assoc.substr(0, lastPos);
      let last = assoc.substr(lastPos + 1);
      let baseNode = cache[base];

      if (!baseNode) {
        baseNode = this._loadAssocIntoTable(assocTable, cache, base);
      }

      let entity = this.db.model(baseNode.entity);
      let assocInfo = { ...entity.meta.associations[last]
      };

      if (!assocInfo) {
        throw new BusinessError(`Entity "${entity.meta.name}" does not have the association "${assoc}".`);
      }

      result = { ...this._translateSchemaNameToDb(assocInfo)
      };

      if (!baseNode.subAssocs) {
        baseNode.subAssocs = {};
      }

      cache[assoc] = baseNode.subAssocs[last] = result;
    }

    if (result.assoc) {
      this._loadAssocIntoTable(assocTable, cache, assoc + '.' + result.assoc);
    }

    return result;
  }

  static _translateSchemaNameToDb(assoc) {
    if (assoc.entity.indexOf('.') > 0) {
      let [schemaName, entityName] = assoc.entity.split('.', 2);
      let app = this.db.app;

      if (!app) {
        throw new OolongUsageError('Cross db association requires the db object have access to other db object.');
      }

      let refDb = app.db(schemaName);

      if (!refDb) {
        throw new OolongUsageError(`The referenced schema "${schemaName}" does not have db model in the same application.`);
      }

      assoc.entity = refDb.connector.database + '.' + entityName;

      if (!assoc.key) {
        let model = refDb.model(entityName);

        if (!model) {
          throw new OolongUsageError(`Failed load the entity model "${schemaName}.${entityName}".`);
        }

        assoc.key = model.meta.keyField;
      }
    } else if (!assoc.key) {
      assoc.key = this.db.model(assoc.entity).meta.keyField;
    }

    return assoc;
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) return;
        let objKey = ':' + anchor;
        let subObj = rowObject[objKey];
        let subIndexes = existingRow.subIndexes[objKey];
        let rowKey = subObj[key];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssocs) {
            mergeRecord(existingSubRow, subObj, subAssocs);
          }
        } else {
          if (!list) {
            throw new Error("Assertion failed: list");
          }

          if (existingRow.rowObject[objKey]) {
            existingRow.rowObject[objKey].push(subObj);
          } else {
            existingRow.rowObject[objKey] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssocs);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      let indexes = {};

      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) {
          return;
        }

        if (!key) {
          throw new Error("Assertion failed: key");
        }

        let objKey = ':' + anchor;
        let subObject = rowObject[objKey];
        let subIndex = {
          rowObject: subObject
        };

        if (list) {
          if (_.isNil(subObject[key])) {
            rowObject[objKey] = [];
            subObject = null;
          } else {
            rowObject[objKey] = [subObject];
          }
        } else if (subObject && _.isNil(subObject[key])) {
          subObject = rowObject[objKey] = null;
        }

        if (subObject) {
          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssocs);
          }

          indexes[objKey] = {
            [subObject[key]]: subIndex
          };
        }
      });

      return indexes;
    }

    let arrayOfObjs = [];
    rows.forEach((row, i) => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];

            if (nodePath) {
              let subObject = {
                [col.name]: value
              };
              tableCache[col.table] = subObject;
              setValueByPath(result, nodePath, subObject);
            }
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      let assocModel = this.db.model(assocMeta.entity);

      if (assocMeta.list) {
        data = _.castArray(data);
        return eachAsync_(data, item => assocModel.create_({ ...item,
          ...(assocMeta.field ? {
            [assocMeta.field]: keyValue
          } : {})
        }, context.createOptions, context.connOptions));
      }

      return assocModel.create_({ ...data,
        ...(assocMeta.field ? {
          [assocMeta.field]: keyValue
        } : {})
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiRGF0ZVRpbWUiLCJFbnRpdHlNb2RlbCIsIk9vbG9uZ1VzYWdlRXJyb3IiLCJCdXNpbmVzc0Vycm9yIiwiVHlwZXMiLCJNeVNRTEVudGl0eU1vZGVsIiwiaGFzQXV0b0luY3JlbWVudCIsImF1dG9JZCIsIm1ldGEiLCJmZWF0dXJlcyIsImZpZWxkcyIsImZpZWxkIiwiYXV0b0luY3JlbWVudElkIiwiX3RyYW5zbGF0ZVN5bWJvbFRva2VuIiwibmFtZSIsImRiIiwiY29ubmVjdG9yIiwicmF3IiwiRXJyb3IiLCJfc2VyaWFsaXplIiwidmFsdWUiLCJ0b0lTTyIsImluY2x1ZGVPZmZzZXQiLCJfc2VyaWFsaXplQnlUeXBlIiwiaW5mbyIsInR5cGUiLCJBcnJheSIsImlzQXJyYXkiLCJjc3YiLCJBUlJBWSIsInRvQ3N2Iiwic2VyaWFsaXplIiwiY3JlYXRlXyIsImFyZ3MiLCJlcnJvciIsImVycm9yQ29kZSIsImNvZGUiLCJtZXNzYWdlIiwidXBkYXRlT25lXyIsImJlZm9yZUNyZWF0ZV8iLCJjb250ZXh0IiwiYWZ0ZXJDcmVhdGVfIiwiaW5zZXJ0SWQiLCJyZXN1bHQiLCJsYXRlc3QiLCJjcmVhdGVPcHRpb25zIiwiJHJldHJpZXZlQ3JlYXRlZCIsImNvbmRpdGlvbiIsImdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tIiwicmV0cmlldmVPcHRpb25zIiwiaXNQbGFpbk9iamVjdCIsImZpbmRPbmVfIiwiJHF1ZXJ5IiwiY29ubk9wdGlvbnMiLCJhZnRlclVwZGF0ZV8iLCJ1cGRhdGVPcHRpb25zIiwiJHJldHJpZXZlVXBkYXRlZCIsIiRieVBhc3NFbnN1cmVVbmlxdWUiLCIkcmVsYXRpb25zaGlwcyIsImFmdGVyVXBkYXRlTWFueV8iLCJmaW5kQWxsXyIsImFmdGVyRGVsZXRlXyIsImFmdGVyRGVsZXRlTWFueV8iLCJhZnRlckZpbmRBbGxfIiwicmVjb3JkcyIsImZpbmRPcHRpb25zIiwiJHRvRGljdGlvbmFyeSIsInJlZHVjZSIsInRhYmxlIiwidiIsImtleUZpZWxkIiwiYmVmb3JlRGVsZXRlXyIsImRlbGV0ZU9wdGlvbnMiLCIkcmV0cmlldmVEZWxldGVkIiwiY29ubmVjdGlvbiIsImJlZ2luVHJhbnNhY3Rpb25fIiwiZXhpc3RpbmciLCJiZWZvcmVEZWxldGVNYW55XyIsIl9wcmVwYXJlQXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25zIiwidW5pcSIsIiRhc3NvY2lhdGlvbiIsInNvcnQiLCJhc3NvY1RhYmxlIiwiY291bnRlciIsImNhY2hlIiwiZm9yRWFjaCIsImFzc29jIiwiX3RyYW5zbGF0ZVNjaGVtYU5hbWVUb0RiIiwiYWxpYXMiLCJlbnRpdHkiLCJqb2luVHlwZSIsIm91dHB1dCIsImtleSIsIm9uIiwiZGF0YXNldCIsImJ1aWxkUXVlcnkiLCJfcHJlcGFyZVF1ZXJpZXMiLCIkdmFyaWFibGVzIiwiX2xvYWRBc3NvY0ludG9UYWJsZSIsImxhc3RQb3MiLCJsYXN0SW5kZXhPZiIsImFzc29jSW5mbyIsImJhc2UiLCJzdWJzdHIiLCJsYXN0IiwiYmFzZU5vZGUiLCJtb2RlbCIsInN1YkFzc29jcyIsImluZGV4T2YiLCJzY2hlbWFOYW1lIiwiZW50aXR5TmFtZSIsInNwbGl0IiwiYXBwIiwicmVmRGIiLCJkYXRhYmFzZSIsIl9tYXBSZWNvcmRzVG9PYmplY3RzIiwicm93cyIsImNvbHVtbnMiLCJhbGlhc01hcCIsImhpZXJhcmNoeSIsIm1haW5JbmRleCIsIm1lcmdlUmVjb3JkIiwiZXhpc3RpbmdSb3ciLCJyb3dPYmplY3QiLCJlYWNoIiwic3FsIiwibGlzdCIsImFuY2hvciIsIm9iaktleSIsInN1Yk9iaiIsInN1YkluZGV4ZXMiLCJyb3dLZXkiLCJpc05pbCIsImV4aXN0aW5nU3ViUm93IiwicHVzaCIsInN1YkluZGV4IiwiYnVpbGRTdWJJbmRleGVzIiwiaW5kZXhlcyIsInN1Yk9iamVjdCIsImFycmF5T2ZPYmpzIiwicm93IiwiaSIsInRhYmxlQ2FjaGUiLCJjb2wiLCJidWNrZXQiLCJub2RlUGF0aCIsIl9leHRyYWN0QXNzb2NpYXRpb25zIiwiZGF0YSIsImFzc29jcyIsImZvck93biIsImsiLCJzdGFydHNXaXRoIiwiX2NyZWF0ZUFzc29jc18iLCJrZXlWYWx1ZSIsImFzc29jTWV0YSIsImFzc29jTW9kZWwiLCJjYXN0QXJyYXkiLCJpdGVtIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxjQUFMO0FBQXFCQyxFQUFBQTtBQUFyQixJQUFvQ0osSUFBMUM7O0FBRUEsTUFBTTtBQUFFSyxFQUFBQTtBQUFGLElBQWVKLE9BQU8sQ0FBQyxPQUFELENBQTVCOztBQUNBLE1BQU1LLFdBQVcsR0FBR0wsT0FBTyxDQUFDLG1CQUFELENBQTNCOztBQUNBLE1BQU07QUFBRU0sRUFBQUEsZ0JBQUY7QUFBb0JDLEVBQUFBO0FBQXBCLElBQXNDUCxPQUFPLENBQUMsY0FBRCxDQUFuRDs7QUFDQSxNQUFNUSxLQUFLLEdBQUdSLE9BQU8sQ0FBQyxhQUFELENBQXJCOztBQUtBLE1BQU1TLGdCQUFOLFNBQStCSixXQUEvQixDQUEyQztBQUN2QyxhQUFXSyxnQkFBWCxHQUE4QjtBQUMxQixRQUFJQyxNQUFNLEdBQUcsS0FBS0MsSUFBTCxDQUFVQyxRQUFWLENBQW1CRixNQUFoQztBQUNBLFdBQU9BLE1BQU0sSUFBSSxLQUFLQyxJQUFMLENBQVVFLE1BQVYsQ0FBaUJILE1BQU0sQ0FBQ0ksS0FBeEIsRUFBK0JDLGVBQWhEO0FBQ0g7O0FBTUQsU0FBT0MscUJBQVAsQ0FBNkJDLElBQTdCLEVBQW1DO0FBQy9CLFFBQUlBLElBQUksS0FBSyxLQUFiLEVBQW9CO0FBQ2hCLGFBQU8sS0FBS0Ms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QUFMLENBQVVNLElBQUssSUFBL0UsQ0FBTjtBQUNIOztBQUVELFVBQUk4SSxVQUFVLEdBQUcsS0FBSzdJLEVBQUwsQ0FBUTRGLEtBQVIsQ0FBY2dELFNBQVMsQ0FBQ2pFLE1BQXhCLENBQWpCOztBQUVBLFVBQUlpRSxTQUFTLENBQUM1QixJQUFkLEVBQW9CO0FBQ2hCcUIsUUFBQUEsSUFBSSxHQUFHdkosQ0FBQyxDQUFDZ0ssU0FBRixDQUFZVCxJQUFaLENBQVA7QUFFQSxlQUFPckosVUFBVSxDQUFDcUosSUFBRCxFQUFPVSxJQUFJLElBQUlGLFVBQVUsQ0FBQzVILE9BQVgsQ0FBbUIsRUFBRSxHQUFHOEgsSUFBTDtBQUFXLGNBQUlILFNBQVMsQ0FBQ2hKLEtBQVYsR0FBa0I7QUFBRSxhQUFDZ0osU0FBUyxDQUFDaEosS0FBWCxHQUFtQitJO0FBQXJCLFdBQWxCLEdBQW9ELEVBQXhEO0FBQVgsU0FBbkIsRUFBNkZsSCxPQUFPLENBQUNLLGFBQXJHLEVBQW9ITCxPQUFPLENBQUNhLFdBQTVILENBQWYsQ0FBakI7QUFDSDs7QUFFRCxhQUFPdUcsVUFBVSxDQUFDNUgsT0FBWCxDQUFtQixFQUFFLEdBQUdvSCxJQUFMO0FBQVcsWUFBSU8sU0FBUyxDQUFDaEosS0FBVixHQUFrQjtBQUFFLFdBQUNnSixTQUFTLENBQUNoSixLQUFYLEdBQW1CK0k7QUFBckIsU0FBbEIsR0FBb0QsRUFBeEQ7QUFBWCxPQUFuQixFQUE2RmxILE9BQU8sQ0FBQ0ssYUFBckcsRUFBb0hMLE9BQU8sQ0FBQ2EsV0FBNUgsQ0FBUDtBQUNILEtBZmdCLENBQWpCO0FBZ0JIOztBQXhmc0M7O0FBMmYzQzBHLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjNKLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgc2V0VmFsdWVCeVBhdGgsIGVhY2hBc3luY18gfSA9IFV0aWw7XG5cbmNvbnN0IHsgRGF0ZVRpbWUgfSA9IHJlcXVpcmUoJ2x1eG9uJyk7XG5jb25zdCBFbnRpdHlNb2RlbCA9IHJlcXVpcmUoJy4uLy4uL0VudGl0eU1vZGVsJyk7XG5jb25zdCB7IE9vbG9uZ1VzYWdlRXJyb3IsIEJ1c2luZXNzRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL0Vycm9ycycpO1xuY29uc3QgVHlwZXMgPSByZXF1aXJlKCcuLi8uLi90eXBlcycpO1xuXG4vKipcbiAqIE15U1FMIGVudGl0eSBtb2RlbCBjbGFzcy5cbiAqL1xuY2xhc3MgTXlTUUxFbnRpdHlNb2RlbCBleHRlbmRzIEVudGl0eU1vZGVsIHsgICAgXG4gICAgc3RhdGljIGdldCBoYXNBdXRvSW5jcmVtZW50KCkge1xuICAgICAgICBsZXQgYXV0b0lkID0gdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZDtcbiAgICAgICAgcmV0dXJuIGF1dG9JZCAmJiB0aGlzLm1ldGEuZmllbGRzW2F1dG9JZC5maWVsZF0uYXV0b0luY3JlbWVudElkOyAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXJpYWxpemUgdmFsdWUgaW50byBkYXRhYmFzZSBhY2NlcHRhYmxlIGZvcm1hdC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gbmFtZSAtIE5hbWUgb2YgdGhlIHN5bWJvbCB0b2tlbiBcbiAgICAgKi9cbiAgICBzdGF0aWMgX3RyYW5zbGF0ZVN5bWJvbFRva2VuKG5hbWUpIHtcbiAgICAgICAgaWYgKG5hbWUgPT09ICdub3cnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYi5jb25uZWN0b3IucmF3KCdOT1coKScpO1xuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdub3Qgc3VwcG9ydCcpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfc2VyaWFsaXplKHZhbHVlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlID8gMSA6IDA7XG5cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZVRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b0lTTyh7IGluY2x1ZGVPZmZzZXQ6IGZhbHNlIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gICAgXG5cbiAgICBzdGF0aWMgX3NlcmlhbGl6ZUJ5VHlwZSh2YWx1ZSwgaW5mbykge1xuICAgICAgICBpZiAoaW5mby50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IDEgOiAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGluZm8udHlwZSA9PT0gJ2RhdGV0aW1lJyAmJiB2YWx1ZSBpbnN0YW5jZW9mIERhdGVUaW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbmZvLnR5cGUgPT09ICdhcnJheScgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGlmIChpbmZvLmNzdikge1xuICAgICAgICAgICAgICAgIHJldHVybiBUeXBlcy5BUlJBWS50b0Nzdih2YWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBUeXBlcy5BUlJBWS5zZXJpYWxpemUodmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0gICAgXG5cbiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlXyguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIuY3JlYXRlXyguLi5hcmdzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBlcnJvckNvZGUgPSBlcnJvci5jb2RlO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAnRVJfTk9fUkVGRVJFTkNFRF9ST1dfMicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcignVGhlIG5ldyBlbnRpdHkgaXMgcmVmZXJlbmNpbmcgdG8gYW4gdW5leGlzdGluZyBlbnRpdHkuIERldGFpbDogJyArIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSArIGAgd2hpbGUgY3JlYXRpbmcgYSBuZXcgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVPbmVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci51cGRhdGVPbmVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBiZWZvcmVDcmVhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFBvc3QgY3JlYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29udGV4dC5jcmVhdGVPcHRpb25zXSAtIENyZWF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjcmVhdGVPcHRpb25zLiRyZXRyaWV2ZUNyZWF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlckNyZWF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAodGhpcy5oYXNBdXRvSW5jcmVtZW50KSB7XG4gICAgICAgICAgICBsZXQgeyBpbnNlcnRJZCB9ID0gY29udGV4dC5yZXN1bHQ7XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdFt0aGlzLm1ldGEuZmVhdHVyZXMuYXV0b0lkLmZpZWxkXSA9IGluc2VydElkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQuY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkKSB7XG4gICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gdGhpcy5nZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbShjb250ZXh0LmxhdGVzdCk7XG4gICAgICAgICAgICBsZXQgcmV0cmlldmVPcHRpb25zID0gXy5pc1BsYWluT2JqZWN0KGNvbnRleHQuY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkKSA/IGNvbnRleHQuY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkIDoge307XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAuLi5yZXRyaWV2ZU9wdGlvbnMsICRxdWVyeTogY29uZGl0aW9uIH0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdCB1cGRhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFt1cGRhdGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFt1cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IHVwZGF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlclVwZGF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWQpIHsgICAgXG4gICAgICAgICAgICBsZXQgY29uZGl0aW9uID0geyAkcXVlcnk6IGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcXVlcnkgfTtcbiAgICAgICAgICAgIGlmIChjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJGJ5UGFzc0Vuc3VyZVVuaXF1ZSkge1xuICAgICAgICAgICAgICAgIGNvbmRpdGlvbi4kYnlQYXNzRW5zdXJlVW5pcXVlID0gY29udGV4dC51cGRhdGVPcHRpb25zLiRieVBhc3NFbnN1cmVVbmlxdWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXRyaWV2ZU9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZCkpIHtcbiAgICAgICAgICAgICAgICByZXRyaWV2ZU9wdGlvbnMgPSBjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZWxhdGlvbnNoaXBzKSB7XG4gICAgICAgICAgICAgICAgcmV0cmlldmVPcHRpb25zLiRyZWxhdGlvbnNoaXBzID0gY29udGV4dC51cGRhdGVPcHRpb25zLiRyZWxhdGlvbnNoaXBzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAuLi5yZXRyaWV2ZU9wdGlvbnMsIC4uLmNvbmRpdGlvbiB9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgdXBkYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9uc10gLSBVcGRhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSB1cGRhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJVcGRhdGVNYW55Xyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZCkgeyAgICBcbiAgICAgICAgICAgIGxldCByZXRyaWV2ZU9wdGlvbnMgPSB7fTtcblxuICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZCkpIHtcbiAgICAgICAgICAgICAgICByZXRyaWV2ZU9wdGlvbnMgPSBjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZWxhdGlvbnNoaXBzKSB7XG4gICAgICAgICAgICAgICAgcmV0cmlldmVPcHRpb25zLiRyZWxhdGlvbnNoaXBzID0gY29udGV4dC51cGRhdGVPcHRpb25zLiRyZWxhdGlvbnNoaXBzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZEFsbF8oeyAuLi5yZXRyaWV2ZU9wdGlvbnMsICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSB9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgZGVsZXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0ICAgICAgXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGFmdGVyRGVsZXRlXyhjb250ZXh0KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgZGVsZXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0ICAgICAgXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGFmdGVyRGVsZXRlTWFueV8oY29udGV4dCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJGaW5kQWxsXyhjb250ZXh0LCByZWNvcmRzKSB7XG4gICAgICAgIGlmIChjb250ZXh0LmZpbmRPcHRpb25zLiR0b0RpY3Rpb25hcnkpIHJldHVybiByZWNvcmRzLnJlZHVjZSgodGFibGUsIHYpID0+IHtcbiAgICAgICAgICAgIHRhYmxlW3ZbdGhpcy5tZXRhLmtleUZpZWxkXV0gPSB2O1xuICAgICAgICAgICAgcmV0dXJuIHRhYmxlO1xuICAgICAgICB9LCB7fSk7XG5cbiAgICAgICAgcmV0dXJuIHJlY29yZHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQmVmb3JlIGRlbGV0aW5nIGFuIGVudGl0eS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmRlbGV0ZU9wdGlvbnNdIC0gRGVsZXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2RlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZF0gLSBSZXRyaWV2ZSB0aGUgcmVjZW50bHkgZGVsZXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGJlZm9yZURlbGV0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghY29udGV4dC5jb25uT3B0aW9ucyB8fCAhY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucyB8fCAoY29udGV4dC5jb25uT3B0aW9ucyA9IHt9KTtcblxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmJlZ2luVHJhbnNhY3Rpb25fKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXRyaWV2ZU9wdGlvbnMgPSBfLmlzUGxhaW5PYmplY3QoY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQpID8gXG4gICAgICAgICAgICAgICAgY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQgOlxuICAgICAgICAgICAgICAgIHt9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmV4aXN0aW5nID0gYXdhaXQgdGhpcy5maW5kT25lXyh7IC4uLnJldHJpZXZlT3B0aW9ucywgJHF1ZXJ5OiBjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHF1ZXJ5IH0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGJlZm9yZURlbGV0ZU1hbnlfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIWNvbnRleHQuY29ubk9wdGlvbnMgfHwgIWNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMgfHwgKGNvbnRleHQuY29ubk9wdGlvbnMgPSB7fSk7XG5cbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5iZWdpblRyYW5zYWN0aW9uXygpOyAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmV0cmlldmVPcHRpb25zID0gXy5pc1BsYWluT2JqZWN0KGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkKSA/IFxuICAgICAgICAgICAgICAgIGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkIDpcbiAgICAgICAgICAgICAgICB7fTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGF3YWl0IHRoaXMuZmluZEFsbF8oeyAuLi5yZXRyaWV2ZU9wdGlvbnMsICRxdWVyeTogY29udGV4dC5kZWxldGVPcHRpb25zLiRxdWVyeSB9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7Kn0gZmluZE9wdGlvbnMgXG4gICAgICovXG4gICAgc3RhdGljIF9wcmVwYXJlQXNzb2NpYXRpb25zKGZpbmRPcHRpb25zKSB7IFxuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gXy51bmlxKGZpbmRPcHRpb25zLiRhc3NvY2lhdGlvbikuc29ydCgpOyAgICAgICAgXG4gICAgICAgIGxldCBhc3NvY1RhYmxlID0ge30sIGNvdW50ZXIgPSAwLCBjYWNoZSA9IHt9OyAgICAgICBcblxuICAgICAgICBhc3NvY2lhdGlvbnMuZm9yRWFjaChhc3NvYyA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFzc29jKSkge1xuICAgICAgICAgICAgICAgIGFzc29jID0gdGhpcy5fdHJhbnNsYXRlU2NoZW1hTmFtZVRvRGIoYXNzb2MpO1xuXG4gICAgICAgICAgICAgICAgbGV0IGFsaWFzID0gYXNzb2MuYWxpYXM7XG4gICAgICAgICAgICAgICAgaWYgKCFhc3NvYy5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICBhbGlhcyA9ICc6am9pbicgKyArK2NvdW50ZXI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXNzb2NUYWJsZVthbGlhc10gPSB7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiBhc3NvYy50eXBlLCBcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiBhc3NvYy5vdXRwdXQsXG4gICAgICAgICAgICAgICAgICAgIGtleTogYXNzb2Mua2V5LFxuICAgICAgICAgICAgICAgICAgICBhbGlhcyxcbiAgICAgICAgICAgICAgICAgICAgb246IGFzc29jLm9uLFxuICAgICAgICAgICAgICAgICAgICAuLi4oYXNzb2MuZGF0YXNldCA/IHRoaXMuZGIuY29ubmVjdG9yLmJ1aWxkUXVlcnkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzb2MuZW50aXR5LCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcmVwYXJlUXVlcmllcyh7IC4uLmFzc29jLmRhdGFzZXQsICR2YXJpYWJsZXM6IGZpbmRPcHRpb25zLiR2YXJpYWJsZXMgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkgOiB7fSkgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX2xvYWRBc3NvY0ludG9UYWJsZShhc3NvY1RhYmxlLCBjYWNoZSwgYXNzb2MpO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHJldHVybiBhc3NvY1RhYmxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7Kn0gYXNzb2NUYWJsZSAtIEhpZXJhcmNoeSB3aXRoIHN1YkFzc29jc1xuICAgICAqIEBwYXJhbSB7Kn0gY2FjaGUgLSBEb3R0ZWQgcGF0aCBhcyBrZXlcbiAgICAgKiBAcGFyYW0geyp9IGFzc29jIC0gRG90dGVkIHBhdGhcbiAgICAgKi9cbiAgICBzdGF0aWMgX2xvYWRBc3NvY0ludG9UYWJsZShhc3NvY1RhYmxlLCBjYWNoZSwgYXNzb2MpIHtcbiAgICAgICAgaWYgKGNhY2hlW2Fzc29jXSkgcmV0dXJuIGNhY2hlW2Fzc29jXTtcblxuICAgICAgICBsZXQgbGFzdFBvcyA9IGFzc29jLmxhc3RJbmRleE9mKCcuJyk7ICAgICAgICBcbiAgICAgICAgbGV0IHJlc3VsdDsgIFxuXG4gICAgICAgIGlmIChsYXN0UG9zID09PSAtMSkgeyAgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBhc3NvY0luZm8gPSB7IC4uLnRoaXMubWV0YS5hc3NvY2lhdGlvbnNbYXNzb2NdIH07ICAgXG4gICAgICAgICAgICBpZiAoIWFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBFbnRpdHkgXCIke3RoaXMubWV0YS5uYW1lfVwiIGRvZXMgbm90IGhhdmUgdGhlIGFzc29jaWF0aW9uIFwiJHthc3NvY31cIi5gKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXN1bHQgPSBjYWNoZVthc3NvY10gPSBhc3NvY1RhYmxlW2Fzc29jXSA9IHsgLi4udGhpcy5fdHJhbnNsYXRlU2NoZW1hTmFtZVRvRGIoYXNzb2NJbmZvKSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGJhc2UgPSBhc3NvYy5zdWJzdHIoMCwgbGFzdFBvcyk7XG4gICAgICAgICAgICBsZXQgbGFzdCA9IGFzc29jLnN1YnN0cihsYXN0UG9zKzEpOyAgICAgICAgIFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGJhc2VOb2RlID0gY2FjaGVbYmFzZV07XG4gICAgICAgICAgICBpZiAoIWJhc2VOb2RlKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGJhc2VOb2RlID0gdGhpcy5fbG9hZEFzc29jSW50b1RhYmxlKGFzc29jVGFibGUsIGNhY2hlLCBiYXNlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMuZGIubW9kZWwoYmFzZU5vZGUuZW50aXR5KTtcbiAgICAgICAgICAgIGxldCBhc3NvY0luZm8gPXsgLi4uZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2xhc3RdIH07XG4gICAgICAgICAgICBpZiAoIWFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBFbnRpdHkgXCIke2VudGl0eS5tZXRhLm5hbWV9XCIgZG9lcyBub3QgaGF2ZSB0aGUgYXNzb2NpYXRpb24gXCIke2Fzc29jfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXN1bHQgPSB7IC4uLnRoaXMuX3RyYW5zbGF0ZVNjaGVtYU5hbWVUb0RiKGFzc29jSW5mbykgfTtcblxuICAgICAgICAgICAgaWYgKCFiYXNlTm9kZS5zdWJBc3NvY3MpIHtcbiAgICAgICAgICAgICAgICBiYXNlTm9kZS5zdWJBc3NvY3MgPSB7fTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGNhY2hlW2Fzc29jXSA9IGJhc2VOb2RlLnN1YkFzc29jc1tsYXN0XSA9IHJlc3VsdDtcbiAgICAgICAgfSAgICAgIFxuXG4gICAgICAgIGlmIChyZXN1bHQuYXNzb2MpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvYWRBc3NvY0ludG9UYWJsZShhc3NvY1RhYmxlLCBjYWNoZSwgYXNzb2MgKyAnLicgKyByZXN1bHQuYXNzb2MpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3RyYW5zbGF0ZVNjaGVtYU5hbWVUb0RiKGFzc29jKSB7XG4gICAgICAgIGlmIChhc3NvYy5lbnRpdHkuaW5kZXhPZignLicpID4gMCkge1xuICAgICAgICAgICAgbGV0IFsgc2NoZW1hTmFtZSwgZW50aXR5TmFtZSBdID0gYXNzb2MuZW50aXR5LnNwbGl0KCcuJywgMik7XG5cbiAgICAgICAgICAgIGxldCBhcHAgPSB0aGlzLmRiLmFwcDtcbiAgICAgICAgICAgIGlmICghYXBwKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoJ0Nyb3NzIGRiIGFzc29jaWF0aW9uIHJlcXVpcmVzIHRoZSBkYiBvYmplY3QgaGF2ZSBhY2Nlc3MgdG8gb3RoZXIgZGIgb2JqZWN0LicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVmRGIgPSBhcHAuZGIoc2NoZW1hTmFtZSk7XG4gICAgICAgICAgICBpZiAoIXJlZkRiKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBUaGUgcmVmZXJlbmNlZCBzY2hlbWEgXCIke3NjaGVtYU5hbWV9XCIgZG9lcyBub3QgaGF2ZSBkYiBtb2RlbCBpbiB0aGUgc2FtZSBhcHBsaWNhdGlvbi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXNzb2MuZW50aXR5ID0gcmVmRGIuY29ubmVjdG9yLmRhdGFiYXNlICsgJy4nICsgZW50aXR5TmFtZTtcblxuICAgICAgICAgICAgaWYgKCFhc3NvYy5rZXkpIHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSByZWZEYi5tb2RlbChlbnRpdHlOYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKGBGYWlsZWQgbG9hZCB0aGUgZW50aXR5IG1vZGVsIFwiJHtzY2hlbWFOYW1lfS4ke2VudGl0eU5hbWV9XCIuYCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXNzb2Mua2V5ID0gbW9kZWwubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICghYXNzb2Mua2V5KSB7XG4gICAgICAgICAgICBhc3NvYy5rZXkgPSB0aGlzLmRiLm1vZGVsKGFzc29jLmVudGl0eSkubWV0YS5rZXlGaWVsZDsgICAgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXNzb2M7XG4gICAgfVxuXG4gICAgc3RhdGljIF9tYXBSZWNvcmRzVG9PYmplY3RzKFtyb3dzLCBjb2x1bW5zLCBhbGlhc01hcF0sIGhpZXJhcmNoeSkge1xuICAgICAgICBsZXQgbWFpbkluZGV4ID0ge307ICAgICAgICBcblxuICAgICAgICBmdW5jdGlvbiBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChhc3NvY2lhdGlvbnMsICh7IHNxbCwga2V5LCBsaXN0LCBzdWJBc3NvY3MgfSwgYW5jaG9yKSA9PiB7IFxuICAgICAgICAgICAgICAgIGlmIChzcWwpIHJldHVybjsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIGxldCBvYmpLZXkgPSAnOicgKyBhbmNob3I7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJPYmogPSByb3dPYmplY3Rbb2JqS2V5XVxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleGVzID0gZXhpc3RpbmdSb3cuc3ViSW5kZXhlc1tvYmpLZXldO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIGpvaW5lZCBhbiBlbXB0eSByZWNvcmRcbiAgICAgICAgICAgICAgICBsZXQgcm93S2V5ID0gc3ViT2JqW2tleV07XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwocm93S2V5KSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nU3ViUm93ID0gc3ViSW5kZXhlcyAmJiBzdWJJbmRleGVzW3Jvd0tleV07XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nU3ViUm93KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nU3ViUm93LCBzdWJPYmosIHN1YkFzc29jcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBsaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSb3cucm93T2JqZWN0W29iaktleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUm93LnJvd09iamVjdFtvYmpLZXldLnB1c2goc3ViT2JqKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUm93LnJvd09iamVjdFtvYmpLZXldID0gWyBzdWJPYmogXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdDogc3ViT2JqICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXguc3ViSW5kZXhlcyA9IGJ1aWxkU3ViSW5kZXhlcyhzdWJPYmosIHN1YkFzc29jcylcbiAgICAgICAgICAgICAgICAgICAgfSAgICBcblxuICAgICAgICAgICAgICAgICAgICBzdWJJbmRleGVzW3Jvd0tleV0gPSBzdWJJbmRleDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gYnVpbGRTdWJJbmRleGVzKHJvd09iamVjdCwgYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXhlcyA9IHt9O1xuXG4gICAgICAgICAgICBfLmVhY2goYXNzb2NpYXRpb25zLCAoeyBzcWwsIGtleSwgbGlzdCwgc3ViQXNzb2NzIH0sIGFuY2hvcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzcWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFzc2VydDoga2V5O1xuXG4gICAgICAgICAgICAgICAgbGV0IG9iaktleSA9ICc6JyArIGFuY2hvcjtcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqZWN0ID0gcm93T2JqZWN0W29iaktleV07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdDogc3ViT2JqZWN0IFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBpZiAobGlzdCkgeyAgIFxuICAgICAgICAgICAgICAgICAgICAvL21hbnkgdG8gKiAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHN1Yk9iamVjdFtrZXldKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9zdWJPYmplY3Qgbm90IGV4aXN0LCBqdXN0IGZpbGxlZCB3aXRoIG51bGwgYnkgam9pbmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W29iaktleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rbb2JqS2V5XSA9IFsgc3ViT2JqZWN0IF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN1Yk9iamVjdCAmJiBfLmlzTmlsKHN1Yk9iamVjdFtrZXldKSkge1xuICAgICAgICAgICAgICAgICAgICBzdWJPYmplY3QgPSByb3dPYmplY3Rbb2JqS2V5XSA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHN1Yk9iamVjdCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iamVjdCwgc3ViQXNzb2NzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXNbb2JqS2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFtzdWJPYmplY3Rba2V5XV06IHN1YkluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7ICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGluZGV4ZXM7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXJyYXlPZk9ianMgPSBbXTtcblxuICAgICAgICAvL3Byb2Nlc3MgZWFjaCByb3dcbiAgICAgICAgcm93cy5mb3JFYWNoKChyb3csIGkpID0+IHtcbiAgICAgICAgICAgIGxldCByb3dPYmplY3QgPSB7fTsgLy8gaGFzaC1zdHlsZSBkYXRhIHJvd1xuICAgICAgICAgICAgbGV0IHRhYmxlQ2FjaGUgPSB7fTsgLy8gZnJvbSBhbGlhcyB0byBjaGlsZCBwcm9wIG9mIHJvd09iamVjdFxuXG4gICAgICAgICAgICByb3cucmVkdWNlKChyZXN1bHQsIHZhbHVlLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbCA9IGNvbHVtbnNbaV07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGNvbC50YWJsZSA9PT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjb2wubmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJ1Y2tldCA9IHRhYmxlQ2FjaGVbY29sLnRhYmxlXTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVja2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2FscmVhZHkgbmVzdGVkIGluc2lkZSBcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1Y2tldFtjb2wubmFtZV0gPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vZGVQYXRoID0gYWxpYXNNYXBbY29sLnRhYmxlXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSB7IFtjb2wubmFtZV06IHZhbHVlIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVDYWNoZVtjb2wudGFibGVdID0gc3ViT2JqZWN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlQnlQYXRoKHJlc3VsdCwgbm9kZVBhdGgsIHN1Yk9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSwgcm93T2JqZWN0KTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcm93S2V5ID0gcm93T2JqZWN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG4gICAgICAgICAgICBsZXQgZXhpc3RpbmdSb3cgPSBtYWluSW5kZXhbcm93S2V5XTtcbiAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdykge1xuICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGhpZXJhcmNoeSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFycmF5T2ZPYmpzLnB1c2gocm93T2JqZWN0KTtcbiAgICAgICAgICAgICAgICBtYWluSW5kZXhbcm93S2V5XSA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdCwgXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXM6IGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGhpZXJhcmNoeSlcbiAgICAgICAgICAgICAgICB9OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFycmF5T2ZPYmpzO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZXh0cmFjdEFzc29jaWF0aW9ucyhkYXRhKSB7XG4gICAgICAgIGxldCByYXcgPSB7fSwgYXNzb2NzID0ge307XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihkYXRhLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgaWYgKGsuc3RhcnRzV2l0aCgnOicpKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NzW2suc3Vic3RyKDEpXSA9IHY7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJhd1trXSA9IHY7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIFsgcmF3LCBhc3NvY3MgXTsgICAgICAgIFxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBfY3JlYXRlQXNzb2NzXyhjb250ZXh0LCBhc3NvY3MpIHtcbiAgICAgICAgbGV0IG1ldGEgPSB0aGlzLm1ldGEuYXNzb2NpYXRpb25zO1xuICAgICAgICBsZXQga2V5VmFsdWUgPSBjb250ZXh0LmxhdGVzdFt0aGlzLm1ldGEua2V5RmllbGRdO1xuXG4gICAgICAgIGlmIChfLmlzTmlsKGtleVZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgcHJpbWFyeSBrZXkgZmllbGQgdmFsdWUuIEVudGl0eTogJyArIHRoaXMubWV0YS5uYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlYWNoQXN5bmNfKGFzc29jcywgYXN5bmMgKGRhdGEsIGFuY2hvcikgPT4ge1xuICAgICAgICAgICAgbGV0IGFzc29jTWV0YSA9IG1ldGFbYW5jaG9yXTtcbiAgICAgICAgICAgIGlmICghYXNzb2NNZXRhKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gXCIke2FuY2hvcn1cIiBvZiBlbnRpdHkgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBsZXQgYXNzb2NNb2RlbCA9IHRoaXMuZGIubW9kZWwoYXNzb2NNZXRhLmVudGl0eSk7XG5cbiAgICAgICAgICAgIGlmIChhc3NvY01ldGEubGlzdCkge1xuICAgICAgICAgICAgICAgIGRhdGEgPSBfLmNhc3RBcnJheShkYXRhKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlYWNoQXN5bmNfKGRhdGEsIGl0ZW0gPT4gYXNzb2NNb2RlbC5jcmVhdGVfKHsgLi4uaXRlbSwgLi4uKGFzc29jTWV0YS5maWVsZCA/IHsgW2Fzc29jTWV0YS5maWVsZF06IGtleVZhbHVlIH0gOiB7fSkgfSwgY29udGV4dC5jcmVhdGVPcHRpb25zLCBjb250ZXh0LmNvbm5PcHRpb25zKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBhc3NvY01vZGVsLmNyZWF0ZV8oeyAuLi5kYXRhLCAuLi4oYXNzb2NNZXRhLmZpZWxkID8geyBbYXNzb2NNZXRhLmZpZWxkXToga2V5VmFsdWUgfSA6IHt9KSB9LCBjb250ZXh0LmNyZWF0ZU9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpOyAgXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTEVudGl0eU1vZGVsOyJdfQ==