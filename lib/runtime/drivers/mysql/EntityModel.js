"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static serialize(dataRecord) {
    _.forOwn(dataRecord, (value, fieldName) => {
      let fieldMeta = this.meta.fields[fieldName];

      if (fieldMeta.type === 'datetime') {
        if (typeof value === 'object' && value.oolType === 'SymbolToken') {
          if (value.name === 'now') {
            dataRecord[fieldName] = this.db.connector.raw('NOW()');
          }
        }

        if (value instanceof DateTime) {
          dataRecord[fieldName] = value.toISO({
            includeOffset: false
          });
        }
      } else if (fieldMeta.type === 'boolean') {
        dataRecord[fieldName] = dataRecord[fieldName] ? 1 : 0;
      }
    });
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(associations) {
    associations = associations.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor,
        isList: assocInfo.isList,
        optional: assocInfo.optional
      };

      if (assocInfo.connectedBy) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
        detail.entity = assocInfo.connectedBy;
        detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;

        if (assocInfo.connectedWith) {
          detail.connectedWith = assocInfo.connectedWith;
        }

        detail.subAssociations = [{
          entity: remoteEntityName,
          keyField: remoteEntity.meta.keyField,
          joinType: 'LEFT JOIN',
          anchor: assocInfo.refersToField,
          localField: assocInfo.refersToField,
          remoteField: remoteEntity.meta.keyField,
          isList: false
        }];
      } else if (assoc.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
      } else {
        detail.localField = anchor;
        detail.remoteField = remoteEntity.meta.keyField;
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = {
        entity: remoteEntity,
        detail
      };
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            throw new Error('');
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];
            let subObject = {
              [col.name]: value
            };
            tableCache[col.table] = subObject;
            setValueByPath(result, nodePath, subObject);
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJEYXRlVGltZSIsIkVudGl0eU1vZGVsIiwiQnVzaW5lc3NFcnJvciIsIk15U1FMRW50aXR5TW9kZWwiLCJoYXNBdXRvSW5jcmVtZW50IiwiYXV0b0lkIiwibWV0YSIsImZlYXR1cmVzIiwiZmllbGRzIiwiZmllbGQiLCJhdXRvSW5jcmVtZW50SWQiLCJzZXJpYWxpemUiLCJkYXRhUmVjb3JkIiwiZm9yT3duIiwidmFsdWUiLCJmaWVsZE5hbWUiLCJmaWVsZE1ldGEiLCJ0eXBlIiwib29sVHlwZSIsIm5hbWUiLCJkYiIsImNvbm5lY3RvciIsInJhdyIsInRvSVNPIiwiaW5jbHVkZU9mZnNldCIsImNyZWF0ZV8iLCJhcmdzIiwiZXJyb3IiLCJlcnJvckNvZGUiLCJjb2RlIiwibWVzc2FnZSIsInVwZGF0ZV8iLCJhZnRlckNyZWF0ZV8iLCJjb250ZXh0IiwiaW5zZXJ0SWQiLCJyZXN1bHQiLCJsYXRlc3QiLCJjcmVhdGVPcHRpb25zIiwiJHJldHJpZXZlQ3JlYXRlZCIsImNvbmRpdGlvbiIsImdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tIiwiZmluZE9uZV8iLCIkcXVlcnkiLCIkdW5ib3hpbmciLCJjb25uT3B0aW9ucyIsImFmdGVyVXBkYXRlXyIsInVwZGF0ZU9wdGlvbnMiLCIkcmV0cmlldmVVcGRhdGVkIiwiYmVmb3JlRGVsZXRlXyIsImRlbGV0ZU9wdGlvbnMiLCIkcmV0cmlldmVEZWxldGVkIiwiY29ubmVjdGlvbiIsImJlZ2luVHJhbnNhY3Rpb25fIiwiZXhpc3RpbmciLCJfcHJlcGFyZUFzc29jaWF0aW9ucyIsImFzc29jaWF0aW9ucyIsImNvbmNhdCIsInNvcnQiLCJjYWNoZSIsImhpZXJhcmNoeSIsImZvckVhY2giLCJhc3NvYyIsInJlbW90ZUVudGl0eSIsImJhc2UiLCJhbmNob3IiLCJhc3NvY0luZm8iLCJfZ2V0UmVsYXRlZEVudGl0eSIsInJlbW90ZUVudGl0eU5hbWUiLCJkZXRhaWwiLCJlbnRpdHkiLCJrZXlGaWVsZCIsImpvaW5UeXBlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJjb25uZWN0ZWRCeSIsImxvY2FsRmllbGQiLCJyZW1vdGVGaWVsZCIsIm1vZGVsIiwiY29ubmVjdGVkV2l0aCIsInN1YkFzc29jaWF0aW9ucyIsInJlZmVyc1RvRmllbGQiLCJwdXNoIiwiYXNzb2NQYXRoIiwicGFydHMiLCJzcGxpdCIsInNsaWNlIiwiam9pbiIsImNhY2hlTm9kZSIsImxhc3QiLCJwb3AiLCJjdXJyZW50IiwiY3VycmVudEFzc29jSW5mbyIsImxlbmd0aCIsInNoaWZ0IiwiX21hcFJlY29yZHNUb09iamVjdHMiLCJyb3dzIiwiY29sdW1ucyIsImFsaWFzTWFwIiwibWFpbkluZGV4IiwibWVyZ2VSZWNvcmQiLCJleGlzdGluZ1JvdyIsInJvd09iamVjdCIsImVhY2giLCJrZXkiLCJzdWJPYmoiLCJzdWJJbmRleGVzIiwicm93S2V5IiwiaXNOaWwiLCJleGlzdGluZ1N1YlJvdyIsIkVycm9yIiwic3ViSW5kZXgiLCJidWlsZFN1YkluZGV4ZXMiLCJyZWR1Y2UiLCJpbmRleGVzIiwic3ViT2JqZWN0IiwiYXJyYXlPZk9ianMiLCJyb3ciLCJ0YWJsZUNhY2hlIiwiaSIsImNvbCIsInRhYmxlIiwiYnVja2V0Iiwibm9kZVBhdGgiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBd0JILElBQTlCOztBQUVBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUFlSCxPQUFPLENBQUMsT0FBRCxDQUE1Qjs7QUFDQSxNQUFNSSxXQUFXLEdBQUdKLE9BQU8sQ0FBQyxtQkFBRCxDQUEzQjs7QUFD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RUFBRU0sZUFBZSxDQUFDVixTQUFELEVBQVkxQyxTQUFaO0FBRlgsU0FBcEI7QUFJSDtBQUNKLEtBbENEO0FBb0NBLFdBQU93RCxXQUFQO0FBQ0g7O0FBdlVzQzs7QUEwVTNDUSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6SCxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIHNldFZhbHVlQnlQYXRoIH0gPSBVdGlsO1xuXG5jb25zdCB7IERhdGVUaW1lIH0gPSByZXF1aXJlKCdsdXhvbicpO1xuY29uc3QgRW50aXR5TW9kZWwgPSByZXF1aXJlKCcuLi8uLi9FbnRpdHlNb2RlbCcpO1xuY29uc3QgeyBCdXNpbmVzc0Vycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBNeVNRTCBlbnRpdHkgbW9kZWwgY2xhc3MuXG4gKi9cbmNsYXNzIE15U1FMRW50aXR5TW9kZWwgZXh0ZW5kcyBFbnRpdHlNb2RlbCB7ICAgIFxuICAgIHN0YXRpYyBnZXQgaGFzQXV0b0luY3JlbWVudCgpIHtcbiAgICAgICAgbGV0IGF1dG9JZCA9IHRoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG4gICAgICAgIHJldHVybiBhdXRvSWQgJiYgdGhpcy5tZXRhLmZpZWxkc1thdXRvSWQuZmllbGRdLmF1dG9JbmNyZW1lbnRJZDsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VyaWFsaXplIHZhbHVlIGludG8gZGF0YWJhc2UgYWNjZXB0YWJsZSBmb3JtYXQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFSZWNvcmQgXG4gICAgICovXG4gICAgc3RhdGljIHNlcmlhbGl6ZShkYXRhUmVjb3JkKSB7XG4gICAgICAgIF8uZm9yT3duKGRhdGFSZWNvcmQsICh2YWx1ZSwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZmllbGRNZXRhID0gdGhpcy5tZXRhLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZmllbGRNZXRhLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5vb2xUeXBlID09PSAnU3ltYm9sVG9rZW4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5uYW1lID09PSAnbm93Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdGhpcy5kYi5jb25uZWN0b3IucmF3KCdOT1coKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZVRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkTWV0YS50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPSBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPyAxIDogMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGNyZWF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLmNyZWF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSArIGAgd2hpbGUgY3JlYXRpbmcgYSBuZXcgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci51cGRhdGVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBQb3N0IGNyZWF0ZSBwcm9jZXNzaW5nLlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuY3JlYXRlT3B0aW9uc10gLSBDcmVhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSBjcmVhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJDcmVhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzQXV0b0luY3JlbWVudCkge1xuICAgICAgICAgICAgbGV0IHsgaW5zZXJ0SWQgfSA9IGNvbnRleHQucmVzdWx0O1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZC5maWVsZF0gPSBpbnNlcnRJZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmNyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZCkge1xuICAgICAgICAgICAgbGV0IGNvbmRpdGlvbiA9IHRoaXMuZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20oY29udGV4dC5sYXRlc3QpO1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3QgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb25kaXRpb24sICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdCB1cGRhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFt1cGRhdGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFt1cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IHVwZGF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlclVwZGF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCZWZvcmUgZGVsZXRpbmcgYW4gZW50aXR5LlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuZGVsZXRlT3B0aW9uc10gLSBEZWxldGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkXSAtIFJldHJpZXZlIHRoZSByZWNlbnRseSBkZWxldGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYmVmb3JlRGVsZXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFjb250ZXh0LmNvbm5PcHRpb25zIHx8ICFjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zIHx8IChjb250ZXh0LmNvbm5PcHRpb25zID0ge30pO1xuXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuYmVnaW5UcmFuc2FjdGlvbl8oKTsgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyogICAgICBlbnRpdHk6IDxyZW1vdGUgZW50aXR5PlxuICAgICAqICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU58SU5ORVIgSk9JTnxGVUxMIE9VVEVSIEpPSU4nXG4gICAgICogICAgICBhbmNob3I6ICdsb2NhbCBwcm9wZXJ0eSB0byBwbGFjZSB0aGUgcmVtb3RlIGVudGl0eSdcbiAgICAgKiAgICAgIGxvY2FsRmllbGQ6IDxsb2NhbCBmaWVsZCB0byBqb2luPlxuICAgICAqICAgICAgcmVtb3RlRmllbGQ6IDxyZW1vdGUgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHN1YkFzc29jaWF0aW9uczogeyAuLi4gfSAgKi9cbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoYXNzb2NpYXRpb25zKSB7ICAgXG4gICAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQoKS5zb3J0KCk7XG4gICAgICAgIGxldCBjYWNoZSA9IHt9LCBoaWVyYXJjaHkgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGFzc29jaWF0aW9ucy5mb3JFYWNoKGFzc29jID0+IHtcbiAgICAgICAgICAgIGxldCBbIHJlbW90ZUVudGl0eSwgYmFzZSwgYW5jaG9yLCBhc3NvY0luZm8gXSA9IHRoaXMuX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2MsIGNhY2hlKTtcbiAgICAgICAgICAgIGFzc2VydDogYXNzb2NJbmZvO1xuXG4gICAgICAgICAgICBsZXQgcmVtb3RlRW50aXR5TmFtZSA9IHJlbW90ZUVudGl0eS5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgIGxldCBkZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgYW5jaG9yLFxuICAgICAgICAgICAgICAgIGlzTGlzdDogYXNzb2NJbmZvLmlzTGlzdCxcbiAgICAgICAgICAgICAgICBvcHRpb25hbDogYXNzb2NJbmZvLm9wdGlvbmFsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBjYWNoZVtiYXNlXSA/IGNhY2hlW2Jhc2VdLmVudGl0eS5tZXRhLmtleUZpZWxkIDogdGhpcy5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IGFzc29jSW5mby5yZW1vdGVGaWVsZCB8fCB0aGlzLm1ldGEubmFtZTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5lbnRpdHkgPSBhc3NvY0luZm8uY29ubmVjdGVkQnk7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmtleUZpZWxkID0gdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uY29ubmVjdGVkQnkpLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLmNvbm5lY3RlZFdpdGggPSBhc3NvY0luZm8uY29ubmVjdGVkV2l0aDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBkZXRhaWwuc3ViQXNzb2NpYXRpb25zID0gW1xuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXlGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgICAgICAgICBhbmNob3I6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogYXNzb2NJbmZvLnJlZmVyc1RvRmllbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0xpc3Q6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhc3NvYy5pc0xpc3QpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGNhY2hlW2Jhc2VdID8gY2FjaGVbYmFzZV0uZW50aXR5Lm1ldGEua2V5RmllbGQgOiB0aGlzLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkIHx8IHRoaXMubWV0YS5uYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGFuY2hvcjtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucy5wdXNoKGRldGFpbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucyA9IFsgZGV0YWlsIF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWNoZVthc3NvY10gPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHksXG4gICAgICAgICAgICAgICAgZGV0YWlsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gaGllcmFyY2h5O1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0UmVsYXRlZEVudGl0eShhc3NvY1BhdGgsIGNhY2hlKSB7ICAgICAgICBcbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2NQYXRoLnNwbGl0KCcuJyk7ICAgICAgICBcbiAgICAgICAgbGV0IGJhc2UgPSBwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignLicpOyAgICAgICAgXG5cbiAgICAgICAgbGV0IGNhY2hlTm9kZSA9IGNhY2hlW2Jhc2VdO1xuICAgICAgICBpZiAoY2FjaGVOb2RlKSB7XG4gICAgICAgICAgICBsZXQgbGFzdCA9IHBhcnRzLnBvcCgpO1xuICAgICAgICAgICAgbGV0IGFzc29jSW5mbyA9IGNhY2hlTm9kZS5lbnRpdHkubWV0YS5hc3NvY2lhdGlvbnNbbGFzdF07XG4gICAgICAgICAgICBpZiAoIWFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIG9mIFwiJHt0aGlzLm1ldGEubmFtZX1cIiBlbnRpdHk6ICR7YXNzb2NQYXRofWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gWyB0aGlzLmRiLm1vZGVsKGFzc29jSW5mby5lbnRpdHkpLCBiYXNlLCBsYXN0LCBhc3NvY0luZm8gXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLCBjdXJyZW50LCBjdXJyZW50QXNzb2NJbmZvO1xuXG4gICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjdXJyZW50ID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgICAgIGN1cnJlbnRBc3NvY0luZm8gPSBlbnRpdHkubWV0YS5hc3NvY2lhdGlvbnNbY3VycmVudF07XG4gICAgICAgICAgICBpZiAoIWN1cnJlbnRBc3NvY0luZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBvZiBcIiR7dGhpcy5tZXRhLm5hbWV9XCIgZW50aXR5OiAke2Fzc29jUGF0aH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5ID0gdGhpcy5kYi5tb2RlbChjdXJyZW50QXNzb2NJbmZvLmVudGl0eSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gWyBlbnRpdHksIGJhc2UsIGN1cnJlbnQsIGN1cnJlbnRBc3NvY0luZm8gXTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX21hcFJlY29yZHNUb09iamVjdHMoW3Jvd3MsIGNvbHVtbnMsIGFsaWFzTWFwXSwgaGllcmFyY2h5KSB7XG4gICAgICAgIGxldCBtYWluSW5kZXggPSB7fTtcblxuICAgICAgICBmdW5jdGlvbiBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChhc3NvY2lhdGlvbnMsICh7IGtleUZpZWxkLCBhbmNob3IsIGlzTGlzdCwgc3ViQXNzb2NpYXRpb25zIH0pID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGtleSA9ICc6JyArIGFuY2hvcjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1Yk9iaiA9IHJvd09iamVjdFtrZXldXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ZXMgPSBleGlzdGluZ1Jvdy5zdWJJbmRleGVzW2tleV07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJvd0tleSA9IHN1Yk9ialtrZXlGaWVsZF07XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwocm93S2V5KSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nU3ViUm93ID0gc3ViSW5kZXhlcyAmJiBzdWJJbmRleGVzW3Jvd0tleV07XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nU3ViUm93KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nU3ViUm93LCBzdWJPYmosIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0xpc3QpIHsgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93LnJvd09iamVjdFtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XS5wdXNoKHN1Yk9iaik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqIF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iaiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqLCBzdWJBc3NvY2lhdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlc1tyb3dLZXldID0gc3ViSW5kZXg7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIGFzc29jaWF0aW9ucy5yZWR1Y2UoKGluZGV4ZXMsIHsga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBrZXkgPSAnOicrYW5jaG9yO1xuICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSByb3dPYmplY3Rba2V5XTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmplY3QgXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChpc0xpc3QpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChzdWJPYmplY3Rba2V5RmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W2tleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqZWN0IF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleUZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gcm93T2JqZWN0W2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChzdWJPYmplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXguc3ViSW5kZXhlcyA9IGJ1aWxkU3ViSW5kZXhlcyhzdWJPYmplY3QsIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpbmRleGVzW2tleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBbc3ViT2JqZWN0W2tleUZpZWxkXV06IHN1YkluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ZXM7XG4gICAgICAgICAgICB9LCB7fSk7ICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFycmF5T2ZPYmpzID0gW107XG5cbiAgICAgICAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XG4gICAgICAgICAgICBsZXQgcm93T2JqZWN0ID0ge307IC8vIGhhc2gtc3R5bGUgZGF0YSByb3dcbiAgICAgICAgICAgIGxldCB0YWJsZUNhY2hlID0ge307IC8vIGZyb20gYWxpYXMgdG8gY2hpbGQgcHJvcCBvZiByb3dPYmplY3RcblxuICAgICAgICAgICAgcm93LnJlZHVjZSgocmVzdWx0LCB2YWx1ZSwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2wgPSBjb2x1bW5zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChjb2wudGFibGUgPT09ICdBJykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbY29sLm5hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBidWNrZXQgPSB0YWJsZUNhY2hlW2NvbC50YWJsZV07ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1Y2tldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0W2NvbC5uYW1lXSA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZVBhdGggPSBhbGlhc01hcFtjb2wudGFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHsgW2NvbC5uYW1lXTogdmFsdWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlQ2FjaGVbY29sLnRhYmxlXSA9IHN1Yk9iamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlQnlQYXRoKHJlc3VsdCwgbm9kZVBhdGgsIHN1Yk9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSwgcm93T2JqZWN0KTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcm93S2V5ID0gcm93T2JqZWN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG4gICAgICAgICAgICBsZXQgZXhpc3RpbmdSb3cgPSBtYWluSW5kZXhbcm93S2V5XTtcbiAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdykge1xuICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGhpZXJhcmNoeSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFycmF5T2ZPYmpzLnB1c2gocm93T2JqZWN0KTtcbiAgICAgICAgICAgICAgICBtYWluSW5kZXhbcm93S2V5XSA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdCwgXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXM6IGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGhpZXJhcmNoeSlcbiAgICAgICAgICAgICAgICB9OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFycmF5T2ZPYmpzO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTEVudGl0eU1vZGVsOyJdfQ==