"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static _translateSymbolToken(name) {
    if (name === 'now') {
      return this.db.connector.raw('NOW()');
    }

    throw new Error('not support');
  }

  static _serialize(value) {
    if (typeof value === 'boolean') return value ? 1 : 0;

    if (value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity. Detail: ' + error.message);
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(findOptions) {
    let associations = findOptions.$association.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      if (_.isPlainObject(assoc)) {
        hierarchy.push({
          entity: assoc.entity,
          joinType: assoc.type,
          output: assoc.output,
          ...(assoc.alias ? {
            alias: assoc.alias
          } : {}),
          ...assoc.on,
          ...this.db.connector.buildQuery(assoc.entity, this._prepareQueries({ ...assoc.dataset,
            $variables: findOptions.$variables
          }))
        });
        return;
      }

      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor
      };
      let toCache = {
        entity: remoteEntity,
        detail
      };

      if (assocInfo.isList) {
        detail.isList = true;
      }

      if (assocInfo.optional) {
        detail.optional = true;
      }

      if (assocInfo.connectedBy) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
        detail.entity = assocInfo.connectedBy;
        detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;

        if (assocInfo.connectedWith) {
          detail.connectedWith = assocInfo.connectedWith;
        }

        toCache.detail = {
          entity: remoteEntityName,
          keyField: remoteEntity.meta.keyField,
          joinType: 'LEFT JOIN',
          anchor: assocInfo.refersToField,
          localField: assocInfo.refersToField,
          remoteField: remoteEntity.meta.keyField
        };
        detail.subAssociations = [toCache.detail];
      } else if (assocInfo.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;

        if (assocInfo.remoteFields) {
          detail.remoteFields = assocInfo.remoteFields;
          detail.joinType = 'RIGHT JOIN';
        } else {
          detail.remoteField = assocInfo.remoteField || this.meta.name;
        }
      } else {
        detail.localField = anchor;

        if (assocInfo.remoteFields) {
          detail.remoteFields = assocInfo.remoteFields;
          detail.joinType = 'RIGHT JOIN';
        } else {
          detail.remoteField = remoteEntity.meta.keyField;
        }
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = toCache;
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        sql,
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        if (sql) return;
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            throw new Error("Assertion failed: isList");
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        sql,
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        if (sql) {
          return indexes;
        }

        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];

            if (nodePath) {
              let subObject = {
                [col.name]: value
              };
              tableCache[col.table] = subObject;
              setValueByPath(result, nodePath, subObject);
            }
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      let assocModel;

      if (assocMeta.connectedBy) {
        assocModel = this.db.model(assocMeta.connectedBy);
      } else {
        assocModel = this.db.model(assocMeta.entity);
      }

      if (assocMeta.isList) {
        data = _.castArray(data);
        return eachAsync_(data, item => assocModel.create_({ ...item,
          [assocMeta.remoteField]: keyValue
        }, context.createOptions, context.connOptions));
      }

      return assocModel.create_({ ...data,
        [assocMeta.remoteField]: keyValue
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiRGF0ZVRpbWUiLCJFbnRpdHlNb2RlbCIsIk9vbG9uZ1VzYWdlRXJyb3IiLCJCdXNpbmVzc0Vycm9yIiwiTXlTUUxFbnRpdHlNb2RlbCIsImhhc0F1dG9JbmNyZW1lbnQiLCJhdXRvSWQiLCJtZXRhIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJmaWVsZCIsImF1dG9JbmNyZW1lbnRJZCIsIl90cmFuc2xhdGVTeW1ib2xUb2tlbiIsIm5hbWUiLCJkYiIsImNvbm5lY3RvciIsInJhdyIsIkVycm9yIiwiX3NlcmlhbGl6ZSIsInZhbHVlIiwidG9JU08iLCJpbmNsdWRlT2Zmc2V0IiwiY3JlYXRlXyIsImFyZ3MiLCJlcnJvciIsImVycm9yQ29kZSIsImNvZGUiLCJtZXNzYWdlIiwidXBkYXRlXyIsImFmdGVyQ3JlYXRlXyIsImNvbnRleHQiLCJpbnNlcnRJZCIsInJlc3VsdCIsImxhdGVzdCIsImNyZWF0ZU9wdGlvbnMiLCIkcmV0cmlldmVDcmVhdGVkIiwiY29uZGl0aW9uIiwiZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20iLCJmaW5kT25lXyIsIiRxdWVyeSIsIiR1bmJveGluZyIsImNvbm5PcHRpb25zIiwiYWZ0ZXJVcGRhdGVfIiwidXBkYXRlT3B0aW9ucyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJiZWZvcmVEZWxldGVfIiwiZGVsZXRlT3B0aW9ucyIsIiRyZXRyaWV2ZURlbGV0ZWQiLCJjb25uZWN0aW9uIiwiYmVnaW5UcmFuc2FjdGlvbl8iLCJleGlzdGluZyIsIl9wcmVwYXJlQXNzb2NpYXRpb25zIiwiZmluZE9wdGlvbnMiLCJhc3NvY2lhdGlvbnMiLCIkYXNzb2NpYXRpb24iLCJjb25jYXQiLCJzb3J0IiwiY2FjaGUiLCJoaWVyYXJjaHkiLCJmb3JFYWNoIiwiYXNzb2MiLCJpc1BsYWluT2JqZWN0IiwicHVzaCIsImVudGl0eSIsImpvaW5UeXBlIiwidHlwZSIsIm91dHB1dCIsImFsaWFzIiwib24iLCJidWlsZFF1ZXJ5IiwiX3ByZXBhcmVRdWVyaWVzIiwiZGF0YXNldCIsIiR2YXJpYWJsZXMiLCJyZW1vdGVFbnRpdHkiLCJiYXNlIiwiYW5jaG9yIiwiYXNzb2NJbmZvIiwiX2dldFJlbGF0ZWRFbnRpdHkiLCJyZW1vdGVFbnRpdHlOYW1lIiwiZGV0YWlsIiwia2V5RmllbGQiLCJ0b0NhY2hlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJjb25uZWN0ZWRCeSIsImxvY2FsRmllbGQiLCJyZW1vdGVGaWVsZCIsIm1vZGVsIiwiY29ubmVjdGVkV2l0aCIsInJlZmVyc1RvRmllbGQiLCJzdWJBc3NvY2lhdGlvbnMiLCJyZW1vdGVGaWVsZHMiLCJhc3NvY1BhdGgiLCJwYXJ0cyIsInNwbGl0Iiwic2xpY2UiLCJqb2luIiwiY2FjaGVOb2RlIiwibGFzdCIsInBvcCIsImN1cnJlbnQiLCJjdXJyZW50QXNzb2NJbmZvIiwibGVuZ3RoIiwic2hpZnQiLCJfbWFwUmVjb3Jkc1RvT2JqZWN0cyIsInJvd3MiLCJjb2x1bW5zIiwiYWxpYXNNYXAiLCJtYWluSW5kZXgiLCJtZXJnZVJlY29yZCIsImV4aXN0aW5nUm93Iiwicm93T2JqZWN0IiwiZWFjaCIsInNxbCIsImtleSIsInN1Yk9iaiIsInN1YkluZGV4ZXMiLCJyb3dLZXkiLCJpc05pbCIsImV4aXN0aW5nU3ViUm93Iiwic3ViSW5kZXgiLCJidWlsZFN1YkluZGV4ZXMiLCJyZWR1Y2UiLCJpbmRleGVzIiwic3ViT2JqZWN0IiwiYXJyYXlPZk9ianMiLCJyb3ciLCJ0YWJsZUNhY2hlIiwiaSIsImNvbCIsInRhYmxlIiwiYnVja2V0Iiwibm9kZVBhdGgiLCJfZXh0cmFjdEFzc29jaWF0aW9ucyIsImRhdGEiLCJhc3NvY3MiLCJmb3JPd24iLCJ2IiwiayIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJfY3JlYXRlQXNzb2NzXyIsImtleVZhbHVlIiwiYXNzb2NNZXRhIiwiYXNzb2NNb2RlbCIsImNhc3RBcnJheSIsIml0ZW0iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLGNBQUw7QUFBcUJDLEVBQUFBO0FBQXJCLElBQW9DSixJQUExQzs7QUFFQSxNQUFNO0FBQUVLLEVBQUFBO0FBQUYsSUFBZUosT0FBTyxDQUFDLE9BQUQsQ0FBNUI7O0FBQ0EsTUFBTUssV0FBVyxHQUFHTCxPQUFPLENBQUMsbUJBQUQsQ0FBM0I7O0FBQ0EsTUFBTTtBQUFFTSxFQUFBQSxnQkFBRjtBQUFvQkMsRUFBQUE7QUFBcEIsSUFBc0NQLE9BQU8sQ0FBQyxjQUFELENBQW5EOztBQUtBLE1BQU1RLGdCQUFOLFNBQStCSCxXQUEvQixDQUEyQztBQUN2QyxhQUFXSSxnQkFBWCxHQUE4QjtBQUMxQixRQUFJQyxNQUFNLEdBQUcsS0FBS0MsSUFBTCxDQUFVQyxRQUFWLENBQW1CRixNQUFoQztBQUNBLFdBQU9BLE1BQU0sSUFBSSxLQUFLQyxJQUFMLENBQVVFLE1BQVYsQ0FBaUJILE1BQU0sQ0FBQ0ksS0FBeEIsRUFBK0JDLGVBQWhEO0FBQ0g7O0FBTUQsU0FBT0MscUJBQVAsQ0FBNkJDLElBQTdCLEVBQW1DO0FBQy9CLFFBQUlBLElBQUksS0FBSyxLQUFiLEVBQW9CO0FBQ2hCLGFBQU8sS0FBS0MsRUFBTCxDQUFRQyxTQUFSLENBQWtCQyxHQUFsQixDQUFzQixPQUF0QixDQUFQO0FBQ0g7O0FBRUQsVUFBTSxJQUFJQyxLQUFKLENBQVUsYUFBVixDQUFOO0FBQ0g7O0FBRUQsU0FBT0MsVUFBUCxDQUFrQkMsS0FBbEIsRUFBeUI7QUFDckIsUUFBSSxPQUFPQSxLQUFQLEtBQWlCLFNBQXJCLEVBQWdDLE9BQU9BLEtBQUssR0FBRyxDQUFILEdBQU8sQ0FBbkI7O0FBRWhDLFFBQUlBLEtB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QUFVLENBQUMxSCxPQUFYLENBQW1CLEVBQUUsR0FBR2dILElBQUw7QUFBVyxTQUFDUyxTQUFTLENBQUN6RCxXQUFYLEdBQXlCd0Q7QUFBcEMsT0FBbkIsRUFBbUVoSCxPQUFPLENBQUNJLGFBQTNFLEVBQTBGSixPQUFPLENBQUNXLFdBQWxHLENBQVA7QUFDSCxLQXJCZ0IsQ0FBakI7QUFzQkg7O0FBL1pzQzs7QUFrYTNDMEcsTUFBTSxDQUFDQyxPQUFQLEdBQWlCaEosZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBzZXRWYWx1ZUJ5UGF0aCwgZWFjaEFzeW5jXyB9ID0gVXRpbDtcblxuY29uc3QgeyBEYXRlVGltZSB9ID0gcmVxdWlyZSgnbHV4b24nKTtcbmNvbnN0IEVudGl0eU1vZGVsID0gcmVxdWlyZSgnLi4vLi4vRW50aXR5TW9kZWwnKTtcbmNvbnN0IHsgT29sb25nVXNhZ2VFcnJvciwgQnVzaW5lc3NFcnJvciB9ID0gcmVxdWlyZSgnLi4vLi4vRXJyb3JzJyk7XG5cbi8qKlxuICogTXlTUUwgZW50aXR5IG1vZGVsIGNsYXNzLlxuICovXG5jbGFzcyBNeVNRTEVudGl0eU1vZGVsIGV4dGVuZHMgRW50aXR5TW9kZWwgeyAgICBcbiAgICBzdGF0aWMgZ2V0IGhhc0F1dG9JbmNyZW1lbnQoKSB7XG4gICAgICAgIGxldCBhdXRvSWQgPSB0aGlzLm1ldGEuZmVhdHVyZXMuYXV0b0lkO1xuICAgICAgICByZXR1cm4gYXV0b0lkICYmIHRoaXMubWV0YS5maWVsZHNbYXV0b0lkLmZpZWxkXS5hdXRvSW5jcmVtZW50SWQ7ICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlcmlhbGl6ZSB2YWx1ZSBpbnRvIGRhdGFiYXNlIGFjY2VwdGFibGUgZm9ybWF0LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBuYW1lIC0gTmFtZSBvZiB0aGUgc3ltYm9sIHRva2VuIFxuICAgICAqL1xuICAgIHN0YXRpYyBfdHJhbnNsYXRlU3ltYm9sVG9rZW4obmFtZSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gJ25vdycpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRiLmNvbm5lY3Rvci5yYXcoJ05PVygpJyk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBzdXBwb3J0Jyk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9zZXJpYWxpemUodmFsdWUpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWUgPyAxIDogMDtcblxuICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlVGltZSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvSVNPKHsgaW5jbHVkZU9mZnNldDogZmFsc2UgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGNyZWF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLmNyZWF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LiBEZXRhaWw6ICcgKyBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UgKyBgIHdoaWxlIGNyZWF0aW5nIGEgbmV3IFwiJHt0aGlzLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgdXBkYXRlXyguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIudXBkYXRlXyguLi5hcmdzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBlcnJvckNvZGUgPSBlcnJvci5jb2RlO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAnRVJfTk9fUkVGRVJFTkNFRF9ST1dfMicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcignVGhlIG5ldyBlbnRpdHkgaXMgcmVmZXJlbmNpbmcgdG8gYW4gdW5leGlzdGluZyBlbnRpdHkuJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX0RVUF9FTlRSWScpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogUG9zdCBjcmVhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmNyZWF0ZU9wdGlvbnNdIC0gQ3JlYXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZF0gLSBSZXRyaWV2ZSB0aGUgbmV3bHkgY3JlYXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGFmdGVyQ3JlYXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0F1dG9JbmNyZW1lbnQpIHtcbiAgICAgICAgICAgIGxldCB7IGluc2VydElkIH0gPSBjb250ZXh0LnJlc3VsdDtcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0W3RoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQuZmllbGRdID0gaW5zZXJ0SWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5jcmVhdGVPcHRpb25zLiRyZXRyaWV2ZUNyZWF0ZWQpIHtcbiAgICAgICAgICAgIGxldCBjb25kaXRpb24gPSB0aGlzLmdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tKGNvbnRleHQubGF0ZXN0KTtcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29uZGl0aW9uLCAkdW5ib3hpbmc6IHRydWV9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgdXBkYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9uc10gLSBVcGRhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSB1cGRhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJVcGRhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQmVmb3JlIGRlbGV0aW5nIGFuIGVudGl0eS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmRlbGV0ZU9wdGlvbnNdIC0gRGVsZXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2RlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZF0gLSBSZXRyaWV2ZSB0aGUgcmVjZW50bHkgZGVsZXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGJlZm9yZURlbGV0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghY29udGV4dC5jb25uT3B0aW9ucyB8fCAhY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucyB8fCAoY29udGV4dC5jb25uT3B0aW9ucyA9IHt9KTtcblxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmJlZ2luVHJhbnNhY3Rpb25fKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQuZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHF1ZXJ5LCAkdW5ib3hpbmc6IHRydWV9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qICAgICAgZW50aXR5OiA8cmVtb3RlIGVudGl0eT5cbiAgICAgKiAgICAgIGpvaW5UeXBlOiAnTEVGVCBKT0lOfElOTkVSIEpPSU58RlVMTCBPVVRFUiBKT0lOJ1xuICAgICAqICAgICAgYW5jaG9yOiAnbG9jYWwgcHJvcGVydHkgdG8gcGxhY2UgdGhlIHJlbW90ZSBlbnRpdHknXG4gICAgICogICAgICBsb2NhbEZpZWxkOiA8bG9jYWwgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHJlbW90ZUZpZWxkOiA8cmVtb3RlIGZpZWxkIHRvIGpvaW4+XG4gICAgICogICAgICBzdWJBc3NvY2lhdGlvbnM6IHsgLi4uIH0gICovXG4gICAgc3RhdGljIF9wcmVwYXJlQXNzb2NpYXRpb25zKGZpbmRPcHRpb25zKSB7IFxuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uLmNvbmNhdCgpLnNvcnQoKTsgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IGNhY2hlID0ge30sIGhpZXJhcmNoeSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgYXNzb2NpYXRpb25zLmZvckVhY2goYXNzb2MgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhc3NvYykpIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkucHVzaCh7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiBhc3NvYy50eXBlLCBcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiBhc3NvYy5vdXRwdXQsXG4gICAgICAgICAgICAgICAgICAgIC4uLihhc3NvYy5hbGlhcyA/IHsgYWxpYXM6IGFzc29jLmFsaWFzIH0gOiB7fSksXG4gICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLm9uLFxuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmRiLmNvbm5lY3Rvci5idWlsZFF1ZXJ5KGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcmVwYXJlUXVlcmllcyh7IC4uLmFzc29jLmRhdGFzZXQsICR2YXJpYWJsZXM6IGZpbmRPcHRpb25zLiR2YXJpYWJsZXMgfSkpICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgWyByZW1vdGVFbnRpdHksIGJhc2UsIGFuY2hvciwgYXNzb2NJbmZvIF0gPSB0aGlzLl9nZXRSZWxhdGVkRW50aXR5KGFzc29jLCBjYWNoZSk7XG4gICAgICAgICAgICBhc3NlcnQ6IGFzc29jSW5mbzsgICAgICAgICAgICBcblxuICAgICAgICAgICAgbGV0IHJlbW90ZUVudGl0eU5hbWUgPSByZW1vdGVFbnRpdHkubWV0YS5uYW1lO1xuXG4gICAgICAgICAgICBsZXQgZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICBrZXlGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgIGFuY2hvclxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHRvQ2FjaGUgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHksXG4gICAgICAgICAgICAgICAgZGV0YWlsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5pc0xpc3QgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLm9wdGlvbmFsID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRCeSkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBkZXRhaWwuZW50aXR5ID0gYXNzb2NJbmZvLmNvbm5lY3RlZEJ5O1xuICAgICAgICAgICAgICAgIGRldGFpbC5rZXlGaWVsZCA9IHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KS5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRXaXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5jb25uZWN0ZWRXaXRoID0gYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGg7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgICAgICBhbmNob3I6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBsb2NhbEZpZWxkOiBhc3NvY0luZm8ucmVmZXJzVG9GaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlRmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcblxuICAgICAgICAgICAgICAgIGlmIChhc3NvY0luZm8ucmVtb3RlRmllbGRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZHMgPSBhc3NvY0luZm8ucmVtb3RlRmllbGRzO1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwuam9pblR5cGUgPSAnUklHSFQgSk9JTic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkIHx8IHRoaXMubWV0YS5uYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBhbmNob3I7XG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5yZW1vdGVGaWVsZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkcyA9IGFzc29jSW5mby5yZW1vdGVGaWVsZHM7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5qb2luVHlwZSA9ICdSSUdIVCBKT0lOJztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXSkge1xuICAgICAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbIGRldGFpbCBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGllcmFyY2h5LnB1c2goZGV0YWlsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FjaGVbYXNzb2NdID0gdG9DYWNoZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGhpZXJhcmNoeTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2NQYXRoLCBjYWNoZSkgeyAgICAgICAgXG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jUGF0aC5zcGxpdCgnLicpOyAgICAgICAgXG4gICAgICAgIGxldCBiYXNlID0gcGFydHMuc2xpY2UoMCwgLTEpLmpvaW4oJy4nKTsgICAgICAgIFxuXG4gICAgICAgIGxldCBjYWNoZU5vZGUgPSBjYWNoZVtiYXNlXTtcbiAgICAgICAgaWYgKGNhY2hlTm9kZSkge1xuICAgICAgICAgICAgbGV0IGxhc3QgPSBwYXJ0cy5wb3AoKTtcbiAgICAgICAgICAgIGxldCBhc3NvY0luZm8gPSBjYWNoZU5vZGUuZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2xhc3RdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY0luZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBvZiBcIiR7dGhpcy5tZXRhLm5hbWV9XCIgZW50aXR5OiAke2Fzc29jUGF0aH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFsgdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uZW50aXR5KSwgYmFzZSwgbGFzdCwgYXNzb2NJbmZvIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcywgY3VycmVudCwgY3VycmVudEFzc29jSW5mbztcblxuICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY3VycmVudCA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICBjdXJyZW50QXNzb2NJbmZvID0gZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2N1cnJlbnRdO1xuICAgICAgICAgICAgaWYgKCFjdXJyZW50QXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVudGl0eSA9IHRoaXMuZGIubW9kZWwoY3VycmVudEFzc29jSW5mby5lbnRpdHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFsgZW50aXR5LCBiYXNlLCBjdXJyZW50LCBjdXJyZW50QXNzb2NJbmZvIF07XG4gICAgfVxuXG4gICAgc3RhdGljIF9tYXBSZWNvcmRzVG9PYmplY3RzKFtyb3dzLCBjb2x1bW5zLCBhbGlhc01hcF0sIGhpZXJhcmNoeSkge1xuICAgICAgICBsZXQgbWFpbkluZGV4ID0ge307XG5cbiAgICAgICAgZnVuY3Rpb24gbWVyZ2VSZWNvcmQoZXhpc3RpbmdSb3csIHJvd09iamVjdCwgYXNzb2NpYXRpb25zKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBfLmVhY2goYXNzb2NpYXRpb25zLCAoeyBzcWwsIGtleUZpZWxkLCBhbmNob3IsIGlzTGlzdCwgc3ViQXNzb2NpYXRpb25zIH0pID0+IHsgXG4gICAgICAgICAgICAgICAgaWYgKHNxbCkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbGV0IGtleSA9ICc6JyArIGFuY2hvcjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1Yk9iaiA9IHJvd09iamVjdFtrZXldXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ZXMgPSBleGlzdGluZ1Jvdy5zdWJJbmRleGVzW2tleV07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJvd0tleSA9IHN1Yk9ialtrZXlGaWVsZF07XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwocm93S2V5KSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nU3ViUm93ID0gc3ViSW5kZXhlcyAmJiBzdWJJbmRleGVzW3Jvd0tleV07XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nU3ViUm93KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nU3ViUm93LCBzdWJPYmosIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBpc0xpc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W2tleV0ucHVzaChzdWJPYmopO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W2tleV0gPSBbIHN1Yk9iaiBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXggPSB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmogICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iaiwgc3ViQXNzb2NpYXRpb25zKVxuICAgICAgICAgICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXNbcm93S2V5XSA9IHN1YkluZGV4OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBidWlsZFN1YkluZGV4ZXMocm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBhc3NvY2lhdGlvbnMucmVkdWNlKChpbmRleGVzLCB7IHNxbCwga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzcWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ZXM7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGtleSA9ICc6JythbmNob3I7XG4gICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHJvd09iamVjdFtrZXldOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXggPSB7IFxuICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iamVjdCBcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzTGlzdCkgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHN1Yk9iamVjdFtrZXlGaWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rba2V5XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdFtrZXldID0gWyBzdWJPYmplY3QgXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc05pbChzdWJPYmplY3Rba2V5RmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICBzdWJPYmplY3QgPSByb3dPYmplY3Rba2V5XSA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHN1Yk9iamVjdCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iamVjdCwgc3ViQXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFtzdWJPYmplY3Rba2V5RmllbGRdXTogc3ViSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhlcztcbiAgICAgICAgICAgIH0sIHt9KTsgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXJyYXlPZk9ianMgPSBbXTtcblxuICAgICAgICByb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgICAgIGxldCByb3dPYmplY3QgPSB7fTsgLy8gaGFzaC1zdHlsZSBkYXRhIHJvd1xuICAgICAgICAgICAgbGV0IHRhYmxlQ2FjaGUgPSB7fTsgLy8gZnJvbSBhbGlhcyB0byBjaGlsZCBwcm9wIG9mIHJvd09iamVjdFxuXG4gICAgICAgICAgICByb3cucmVkdWNlKChyZXN1bHQsIHZhbHVlLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbCA9IGNvbHVtbnNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGNvbC50YWJsZSA9PT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjb2wubmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJ1Y2tldCA9IHRhYmxlQ2FjaGVbY29sLnRhYmxlXTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVja2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBidWNrZXRbY29sLm5hbWVdID0gdmFsdWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBub2RlUGF0aCA9IGFsaWFzTWFwW2NvbC50YWJsZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3ViT2JqZWN0ID0geyBbY29sLm5hbWVdOiB2YWx1ZSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlQ2FjaGVbY29sLnRhYmxlXSA9IHN1Yk9iamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRWYWx1ZUJ5UGF0aChyZXN1bHQsIG5vZGVQYXRoLCBzdWJPYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0sIHJvd09iamVjdCk7ICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJvd0tleSA9IHJvd09iamVjdFt0aGlzLm1ldGEua2V5RmllbGRdO1xuICAgICAgICAgICAgbGV0IGV4aXN0aW5nUm93ID0gbWFpbkluZGV4W3Jvd0tleV07XG4gICAgICAgICAgICBpZiAoZXhpc3RpbmdSb3cpIHtcbiAgICAgICAgICAgICAgICBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBoaWVyYXJjaHkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhcnJheU9mT2Jqcy5wdXNoKHJvd09iamVjdCk7XG4gICAgICAgICAgICAgICAgbWFpbkluZGV4W3Jvd0tleV0gPSB7IFxuICAgICAgICAgICAgICAgICAgICByb3dPYmplY3QsIFxuICAgICAgICAgICAgICAgICAgICBzdWJJbmRleGVzOiBidWlsZFN1YkluZGV4ZXMocm93T2JqZWN0LCBoaWVyYXJjaHkpXG4gICAgICAgICAgICAgICAgfTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhcnJheU9mT2JqcztcbiAgICB9XG5cbiAgICBzdGF0aWMgX2V4dHJhY3RBc3NvY2lhdGlvbnMoZGF0YSkge1xuICAgICAgICBsZXQgcmF3ID0ge30sIGFzc29jcyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZGF0YSwgKHYsIGspID0+IHtcbiAgICAgICAgICAgIGlmIChrLnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgIGFzc29jc1trLnN1YnN0cigxKV0gPSB2O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByYXdba10gPSB2O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBbIHJhdywgYXNzb2NzIF07ICAgICAgICBcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX2NyZWF0ZUFzc29jc18oY29udGV4dCwgYXNzb2NzKSB7XG4gICAgICAgIGxldCBtZXRhID0gdGhpcy5tZXRhLmFzc29jaWF0aW9ucztcbiAgICAgICAgbGV0IGtleVZhbHVlID0gY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmtleUZpZWxkXTtcblxuICAgICAgICBpZiAoXy5pc05pbChrZXlWYWx1ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIHByaW1hcnkga2V5IGZpZWxkIHZhbHVlLiBFbnRpdHk6ICcgKyB0aGlzLm1ldGEubmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhhc3NvY3MsIGFzeW5jIChkYXRhLCBhbmNob3IpID0+IHtcbiAgICAgICAgICAgIGxldCBhc3NvY01ldGEgPSBtZXRhW2FuY2hvcl07XG4gICAgICAgICAgICBpZiAoIWFzc29jTWV0YSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIFwiJHthbmNob3J9XCIgb2YgZW50aXR5IFwiJHt0aGlzLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGFzc29jTW9kZWw7XG5cbiAgICAgICAgICAgIGlmIChhc3NvY01ldGEuY29ubmVjdGVkQnkpIHtcbiAgICAgICAgICAgICAgICBhc3NvY01vZGVsID0gdGhpcy5kYi5tb2RlbChhc3NvY01ldGEuY29ubmVjdGVkQnkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhc3NvY01vZGVsID0gdGhpcy5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFzc29jTWV0YS5pc0xpc3QpIHtcbiAgICAgICAgICAgICAgICBkYXRhID0gXy5jYXN0QXJyYXkoZGF0YSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhkYXRhLCBpdGVtID0+IGFzc29jTW9kZWwuY3JlYXRlXyh7IC4uLml0ZW0sIFthc3NvY01ldGEucmVtb3RlRmllbGRdOiBrZXlWYWx1ZSB9LCBjb250ZXh0LmNyZWF0ZU9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFzc29jTW9kZWwuY3JlYXRlXyh7IC4uLmRhdGEsIFthc3NvY01ldGEucmVtb3RlRmllbGRdOiBrZXlWYWx1ZSB9LCBjb250ZXh0LmNyZWF0ZU9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpOyAgXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTEVudGl0eU1vZGVsOyJdfQ==