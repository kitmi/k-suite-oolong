"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static _translateSymbolToken(name) {
    if (name === 'now') {
      return this.db.connector.raw('NOW()');
    }

    throw new Error('not support');
  }

  static _serialize(value) {
    if (typeof value === 'boolean') return value ? 1 : 0;

    if (value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity. Detail: ' + error.message);
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(associations) {
    associations = associations.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor
      };
      let toCache = {
        entity: remoteEntity,
        detail
      };

      if (assocInfo.isList) {
        detail.isList = true;
      }

      if (assocInfo.optional) {
        detail.optional = true;
      }

      if (assocInfo.connectedBy) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
        detail.entity = assocInfo.connectedBy;
        detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;

        if (assocInfo.connectedWith) {
          detail.connectedWith = assocInfo.connectedWith;
        }

        toCache.detail = {
          entity: remoteEntityName,
          keyField: remoteEntity.meta.keyField,
          joinType: 'LEFT JOIN',
          anchor: assocInfo.refersToField,
          localField: assocInfo.refersToField,
          remoteField: remoteEntity.meta.keyField
        };
        detail.subAssociations = [toCache.detail];
      } else if (assocInfo.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
      } else {
        detail.localField = anchor;
        detail.remoteField = remoteEntity.meta.keyField;
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = toCache;
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            throw new Error("Assertion failed: isList");
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];
            let subObject = {
              [col.name]: value
            };
            tableCache[col.table] = subObject;
            setValueByPath(result, nodePath, subObject);
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      let assocModel;

      if (assocMeta.connectedBy) {
        assocModel = this.db.model(assocMeta.connectedBy);
      } else {
        assocModel = this.db.model(assocMeta.entity);
      }

      if (assocMeta.isList) {
        data = _.castArray(data);
        return eachAsync_(data, item => assocModel.create_({ ...item,
          [assocMeta.remoteField]: keyValue
        }, context.createOptions, context.connOptions));
      }

      return assocModel.create_({ ...data,
        [assocMeta.remoteField]: keyValue
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiRGF0ZVRpbWUiLCJFbnRpdHlNb2RlbCIsIk9vbG9uZ1VzYWdlRXJyb3IiLCJCdXNpbmVzc0Vycm9yIiwiTXlTUUxFbnRpdHlNb2RlbCIsImhhc0F1dG9JbmNyZW1lbnQiLCJhdXRvSWQiLCJtZXRhIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJmaWVsZCIsImF1dG9JbmNyZW1lbnRJZCIsIl90cmFuc2xhdGVTeW1ib2xUb2tlbiIsIm5hbWUiLCJkYiIsImNvbm5lY3RvciIsInJhdyIsIkVycm9yIiwiX3NlcmlhbGl6ZSIsInZhbHVlIiwidG9JU08iLCJpbmNsdWRlT2Zmc2V0IiwiY3JlYXRlXyIsImFyZ3MiLCJlcnJvciIsImVycm9yQ29kZSIsImNvZGUiLCJtZXNzYWdlIiwidXBkYXRlXyIsImFmdGVyQ3JlYXRlXyIsImNvbnRleHQiLCJpbnNlcnRJZCIsInJlc3VsdCIsImxhdGVzdCIsImNyZWF0ZU9wdGlvbnMiLCIkcmV0cmlldmVDcmVhdGVkIiwiY29uZGl0aW9uIiwiZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20iLCJmaW5kT25lXyIsIiRxdWVyeSIsIiR1bmJveGluZyIsImNvbm5PcHRpb25zIiwiYWZ0ZXJVcGRhdGVfIiwidXBkYXRlT3B0aW9ucyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJiZWZvcmVEZWxldGVfIiwiZGVsZXRlT3B0aW9ucyIsIiRyZXRyaWV2ZURlbGV0ZWQiLCJjb25uZWN0aW9uIiwiYmVnaW5UcmFuc2FjdGlvbl8iLCJleGlzdGluZyIsIl9wcmVwYXJlQXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25zIiwiY29uY2F0Iiwic29ydCIsImNhY2hlIiwiaGllcmFyY2h5IiwiZm9yRWFjaCIsImFzc29jIiwicmVtb3RlRW50aXR5IiwiYmFzZSIsImFuY2hvciIsImFzc29jSW5mbyIsIl9nZXRSZWxhdGVkRW50aXR5IiwicmVtb3RlRW50aXR5TmFtZSIsImRldGFpbCIsImVudGl0eSIsImtleUZpZWxkIiwiam9pblR5cGUiLCJ0b0NhY2hlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJjb25uZWN0ZWRCeSIsImxvY2FsRmllbGQiLCJyZW1vdGVGaWVsZCIsIm1vZGVsIiwiY29ubmVjdGVkV2l0aCIsInJlZmVyc1RvRmllbGQiLCJzdWJBc3NvY2lhdGlvbnMiLCJwdXNoIiwiYXNzb2NQYXRoIiwicGFydHMiLCJzcGxpdCIsInNsaWNlIiwiam9pbiIsImNhY2hlTm9kZSIsImxhc3QiLCJwb3AiLCJjdXJyZW50IiwiY3VycmVudEFzc29jSW5mbyIsImxlbmd0aCIsInNoaWZ0IiwiX21hcFJlY29yZHNUb09iamVjdHMiLCJyb3dzIiwiY29sdW1ucyIsImFsaWFzTWFwIiwibWFpbkluZGV4IiwibWVyZ2VSZWNvcmQiLCJleGlzdGluZ1JvdyIsInJvd09iamVjdCIsImVhY2giLCJrZXkiLCJzdWJPYmoiLCJzdWJJbmRleGVzIiwicm93S2V5IiwiaXNOaWwiLCJleGlzdGluZ1N1YlJvdyIsInN1YkluZGV4IiwiYnVpbGRTdWJJbmRleGVzIiwicmVkdWNlIiwiaW5kZXhlcyIsInN1Yk9iamVjdCIsImFycmF5T2ZPYmpzIiwicm93IiwidGFibGVDYWNoZSIsImkiLCJjb2wiLCJ0YWJsZSIsImJ1Y2tldCIsIm5vZGVQYXRoIiwiX2V4dHJhY3RBc3NvY2lhdGlvbnMiLCJkYXRhIiwiYXNzb2NzIiwiZm9yT3duIiwidiIsImsiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiX2NyZWF0ZUFzc29jc18iLCJrZXlWYWx1ZSIsImFzc29jTWV0YSIsImFzc29jTW9kZWwiLCJjYXN0QXJyYXkiLCJpdGVtIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1B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c3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBzZXRWYWx1ZUJ5UGF0aCwgZWFjaEFzeW5jXyB9ID0gVXRpbDtcblxuY29uc3QgeyBEYXRlVGltZSB9ID0gcmVxdWlyZSgnbHV4b24nKTtcbmNvbnN0IEVudGl0eU1vZGVsID0gcmVxdWlyZSgnLi4vLi4vRW50aXR5TW9kZWwnKTtcbmNvbnN0IHsgT29sb25nVXNhZ2VFcnJvciwgQnVzaW5lc3NFcnJvciB9ID0gcmVxdWlyZSgnLi4vLi4vRXJyb3JzJyk7XG5cbi8qKlxuICogTXlTUUwgZW50aXR5IG1vZGVsIGNsYXNzLlxuICovXG5jbGFzcyBNeVNRTEVudGl0eU1vZGVsIGV4dGVuZHMgRW50aXR5TW9kZWwgeyAgICBcbiAgICBzdGF0aWMgZ2V0IGhhc0F1dG9JbmNyZW1lbnQoKSB7XG4gICAgICAgIGxldCBhdXRvSWQgPSB0aGlzLm1ldGEuZmVhdHVyZXMuYXV0b0lkO1xuICAgICAgICByZXR1cm4gYXV0b0lkICYmIHRoaXMubWV0YS5maWVsZHNbYXV0b0lkLmZpZWxkXS5hdXRvSW5jcmVtZW50SWQ7ICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlcmlhbGl6ZSB2YWx1ZSBpbnRvIGRhdGFiYXNlIGFjY2VwdGFibGUgZm9ybWF0LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBuYW1lIC0gTmFtZSBvZiB0aGUgc3ltYm9sIHRva2VuIFxuICAgICAqL1xuICAgIHN0YXRpYyBfdHJhbnNsYXRlU3ltYm9sVG9rZW4obmFtZSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gJ25vdycpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRiLmNvbm5lY3Rvci5yYXcoJ05PVygpJyk7XG4gICAgICAgIH0gXG4gICAgICAgIFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBzdXBwb3J0Jyk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9zZXJpYWxpemUodmFsdWUpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWUgPyAxIDogMDtcblxuICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlVGltZSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvSVNPKHsgaW5jbHVkZU9mZnNldDogZmFsc2UgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGNyZWF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLmNyZWF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LiBEZXRhaWw6ICcgKyBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UgKyBgIHdoaWxlIGNyZWF0aW5nIGEgbmV3IFwiJHt0aGlzLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgdXBkYXRlXyguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIudXBkYXRlXyguLi5hcmdzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBlcnJvckNvZGUgPSBlcnJvci5jb2RlO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAnRVJfTk9fUkVGRVJFTkNFRF9ST1dfMicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcignVGhlIG5ldyBlbnRpdHkgaXMgcmVmZXJlbmNpbmcgdG8gYW4gdW5leGlzdGluZyBlbnRpdHkuJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX0RVUF9FTlRSWScpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogUG9zdCBjcmVhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmNyZWF0ZU9wdGlvbnNdIC0gQ3JlYXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZF0gLSBSZXRyaWV2ZSB0aGUgbmV3bHkgY3JlYXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGFmdGVyQ3JlYXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmICh0aGlzLmhhc0F1dG9JbmNyZW1lbnQpIHtcbiAgICAgICAgICAgIGxldCB7IGluc2VydElkIH0gPSBjb250ZXh0LnJlc3VsdDtcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0W3RoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQuZmllbGRdID0gaW5zZXJ0SWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29udGV4dC5jcmVhdGVPcHRpb25zLiRyZXRyaWV2ZUNyZWF0ZWQpIHtcbiAgICAgICAgICAgIGxldCBjb25kaXRpb24gPSB0aGlzLmdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tKGNvbnRleHQubGF0ZXN0KTtcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29uZGl0aW9uLCAkdW5ib3hpbmc6IHRydWV9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgdXBkYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9uc10gLSBVcGRhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSB1cGRhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJVcGRhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQmVmb3JlIGRlbGV0aW5nIGFuIGVudGl0eS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmRlbGV0ZU9wdGlvbnNdIC0gRGVsZXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2RlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZF0gLSBSZXRyaWV2ZSB0aGUgcmVjZW50bHkgZGVsZXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGJlZm9yZURlbGV0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghY29udGV4dC5jb25uT3B0aW9ucyB8fCAhY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucyB8fCAoY29udGV4dC5jb25uT3B0aW9ucyA9IHt9KTtcblxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmJlZ2luVHJhbnNhY3Rpb25fKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQuZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHF1ZXJ5LCAkdW5ib3hpbmc6IHRydWV9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qICAgICAgZW50aXR5OiA8cmVtb3RlIGVudGl0eT5cbiAgICAgKiAgICAgIGpvaW5UeXBlOiAnTEVGVCBKT0lOfElOTkVSIEpPSU58RlVMTCBPVVRFUiBKT0lOJ1xuICAgICAqICAgICAgYW5jaG9yOiAnbG9jYWwgcHJvcGVydHkgdG8gcGxhY2UgdGhlIHJlbW90ZSBlbnRpdHknXG4gICAgICogICAgICBsb2NhbEZpZWxkOiA8bG9jYWwgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHJlbW90ZUZpZWxkOiA8cmVtb3RlIGZpZWxkIHRvIGpvaW4+XG4gICAgICogICAgICBzdWJBc3NvY2lhdGlvbnM6IHsgLi4uIH0gICovXG4gICAgc3RhdGljIF9wcmVwYXJlQXNzb2NpYXRpb25zKGFzc29jaWF0aW9ucykgeyAgIFxuICAgICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KCkuc29ydCgpO1xuICAgICAgICBsZXQgY2FjaGUgPSB7fSwgaGllcmFyY2h5ID0gW107XG4gICAgICAgIFxuICAgICAgICBhc3NvY2lhdGlvbnMuZm9yRWFjaChhc3NvYyA9PiB7XG4gICAgICAgICAgICBsZXQgWyByZW1vdGVFbnRpdHksIGJhc2UsIGFuY2hvciwgYXNzb2NJbmZvIF0gPSB0aGlzLl9nZXRSZWxhdGVkRW50aXR5KGFzc29jLCBjYWNoZSk7XG4gICAgICAgICAgICBhc3NlcnQ6IGFzc29jSW5mbzsgICAgICAgICAgICBcblxuICAgICAgICAgICAgbGV0IHJlbW90ZUVudGl0eU5hbWUgPSByZW1vdGVFbnRpdHkubWV0YS5uYW1lO1xuXG4gICAgICAgICAgICBsZXQgZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICBrZXlGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgIGFuY2hvclxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHRvQ2FjaGUgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHksXG4gICAgICAgICAgICAgICAgZGV0YWlsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5pc0xpc3QgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLm9wdGlvbmFsID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRCeSkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBkZXRhaWwuZW50aXR5ID0gYXNzb2NJbmZvLmNvbm5lY3RlZEJ5O1xuICAgICAgICAgICAgICAgIGRldGFpbC5rZXlGaWVsZCA9IHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KS5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRXaXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5jb25uZWN0ZWRXaXRoID0gYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGg7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgICAgICBhbmNob3I6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBsb2NhbEZpZWxkOiBhc3NvY0luZm8ucmVmZXJzVG9GaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlRmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gYW5jaG9yO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY2FjaGVbYmFzZV0pIHtcbiAgICAgICAgICAgICAgICBpZiAoY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zLnB1c2goZGV0YWlsKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zID0gWyBkZXRhaWwgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhpZXJhcmNoeS5wdXNoKGRldGFpbCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNhY2hlW2Fzc29jXSA9IHRvQ2FjaGU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBoaWVyYXJjaHk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXRSZWxhdGVkRW50aXR5KGFzc29jUGF0aCwgY2FjaGUpIHsgICAgICAgIFxuICAgICAgICBsZXQgcGFydHMgPSBhc3NvY1BhdGguc3BsaXQoJy4nKTsgICAgICAgIFxuICAgICAgICBsZXQgYmFzZSA9IHBhcnRzLnNsaWNlKDAsIC0xKS5qb2luKCcuJyk7ICAgICAgICBcblxuICAgICAgICBsZXQgY2FjaGVOb2RlID0gY2FjaGVbYmFzZV07XG4gICAgICAgIGlmIChjYWNoZU5vZGUpIHtcbiAgICAgICAgICAgIGxldCBsYXN0ID0gcGFydHMucG9wKCk7XG4gICAgICAgICAgICBsZXQgYXNzb2NJbmZvID0gY2FjaGVOb2RlLmVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tsYXN0XTtcbiAgICAgICAgICAgIGlmICghYXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBbIHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmVudGl0eSksIGJhc2UsIGxhc3QsIGFzc29jSW5mbyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMsIGN1cnJlbnQsIGN1cnJlbnRBc3NvY0luZm87XG5cbiAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgY3VycmVudEFzc29jSW5mbyA9IGVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tjdXJyZW50XTtcbiAgICAgICAgICAgIGlmICghY3VycmVudEFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIG9mIFwiJHt0aGlzLm1ldGEubmFtZX1cIiBlbnRpdHk6ICR7YXNzb2NQYXRofWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbnRpdHkgPSB0aGlzLmRiLm1vZGVsKGN1cnJlbnRBc3NvY0luZm8uZW50aXR5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbIGVudGl0eSwgYmFzZSwgY3VycmVudCwgY3VycmVudEFzc29jSW5mbyBdO1xuICAgIH1cblxuICAgIHN0YXRpYyBfbWFwUmVjb3Jkc1RvT2JqZWN0cyhbcm93cywgY29sdW1ucywgYWxpYXNNYXBdLCBoaWVyYXJjaHkpIHtcbiAgICAgICAgbGV0IG1haW5JbmRleCA9IHt9O1xuXG4gICAgICAgIGZ1bmN0aW9uIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGFzc29jaWF0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKGFzc29jaWF0aW9ucywgKHsga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4geyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQga2V5ID0gJzonICsgYW5jaG9yOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqID0gcm93T2JqZWN0W2tleV1cbiAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXhlcyA9IGV4aXN0aW5nUm93LnN1YkluZGV4ZXNba2V5XTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcm93S2V5ID0gc3ViT2JqW2tleUZpZWxkXTtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChyb3dLZXkpKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBsZXQgZXhpc3RpbmdTdWJSb3cgPSBzdWJJbmRleGVzICYmIHN1YkluZGV4ZXNbcm93S2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdTdWJSb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdTdWJSb3csIHN1Yk9iaiwgc3ViQXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGlzTGlzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93LnJvd09iamVjdFtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XS5wdXNoKHN1Yk9iaik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqIF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iaiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqLCBzdWJBc3NvY2lhdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlc1tyb3dLZXldID0gc3ViSW5kZXg7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIGFzc29jaWF0aW9ucy5yZWR1Y2UoKGluZGV4ZXMsIHsga2V5RmllbGQsIGFuY2hvciwgaXNMaXN0LCBzdWJBc3NvY2lhdGlvbnMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBrZXkgPSAnOicrYW5jaG9yO1xuICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSByb3dPYmplY3Rba2V5XTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmplY3QgXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChpc0xpc3QpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChzdWJPYmplY3Rba2V5RmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W2tleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rba2V5XSA9IFsgc3ViT2JqZWN0IF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleUZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gcm93T2JqZWN0W2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChzdWJPYmplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXguc3ViSW5kZXhlcyA9IGJ1aWxkU3ViSW5kZXhlcyhzdWJPYmplY3QsIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpbmRleGVzW2tleV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBbc3ViT2JqZWN0W2tleUZpZWxkXV06IHN1YkluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ZXM7XG4gICAgICAgICAgICB9LCB7fSk7ICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFycmF5T2ZPYmpzID0gW107XG5cbiAgICAgICAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XG4gICAgICAgICAgICBsZXQgcm93T2JqZWN0ID0ge307IC8vIGhhc2gtc3R5bGUgZGF0YSByb3dcbiAgICAgICAgICAgIGxldCB0YWJsZUNhY2hlID0ge307IC8vIGZyb20gYWxpYXMgdG8gY2hpbGQgcHJvcCBvZiByb3dPYmplY3RcblxuICAgICAgICAgICAgcm93LnJlZHVjZSgocmVzdWx0LCB2YWx1ZSwgaSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2wgPSBjb2x1bW5zW2ldO1xuICAgICAgICAgICAgICAgIGlmIChjb2wudGFibGUgPT09ICdBJykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbY29sLm5hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBidWNrZXQgPSB0YWJsZUNhY2hlW2NvbC50YWJsZV07ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1Y2tldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0W2NvbC5uYW1lXSA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZVBhdGggPSBhbGlhc01hcFtjb2wudGFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHsgW2NvbC5uYW1lXTogdmFsdWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlQ2FjaGVbY29sLnRhYmxlXSA9IHN1Yk9iamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlQnlQYXRoKHJlc3VsdCwgbm9kZVBhdGgsIHN1Yk9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSwgcm93T2JqZWN0KTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcm93S2V5ID0gcm93T2JqZWN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG4gICAgICAgICAgICBsZXQgZXhpc3RpbmdSb3cgPSBtYWluSW5kZXhbcm93S2V5XTtcbiAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdykge1xuICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGhpZXJhcmNoeSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFycmF5T2ZPYmpzLnB1c2gocm93T2JqZWN0KTtcbiAgICAgICAgICAgICAgICBtYWluSW5kZXhbcm93S2V5XSA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdCwgXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXM6IGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGhpZXJhcmNoeSlcbiAgICAgICAgICAgICAgICB9OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFycmF5T2ZPYmpzO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZXh0cmFjdEFzc29jaWF0aW9ucyhkYXRhKSB7XG4gICAgICAgIGxldCByYXcgPSB7fSwgYXNzb2NzID0ge307XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihkYXRhLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgaWYgKGsuc3RhcnRzV2l0aCgnOicpKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NzW2suc3Vic3RyKDEpXSA9IHY7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJhd1trXSA9IHY7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIFsgcmF3LCBhc3NvY3MgXTsgICAgICAgIFxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBfY3JlYXRlQXNzb2NzXyhjb250ZXh0LCBhc3NvY3MpIHtcbiAgICAgICAgbGV0IG1ldGEgPSB0aGlzLm1ldGEuYXNzb2NpYXRpb25zO1xuICAgICAgICBsZXQga2V5VmFsdWUgPSBjb250ZXh0LmxhdGVzdFt0aGlzLm1ldGEua2V5RmllbGRdO1xuXG4gICAgICAgIGlmIChfLmlzTmlsKGtleVZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IE9vbG9uZ1VzYWdlRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgcHJpbWFyeSBrZXkgZmllbGQgdmFsdWUuIEVudGl0eTogJyArIHRoaXMubWV0YS5uYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlYWNoQXN5bmNfKGFzc29jcywgYXN5bmMgKGRhdGEsIGFuY2hvcikgPT4ge1xuICAgICAgICAgICAgbGV0IGFzc29jTWV0YSA9IG1ldGFbYW5jaG9yXTtcbiAgICAgICAgICAgIGlmICghYXNzb2NNZXRhKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gXCIke2FuY2hvcn1cIiBvZiBlbnRpdHkgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgYXNzb2NNb2RlbDtcblxuICAgICAgICAgICAgaWYgKGFzc29jTWV0YS5jb25uZWN0ZWRCeSkge1xuICAgICAgICAgICAgICAgIGFzc29jTW9kZWwgPSB0aGlzLmRiLm1vZGVsKGFzc29jTWV0YS5jb25uZWN0ZWRCeSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFzc29jTW9kZWwgPSB0aGlzLmRiLm1vZGVsKGFzc29jTWV0YS5lbnRpdHkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYXNzb2NNZXRhLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRhdGEgPSBfLmNhc3RBcnJheShkYXRhKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlYWNoQXN5bmNfKGRhdGEsIGl0ZW0gPT4gYXNzb2NNb2RlbC5jcmVhdGVfKHsgLi4uaXRlbSwgW2Fzc29jTWV0YS5yZW1vdGVGaWVsZF06IGtleVZhbHVlIH0sIGNvbnRleHQuY3JlYXRlT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucykpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYXNzb2NNb2RlbC5jcmVhdGVfKHsgLi4uZGF0YSwgW2Fzc29jTWV0YS5yZW1vdGVGaWVsZF06IGtleVZhbHVlIH0sIGNvbnRleHQuY3JlYXRlT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7ICBcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMRW50aXR5TW9kZWw7Il19