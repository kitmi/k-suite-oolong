"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static serialize(dataRecord) {
    _.forOwn(dataRecord, (value, fieldName) => {
      let fieldMeta = this.meta.fields[fieldName];

      if (fieldMeta.type === 'datetime') {
        if (typeof value === 'object' && value.oolType === 'SymbolToken') {
          if (value.name === 'now') {
            dataRecord[fieldName] = this.db.connector.raw('NOW()');
          }
        }

        if (value instanceof DateTime) {
          dataRecord[fieldName] = value.toISO({
            includeOffset: false
          });
        }
      } else if (fieldMeta.type === 'boolean') {
        dataRecord[fieldName] = dataRecord[fieldName] ? 1 : 0;
      }
    });
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(associations) {
    associations = associations.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor
      };
      let toCache = {
        entity: remoteEntity,
        detail
      };

      if (assocInfo.isList) {
        detail.isList = true;
      }

      if (assocInfo.optional) {
        detail.optional = true;
      }

      if (assocInfo.connectedBy) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
        detail.entity = assocInfo.connectedBy;
        detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;

        if (assocInfo.connectedWith) {
          detail.connectedWith = assocInfo.connectedWith;
        }

        toCache.detail = {
          entity: remoteEntityName,
          keyField: remoteEntity.meta.keyField,
          joinType: 'LEFT JOIN',
          anchor: assocInfo.refersToField,
          localField: assocInfo.refersToField,
          remoteField: remoteEntity.meta.keyField
        };
        detail.subAssociations = [toCache.detail];
      } else if (assocInfo.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
      } else {
        detail.localField = anchor;
        detail.remoteField = remoteEntity.meta.keyField;
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = toCache;
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            throw new Error("Assertion failed: isList");
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];
            let subObject = {
              [col.name]: value
            };
            tableCache[col.table] = subObject;
            setValueByPath(result, nodePath, subObject);
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      if (!assocMeta.connectedBy) {
        throw new BusinessError(`Unsupported association type, "${anchor}" of entity "${this.meta.name}". Currently only supports many-to-many association.`);
      }

      let assocModel = this.db.model(assocMeta.connectedBy);
      console.log(data);
      return assocModel.create_({ ...data,
        [assocMeta.remoteField]: keyValue
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiRGF0ZVRpbWUiLCJFbnRpdHlNb2RlbCIsIk9vbG9uZ1VzYWdlRXJyb3IiLCJCdXNpbmVzc0Vycm9yIiwiTXlTUUxFbnRpdHlNb2RlbCIsImhhc0F1dG9JbmNyZW1lbnQiLCJhdXRvSWQiLCJtZXRhIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJmaWVsZCIsImF1dG9JbmNyZW1lbnRJZCIsInNlcmlhbGl6ZSIsImRhdGFSZWNvcmQiLCJmb3JPd24iLCJ2YWx1ZSIsImZpZWxkTmFtZSIsImZpZWxkTWV0YSIsInR5cGUiLCJvb2xUeXBlIiwibmFtZSIsImRiIiwiY29ubmVjdG9yIiwicmF3IiwidG9JU08iLCJpbmNsdWRlT2Zmc2V0IiwiY3JlYXRlXyIsImFyZ3MiLCJlcnJvciIsImVycm9yQ29kZSIsImNvZGUiLCJtZXNzYWdlIiwidXBkYXRlXyIsImFmdGVyQ3JlYXRlXyIsImNvbnRleHQiLCJpbnNlcnRJZCIsInJlc3VsdCIsImxhdGVzdCIsImNyZWF0ZU9wdGlvbnMiLCIkcmV0cmlldmVDcmVhdGVkIiwiY29uZGl0aW9uIiwiZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20iLCJmaW5kT25lXyIsIiRxdWVyeSIsIiR1bmJveGluZyIsImNvbm5PcHRpb25zIiwiYWZ0ZXJVcGRhdGVfIiwidXBkYXRlT3B0aW9ucyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJiZWZvcmVEZWxldGVfIiwiZGVsZXRlT3B0aW9ucyIsIiRyZXRyaWV2ZURlbGV0ZWQiLCJjb25uZWN0aW9uIiwiYmVnaW5UcmFuc2FjdGlvbl8iLCJleGlzdGluZyIsIl9wcmVwYXJlQXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25zIiwiY29uY2F0Iiwic29ydCIsImNhY2hlIiwiaGllcmFyY2h5IiwiZm9yRWFjaCIsImFzc29jIiwicmVtb3RlRW50aXR5IiwiYmFzZSIsImFuY2hvciIsImFzc29jSW5mbyIsIl9nZXRSZWxhdGVkRW50aXR5IiwicmVtb3RlRW50aXR5TmFtZSIsImRldGFpbCIsImVudGl0eSIsImtleUZpZWxkIiwiam9pblR5cGUiLCJ0b0NhY2hlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJjb25uZWN0ZWRCeSIsImxvY2FsRmllbGQiLCJyZW1vdGVGaWVsZCIsIm1vZGVsIiwiY29ubmVjdGVkV2l0aCIsInJlZmVyc1RvRmllbGQiLCJzdWJBc3NvY2lhdGlvbnMiLCJwdXNoIiwiYXNzb2NQYXRoIiwicGFydHMiLCJzcGxpdCIsInNsaWNlIiwiam9pbiIsImNhY2hlTm9kZSIsImxhc3QiLCJwb3AiLCJjdXJyZW50IiwiY3VycmVudEFzc29jSW5mbyIsImxlbmd0aCIsInNoaWZ0IiwiX21hcFJlY29yZHNUb09iamVjdHMiLCJyb3dzIiwiY29sdW1ucyIsImFsaWFzTWFwIiwibWFpbkluZGV4IiwibWVyZ2VSZWNvcmQiLCJleGlzdGluZ1JvdyIsInJvd09iamVjdCIsImVhY2giLCJrZXkiLCJzdWJPYmoiLCJzdWJJbmRleGVzIiwicm93S2V5IiwiaXNOaWwiLCJleGlzdGluZ1N1YlJvdyIsInN1YkluZGV4IiwiYnVpbGRTdWJJbmRleGVzIiwicmVkdWNlIiwiaW5kZXhlcyIsInN1Yk9iamVjdCIsImFycmF5T2ZPYmpzIiwicm93IiwidGFibGVDYWNoZSIsImkiLCJjb2wiLCJ0YWJsZSIsImJ1Y2tldCIsIm5vZGVQYXRoIiwiX2V4dHJhY3RBc3NvY2lhdGlvbnMiLCJkYXRhIiwiYXNzb2NzIiwidiIsImsiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiX2NyZWF0ZUFzc29jc18iLCJrZXlWYWx1ZSIsImFzc29jTWV0YSIsImFzc29jTW9kZWwiLCJjb25zb2xlIiwibG9nIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxV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Q29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIHNldFZhbHVlQnlQYXRoLCBlYWNoQXN5bmNfIH0gPSBVdGlsO1xuXG5jb25zdCB7IERhdGVUaW1lIH0gPSByZXF1aXJlKCdsdXhvbicpO1xuY29uc3QgRW50aXR5TW9kZWwgPSByZXF1aXJlKCcuLi8uLi9FbnRpdHlNb2RlbCcpO1xuY29uc3QgeyBPb2xvbmdVc2FnZUVycm9yLCBCdXNpbmVzc0Vycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBNeVNRTCBlbnRpdHkgbW9kZWwgY2xhc3MuXG4gKi9cbmNsYXNzIE15U1FMRW50aXR5TW9kZWwgZXh0ZW5kcyBFbnRpdHlNb2RlbCB7ICAgIFxuICAgIHN0YXRpYyBnZXQgaGFzQXV0b0luY3JlbWVudCgpIHtcbiAgICAgICAgbGV0IGF1dG9JZCA9IHRoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG4gICAgICAgIHJldHVybiBhdXRvSWQgJiYgdGhpcy5tZXRhLmZpZWxkc1thdXRvSWQuZmllbGRdLmF1dG9JbmNyZW1lbnRJZDsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VyaWFsaXplIHZhbHVlIGludG8gZGF0YWJhc2UgYWNjZXB0YWJsZSBmb3JtYXQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGFSZWNvcmQgXG4gICAgICovXG4gICAgc3RhdGljIHNlcmlhbGl6ZShkYXRhUmVjb3JkKSB7XG4gICAgICAgIF8uZm9yT3duKGRhdGFSZWNvcmQsICh2YWx1ZSwgZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgZmllbGRNZXRhID0gdGhpcy5tZXRhLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZmllbGRNZXRhLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5vb2xUeXBlID09PSAnU3ltYm9sVG9rZW4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5uYW1lID09PSAnbm93Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdGhpcy5kYi5jb25uZWN0b3IucmF3KCdOT1coKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZVRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVJlY29yZFtmaWVsZE5hbWVdID0gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpZWxkTWV0YS50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPSBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPyAxIDogMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIGNyZWF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLmNyZWF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSArIGAgd2hpbGUgY3JlYXRpbmcgYSBuZXcgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci51cGRhdGVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBQb3N0IGNyZWF0ZSBwcm9jZXNzaW5nLlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuY3JlYXRlT3B0aW9uc10gLSBDcmVhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSBjcmVhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJDcmVhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzQXV0b0luY3JlbWVudCkge1xuICAgICAgICAgICAgbGV0IHsgaW5zZXJ0SWQgfSA9IGNvbnRleHQucmVzdWx0O1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZC5maWVsZF0gPSBpbnNlcnRJZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmNyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZCkge1xuICAgICAgICAgICAgbGV0IGNvbmRpdGlvbiA9IHRoaXMuZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20oY29udGV4dC5sYXRlc3QpO1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3QgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb25kaXRpb24sICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdCB1cGRhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFt1cGRhdGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFt1cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IHVwZGF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlclVwZGF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCZWZvcmUgZGVsZXRpbmcgYW4gZW50aXR5LlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuZGVsZXRlT3B0aW9uc10gLSBEZWxldGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkXSAtIFJldHJpZXZlIHRoZSByZWNlbnRseSBkZWxldGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYmVmb3JlRGVsZXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFjb250ZXh0LmNvbm5PcHRpb25zIHx8ICFjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zIHx8IChjb250ZXh0LmNvbm5PcHRpb25zID0ge30pO1xuXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuYmVnaW5UcmFuc2FjdGlvbl8oKTsgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyogICAgICBlbnRpdHk6IDxyZW1vdGUgZW50aXR5PlxuICAgICAqICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU58SU5ORVIgSk9JTnxGVUxMIE9VVEVSIEpPSU4nXG4gICAgICogICAgICBhbmNob3I6ICdsb2NhbCBwcm9wZXJ0eSB0byBwbGFjZSB0aGUgcmVtb3RlIGVudGl0eSdcbiAgICAgKiAgICAgIGxvY2FsRmllbGQ6IDxsb2NhbCBmaWVsZCB0byBqb2luPlxuICAgICAqICAgICAgcmVtb3RlRmllbGQ6IDxyZW1vdGUgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHN1YkFzc29jaWF0aW9uczogeyAuLi4gfSAgKi9cbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoYXNzb2NpYXRpb25zKSB7ICAgXG4gICAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQoKS5zb3J0KCk7XG4gICAgICAgIGxldCBjYWNoZSA9IHt9LCBoaWVyYXJjaHkgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGFzc29jaWF0aW9ucy5mb3JFYWNoKGFzc29jID0+IHtcbiAgICAgICAgICAgIGxldCBbIHJlbW90ZUVudGl0eSwgYmFzZSwgYW5jaG9yLCBhc3NvY0luZm8gXSA9IHRoaXMuX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2MsIGNhY2hlKTtcbiAgICAgICAgICAgIGFzc2VydDogYXNzb2NJbmZvOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBsZXQgcmVtb3RlRW50aXR5TmFtZSA9IHJlbW90ZUVudGl0eS5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgIGxldCBkZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgYW5jaG9yXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgdG9DYWNoZSA9IHtcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eSxcbiAgICAgICAgICAgICAgICBkZXRhaWxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChhc3NvY0luZm8uaXNMaXN0KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmlzTGlzdCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhc3NvY0luZm8ub3B0aW9uYWwpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwub3B0aW9uYWwgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBjYWNoZVtiYXNlXSA/IGNhY2hlW2Jhc2VdLmVudGl0eS5tZXRhLmtleUZpZWxkIDogdGhpcy5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IGFzc29jSW5mby5yZW1vdGVGaWVsZCB8fCB0aGlzLm1ldGEubmFtZTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5lbnRpdHkgPSBhc3NvY0luZm8uY29ubmVjdGVkQnk7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmtleUZpZWxkID0gdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uY29ubmVjdGVkQnkpLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLmNvbm5lY3RlZFdpdGggPSBhc3NvY0luZm8uY29ubmVjdGVkV2l0aDtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgdG9DYWNoZS5kZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAga2V5RmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgICAgIGFuY2hvcjogYXNzb2NJbmZvLnJlZmVyc1RvRmllbGQsXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsRmllbGQ6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICByZW1vdGVGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGRcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgZGV0YWlsLnN1YkFzc29jaWF0aW9ucyA9IFtcbiAgICAgICAgICAgICAgICAgICAgdG9DYWNoZS5kZXRhaWxcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhc3NvY0luZm8uaXNMaXN0KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBjYWNoZVtiYXNlXSA/IGNhY2hlW2Jhc2VdLmVudGl0eS5tZXRhLmtleUZpZWxkIDogdGhpcy5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IGFzc29jSW5mby5yZW1vdGVGaWVsZCB8fCB0aGlzLm1ldGEubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBhbmNob3I7XG4gICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXSkge1xuICAgICAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbIGRldGFpbCBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGllcmFyY2h5LnB1c2goZGV0YWlsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FjaGVbYXNzb2NdID0gdG9DYWNoZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGhpZXJhcmNoeTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2NQYXRoLCBjYWNoZSkgeyAgICAgICAgXG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jUGF0aC5zcGxpdCgnLicpOyAgICAgICAgXG4gICAgICAgIGxldCBiYXNlID0gcGFydHMuc2xpY2UoMCwgLTEpLmpvaW4oJy4nKTsgICAgICAgIFxuXG4gICAgICAgIGxldCBjYWNoZU5vZGUgPSBjYWNoZVtiYXNlXTtcbiAgICAgICAgaWYgKGNhY2hlTm9kZSkge1xuICAgICAgICAgICAgbGV0IGxhc3QgPSBwYXJ0cy5wb3AoKTtcbiAgICAgICAgICAgIGxldCBhc3NvY0luZm8gPSBjYWNoZU5vZGUuZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2xhc3RdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY0luZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBvZiBcIiR7dGhpcy5tZXRhLm5hbWV9XCIgZW50aXR5OiAke2Fzc29jUGF0aH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFsgdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uZW50aXR5KSwgYmFzZSwgbGFzdCwgYXNzb2NJbmZvIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcywgY3VycmVudCwgY3VycmVudEFzc29jSW5mbztcblxuICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY3VycmVudCA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICBjdXJyZW50QXNzb2NJbmZvID0gZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2N1cnJlbnRdO1xuICAgICAgICAgICAgaWYgKCFjdXJyZW50QXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVudGl0eSA9IHRoaXMuZGIubW9kZWwoY3VycmVudEFzc29jSW5mby5lbnRpdHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFsgZW50aXR5LCBiYXNlLCBjdXJyZW50LCBjdXJyZW50QXNzb2NJbmZvIF07XG4gICAgfVxuXG4gICAgc3RhdGljIF9tYXBSZWNvcmRzVG9PYmplY3RzKFtyb3dzLCBjb2x1bW5zLCBhbGlhc01hcF0sIGhpZXJhcmNoeSkge1xuICAgICAgICBsZXQgbWFpbkluZGV4ID0ge307XG5cbiAgICAgICAgZnVuY3Rpb24gbWVyZ2VSZWNvcmQoZXhpc3RpbmdSb3csIHJvd09iamVjdCwgYXNzb2NpYXRpb25zKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBfLmVhY2goYXNzb2NpYXRpb25zLCAoeyBrZXlGaWVsZCwgYW5jaG9yLCBpc0xpc3QsIHN1YkFzc29jaWF0aW9ucyB9KSA9PiB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBrZXkgPSAnOicgKyBhbmNob3I7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJPYmogPSByb3dPYmplY3Rba2V5XVxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleGVzID0gZXhpc3RpbmdSb3cuc3ViSW5kZXhlc1trZXldO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCByb3dLZXkgPSBzdWJPYmpba2V5RmllbGRdO1xuICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHJvd0tleSkpIHJldHVybjtcblxuICAgICAgICAgICAgICAgIGxldCBleGlzdGluZ1N1YlJvdyA9IHN1YkluZGV4ZXMgJiYgc3ViSW5kZXhlc1tyb3dLZXldO1xuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1N1YlJvdykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVJlY29yZChleGlzdGluZ1N1YlJvdywgc3ViT2JqLCBzdWJBc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogaXNMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdSb3cucm93T2JqZWN0W2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUm93LnJvd09iamVjdFtrZXldLnB1c2goc3ViT2JqKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUm93LnJvd09iamVjdFtrZXldID0gWyBzdWJPYmogXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdDogc3ViT2JqICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXguc3ViSW5kZXhlcyA9IGJ1aWxkU3ViSW5kZXhlcyhzdWJPYmosIHN1YkFzc29jaWF0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgICAgICAgICBzdWJJbmRleGVzW3Jvd0tleV0gPSBzdWJJbmRleDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gYnVpbGRTdWJJbmRleGVzKHJvd09iamVjdCwgYXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICByZXR1cm4gYXNzb2NpYXRpb25zLnJlZHVjZSgoaW5kZXhlcywgeyBrZXlGaWVsZCwgYW5jaG9yLCBpc0xpc3QsIHN1YkFzc29jaWF0aW9ucyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGtleSA9ICc6JythbmNob3I7XG4gICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHJvd09iamVjdFtrZXldOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXggPSB7IFxuICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iamVjdCBcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzTGlzdCkgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHN1Yk9iamVjdFtrZXlGaWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rba2V5XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdFtrZXldID0gWyBzdWJPYmplY3QgXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc05pbChzdWJPYmplY3Rba2V5RmllbGRdKSkge1xuICAgICAgICAgICAgICAgICAgICBzdWJPYmplY3QgPSByb3dPYmplY3Rba2V5XSA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHN1Yk9iamVjdCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iamVjdCwgc3ViQXNzb2NpYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ZXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFtzdWJPYmplY3Rba2V5RmllbGRdXTogc3ViSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXhlcztcbiAgICAgICAgICAgIH0sIHt9KTsgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYXJyYXlPZk9ianMgPSBbXTtcblxuICAgICAgICByb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgICAgIGxldCByb3dPYmplY3QgPSB7fTsgLy8gaGFzaC1zdHlsZSBkYXRhIHJvd1xuICAgICAgICAgICAgbGV0IHRhYmxlQ2FjaGUgPSB7fTsgLy8gZnJvbSBhbGlhcyB0byBjaGlsZCBwcm9wIG9mIHJvd09iamVjdFxuXG4gICAgICAgICAgICByb3cucmVkdWNlKChyZXN1bHQsIHZhbHVlLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbCA9IGNvbHVtbnNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGNvbC50YWJsZSA9PT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjb2wubmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICBcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJ1Y2tldCA9IHRhYmxlQ2FjaGVbY29sLnRhYmxlXTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYnVja2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBidWNrZXRbY29sLm5hbWVdID0gdmFsdWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBub2RlUGF0aCA9IGFsaWFzTWFwW2NvbC50YWJsZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3ViT2JqZWN0ID0geyBbY29sLm5hbWVdOiB2YWx1ZSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVDYWNoZVtjb2wudGFibGVdID0gc3ViT2JqZWN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmFsdWVCeVBhdGgocmVzdWx0LCBub2RlUGF0aCwgc3ViT2JqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9LCByb3dPYmplY3QpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCByb3dLZXkgPSByb3dPYmplY3RbdGhpcy5tZXRhLmtleUZpZWxkXTtcbiAgICAgICAgICAgIGxldCBleGlzdGluZ1JvdyA9IG1haW5JbmRleFtyb3dLZXldO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93KSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdSb3csIHJvd09iamVjdCwgaGllcmFyY2h5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXJyYXlPZk9ianMucHVzaChyb3dPYmplY3QpO1xuICAgICAgICAgICAgICAgIG1haW5JbmRleFtyb3dLZXldID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0LCBcbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlczogYnVpbGRTdWJJbmRleGVzKHJvd09iamVjdCwgaGllcmFyY2h5KVxuICAgICAgICAgICAgICAgIH07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXJyYXlPZk9ianM7XG4gICAgfVxuXG4gICAgc3RhdGljIF9leHRyYWN0QXNzb2NpYXRpb25zKGRhdGEpIHtcbiAgICAgICAgbGV0IHJhdyA9IHt9LCBhc3NvY3MgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGRhdGEsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICBpZiAoay5zdGFydHNXaXRoKCc6JykpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3Nbay5zdWJzdHIoMSldID0gdjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmF3W2tdID0gdjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gWyByYXcsIGFzc29jcyBdOyAgICAgICAgXG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9jcmVhdGVBc3NvY3NfKGNvbnRleHQsIGFzc29jcykge1xuICAgICAgICBsZXQgbWV0YSA9IHRoaXMubWV0YS5hc3NvY2lhdGlvbnM7XG4gICAgICAgIGxldCBrZXlWYWx1ZSA9IGNvbnRleHQubGF0ZXN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG5cbiAgICAgICAgaWYgKF8uaXNOaWwoa2V5VmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignTWlzc2luZyByZXF1aXJlZCBwcmltYXJ5IGtleSBmaWVsZCB2YWx1ZS4gRW50aXR5OiAnICsgdGhpcy5tZXRhLm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oYXNzb2NzLCBhc3luYyAoZGF0YSwgYW5jaG9yKSA9PiB7XG4gICAgICAgICAgICBsZXQgYXNzb2NNZXRhID0gbWV0YVthbmNob3JdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY01ldGEpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBcIiR7YW5jaG9yfVwiIG9mIGVudGl0eSBcIiR7dGhpcy5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghYXNzb2NNZXRhLmNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVuc3VwcG9ydGVkIGFzc29jaWF0aW9uIHR5cGUsIFwiJHthbmNob3J9XCIgb2YgZW50aXR5IFwiJHt0aGlzLm1ldGEubmFtZX1cIi4gQ3VycmVudGx5IG9ubHkgc3VwcG9ydHMgbWFueS10by1tYW55IGFzc29jaWF0aW9uLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgYXNzb2NNb2RlbCA9IHRoaXMuZGIubW9kZWwoYXNzb2NNZXRhLmNvbm5lY3RlZEJ5KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXNzb2NNb2RlbC5jcmVhdGVfKHsgLi4uZGF0YSwgW2Fzc29jTWV0YS5yZW1vdGVGaWVsZF06IGtleVZhbHVlIH0sIGNvbnRleHQuY3JlYXRlT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7ICBcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMRW50aXR5TW9kZWw7Il19