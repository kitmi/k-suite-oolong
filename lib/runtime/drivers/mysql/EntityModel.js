"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  getValueByPath,
  setValueByPath,
  eachAsync_,
  fs
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static _translateSymbolToken(name) {
    if (name === 'now') {
      return this.db.connector.raw('NOW()');
    }

    throw new Error('not support');
  }

  static _serialize(value) {
    if (typeof value === 'boolean') return value ? 1 : 0;

    if (value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity. Detail: ' + error.message);
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async updateOne_(...args) {
    try {
      return await super.updateOne_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query
      }, context.connOptions);
    }

    return true;
  }

  static afterFindAll_(context, records) {
    if (context.findOptions.$toDictionary) return records.reduce((table, v) => {
      table[v[this.meta.keyField]] = v;
      return table;
    }, {});
    return records;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query
      }, context.connOptions);
    }
  }

  static _prepareAssociations(findOptions) {
    let associations = _.uniq(findOptions.$association).sort();

    let assocTable = {},
        counter = 0,
        cache = {};
    associations.forEach(assoc => {
      if (_.isPlainObject(assoc)) {
        let alias = assoc.alias;

        if (!assoc.alias) {
          alias = ':join' + ++counter;
        }

        assocTable[alias] = {
          entity: assoc.entity,
          joinType: assoc.type,
          output: assoc.output,
          alias,
          on: assoc.on,
          ...(assoc.dataset ? this.db.connector.buildQuery(assoc.entity, this._prepareQueries({ ...assoc.dataset,
            $variables: findOptions.$variables
          })) : {})
        };
      } else {
        this._loadAssocIntoTable(assocTable, cache, assoc);
      }
    });
    return assocTable;
  }

  static _loadAssocIntoTable(assocTable, cache, assoc) {
    if (cache[assoc]) return cache[assoc];
    let lastPos = assoc.lastIndexOf('.');
    let result;

    if (lastPos === -1) {
      result = cache[assoc] = assocTable[assoc] = { ...this.meta.associations[assoc]
      };
    } else {
      let base = assoc.substr(0, lastPos);
      let last = assoc.substr(lastPos + 1);
      let baseNode = cache[base];

      if (!baseNode) {
        console.log(base, last);
        baseNode = this._loadAssocIntoTable(assocTable, cache, base);
      }

      let entity = this.db.model(baseNode.entity);
      result = { ...entity.meta.associations[last]
      };

      if (!baseNode.subAssocs) {
        baseNode.subAssocs = {};
      }

      cache[assoc] = baseNode.subAssocs[last] = result;
    }

    if (result.assoc) {
      this._loadAssocIntoTable(assocTable, cache, assoc + '.' + result.assoc);
    }

    return result;
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) return;
        let objKey = ':' + anchor;
        let subObj = rowObject[objKey];
        let subIndexes = existingRow.subIndexes[objKey];
        let rowKey = subObj[key];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssocs) {
            mergeRecord(existingSubRow, subObj, subAssocs);
          }
        } else {
          if (!list) {
            throw new Error("Assertion failed: list");
          }

          if (existingRow.rowObject[objKey]) {
            existingRow.rowObject[objKey].push(subObj);
          } else {
            existingRow.rowObject[objKey] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssocs);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      let indexes = {};

      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) {
          return;
        }

        let objKey = ':' + anchor;
        let subObject = rowObject[objKey];
        let subIndex = {
          rowObject: subObject
        };

        if (list) {
          if (_.isNil(subObject[key])) {
            rowObject[objKey] = [];
            subObject = null;
          } else {
            rowObject[objKey] = [subObject];
          }
        } else if (subObject && _.isNil(subObject[key])) {
          subObject = rowObject[objKey] = null;
        }

        if (subObject) {
          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssocs);
          }

          indexes[objKey] = {
            [subObject[key]]: subIndex
          };
        }
      });

      return indexes;
    }

    let arrayOfObjs = [];
    rows.forEach((row, i) => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];

            if (nodePath) {
              let subObject = {
                [col.name]: value
              };
              tableCache[col.table] = subObject;
              setValueByPath(result, nodePath, subObject);
            }
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      let assocModel = this.db.model(assocMeta.entity);

      if (assocMeta.list) {
        data = _.castArray(data);
        return eachAsync_(data, item => assocModel.create_({ ...item,
          ...(assocMeta.field ? {
            [assocMeta.field]: keyValue
          } : {})
        }, context.createOptions, context.connOptions));
      }

      return assocModel.create_({ ...data,
        ...(assocMeta.field ? {
          [assocMeta.field]: keyValue
        } : {})
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZ2V0VmFsdWVCeVBhdGgiLCJzZXRWYWx1ZUJ5UGF0aCIsImVhY2hBc3luY18iLCJmcyIsIkRhdGVUaW1lIiwiRW50aXR5TW9kZWwiLCJPb2xvbmdVc2FnZUVycm9yIiwiQnVzaW5lc3NFcnJvciIsIk15U1FMRW50aXR5TW9kZWwiLCJoYXNBdXRvSW5jcmVtZW50IiwiYXV0b0lkIiwibWV0YSIsImZlYXR1cmVzIiwiZmllbGRzIiwiZmllbGQiLCJhdXRvSW5jcmVtZW50SWQiLCJfdHJhbnNsYXRlU3ltYm9sVG9rZW4iLCJuYW1lIiwiZGIiLCJjb25uZWN0b3IiLCJyYXciLCJFcnJvciIsIl9zZXJpYWxpemUiLCJ2YWx1ZSIsInRvSVNPIiwiaW5jbHVkZU9mZnNldCIsImNyZWF0ZV8iLCJhcmdzIiwiZXJyb3IiLCJlcnJvckNvZGUiLCJjb2RlIiwibWVzc2FnZSIsInVwZGF0ZU9uZV8iLCJhZnRlckNyZWF0ZV8iLCJjb250ZXh0IiwiaW5zZXJ0SWQiLCJyZXN1bHQiLCJsYXRlc3QiLCJjcmVhdGVPcHRpb25zIiwiJHJldHJpZXZlQ3JlYXRlZCIsImNvbmRpdGlvbiIsImdldFVuaXF1ZUtleVZhbHVlUGFpcnNGcm9tIiwiZmluZE9uZV8iLCIkcXVlcnkiLCJjb25uT3B0aW9ucyIsImFmdGVyVXBkYXRlXyIsInVwZGF0ZU9wdGlvbnMiLCIkcmV0cmlldmVVcGRhdGVkIiwiYWZ0ZXJGaW5kQWxsXyIsInJlY29yZHMiLCJmaW5kT3B0aW9ucyIsIiR0b0RpY3Rpb25hcnkiLCJyZWR1Y2UiLCJ0YWJsZSIsInYiLCJrZXlGaWVsZCIsImJlZm9yZURlbGV0ZV8iLCJkZWxldGVPcHRpb25zIiwiJHJldHJpZXZlRGVsZXRlZCIsImNvbm5lY3Rpb24iLCJiZWdpblRyYW5zYWN0aW9uXyIsImV4aXN0aW5nIiwiX3ByZXBhcmVBc3NvY2lhdGlvbnMiLCJhc3NvY2lhdGlvbnMiLCJ1bmlxIiwiJGFzc29jaWF0aW9uIiwic29ydCIsImFzc29jVGFibGUiLCJjb3VudGVyIiwiY2FjaGUiLCJmb3JFYWNoIiwiYXNzb2MiLCJpc1BsYWluT2JqZWN0IiwiYWxpYXMiLCJlbnRpdHkiLCJqb2luVHlwZSIsInR5cGUiLCJvdXRwdXQiLCJvbiIsImRhdGFzZXQiLCJidWlsZFF1ZXJ5IiwiX3ByZXBhcmVRdWVyaWVzIiwiJHZhcmlhYmxlcyIsIl9sb2FkQXNzb2NJbnRvVGFibGUiLCJsYXN0UG9zIiwibGFzdEluZGV4T2YiLCJiYXNlIiwic3Vic3RyIiwibGFzdCIsImJhc2VOb2RlIiwiY29uc29sZSIsImxvZyIsIm1vZGVsIiwic3ViQXNzb2NzIiwiX21hcFJlY29yZHNUb09iamVjdHMiLCJyb3dzIiwiY29sdW1ucyIsImFsaWFzTWFwIiwiaGllcmFyY2h5IiwibWFpbkluZGV4IiwibWVyZ2VSZWNvcmQiLCJleGlzdGluZ1JvdyIsInJvd09iamVjdCIsImVhY2giLCJzcWwiLCJrZXkiLCJsaXN0IiwiYW5jaG9yIiwib2JqS2V5Iiwic3ViT2JqIiwic3ViSW5kZXhlcyIsInJvd0tleSIsImlzTmlsIiwiZXhpc3RpbmdTdWJSb3ciLCJwdXNoIiwic3ViSW5kZXgiLCJidWlsZFN1YkluZGV4ZXMiLCJpbmRleGVzIiwic3ViT2JqZWN0IiwiYXJyYXlPZk9ianMiLCJyb3ciLCJpIiwidGFibGVDYWNoZSIsImNvbCIsImJ1Y2tldCIsIm5vZGVQYXRoIiwiX2V4dHJhY3RBc3NvY2lhdGlvbnMiLCJkYXRhIiwiYXNzb2NzIiwiZm9yT3duIiwiayIsInN0YXJ0c1dpdGgiLCJfY3JlYXRlQXNzb2NzXyIsImtleVZhbHVlIiwiYXNzb2NNZXRhIiwiYXNzb2NNb2RlbCIsImNhc3RBcnJheSIsIml0ZW0iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7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VU0sSUFBSyxJQUEvRSxDQUFOO0FBQ0g7O0FBRUQsVUFBSXNILFVBQVUsR0FBRyxLQUFLckgsRUFBTCxDQUFRMEUsS0FBUixDQUFjMEMsU0FBUyxDQUFDNUQsTUFBeEIsQ0FBakI7O0FBRUEsVUFBSTRELFNBQVMsQ0FBQzVCLElBQWQsRUFBb0I7QUFDaEJxQixRQUFBQSxJQUFJLEdBQUdoSSxDQUFDLENBQUN5SSxTQUFGLENBQVlULElBQVosQ0FBUDtBQUVBLGVBQU83SCxVQUFVLENBQUM2SCxJQUFELEVBQU9VLElBQUksSUFBSUYsVUFBVSxDQUFDN0csT0FBWCxDQUFtQixFQUFFLEdBQUcrRyxJQUFMO0FBQVcsY0FBSUgsU0FBUyxDQUFDeEgsS0FBVixHQUFrQjtBQUFFLGFBQUN3SCxTQUFTLENBQUN4SCxLQUFYLEdBQW1CdUg7QUFBckIsV0FBbEIsR0FBb0QsRUFBeEQ7QUFBWCxTQUFuQixFQUE2Rm5HLE9BQU8sQ0FBQ0ksYUFBckcsRUFBb0hKLE9BQU8sQ0FBQ1UsV0FBNUgsQ0FBZixDQUFqQjtBQUNIOztBQUVELGFBQU8yRixVQUFVLENBQUM3RyxPQUFYLENBQW1CLEVBQUUsR0FBR3FHLElBQUw7QUFBVyxZQUFJTyxTQUFTLENBQUN4SCxLQUFWLEdBQWtCO0FBQUUsV0FBQ3dILFNBQVMsQ0FBQ3hILEtBQVgsR0FBbUJ1SDtBQUFyQixTQUFsQixHQUFvRCxFQUF4RDtBQUFYLE9BQW5CLEVBQTZGbkcsT0FBTyxDQUFDSSxhQUFyRyxFQUFvSEosT0FBTyxDQUFDVSxXQUE1SCxDQUFQO0FBQ0gsS0FmZ0IsQ0FBakI7QUFnQkg7O0FBbmZzQzs7QUFzZjNDOEYsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbkksZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBnZXRWYWx1ZUJ5UGF0aCwgc2V0VmFsdWVCeVBhdGgsIGVhY2hBc3luY18sIGZzIH0gPSBVdGlsO1xuXG5jb25zdCB7IERhdGVUaW1lIH0gPSByZXF1aXJlKCdsdXhvbicpO1xuY29uc3QgRW50aXR5TW9kZWwgPSByZXF1aXJlKCcuLi8uLi9FbnRpdHlNb2RlbCcpO1xuY29uc3QgeyBPb2xvbmdVc2FnZUVycm9yLCBCdXNpbmVzc0Vycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBNeVNRTCBlbnRpdHkgbW9kZWwgY2xhc3MuXG4gKi9cbmNsYXNzIE15U1FMRW50aXR5TW9kZWwgZXh0ZW5kcyBFbnRpdHlNb2RlbCB7ICAgIFxuICAgIHN0YXRpYyBnZXQgaGFzQXV0b0luY3JlbWVudCgpIHtcbiAgICAgICAgbGV0IGF1dG9JZCA9IHRoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG4gICAgICAgIHJldHVybiBhdXRvSWQgJiYgdGhpcy5tZXRhLmZpZWxkc1thdXRvSWQuZmllbGRdLmF1dG9JbmNyZW1lbnRJZDsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VyaWFsaXplIHZhbHVlIGludG8gZGF0YWJhc2UgYWNjZXB0YWJsZSBmb3JtYXQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG5hbWUgLSBOYW1lIG9mIHRoZSBzeW1ib2wgdG9rZW4gXG4gICAgICovXG4gICAgc3RhdGljIF90cmFuc2xhdGVTeW1ib2xUb2tlbihuYW1lKSB7XG4gICAgICAgIGlmIChuYW1lID09PSAnbm93Jykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGIuY29ubmVjdG9yLnJhdygnTk9XKCknKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbm90IHN1cHBvcnQnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3NlcmlhbGl6ZSh2YWx1ZSkge1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHJldHVybiB2YWx1ZSA/IDEgOiAwO1xuXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGVUaW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBcblxuICAgIHN0YXRpYyBhc3luYyBjcmVhdGVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci5jcmVhdGVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4gRGV0YWlsOiAnICsgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX0RVUF9FTlRSWScpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihlcnJvci5tZXNzYWdlICsgYCB3aGlsZSBjcmVhdGluZyBhIG5ldyBcIiR7dGhpcy5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIHVwZGF0ZU9uZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLnVwZGF0ZU9uZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFBvc3QgY3JlYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29udGV4dC5jcmVhdGVPcHRpb25zXSAtIENyZWF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjcmVhdGVPcHRpb25zLiRyZXRyaWV2ZUNyZWF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlckNyZWF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAodGhpcy5oYXNBdXRvSW5jcmVtZW50KSB7XG4gICAgICAgICAgICBsZXQgeyBpbnNlcnRJZCB9ID0gY29udGV4dC5yZXN1bHQ7XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdFt0aGlzLm1ldGEuZmVhdHVyZXMuYXV0b0lkLmZpZWxkXSA9IGluc2VydElkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQuY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkKSB7XG4gICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gdGhpcy5nZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbShjb250ZXh0LmxhdGVzdCk7XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbmRpdGlvbiB9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3QgdXBkYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdXBkYXRlT3B0aW9uc10gLSBVcGRhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbdXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSB1cGRhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJVcGRhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcmV0cmlldmVVcGRhdGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQudXBkYXRlT3B0aW9ucy4kcXVlcnkgfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYWZ0ZXJGaW5kQWxsXyhjb250ZXh0LCByZWNvcmRzKSB7XG4gICAgICAgIGlmIChjb250ZXh0LmZpbmRPcHRpb25zLiR0b0RpY3Rpb25hcnkpIHJldHVybiByZWNvcmRzLnJlZHVjZSgodGFibGUsIHYpID0+IHtcbiAgICAgICAgICAgIHRhYmxlW3ZbdGhpcy5tZXRhLmtleUZpZWxkXV0gPSB2O1xuICAgICAgICAgICAgcmV0dXJuIHRhYmxlO1xuICAgICAgICB9LCB7fSk7XG5cbiAgICAgICAgcmV0dXJuIHJlY29yZHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQmVmb3JlIGRlbGV0aW5nIGFuIGVudGl0eS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtjb250ZXh0LmRlbGV0ZU9wdGlvbnNdIC0gRGVsZXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2RlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZF0gLSBSZXRyaWV2ZSB0aGUgcmVjZW50bHkgZGVsZXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGJlZm9yZURlbGV0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC5kZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghY29udGV4dC5jb25uT3B0aW9ucyB8fCAhY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucyB8fCAoY29udGV4dC5jb25uT3B0aW9ucyA9IHt9KTtcblxuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZGIuY29ubmVjdG9yLmJlZ2luVHJhbnNhY3Rpb25fKCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQuZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHF1ZXJ5IH0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHsqfSBmaW5kT3B0aW9ucyBcbiAgICAgKi9cbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoZmluZE9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBfLnVuaXEoZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKS5zb3J0KCk7ICAgICAgICBcbiAgICAgICAgbGV0IGFzc29jVGFibGUgPSB7fSwgY291bnRlciA9IDAsIGNhY2hlID0ge307ICAgICAgIFxuXG4gICAgICAgIGFzc29jaWF0aW9ucy5mb3JFYWNoKGFzc29jID0+IHtcbiAgICAgICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYXNzb2MpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFsaWFzID0gYXNzb2MuYWxpYXM7XG4gICAgICAgICAgICAgICAgaWYgKCFhc3NvYy5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICBhbGlhcyA9ICc6am9pbicgKyArK2NvdW50ZXI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXNzb2NUYWJsZVthbGlhc10gPSB7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiBhc3NvYy50eXBlLCBcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiBhc3NvYy5vdXRwdXQsXG4gICAgICAgICAgICAgICAgICAgIGFsaWFzLFxuICAgICAgICAgICAgICAgICAgICBvbjogYXNzb2Mub24sXG4gICAgICAgICAgICAgICAgICAgIC4uLihhc3NvYy5kYXRhc2V0ID8gdGhpcy5kYi5jb25uZWN0b3IuYnVpbGRRdWVyeShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NvYy5lbnRpdHksIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVRdWVyaWVzKHsgLi4uYXNzb2MuZGF0YXNldCwgJHZhcmlhYmxlczogZmluZE9wdGlvbnMuJHZhcmlhYmxlcyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgKSA6IHt9KSAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9hZEFzc29jSW50b1RhYmxlKGFzc29jVGFibGUsIGNhY2hlLCBhc3NvYyk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgcmV0dXJuIGFzc29jVGFibGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHsqfSBhc3NvY1RhYmxlIC0gSGllcmFyY2h5IHdpdGggc3ViQXNzb2NzXG4gICAgICogQHBhcmFtIHsqfSBjYWNoZSAtIERvdHRlZCBwYXRoIGFzIGtleVxuICAgICAqIEBwYXJhbSB7Kn0gYXNzb2MgLSBEb3R0ZWQgcGF0aFxuICAgICAqL1xuICAgIHN0YXRpYyBfbG9hZEFzc29jSW50b1RhYmxlKGFzc29jVGFibGUsIGNhY2hlLCBhc3NvYykge1xuICAgICAgICBpZiAoY2FjaGVbYXNzb2NdKSByZXR1cm4gY2FjaGVbYXNzb2NdO1xuXG4gICAgICAgIGxldCBsYXN0UG9zID0gYXNzb2MubGFzdEluZGV4T2YoJy4nKTsgICAgICAgIFxuICAgICAgICBsZXQgcmVzdWx0OyAgXG5cbiAgICAgICAgaWYgKGxhc3RQb3MgPT09IC0xKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgcmVzdWx0ID0gY2FjaGVbYXNzb2NdID0gYXNzb2NUYWJsZVthc3NvY10gPSB7IC4uLnRoaXMubWV0YS5hc3NvY2lhdGlvbnNbYXNzb2NdIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgYmFzZSA9IGFzc29jLnN1YnN0cigwLCBsYXN0UG9zKTtcbiAgICAgICAgICAgIGxldCBsYXN0ID0gYXNzb2Muc3Vic3RyKGxhc3RQb3MrMSk7ICAgICAgICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgYmFzZU5vZGUgPSBjYWNoZVtiYXNlXTtcbiAgICAgICAgICAgIGlmICghYmFzZU5vZGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhiYXNlLCBsYXN0KTtcbiAgICAgICAgICAgICAgICBiYXNlTm9kZSA9IHRoaXMuX2xvYWRBc3NvY0ludG9UYWJsZShhc3NvY1RhYmxlLCBjYWNoZSwgYmFzZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmRiLm1vZGVsKGJhc2VOb2RlLmVudGl0eSk7XG4gICAgICAgICAgICByZXN1bHQgPSB7IC4uLmVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tsYXN0XSB9O1xuXG4gICAgICAgICAgICBpZiAoIWJhc2VOb2RlLnN1YkFzc29jcykge1xuICAgICAgICAgICAgICAgIGJhc2VOb2RlLnN1YkFzc29jcyA9IHt9O1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgY2FjaGVbYXNzb2NdID0gYmFzZU5vZGUuc3ViQXNzb2NzW2xhc3RdID0gcmVzdWx0O1xuICAgICAgICB9ICAgICAgXG5cbiAgICAgICAgaWYgKHJlc3VsdC5hc3NvYykge1xuICAgICAgICAgICAgdGhpcy5fbG9hZEFzc29jSW50b1RhYmxlKGFzc29jVGFibGUsIGNhY2hlLCBhc3NvYyArICcuJyArIHJlc3VsdC5hc3NvYyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8qXG4gICAgc3RhdGljIF9wcmVwYXJlQXNzb2NpYXRpb25zKGZpbmRPcHRpb25zKSB7IFxuICAgICAgICBsZXQgYXNzb2NpYXRpb25zID0gZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uLmNvbmNhdCgpLnNvcnQoKTsgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IGNhY2hlID0ge30sIGhpZXJhcmNoeSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgYXNzb2NpYXRpb25zLmZvckVhY2goYXNzb2MgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhc3NvYykpIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkucHVzaCh7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiBhc3NvYy50eXBlLCBcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiBhc3NvYy5vdXRwdXQsXG4gICAgICAgICAgICAgICAgICAgIC4uLihhc3NvYy5hbGlhcyA/IHsgYWxpYXM6IGFzc29jLmFsaWFzIH0gOiB7fSksXG4gICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLm9uLFxuICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmRiLmNvbm5lY3Rvci5idWlsZFF1ZXJ5KGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcmVwYXJlUXVlcmllcyh7IC4uLmFzc29jLmRhdGFzZXQsICR2YXJpYWJsZXM6IGZpbmRPcHRpb25zLiR2YXJpYWJsZXMgfSkpICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgWyByZW1vdGVFbnRpdHksIGJhc2UsIGFuY2hvciwgYXNzb2NJbmZvIF0gPSB0aGlzLl9nZXRSZWxhdGVkRW50aXR5KGFzc29jLCBjYWNoZSk7XG4gICAgICAgICAgICBhc3NlcnQ6IGFzc29jSW5mbzsgICAgICAgICAgICBcblxuICAgICAgICAgICAgbGV0IHJlbW90ZUVudGl0eU5hbWUgPSByZW1vdGVFbnRpdHkubWV0YS5uYW1lO1xuXG4gICAgICAgICAgICBsZXQgZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICBrZXlGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgIGFuY2hvclxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgbGV0IHRvQ2FjaGUgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHksXG4gICAgICAgICAgICAgICAgZGV0YWlsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5pc0xpc3QgPSB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLm9wdGlvbmFsKSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLm9wdGlvbmFsID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRCeSkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgICAgICBkZXRhaWwuZW50aXR5ID0gYXNzb2NJbmZvLmNvbm5lY3RlZEJ5O1xuICAgICAgICAgICAgICAgIGRldGFpbC5rZXlGaWVsZCA9IHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KS5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5jb25uZWN0ZWRXaXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5jb25uZWN0ZWRXaXRoID0gYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGg7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsID0ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU4nLFxuICAgICAgICAgICAgICAgICAgICBhbmNob3I6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBsb2NhbEZpZWxkOiBhc3NvY0luZm8ucmVmZXJzVG9GaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgcmVtb3RlRmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbXG4gICAgICAgICAgICAgICAgICAgIHRvQ2FjaGUuZGV0YWlsXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NJbmZvLmlzTGlzdCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5sb2NhbEZpZWxkID0gY2FjaGVbYmFzZV0gPyBjYWNoZVtiYXNlXS5lbnRpdHkubWV0YS5rZXlGaWVsZCA6IHRoaXMubWV0YS5rZXlGaWVsZDtcblxuICAgICAgICAgICAgICAgIGlmIChhc3NvY0luZm8ucmVtb3RlRmllbGRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZHMgPSBhc3NvY0luZm8ucmVtb3RlRmllbGRzO1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwuam9pblR5cGUgPSAnUklHSFQgSk9JTic7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkIHx8IHRoaXMubWV0YS5uYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBhbmNob3I7XG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5yZW1vdGVGaWVsZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkcyA9IGFzc29jSW5mby5yZW1vdGVGaWVsZHM7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5qb2luVHlwZSA9ICdSSUdIVCBKT0lOJztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXSkge1xuICAgICAgICAgICAgICAgIGlmIChjYWNoZVtiYXNlXS5kZXRhaWwuc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMgPSBbIGRldGFpbCBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGllcmFyY2h5LnB1c2goZGV0YWlsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FjaGVbYXNzb2NdID0gdG9DYWNoZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGhpZXJhcmNoeTtcbiAgICB9Ki9cblxuICAgIC8qXG4gICAgc3RhdGljIF9nZXRSZWxhdGVkRW50aXR5KGFzc29jUGF0aCwgY2FjaGUpIHsgICAgICAgIFxuICAgICAgICBsZXQgcGFydHMgPSBhc3NvY1BhdGguc3BsaXQoJy4nKTsgICAgICAgIFxuICAgICAgICBsZXQgYmFzZSA9IHBhcnRzLnNsaWNlKDAsIC0xKS5qb2luKCcuJyk7ICAgICAgICBcblxuICAgICAgICBsZXQgY2FjaGVOb2RlID0gY2FjaGVbYmFzZV07XG4gICAgICAgIGlmIChjYWNoZU5vZGUpIHtcbiAgICAgICAgICAgIGxldCBsYXN0ID0gcGFydHMucG9wKCk7XG4gICAgICAgICAgICBsZXQgYXNzb2NJbmZvID0gY2FjaGVOb2RlLmVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tsYXN0XTtcbiAgICAgICAgICAgIGlmICghYXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBbIHRoaXMuZGIubW9kZWwoYXNzb2NJbmZvLmVudGl0eSksIGJhc2UsIGxhc3QsIGFzc29jSW5mbyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMsIGN1cnJlbnQsIGN1cnJlbnRBc3NvY0luZm87XG5cbiAgICAgICAgd2hpbGUgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgY3VycmVudEFzc29jSW5mbyA9IGVudGl0eS5tZXRhLmFzc29jaWF0aW9uc1tjdXJyZW50XTtcbiAgICAgICAgICAgIGlmICghY3VycmVudEFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIG9mIFwiJHt0aGlzLm1ldGEubmFtZX1cIiBlbnRpdHk6ICR7YXNzb2NQYXRofWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbnRpdHkgPSB0aGlzLmRiLm1vZGVsKGN1cnJlbnRBc3NvY0luZm8uZW50aXR5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbIGVudGl0eSwgYmFzZSwgY3VycmVudCwgY3VycmVudEFzc29jSW5mbyBdO1xuICAgIH0qL1xuXG4gICAgc3RhdGljIF9tYXBSZWNvcmRzVG9PYmplY3RzKFtyb3dzLCBjb2x1bW5zLCBhbGlhc01hcF0sIGhpZXJhcmNoeSkge1xuICAgICAgICBsZXQgbWFpbkluZGV4ID0ge307ICAgICAgICBcblxuICAgICAgICBmdW5jdGlvbiBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChhc3NvY2lhdGlvbnMsICh7IHNxbCwga2V5LCBsaXN0LCBzdWJBc3NvY3MgfSwgYW5jaG9yKSA9PiB7IFxuICAgICAgICAgICAgICAgIGlmIChzcWwpIHJldHVybjsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICBsZXQgb2JqS2V5ID0gJzonICsgYW5jaG9yOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqID0gcm93T2JqZWN0W29iaktleV1cbiAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXhlcyA9IGV4aXN0aW5nUm93LnN1YkluZGV4ZXNbb2JqS2V5XTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBqb2luZWQgYW4gZW1wdHkgcmVjb3JkXG4gICAgICAgICAgICAgICAgbGV0IHJvd0tleSA9IHN1Yk9ialtrZXldO1xuICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHJvd0tleSkpIHJldHVybjtcblxuICAgICAgICAgICAgICAgIGxldCBleGlzdGluZ1N1YlJvdyA9IHN1YkluZGV4ZXMgJiYgc3ViSW5kZXhlc1tyb3dLZXldO1xuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1N1YlJvdykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXJnZVJlY29yZChleGlzdGluZ1N1YlJvdywgc3ViT2JqLCBzdWJBc3NvY3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHsgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogbGlzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93LnJvd09iamVjdFtvYmpLZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rbb2JqS2V5XS5wdXNoKHN1Yk9iaik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Jvdy5yb3dPYmplY3Rbb2JqS2V5XSA9IFsgc3ViT2JqIF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Q6IHN1Yk9iaiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqLCBzdWJBc3NvY3MpXG4gICAgICAgICAgICAgICAgICAgIH0gICAgXG5cbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlc1tyb3dLZXldID0gc3ViSW5kZXg7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGJ1aWxkU3ViSW5kZXhlcyhyb3dPYmplY3QsIGFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgbGV0IGluZGV4ZXMgPSB7fTtcblxuICAgICAgICAgICAgXy5lYWNoKGFzc29jaWF0aW9ucywgKHsgc3FsLCBrZXksIGxpc3QsIHN1YkFzc29jcyB9LCBhbmNob3IpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc3FsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgb2JqS2V5ID0gJzonICsgYW5jaG9yO1xuICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSByb3dPYmplY3Rbb2JqS2V5XTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmplY3QgXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGlmIChsaXN0KSB7ICAgXG4gICAgICAgICAgICAgICAgICAgIC8vbWFueSB0byAqICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL3N1Yk9iamVjdCBub3QgZXhpc3QsIGp1c3QgZmlsbGVkIHdpdGggbnVsbCBieSBqb2luaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rbb2JqS2V5XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3ViT2JqZWN0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdFtvYmpLZXldID0gWyBzdWJPYmplY3QgXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3ViT2JqZWN0ICYmIF8uaXNOaWwoc3ViT2JqZWN0W2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IHJvd09iamVjdFtvYmpLZXldID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoc3ViT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqZWN0LCBzdWJBc3NvY3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlc1tvYmpLZXldID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgW3N1Yk9iamVjdFtrZXldXTogc3ViSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTsgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gaW5kZXhlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhcnJheU9mT2JqcyA9IFtdO1xuXG4gICAgICAgIC8vcHJvY2VzcyBlYWNoIHJvd1xuICAgICAgICByb3dzLmZvckVhY2goKHJvdywgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHJvd09iamVjdCA9IHt9OyAvLyBoYXNoLXN0eWxlIGRhdGEgcm93XG4gICAgICAgICAgICBsZXQgdGFibGVDYWNoZSA9IHt9OyAvLyBmcm9tIGFsaWFzIHRvIGNoaWxkIHByb3Agb2Ygcm93T2JqZWN0XG5cbiAgICAgICAgICAgIHJvdy5yZWR1Y2UoKHJlc3VsdCwgdmFsdWUsIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgY29sID0gY29sdW1uc1tpXTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoY29sLnRhYmxlID09PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2NvbC5uYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgYnVja2V0ID0gdGFibGVDYWNoZVtjb2wudGFibGVdOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vYWxyZWFkeSBuZXN0ZWQgaW5zaWRlIFxuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0W2NvbC5uYW1lXSA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZVBhdGggPSBhbGlhc01hcFtjb2wudGFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHsgW2NvbC5uYW1lXTogdmFsdWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZUNhY2hlW2NvbC50YWJsZV0gPSBzdWJPYmplY3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmFsdWVCeVBhdGgocmVzdWx0LCBub2RlUGF0aCwgc3ViT2JqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9LCByb3dPYmplY3QpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCByb3dLZXkgPSByb3dPYmplY3RbdGhpcy5tZXRhLmtleUZpZWxkXTtcbiAgICAgICAgICAgIGxldCBleGlzdGluZ1JvdyA9IG1haW5JbmRleFtyb3dLZXldO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93KSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdSb3csIHJvd09iamVjdCwgaGllcmFyY2h5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXJyYXlPZk9ianMucHVzaChyb3dPYmplY3QpO1xuICAgICAgICAgICAgICAgIG1haW5JbmRleFtyb3dLZXldID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0LCBcbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlczogYnVpbGRTdWJJbmRleGVzKHJvd09iamVjdCwgaGllcmFyY2h5KVxuICAgICAgICAgICAgICAgIH07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXJyYXlPZk9ianM7XG4gICAgfVxuXG4gICAgc3RhdGljIF9leHRyYWN0QXNzb2NpYXRpb25zKGRhdGEpIHtcbiAgICAgICAgbGV0IHJhdyA9IHt9LCBhc3NvY3MgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGRhdGEsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICBpZiAoay5zdGFydHNXaXRoKCc6JykpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3Nbay5zdWJzdHIoMSldID0gdjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmF3W2tdID0gdjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gWyByYXcsIGFzc29jcyBdOyAgICAgICAgXG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9jcmVhdGVBc3NvY3NfKGNvbnRleHQsIGFzc29jcykge1xuICAgICAgICBsZXQgbWV0YSA9IHRoaXMubWV0YS5hc3NvY2lhdGlvbnM7XG4gICAgICAgIGxldCBrZXlWYWx1ZSA9IGNvbnRleHQubGF0ZXN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG5cbiAgICAgICAgaWYgKF8uaXNOaWwoa2V5VmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignTWlzc2luZyByZXF1aXJlZCBwcmltYXJ5IGtleSBmaWVsZCB2YWx1ZS4gRW50aXR5OiAnICsgdGhpcy5tZXRhLm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oYXNzb2NzLCBhc3luYyAoZGF0YSwgYW5jaG9yKSA9PiB7XG4gICAgICAgICAgICBsZXQgYXNzb2NNZXRhID0gbWV0YVthbmNob3JdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY01ldGEpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBcIiR7YW5jaG9yfVwiIG9mIGVudGl0eSBcIiR7dGhpcy5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGxldCBhc3NvY01vZGVsID0gdGhpcy5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KTtcblxuICAgICAgICAgICAgaWYgKGFzc29jTWV0YS5saXN0KSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IF8uY2FzdEFycmF5KGRhdGEpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oZGF0YSwgaXRlbSA9PiBhc3NvY01vZGVsLmNyZWF0ZV8oeyAuLi5pdGVtLCAuLi4oYXNzb2NNZXRhLmZpZWxkID8geyBbYXNzb2NNZXRhLmZpZWxkXToga2V5VmFsdWUgfSA6IHt9KSB9LCBjb250ZXh0LmNyZWF0ZU9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFzc29jTW9kZWwuY3JlYXRlXyh7IC4uLmRhdGEsIC4uLihhc3NvY01ldGEuZmllbGQgPyB7IFthc3NvY01ldGEuZmllbGRdOiBrZXlWYWx1ZSB9IDoge30pIH0sIGNvbnRleHQuY3JlYXRlT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7ICBcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMRW50aXR5TW9kZWw7Il19