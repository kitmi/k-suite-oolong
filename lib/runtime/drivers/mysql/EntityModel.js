"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static serialize(dataRecord) {
    _.forOwn(dataRecord, (value, fieldName) => {
      let fieldMeta = this.meta.fields[fieldName];

      if (fieldMeta.type === 'datetime') {
        if (typeof value === 'object' && value.oolType === 'SymbolToken') {
          if (value.name === 'now') {
            dataRecord[fieldName] = this.db.connector.raw('NOW()');
          }
        }

        if (value instanceof DateTime) {
          dataRecord[fieldName] = value.toISO({
            includeOffset: false
          });
        }
      } else if (fieldMeta.type === 'boolean') {
        dataRecord[fieldName] = dataRecord[fieldName] ? 1 : 0;
      }
    });
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(associations) {
    associations = associations.concat().sort();
    let cache = {},
        hierarchy = [];
    associations.forEach(assoc => {
      let [remoteEntity, base, anchor, assocInfo] = this._getRelatedEntity(assoc, cache);

      if (!assocInfo) {
        throw new Error("Assertion failed: assocInfo");
      }

      let remoteEntityName = remoteEntity.meta.name;
      let detail = {
        entity: remoteEntityName,
        keyField: remoteEntity.meta.keyField,
        joinType: 'LEFT JOIN',
        anchor
      };
      let toCache = {
        entity: remoteEntity,
        detail
      };

      if (assocInfo.isList) {
        detail.isList = true;
      }

      if (assocInfo.optional) {
        detail.optional = true;
      }

      if (assocInfo.connectedBy) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
        detail.entity = assocInfo.connectedBy;
        detail.keyField = this.db.model(assocInfo.connectedBy).meta.keyField;

        if (assocInfo.connectedWith) {
          detail.connectedWith = assocInfo.connectedWith;
        }

        toCache.detail = {
          entity: remoteEntityName,
          keyField: remoteEntity.meta.keyField,
          joinType: 'LEFT JOIN',
          anchor: assocInfo.refersToField,
          localField: assocInfo.refersToField,
          remoteField: remoteEntity.meta.keyField
        };
        detail.subAssociations = [toCache.detail];
      } else if (assocInfo.isList) {
        detail.localField = cache[base] ? cache[base].entity.meta.keyField : this.meta.keyField;
        detail.remoteField = assocInfo.remoteField || this.meta.name;
      } else {
        detail.localField = anchor;
        detail.remoteField = remoteEntity.meta.keyField;
      }

      if (cache[base]) {
        if (cache[base].detail.subAssociations) {
          cache[base].detail.subAssociations.push(detail);
        } else {
          cache[base].detail.subAssociations = [detail];
        }
      } else {
        hierarchy.push(detail);
      }

      cache[assoc] = toCache;
    });
    return hierarchy;
  }

  static _getRelatedEntity(assocPath, cache) {
    let parts = assocPath.split('.');
    let base = parts.slice(0, -1).join('.');
    let cacheNode = cache[base];

    if (cacheNode) {
      let last = parts.pop();
      let assocInfo = cacheNode.entity.meta.associations[last];

      if (!assocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      return [this.db.model(assocInfo.entity), base, last, assocInfo];
    }

    let entity = this,
        current,
        currentAssocInfo;

    while (parts.length > 0) {
      current = parts.shift();
      currentAssocInfo = entity.meta.associations[current];

      if (!currentAssocInfo) {
        throw new BusinessError(`Unknown association of "${this.meta.name}" entity: ${assocPath}`);
      }

      entity = this.db.model(currentAssocInfo.entity);
    }

    return [entity, base, current, currentAssocInfo];
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObj = rowObject[key];
        let subIndexes = existingRow.subIndexes[key];
        let rowKey = subObj[keyField];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssociations) {
            mergeRecord(existingSubRow, subObj, subAssociations);
          }
        } else {
          if (!isList) {
            throw new Error("Assertion failed: isList");
          }

          if (existingRow.rowObject[key]) {
            existingRow.rowObject[key].push(subObj);
          } else {
            existingRow.rowObject[key] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssociations);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      return associations.reduce((indexes, {
        keyField,
        anchor,
        isList,
        subAssociations
      }) => {
        let key = ':' + anchor;
        let subObject = rowObject[key];
        let subIndex = {
          rowObject: subObject
        };

        if (isList) {
          if (_.isNil(subObject[keyField])) {
            rowObject[key] = [];
            subObject = null;
          } else {
            rowObject[key] = [subObject];
          }
        } else if (_.isNil(subObject[keyField])) {
          subObject = rowObject[key] = null;
        }

        if (subObject) {
          if (subAssociations) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssociations);
          }

          indexes[key] = {
            [subObject[keyField]]: subIndex
          };
        }

        return indexes;
      }, {});
    }

    let arrayOfObjs = [];
    rows.forEach(row => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];
            let subObject = {
              [col.name]: value
            };
            tableCache[col.table] = subObject;
            setValueByPath(result, nodePath, subObject);
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      if (!assocMeta.connectedBy) {
        throw new BusinessError(`Unsupported association type, "${anchor}" of entity "${this.meta.name}". Currently only supports many-to-many association.`);
      }

      let assocModel = this.db.model(assocMeta.connectedBy);
      console.log(data);
      return assocModel.create_({ ...data,
        [assocMeta.remoteField]: keyValue
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiRGF0ZVRpbWUiLCJFbnRpdHlNb2RlbCIsIk9vbG9uZ1VzYWdlRXJyb3IiLCJCdXNpbmVzc0Vycm9yIiwiTXlTUUxFbnRpdHlNb2RlbCIsImhhc0F1dG9JbmNyZW1lbnQiLCJhdXRvSWQiLCJtZXRhIiwiZmVhdHVyZXMiLCJmaWVsZHMiLCJmaWVsZCIsImF1dG9JbmNyZW1lbnRJZCIsInNlcmlhbGl6ZSIsImRhdGFSZWNvcmQiLCJmb3JPd24iLCJ2YWx1ZSIsImZpZWxkTmFtZSIsImZpZWxkTWV0YSIsInR5cGUiLCJvb2xUeXBlIiwibmFtZSIsImRiIiwiY29ubmVjdG9yIiwicmF3IiwidG9JU08iLCJpbmNsdWRlT2Zmc2V0IiwiY3JlYXRlXyIsImFyZ3MiLCJlcnJvciIsImVycm9yQ29kZSIsImNvZGUiLCJtZXNzYWdlIiwidXBkYXRlXyIsImFmdGVyQ3JlYXRlXyIsImNvbnRleHQiLCJpbnNlcnRJZCIsInJlc3VsdCIsImxhdGVzdCIsImNyZWF0ZU9wdGlvbnMiLCIkcmV0cmlldmVDcmVhdGVkIiwiY29uZGl0aW9uIiwiZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20iLCJmaW5kT25lXyIsIiRxdWVyeSIsIiR1bmJveGluZyIsImNvbm5PcHRpb25zIiwiYWZ0ZXJVcGRhdGVfIiwidXBkYXRlT3B0aW9ucyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJiZWZvcmVEZWxldGVfIiwiZGVsZXRlT3B0aW9ucyIsIiRyZXRyaWV2ZURlbGV0ZWQiLCJjb25uZWN0aW9uIiwiYmVnaW5UcmFuc2FjdGlvbl8iLCJleGlzdGluZyIsIl9wcmVwYXJlQXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25zIiwiY29uY2F0Iiwic29ydCIsImNhY2hlIiwiaGllcmFyY2h5IiwiZm9yRWFjaCIsImFzc29jIiwicmVtb3RlRW50aXR5IiwiYmFzZSIsImFuY2hvciIsImFzc29jSW5mbyIsIl9nZXRSZWxhdGVkRW50aXR5IiwicmVtb3RlRW50aXR5TmFtZSIsImRldGFpbCIsImVudGl0eSIsImtleUZpZWxkIiwiam9pblR5cGUiLCJ0b0NhY2hlIiwiaXNMaXN0Iiwib3B0aW9uYWwiLCJjb25uZWN0ZWRCeSIsImxvY2FsRmllbGQiLCJyZW1vdGVGaWVsZCIsIm1vZGVsIiwiY29ubmVjdGVkV2l0aCIsInJlZmVyc1RvRmllbGQiLCJzdWJBc3NvY2lhdGlvbnMiLCJwdXNoIiwiYXNzb2NQYXRoIiwicGFydHMiLCJzcGxpdCIsInNsaWNlIiwiam9pbiIsImNhY2hlTm9kZSIsImxhc3QiLCJwb3AiLCJjdXJyZW50IiwiY3VycmVudEFzc29jSW5mbyIsImxlbmd0aCIsInNoaWZ0IiwiX21hcFJlY29yZHNUb09iamVjdHMiLCJyb3dzIiwiY29sdW1ucyIsImFsaWFzTWFwIiwibWFpbkluZGV4IiwibWVyZ2VSZWNvcmQiLCJleGlzdGluZ1JvdyIsInJvd09iamVjdCIsImVhY2giLCJrZXkiLCJzdWJPYmoiLCJzdWJJbmRleGVzIiwicm93S2V5IiwiaXNOaWwiLCJleGlzdGluZ1N1YlJvdyIsInN1YkluZGV4IiwiYnVpbGRTdWJJbmRleGVzIiwicmVkdWNlIiwiaW5kZXhlcyIsInN1Yk9iamVjdCIsImFycmF5T2ZPYmpzIiwicm93IiwidGFibGVDYWNoZSIsImkiLCJjb2wiLCJ0YWJsZSIsImJ1Y2tldCIsIm5vZGVQYXRoIiwiX2V4dHJhY3RBc3NvY2lhdGlvbnMiLCJkYXRhIiwiYXNzb2NzIiwidiIsImsiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiX2NyZWF0ZUFzc29jc18iLCJrZXlWYWx1ZSIsImFzc29jTWV0YSIsImFzc29jTW9kZWwiLCJjb25zb2xlIiwibG9nIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxV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Q0MsT0FBUCxHQUFpQnRJLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgc2V0VmFsdWVCeVBhdGgsIGVhY2hBc3luY18gfSA9IFV0aWw7XG5cbmNvbnN0IHsgRGF0ZVRpbWUgfSA9IHJlcXVpcmUoJ2x1eG9uJyk7XG5jb25zdCBFbnRpdHlNb2RlbCA9IHJlcXVpcmUoJy4uLy4uL0VudGl0eU1vZGVsJyk7XG5jb25zdCB7IE9vbG9uZ1VzYWdlRXJyb3IsIEJ1c2luZXNzRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL0Vycm9ycycpO1xuXG4vKipcbiAqIE15U1FMIGVudGl0eSBtb2RlbCBjbGFzcy5cbiAqL1xuY2xhc3MgTXlTUUxFbnRpdHlNb2RlbCBleHRlbmRzIEVudGl0eU1vZGVsIHsgICAgXG4gICAgc3RhdGljIGdldCBoYXNBdXRvSW5jcmVtZW50KCkge1xuICAgICAgICBsZXQgYXV0b0lkID0gdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZDtcbiAgICAgICAgcmV0dXJuIGF1dG9JZCAmJiB0aGlzLm1ldGEuZmllbGRzW2F1dG9JZC5maWVsZF0uYXV0b0luY3JlbWVudElkOyAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXJpYWxpemUgdmFsdWUgaW50byBkYXRhYmFzZSBhY2NlcHRhYmxlIGZvcm1hdC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YVJlY29yZCBcbiAgICAgKi9cbiAgICBzdGF0aWMgc2VyaWFsaXplKGRhdGFSZWNvcmQpIHtcbiAgICAgICAgXy5mb3JPd24oZGF0YVJlY29yZCwgKHZhbHVlLCBmaWVsZE5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBmaWVsZE1ldGEgPSB0aGlzLm1ldGEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmaWVsZE1ldGEudHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlLm9vbFR5cGUgPT09ICdTeW1ib2xUb2tlbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLm5hbWUgPT09ICdub3cnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPSB0aGlzLmRiLmNvbm5lY3Rvci5yYXcoJ05PVygpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlVGltZSkge1xuICAgICAgICAgICAgICAgICAgICBkYXRhUmVjb3JkW2ZpZWxkTmFtZV0gPSB2YWx1ZS50b0lTTyh7IGluY2x1ZGVPZmZzZXQ6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmllbGRNZXRhLnR5cGUgPT09ICdib29sZWFuJykge1xuICAgICAgICAgICAgICAgIGRhdGFSZWNvcmRbZmllbGROYW1lXSA9IGRhdGFSZWNvcmRbZmllbGROYW1lXSA/IDEgOiAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlXyguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIuY3JlYXRlXyguLi5hcmdzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBlcnJvckNvZGUgPSBlcnJvci5jb2RlO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAnRVJfTk9fUkVGRVJFTkNFRF9ST1dfMicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcignVGhlIG5ldyBlbnRpdHkgaXMgcmVmZXJlbmNpbmcgdG8gYW4gdW5leGlzdGluZyBlbnRpdHkuJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX0RVUF9FTlRSWScpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihlcnJvci5tZXNzYWdlICsgYCB3aGlsZSBjcmVhdGluZyBhIG5ldyBcIiR7dGhpcy5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIHVwZGF0ZV8oLi4uYXJncykge1xuICAgICAgICB0cnkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyLnVwZGF0ZV8oLi4uYXJncyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsZXQgZXJyb3JDb2RlID0gZXJyb3IuY29kZTtcblxuICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gJ0VSX05PX1JFRkVSRU5DRURfUk9XXzInKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoJ1RoZSBuZXcgZW50aXR5IGlzIHJlZmVyZW5jaW5nIHRvIGFuIHVuZXhpc3RpbmcgZW50aXR5LicpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFBvc3QgY3JlYXRlIHByb2Nlc3NpbmcuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29udGV4dC5jcmVhdGVPcHRpb25zXSAtIENyZWF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtjcmVhdGVPcHRpb25zLiRyZXRyaWV2ZUNyZWF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlckNyZWF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAodGhpcy5oYXNBdXRvSW5jcmVtZW50KSB7XG4gICAgICAgICAgICBsZXQgeyBpbnNlcnRJZCB9ID0gY29udGV4dC5yZXN1bHQ7XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdFt0aGlzLm1ldGEuZmVhdHVyZXMuYXV0b0lkLmZpZWxkXSA9IGluc2VydElkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRleHQuY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkKSB7XG4gICAgICAgICAgICBsZXQgY29uZGl0aW9uID0gdGhpcy5nZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbShjb250ZXh0LmxhdGVzdCk7XG4gICAgICAgICAgICBjb250ZXh0LmxhdGVzdCA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbmRpdGlvbiwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3N0IHVwZGF0ZSBwcm9jZXNzaW5nLlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW3VwZGF0ZU9wdGlvbnNdIC0gVXBkYXRlIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW3VwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZF0gLSBSZXRyaWV2ZSB0aGUgbmV3bHkgdXBkYXRlZCByZWNvcmQgZnJvbSBkYi4gXG4gICAgICovXG4gICAgc3RhdGljIGFzeW5jIGFmdGVyVXBkYXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHJldHJpZXZlVXBkYXRlZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5sYXRlc3QgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb250ZXh0LnVwZGF0ZU9wdGlvbnMuJHF1ZXJ5LCAkdW5ib3hpbmc6IHRydWV9LCBjb250ZXh0LmNvbm5PcHRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJlZm9yZSBkZWxldGluZyBhbiBlbnRpdHkuXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbY29udGV4dC5kZWxldGVPcHRpb25zXSAtIERlbGV0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtkZWxldGVPcHRpb25zLiRyZXRyaWV2ZURlbGV0ZWRdIC0gUmV0cmlldmUgdGhlIHJlY2VudGx5IGRlbGV0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBiZWZvcmVEZWxldGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIWNvbnRleHQuY29ubk9wdGlvbnMgfHwgIWNvbnRleHQuY29ubk9wdGlvbnMuY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnRleHQuY29ubk9wdGlvbnMgfHwgKGNvbnRleHQuY29ubk9wdGlvbnMgPSB7fSk7XG5cbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLmRiLmNvbm5lY3Rvci5iZWdpblRyYW5zYWN0aW9uXygpOyAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb250ZXh0LmV4aXN0aW5nID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC5kZWxldGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiAgICAgIGVudGl0eTogPHJlbW90ZSBlbnRpdHk+XG4gICAgICogICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTnxJTk5FUiBKT0lOfEZVTEwgT1VURVIgSk9JTidcbiAgICAgKiAgICAgIGFuY2hvcjogJ2xvY2FsIHByb3BlcnR5IHRvIHBsYWNlIHRoZSByZW1vdGUgZW50aXR5J1xuICAgICAqICAgICAgbG9jYWxGaWVsZDogPGxvY2FsIGZpZWxkIHRvIGpvaW4+XG4gICAgICogICAgICByZW1vdGVGaWVsZDogPHJlbW90ZSBmaWVsZCB0byBqb2luPlxuICAgICAqICAgICAgc3ViQXNzb2NpYXRpb25zOiB7IC4uLiB9ICAqL1xuICAgIHN0YXRpYyBfcHJlcGFyZUFzc29jaWF0aW9ucyhhc3NvY2lhdGlvbnMpIHsgICBcbiAgICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCgpLnNvcnQoKTtcbiAgICAgICAgbGV0IGNhY2hlID0ge30sIGhpZXJhcmNoeSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgYXNzb2NpYXRpb25zLmZvckVhY2goYXNzb2MgPT4ge1xuICAgICAgICAgICAgbGV0IFsgcmVtb3RlRW50aXR5LCBiYXNlLCBhbmNob3IsIGFzc29jSW5mbyBdID0gdGhpcy5fZ2V0UmVsYXRlZEVudGl0eShhc3NvYywgY2FjaGUpO1xuICAgICAgICAgICAgYXNzZXJ0OiBhc3NvY0luZm87ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGxldCByZW1vdGVFbnRpdHlOYW1lID0gcmVtb3RlRW50aXR5Lm1ldGEubmFtZTtcblxuICAgICAgICAgICAgbGV0IGRldGFpbCA9IHtcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eU5hbWUsXG4gICAgICAgICAgICAgICAga2V5RmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkLFxuICAgICAgICAgICAgICAgIGpvaW5UeXBlOiAnTEVGVCBKT0lOJyxcbiAgICAgICAgICAgICAgICBhbmNob3JcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGxldCB0b0NhY2hlID0ge1xuICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5LFxuICAgICAgICAgICAgICAgIGRldGFpbFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGFzc29jSW5mby5pc0xpc3QpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwuaXNMaXN0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFzc29jSW5mby5vcHRpb25hbCkge1xuICAgICAgICAgICAgICAgIGRldGFpbC5vcHRpb25hbCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChhc3NvY0luZm8uY29ubmVjdGVkQnkpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGNhY2hlW2Jhc2VdID8gY2FjaGVbYmFzZV0uZW50aXR5Lm1ldGEua2V5RmllbGQgOiB0aGlzLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkIHx8IHRoaXMubWV0YS5uYW1lO1xuXG4gICAgICAgICAgICAgICAgZGV0YWlsLmVudGl0eSA9IGFzc29jSW5mby5jb25uZWN0ZWRCeTtcbiAgICAgICAgICAgICAgICBkZXRhaWwua2V5RmllbGQgPSB0aGlzLmRiLm1vZGVsKGFzc29jSW5mby5jb25uZWN0ZWRCeSkubWV0YS5rZXlGaWVsZDtcblxuICAgICAgICAgICAgICAgIGlmIChhc3NvY0luZm8uY29ubmVjdGVkV2l0aCkge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwuY29ubmVjdGVkV2l0aCA9IGFzc29jSW5mby5jb25uZWN0ZWRXaXRoO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICB0b0NhY2hlLmRldGFpbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICBrZXlGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiAnTEVGVCBKT0lOJyxcbiAgICAgICAgICAgICAgICAgICAgYW5jaG9yOiBhc3NvY0luZm8ucmVmZXJzVG9GaWVsZCxcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxGaWVsZDogYXNzb2NJbmZvLnJlZmVyc1RvRmllbGQsXG4gICAgICAgICAgICAgICAgICAgIHJlbW90ZUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBkZXRhaWwuc3ViQXNzb2NpYXRpb25zID0gW1xuICAgICAgICAgICAgICAgICAgICB0b0NhY2hlLmRldGFpbFxuICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFzc29jSW5mby5pc0xpc3QpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGNhY2hlW2Jhc2VdID8gY2FjaGVbYmFzZV0uZW50aXR5Lm1ldGEua2V5RmllbGQgOiB0aGlzLm1ldGEua2V5RmllbGQ7XG4gICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkIHx8IHRoaXMubWV0YS5uYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGFuY2hvcjtcbiAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucy5wdXNoKGRldGFpbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucyA9IFsgZGV0YWlsIF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWNoZVthc3NvY10gPSB0b0NhY2hlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gaGllcmFyY2h5O1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0UmVsYXRlZEVudGl0eShhc3NvY1BhdGgsIGNhY2hlKSB7ICAgICAgICBcbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2NQYXRoLnNwbGl0KCcuJyk7ICAgICAgICBcbiAgICAgICAgbGV0IGJhc2UgPSBwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignLicpOyAgICAgICAgXG5cbiAgICAgICAgbGV0IGNhY2hlTm9kZSA9IGNhY2hlW2Jhc2VdO1xuICAgICAgICBpZiAoY2FjaGVOb2RlKSB7XG4gICAgICAgICAgICBsZXQgbGFzdCA9IHBhcnRzLnBvcCgpO1xuICAgICAgICAgICAgbGV0IGFzc29jSW5mbyA9IGNhY2hlTm9kZS5lbnRpdHkubWV0YS5hc3NvY2lhdGlvbnNbbGFzdF07XG4gICAgICAgICAgICBpZiAoIWFzc29jSW5mbykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIG9mIFwiJHt0aGlzLm1ldGEubmFtZX1cIiBlbnRpdHk6ICR7YXNzb2NQYXRofWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gWyB0aGlzLmRiLm1vZGVsKGFzc29jSW5mby5lbnRpdHkpLCBiYXNlLCBsYXN0LCBhc3NvY0luZm8gXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLCBjdXJyZW50LCBjdXJyZW50QXNzb2NJbmZvO1xuXG4gICAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjdXJyZW50ID0gcGFydHMuc2hpZnQoKTtcbiAgICAgICAgICAgIGN1cnJlbnRBc3NvY0luZm8gPSBlbnRpdHkubWV0YS5hc3NvY2lhdGlvbnNbY3VycmVudF07XG4gICAgICAgICAgICBpZiAoIWN1cnJlbnRBc3NvY0luZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBvZiBcIiR7dGhpcy5tZXRhLm5hbWV9XCIgZW50aXR5OiAke2Fzc29jUGF0aH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5ID0gdGhpcy5kYi5tb2RlbChjdXJyZW50QXNzb2NJbmZvLmVudGl0eSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gWyBlbnRpdHksIGJhc2UsIGN1cnJlbnQsIGN1cnJlbnRBc3NvY0luZm8gXTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX21hcFJlY29yZHNUb09iamVjdHMoW3Jvd3MsIGNvbHVtbnMsIGFsaWFzTWFwXSwgaGllcmFyY2h5KSB7XG4gICAgICAgIGxldCBtYWluSW5kZXggPSB7fTtcblxuICAgICAgICBmdW5jdGlvbiBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIF8uZWFjaChhc3NvY2lhdGlvbnMsICh7IGtleUZpZWxkLCBhbmNob3IsIGlzTGlzdCwgc3ViQXNzb2NpYXRpb25zIH0pID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGtleSA9ICc6JyArIGFuY2hvcjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHN1Yk9iaiA9IHJvd09iamVjdFtrZXldXG4gICAgICAgICAgICAgICAgbGV0IHN1YkluZGV4ZXMgPSBleGlzdGluZ1Jvdy5zdWJJbmRleGVzW2tleV07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJvd0tleSA9IHN1Yk9ialtrZXlGaWVsZF07XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwocm93S2V5KSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgbGV0IGV4aXN0aW5nU3ViUm93ID0gc3ViSW5kZXhlcyAmJiBzdWJJbmRleGVzW3Jvd0tleV07XG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nU3ViUm93KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlUmVjb3JkKGV4aXN0aW5nU3ViUm93LCBzdWJPYmosIHN1YkFzc29jaWF0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBpc0xpc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdy5yb3dPYmplY3Rba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W2tleV0ucHVzaChzdWJPYmopO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W2tleV0gPSBbIHN1Yk9iaiBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXggPSB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmogICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iaiwgc3ViQXNzb2NpYXRpb25zKVxuICAgICAgICAgICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXNbcm93S2V5XSA9IHN1YkluZGV4OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBidWlsZFN1YkluZGV4ZXMocm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBhc3NvY2lhdGlvbnMucmVkdWNlKChpbmRleGVzLCB7IGtleUZpZWxkLCBhbmNob3IsIGlzTGlzdCwgc3ViQXNzb2NpYXRpb25zIH0pID0+IHtcbiAgICAgICAgICAgICAgICBsZXQga2V5ID0gJzonK2FuY2hvcjtcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqZWN0ID0gcm93T2JqZWN0W2tleV07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdDogc3ViT2JqZWN0IFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNMaXN0KSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleUZpZWxkXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd09iamVjdFtrZXldID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJPYmplY3QgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W2tleV0gPSBbIHN1Yk9iamVjdCBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChfLmlzTmlsKHN1Yk9iamVjdFtrZXlGaWVsZF0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IHJvd09iamVjdFtrZXldID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoc3ViT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqZWN0LCBzdWJBc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlc1trZXldID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgW3N1Yk9iamVjdFtrZXlGaWVsZF1dOiBzdWJJbmRleFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBpbmRleGVzO1xuICAgICAgICAgICAgfSwge30pOyAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhcnJheU9mT2JqcyA9IFtdO1xuXG4gICAgICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICAgICAgbGV0IHJvd09iamVjdCA9IHt9OyAvLyBoYXNoLXN0eWxlIGRhdGEgcm93XG4gICAgICAgICAgICBsZXQgdGFibGVDYWNoZSA9IHt9OyAvLyBmcm9tIGFsaWFzIHRvIGNoaWxkIHByb3Agb2Ygcm93T2JqZWN0XG5cbiAgICAgICAgICAgIHJvdy5yZWR1Y2UoKHJlc3VsdCwgdmFsdWUsIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgY29sID0gY29sdW1uc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoY29sLnRhYmxlID09PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2NvbC5uYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgYnVja2V0ID0gdGFibGVDYWNoZVtjb2wudGFibGVdOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1Y2tldFtjb2wubmFtZV0gPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vZGVQYXRoID0gYWxpYXNNYXBbY29sLnRhYmxlXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdWJPYmplY3QgPSB7IFtjb2wubmFtZV06IHZhbHVlIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJsZUNhY2hlW2NvbC50YWJsZV0gPSBzdWJPYmplY3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRWYWx1ZUJ5UGF0aChyZXN1bHQsIG5vZGVQYXRoLCBzdWJPYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0sIHJvd09iamVjdCk7ICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IHJvd0tleSA9IHJvd09iamVjdFt0aGlzLm1ldGEua2V5RmllbGRdO1xuICAgICAgICAgICAgbGV0IGV4aXN0aW5nUm93ID0gbWFpbkluZGV4W3Jvd0tleV07XG4gICAgICAgICAgICBpZiAoZXhpc3RpbmdSb3cpIHtcbiAgICAgICAgICAgICAgICBtZXJnZVJlY29yZChleGlzdGluZ1Jvdywgcm93T2JqZWN0LCBoaWVyYXJjaHkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhcnJheU9mT2Jqcy5wdXNoKHJvd09iamVjdCk7XG4gICAgICAgICAgICAgICAgbWFpbkluZGV4W3Jvd0tleV0gPSB7IFxuICAgICAgICAgICAgICAgICAgICByb3dPYmplY3QsIFxuICAgICAgICAgICAgICAgICAgICBzdWJJbmRleGVzOiBidWlsZFN1YkluZGV4ZXMocm93T2JqZWN0LCBoaWVyYXJjaHkpXG4gICAgICAgICAgICAgICAgfTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhcnJheU9mT2JqcztcbiAgICB9XG5cbiAgICBzdGF0aWMgX2V4dHJhY3RBc3NvY2lhdGlvbnMoZGF0YSkge1xuICAgICAgICBsZXQgcmF3ID0ge30sIGFzc29jcyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgXy5mb3JPd24oZGF0YSwgKHYsIGspID0+IHtcbiAgICAgICAgICAgIGlmIChrLnN0YXJ0c1dpdGgoJzonKSkge1xuICAgICAgICAgICAgICAgIGFzc29jc1trLnN1YnN0cigxKV0gPSB2O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByYXdba10gPSB2O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBbIHJhdywgYXNzb2NzIF07ICAgICAgICBcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX2NyZWF0ZUFzc29jc18oY29udGV4dCwgYXNzb2NzKSB7XG4gICAgICAgIGxldCBtZXRhID0gdGhpcy5tZXRhLmFzc29jaWF0aW9ucztcbiAgICAgICAgbGV0IGtleVZhbHVlID0gY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmtleUZpZWxkXTtcblxuICAgICAgICBpZiAoXy5pc05pbChrZXlWYWx1ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBPb2xvbmdVc2FnZUVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIHByaW1hcnkga2V5IGZpZWxkIHZhbHVlLiBFbnRpdHk6ICcgKyB0aGlzLm1ldGEubmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhhc3NvY3MsIGFzeW5jIChkYXRhLCBhbmNob3IpID0+IHtcbiAgICAgICAgICAgIGxldCBhc3NvY01ldGEgPSBtZXRhW2FuY2hvcl07XG4gICAgICAgICAgICBpZiAoIWFzc29jTWV0YSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGBVbmtub3duIGFzc29jaWF0aW9uIFwiJHthbmNob3J9XCIgb2YgZW50aXR5IFwiJHt0aGlzLm1ldGEubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFhc3NvY01ldGEuY29ubmVjdGVkQnkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5zdXBwb3J0ZWQgYXNzb2NpYXRpb24gdHlwZSwgXCIke2FuY2hvcn1cIiBvZiBlbnRpdHkgXCIke3RoaXMubWV0YS5uYW1lfVwiLiBDdXJyZW50bHkgb25seSBzdXBwb3J0cyBtYW55LXRvLW1hbnkgYXNzb2NpYXRpb24uYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBhc3NvY01vZGVsID0gdGhpcy5kYi5tb2RlbChhc3NvY01ldGEuY29ubmVjdGVkQnkpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG5cbiAgICAgICAgICAgIHJldHVybiBhc3NvY01vZGVsLmNyZWF0ZV8oeyAuLi5kYXRhLCBbYXNzb2NNZXRhLnJlbW90ZUZpZWxkXToga2V5VmFsdWUgfSwgY29udGV4dC5jcmVhdGVPcHRpb25zLCBjb250ZXh0LmNvbm5PcHRpb25zKTsgIFxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTXlTUUxFbnRpdHlNb2RlbDsiXX0=