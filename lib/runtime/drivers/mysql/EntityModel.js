"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  setValueByPath,
  eachAsync_,
  fs
} = Util;

const {
  DateTime
} = require('luxon');

const EntityModel = require('../../EntityModel');

const {
  OolongUsageError,
  BusinessError
} = require('../../Errors');

class MySQLEntityModel extends EntityModel {
  static get hasAutoIncrement() {
    let autoId = this.meta.features.autoId;
    return autoId && this.meta.fields[autoId.field].autoIncrementId;
  }

  static _translateSymbolToken(name) {
    if (name === 'now') {
      return this.db.connector.raw('NOW()');
    }

    throw new Error('not support');
  }

  static _serialize(value) {
    if (typeof value === 'boolean') return value ? 1 : 0;

    if (value instanceof DateTime) {
      return value.toISO({
        includeOffset: false
      });
    }

    return value;
  }

  static async create_(...args) {
    try {
      return await super.create_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity. Detail: ' + error.message);
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message + ` while creating a new "${this.meta.name}".`);
      }

      throw error;
    }
  }

  static async update_(...args) {
    try {
      return await super.update_(...args);
    } catch (error) {
      let errorCode = error.code;

      if (errorCode === 'ER_NO_REFERENCED_ROW_2') {
        throw new BusinessError('The new entity is referencing to an unexisting entity.');
      } else if (errorCode === 'ER_DUP_ENTRY') {
        throw new BusinessError(error.message);
      }

      throw error;
    }
  }

  static async afterCreate_(context) {
    if (this.hasAutoIncrement) {
      let {
        insertId
      } = context.result;
      context.latest[this.meta.features.autoId.field] = insertId;
    }

    if (context.createOptions.$retrieveCreated) {
      let condition = this.getUniqueKeyValuePairsFrom(context.latest);
      context.latest = await this.findOne_({
        $query: condition,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async afterUpdate_(context) {
    if (context.updateOptions.$retrieveUpdated) {
      context.latest = await this.findOne_({
        $query: context.updateOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }

    return true;
  }

  static async beforeDelete_(context) {
    if (context.deleteOptions.$retrieveDeleted) {
      if (!context.connOptions || !context.connOptions.connection) {
        context.connOptions || (context.connOptions = {});
        context.connOptions.connection = await this.db.connector.beginTransaction_();
      }

      context.existing = await this.findOne_({
        $query: context.deleteOptions.$query,
        $unboxing: true
      }, context.connOptions);
    }
  }

  static _prepareAssociations(findOptions) {
    let associations = _.uniq(findOptions.$association).sort();

    let assocTable = {},
        counter = 0;
    associations.forEach(assoc => {
      if (_.isPlainObject(assoc)) {
        let alias = assoc.alias;

        if (!assoc.alias) {
          alias = ':join' + ++counter;
        }

        assocTable[alias] = {
          entity: assoc.entity,
          joinType: assoc.type,
          output: assoc.output,
          alias,
          on: assoc.on,
          ...(assoc.dataset ? this.db.connector.buildQuery(assoc.entity, this._prepareQueries({ ...assoc.dataset,
            $variables: findOptions.$variables
          })) : {})
        };
      } else {
        this._loadAssoc(assocTable, assoc);
      }
    });
    return assocTable;
  }

  static _loadAssoc(cache, assoc) {
    if (cache[assoc]) return cache[assoc];
    let parts = assoc.split('.');
    let result;

    if (parts.length === 1) {
      result = cache[assoc] = { ...this.meta.associations[assoc]
      };
    } else {
      let base = parts.slice(0, -1).join('.');
      let last = parts.pop();
      let baseNode = cache[base];

      if (!cache[base]) {
        baseNode = this._loadAssoc(cache, base);
      }

      let entity = this.db.model(baseNode.entity);
      result = { ...entity.meta.associations[last]
      };

      if (!baseNode.subAssocs) {
        baseNode.subAssocs = {};
      }

      baseNode.subAssocs[last] = result;
    }

    if (result.assoc) {
      this._loadAssoc(cache, assoc + '.' + result.assoc);
    }

    return result;
  }

  static _mapRecordsToObjects([rows, columns, aliasMap], hierarchy) {
    let mainIndex = {};

    function mergeRecord(existingRow, rowObject, associations) {
      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) return;
        let objKey = ':' + anchor;
        let subObj = rowObject[objKey];
        let subIndexes = existingRow.subIndexes[objKey];
        let rowKey = subObj[key];
        if (_.isNil(rowKey)) return;
        let existingSubRow = subIndexes && subIndexes[rowKey];

        if (existingSubRow) {
          if (subAssocs) {
            mergeRecord(existingSubRow, subObj, subAssocs);
          }
        } else {
          if (!list) {
            throw new Error("Assertion failed: list");
          }

          if (existingRow.rowObject[objKey]) {
            existingRow.rowObject[objKey].push(subObj);
          } else {
            existingRow.rowObject[objKey] = [subObj];
          }

          let subIndex = {
            rowObject: subObj
          };

          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObj, subAssocs);
          }

          subIndexes[rowKey] = subIndex;
        }
      });
    }

    function buildSubIndexes(rowObject, associations) {
      let indexes = {};

      _.each(associations, ({
        sql,
        key,
        list,
        subAssocs
      }, anchor) => {
        if (sql) {
          return;
        }

        let objKey = ':' + anchor;
        let subObject = rowObject[objKey];
        let subIndex = {
          rowObject: subObject
        };

        if (list) {
          if (_.isNil(subObject[key])) {
            rowObject[objKey] = [];
            subObject = null;
          } else {
            rowObject[objKey] = [subObject];
          }
        } else if (_.isNil(subObject[key])) {
          subObject = rowObject[objKey] = null;
        }

        if (subObject) {
          if (subAssocs) {
            subIndex.subIndexes = buildSubIndexes(subObject, subAssocs);
          }

          indexes[objKey] = {
            [subObject[key]]: subIndex
          };
        }
      });

      return indexes;
    }

    let arrayOfObjs = [];
    rows.forEach((row, i) => {
      let rowObject = {};
      let tableCache = {};
      row.reduce((result, value, i) => {
        let col = columns[i];

        if (col.table === 'A') {
          result[col.name] = value;
        } else {
          let bucket = tableCache[col.table];

          if (bucket) {
            bucket[col.name] = value;
          } else {
            let nodePath = aliasMap[col.table];

            if (nodePath) {
              let subObject = {
                [col.name]: value
              };
              tableCache[col.table] = subObject;
              setValueByPath(result, nodePath, subObject);
            }
          }
        }

        return result;
      }, rowObject);
      let rowKey = rowObject[this.meta.keyField];
      let existingRow = mainIndex[rowKey];

      if (existingRow) {
        mergeRecord(existingRow, rowObject, hierarchy);
      } else {
        arrayOfObjs.push(rowObject);
        mainIndex[rowKey] = {
          rowObject,
          subIndexes: buildSubIndexes(rowObject, hierarchy)
        };
      }
    });
    return arrayOfObjs;
  }

  static _extractAssociations(data) {
    let raw = {},
        assocs = {};

    _.forOwn(data, (v, k) => {
      if (k.startsWith(':')) {
        assocs[k.substr(1)] = v;
      } else {
        raw[k] = v;
      }
    });

    return [raw, assocs];
  }

  static async _createAssocs_(context, assocs) {
    let meta = this.meta.associations;
    let keyValue = context.latest[this.meta.keyField];

    if (_.isNil(keyValue)) {
      throw new OolongUsageError('Missing required primary key field value. Entity: ' + this.meta.name);
    }

    return eachAsync_(assocs, async (data, anchor) => {
      let assocMeta = meta[anchor];

      if (!assocMeta) {
        throw new BusinessError(`Unknown association "${anchor}" of entity "${this.meta.name}".`);
      }

      let assocModel = this.db.model(assocMeta.entity);

      if (assocMeta.list) {
        data = _.castArray(data);
        return eachAsync_(data, item => assocModel.create_({ ...item,
          ...(assocMeta.field ? {
            [assocMeta.field]: keyValue
          } : {})
        }, context.createOptions, context.connOptions));
      }

      return assocModel.create_({ ...data,
        ...(assocMeta.field ? {
          [assocMeta.field]: keyValue
        } : {})
      }, context.createOptions, context.connOptions);
    });
  }

}

module.exports = MySQLEntityModel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbXlzcWwvRW50aXR5TW9kZWwuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwic2V0VmFsdWVCeVBhdGgiLCJlYWNoQXN5bmNfIiwiZnMiLCJEYXRlVGltZSIsIkVudGl0eU1vZGVsIiwiT29sb25nVXNhZ2VFcnJvciIsIkJ1c2luZXNzRXJyb3IiLCJNeVNRTEVudGl0eU1vZGVsIiwiaGFzQXV0b0luY3JlbWVudCIsImF1dG9JZCIsIm1ldGEiLCJmZWF0dXJlcyIsImZpZWxkcyIsImZpZWxkIiwiYXV0b0luY3JlbWVudElkIiwiX3RyYW5zbGF0ZVN5bWJvbFRva2VuIiwibmFtZSIsImRiIiwiY29ubmVjdG9yIiwicmF3IiwiRXJyb3IiLCJfc2VyaWFsaXplIiwidmFsdWUiLCJ0b0lTTyIsImluY2x1ZGVPZmZzZXQiLCJjcmVhdGVfIiwiYXJncyIsImVycm9yIiwiZXJyb3JDb2RlIiwiY29kZSIsIm1lc3NhZ2UiLCJ1cGRhdGVfIiwiYWZ0ZXJDcmVhdGVfIiwiY29udGV4dCIsImluc2VydElkIiwicmVzdWx0IiwibGF0ZXN0IiwiY3JlYXRlT3B0aW9ucyIsIiRyZXRyaWV2ZUNyZWF0ZWQiLCJjb25kaXRpb24iLCJnZXRVbmlxdWVLZXlWYWx1ZVBhaXJzRnJvbSIsImZpbmRPbmVfIiwiJHF1ZXJ5IiwiJHVuYm94aW5nIiwiY29ubk9wdGlvbnMiLCJhZnRlclVwZGF0ZV8iLCJ1cGRhdGVPcHRpb25zIiwiJHJldHJpZXZlVXBkYXRlZCIsImJlZm9yZURlbGV0ZV8iLCJkZWxldGVPcHRpb25zIiwiJHJldHJpZXZlRGVsZXRlZCIsImNvbm5lY3Rpb24iLCJiZWdpblRyYW5zYWN0aW9uXyIsImV4aXN0aW5nIiwiX3ByZXBhcmVBc3NvY2lhdGlvbnMiLCJmaW5kT3B0aW9ucyIsImFzc29jaWF0aW9ucyIsInVuaXEiLCIkYXNzb2NpYXRpb24iLCJzb3J0IiwiYXNzb2NUYWJsZSIsImNvdW50ZXIiLCJmb3JFYWNoIiwiYXNzb2MiLCJpc1BsYWluT2JqZWN0IiwiYWxpYXMiLCJlbnRpdHkiLCJqb2luVHlwZSIsInR5cGUiLCJvdXRwdXQiLCJvbiIsImRhdGFzZXQiLCJidWlsZFF1ZXJ5IiwiX3ByZXBhcmVRdWVyaWVzIiwiJHZhcmlhYmxlcyIsIl9sb2FkQXNzb2MiLCJjYWNoZSIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJiYXNlIiwic2xpY2UiLCJqb2luIiwibGFzdCIsInBvcCIsImJhc2VOb2RlIiwibW9kZWwiLCJzdWJBc3NvY3MiLCJfbWFwUmVjb3Jkc1RvT2JqZWN0cyIsInJvd3MiLCJjb2x1bW5zIiwiYWxpYXNNYXAiLCJoaWVyYXJjaHkiLCJtYWluSW5kZXgiLCJtZXJnZVJlY29yZCIsImV4aXN0aW5nUm93Iiwicm93T2JqZWN0IiwiZWFjaCIsInNxbCIsImtleSIsImxpc3QiLCJhbmNob3IiLCJvYmpLZXkiLCJzdWJPYmoiLCJzdWJJbmRleGVzIiwicm93S2V5IiwiaXNOaWwiLCJleGlzdGluZ1N1YlJvdyIsInB1c2giLCJzdWJJbmRleCIsImJ1aWxkU3ViSW5kZXhlcyIsImluZGV4ZXMiLCJzdWJPYmplY3QiLCJhcnJheU9mT2JqcyIsInJvdyIsImkiLCJ0YWJsZUNhY2hlIiwicmVkdWNlIiwiY29sIiwidGFibGUiLCJidWNrZXQiLCJub2RlUGF0aCIsImtleUZpZWxkIiwiX2V4dHJhY3RBc3NvY2lhdGlvbnMiLCJkYXRhIiwiYXNzb2NzIiwiZm9yT3duIiwidiIsImsiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiX2NyZWF0ZUFzc29jc18iLCJrZXlWYWx1ZSIsImFzc29jTWV0YSIsImFzc29jTW9kZWwiLCJjYXN0QXJyYXkiLCJpdGVtIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxjQUFMO0FBQXFCQyxF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WCxDQUFtQixFQUFFLEdBQUdtRyxJQUFMO0FBQVcsWUFBSVMsU0FBUyxDQUFDeEgsS0FBVixHQUFrQjtBQUFFLFdBQUN3SCxTQUFTLENBQUN4SCxLQUFYLEdBQW1CdUg7QUFBckIsU0FBbEIsR0FBb0QsRUFBeEQ7QUFBWCxPQUFuQixFQUE2Rm5HLE9BQU8sQ0FBQ0ksYUFBckcsRUFBb0hKLE9BQU8sQ0FBQ1csV0FBNUgsQ0FBUDtBQUNILEtBZmdCLENBQWpCO0FBZ0JIOztBQWhlc0M7O0FBbWUzQzZGLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5JLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgc2V0VmFsdWVCeVBhdGgsIGVhY2hBc3luY18sIGZzIH0gPSBVdGlsO1xuXG5jb25zdCB7IERhdGVUaW1lIH0gPSByZXF1aXJlKCdsdXhvbicpO1xuY29uc3QgRW50aXR5TW9kZWwgPSByZXF1aXJlKCcuLi8uLi9FbnRpdHlNb2RlbCcpO1xuY29uc3QgeyBPb2xvbmdVc2FnZUVycm9yLCBCdXNpbmVzc0Vycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9FcnJvcnMnKTtcblxuLyoqXG4gKiBNeVNRTCBlbnRpdHkgbW9kZWwgY2xhc3MuXG4gKi9cbmNsYXNzIE15U1FMRW50aXR5TW9kZWwgZXh0ZW5kcyBFbnRpdHlNb2RlbCB7ICAgIFxuICAgIHN0YXRpYyBnZXQgaGFzQXV0b0luY3JlbWVudCgpIHtcbiAgICAgICAgbGV0IGF1dG9JZCA9IHRoaXMubWV0YS5mZWF0dXJlcy5hdXRvSWQ7XG4gICAgICAgIHJldHVybiBhdXRvSWQgJiYgdGhpcy5tZXRhLmZpZWxkc1thdXRvSWQuZmllbGRdLmF1dG9JbmNyZW1lbnRJZDsgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2VyaWFsaXplIHZhbHVlIGludG8gZGF0YWJhc2UgYWNjZXB0YWJsZSBmb3JtYXQuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG5hbWUgLSBOYW1lIG9mIHRoZSBzeW1ib2wgdG9rZW4gXG4gICAgICovXG4gICAgc3RhdGljIF90cmFuc2xhdGVTeW1ib2xUb2tlbihuYW1lKSB7XG4gICAgICAgIGlmIChuYW1lID09PSAnbm93Jykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGIuY29ubmVjdG9yLnJhdygnTk9XKCknKTtcbiAgICAgICAgfSBcbiAgICAgICAgXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignbm90IHN1cHBvcnQnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3NlcmlhbGl6ZSh2YWx1ZSkge1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHJldHVybiB2YWx1ZSA/IDEgOiAwO1xuXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGVUaW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUudG9JU08oeyBpbmNsdWRlT2Zmc2V0OiBmYWxzZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlXyguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgc3VwZXIuY3JlYXRlXyguLi5hcmdzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxldCBlcnJvckNvZGUgPSBlcnJvci5jb2RlO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAnRVJfTk9fUkVGRVJFTkNFRF9ST1dfMicpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcignVGhlIG5ldyBlbnRpdHkgaXMgcmVmZXJlbmNpbmcgdG8gYW4gdW5leGlzdGluZyBlbnRpdHkuIERldGFpbDogJyArIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICdFUl9EVVBfRU5UUlknKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoZXJyb3IubWVzc2FnZSArIGAgd2hpbGUgY3JlYXRpbmcgYSBuZXcgXCIke3RoaXMubWV0YS5uYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyB1cGRhdGVfKC4uLmFyZ3MpIHtcbiAgICAgICAgdHJ5IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzdXBlci51cGRhdGVfKC4uLmFyZ3MpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgbGV0IGVycm9yQ29kZSA9IGVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChlcnJvckNvZGUgPT09ICdFUl9OT19SRUZFUkVOQ0VEX1JPV18yJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKCdUaGUgbmV3IGVudGl0eSBpcyByZWZlcmVuY2luZyB0byBhbiB1bmV4aXN0aW5nIGVudGl0eS4nKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAnRVJfRFVQX0VOVFJZJykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBCdXNpbmVzc0Vycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBQb3N0IGNyZWF0ZSBwcm9jZXNzaW5nLlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuY3JlYXRlT3B0aW9uc10gLSBDcmVhdGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbY3JlYXRlT3B0aW9ucy4kcmV0cmlldmVDcmVhdGVkXSAtIFJldHJpZXZlIHRoZSBuZXdseSBjcmVhdGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYWZ0ZXJDcmVhdGVfKGNvbnRleHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzQXV0b0luY3JlbWVudCkge1xuICAgICAgICAgICAgbGV0IHsgaW5zZXJ0SWQgfSA9IGNvbnRleHQucmVzdWx0O1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3RbdGhpcy5tZXRhLmZlYXR1cmVzLmF1dG9JZC5maWVsZF0gPSBpbnNlcnRJZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZXh0LmNyZWF0ZU9wdGlvbnMuJHJldHJpZXZlQ3JlYXRlZCkge1xuICAgICAgICAgICAgbGV0IGNvbmRpdGlvbiA9IHRoaXMuZ2V0VW5pcXVlS2V5VmFsdWVQYWlyc0Zyb20oY29udGV4dC5sYXRlc3QpO1xuICAgICAgICAgICAgY29udGV4dC5sYXRlc3QgPSBhd2FpdCB0aGlzLmZpbmRPbmVfKHsgJHF1ZXJ5OiBjb25kaXRpb24sICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdCB1cGRhdGUgcHJvY2Vzc2luZy5cbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFt1cGRhdGVPcHRpb25zXSAtIFVwZGF0ZSBvcHRpb25zICAgICBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFt1cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWRdIC0gUmV0cmlldmUgdGhlIG5ld2x5IHVwZGF0ZWQgcmVjb3JkIGZyb20gZGIuIFxuICAgICAqL1xuICAgIHN0YXRpYyBhc3luYyBhZnRlclVwZGF0ZV8oY29udGV4dCkge1xuICAgICAgICBpZiAoY29udGV4dC51cGRhdGVPcHRpb25zLiRyZXRyaWV2ZVVwZGF0ZWQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0ID0gYXdhaXQgdGhpcy5maW5kT25lXyh7ICRxdWVyeTogY29udGV4dC51cGRhdGVPcHRpb25zLiRxdWVyeSwgJHVuYm94aW5nOiB0cnVlfSwgY29udGV4dC5jb25uT3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCZWZvcmUgZGVsZXRpbmcgYW4gZW50aXR5LlxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCBcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW2NvbnRleHQuZGVsZXRlT3B0aW9uc10gLSBEZWxldGUgb3B0aW9ucyAgICAgXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbZGVsZXRlT3B0aW9ucy4kcmV0cmlldmVEZWxldGVkXSAtIFJldHJpZXZlIHRoZSByZWNlbnRseSBkZWxldGVkIHJlY29yZCBmcm9tIGRiLiBcbiAgICAgKi9cbiAgICBzdGF0aWMgYXN5bmMgYmVmb3JlRGVsZXRlXyhjb250ZXh0KSB7XG4gICAgICAgIGlmIChjb250ZXh0LmRlbGV0ZU9wdGlvbnMuJHJldHJpZXZlRGVsZXRlZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFjb250ZXh0LmNvbm5PcHRpb25zIHx8ICFjb250ZXh0LmNvbm5PcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0LmNvbm5PcHRpb25zIHx8IChjb250ZXh0LmNvbm5PcHRpb25zID0ge30pO1xuXG4gICAgICAgICAgICAgICAgY29udGV4dC5jb25uT3B0aW9ucy5jb25uZWN0aW9uID0gYXdhaXQgdGhpcy5kYi5jb25uZWN0b3IuYmVnaW5UcmFuc2FjdGlvbl8oKTsgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29udGV4dC5leGlzdGluZyA9IGF3YWl0IHRoaXMuZmluZE9uZV8oeyAkcXVlcnk6IGNvbnRleHQuZGVsZXRlT3B0aW9ucy4kcXVlcnksICR1bmJveGluZzogdHJ1ZX0sIGNvbnRleHQuY29ubk9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyogICAgICBlbnRpdHk6IDxyZW1vdGUgZW50aXR5PlxuICAgICAqICAgICAgam9pblR5cGU6ICdMRUZUIEpPSU58SU5ORVIgSk9JTnxGVUxMIE9VVEVSIEpPSU4nXG4gICAgICogICAgICBhbmNob3I6ICdsb2NhbCBwcm9wZXJ0eSB0byBwbGFjZSB0aGUgcmVtb3RlIGVudGl0eSdcbiAgICAgKiAgICAgIGxvY2FsRmllbGQ6IDxsb2NhbCBmaWVsZCB0byBqb2luPlxuICAgICAqICAgICAgcmVtb3RlRmllbGQ6IDxyZW1vdGUgZmllbGQgdG8gam9pbj5cbiAgICAgKiAgICAgIHN1YkFzc29jaWF0aW9uczogeyAuLi4gfSAgKi9cbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoZmluZE9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBfLnVuaXEoZmluZE9wdGlvbnMuJGFzc29jaWF0aW9uKS5zb3J0KCk7ICAgICAgICBcbiAgICAgICAgbGV0IGFzc29jVGFibGUgPSB7fSwgY291bnRlciA9IDA7ICAgICAgIFxuXG4gICAgICAgIGFzc29jaWF0aW9ucy5mb3JFYWNoKGFzc29jID0+IHtcbiAgICAgICAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYXNzb2MpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGFsaWFzID0gYXNzb2MuYWxpYXM7XG4gICAgICAgICAgICAgICAgaWYgKCFhc3NvYy5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICBhbGlhcyA9ICc6am9pbicgKyArK2NvdW50ZXI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYXNzb2NUYWJsZVthbGlhc10gPSB7IFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHk6IGFzc29jLmVudGl0eSwgXG4gICAgICAgICAgICAgICAgICAgIGpvaW5UeXBlOiBhc3NvYy50eXBlLCBcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiBhc3NvYy5vdXRwdXQsXG4gICAgICAgICAgICAgICAgICAgIGFsaWFzLFxuICAgICAgICAgICAgICAgICAgICBvbjogYXNzb2Mub24sXG4gICAgICAgICAgICAgICAgICAgIC4uLihhc3NvYy5kYXRhc2V0ID8gdGhpcy5kYi5jb25uZWN0b3IuYnVpbGRRdWVyeShhc3NvYy5lbnRpdHksIFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJlcGFyZVF1ZXJpZXMoeyAuLi5hc3NvYy5kYXRhc2V0LCAkdmFyaWFibGVzOiBmaW5kT3B0aW9ucy4kdmFyaWFibGVzIH0pKSA6IHt9KSAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9hZEFzc29jKGFzc29jVGFibGUsIGFzc29jKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFzc29jVGFibGU7XG4gICAgfVxuXG4gICAgc3RhdGljIF9sb2FkQXNzb2MoY2FjaGUsIGFzc29jKSB7XG4gICAgICAgIGlmIChjYWNoZVthc3NvY10pIHJldHVybiBjYWNoZVthc3NvY107XG5cbiAgICAgICAgbGV0IHBhcnRzID0gYXNzb2Muc3BsaXQoJy4nKTtcbiAgICAgICAgbGV0IHJlc3VsdDsgICBcblxuICAgICAgICBpZiAocGFydHMubGVuZ3RoID09PSAxKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgIHJlc3VsdCA9IGNhY2hlW2Fzc29jXSA9IHsgLi4udGhpcy5tZXRhLmFzc29jaWF0aW9uc1thc3NvY10gfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBiYXNlID0gcGFydHMuc2xpY2UoMCwgLTEpLmpvaW4oJy4nKTsgIFxuICAgICAgICAgICAgbGV0IGxhc3QgPSBwYXJ0cy5wb3AoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBiYXNlTm9kZSA9IGNhY2hlW2Jhc2VdO1xuICAgICAgICAgICAgaWYgKCFjYWNoZVtiYXNlXSkge1xuICAgICAgICAgICAgICAgIGJhc2VOb2RlID0gdGhpcy5fbG9hZEFzc29jKGNhY2hlLCBiYXNlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMuZGIubW9kZWwoYmFzZU5vZGUuZW50aXR5KTtcbiAgICAgICAgICAgIHJlc3VsdCA9IHsgLi4uZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2xhc3RdIH07XG5cbiAgICAgICAgICAgIGlmICghYmFzZU5vZGUuc3ViQXNzb2NzKSB7XG4gICAgICAgICAgICAgICAgYmFzZU5vZGUuc3ViQXNzb2NzID0ge307XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBiYXNlTm9kZS5zdWJBc3NvY3NbbGFzdF0gPSByZXN1bHQ7XG4gICAgICAgIH0gICAgICBcblxuICAgICAgICBpZiAocmVzdWx0LmFzc29jKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2FkQXNzb2MoY2FjaGUsIGFzc29jICsgJy4nICsgcmVzdWx0LmFzc29jKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLypcbiAgICBzdGF0aWMgX3ByZXBhcmVBc3NvY2lhdGlvbnMoZmluZE9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBhc3NvY2lhdGlvbnMgPSBmaW5kT3B0aW9ucy4kYXNzb2NpYXRpb24uY29uY2F0KCkuc29ydCgpOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBsZXQgY2FjaGUgPSB7fSwgaGllcmFyY2h5ID0gW107XG4gICAgICAgIFxuICAgICAgICBhc3NvY2lhdGlvbnMuZm9yRWFjaChhc3NvYyA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGFzc29jKSkge1xuICAgICAgICAgICAgICAgIGhpZXJhcmNoeS5wdXNoKHsgXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eTogYXNzb2MuZW50aXR5LCBcbiAgICAgICAgICAgICAgICAgICAgam9pblR5cGU6IGFzc29jLnR5cGUsIFxuICAgICAgICAgICAgICAgICAgICBvdXRwdXQ6IGFzc29jLm91dHB1dCxcbiAgICAgICAgICAgICAgICAgICAgLi4uKGFzc29jLmFsaWFzID8geyBhbGlhczogYXNzb2MuYWxpYXMgfSA6IHt9KSxcbiAgICAgICAgICAgICAgICAgICAgLi4uYXNzb2Mub24sXG4gICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuZGIuY29ubmVjdG9yLmJ1aWxkUXVlcnkoYXNzb2MuZW50aXR5LCBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVRdWVyaWVzKHsgLi4uYXNzb2MuZGF0YXNldCwgJHZhcmlhYmxlczogZmluZE9wdGlvbnMuJHZhcmlhYmxlcyB9KSkgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBbIHJlbW90ZUVudGl0eSwgYmFzZSwgYW5jaG9yLCBhc3NvY0luZm8gXSA9IHRoaXMuX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2MsIGNhY2hlKTtcbiAgICAgICAgICAgIGFzc2VydDogYXNzb2NJbmZvOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBsZXQgcmVtb3RlRW50aXR5TmFtZSA9IHJlbW90ZUVudGl0eS5tZXRhLm5hbWU7XG5cbiAgICAgICAgICAgIGxldCBkZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgZW50aXR5OiByZW1vdGVFbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgIGtleUZpZWxkOiByZW1vdGVFbnRpdHkubWV0YS5rZXlGaWVsZCxcbiAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgYW5jaG9yXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgdG9DYWNoZSA9IHtcbiAgICAgICAgICAgICAgICBlbnRpdHk6IHJlbW90ZUVudGl0eSxcbiAgICAgICAgICAgICAgICBkZXRhaWxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChhc3NvY0luZm8uaXNMaXN0KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmlzTGlzdCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhc3NvY0luZm8ub3B0aW9uYWwpIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwub3B0aW9uYWwgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZEJ5KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBjYWNoZVtiYXNlXSA/IGNhY2hlW2Jhc2VdLmVudGl0eS5tZXRhLmtleUZpZWxkIDogdGhpcy5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IGFzc29jSW5mby5yZW1vdGVGaWVsZCB8fCB0aGlzLm1ldGEubmFtZTtcblxuICAgICAgICAgICAgICAgIGRldGFpbC5lbnRpdHkgPSBhc3NvY0luZm8uY29ubmVjdGVkQnk7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmtleUZpZWxkID0gdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uY29ubmVjdGVkQnkpLm1ldGEua2V5RmllbGQ7XG5cbiAgICAgICAgICAgICAgICBpZiAoYXNzb2NJbmZvLmNvbm5lY3RlZFdpdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLmNvbm5lY3RlZFdpdGggPSBhc3NvY0luZm8uY29ubmVjdGVkV2l0aDtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgdG9DYWNoZS5kZXRhaWwgPSB7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eTogcmVtb3RlRW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAga2V5RmllbGQ6IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkLFxuICAgICAgICAgICAgICAgICAgICBqb2luVHlwZTogJ0xFRlQgSk9JTicsXG4gICAgICAgICAgICAgICAgICAgIGFuY2hvcjogYXNzb2NJbmZvLnJlZmVyc1RvRmllbGQsXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsRmllbGQ6IGFzc29jSW5mby5yZWZlcnNUb0ZpZWxkLFxuICAgICAgICAgICAgICAgICAgICByZW1vdGVGaWVsZDogcmVtb3RlRW50aXR5Lm1ldGEua2V5RmllbGRcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgZGV0YWlsLnN1YkFzc29jaWF0aW9ucyA9IFtcbiAgICAgICAgICAgICAgICAgICAgdG9DYWNoZS5kZXRhaWxcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhc3NvY0luZm8uaXNMaXN0KSB7XG4gICAgICAgICAgICAgICAgZGV0YWlsLmxvY2FsRmllbGQgPSBjYWNoZVtiYXNlXSA/IGNhY2hlW2Jhc2VdLmVudGl0eS5tZXRhLmtleUZpZWxkIDogdGhpcy5tZXRhLmtleUZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzc29jSW5mby5yZW1vdGVGaWVsZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLnJlbW90ZUZpZWxkcyA9IGFzc29jSW5mby5yZW1vdGVGaWVsZHM7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5qb2luVHlwZSA9ICdSSUdIVCBKT0lOJztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGQgPSBhc3NvY0luZm8ucmVtb3RlRmllbGQgfHwgdGhpcy5tZXRhLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkZXRhaWwubG9jYWxGaWVsZCA9IGFuY2hvcjtcbiAgICAgICAgICAgICAgICBpZiAoYXNzb2NJbmZvLnJlbW90ZUZpZWxkcykge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWwucmVtb3RlRmllbGRzID0gYXNzb2NJbmZvLnJlbW90ZUZpZWxkcztcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsLmpvaW5UeXBlID0gJ1JJR0hUIEpPSU4nO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFpbC5yZW1vdGVGaWVsZCA9IHJlbW90ZUVudGl0eS5tZXRhLmtleUZpZWxkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNhY2hlW2Jhc2VdLmRldGFpbC5zdWJBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucy5wdXNoKGRldGFpbCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVbYmFzZV0uZGV0YWlsLnN1YkFzc29jaWF0aW9ucyA9IFsgZGV0YWlsIF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHkucHVzaChkZXRhaWwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjYWNoZVthc3NvY10gPSB0b0NhY2hlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gaGllcmFyY2h5O1xuICAgIH0qL1xuXG4gICAgLypcbiAgICBzdGF0aWMgX2dldFJlbGF0ZWRFbnRpdHkoYXNzb2NQYXRoLCBjYWNoZSkgeyAgICAgICAgXG4gICAgICAgIGxldCBwYXJ0cyA9IGFzc29jUGF0aC5zcGxpdCgnLicpOyAgICAgICAgXG4gICAgICAgIGxldCBiYXNlID0gcGFydHMuc2xpY2UoMCwgLTEpLmpvaW4oJy4nKTsgICAgICAgIFxuXG4gICAgICAgIGxldCBjYWNoZU5vZGUgPSBjYWNoZVtiYXNlXTtcbiAgICAgICAgaWYgKGNhY2hlTm9kZSkge1xuICAgICAgICAgICAgbGV0IGxhc3QgPSBwYXJ0cy5wb3AoKTtcbiAgICAgICAgICAgIGxldCBhc3NvY0luZm8gPSBjYWNoZU5vZGUuZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2xhc3RdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY0luZm8pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBvZiBcIiR7dGhpcy5tZXRhLm5hbWV9XCIgZW50aXR5OiAke2Fzc29jUGF0aH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFsgdGhpcy5kYi5tb2RlbChhc3NvY0luZm8uZW50aXR5KSwgYmFzZSwgbGFzdCwgYXNzb2NJbmZvIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcywgY3VycmVudCwgY3VycmVudEFzc29jSW5mbztcblxuICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY3VycmVudCA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICBjdXJyZW50QXNzb2NJbmZvID0gZW50aXR5Lm1ldGEuYXNzb2NpYXRpb25zW2N1cnJlbnRdO1xuICAgICAgICAgICAgaWYgKCFjdXJyZW50QXNzb2NJbmZvKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1c2luZXNzRXJyb3IoYFVua25vd24gYXNzb2NpYXRpb24gb2YgXCIke3RoaXMubWV0YS5uYW1lfVwiIGVudGl0eTogJHthc3NvY1BhdGh9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVudGl0eSA9IHRoaXMuZGIubW9kZWwoY3VycmVudEFzc29jSW5mby5lbnRpdHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFsgZW50aXR5LCBiYXNlLCBjdXJyZW50LCBjdXJyZW50QXNzb2NJbmZvIF07XG4gICAgfSovXG5cbiAgICBzdGF0aWMgX21hcFJlY29yZHNUb09iamVjdHMoW3Jvd3MsIGNvbHVtbnMsIGFsaWFzTWFwXSwgaGllcmFyY2h5KSB7XG4gICAgICAgIGxldCBtYWluSW5kZXggPSB7fTsgICAgICAgIFxuXG4gICAgICAgIGZ1bmN0aW9uIG1lcmdlUmVjb3JkKGV4aXN0aW5nUm93LCByb3dPYmplY3QsIGFzc29jaWF0aW9ucykgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgXy5lYWNoKGFzc29jaWF0aW9ucywgKHsgc3FsLCBrZXksIGxpc3QsIHN1YkFzc29jcyB9LCBhbmNob3IpID0+IHsgXG4gICAgICAgICAgICAgICAgaWYgKHNxbCkgcmV0dXJuOyAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIGxldCBvYmpLZXkgPSAnOicgKyBhbmNob3I7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJPYmogPSByb3dPYmplY3Rbb2JqS2V5XVxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleGVzID0gZXhpc3RpbmdSb3cuc3ViSW5kZXhlc1tvYmpLZXldO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCByb3dLZXkgPSBzdWJPYmpba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc05pbChyb3dLZXkpKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBsZXQgZXhpc3RpbmdTdWJSb3cgPSBzdWJJbmRleGVzICYmIHN1YkluZGV4ZXNbcm93S2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdTdWJSb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN1YkFzc29jcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdTdWJSb3csIHN1Yk9iaiwgc3ViQXNzb2NzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6IGxpc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1Jvdy5yb3dPYmplY3Rbb2JqS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W29iaktleV0ucHVzaChzdWJPYmopO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdSb3cucm93T2JqZWN0W29iaktleV0gPSBbIHN1Yk9iaiBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgc3ViSW5kZXggPSB7IFxuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0OiBzdWJPYmogICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViQXNzb2NzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJJbmRleC5zdWJJbmRleGVzID0gYnVpbGRTdWJJbmRleGVzKHN1Yk9iaiwgc3ViQXNzb2NzKVxuICAgICAgICAgICAgICAgICAgICB9ICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIHN1YkluZGV4ZXNbcm93S2V5XSA9IHN1YkluZGV4OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBidWlsZFN1YkluZGV4ZXMocm93T2JqZWN0LCBhc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIGxldCBpbmRleGVzID0ge307XG5cbiAgICAgICAgICAgIF8uZWFjaChhc3NvY2lhdGlvbnMsICh7IHNxbCwga2V5LCBsaXN0LCBzdWJBc3NvY3MgfSwgYW5jaG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHNxbCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IG9iaktleSA9ICc6JyArIGFuY2hvcjtcbiAgICAgICAgICAgICAgICBsZXQgc3ViT2JqZWN0ID0gcm93T2JqZWN0W29iaktleV07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBzdWJJbmRleCA9IHsgXG4gICAgICAgICAgICAgICAgICAgIHJvd09iamVjdDogc3ViT2JqZWN0IFxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBpZiAobGlzdCkgeyAgIFxuICAgICAgICAgICAgICAgICAgICAvL21hbnkgdG8gKiAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzTmlsKHN1Yk9iamVjdFtrZXldKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9zdWJPYmplY3Qgbm90IGV4aXN0LCBqdXN0IGZpbGxlZCB3aXRoIG51bGwgYnkgam9pbmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0W29iaktleV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dPYmplY3Rbb2JqS2V5XSA9IFsgc3ViT2JqZWN0IF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNOaWwoc3ViT2JqZWN0W2tleV0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1Yk9iamVjdCA9IHJvd09iamVjdFtvYmpLZXldID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoc3ViT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJBc3NvY3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YkluZGV4LnN1YkluZGV4ZXMgPSBidWlsZFN1YkluZGV4ZXMoc3ViT2JqZWN0LCBzdWJBc3NvY3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaW5kZXhlc1tvYmpLZXldID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgW3N1Yk9iamVjdFtrZXldXTogc3ViSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTsgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gaW5kZXhlcztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBhcnJheU9mT2JqcyA9IFtdO1xuXG4gICAgICAgIC8vcHJvY2VzcyBlYWNoIHJvd1xuICAgICAgICByb3dzLmZvckVhY2goKHJvdywgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHJvd09iamVjdCA9IHt9OyAvLyBoYXNoLXN0eWxlIGRhdGEgcm93XG4gICAgICAgICAgICBsZXQgdGFibGVDYWNoZSA9IHt9OyAvLyBmcm9tIGFsaWFzIHRvIGNoaWxkIHByb3Agb2Ygcm93T2JqZWN0XG5cbiAgICAgICAgICAgIHJvdy5yZWR1Y2UoKHJlc3VsdCwgdmFsdWUsIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgY29sID0gY29sdW1uc1tpXTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoY29sLnRhYmxlID09PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2NvbC5uYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7ICAgIFxuICAgICAgICAgICAgICAgICAgICBsZXQgYnVja2V0ID0gdGFibGVDYWNoZVtjb2wudGFibGVdOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChidWNrZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vYWxyZWFkeSBuZXN0ZWQgaW5zaWRlIFxuICAgICAgICAgICAgICAgICAgICAgICAgYnVja2V0W2NvbC5uYW1lXSA9IHZhbHVlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm9kZVBhdGggPSBhbGlhc01hcFtjb2wudGFibGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1Yk9iamVjdCA9IHsgW2NvbC5uYW1lXTogdmFsdWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZUNhY2hlW2NvbC50YWJsZV0gPSBzdWJPYmplY3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmFsdWVCeVBhdGgocmVzdWx0LCBub2RlUGF0aCwgc3ViT2JqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9LCByb3dPYmplY3QpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCByb3dLZXkgPSByb3dPYmplY3RbdGhpcy5tZXRhLmtleUZpZWxkXTtcbiAgICAgICAgICAgIGxldCBleGlzdGluZ1JvdyA9IG1haW5JbmRleFtyb3dLZXldO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nUm93KSB7XG4gICAgICAgICAgICAgICAgbWVyZ2VSZWNvcmQoZXhpc3RpbmdSb3csIHJvd09iamVjdCwgaGllcmFyY2h5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYXJyYXlPZk9ianMucHVzaChyb3dPYmplY3QpO1xuICAgICAgICAgICAgICAgIG1haW5JbmRleFtyb3dLZXldID0geyBcbiAgICAgICAgICAgICAgICAgICAgcm93T2JqZWN0LCBcbiAgICAgICAgICAgICAgICAgICAgc3ViSW5kZXhlczogYnVpbGRTdWJJbmRleGVzKHJvd09iamVjdCwgaGllcmFyY2h5KVxuICAgICAgICAgICAgICAgIH07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXJyYXlPZk9ianM7XG4gICAgfVxuXG4gICAgc3RhdGljIF9leHRyYWN0QXNzb2NpYXRpb25zKGRhdGEpIHtcbiAgICAgICAgbGV0IHJhdyA9IHt9LCBhc3NvY3MgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIF8uZm9yT3duKGRhdGEsICh2LCBrKSA9PiB7XG4gICAgICAgICAgICBpZiAoay5zdGFydHNXaXRoKCc6JykpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3Nbay5zdWJzdHIoMSldID0gdjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmF3W2tdID0gdjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gWyByYXcsIGFzc29jcyBdOyAgICAgICAgXG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIF9jcmVhdGVBc3NvY3NfKGNvbnRleHQsIGFzc29jcykge1xuICAgICAgICBsZXQgbWV0YSA9IHRoaXMubWV0YS5hc3NvY2lhdGlvbnM7XG4gICAgICAgIGxldCBrZXlWYWx1ZSA9IGNvbnRleHQubGF0ZXN0W3RoaXMubWV0YS5rZXlGaWVsZF07XG5cbiAgICAgICAgaWYgKF8uaXNOaWwoa2V5VmFsdWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgT29sb25nVXNhZ2VFcnJvcignTWlzc2luZyByZXF1aXJlZCBwcmltYXJ5IGtleSBmaWVsZCB2YWx1ZS4gRW50aXR5OiAnICsgdGhpcy5tZXRhLm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oYXNzb2NzLCBhc3luYyAoZGF0YSwgYW5jaG9yKSA9PiB7XG4gICAgICAgICAgICBsZXQgYXNzb2NNZXRhID0gbWV0YVthbmNob3JdO1xuICAgICAgICAgICAgaWYgKCFhc3NvY01ldGEpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQnVzaW5lc3NFcnJvcihgVW5rbm93biBhc3NvY2lhdGlvbiBcIiR7YW5jaG9yfVwiIG9mIGVudGl0eSBcIiR7dGhpcy5tZXRhLm5hbWV9XCIuYCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGxldCBhc3NvY01vZGVsID0gdGhpcy5kYi5tb2RlbChhc3NvY01ldGEuZW50aXR5KTtcblxuICAgICAgICAgICAgaWYgKGFzc29jTWV0YS5saXN0KSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IF8uY2FzdEFycmF5KGRhdGEpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oZGF0YSwgaXRlbSA9PiBhc3NvY01vZGVsLmNyZWF0ZV8oeyAuLi5pdGVtLCAuLi4oYXNzb2NNZXRhLmZpZWxkID8geyBbYXNzb2NNZXRhLmZpZWxkXToga2V5VmFsdWUgfSA6IHt9KSB9LCBjb250ZXh0LmNyZWF0ZU9wdGlvbnMsIGNvbnRleHQuY29ubk9wdGlvbnMpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFzc29jTW9kZWwuY3JlYXRlXyh7IC4uLmRhdGEsIC4uLihhc3NvY01ldGEuZmllbGQgPyB7IFthc3NvY01ldGEuZmllbGRdOiBrZXlWYWx1ZSB9IDoge30pIH0sIGNvbnRleHQuY3JlYXRlT3B0aW9ucywgY29udGV4dC5jb25uT3B0aW9ucyk7ICBcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMRW50aXR5TW9kZWw7Il19