"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const AmqpNode = tryRequire('amqplib');

const Connector = require('../../Connector');

class RabbitmqConnector extends Connector {
  constructor(connectionString, options) {
    super('rabbitmq', connectionString, options);
  }

  async end_() {
    if (this.ch) {
      await this.ch.close();
    }

    delete this.ch;

    if (this.conn) {
      await this.conn.close();
    }

    delete this.conn;
  }

  async connect_() {
    if (!this.conn) {
      this.conn = await AmqpNode.connect(this.connectionString);
    }

    if (!this.ch) {
      this.ch = await this.conn.createChannel();
    }

    return this.ch;
  }

  async disconnect_(conn) {}

  async sendToQueue_(queueName, obj) {
    if (typeof obj !== 'string') {
      obj = JSON.stringify(obj);
    }

    let ch = await this.connect_();
    await ch.assertQueue(queueName);
    return ch.sendToQueue(queueName, Buffer.from(obj));
  }

}

module.exports = RabbitmqConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvcmFiYml0bXEvQ29ubmVjdG9yLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkFtcXBOb2RlIiwiQ29ubmVjdG9yIiwiUmFiYml0bXFDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZW5kXyIsImNoIiwiY2xvc2UiLCJjb25uIiwiY29ubmVjdF8iLCJjb25uZWN0IiwiY3JlYXRlQ2hhbm5lbCIsImRpc2Nvbm5lY3RfIiwic2VuZFRvUXVldWVfIiwicXVldWVOYW1lIiwib2JqIiwiSlNPTiIsInN0cmluZ2lmeSIsImFzc2VydFF1ZXVlIiwic2VuZFRvUXVldWUiLCJCdWZmZXIiLCJmcm9tIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxnQ0FBRCxDQUE5Qjs7QUFDQSxNQUFNRSxRQUFRLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTNCOztBQUNBLE1BQU1FLFNBQVMsR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQU9BLE1BQU1JLGlCQUFOLFNBQWdDRCxTQUFoQyxDQUEwQztBQU10Q0UsRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxVQUFOLEVBQWtCRCxnQkFBbEIsRUFBb0NDLE9BQXBDO0FBQ0g7O0FBS0QsUUFBTUMsSUFBTixHQUFhO0FBQ1QsUUFBSSxLQUFLQyxFQUFULEVBQWE7QUFDVCxZQUFNLEtBQUtBLEVBQUwsQ0FBUUMsS0FBUixFQUFOO0FBQ0g7O0FBRUQsV0FBTyxLQUFLRCxFQUFaOztBQUVBLFFBQUksS0FBS0UsSUFBVCxFQUFlO0FBQ1gsWUFBTSxLQUFLQSxJQUFMLENBQVVELEtBQVYsRUFBTjtBQUNIOztBQUVELFdBQU8sS0FBS0MsSUFBWjtBQUNIOztBQVNELFFBQU1DLFFBQU4sR0FBaUI7QUFDYixRQUFJLENBQUMsS0FBS0QsSUFBVixFQUFnQjtBQUNaLFdBQUtBLElBQUwsR0FBWSxNQUFNVCxRQUFRLENBQUNXLE9BQVQsQ0FBaUIsS0FBS1AsZ0JBQXRCLENBQWxCO0FBQ0g7O0FBRUQsUUFBSSxDQUFDLEtBQUtHLEVBQVYsRUFBYztBQUNWLFdBQUtBLEVBQUwsR0FBVSxNQUFNLEtBQUtFLElBQUwsQ0FBVUcsYUFBVixFQUFoQjtBQUNIOztBQUVELFdBQU8sS0FBS0wsRUFBWjtBQUNIOztBQU1ELFFBQU1NLFdBQU4sQ0FBa0JKLElBQWxCLEVBQXdCLENBRXZCOztBQUVELFFBQU1LLFlBQU4sQ0FBbUJDLFNBQW5CLEVBQThCQyxHQUE5QixFQUFtQztBQUMvQixRQUFJLE9BQU9BLEdBQVAsS0FBZSxRQUFuQixFQUE2QjtBQUN6QkEsTUFBQUEsR0FBRyxHQUFHQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUYsR0FBZixDQUFOO0FBQ0g7O0FBRUQsUUFBSVQsRUFBRSxHQUFHLE1BQU0sS0FBS0csUUFBTCxFQUFmO0FBQ0EsVUFBTUgsRUFBRSxDQUFDWSxXQUFILENBQWVKLFNBQWYsQ0FBTjtBQUNBLFdBQU9SLEVBQUUsQ0FBQ2EsV0FBSCxDQUFlTCxTQUFmLEVBQTBCTSxNQUFNLENBQUNDLElBQVAsQ0FBWU4sR0FBWixDQUExQixDQUFQO0FBQ0g7O0FBOURxQzs7QUFpRTFDTyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0QixpQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgQW1xcE5vZGUgPSB0cnlSZXF1aXJlKCdhbXFwbGliJyk7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBSYWJiaXRtcSBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgUmFiYml0bXFDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcigncmFiYml0bXEnLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2gpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2guY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNoO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbm4pIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY29ubi5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY29ubjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5jb25uKSB7XG4gICAgICAgICAgICB0aGlzLmNvbm4gPSBhd2FpdCBBbXFwTm9kZS5jb25uZWN0KHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmICghdGhpcy5jaCkge1xuICAgICAgICAgICAgdGhpcy5jaCA9IGF3YWl0IHRoaXMuY29ubi5jcmVhdGVDaGFubmVsKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5jaDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuXG4gICAgfVxuICBcbiAgICBhc3luYyBzZW5kVG9RdWV1ZV8ocXVldWVOYW1lLCBvYmopIHtcbiAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBvYmogPSBKU09OLnN0cmluZ2lmeShvYmopO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNoID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuICAgICAgICBhd2FpdCBjaC5hc3NlcnRRdWV1ZShxdWV1ZU5hbWUpO1xuICAgICAgICByZXR1cm4gY2guc2VuZFRvUXVldWUocXVldWVOYW1lLCBCdWZmZXIuZnJvbShvYmopKTtcbiAgICB9ICAgXG59XG5cbm1vZHVsZS5leHBvcnRzID0gUmFiYml0bXFDb25uZWN0b3I7Il19