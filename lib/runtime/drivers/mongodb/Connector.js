"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
  }

  async end_() {
    if (this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      this.client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      await this.client.connect();
      this.log('debug', 'Create connection: ' + this.connectionString);
    }

    return this.client.db(this.database);
  }

  async disconnect_(conn) {}

  async ping_() {
    let db;

    try {
      db = await this.connect_();
      await db.listCollections(null, {
        nameOnly: true
      }).toArray();
      return true;
    } catch (err) {
      this.log('error', err.stack);
      return false;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async insertOne_(model, data, options) {
    return this._execute_(model, options, coll => coll.insertOne(data, {
      forceServerObjectId: true,
      bypassDocumentValidation: true
    }));
  }

  async findAndReplace_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.findAndReplace(condition, data, {
      upsert: true,
      returnOriginal: true
    }));
  }

  async findOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.findOne(condition));
  }

  async updateOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }));
  }

  async upsertOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }, {
      upsert: true
    }));
  }

  async replaceOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.replaceOne(condition, data));
  }

  async deleteOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.deleteOne(condition));
  }

  async find_(model, condition, options) {
    let db;

    try {
      db = await this._getConnection_(options);
      let queryOptions = {};

      if (!_.isEmpty(condition.$projection)) {
        queryOptions.projection = condition.$projection;
      }

      if (!_.isEmpty(condition.$orderBy)) {
        queryOptions.sort = condition.$orderBy;
      }

      if (!_.isEmpty(condition.$offset)) {
        queryOptions.skip = condition.$offset;
      }

      if (!_.isEmpty(condition.$limit)) {
        queryOptions.limit = condition.$limit;
      }

      let query = condition.$query || {};
      console.log('query', query);
      console.log('queryOptions', queryOptions);
      return await db.collection(model).find(query, queryOptions).toArray();
    } catch (err) {
      this.log('error', err.message, {
        stack: err.stack
      });
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _execute_(model, options, executor) {
    let db;

    try {
      db = await this._getConnection_(options);
      return await executor(db.collection(model));
    } catch (err) {
      throw err;
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _getConnection_(options) {
    return options && options.connection ? options.connection : this.connect_(options);
  }

  async _releaseConnection_(conn, options) {
    if (!options || !options.connection) {
      return this.disconnect_(conn);
    }
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImxvZyIsImRiIiwiZGF0YWJhc2UiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImVyciIsInN0YWNrIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsIl9leGVjdXRlXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJmb3JjZVNlcnZlck9iamVjdElkIiwiYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uIiwiZmluZEFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZEFuZFJlcGxhY2UiLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsImZpbmRPbmVfIiwiZmluZE9uZSIsInVwZGF0ZU9uZV8iLCJ1cGRhdGVPbmUiLCIkc2V0IiwidXBzZXJ0T25lXyIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJmaW5kXyIsIl9nZXRDb25uZWN0aW9uXyIsInF1ZXJ5T3B0aW9ucyIsImlzRW1wdHkiLCIkcHJvamVjdGlvbiIsInByb2plY3Rpb24iLCIkb3JkZXJCeSIsInNvcnQiLCIkb2Zmc2V0Iiwic2tpcCIsIiRsaW1pdCIsImxpbWl0IiwicXVlcnkiLCIkcXVlcnkiLCJjb25zb2xlIiwiY29sbGVjdGlvbiIsImZpbmQiLCJtZXNzYWdlIiwiX3JlbGVhc2VDb25uZWN0aW9u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M0MsT0FBdEIsRUFBK0I7QUFDM0IsV0FBUUEsT0FBTyxJQUFJQSxPQUFPLENBQUM4RCxVQUFwQixHQUFrQzlELE9BQU8sQ0FBQzhELFVBQTFDLEdBQXVELEtBQUt6RCxRQUFMLENBQWNMLE9BQWQsQ0FBOUQ7QUFDSDs7QUFFRCxRQUFNNEQsbUJBQU4sQ0FBMEJoRCxJQUExQixFQUFnQ1osT0FBaEMsRUFBeUM7QUFDckMsUUFBSSxDQUFDQSxPQUFELElBQVksQ0FBQ0EsT0FBTyxDQUFDOEQsVUFBekIsRUFBcUM7QUFDakMsYUFBTyxLQUFLbkQsV0FBTCxDQUFpQkMsSUFBakIsQ0FBUDtBQUNIO0FBQ0o7O0FBak1vQzs7QUFvTXpDbUQsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbkUsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAvbGliL3V0aWxzL0hlbHBlcnMnKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBNb25nb0NsaWVudCA9IG1vbmdvZGIuTW9uZ29DbGllbnQ7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxNeVNRTENvbm5lY3Rpb24+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jb25uZWN0KCk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsICdDcmVhdGUgY29ubmVjdGlvbjogJyArIHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtNeVNRTENvbm5lY3Rpb259IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG4gIFxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIGxldCBkYjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSAgYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuICAgICAgICAgICAgYXdhaXQgZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9ICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgZm9yY2VTZXJ2ZXJPYmplY3RJZDogdHJ1ZSwgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuZmluZEFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCB7IHVwc2VydDogdHJ1ZSwgcmV0dXJuT3JpZ2luYWw6IHRydWUgfSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCB7dXBzZXJ0OiB0cnVlfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGRiO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuX2dldENvbm5lY3Rpb25fKG9wdGlvbnMpO1xuXG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0ge307XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kcHJvamVjdGlvbikpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9IGNvbmRpdGlvbi4kcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kb3JkZXJCeSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9IGNvbmRpdGlvbi4kb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kb2Zmc2V0KSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gY29uZGl0aW9uLiRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24uJGxpbWl0KSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9IGNvbmRpdGlvbi4kbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcXVlcnkgPSBjb25kaXRpb24uJHF1ZXJ5IHx8IHt9O1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZygncXVlcnknLCBxdWVyeSk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdxdWVyeU9wdGlvbnMnLCBxdWVyeU9wdGlvbnMpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGIuY29sbGVjdGlvbihtb2RlbCkuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygnZXJyb3InLCBlcnIubWVzc2FnZSwgeyBzdGFjazogZXJyLnN0YWNrIH0pO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5fcmVsZWFzZUNvbm5lY3Rpb25fKGRiLCBvcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH0gICBcblxuICAgIGFzeW5jIF9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgZXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLl9nZXRDb25uZWN0aW9uXyhvcHRpb25zKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuX3JlbGVhc2VDb25uZWN0aW9uXyhkYiwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0Q29ubmVjdGlvbl8ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gKG9wdGlvbnMgJiYgb3B0aW9ucy5jb25uZWN0aW9uKSA/IG9wdGlvbnMuY29ubmVjdGlvbiA6IHRoaXMuY29ubmVjdF8ob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3JlbGVhc2VDb25uZWN0aW9uXyhjb25uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kaXNjb25uZWN0Xyhjb25uKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==