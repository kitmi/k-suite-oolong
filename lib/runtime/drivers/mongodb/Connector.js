"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    let {
      _id,
      ...updateData
    } = data;
    let updateOp = {
      $set: updateData
    };
    return this.onCollection_(model, coll => coll.updateOne(condition, updateOp, {
      bypassDocumentValidation: true,
      ...options,
      upsert: true
    }));
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, {
      $set: data
    }, options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJmaW5kQWxsXyIsImZpbmRfIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZXhlY3V0ZV8iLCJkYkV4ZWN1dG9yIiwiZXJyIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCIkc2V0IiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwc2VydE9uZV8iLCJfaWQiLCJ1cGRhdGVEYXRhIiwidXBkYXRlT3AiLCJ1cHNlcnQiLCJ1cHNlcnRNYW55XyIsInVuaXF1ZUtleXMiLCJvcHMiLCJtYXAiLCJyZWNvcmQiLCIkc2V0T25JbnNlcnQiLCJmaWx0ZXIiLCJwaWNrIiwidXBkYXRlIiwiYnVsa1dyaXRlIiwiaW5zZXJ0TWFueUlmTm90RXhpc3RfIiwidXBkYXRlTWFueV8iLCJ1cGRhdGVNYW55IiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImRlbGV0ZU1hbnlfIiwiZGVsZXRlTWFueSIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcXVlcnkiLCJvdGhlcnMiLCJwcm9qZWN0aW9uIiwic29ydCIsInNraXAiLCJsaW1pdCIsIk9iamVjdCIsImFzc2lnbiIsInBpY2tCeSIsInYiLCJrIiwicmVzdWx0IiwiZmluZCIsIiR0b3RhbENvdW50IiwidG90YWxDb3VudCIsImNvdW50IiwiZXhlY3V0b3IiLCJjb2xsZWN0aW9uIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxnQ0FBRCxDQUE5Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTFCO0FBQ0EsTUFBTUUsV0FBVyxHQUFHRCxPQUFPLENBQUNDLFdBQTVCOztBQUNBLE1BQU1DLFNBQVMsR0FBR0osT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQU9BLE1BQU1LLGdCQUFOLFNBQStCRCxTQUEvQixDQUF5QztBQU1yQ0UsRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxTQUFOLEVBQWlCRCxnQkFBakIsRUFBbUNDLE9BQW5DO0FBRG1DLFNBSXZDQyxRQUp1QyxHQUk1QixLQUFLQyxLQUp1QjtBQUV0Qzs7QUFPRCxRQUFNQyxJQUFOLEdBQWE7QUFDVCxRQUFJLEtBQUtDLE1BQUwsSUFBZSxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBbkIsRUFBOEM7QUFDMUMsV0FBS0QsTUFBTCxDQUFZRSxL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Q0g7O0FBRURPLFFBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjWixLQUFkLEVBQXFCN0UsQ0FBQyxDQUFDMEYsTUFBRixDQUFTUCxNQUFULEVBQWlCLENBQUNRLENBQUQsRUFBR0MsQ0FBSCxLQUFTQSxDQUFDLENBQUMsQ0FBRCxDQUFELEtBQVMsR0FBbkMsQ0FBckI7O0FBRUEsWUFBSVYsTUFBSixFQUFZO0FBQ1JNLFVBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjWixLQUFkLEVBQXFCSyxNQUFyQjtBQUNIO0FBQ0o7O0FBRUQsVUFBSVcsTUFBTSxHQUFHLE1BQU0zRCxJQUFJLENBQUM0RCxJQUFMLENBQVVqQixLQUFWLEVBQWlCRCxZQUFqQixFQUErQi9DLE9BQS9CLEVBQW5COztBQUVBLFVBQUlZLFNBQVMsSUFBSUEsU0FBUyxDQUFDc0QsV0FBM0IsRUFBd0M7QUFDcEMsWUFBSUMsVUFBVSxHQUFHLE1BQU05RCxJQUFJLENBQUM0RCxJQUFMLENBQVVqQixLQUFWLEVBQWlCb0IsS0FBakIsRUFBdkI7QUFDQSxlQUFPLENBQUVKLE1BQUYsRUFBVUcsVUFBVixDQUFQO0FBQ0g7O0FBRUQsYUFBT0gsTUFBUDtBQUNILEtBdENNLENBQVA7QUF1Q0g7O0FBRUQsUUFBTTVELGFBQU4sQ0FBb0JGLEtBQXBCLEVBQTJCbUUsUUFBM0IsRUFBcUM7QUFDakMsV0FBTyxLQUFLN0UsUUFBTCxDQUFjRixFQUFFLElBQUkrRSxRQUFRLENBQUMvRSxFQUFFLENBQUNnRixVQUFILENBQWNwRSxLQUFkLENBQUQsQ0FBNUIsQ0FBUDtBQUNIOztBQWxSb0M7O0FBcVJ6Q3FFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQi9GLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cbiAgXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRNYW55KGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSBkYXRhO1xuXG4gICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICRzZXQ6IHVwZGF0ZURhdGFcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB1cGRhdGVPcCwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE1hbnlfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7IFxuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gcmVjb3JkO1xuXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB7XG4gICAgICAgICAgICAgICAgJHNldDogdXBkYXRlRGF0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHtcbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9ICRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9ICRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBfLnBpY2tCeShvdGhlcnMsICh2LGspID0+IGtbMF0gIT09ICckJykpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCAkcXVlcnkpO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uICYmIGNvbmRpdGlvbi4kdG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==