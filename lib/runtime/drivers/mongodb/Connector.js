"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async upsertOne_(model, data, condition, options, retry) {
    return this.onCollection_(model, async coll => {
      let current = await coll.findOneAndUpdate(condition, {
        $set: {
          __lock: true
        }
      });

      if (current.value) {
        return coll.updateOne({
          _id: current.value._id
        }, {
          $set: _.omit(data, ['_id'])
        }, {
          bypassDocumentValidation: true,
          ...options
        });
      } else {
        try {
          return await coll.insertOne(data, {
            bypassDocumentValidation: true,
            ...options
          });
        } catch (error) {
          if (!retry && error.message.startsWith('E11000 duplicate key error')) {
            return this.upsertOne_(model, data, condition, options, true);
          }

          throw error;
        }
      }
    });
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else {
      ops.$set = others;
    }

    return ops;
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsIndhaXRVbnRpbF8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIm1vbmdvZGIiLCJNb25nb0NsaWVudCIsIkdyaWRGU0J1Y2tldCIsIkNvbm5lY3RvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJlcnIiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImNyZWF0ZUdyaWRGU0J1Y2tldF8iLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCIkc2V0IiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsIl90cmFuc2xhdGVVcGRhdGUiLCJ1cHNlcnRPbmVfIiwicmV0cnkiLCJjdXJyZW50IiwiX19sb2NrIiwidmFsdWUiLCJfaWQiLCJvbWl0IiwiZXJyb3IiLCJtZXNzYWdlIiwic3RhcnRzV2l0aCIsInVwc2VydE1hbnlfIiwidW5pcXVlS2V5cyIsIm9wcyIsIm1hcCIsInJlY29yZCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVPcCIsIiRzZXRPbkluc2VydCIsImZpbHRlciIsInBpY2siLCJ1cGRhdGUiLCJ1cHNlcnQiLCJidWxrV3JpdGUiLCJpbnNlcnRNYW55SWZOb3RFeGlzdF8iLCJ1cGRhdGVNYW55XyIsInVwZGF0ZU1hbnkiLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwicXVlcnlPcHRpb25zIiwicXVlcnkiLCIkcHJvamVjdGlvbiIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRxdWVyeSIsIm90aGVycyIsInByb2plY3Rpb24iLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwiT2JqZWN0IiwiYXNzaWduIiwicGlja0J5IiwidiIsImsiLCJyZXN1bHQiLCJmaW5kIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiY291bnQiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBb0JDLE9BQU8sQ0FBQyxVQUFELENBQWpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLFdBQUY7QUFBZUMsRUFBQUE7QUFBZixJQUFnQ0YsT0FBdEM7O0FBQ0EsTUFBTUcsU0FBUyxHQUFHTCxPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBRUEsTUFBTU0sY0FBYyxHQUFHLENBQUUsY0FBRixFQUFrQixNQUFsQixFQUEwQixNQUExQixFQUFrQyxNQUFsQyxFQUEwQyxNQUExQyxFQUFrRCxTQUFsRCxFQUE2RCxNQUE3RCxFQUFxRSxjQUFyRSxFQUFxRixRQUFyRixDQUF2QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUFFLFdBQUYsRUFBZSxNQUFmLEVBQXVCLE9BQXZCLEVBQWdDLE9BQWhDLEVBQXlDLFVBQXpDLENBQXZCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHRixjQUFjLENBQUNHLE1BQWYsQ0FBc0JGLGNBQXRCLENBQWxCOztBQU9BLE1BQU1HLGdCQUFOLFNBQStCTCxTQUEvQixDQUF5QztBQU1yQ00sRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxTQUFOLEVBQWlCRCxnQkFBakIsRUFBbUNDLE9BQW5DO0FBRG1DLFNBSXZDQyxRQUp1QyxHQUk1QixLQUFLQyxLQUp1QjtBQUV0Qzs7QUFPRCxRQUFNQyxJQUFOLEdBQWE7QUFDVCxRQUFJLEtBQUtDLE1BQUwsSUFBZSxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBbkIsRUFBOEM7QUFDMUMsV0FBS0QsTUFBTCxDQUFZRSxLQUFaO0FBQ0g7O0FBRUQsV0FBTyxLQUFLRixNQUFaO0FBQ0g7O0FBU0QsUUFBTUcsUUFBTixHQUFpQjtBQUNiLFFBQUksQ0FBQyxLQUFLSCxNQUFOLElBQWdCLENBQUMsS0FBS0EsTUFBTCxDQUFZQyxXQUFaLEVBQXJCLEVBQWdEO0FBQzVDLFVBQUlELE1BQU0sR0FBRyxJQUFJZCxXQUFKLENBQWdCLEtBQUtTLGdCQUFyQixFQUF1QztBQUFDUyxRQUFBQSxlQUFlLEVBQUU7QUFBbEIsT0FBdkMsQ0FBYjtBQUNBLFdBQUtKLE1BQUwsR0FBYyxNQUFNQSxNQUFNLENBQUNLLE9BQVAsRUFBcEI7QUFDSDs7QUFFRCxXQUFPLEtBQUtMLE1BQUwsQ0FBWU0sRUFBWixDQUFlLEtBQUtDLFFBQXBCLENBQVA7QUFDSDs7QUFFRCxRQUFNQyxRQUFOLENBQWVDLFVBQWYsRUFBMkI7QUFDdkIsUUFBSUgsRUFBSjs7QUFFQSxRQUFJO0FBQ0FBLE1BQUFBLEVBQUUsR0FBRyxNQUFNLEtBQUtILFFBQUwsRUFBWDtBQUVBLGFBQU8sTUFBTU0sVUFBVSxDQUFDSCxFQUFELENBQXZCO0FBQ0gsS0FKRCxDQUlFLE9BQU1JLEdBQU4sRUFBVztBQUNULFlBQU1BLEdBQU47QUFDSCxLQU5ELFNBTVU7QUFDTkosTUFBQUEsRUFBRSxLQUFJLE1BQU0sS0FBS0ssV0FBTCxDQUFpQkwsRUFBakIsQ0FBVixDQUFGO0FBQ0g7QUFDSjs7QUFNRCxRQUFNSyxXQUFOLENBQWtCQyxJQUFsQixFQUF3QixDQUN2Qjs7QUFFRCxRQUFNQyxLQUFOLEdBQWM7QUFDVixXQUFPLEtBQUtMLFFBQUwsQ0FBY0YsRUFBRSxJQUFJO0FBQ3ZCLGFBQU9BLEVBQUUsQ0FBQ1EsZUFBSCxDQUFtQixJQUFuQixFQUF5QjtBQUFFQyxRQUFBQSxRQUFRLEVBQUU7QUFBWixPQUF6QixFQUE2Q0MsT0FBN0MsRUFBUDtBQUNILEtBRk0sQ0FBUDtBQUdIOztBQVNELFFBQU1DLG1CQUFOLENBQTBCckIsT0FBMUIsRUFBbUM7QUFDL0IsUUFBSVUsRUFBRSxHQUFHLE1BQU0sS0FBS0gsUUFBTCxFQUFmO0FBRUEsV0FBTyxJQUFJaEIsWUFBSixDQUFpQm1CLEVBQWpCLEVBQXFCVixPQUFyQixDQUFQO0FBQ0g7O0FBUUQsUUFBTXNCLFVBQU4sQ0FBaUJDLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QnhCLE9BQTlCLEVBQXVDO0FBQ25DLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ0MsU0FBTCxDQUFlSCxJQUFmLEVBQXFCO0FBQUVJLE1BQUFBLHdCQUF3QixFQUFFLElBQTVCO0FBQWtDLFNBQUc1QjtBQUFyQyxLQUFyQixDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTTZCLFdBQU4sQ0FBa0JOLEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQnhCLE9BQS9CLEVBQXdDO0FBQ3BDLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ0ksVUFBTCxDQUFnQk4sSUFBaEIsRUFBc0I7QUFBRUksTUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0NHLE1BQUFBLE9BQU8sRUFBRSxLQUEzQztBQUFrRCxTQUFHL0I7QUFBckQsS0FBdEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1nQyxrQkFBTixDQUF5QlQsS0FBekIsRUFBZ0NDLElBQWhDLEVBQXNDUyxTQUF0QyxFQUFpRGpDLE9BQWpELEVBQTBEO0FBQ3RELFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ1EsaUJBQUwsQ0FBdUJELFNBQXZCLEVBQWtDVCxJQUFsQyxFQUF3Q3hCLE9BQXhDLENBQXBDLENBQVA7QUFDSDs7QUFRRCxRQUFNbUMsaUJBQU4sQ0FBd0JaLEtBQXhCLEVBQStCQyxJQUEvQixFQUFxQ1MsU0FBckMsRUFBZ0RqQyxPQUFoRCxFQUF5RDtBQUNyRCxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNVLGdCQUFMLENBQXNCSCxTQUF0QixFQUFpQztBQUFFSSxNQUFBQSxJQUFJLEVBQUViO0FBQVIsS0FBakMsRUFBaUR4QixPQUFqRCxDQUFwQyxDQUFQO0FBQ0g7O0FBRUQsUUFBTXNDLGlCQUFOLENBQXdCZixLQUF4QixFQUErQlUsU0FBL0IsRUFBMENqQyxPQUExQyxFQUFtRDtBQUMvQyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNhLGdCQUFMLENBQXNCTixTQUF0QixFQUFpQ2pDLE9BQWpDLENBQXBDLENBQVA7QUFDSDs7QUFFRCxRQUFNd0MsUUFBTixDQUFlakIsS0FBZixFQUFzQlUsU0FBdEIsRUFBaUNqQyxPQUFqQyxFQUEwQztBQUN0QyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNlLE9BQUwsQ0FBYVIsU0FBYixFQUF3QmpDLE9BQXhCLENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNMEMsVUFBTixDQUFpQm5CLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QlMsU0FBOUIsRUFBeUNqQyxPQUF6QyxFQUFrRDtBQUM5QyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNpQixTQUFMLENBQWVWLFNBQWYsRUFBMEIsS0FBS1csZ0JBQUwsQ0FBc0JwQixJQUF0QixDQUExQixFQUF1RHhCLE9BQXZELENBQXBDLENBQVA7QUFDSDs7QUFTRCxRQUFNNkMsVUFBTixDQUFpQnRCLEtBQWpCLEVBQXdCQyxJQUF4QixFQUE4QlMsU0FBOUIsRUFBeUNqQyxPQUF6QyxFQUFrRDhDLEtBQWxELEVBQXlEO0FBR3JELFdBQU8sS0FBS3JCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTBCLE1BQU9HLElBQVAsSUFBZ0I7QUFFN0MsVUFBSXFCLE9BQU8sR0FBRyxNQUFNckIsSUFBSSxDQUFDVSxnQkFBTCxDQUFzQkgsU0FBdEIsRUFBaUM7QUFBRUksUUFBQUEsSUFBSSxFQUFFO0FBQUVXLFVBQUFBLE1BQU0sRUFBRTtBQUFWO0FBQVIsT0FBakMsQ0FBcEI7O0FBRUEsVUFBSUQsT0FBTyxDQUFDRSxLQUFaLEVBQW1CO0FBQ2YsZUFBT3ZCLElBQUksQ0FBQ2lCLFNBQUwsQ0FBZTtBQUFFTyxVQUFBQSxHQUFHLEVBQUVILE9BQU8sQ0FBQ0UsS0FBUixDQUFjQztBQUFyQixTQUFmLEVBQTJDO0FBQUViLFVBQUFBLElBQUksRUFBRXBELENBQUMsQ0FBQ2tFLElBQUYsQ0FBTzNCLElBQVAsRUFBYSxDQUFFLEtBQUYsQ0FBYjtBQUFSLFNBQTNDLEVBQThFO0FBQUVJLFVBQUFBLHdCQUF3QixFQUFFLElBQTVCO0FBQWtDLGFBQUc1QjtBQUFyQyxTQUE5RSxDQUFQO0FBQ0gsT0FGRCxNQUVPO0FBQ0gsWUFBSTtBQUNBLGlCQUFPLE1BQU0wQixJQUFJLENBQUNDLFNBQUwsQ0FBZUgsSUFBZixFQUFxQjtBQUFFSSxZQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQyxlQUFHNUI7QUFBckMsV0FBckIsQ0FBYjtBQUNILFNBRkQsQ0FFRSxPQUFPb0QsS0FBUCxFQUFjO0FBQ1osY0FBSSxDQUFDTixLQUFELElBQVVNLEtBQUssQ0FBQ0MsT0FBTixDQUFjQyxVQUFkLENBQXlCLDRCQUF6QixDQUFkLEVBQXNFO0FBQ2xFLG1CQUFPLEtBQUtULFVBQUwsQ0FBZ0J0QixLQUFoQixFQUF1QkMsSUFBdkIsRUFBNkJTLFNBQTdCLEVBQXdDakMsT0FBeEMsRUFBaUQsSUFBakQsQ0FBUDtBQUNIOztBQUVELGdCQUFNb0QsS0FBTjtBQUNIO0FBQ0o7QUF5QkosS0F6Q00sQ0FBUDtBQTBDSDs7QUFrQkQsUUFBTUcsV0FBTixDQUFrQmhDLEtBQWxCLEVBQXlCQyxJQUF6QixFQUErQmdDLFVBQS9CLEVBQTJDeEQsT0FBM0MsRUFBb0Q7QUFDaEQsUUFBSXlELEdBQUcsR0FBR2pDLElBQUksQ0FBQ2tDLEdBQUwsQ0FBU0MsTUFBTSxJQUFJO0FBQ3pCLFVBQUk7QUFBRVQsUUFBQUEsR0FBRjtBQUFPLFdBQUdVO0FBQVYsVUFBeUJELE1BQTdCO0FBRUEsVUFBSUUsUUFBUSxHQUFHO0FBQ1h4QixRQUFBQSxJQUFJLEVBQUV1QjtBQURLLE9BQWY7O0FBSUEsVUFBSVYsR0FBSixFQUFTO0FBQ0xXLFFBQUFBLFFBQVEsQ0FBQ0MsWUFBVCxHQUF3QjtBQUFFWixVQUFBQTtBQUFGLFNBQXhCO0FBQ0g7O0FBRUQsYUFBTztBQUNIUCxRQUFBQSxTQUFTLEVBQUU7QUFBRW9CLFVBQUFBLE1BQU0sRUFBRSxFQUFFLEdBQUc5RSxDQUFDLENBQUMrRSxJQUFGLENBQU9MLE1BQVAsRUFBZUgsVUFBZjtBQUFMLFdBQVY7QUFBNkNTLFVBQUFBLE1BQU0sRUFBRUosUUFBckQ7QUFBK0RLLFVBQUFBLE1BQU0sRUFBRTtBQUF2RTtBQURSLE9BQVA7QUFHSCxLQWRTLENBQVY7QUFnQkEsV0FBTyxLQUFLekMsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDeUMsU0FBTCxDQUFlVixHQUFmLEVBQW9CO0FBQUU3QixNQUFBQSx3QkFBd0IsRUFBRSxJQUE1QjtBQUFrQ0csTUFBQUEsT0FBTyxFQUFFLEtBQTNDO0FBQWtELFNBQUcvQjtBQUFyRCxLQUFwQixDQUFwQyxDQUFQO0FBQ0g7O0FBU0QsUUFBTW9FLHFCQUFOLENBQTRCN0MsS0FBNUIsRUFBbUNDLElBQW5DLEVBQXlDZ0MsVUFBekMsRUFBcUR4RCxPQUFyRCxFQUE4RDtBQUMxRCxRQUFJeUQsR0FBRyxHQUFHakMsSUFBSSxDQUFDa0MsR0FBTCxDQUFTQyxNQUFNLEtBQUs7QUFDMUJoQixNQUFBQSxTQUFTLEVBQUU7QUFBRW9CLFFBQUFBLE1BQU0sRUFBRSxFQUFFLEdBQUc5RSxDQUFDLENBQUMrRSxJQUFGLENBQU9MLE1BQVAsRUFBZUgsVUFBZjtBQUFMLFNBQVY7QUFBNkNTLFFBQUFBLE1BQU0sRUFBRTtBQUFFSCxVQUFBQSxZQUFZLEVBQUVIO0FBQWhCLFNBQXJEO0FBQStFTyxRQUFBQSxNQUFNLEVBQUU7QUFBdkY7QUFEZSxLQUFMLENBQWYsQ0FBVjtBQUlBLFdBQU8sS0FBS3pDLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQ3lDLFNBQUwsQ0FBZVYsR0FBZixFQUFvQjtBQUFFN0IsTUFBQUEsd0JBQXdCLEVBQUUsSUFBNUI7QUFBa0NHLE1BQUFBLE9BQU8sRUFBRSxLQUEzQztBQUFrRCxTQUFHL0I7QUFBckQsS0FBcEIsQ0FBcEMsQ0FBUDtBQUNIOztBQVNELFFBQU1xRSxXQUFOLENBQWtCOUMsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCUyxTQUEvQixFQUEwQ2pDLE9BQTFDLEVBQW1EO0FBQy9DLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQzRDLFVBQUwsQ0FBZ0JyQyxTQUFoQixFQUEyQixLQUFLVyxnQkFBTCxDQUFzQnBCLElBQXRCLENBQTNCLEVBQXdEeEIsT0FBeEQsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU11RSxXQUFOLENBQWtCaEQsS0FBbEIsRUFBeUJDLElBQXpCLEVBQStCUyxTQUEvQixFQUEwQ2pDLE9BQTFDLEVBQW1EO0FBQy9DLFdBQU8sS0FBS3lCLGFBQUwsQ0FBbUJGLEtBQW5CLEVBQTJCRyxJQUFELElBQVVBLElBQUksQ0FBQzhDLFVBQUwsQ0FBZ0J2QyxTQUFoQixFQUEyQlQsSUFBM0IsRUFBaUN4QixPQUFqQyxDQUFwQyxDQUFQO0FBQ0g7O0FBUUQsUUFBTXlFLFVBQU4sQ0FBaUJsRCxLQUFqQixFQUF3QlUsU0FBeEIsRUFBbUNqQyxPQUFuQyxFQUE0QztBQUN4QyxXQUFPLEtBQUt5QixhQUFMLENBQW1CRixLQUFuQixFQUEyQkcsSUFBRCxJQUFVQSxJQUFJLENBQUNnRCxTQUFMLENBQWV6QyxTQUFmLEVBQTBCakMsT0FBMUIsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU0yRSxXQUFOLENBQWtCcEQsS0FBbEIsRUFBeUJVLFNBQXpCLEVBQW9DakMsT0FBcEMsRUFBNkM7QUFDekMsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMkJHLElBQUQsSUFBVUEsSUFBSSxDQUFDa0QsVUFBTCxDQUFnQjNDLFNBQWhCLEVBQTJCakMsT0FBM0IsQ0FBcEMsQ0FBUDtBQUNIOztBQVFELFFBQU1FLEtBQU4sQ0FBWXFCLEtBQVosRUFBbUJVLFNBQW5CLEVBQThCakMsT0FBOUIsRUFBdUM7QUFDbkMsV0FBTyxLQUFLeUIsYUFBTCxDQUFtQkYsS0FBbkIsRUFBMEIsTUFBTUcsSUFBTixJQUFjO0FBQzNDLFVBQUltRCxZQUFZLEdBQUcsRUFBQyxHQUFHN0U7QUFBSixPQUFuQjtBQUNBLFVBQUk4RSxLQUFLLEdBQUcsRUFBWjs7QUFFQSxVQUFJN0MsU0FBSixFQUFlO0FBQ1gsWUFBSTtBQUFFOEMsVUFBQUEsV0FBRjtBQUFlQyxVQUFBQSxRQUFmO0FBQXlCQyxVQUFBQSxPQUF6QjtBQUFrQ0MsVUFBQUEsTUFBbEM7QUFBMENDLFVBQUFBLE1BQTFDO0FBQWtELGFBQUdDO0FBQXJELFlBQWdFbkQsU0FBcEU7O0FBRUEsWUFBSThDLFdBQUosRUFBaUI7QUFDYkYsVUFBQUEsWUFBWSxDQUFDUSxVQUFiLEdBQTBCTixXQUExQjtBQUNIOztBQUVELFlBQUlDLFFBQUosRUFBYztBQUNWSCxVQUFBQSxZQUFZLENBQUNTLElBQWIsR0FBb0JOLFFBQXBCO0FBQ0g7O0FBRUQsWUFBSUMsT0FBSixFQUFhO0FBQ1RKLFVBQUFBLFlBQVksQ0FBQ1UsSUFBYixHQUFvQk4sT0FBcEI7QUFDSDs7QUFFRCxZQUFJQyxNQUFKLEVBQVk7QUFDUkwsVUFBQUEsWUFBWSxDQUFDVyxLQUFiLEdBQXFCTixNQUFyQjtBQUNIOztBQUVETyxRQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY1osS0FBZCxFQUFxQjdGLENBQUMsQ0FBQzBHLE1BQUYsQ0FBU1AsTUFBVCxFQUFpQixDQUFDUSxDQUFELEVBQUdDLENBQUgsS0FBU0EsQ0FBQyxDQUFDLENBQUQsQ0FBRCxLQUFTLEdBQW5DLENBQXJCOztBQUVBLFlBQUlWLE1BQUosRUFBWTtBQUNSTSxVQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY1osS0FBZCxFQUFxQkssTUFBckI7QUFDSDtBQUNKOztBQUVELFVBQUlXLE1BQU0sR0FBRyxNQUFNcEUsSUFBSSxDQUFDcUUsSUFBTCxDQUFVakIsS0FBVixFQUFpQkQsWUFBakIsRUFBK0J6RCxPQUEvQixFQUFuQjs7QUFFQSxVQUFJYSxTQUFTLElBQUlBLFNBQVMsQ0FBQytELFdBQTNCLEVBQXdDO0FBQ3BDLFlBQUlDLFVBQVUsR0FBRyxNQUFNdkUsSUFBSSxDQUFDcUUsSUFBTCxDQUFVakIsS0FBVixFQUFpQm9CLEtBQWpCLEVBQXZCO0FBQ0EsZUFBTyxDQUFFSixNQUFGLEVBQVVHLFVBQVYsQ0FBUDtBQUNIOztBQUVELGFBQU9ILE1BQVA7QUFDSCxLQXRDTSxDQUFQO0FBdUNIOztBQUVELFFBQU1yRSxhQUFOLENBQW9CRixLQUFwQixFQUEyQjRFLFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU8sS0FBS3ZGLFFBQUwsQ0FBY0YsRUFBRSxJQUFJeUYsUUFBUSxDQUFDekYsRUFBRSxDQUFDMEYsVUFBSCxDQUFjN0UsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUFFRHFCLEVBQUFBLGdCQUFnQixDQUFDcUIsTUFBRCxFQUFTO0FBQ3JCLFFBQUlSLEdBQUcsR0FBR3hFLENBQUMsQ0FBQytFLElBQUYsQ0FBT0MsTUFBUCxFQUFldEUsU0FBZixDQUFWOztBQUNBLFFBQUl5RixNQUFNLEdBQUduRyxDQUFDLENBQUNrRSxJQUFGLENBQU9jLE1BQVAsRUFBZXRFLFNBQWYsQ0FBYjs7QUFFQSxRQUFJOEQsR0FBRyxDQUFDcEIsSUFBUixFQUFjO0FBQ1ZvQixNQUFBQSxHQUFHLENBQUNwQixJQUFKLEdBQVcsRUFBRSxHQUFHb0IsR0FBRyxDQUFDcEIsSUFBVDtBQUFlLFdBQUcrQztBQUFsQixPQUFYO0FBQ0gsS0FGRCxNQUVPO0FBQ0gzQixNQUFBQSxHQUFHLENBQUNwQixJQUFKLEdBQVcrQyxNQUFYO0FBQ0g7O0FBRUQsV0FBTzNCLEdBQVA7QUFDSDs7QUEzVm9DOztBQThWekM0QyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6RyxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHdhaXRVbnRpbF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHsgTW9uZ29DbGllbnQsIEdyaWRGU0J1Y2tldCB9ID0gbW9uZ29kYjtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG5jb25zdCBVcGRhdGVPcHNGaWVsZCA9IFsgJyRjdXJyZW50RGF0ZScsICckaW5jJywgJyRtaW4nLCAnJG1heCcsICckbXVsJywgJyRyZW5hbWUnLCAnJHNldCcsICckc2V0T25JbnNlcnQnLCAnJHVuc2V0JyBdO1xuY29uc3QgVXBkYXRlT3BzQXJyYXkgPSBbICckYWRkVG9TZXQnLCAnJHBvcCcsICckcHVsbCcsICckcHVzaCcsICckcHVsbEFsbCcgXTtcbmNvbnN0IFVwZGF0ZU9wcyA9IFVwZGF0ZU9wc0ZpZWxkLmNvbmNhdChVcGRhdGVPcHNBcnJheSk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cbiAgXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3MuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJ1Y2tldE5hbWU9J2ZzJ10gLSBUaGUgJ2ZpbGVzJyBhbmQgJ2NodW5rcycgY29sbGVjdGlvbnMgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIHRoZSBidWNrZXQgbmFtZSBmb2xsb3dlZCBieSBhIGRvdC5cbiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wdGlvbnMuY2h1bmtTaXplQnl0ZXNdIC0gTnVtYmVyIG9mIGJ5dGVzIHN0b3JlZCBpbiBlYWNoIGNodW5rLiBEZWZhdWx0cyB0byAyNTVLQlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy53cml0ZUNvbmNlcm5dXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLnJlYWRQcmVmZXJlbmNlXVxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZUdyaWRGU0J1Y2tldF8ob3B0aW9ucykge1xuICAgICAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBHcmlkRlNCdWNrZXQoZGIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE1hbnkoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVBbmREZWxldGVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucywgcmV0cnkpIHsgXG4gICAgICAgIC8vd2FsayBhcm91bmQgbW9uZ29kYiBmYWlsZWQgdG8gc2V0T25JbnNlcnQgd2l0aCBfaWRcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyAoY29sbCkgPT4ge1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgY3VycmVudCA9IGF3YWl0IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogeyBfX2xvY2s6IHRydWUgfSB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGN1cnJlbnQudmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sbC51cGRhdGVPbmUoeyBfaWQ6IGN1cnJlbnQudmFsdWUuX2lkIH0sIHsgJHNldDogXy5vbWl0KGRhdGEsIFsgJ19pZCcgXSkgfSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSk7ICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0cnkgeyBcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXRyeSAmJiBlcnJvci5tZXNzYWdlLnN0YXJ0c1dpdGgoJ0UxMTAwMCBkdXBsaWNhdGUga2V5IGVycm9yJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcblxuICAgICAgICAgICAgLyogICAgICAgICAgIFxuXG4gICAgICAgICAgICAvL2lmIChjdXJyZW50Lmxhc3RFcnJvck9iamVjdCAmJiBjdXJyZW50Lmxhc3RFcnJvck9iamVjdC51cGRhdGVkRXhpc3RpbmcpXG5cbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gZGF0YTtcbiAgICBcbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICAgICAkc2V0OiB1cGRhdGVEYXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2codXBkYXRlT3ApO1xuXG4gICAgICAgICAgICBsZXQgb3BzID0gW3tcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IF9pZDogY3VycmVudC5faWQgfSwgdXBkYXRlOiB1cGRhdGVPcCwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgICAgIH1dO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pO1xuICAgICAgICAgICAgKi9cbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICBhc3luYyBfc3BpbkxvY2tfKG1vZGVsLCBjb25kaXRpb24pIHtcbiAgICAgICAgcmV0dXJuIHdhaXRVbnRpbF8oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IGN1cnJlbnQgPSBhd2FpdCBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB7ICRzZXQ6IHsgX19sb2NrOiB0cnVlIH0gfSk7XG4gICAgICAgICAgICBpZiAoY3VycmVudC4pXG5cblxuICAgICAgICB9LCAxLCA1MDAwKTsgICAgICAgIFxuICAgIH0gKi9cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtYW55IGVudGl0aWVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEFycmF5IG9mIHJlY29yZCB3aXRoIF9pZFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykgeyBcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiB7XG4gICAgICAgICAgICBsZXQgeyBfaWQsIC4uLnVwZGF0ZURhdGEgfSA9IHJlY29yZDtcblxuICAgICAgICAgICAgbGV0IHVwZGF0ZU9wID0ge1xuICAgICAgICAgICAgICAgICRzZXQ6IHVwZGF0ZURhdGFcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChfaWQpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSB7IF9pZCB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB1cGRhdGVPcCwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5zZXJ0IG1hbnkgZW50aXRpZXMgaWYgbm90IGV4aXN0LlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gdW5pcXVlS2V5cyBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4gKHtcbiAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB7ICRzZXRPbkluc2VydDogcmVjb3JkIH0sIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtdWx0aXBsZSBkb2N1bWVudHMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlTWFueV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlTWFueShjb25kaXRpb24sIHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwucmVwbGFjZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlTWFueV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4ge1xuICAgICAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgICAgIGxldCBxdWVyeSA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICRvcmRlckJ5LCAkb2Zmc2V0LCAkbGltaXQsICRxdWVyeSwgLi4ub3RoZXJzIH0gPSBjb25kaXRpb247XG5cbiAgICAgICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSAkbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocXVlcnksIF8ucGlja0J5KG90aGVycywgKHYsaykgPT4ga1swXSAhPT0gJyQnKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoJHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocXVlcnksICRxdWVyeSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24gJiYgY29uZGl0aW9uLiR0b3RhbENvdW50KSB7XG4gICAgICAgICAgICAgICAgbGV0IHRvdGFsQ291bnQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnkpLmNvdW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsgcmVzdWx0LCB0b3RhbENvdW50IF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVVwZGF0ZSh1cGRhdGUpIHtcbiAgICAgICAgbGV0IG9wcyA9IF8ucGljayh1cGRhdGUsIFVwZGF0ZU9wcyk7XG4gICAgICAgIGxldCBvdGhlcnMgPSBfLm9taXQodXBkYXRlLCBVcGRhdGVPcHMpO1xuXG4gICAgICAgIGlmIChvcHMuJHNldCkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSB7IC4uLm9wcy4kc2V0LCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0gb3RoZXJzO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9wcztcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=