"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, this._translateUpdate(data), options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async upsertOne_(model, data, condition, options, retry) {
    return this.onCollection_(model, async coll => {
      let current = await coll.findOneAndUpdate(condition, {
        $set: {
          __lock: true
        }
      });

      if (current.value) {
        return coll.updateOne({
          _id: current.value._id
        }, {
          $set: _.omit(data, ['_id'])
        }, {
          bypassDocumentValidation: true,
          ...options
        });
      } else {
        try {
          return await coll.insertOne(data, {
            bypassDocumentValidation: true,
            ...options
          });
        } catch (error) {
          if (!retry && error.message.startsWith('E11000 duplicate key error')) {
            return this.upsertOne_(model, data, condition, options, true);
          }

          throw error;
        }
      }
    });
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsIndhaXRVbnRpbF8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIm1vbmdvZGIiLCJNb25nb0NsaWVudCIsIkdyaWRGU0J1Y2tldCIsIkNvbm5lY3RvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJlcnIiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImNyZWF0ZUdyaWRGU0J1Y2tldF8iLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCJfdHJhbnNsYXRlVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwc2VydE9uZV8iLCJyZXRyeSIsImN1cnJlbnQiLCIkc2V0IiwiX19sb2NrIiwidmFsdWUiLCJfaWQiLCJvbWl0IiwiZXJyb3IiLCJtZXNzYWdlIiwic3RhcnRzV2l0aCIsInVwc2VydE1hbnlfIiwidW5pcXVlS2V5cyIsIm9wcyIsIm1hcCIsInJlY29yZCIsInVwZGF0ZURhdGEiLCJ1cGRhdGVPcCIsIiRzZXRPbkluc2VydCIsImZpbHRlciIsInBpY2siLCJ1cGRhdGUiLCJ1cHNlcnQiLCJidWxrV3JpdGUiLCJpbnNlcnRNYW55SWZOb3RFeGlzdF8iLCJ1cGRhdGVNYW55XyIsInVwZGF0ZU1hbnkiLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZGVsZXRlTWFueV8iLCJkZWxldGVNYW55IiwicXVlcnlPcHRpb25zIiwicXVlcnkiLCIkcHJvamVjdGlvbiIsIiRvcmRlckJ5IiwiJG9mZnNldCIsIiRsaW1pdCIsIiRxdWVyeSIsIm90aGVycyIsInByb2plY3Rpb24iLCJzb3J0Iiwic2tpcCIsImxpbWl0IiwiT2JqZWN0IiwiYXNzaWduIiwicGlja0J5IiwidiIsImsiLCJyZXN1bHQiLCJmaW5kIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiY291bnQiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJpc0VtcHR5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxnQ0FBRCxDQUE5Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTFCO0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxXQUFGO0FBQWVDLEVBQUFBO0FBQWYsSUFBZ0NGLE9BQXRDOztBQUNBLE1BQU1HLFNBQVMsR0FBR0wsT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQUVBLE1BQU1NLGNBQWMsR0FBRyxDQUFFLGNBQUYsRUFB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O0FBQ2pDLFdBQU8sS0FBS3ZGLFFBQUwsQ0FBY0YsRUFBRSxJQUFJeUYsUUFBUSxDQUFDekYsRUFBRSxDQUFDMEYsVUFBSCxDQUFjN0UsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUFFRGMsRUFBQUEsZ0JBQWdCLENBQUM0QixNQUFELEVBQVM7QUFDckIsUUFBSVIsR0FBRyxHQUFHeEUsQ0FBQyxDQUFDK0UsSUFBRixDQUFPQyxNQUFQLEVBQWV0RSxTQUFmLENBQVY7O0FBQ0EsUUFBSXlGLE1BQU0sR0FBR25HLENBQUMsQ0FBQ2tFLElBQUYsQ0FBT2MsTUFBUCxFQUFldEUsU0FBZixDQUFiOztBQUVBLFFBQUk4RCxHQUFHLENBQUNWLElBQVIsRUFBYztBQUNWVSxNQUFBQSxHQUFHLENBQUNWLElBQUosR0FBVyxFQUFFLEdBQUdVLEdBQUcsQ0FBQ1YsSUFBVDtBQUFlLFdBQUdxQztBQUFsQixPQUFYO0FBQ0gsS0FGRCxNQUVPLElBQUksQ0FBQ25HLENBQUMsQ0FBQ29ILE9BQUYsQ0FBVWpCLE1BQVYsQ0FBTCxFQUF3QjtBQUMzQjNCLE1BQUFBLEdBQUcsQ0FBQ1YsSUFBSixHQUFXcUMsTUFBWDtBQUNIOztBQUVELFdBQU8zQixHQUFQO0FBQ0g7O0FBM1ZvQzs7QUE4VnpDNkMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCMUcsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfLCB3YWl0VW50aWxfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAvbGliL3V0aWxzL0hlbHBlcnMnKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCB7IE1vbmdvQ2xpZW50LCBHcmlkRlNCdWNrZXQgfSA9IG1vbmdvZGI7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuY29uc3QgVXBkYXRlT3BzRmllbGQgPSBbICckY3VycmVudERhdGUnLCAnJGluYycsICckbWluJywgJyRtYXgnLCAnJG11bCcsICckcmVuYW1lJywgJyRzZXQnLCAnJHNldE9uSW5zZXJ0JywgJyR1bnNldCcgXTtcbmNvbnN0IFVwZGF0ZU9wc0FycmF5ID0gWyAnJGFkZFRvU2V0JywgJyRwb3AnLCAnJHB1bGwnLCAnJHB1c2gnLCAnJHB1bGxBbGwnIF07XG5jb25zdCBVcGRhdGVPcHMgPSBVcGRhdGVPcHNGaWVsZC5jb25jYXQoVXBkYXRlT3BzQXJyYXkpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICAgICAgIFxuICAgIH1cblxuICAgIGZpbmRBbGxfID0gdGhpcy5maW5kXztcblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IGNsaWVudC5jb25uZWN0KCk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGVfKGRiRXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYkV4ZWN1dG9yKGRiKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYSBkYXRhYmFzZSBjb25uZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7RGJ9IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG4gIFxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkYi5saXN0Q29sbGVjdGlvbnMobnVsbCwgeyBuYW1lT25seTogdHJ1ZSB9KS50b0FycmF5KCk7XG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbmFsIHNldHRpbmdzLlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5idWNrZXROYW1lPSdmcyddIC0gVGhlICdmaWxlcycgYW5kICdjaHVua3MnIGNvbGxlY3Rpb25zIHdpbGwgYmUgcHJlZml4ZWQgd2l0aCB0aGUgYnVja2V0IG5hbWUgZm9sbG93ZWQgYnkgYSBkb3QuXG4gICAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtvcHRpb25zLmNodW5rU2l6ZUJ5dGVzXSAtIE51bWJlciBvZiBieXRlcyBzdG9yZWQgaW4gZWFjaCBjaHVuay4gRGVmYXVsdHMgdG8gMjU1S0JcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMud3JpdGVDb25jZXJuXVxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5yZWFkUHJlZmVyZW5jZV1cbiAgICAgKi9cbiAgICBhc3luYyBjcmVhdGVHcmlkRlNCdWNrZXRfKG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgIHJldHVybiBuZXcgR3JpZEZTQnVja2V0KGRiLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhbiBhcnJheSBvZiBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRNYW55KGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCByZXRyeSkgeyBcbiAgICAgICAgLy93YWxrIGFyb3VuZCBtb25nb2RiIGZhaWxlZCB0byBzZXRPbkluc2VydCB3aXRoIF9pZFxuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIChjb2xsKSA9PiB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBjdXJyZW50ID0gYXdhaXQgY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgeyAkc2V0OiB7IF9fbG9jazogdHJ1ZSB9IH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoY3VycmVudC52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjb2xsLnVwZGF0ZU9uZSh7IF9pZDogY3VycmVudC52YWx1ZS5faWQgfSwgeyAkc2V0OiBfLm9taXQoZGF0YSwgWyAnX2lkJyBdKSB9LCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KTsgICAgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRyeSB7IFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIXJldHJ5ICYmIGVycm9yLm1lc3NhZ2Uuc3RhcnRzV2l0aCgnRTExMDAwIGR1cGxpY2F0ZSBrZXkgZXJyb3InKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAvKiAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vaWYgKGN1cnJlbnQubGFzdEVycm9yT2JqZWN0ICYmIGN1cnJlbnQubGFzdEVycm9yT2JqZWN0LnVwZGF0ZWRFeGlzdGluZylcblxuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSBkYXRhO1xuICAgIFxuICAgICAgICAgICAgbGV0IHVwZGF0ZU9wID0ge1xuICAgICAgICAgICAgICAgICRzZXQ6IHVwZGF0ZURhdGFcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGlmIChfaWQpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPcC4kc2V0T25JbnNlcnQgPSB7IF9pZCB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh1cGRhdGVPcCk7XG5cbiAgICAgICAgICAgIGxldCBvcHMgPSBbe1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgX2lkOiBjdXJyZW50Ll9pZCB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfV07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSk7XG4gICAgICAgICAgICAqL1xuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgIGFzeW5jIF9zcGluTG9ja18obW9kZWwsIGNvbmRpdGlvbikge1xuICAgICAgICByZXR1cm4gd2FpdFVudGlsXyhhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgY3VycmVudCA9IGF3YWl0IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogeyBfX2xvY2s6IHRydWUgfSB9KTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50LilcblxuXG4gICAgICAgIH0sIDEsIDUwMDApOyAgICAgICAgXG4gICAgfSAqL1xuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1hbnkgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gQXJyYXkgb2YgcmVjb3JkIHdpdGggX2lkXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE1hbnlfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7IFxuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGxldCB7IF9pZCwgLi4udXBkYXRlRGF0YSB9ID0gcmVjb3JkO1xuXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB7XG4gICAgICAgICAgICAgICAgJHNldDogdXBkYXRlRGF0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHVwZGF0ZU9wLCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgdGhpcy5fdHJhbnNsYXRlVXBkYXRlKGRhdGEpLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7XG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0ge307XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBsZXQgeyAkcHJvamVjdGlvbiwgJG9yZGVyQnksICRvZmZzZXQsICRsaW1pdCwgJHF1ZXJ5LCAuLi5vdGhlcnMgfSA9IGNvbmRpdGlvbjtcblxuICAgICAgICAgICAgICAgIGlmICgkcHJvamVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9ICRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSAkb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSAkb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJGxpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9ICRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgXy5waWNrQnkob3RoZXJzLCAodixrKSA9PiBrWzBdICE9PSAnJCcpKTtcblxuICAgICAgICAgICAgICAgIGlmICgkcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihxdWVyeSwgJHF1ZXJ5KTtcbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlVXBkYXRlKHVwZGF0ZSkge1xuICAgICAgICBsZXQgb3BzID0gXy5waWNrKHVwZGF0ZSwgVXBkYXRlT3BzKTtcbiAgICAgICAgbGV0IG90aGVycyA9IF8ub21pdCh1cGRhdGUsIFVwZGF0ZU9wcyk7XG5cbiAgICAgICAgaWYgKG9wcy4kc2V0KSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IHsgLi4ub3BzLiRzZXQsIC4uLm90aGVycyB9O1xuICAgICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkob3RoZXJzKSkge1xuICAgICAgICAgICAgb3BzLiRzZXQgPSBvdGhlcnM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BzO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==