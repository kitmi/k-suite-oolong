"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      this.client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      await this.client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      forceServerObjectId: true,
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, { ...options,
      upsert: true
    }));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        if (condition.$projection) {
          queryOptions.projection = condition.$projection;
        }

        if (condition.$orderBy) {
          queryOptions.sort = condition.$orderBy;
        }

        if (condition.$offset) {
          queryOptions.skip = condition.$offset;
        }

        if (condition.$limit) {
          queryOptions.limit = condition.$limit;
        }

        if (condition.$query) {
          query = condition.$query;
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJlcnIiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImluc2VydE9uZV8iLCJtb2RlbCIsImRhdGEiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImZvcmNlU2VydmVyT2JqZWN0SWQiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJjb25kaXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGVfIiwiZmluZE9uZUFuZFVwZGF0ZSIsIiRzZXQiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwidXBzZXJ0T25lXyIsInVwc2VydCIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJmaW5kXyIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCJwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCJzb3J0IiwiJG9mZnNldCIsInNraXAiLCIkbGltaXQiLCJsaW1pdCIsIiRxdWVyeSIsInJlc3VsdCIsImZpbmQiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsZ0NBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRCxVQUFVLENBQUMsU0FBRCxDQUExQjtBQUNBLE1BQU1FLFdBQVcsR0FBR0QsT0FBTyxDQUFDQyxXQUE1Qjs7QUFDQSxNQUFNQyxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxpQkFBRCxDQUF6Qjs7QUFPQSxNQUFNSyxnQkFBTixTQUErQkQsU0FBL0IsQ0FBeUM7QUFNckNFLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUJDLE9BQW5CLEVBQTRCO0FBQ25DLFVBQU0sU0FBTixFQUFpQkQsZ0JBQWpCLEVBQW1DQyxPQUFuQztBQUNIOztBQUtELFFBQU1DLElBQU4sR0FBYTtBQUNULFFBQUksS0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFuQixFQUE4QztBQUMxQyxXQUFLRCxNQUFMLENBQVlFLEtBQVo7QUFDSDs7QUFFRCxXQUFPLEtBQUtGLE1BQVo7QUFDSDs7QUFTRCxRQUFNRyxRQUFOLEdBQWlCO0FBQ2IsUUFBSSxDQUFDLEtBQUtILE1BQU4sSUFBZ0IsQ0FBQyxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBckIsRUFBZ0Q7QUFDNUMsV0FBS0QsTUFBTCxHQUFjLElBQUlQLFdBQUosQ0FBZ0IsS0FBS0ksZ0JBQXJCLEVBQXVDO0FBQUNPLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFkO0FBQ0EsWUFBTSxLQUFLSixNQUFMLENBQVlLLE9BQVosRUFBTjtBQUNIOztBQUVELFdBQU8sS0FBS0wsTUFB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QUNILEtBbENNLENBQVA7QUFtQ0g7O0FBRUQsUUFBTXJDLGFBQU4sQ0FBb0JGLEtBQXBCLEVBQTJCNEMsUUFBM0IsRUFBcUM7QUFDakMsV0FBTyxLQUFLdEQsUUFBTCxDQUFjRixFQUFFLElBQUl3RCxRQUFRLENBQUN4RCxFQUFFLENBQUN5RCxVQUFILENBQWM3QyxLQUFkLENBQUQsQ0FBNUIsQ0FBUDtBQUNIOztBQXhNb0M7O0FBMk16QzhDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnRFLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jb25uZWN0KCk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGZvcmNlU2VydmVyT2JqZWN0SWQ6IHRydWUsIGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHtcbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSBjb25kaXRpb24uJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJG9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSBjb25kaXRpb24uJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9IGNvbmRpdGlvbi4kb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSBjb25kaXRpb24uJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeSA9IGNvbmRpdGlvbi4kcXVlcnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=