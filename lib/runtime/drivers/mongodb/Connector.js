"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      this.client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      await this.client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, { ...options,
      upsert: true
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, {
      $set: data
    }, options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        if (condition.$projection) {
          queryOptions.projection = condition.$projection;
        }

        if (condition.$orderBy) {
          queryOptions.sort = condition.$orderBy;
        }

        if (condition.$offset) {
          queryOptions.skip = condition.$offset;
        }

        if (condition.$limit) {
          queryOptions.limit = condition.$limit;
        }

        if (condition.$query) {
          query = condition.$query;
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJmaW5kQWxsXyIsImZpbmRfIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZXhlY3V0ZV8iLCJkYkV4ZWN1dG9yIiwiZXJyIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJjb25kaXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGVfIiwiZmluZE9uZUFuZFVwZGF0ZSIsIiRzZXQiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwidXBzZXJ0T25lXyIsInVwc2VydCIsInVwZGF0ZU1hbnlfIiwidXBkYXRlTWFueSIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwicHJvamVjdGlvbiIsIiRvcmRlckJ5Iiwic29ydCIsIiRvZmZzZXQiLCJza2lwIiwiJGxpbWl0IiwibGltaXQiLCIkcXVlcnkiLCJyZXN1bHQiLCJmaW5kIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiY291bnQiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNRSxXQUFXLEdBQUdELE9BQU8sQ0FBQ0MsV0FBNUI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHSixPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBT0EsTUFBTUssZ0JBQU4sU0FBK0JELFNBQS9CLENBQXlDO0FBTXJDRSxFQUFBQSxXQUFXLENBQUNDLGdCQUFELEVBQW1CQyxPQUFuQixFQUE0QjtBQUNuQyxVQUFNLFNBQU4sRUFBaUJELGdCQUFqQixFQUFtQ0MsT0FBbkM7QUFEbUMsU0FJdkNDLFFBSnVDLEdBSTVCLEtBQUtDLEtBSnVCO0FBRXRDOztBQU9ELFFBQU1DLElBQU4sR0FBYTtBQUNULFFBQUksS0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFuQixFQUE4QztBQUMxQyxXQUFLRCxNQUFMLENBQVlFLEtBQVo7QUFDSDs7QUFFRCxXQUFPLEtBQUtGLE1BQVo7QUFDSDs7QUFTRCxRQUFNRyxRQUFOLEdBQWlCO0FBQ2IsUUFBSSxDQUFDLEtBQUtILE1BQU4sSUFBZ0IsQ0FBQyxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBckIsRUFBZ0Q7QUFDNUMsV0FBS0QsTUFBTCxHQUFjLElBQUlULFdBQUosQ0FBZ0IsS0FBS0ksZ0JBQXJCLEVBQXVDO0FBQUNTLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFkO0FBQ0EsWUFB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QUFHLE1BQU1wQyxJQUFJLENBQUNxQyxJQUFMLENBQVVYLEtBQVYsRUFBaUJELFlBQWpCLEVBQStCOUIsT0FBL0IsRUFBbkI7O0FBRUEsVUFBSVMsU0FBUyxJQUFJQSxTQUFTLENBQUNrQyxXQUEzQixFQUF3QztBQUNwQyxZQUFJQyxVQUFVLEdBQUcsTUFBTXZDLElBQUksQ0FBQ3FDLElBQUwsQ0FBVVgsS0FBVixFQUFpQmMsS0FBakIsRUFBdkI7QUFDQSxlQUFPLENBQUVKLE1BQUYsRUFBVUcsVUFBVixDQUFQO0FBQ0g7O0FBRUQsYUFBT0gsTUFBUDtBQUNILEtBbENNLENBQVA7QUFtQ0g7O0FBRUQsUUFBTXJDLGFBQU4sQ0FBb0JGLEtBQXBCLEVBQTJCNEMsUUFBM0IsRUFBcUM7QUFDakMsV0FBTyxLQUFLdEQsUUFBTCxDQUFjRixFQUFFLElBQUl3RCxRQUFRLENBQUN4RCxFQUFFLENBQUN5RCxVQUFILENBQWM3QyxLQUFkLENBQUQsQ0FBNUIsQ0FBUDtBQUNIOztBQXJOb0M7O0FBd056QzhDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnhFLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jb25uZWN0KCk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kUmVwbGFjZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgZG9jdW1lbnQgYW5kIHVwZGF0ZSBpdCBpbiBvbmUgYXRvbWljIG9wZXJhdGlvbi4gUmVxdWlyZXMgYSB3cml0ZSBsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRVcGRhdGVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwc2VydE9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwucmVwbGFjZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlTWFueV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4ge1xuICAgICAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgICAgIGxldCBxdWVyeSA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kcHJvamVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9IGNvbmRpdGlvbi4kcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9IGNvbmRpdGlvbi4kb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gY29uZGl0aW9uLiRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJGxpbWl0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9IGNvbmRpdGlvbi4kbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gY29uZGl0aW9uLiRxdWVyeTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uICYmIGNvbmRpdGlvbi4kdG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==