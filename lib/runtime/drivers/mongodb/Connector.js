"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      this.client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      await this.client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, { ...options,
      upsert: true
    }));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        if (condition.$projection) {
          queryOptions.projection = condition.$projection;
        }

        if (condition.$orderBy) {
          queryOptions.sort = condition.$orderBy;
        }

        if (condition.$offset) {
          queryOptions.skip = condition.$offset;
        }

        if (condition.$limit) {
          queryOptions.limit = condition.$limit;
        }

        if (condition.$query) {
          query = condition.$query;
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJmaW5kQWxsXyIsImZpbmRfIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZXhlY3V0ZV8iLCJkYkV4ZWN1dG9yIiwiZXJyIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJjb25kaXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGVfIiwiZmluZE9uZUFuZFVwZGF0ZSIsIiRzZXQiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwidXBzZXJ0T25lXyIsInVwc2VydCIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwicHJvamVjdGlvbiIsIiRvcmRlckJ5Iiwic29ydCIsIiRvZmZzZXQiLCJza2lwIiwiJGxpbWl0IiwibGltaXQiLCIkcXVlcnkiLCJyZXN1bHQiLCJmaW5kIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiY291bnQiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNRSxXQUFXLEdBQUdELE9BQU8sQ0FBQ0MsV0FBNUI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHSixPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBT0EsTUFBTUssZ0JBQU4sU0FBK0JELFNBQS9CLENBQXlDO0FBTXJDRSxFQUFBQSxXQUFXLENBQUNDLGdCQUFELEVBQW1CQyxPQUFuQixFQUE0QjtBQUNuQyxVQUFNLFNBQU4sRUFBaUJELGdCQUFqQixFQUFtQ0MsT0FBbkM7QUFEbUMsU0FJdkNDLFFBSnVDLEdBSTVCLEtBQUtDLEtBSnVCO0FBRXRDOztBQU9ELFFBQU1DLElBQU4sR0FBYTtBQUNULFFBQUksS0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFuQixFQUE4QztBQUMxQyxXQUFLRCxNQUFMLENBQVlFLEtBQVo7QUFDSDs7QUFFRCxXQUFPLEtBQUtGLE1BQVo7QUFDSDs7QUFTRCxRQUFNRyxRQUFOLEdBQWlCO0FBQ2IsUUFBSSxDQUFDLEtBQUtILE1BQU4sSUFBZ0IsQ0FBQyxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBckIsRUFBZ0Q7QUFDNUMsV0FBS0QsTUFBTCxHQUFjLElBQUlULFdBQUosQ0FBZ0IsS0FBS0ksZ0JBQXJCLEVBQXVDO0FBQUNTLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFkO0FBQ0EsWUFBTSxLQUFLSixNQUFMLENBQVlLLE9BQVosRUFB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QWxDTSxDQUFQO0FBbUNIOztBQUVELFFBQU1uQyxhQUFOLENBQW9CRixLQUFwQixFQUEyQjBDLFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU8sS0FBS3BELFFBQUwsQ0FBY0YsRUFBRSxJQUFJc0QsUUFBUSxDQUFDdEQsRUFBRSxDQUFDdUQsVUFBSCxDQUFjM0MsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUExTW9DOztBQTZNekM0QyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0RSxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IE1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudDtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICAgICAgIFxuICAgIH1cblxuICAgIGZpbmRBbGxfID0gdGhpcy5maW5kXztcblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY29ubmVjdCgpO1xuICAgICAgICB9ICAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cbiAgXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBhIGRvY3VtZW50IGFuZCB1cGRhdGUgaXQgaW4gb25lIGF0b21pYyBvcGVyYXRpb24uIFJlcXVpcmVzIGEgd3JpdGUgbG9jayBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCB7IC4uLm9wdGlvbnMsIHVwc2VydDogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7XG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0ge307XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gY29uZGl0aW9uLiRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gY29uZGl0aW9uLiRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSBjb25kaXRpb24uJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gY29uZGl0aW9uLiRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkgPSBjb25kaXRpb24uJHF1ZXJ5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24gJiYgY29uZGl0aW9uLiR0b3RhbENvdW50KSB7XG4gICAgICAgICAgICAgICAgbGV0IHRvdGFsQ291bnQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnkpLmNvdW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsgcmVzdWx0LCB0b3RhbENvdW50IF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19