"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options, retry) {
    return this.onCollection_(model, async coll => {
      let current = await coll.findOneAndUpdate(condition, {
        $set: {
          __lock: true
        }
      });

      if (current.value) {
        return coll.updateOne({
          _id: current.value._id
        }, {
          $set: _.omit(data, ['_id'])
        }, {
          bypassDocumentValidation: true,
          ...options
        });
      } else {
        try {
          return await coll.insertOne(data, {
            bypassDocumentValidation: true,
            ...options
          });
        } catch (error) {
          if (!retry && error.message.startsWith('E11000 duplicate key error')) {
            return this.upsertOne_(model, data, condition, options, true);
          }

          throw error;
        }
      }
    });
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, {
      $set: data
    }, options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsIndhaXRVbnRpbF8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIm1vbmdvZGIiLCJNb25nb0NsaWVudCIsIkNvbm5lY3RvciIsIk1vbmdvZGJDb25uZWN0b3IiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwiZmluZEFsbF8iLCJmaW5kXyIsImVuZF8iLCJjbGllbnQiLCJpc0Nvbm5lY3RlZCIsImNsb3NlIiwiY29ubmVjdF8iLCJ1c2VOZXdVcmxQYXJzZXIiLCJjb25uZWN0IiwiZGIiLCJkYXRhYmFzZSIsImV4ZWN1dGVfIiwiZGJFeGVjdXRvciIsImVyciIsImRpc2Nvbm5lY3RfIiwiY29ubiIsInBpbmdfIiwibGlzdENvbGxlY3Rpb25zIiwibmFtZU9ubHkiLCJ0b0FycmF5IiwiY3JlYXRlR3JpZEZTQnVja2V0XyIsIkdyaWRGU0J1Y2tldCIsImluc2VydE9uZV8iLCJtb2RlbCIsImRhdGEiLCJvbkNvbGxlY3Rpb25fIiwiY29sbCIsImluc2VydE9uZSIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImluc2VydE1hbnlfIiwiaW5zZXJ0TWFueSIsIm9yZGVyZWQiLCJmaW5kT25lQW5kUmVwbGFjZV8iLCJjb25kaXRpb24iLCJmaW5kT25lQW5kUmVwbGFjZSIsImZpbmRPbmVBbmRVcGRhdGVfIiwiZmluZE9uZUFuZFVwZGF0ZSIsIiRzZXQiLCJmaW5kT25lQW5kRGVsZXRlXyIsImZpbmRPbmVBbmREZWxldGUiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwidXBzZXJ0T25lXyIsInJldHJ5IiwiY3VycmVudCIsIl9fbG9jayIsInZhbHVlIiwiX2lkIiwib21pdCIsImVycm9yIiwibWVzc2FnZSIsInN0YXJ0c1dpdGgiLCJ1cHNlcnRNYW55XyIsInVuaXF1ZUtleXMiLCJvcHMiLCJtYXAiLCJyZWNvcmQiLCJ1cGRhdGVEYXRhIiwidXBkYXRlT3AiLCIkc2V0T25JbnNlcnQiLCJmaWx0ZXIiLCJwaWNrIiwidXBkYXRlIiwidXBzZXJ0IiwiYnVsa1dyaXRlIiwiaW5zZXJ0TWFueUlmTm90RXhpc3RfIiwidXBkYXRlTWFueV8iLCJ1cGRhdGVNYW55IiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImRlbGV0ZU1hbnlfIiwiZGVsZXRlTWFueSIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCIkb3JkZXJCeSIsIiRvZmZzZXQiLCIkbGltaXQiLCIkcXVlcnkiLCJvdGhlcnMiLCJwcm9qZWN0aW9uIiwic29ydCIsInNraXAiLCJsaW1pdCIsIk9iamVjdCIsImFzc2lnbiIsInBpY2tCeSIsInYiLCJrIiwicmVzdWx0IiwiZmluZCIsIiR0b3RhbENvdW50IiwidG90YWxDb3VudCIsImNvdW50IiwiZXhlY3V0b3IiLCJjb2xsZWN0aW9uIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBaUJELE9BQU8sQ0FBQyxnQ0FBRCxDQUE5Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdELFVBQVUsQ0FBQyxTQUFELENBQTFCO0FBQ0EsTUFBTUUsV0FBVyxHQUFHRCxPQUFPLENBQUNDLFdBQTVCOztBQUNBLE1BQU1DLFNBQVMsR0FBR0osT0FBTyxDQUFDLGlCQUFELENBQXpCOztBQU9BLE1BQU1LLGdCQUFOLFNBQStCRCxTQUEvQixDQUF5QztBQU1yQ0UsRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQkMsT0FBbkIsRUFBNEI7QUFDbkMsVUFBTSxTQUFOLEVBQWlCRCxnQkFBakIsRUFBbUNDLE9BQW5DO0FBRG1DLFNB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RixDQUFDLENBQUNxRyxNQUFGLENBQVNQLE1BQVQsRUFBaUIsQ0FBQ1EsQ0FBRCxFQUFHQyxDQUFILEtBQVNBLENBQUMsQ0FBQyxDQUFELENBQUQsS0FBUyxHQUFuQyxDQUFyQjs7QUFFQSxZQUFJVixNQUFKLEVBQVk7QUFDUk0sVUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNaLEtBQWQsRUFBcUJLLE1BQXJCO0FBQ0g7QUFDSjs7QUFFRCxVQUFJVyxNQUFNLEdBQUcsTUFBTW5FLElBQUksQ0FBQ29FLElBQUwsQ0FBVWpCLEtBQVYsRUFBaUJELFlBQWpCLEVBQStCekQsT0FBL0IsRUFBbkI7O0FBRUEsVUFBSWMsU0FBUyxJQUFJQSxTQUFTLENBQUM4RCxXQUEzQixFQUF3QztBQUNwQyxZQUFJQyxVQUFVLEdBQUcsTUFBTXRFLElBQUksQ0FBQ29FLElBQUwsQ0FBVWpCLEtBQVYsRUFBaUJvQixLQUFqQixFQUF2QjtBQUNBLGVBQU8sQ0FBRUosTUFBRixFQUFVRyxVQUFWLENBQVA7QUFDSDs7QUFFRCxhQUFPSCxNQUFQO0FBQ0gsS0F0Q00sQ0FBUDtBQXVDSDs7QUFFRCxRQUFNcEUsYUFBTixDQUFvQkYsS0FBcEIsRUFBMkIyRSxRQUEzQixFQUFxQztBQUNqQyxXQUFPLEtBQUt2RixRQUFMLENBQWNGLEVBQUUsSUFBSXlGLFFBQVEsQ0FBQ3pGLEVBQUUsQ0FBQzBGLFVBQUgsQ0FBYzVFLEtBQWQsQ0FBRCxDQUE1QixDQUFQO0FBQ0g7O0FBOVVvQzs7QUFpVnpDNkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCekcsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfLCB3YWl0VW50aWxfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAvbGliL3V0aWxzL0hlbHBlcnMnKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBNb25nb0NsaWVudCA9IG1vbmdvZGIuTW9uZ29DbGllbnQ7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgICAgICBcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKCkge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBPcHRpb25hbCBzZXR0aW5ncy5cbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuYnVja2V0TmFtZT0nZnMnXSAtIFRoZSAnZmlsZXMnIGFuZCAnY2h1bmtzJyBjb2xsZWN0aW9ucyB3aWxsIGJlIHByZWZpeGVkIHdpdGggdGhlIGJ1Y2tldCBuYW1lIGZvbGxvd2VkIGJ5IGEgZG90LlxuICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbb3B0aW9ucy5jaHVua1NpemVCeXRlc10gLSBOdW1iZXIgb2YgYnl0ZXMgc3RvcmVkIGluIGVhY2ggY2h1bmsuIERlZmF1bHRzIHRvIDI1NUtCXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLndyaXRlQ29uY2Vybl1cbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMucmVhZFByZWZlcmVuY2VdXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlR3JpZEZTQnVja2V0XyhvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICByZXR1cm4gbmV3IEdyaWRGU0J1Y2tldChkYiwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gYXJyYXkgb2YgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHthcnJheX0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBhIGRvY3VtZW50IGFuZCB1cGRhdGUgaXQgaW4gb25lIGF0b21pYyBvcGVyYXRpb24uIFJlcXVpcmVzIGEgd3JpdGUgbG9jayBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIHJldHJ5KSB7IFxuICAgICAgICAvL3dhbGsgYXJvdW5kIG1vbmdvZGIgZmFpbGVkIHRvIHNldE9uSW5zZXJ0IHdpdGggX2lkXG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgKGNvbGwpID0+IHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGN1cnJlbnQgPSBhd2FpdCBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB7ICRzZXQ6IHsgX19sb2NrOiB0cnVlIH0gfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChjdXJyZW50LnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbGwudXBkYXRlT25lKHsgX2lkOiBjdXJyZW50LnZhbHVlLl9pZCB9LCB7ICRzZXQ6IF8ub21pdChkYXRhLCBbICdfaWQnIF0pIH0sIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pOyAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJ5IHsgXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgeyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmV0cnkgJiYgZXJyb3IubWVzc2FnZS5zdGFydHNXaXRoKCdFMTEwMDAgZHVwbGljYXRlIGtleSBlcnJvcicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8qICAgICAgICAgICBcblxuICAgICAgICAgICAgLy9pZiAoY3VycmVudC5sYXN0RXJyb3JPYmplY3QgJiYgY3VycmVudC5sYXN0RXJyb3JPYmplY3QudXBkYXRlZEV4aXN0aW5nKVxuXG4gICAgICAgICAgICBsZXQgeyBfaWQsIC4uLnVwZGF0ZURhdGEgfSA9IGRhdGE7XG4gICAgXG4gICAgICAgICAgICBsZXQgdXBkYXRlT3AgPSB7XG4gICAgICAgICAgICAgICAgJHNldDogdXBkYXRlRGF0YVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKF9pZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZU9wLiRzZXRPbkluc2VydCA9IHsgX2lkIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHVwZGF0ZU9wKTtcblxuICAgICAgICAgICAgbGV0IG9wcyA9IFt7XG4gICAgICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyBfaWQ6IGN1cnJlbnQuX2lkIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9XTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KTtcbiAgICAgICAgICAgICovXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgYXN5bmMgX3NwaW5Mb2NrXyhtb2RlbCwgY29uZGl0aW9uKSB7XG4gICAgICAgIHJldHVybiB3YWl0VW50aWxfKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGxldCBjdXJyZW50ID0gYXdhaXQgY29sbC5maW5kT25lQW5kVXBkYXRlKGNvbmRpdGlvbiwgeyAkc2V0OiB7IF9fbG9jazogdHJ1ZSB9IH0pO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnQuKVxuXG5cbiAgICAgICAgfSwgMSwgNTAwMCk7ICAgICAgICBcbiAgICB9ICovXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4ge1xuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSByZWNvcmQ7XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICAgICAkc2V0OiB1cGRhdGVEYXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc2VydCBtYW55IGVudGl0aWVzIGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IHVuaXF1ZUtleXMgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykge1xuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+ICh7XG4gICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogeyAkc2V0T25JbnNlcnQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwucmVwbGFjZU9uZShjb25kaXRpb24sIGRhdGEsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZGVsZXRlTWFueV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVNYW55KGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIGFzeW5jIGNvbGwgPT4ge1xuICAgICAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgICAgIGxldCBxdWVyeSA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgbGV0IHsgJHByb2plY3Rpb24sICRvcmRlckJ5LCAkb2Zmc2V0LCAkbGltaXQsICRxdWVyeSwgLi4ub3RoZXJzIH0gPSBjb25kaXRpb247XG5cbiAgICAgICAgICAgICAgICBpZiAoJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSAkcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCRsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSAkbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocXVlcnksIF8ucGlja0J5KG90aGVycywgKHYsaykgPT4ga1swXSAhPT0gJyQnKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoJHF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ocXVlcnksICRxdWVyeSk7XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24gJiYgY29uZGl0aW9uLiR0b3RhbENvdW50KSB7XG4gICAgICAgICAgICAgICAgbGV0IHRvdGFsQ291bnQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnkpLmNvdW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsgcmVzdWx0LCB0b3RhbENvdW50IF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19