"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.client = new MongoClient(this.connectionString, {
      useNewUrlParser: true
    });
  }

  async end_() {
    if (this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_(options) {
    await this.client.connect();
    return this.client.db(this.database);
  }

  async disconnect_(conn) {
    this.client.close();
  }

  async ping_() {
    let db;

    try {
      db = await this.connect_();
      await db.listCollections(null, {
        nameOnly: true
      }).toArray();
      return true;
    } catch (err) {
      this.log('error', err.stack);
      return false;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async insertOne_(model, data, options) {
    return this._execute_(model, options, coll => coll.insertOne(data, {
      forceServerObjectId: true,
      bypassDocumentValidation: true
    }));
  }

  async findAndReplace_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.findAndReplace(condition, data, {
      upsert: true,
      returnOriginal: true
    }));
  }

  async findOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.findOne(condition));
  }

  async update_(model, data, condition, options) {
    return _execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }));
  }

  async replace_(model, data, options) {
    return _execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }, {
      upsert: true
    }));
  }

  async delete_(model, condition, options) {
    return _execute_(model, options, coll => coll.deleteOne(condition));
  }

  async find_(model, condition, options) {
    let db;

    try {
      db = await this._getConnection_(options);
      let queryOptions = {};

      if (!_.isEmpty(condition.$projection)) {
        queryOptions.projection = condition.$projection;
      }

      if (!_.isEmpty(condition.$orderBy)) {
        queryOptions.sort = condition.$orderBy;
      }

      if (!_.isEmpty(condition.$offset)) {
        queryOptions.skip = condition.$offset;
      }

      if (!_.isEmpty(condition.$limit)) {
        queryOptions.limit = condition.$limit;
      }

      let query = condition.$query || {};
      console.log('query', query);
      console.log('queryOptions', queryOptions);
      return await db.collection(model).find(query, queryOptions).toArray();
    } catch (err) {
      this.log('error', err.message, {
        stack: err.stack
      });
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _execute_(model, options, executor) {
    let db;

    try {
      db = await this._getConnection_(options);
      return await executor(db.collection(model));
    } catch (err) {
      throw err;
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _getConnection_(options) {
    return options && options.connection ? options.connection : this.connect_(options);
  }

  async _releaseConnection_(conn, options) {
    if (!options || !options.connection) {
      return this.disconnect_(conn);
    }
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJjbGllbnQiLCJ1c2VOZXdVcmxQYXJzZXIiLCJlbmRfIiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImVyciIsImxvZyIsInN0YWNrIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsIl9leGVjdXRlXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJmb3JjZVNlcnZlck9iamVjdElkIiwiYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uIiwiZmluZEFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZEFuZFJlcGxhY2UiLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsImZpbmRPbmVfIiwiZmluZE9uZSIsInVwZGF0ZV8iLCJ1cGRhdGVPbmUiLCIkc2V0IiwicmVwbGFjZV8iLCJkZWxldGVfIiwiZGVsZXRlT25lIiwiZmluZF8iLCJfZ2V0Q29ubmVjdGlvbl8iLCJxdWVyeU9wdGlvbnMiLCJpc0VtcHR5IiwiJHByb2plY3Rpb24iLCJwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCJzb3J0IiwiJG9mZnNldCIsInNraXAiLCIkbGltaXQiLCJsaW1pdCIsInF1ZXJ5IiwiJHF1ZXJ5IiwiY29uc29sZSIsImNvbGxlY3Rpb24iLCJmaW5kIiwibWVzc2FnZSIsIl9yZWxlYXNlQ29ubmVjdGlvbl8iLCJleGVjdXRvciIsImNvbm5lY3Rpb24iLCJtb2R1bGUi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KTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7IFxuICAgICAgICBcbiAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxNeVNRTENvbm5lY3Rpb24+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY29ubmVjdCgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtNeVNRTENvbm5lY3Rpb259IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHsgICAgICAgIFxuICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpOyAgICAgICAgXG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICBsZXQgZGI7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gIGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcbiAgICAgICAgICAgIGF3YWl0IGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyci5zdGFjayk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfSAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGZvcmNlU2VydmVyT2JqZWN0SWQ6IHRydWUsIGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLmZpbmRBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgeyB1cHNlcnQ6IHRydWUsIHJldHVybk9yaWdpbmFsOiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiBfZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCB7dXBzZXJ0OiB0cnVlfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIF9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gc2VsZWN0IG9wZXJhdGlvbi5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLl9nZXRDb25uZWN0aW9uXyhvcHRpb25zKTtcblxuICAgICAgICAgICAgbGV0IHF1ZXJ5T3B0aW9ucyA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24uJHByb2plY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSBjb25kaXRpb24uJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24uJG9yZGVyQnkpKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSBjb25kaXRpb24uJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24uJG9mZnNldCkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9IGNvbmRpdGlvbi4kb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uLiRsaW1pdCkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSBjb25kaXRpb24uJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0gY29uZGl0aW9uLiRxdWVyeSB8fCB7fTtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coJ3F1ZXJ5JywgcXVlcnkpO1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZygncXVlcnlPcHRpb25zJywgcXVlcnlPcHRpb25zKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiLmNvbGxlY3Rpb24obW9kZWwpLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuICAgICAgICB9IGNhdGNoKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgZXJyLm1lc3NhZ2UsIHsgc3RhY2s6IGVyci5zdGFjayB9KTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuX3JlbGVhc2VDb25uZWN0aW9uXyhkYiwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9ICAgXG5cbiAgICBhc3luYyBfZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIGV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5fZ2V0Q29ubmVjdGlvbl8ob3B0aW9ucyk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSk7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLl9yZWxlYXNlQ29ubmVjdGlvbl8oZGIsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldENvbm5lY3Rpb25fKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIChvcHRpb25zICYmIG9wdGlvbnMuY29ubmVjdGlvbikgPyBvcHRpb25zLmNvbm5lY3Rpb24gOiB0aGlzLmNvbm5lY3RfKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIF9yZWxlYXNlQ29ubmVjdGlvbl8oY29ubiwgb3B0aW9ucykge1xuICAgICAgICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuY29ubmVjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlzY29ubmVjdF8oY29ubik7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=