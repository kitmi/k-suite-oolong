"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_(options) {
    if (!this.client || !this.client.isConnected()) {
      this.client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      await this.client.connect();
      this.log('debug', 'Create connection: ' + this.connectionString);
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor, options) {
    let db;

    try {
      db = await this._getConnection_(options);
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    let db;

    try {
      db = await this.connect_();
      await db.listCollections(null, {
        nameOnly: true
      }).toArray();
      return true;
    } catch (err) {
      this.log('error', err.stack);
      return false;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async insertOne_(model, data, options) {
    return this._execute_(model, options, coll => coll.insertOne(data, {
      forceServerObjectId: true,
      bypassDocumentValidation: true
    }));
  }

  async findAndReplace_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.findAndReplace(condition, data, {
      upsert: true,
      returnOriginal: true
    }));
  }

  async findOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.findOne(condition));
  }

  async updateOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }));
  }

  async upsertOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }, {
      upsert: true
    }));
  }

  async replaceOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.replaceOne(condition, data));
  }

  async deleteOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.deleteOne(condition));
  }

  async find_(model, condition, options) {
    let db;

    try {
      db = await this._getConnection_(options);
      let queryOptions = {};

      if (!_.isEmpty(condition.$projection)) {
        queryOptions.projection = condition.$projection;
      }

      if (!_.isEmpty(condition.$orderBy)) {
        queryOptions.sort = condition.$orderBy;
      }

      if (!_.isEmpty(condition.$offset)) {
        queryOptions.skip = condition.$offset;
      }

      if (!_.isEmpty(condition.$limit)) {
        queryOptions.limit = condition.$limit;
      }

      let query = condition.$query || {};
      console.log('query', query);
      console.log('queryOptions', queryOptions);
      return await db.collection(model).find(query, queryOptions).toArray();
    } catch (err) {
      this.log('error', err.message, {
        stack: err.stack
      });
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _execute_(model, options, executor) {
    let db;

    try {
      db = await this._getConnection_(options);
      return await executor(db.collection(model));
    } catch (err) {
      throw err;
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _getConnection_(options) {
    return options && options.connection ? options.connection : this.connect_(options);
  }

  async _releaseConnection_(conn, options) {
    if (!options || !options.connection) {
      return this.disconnect_(conn);
    }
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImxvZyIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJfZ2V0Q29ubmVjdGlvbl8iLCJlcnIiLCJfcmVsZWFzZUNvbm5lY3Rpb25fIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJzdGFjayIsImluc2VydE9uZV8iLCJtb2RlbCIsImRhdGEiLCJfZXhlY3V0ZV8iLCJjb2xsIiwiaW5zZXJ0T25lIiwiZm9yY2VTZXJ2ZXJPYmplY3RJZCIsImJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbiIsImZpbmRBbmRSZXBsYWNlXyIsImNvbmRpdGlvbiIsImZpbmRBbmRSZXBsYWNlIiwidXBzZXJ0IiwicmV0dXJuT3JpZ2luYWwiLCJmaW5kT25lXyIsImZpbmRPbmUiLCJ1cGRhdGVPbmVfIiwidXBkYXRlT25lIiwiJHNldCIsInVwc2VydE9uZV8iLCJyZXBsYWNlT25lXyIsInJlcGxhY2VPbmUiLCJkZWxldGVPbmVfIiwiZGVsZXRlT25lIiwiZmluZF8iLCJxdWVyeU9wdGlvbnMiLCJpc0VtcHR5IiwiJHByb2plY3Rpb24iLCJwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCJzb3J0IiwiJG9mZnNldCIsInNraXAiLCIkbGltaXQiLCJsaW1pdCIsInF1ZXJ5IiwiJHF1ZXJ5IiwiY29uc29sZSIsImNvbGxlY3Rpb24iLCJmaW5kIiwibWVzc2FnZSIsImV4ZWN1dG9yIiwiY29ubmVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsZ0NBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRCxVQUFVLENBQUMsU0FBRCxDQUExQjtBQUNBLE1BQU1FLFdBQVcsR0FBR0QsT0FBTyxDQUFDQyxXQUE1Qjs7QUFDQSxNQUFNQyxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxpQkFBRCxDQUF6Qjs7QUFPQSxNQUFNSyxnQkFBTixTQUErQkQsU0FBL0IsQ0FBeUM7QUFNckNFLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUJDLE9BQW5CLEVBQTRCO0FBQ25DLFVBQU0sU0FBTixFQUFpQkQsZ0JBQWpCLEVBQW1DQyxPQUFuQztBQUNIOztBQUtELFFBQU1DLElBQU4sR0FBYTtBQUNULFFBQUksS0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFuQixFQUE4QztBQUMxQyxXQUFLRCxNQUFMLENBQVlFLEtBQVo7QUFDSDs7QUFFRCxXQUFPLEtBQUtGLE1BQVo7QUFDSDs7QUFTRCxRQUFNRyxRQUFOLENBQWVMLE9BQWYsRUFBd0I7QUFDcEIsUUFBSSxDQUFDLEtBQUtFLE1BQU4sSUFBZ0IsQ0FBQyxLQUFLQSxNQUFMLENBQVlDLFdBQVosRUFBckIsRUFBZ0Q7QUFDNUMsV0FBS0QsTUFBTCxHQUFjLElBQUlQLFdBQUosQ0FBZ0IsS0FBS0ksZ0JBQXJCLEVBQXVDO0FBQUNPLFFBQUFBLGVBQWUsRUFBRTtBQUFsQixPQUF2QyxDQUFkO0FBQ0EsWUFBTSxLQUFLSixNQUFMLENBQVlLLE9BQVosRUFBTjtBQUVBLFdBQUtDLEdBQUwsQ0FBUyxPQUFULEVBQWtCLHdCQUF3QixLQUFLVCxnQkFBL0M7QUFDSDs7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T0FBdkIsRUFBZ0MrRCxRQUFoQyxFQUEwQztBQUN0QyxRQUFJdEQsRUFBSjs7QUFFQSxRQUFJO0FBQ0FBLE1BQUFBLEVBQUUsR0FBRyxNQUFNLEtBQUtJLGVBQUwsQ0FBcUJiLE9BQXJCLENBQVg7QUFFQSxhQUFPLE1BQU0rRCxRQUFRLENBQUN0RCxFQUFFLENBQUNtRCxVQUFILENBQWNwQyxLQUFkLENBQUQsQ0FBckI7QUFDSCxLQUpELENBSUUsT0FBTVYsR0FBTixFQUFXO0FBQ1QsWUFBTUEsR0FBTjtBQUNILEtBTkQsU0FNVTtBQUNOTCxNQUFBQSxFQUFFLEtBQUksTUFBTSxLQUFLTSxtQkFBTCxDQUF5Qk4sRUFBekIsRUFBNkJULE9BQTdCLENBQVYsQ0FBRjtBQUNIO0FBQ0o7O0FBRUQsUUFBTWEsZUFBTixDQUFzQmIsT0FBdEIsRUFBK0I7QUFDM0IsV0FBUUEsT0FBTyxJQUFJQSxPQUFPLENBQUNnRSxVQUFwQixHQUFrQ2hFLE9BQU8sQ0FBQ2dFLFVBQTFDLEdBQXVELEtBQUszRCxRQUFMLENBQWNMLE9BQWQsQ0FBOUQ7QUFDSDs7QUFFRCxRQUFNZSxtQkFBTixDQUEwQkUsSUFBMUIsRUFBZ0NqQixPQUFoQyxFQUF5QztBQUNyQyxRQUFJLENBQUNBLE9BQUQsSUFBWSxDQUFDQSxPQUFPLENBQUNnRSxVQUF6QixFQUFxQztBQUNqQyxhQUFPLEtBQUtoRCxXQUFMLENBQWlCQyxJQUFqQixDQUFQO0FBQ0g7QUFDSjs7QUEvTW9DOztBQWtOekNnRCxNQUFNLENBQUNDLE9BQVAsR0FBaUJyRSxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IE1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudDtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxNeVNRTENvbm5lY3Rpb24+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jb25uZWN0KCk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCdkZWJ1ZycsICdDcmVhdGUgY29ubmVjdGlvbjogJyArIHRoaXMuY29ubmVjdGlvblN0cmluZyk7XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5fZ2V0Q29ubmVjdGlvbl8ob3B0aW9ucyk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYkV4ZWN1dG9yKGRiKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuX3JlbGVhc2VDb25uZWN0aW9uXyhkYiwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtNeVNRTENvbm5lY3Rpb259IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG4gIFxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIGxldCBkYjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSAgYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuICAgICAgICAgICAgYXdhaXQgZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9ICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgZm9yY2VTZXJ2ZXJPYmplY3RJZDogdHJ1ZSwgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuZmluZEFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCB7IHVwc2VydDogdHJ1ZSwgcmV0dXJuT3JpZ2luYWw6IHRydWUgfSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCB7dXBzZXJ0OiB0cnVlfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgYW4gZXhpc3RpbmcgZW50aXR5IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyByZXBsYWNlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGRiO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuX2dldENvbm5lY3Rpb25fKG9wdGlvbnMpO1xuXG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0ge307XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kcHJvamVjdGlvbikpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucHJvamVjdGlvbiA9IGNvbmRpdGlvbi4kcHJvamVjdGlvbjsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kb3JkZXJCeSkpIHtcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9IGNvbmRpdGlvbi4kb3JkZXJCeTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kb2Zmc2V0KSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5za2lwID0gY29uZGl0aW9uLiRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShjb25kaXRpb24uJGxpbWl0KSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5saW1pdCA9IGNvbmRpdGlvbi4kbGltaXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcXVlcnkgPSBjb25kaXRpb24uJHF1ZXJ5IHx8IHt9O1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZygncXVlcnknLCBxdWVyeSk7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdxdWVyeU9wdGlvbnMnLCBxdWVyeU9wdGlvbnMpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGIuY29sbGVjdGlvbihtb2RlbCkuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygnZXJyb3InLCBlcnIubWVzc2FnZSwgeyBzdGFjazogZXJyLnN0YWNrIH0pO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5fcmVsZWFzZUNvbm5lY3Rpb25fKGRiLCBvcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH0gICBcblxuICAgIGFzeW5jIF9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgZXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLl9nZXRDb25uZWN0aW9uXyhvcHRpb25zKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuX3JlbGVhc2VDb25uZWN0aW9uXyhkYiwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0Q29ubmVjdGlvbl8ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gKG9wdGlvbnMgJiYgb3B0aW9ucy5jb25uZWN0aW9uKSA/IG9wdGlvbnMuY29ubmVjdGlvbiA6IHRoaXMuY29ubmVjdF8ob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3JlbGVhc2VDb25uZWN0aW9uXyhjb25uLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5jb25uZWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kaXNjb25uZWN0Xyhjb25uKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb25nb2RiQ29ubmVjdG9yOyJdfQ==