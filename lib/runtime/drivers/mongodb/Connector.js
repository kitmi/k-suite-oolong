"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: _.omit(data, ['_id'])
    }, { ...options,
      upsert: true
    }));
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $set: _.omit(record, ['_id']),
          $setOnInsert: {
            _id: record._id
          }
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, {
      $set: data
    }, options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        if (condition.$projection) {
          queryOptions.projection = condition.$projection;
        }

        if (condition.$orderBy) {
          queryOptions.sort = condition.$orderBy;
        }

        if (condition.$offset) {
          queryOptions.skip = condition.$offset;
        }

        if (condition.$limit) {
          queryOptions.limit = condition.$limit;
        }

        if (condition.$query) {
          query = condition.$query;
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJmaW5kQWxsXyIsImZpbmRfIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZXhlY3V0ZV8iLCJkYkV4ZWN1dG9yIiwiZXJyIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCIkc2V0IiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwc2VydE9uZV8iLCJvbWl0IiwidXBzZXJ0IiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsIiRzZXRPbkluc2VydCIsIl9pZCIsImJ1bGtXcml0ZSIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsInVwZGF0ZU1hbnlfIiwidXBkYXRlTWFueSIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwicHJvamVjdGlvbiIsIiRvcmRlckJ5Iiwic29ydCIsIiRvZmZzZXQiLCJza2lwIiwiJGxpbWl0IiwibGltaXQiLCIkcXVlcnkiLCJyZXN1bHQiLCJmaW5kIiwiJHRvdGFsQ291bnQiLCJ0b3RhbENvdW50IiwiY291bnQiLCJleGVjdXRvciIsImNvbGxlY3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNRSxXQUFXLEdBQUdELE9BQU8sQ0FBQ0MsV0FBNUI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHSixPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBT0EsTUFBTUssZ0JBQU4sU0FBK0JELFNBQS9CLENBQXlDO0FBTXJDRSxFQUFBQSxXQUFXLENBQUNDLGdCQUFELEVBQW1CQyxPQUFuQixFQUE0QjtBQUNuQyxVQUFNLFNBQU4sRUFBaUJELGdCQUFqQixFQUFtQ0MsT0FBbkM7QUFEbUMsU0FJdkNDLFFBSnVDLEdBSTVCLEtBQUtDLEtBSnVCO0FBRXRDOztBQU9ELFFBQU1DLElBQU4sR0FBYTtBQUNULFFBQUksS0FBS0MsTUFBTCxJQUFlLEtBQUtBLE1BQUwsQ0FBWUMsV0FBWixFQUFuQixFQUE4QztBQUMxQyxXQUFLRCxNQUFMLENBQVlFLEtBQVo7QUFDSDs7QUFFRCxXQUFPLEtBQUtGLE1BQVo7QUFDSDs7QUFTRCxRQUFNRyxRQUFOLEdBQWlCO0FB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RUFBd0M7QUFDcEMsWUFBSUMsVUFBVSxHQUFHLE1BQU12RCxJQUFJLENBQUNxRCxJQUFMLENBQVVYLEtBQVYsRUFBaUJjLEtBQWpCLEVBQXZCO0FBQ0EsZUFBTyxDQUFFSixNQUFGLEVBQVVHLFVBQVYsQ0FBUDtBQUNIOztBQUVELGFBQU9ILE1BQVA7QUFDSCxLQWxDTSxDQUFQO0FBbUNIOztBQUVELFFBQU1yRCxhQUFOLENBQW9CRixLQUFwQixFQUEyQjRELFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU8sS0FBS3RFLFFBQUwsQ0FBY0YsRUFBRSxJQUFJd0UsUUFBUSxDQUFDeEUsRUFBRSxDQUFDeUUsVUFBSCxDQUFjN0QsS0FBZCxDQUFELENBQTVCLENBQVA7QUFDSDs7QUE1UG9DOztBQStQekM4RCxNQUFNLENBQUNDLE9BQVAsR0FBaUJ4RixnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IE1vbmdvQ2xpZW50ID0gbW9uZ29kYi5Nb25nb0NsaWVudDtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG4vKipcbiAqIE1vbmdvZGIgZGF0YSBzdG9yYWdlIGNvbm5lY3Rvci5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgQ29ubmVjdG9yXG4gKi9cbmNsYXNzIE1vbmdvZGJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xuICAgIC8qKiAgICAgICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLnVzZVByZXBhcmVkU3RhdGVtZW50XSAtIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBzdXBlcignbW9uZ29kYicsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMpOyAgICAgICAgIFxuICAgIH1cblxuICAgIGZpbmRBbGxfID0gdGhpcy5maW5kXztcblxuICAgIC8qKlxuICAgICAqIENsb3NlIGFsbCBjb25uZWN0aW9uIGluaXRpYXRlZCBieSB0aGlzIGNvbm5lY3Rvci5cbiAgICAgKi9cbiAgICBhc3luYyBlbmRfKCkge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQgJiYgdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgdGhpcy5jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxEYj59XG4gICAgICovXG4gICAgYXN5bmMgY29ubmVjdF8oKSB7XG4gICAgICAgIGlmICghdGhpcy5jbGllbnQgfHwgIXRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIGxldCBjbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgICAgICAgICB0aGlzLmNsaWVudCA9IGF3YWl0IGNsaWVudC5jb25uZWN0KCk7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGVfKGRiRXhlY3V0b3IpIHtcbiAgICAgICAgbGV0IGRiO1xuICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYkV4ZWN1dG9yKGRiKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGRiICYmIGF3YWl0IHRoaXMuZGlzY29ubmVjdF8oZGIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYSBkYXRhYmFzZSBjb25uZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7RGJ9IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHtcbiAgICB9XG4gIFxuICAgIGFzeW5jIHBpbmdfKCkgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkYi5saXN0Q29sbGVjdGlvbnMobnVsbCwgeyBuYW1lT25seTogdHJ1ZSB9KS50b0FycmF5KCk7XG4gICAgICAgIH0pOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE9uZV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0T25lKGRhdGEsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYW4gYXJyYXkgb2YgbmV3IGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHthcnJheX0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueV8obW9kZWwsIGRhdGEsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuaW5zZXJ0TWFueShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2UgKGluc2VydCBvciB1cGRhdGUgZm9yIGV4c2lzdGluZykgYW4gZW50aXR5IGFuZCByZXR1cm4gb3JpZ2luYWwgcmVjb3JkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFJlcGxhY2VfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFJlcGxhY2UoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBhIGRvY3VtZW50IGFuZCB1cGRhdGUgaXQgaW4gb25lIGF0b21pYyBvcGVyYXRpb24uIFJlcXVpcmVzIGEgd3JpdGUgbG9jayBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kT25lQW5kVXBkYXRlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7ICAgICBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZUFuZERlbGV0ZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lQW5kRGVsZXRlKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogXy5vbWl0KGRhdGEsIFsnX2lkJ10pIH0sIHsgLi4ub3B0aW9ucywgdXBzZXJ0OiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4gKHtcbiAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB7ICRzZXQ6IF8ub21pdChyZWNvcmQsIFsnX2lkJ10pLCAkc2V0T25JbnNlcnQ6IHsgX2lkOiByZWNvcmQuX2lkIH0gfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5zZXJ0IG1hbnkgZW50aXRpZXMgaWYgbm90IGV4aXN0LlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gdW5pcXVlS2V5cyBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0TWFueUlmTm90RXhpc3RfKG1vZGVsLCBkYXRhLCB1bmlxdWVLZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4gKHtcbiAgICAgICAgICAgIHVwZGF0ZU9uZTogeyBmaWx0ZXI6IHsgLi4uXy5waWNrKHJlY29yZCwgdW5pcXVlS2V5cykgfSwgdXBkYXRlOiB7ICRzZXRPbkluc2VydDogcmVjb3JkIH0sIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtdWx0aXBsZSBkb2N1bWVudHMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlTWFueV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlTWFueShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9LCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5yZXBsYWNlT25lKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVPbmVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBkZWxldGVNYW55Xyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU1hbnkoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGVyZm9ybSBzZWxlY3Qgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgY29sbCA9PiB7XG4gICAgICAgICAgICBsZXQgcXVlcnlPcHRpb25zID0gey4uLm9wdGlvbnN9O1xuICAgICAgICAgICAgbGV0IHF1ZXJ5ID0ge307XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gY29uZGl0aW9uLiRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRvcmRlckJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gY29uZGl0aW9uLiRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSBjb25kaXRpb24uJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gY29uZGl0aW9uLiRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi4kcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnkgPSBjb25kaXRpb24uJHF1ZXJ5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSwgcXVlcnlPcHRpb25zKS50b0FycmF5KCk7XG5cbiAgICAgICAgICAgIGlmIChjb25kaXRpb24gJiYgY29uZGl0aW9uLiR0b3RhbENvdW50KSB7XG4gICAgICAgICAgICAgICAgbGV0IHRvdGFsQ291bnQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnkpLmNvdW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsgcmVzdWx0LCB0b3RhbENvdW50IF07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0pO1xuICAgIH0gICBcblxuICAgIGFzeW5jIG9uQ29sbGVjdGlvbl8obW9kZWwsIGV4ZWN1dG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVfKGRiID0+IGV4ZWN1dG9yKGRiLmNvbGxlY3Rpb24obW9kZWwpKSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19