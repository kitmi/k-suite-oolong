"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, {
      $set: data
    }, options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, options));
  }

  async upsertOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, {
      $set: data
    }, { ...options,
      upsert: true
    }));
  }

  async upsertMany_(model, data, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: {
          _id: record._id
        },
        update: {
          $set: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, {
      $set: data
    }, options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        if (condition.$projection) {
          queryOptions.projection = condition.$projection;
        }

        if (condition.$orderBy) {
          queryOptions.sort = condition.$orderBy;
        }

        if (condition.$offset) {
          queryOptions.skip = condition.$offset;
        }

        if (condition.$limit) {
          queryOptions.limit = condition.$limit;
        }

        if (condition.$query) {
          query = condition.$query;
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJmaW5kQWxsXyIsImZpbmRfIiwiZW5kXyIsImNsaWVudCIsImlzQ29ubmVjdGVkIiwiY2xvc2UiLCJjb25uZWN0XyIsInVzZU5ld1VybFBhcnNlciIsImNvbm5lY3QiLCJkYiIsImRhdGFiYXNlIiwiZXhlY3V0ZV8iLCJkYkV4ZWN1dG9yIiwiZXJyIiwiZGlzY29ubmVjdF8iLCJjb25uIiwicGluZ18iLCJsaXN0Q29sbGVjdGlvbnMiLCJuYW1lT25seSIsInRvQXJyYXkiLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCIkc2V0IiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwc2VydE9uZV8iLCJ1cHNlcnQiLCJ1cHNlcnRNYW55XyIsIm9wcyIsIm1hcCIsInJlY29yZCIsImZpbHRlciIsIl9pZCIsInVwZGF0ZSIsImJ1bGtXcml0ZSIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsInVuaXF1ZUtleXMiLCJwaWNrIiwiJHNldE9uSW5zZXJ0IiwidXBkYXRlTWFueV8iLCJ1cGRhdGVNYW55IiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImRlbGV0ZU1hbnlfIiwiZGVsZXRlTWFueSIsInF1ZXJ5T3B0aW9ucyIsInF1ZXJ5IiwiJHByb2plY3Rpb24iLCJwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCJzb3J0IiwiJG9mZnNldCIsInNraXAiLCIkbGltaXQiLCJsaW1pdCIsIiRxdWVyeSIsInJlc3VsdCIsImZpbmQiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsZ0NBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRCxVQUFVLENBQUMsU0FBRCxDQUExQjtBQUNBLE1BQU1FLFdBQVcsR0FBR0QsT0FBTyxDQUFDQyxXQUE1Qjs7QUFDQSxNQUFNQyxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxpQkFBRCxDQUF6Qjs7QUFPQSxNQUFNSyxnQkFBTixTQUErQkQsU0FBL0IsQ0FBeUM7QUFNckNFLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUJDLE9BQW5CLEVBQTRCO0FBQ25DLFVBQU0sU0FBTixFQUFpQkQsZ0JBQWpCLEVBQW1DQyxPQUFuQztBQURtQyxTQUl2Q0MsUUFKdUMsR0FJNUIsS0FBS0MsS0FKdUI7QUFFdEM7O0FBT0QsUUFBTUMsSUFBTixHQUFhO0FBQ1QsUUFBSSxLQUFLQyxNQUFMLElBQWUsS0FBS0EsTUFBTCxDQUFZQyxXQUFaLEVBQW5CLEVBQThDO0FBQzFDLFdBQUtELE1BQUwsQ0FBWUUsS0FBWjtBQUNIOztBQUVELFdBQU8sS0FBS0YsTUFBWjtBQUNIOztBQVNELFFBQU1HLFFBQU4sR0FBaUI7QUFDYixRQUFJ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QixFQUFxQztBQUNqQyxXQUFPLEtBQUtyRSxRQUFMLENBQWNGLEVBQUUsSUFBSXVFLFFBQVEsQ0FBQ3ZFLEVBQUUsQ0FBQ3dFLFVBQUgsQ0FBYzVELEtBQWQsQ0FBRCxDQUE1QixDQUFQO0FBQ0g7O0FBNVBvQzs7QUErUHpDNkQsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkYsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAvbGliL3V0aWxzL0hlbHBlcnMnKTtcbmNvbnN0IG1vbmdvZGIgPSB0cnlSZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBNb25nb0NsaWVudCA9IG1vbmdvZGIuTW9uZ29DbGllbnQ7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi8uLi9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBNb25nb2RiIGRhdGEgc3RvcmFnZSBjb25uZWN0b3IuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIENvbm5lY3RvclxuICovXG5jbGFzcyBNb25nb2RiQ29ubmVjdG9yIGV4dGVuZHMgQ29ubmVjdG9yIHtcbiAgICAvKiogICAgICAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy51c2VQcmVwYXJlZFN0YXRlbWVudF0gLSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIoJ21vbmdvZGInLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zKTsgICAgICAgICBcbiAgICB9XG5cbiAgICBmaW5kQWxsXyA9IHRoaXMuZmluZF87XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY29ubmVjdGlvbiBpbml0aWF0ZWQgYnkgdGhpcyBjb25uZWN0b3IuXG4gICAgICovXG4gICAgYXN5bmMgZW5kXygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LmNsb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgZGF0YWJhc2UgY29ubmVjdGlvbiBiYXNlZCBvbiB0aGUgZGVmYXVsdCBjb25uZWN0aW9uIHN0cmluZyBvZiB0aGUgY29ubmVjdG9yIGFuZCBnaXZlbiBvcHRpb25zLiAgICAgXG4gICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSAtIEV4dHJhIG9wdGlvbnMgZm9yIHRoZSBjb25uZWN0aW9uLCBvcHRpb25hbC5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLm11bHRpcGxlU3RhdGVtZW50cz1mYWxzZV0gLSBBbGxvdyBydW5uaW5nIG11bHRpcGxlIHN0YXRlbWVudHMgYXQgYSB0aW1lLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMuY3JlYXRlRGF0YWJhc2U9ZmFsc2VdIC0gRmxhZyB0byB1c2VkIHdoZW4gY3JlYXRpbmcgYSBkYXRhYmFzZS5cbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48RGI+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKCkge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBsZXQgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHRoaXMuY29ubmVjdGlvblN0cmluZywge3VzZU5ld1VybFBhcnNlcjogdHJ1ZX0pO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQgPSBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlXyhkYkV4ZWN1dG9yKSB7XG4gICAgICAgIGxldCBkYjtcbiAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5jb25uZWN0XygpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGJFeGVjdXRvcihkYik7XG4gICAgICAgIH0gY2F0Y2goZXJyKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgZGF0YWJhc2UgY29ubmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0RifSBjb25uIC0gTXlTUUwgY29ubmVjdGlvbi5cbiAgICAgKi9cbiAgICBhc3luYyBkaXNjb25uZWN0Xyhjb25uKSB7XG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZGIubGlzdENvbGxlY3Rpb25zKG51bGwsIHsgbmFtZU9ubHk6IHRydWUgfSkudG9BcnJheSgpO1xuICAgICAgICB9KTsgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE1hbnkoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmRPbmVBbmREZWxldGVfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZmluZE9uZUFuZERlbGV0ZShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyBcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwudXBkYXRlT25lKGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0T25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVPbmUoY29uZGl0aW9uLCB7ICRzZXQ6IGRhdGEgfSwgeyAuLi5vcHRpb25zLCB1cHNlcnQ6IHRydWUgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBtYW55IGVudGl0aWVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEFycmF5IG9mIHJlY29yZCB3aXRoIF9pZFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRNYW55Xyhtb2RlbCwgZGF0YSwgb3B0aW9ucykgeyBcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyBfaWQ6IHJlY29yZC5faWQgfSwgdXBkYXRlOiB7ICRzZXQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgbWFueSBlbnRpdGllcyBpZiBub3QgZXhpc3QuXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSB1bmlxdWVLZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRNYW55SWZOb3RFeGlzdF8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IG9wcyA9IGRhdGEubWFwKHJlY29yZCA9PiAoe1xuICAgICAgICAgICAgdXBkYXRlT25lOiB7IGZpbHRlcjogeyAuLi5fLnBpY2socmVjb3JkLCB1bmlxdWVLZXlzKSB9LCB1cGRhdGU6IHsgJHNldE9uSW5zZXJ0OiByZWNvcmQgfSwgdXBzZXJ0OiB0cnVlIH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmJ1bGtXcml0ZShvcHMsIHsgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiB0cnVlLCBvcmRlcmVkOiBmYWxzZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG11bHRpcGxlIGRvY3VtZW50cy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNYW55Xyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC51cGRhdGVNYW55KGNvbmRpdGlvbiwgeyAkc2V0OiBkYXRhIH0sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHtcbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJHByb2plY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnByb2plY3Rpb24gPSBjb25kaXRpb24uJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJG9yZGVyQnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNvcnQgPSBjb25kaXRpb24uJG9yZGVyQnk7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uJG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9IGNvbmRpdGlvbi4kb2Zmc2V0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMubGltaXQgPSBjb25kaXRpb24uJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLiRxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeSA9IGNvbmRpdGlvbi4kcXVlcnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbiAmJiBjb25kaXRpb24uJHRvdGFsQ291bnQpIHtcbiAgICAgICAgICAgICAgICBsZXQgdG90YWxDb3VudCA9IGF3YWl0IGNvbGwuZmluZChxdWVyeSkuY291bnQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWyByZXN1bHQsIHRvdGFsQ291bnQgXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgb25Db2xsZWN0aW9uXyhtb2RlbCwgZXhlY3V0b3IpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4gZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29kYkNvbm5lY3RvcjsiXX0=