"use strict";

require("source-map-support/register");

const {
  _,
  waitUntil_
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const {
  MongoClient,
  GridFSBucket
} = mongodb;

const Connector = require('../../Connector');

const UpdateOpsField = ['$currentDate', '$inc', '$min', '$max', '$mul', '$rename', '$set', '$setOnInsert', '$unset'];
const UpdateOpsArray = ['$addToSet', '$pop', '$pull', '$push', '$pullAll'];
const UpdateOps = UpdateOpsField.concat(UpdateOpsArray);

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.findAll_ = this.find_;
  }

  async end_() {
    if (this.client && this.client.isConnected()) {
      await this.client.close();
    }

    delete this.client;
  }

  async connect_() {
    if (!this.client || !this.client.isConnected()) {
      let client = new MongoClient(this.connectionString, {
        useNewUrlParser: true
      });
      this.client = await client.connect();
    }

    return this.client.db(this.database);
  }

  async execute_(dbExecutor) {
    let db;

    try {
      db = await this.connect_();
      return await dbExecutor(db);
    } catch (err) {
      throw err;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async disconnect_(conn) {}

  async ping_() {
    return this.execute_(db => {
      return db.listCollections(null, {
        nameOnly: true
      }).toArray();
    });
  }

  async createGridFSBucket_(options) {
    let db = await this.connect_();
    return new GridFSBucket(db, options);
  }

  async insertOne_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertOne(data, {
      bypassDocumentValidation: true,
      ...options
    }));
  }

  async insertMany_(model, data, options) {
    return this.onCollection_(model, coll => coll.insertMany(data, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async findOneAndReplace_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndReplace(condition, data, options));
  }

  async findOneAndUpdate_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndUpdate(condition, this._translateUpdate(data), options));
  }

  async findOneAndDelete_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOneAndDelete(condition, options));
  }

  async findOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.findOne(condition, options));
  }

  async updateOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateOne(condition, this._translateUpdate(data), options));
  }

  async upsertOne_(model, data, condition, options, retry) {
    return this.onCollection_(model, async coll => {
      let current,
          locked = false;

      try {
        do {
          current = await coll.findOneAndUpdate(condition, {
            $set: {
              __lock__: true
            }
          });
        } while (current.value && current.value.__lock__);

        if (current.value) {
          locked = true;
          return await coll.updateOne({
            _id: current.value._id
          }, {
            $set: _.omit(data, ['_id']),
            $unset: {
              __lock__: ""
            }
          }, {
            bypassDocumentValidation: true,
            ...options
          });
        }

        try {
          return await coll.insertOne(data, {
            bypassDocumentValidation: true,
            ...options
          });
        } catch (error2) {
          if (!retry && error2.message.startsWith('E11000 duplicate key error')) {
            return this.upsertOne_(model, data, condition, options, true);
          }

          throw error2;
        }
      } catch (error) {
        if (locked) {
          await coll.updateOne({
            _id: current.value._id
          }, {
            $unset: {
              __lock__: ""
            }
          });
        }

        throw error;
      }
    });
  }

  async upsertMany_(model, data, uniqueKeys, options) {
    let ops = data.map(record => {
      let {
        _id,
        ...updateData
      } = record;
      let updateOp = {
        $set: updateData
      };

      if (_id) {
        updateOp.$setOnInsert = {
          _id
        };
      }

      return {
        updateOne: {
          filter: { ..._.pick(record, uniqueKeys)
          },
          update: updateOp,
          upsert: true
        }
      };
    });
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async insertManyIfNotExist_(model, data, uniqueKeys, options) {
    let ops = data.map(record => ({
      updateOne: {
        filter: { ..._.pick(record, uniqueKeys)
        },
        update: {
          $setOnInsert: record
        },
        upsert: true
      }
    }));
    return this.onCollection_(model, coll => coll.bulkWrite(ops, {
      bypassDocumentValidation: true,
      ordered: false,
      ...options
    }));
  }

  async updateMany_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.updateMany(condition, this._translateUpdate(data), options));
  }

  async replaceOne_(model, data, condition, options) {
    return this.onCollection_(model, coll => coll.replaceOne(condition, data, options));
  }

  async deleteOne_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteOne(condition, options));
  }

  async deleteMany_(model, condition, options) {
    return this.onCollection_(model, coll => coll.deleteMany(condition, options));
  }

  async find_(model, condition, options) {
    return this.onCollection_(model, async coll => {
      let queryOptions = { ...options
      };
      let query = {};

      if (condition) {
        let {
          $projection,
          $orderBy,
          $offset,
          $limit,
          $query,
          ...others
        } = condition;

        if ($projection) {
          queryOptions.projection = $projection;
        }

        if ($orderBy) {
          queryOptions.sort = $orderBy;
        }

        if ($offset) {
          queryOptions.skip = $offset;
        }

        if ($limit) {
          queryOptions.limit = $limit;
        }

        Object.assign(query, _.pickBy(others, (v, k) => k[0] !== '$'));

        if ($query) {
          Object.assign(query, $query);
        }
      }

      let result = await coll.find(query, queryOptions).toArray();

      if (condition && condition.$totalCount) {
        let totalCount = await coll.find(query).count();
        return [result, totalCount];
      }

      return result;
    });
  }

  async onCollection_(model, executor) {
    return this.execute_(db => executor(db.collection(model)));
  }

  _translateUpdate(update) {
    let ops = _.pick(update, UpdateOps);

    let others = _.omit(update, UpdateOps);

    if (ops.$set) {
      ops.$set = { ...ops.$set,
        ...others
      };
    } else if (!_.isEmpty(others)) {
      ops.$set = others;
    }

    return ops;
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsIndhaXRVbnRpbF8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIm1vbmdvZGIiLCJNb25nb0NsaWVudCIsIkdyaWRGU0J1Y2tldCIsIkNvbm5lY3RvciIsIlVwZGF0ZU9wc0ZpZWxkIiwiVXBkYXRlT3BzQXJyYXkiLCJVcGRhdGVPcHMiLCJjb25jYXQiLCJNb25nb2RiQ29ubmVjdG9yIiwiY29uc3RydWN0b3IiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImZpbmRBbGxfIiwiZmluZF8iLCJlbmRfIiwiY2xpZW50IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwidXNlTmV3VXJsUGFyc2VyIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJleGVjdXRlXyIsImRiRXhlY3V0b3IiLCJlcnIiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImNyZWF0ZUdyaWRGU0J1Y2tldF8iLCJpbnNlcnRPbmVfIiwibW9kZWwiLCJkYXRhIiwib25Db2xsZWN0aW9uXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJieXBhc3NEb2N1bWVudFZhbGlkYXRpb24iLCJpbnNlcnRNYW55XyIsImluc2VydE1hbnkiLCJvcmRlcmVkIiwiZmluZE9uZUFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZE9uZUFuZFJlcGxhY2UiLCJmaW5kT25lQW5kVXBkYXRlXyIsImZpbmRPbmVBbmRVcGRhdGUiLCJfdHJhbnNsYXRlVXBkYXRlIiwiZmluZE9uZUFuZERlbGV0ZV8iLCJmaW5kT25lQW5kRGVsZXRlIiwiZmluZE9uZV8iLCJmaW5kT25lIiwidXBkYXRlT25lXyIsInVwZGF0ZU9uZSIsInVwc2VydE9uZV8iLCJyZXRyeSIsImN1cnJlbnQiLCJsb2NrZWQiLCIkc2V0IiwiX19sb2NrX18iLCJ2YWx1ZSIsIl9pZCIsIm9taXQiLCIkdW5zZXQiLCJlcnJvcjIiLCJtZXNzYWdlIiwic3RhcnRzV2l0aCIsImVycm9yIiwidXBzZXJ0TWFueV8iLCJ1bmlxdWVLZXlzIiwib3BzIiwibWFwIiwicmVjb3JkIiwidXBkYXRlRGF0YSIsInVwZGF0ZU9wIiwiJHNldE9uSW5zZXJ0IiwiZmlsdGVyIiwicGljayIsInVwZGF0ZSIsInVwc2VydCIsImJ1bGtXcml0ZSIsImluc2VydE1hbnlJZk5vdEV4aXN0XyIsInVwZGF0ZU1hbnlfIiwidXBkYXRlTWFueSIsInJlcGxhY2VPbmVfIiwicmVwbGFjZU9uZSIsImRlbGV0ZU9uZV8iLCJkZWxldGVPbmUiLCJkZWxldGVNYW55XyIsImRlbGV0ZU1hbnkiLCJxdWVyeU9wdGlvbnMiLCJxdWVyeSIsIiRwcm9qZWN0aW9uIiwiJG9yZGVyQnkiLCIkb2Zmc2V0IiwiJGxpbWl0IiwiJHF1ZXJ5Iiwib3RoZXJzIiwicHJvamVjdGlvbiIsInNvcnQiLCJza2lwIiwibGltaXQiLCJPYmplY3QiLCJhc3NpZ24iLCJwaWNrQnkiLCJ2IiwiayIsInJlc3VsdCIsImZpbmQiLCIkdG90YWxDb3VudCIsInRvdGFsQ291bnQiLCJjb3VudCIsImV4ZWN1dG9yIiwiY29sbGVjdGlvbiIsImlzRW1wdHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBb0JDLE9BQU8sQ0FBQyxVQUFELENBQWpDOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFpQkQsT0FBTyxDQUFDLGdDQUFELENBQTlCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0QsVUFBVSxDQUFDLFNBQUQsQ0FBMUI7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLFdBQUY7QUFBZUMsRUFBQUE7QUFBZixJQUFnQ0YsT0FBdEM7O0FBQ0EsTUFBTUcsU0FBUyxHQUFHTCxPQUFPLENBQUMsaUJBQUQsQ0FBekI7O0FBRUEs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RU8sSUFBSSxDQUFDdEcsQ0FBQyxDQUFDdUgsT0FBRixDQUFVakIsTUFBVixDQUFMLEVBQXdCO0FBQzNCM0IsTUFBQUEsR0FBRyxDQUFDWixJQUFKLEdBQVd1QyxNQUFYO0FBQ0g7O0FBRUQsV0FBTzNCLEdBQVA7QUFDSDs7QUF6VW9DOztBQTRVekM2QyxNQUFNLENBQUNDLE9BQVAsR0FBaUI3RyxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIHdhaXRVbnRpbF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IHRyeVJlcXVpcmUgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcC9saWIvdXRpbHMvSGVscGVycycpO1xuY29uc3QgbW9uZ29kYiA9IHRyeVJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHsgTW9uZ29DbGllbnQsIEdyaWRGU0J1Y2tldCB9ID0gbW9uZ29kYjtcbmNvbnN0IENvbm5lY3RvciA9IHJlcXVpcmUoJy4uLy4uL0Nvbm5lY3RvcicpO1xuXG5jb25zdCBVcGRhdGVPcHNGaWVsZCA9IFsgJyRjdXJyZW50RGF0ZScsICckaW5jJywgJyRtaW4nLCAnJG1heCcsICckbXVsJywgJyRyZW5hbWUnLCAnJHNldCcsICckc2V0T25JbnNlcnQnLCAnJHVuc2V0JyBdO1xuY29uc3QgVXBkYXRlT3BzQXJyYXkgPSBbICckYWRkVG9TZXQnLCAnJHBvcCcsICckcHVsbCcsICckcHVzaCcsICckcHVsbEFsbCcgXTtcbmNvbnN0IFVwZGF0ZU9wcyA9IFVwZGF0ZU9wc0ZpZWxkLmNvbmNhdChVcGRhdGVPcHNBcnJheSk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7ICAgICAgICAgXG4gICAgfVxuXG4gICAgZmluZEFsbF8gPSB0aGlzLmZpbmRfO1xuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY2xpZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24gYmFzZWQgb24gdGhlIGRlZmF1bHQgY29ubmVjdGlvbiBzdHJpbmcgb2YgdGhlIGNvbm5lY3RvciBhbmQgZ2l2ZW4gb3B0aW9ucy4gICAgIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBFeHRyYSBvcHRpb25zIGZvciB0aGUgY29ubmVjdGlvbiwgb3B0aW9uYWwuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5tdWx0aXBsZVN0YXRlbWVudHM9ZmFsc2VdIC0gQWxsb3cgcnVubmluZyBtdWx0aXBsZSBzdGF0ZW1lbnRzIGF0IGEgdGltZS5cbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IFtvcHRpb25zLmNyZWF0ZURhdGFiYXNlPWZhbHNlXSAtIEZsYWcgdG8gdXNlZCB3aGVuIGNyZWF0aW5nIGEgZGF0YWJhc2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPERiPn1cbiAgICAgKi9cbiAgICBhc3luYyBjb25uZWN0XygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCB8fCAhdGhpcy5jbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBNb25nb0NsaWVudCh0aGlzLmNvbm5lY3Rpb25TdHJpbmcsIHt1c2VOZXdVcmxQYXJzZXI6IHRydWV9KTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gYXdhaXQgY2xpZW50LmNvbm5lY3QoKTtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oZGJFeGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRiRXhlY3V0b3IoZGIpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5kaXNjb25uZWN0XyhkYik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtEYn0gY29ubiAtIE15U1FMIGNvbm5lY3Rpb24uXG4gICAgICovXG4gICAgYXN5bmMgZGlzY29ubmVjdF8oY29ubikge1xuICAgIH1cbiAgXG4gICAgYXN5bmMgcGluZ18oKSB7ICBcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZV8oZGIgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgfSk7ICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgc2V0dGluZ3MuXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmJ1Y2tldE5hbWU9J2ZzJ10gLSBUaGUgJ2ZpbGVzJyBhbmQgJ2NodW5rcycgY29sbGVjdGlvbnMgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIHRoZSBidWNrZXQgbmFtZSBmb2xsb3dlZCBieSBhIGRvdC5cbiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gW29wdGlvbnMuY2h1bmtTaXplQnl0ZXNdIC0gTnVtYmVyIG9mIGJ5dGVzIHN0b3JlZCBpbiBlYWNoIGNodW5rLiBEZWZhdWx0cyB0byAyNTVLQlxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy53cml0ZUNvbmNlcm5dXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLnJlYWRQcmVmZXJlbmNlXVxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZUdyaWRGU0J1Y2tldF8ob3B0aW9ucykge1xuICAgICAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmNvbm5lY3RfKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBHcmlkRlNCdWNrZXQoZGIsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBpbnNlcnRPbmVfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuIGFycmF5IG9mIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlfKG1vZGVsLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmluc2VydE1hbnkoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIChpbnNlcnQgb3IgdXBkYXRlIGZvciBleHNpc3RpbmcpIGFuIGVudGl0eSBhbmQgcmV0dXJuIG9yaWdpbmFsIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmRPbmVBbmRSZXBsYWNlXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBkb2N1bWVudCBhbmQgdXBkYXRlIGl0IGluIG9uZSBhdG9taWMgb3BlcmF0aW9uLiBSZXF1aXJlcyBhIHdyaXRlIGxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgb3BlcmF0aW9uLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZE9uZUFuZFVwZGF0ZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmRVcGRhdGUoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lQW5kRGVsZXRlXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLmZpbmRPbmVBbmREZWxldGUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZmluZE9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5maW5kT25lKGNvbmRpdGlvbiwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHRoaXMuX3RyYW5zbGF0ZVVwZGF0ZShkYXRhKSwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhbiBleGlzdGluZyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gY29uZGl0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyB1cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIHJldHJ5KSB7IFxuICAgICAgICAvL3dhbGsgYXJvdW5kIG1vbmdvZGIgZmFpbGVkIHRvIHNldE9uSW5zZXJ0IHdpdGggX2lkXG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgYXN5bmMgKGNvbGwpID0+IHtcblxuICAgICAgICAgICAgbGV0IGN1cnJlbnQsIGxvY2tlZCA9IGZhbHNlO1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGRvIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGF3YWl0IGNvbGwuZmluZE9uZUFuZFVwZGF0ZShjb25kaXRpb24sIHsgJHNldDogeyBfX2xvY2tfXzogdHJ1ZSB9IH0pO1xuICAgICAgICAgICAgICAgIH0gd2hpbGUgKGN1cnJlbnQudmFsdWUgJiYgY3VycmVudC52YWx1ZS5fX2xvY2tfXyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudC52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBsb2NrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGwudXBkYXRlT25lKHsgX2lkOiBjdXJyZW50LnZhbHVlLl9pZCB9LCB7ICRzZXQ6IF8ub21pdChkYXRhLCBbICdfaWQnIF0pLCAkdW5zZXQ6IHsgX19sb2NrX186IFwiXCIgfSB9LCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgLi4ub3B0aW9ucyB9KTsgICAgXG4gICAgICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgICAgIHRyeSB7IFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbC5pbnNlcnRPbmUoZGF0YSwgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIC4uLm9wdGlvbnMgfSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXRyeSAmJiBlcnJvcjIubWVzc2FnZS5zdGFydHNXaXRoKCdFMTEwMDAgZHVwbGljYXRlIGtleSBlcnJvcicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cHNlcnRPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobG9ja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGwudXBkYXRlT25lKHsgX2lkOiBjdXJyZW50LnZhbHVlLl9pZCB9LCB7ICR1bnNldDogeyBfX2xvY2tfXzogXCJcIiB9IH0pOyAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbWFueSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBBcnJheSBvZiByZWNvcmQgd2l0aCBfaWRcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBzZXJ0TWFueV8obW9kZWwsIGRhdGEsIHVuaXF1ZUtleXMsIG9wdGlvbnMpIHsgXG4gICAgICAgIGxldCBvcHMgPSBkYXRhLm1hcChyZWNvcmQgPT4ge1xuICAgICAgICAgICAgbGV0IHsgX2lkLCAuLi51cGRhdGVEYXRhIH0gPSByZWNvcmQ7XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVPcCA9IHtcbiAgICAgICAgICAgICAgICAkc2V0OiB1cGRhdGVEYXRhXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoX2lkKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlT3AuJHNldE9uSW5zZXJ0ID0geyBfaWQgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogdXBkYXRlT3AsIHVwc2VydDogdHJ1ZSB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5idWxrV3JpdGUob3BzLCB7IGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSwgb3JkZXJlZDogZmFsc2UsIC4uLm9wdGlvbnMgfSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluc2VydCBtYW55IGVudGl0aWVzIGlmIG5vdCBleGlzdC5cbiAgICAgKiBAcGFyYW0geyp9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IHVuaXF1ZUtleXMgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGluc2VydE1hbnlJZk5vdEV4aXN0Xyhtb2RlbCwgZGF0YSwgdW5pcXVlS2V5cywgb3B0aW9ucykge1xuICAgICAgICBsZXQgb3BzID0gZGF0YS5tYXAocmVjb3JkID0+ICh7XG4gICAgICAgICAgICB1cGRhdGVPbmU6IHsgZmlsdGVyOiB7IC4uLl8ucGljayhyZWNvcmQsIHVuaXF1ZUtleXMpIH0sIHVwZGF0ZTogeyAkc2V0T25JbnNlcnQ6IHJlY29yZCB9LCB1cHNlcnQ6IHRydWUgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuYnVsa1dyaXRlKG9wcywgeyBieXBhc3NEb2N1bWVudFZhbGlkYXRpb246IHRydWUsIG9yZGVyZWQ6IGZhbHNlLCAuLi5vcHRpb25zIH0pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgbXVsdGlwbGUgZG9jdW1lbnRzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZU1hbnlfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU1hbnkoY29uZGl0aW9uLCB0aGlzLl90cmFuc2xhdGVVcGRhdGUoZGF0YSksIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXBsYWNlIGFuIGV4aXN0aW5nIGVudGl0eSBvciBjcmVhdGUgYSBuZXcgb25lLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgcmVwbGFjZU9uZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykgeyAgXG4gICAgICAgIHJldHVybiB0aGlzLm9uQ29sbGVjdGlvbl8obW9kZWwsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCAoY29sbCkgPT4gY29sbC5kZWxldGVPbmUoY29uZGl0aW9uLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU1hbnlfKG1vZGVsLCBjb25kaXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25Db2xsZWN0aW9uXyhtb2RlbCwgKGNvbGwpID0+IGNvbGwuZGVsZXRlTWFueShjb25kaXRpb24sIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5vbkNvbGxlY3Rpb25fKG1vZGVsLCBhc3luYyBjb2xsID0+IHtcbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7Li4ub3B0aW9uc307XG4gICAgICAgICAgICBsZXQgcXVlcnkgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICAgICAgICAgIGxldCB7ICRwcm9qZWN0aW9uLCAkb3JkZXJCeSwgJG9mZnNldCwgJGxpbWl0LCAkcXVlcnksIC4uLm90aGVycyB9ID0gY29uZGl0aW9uO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRwcm9qZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gJHByb2plY3Rpb247ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkb3JkZXJCeSkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc29ydCA9ICRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoJG9mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMuc2tpcCA9ICRvZmZzZXQ7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgkbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gJGxpbWl0OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCBfLnBpY2tCeShvdGhlcnMsICh2LGspID0+IGtbMF0gIT09ICckJykpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCRxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHF1ZXJ5LCAkcXVlcnkpO1xuICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb2xsLmZpbmQocXVlcnksIHF1ZXJ5T3B0aW9ucykudG9BcnJheSgpO1xuXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uICYmIGNvbmRpdGlvbi4kdG90YWxDb3VudCkge1xuICAgICAgICAgICAgICAgIGxldCB0b3RhbENvdW50ID0gYXdhaXQgY29sbC5maW5kKHF1ZXJ5KS5jb3VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbIHJlc3VsdCwgdG90YWxDb3VudCBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcbiAgICB9ICAgXG5cbiAgICBhc3luYyBvbkNvbGxlY3Rpb25fKG1vZGVsLCBleGVjdXRvcikge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRlXyhkYiA9PiBleGVjdXRvcihkYi5jb2xsZWN0aW9uKG1vZGVsKSkpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVVcGRhdGUodXBkYXRlKSB7XG4gICAgICAgIGxldCBvcHMgPSBfLnBpY2sodXBkYXRlLCBVcGRhdGVPcHMpO1xuICAgICAgICBsZXQgb3RoZXJzID0gXy5vbWl0KHVwZGF0ZSwgVXBkYXRlT3BzKTtcblxuICAgICAgICBpZiAob3BzLiRzZXQpIHtcbiAgICAgICAgICAgIG9wcy4kc2V0ID0geyAuLi5vcHMuJHNldCwgLi4ub3RoZXJzIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIV8uaXNFbXB0eShvdGhlcnMpKSB7XG4gICAgICAgICAgICBvcHMuJHNldCA9IG90aGVycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19