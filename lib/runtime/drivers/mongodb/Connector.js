"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('@k-suite/app/lib/utils/Helpers');

const mongodb = tryRequire('mongodb');
const MongoClient = mongodb.MongoClient;

const Connector = require('../../Connector');

class MongodbConnector extends Connector {
  constructor(connectionString, options) {
    super('mongodb', connectionString, options);
    this.client = new MongoClient(this.connectionString, {
      useNewUrlParser: true
    });
  }

  async end_() {
    if (this.client.isConnected()) {
      this.client.close();
    }

    delete this.client;
  }

  async connect_(options) {
    await this.client.connect();
    return this.client.db(this.database);
  }

  async disconnect_(conn) {
    this.client.close();
  }

  async ping_() {
    let db;

    try {
      db = await this.connect_();
      await db.listCollections(null, {
        nameOnly: true
      }).toArray();
      return true;
    } catch (err) {
      this.log('error', err.stack);
      return false;
    } finally {
      db && (await this.disconnect_(db));
    }
  }

  async insertOne_(model, data, options) {
    return this._execute_(model, options, coll => coll.insertOne(data, {
      forceServerObjectId: true,
      bypassDocumentValidation: true
    }));
  }

  async findAndReplace_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.findAndReplace(condition, data, {
      upsert: true,
      returnOriginal: true
    }));
  }

  async findOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.findOne(condition));
  }

  async updateOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.updateOne(condition, {
      $set: data
    }));
  }

  async replaceOne_(model, data, condition, options) {
    return this._execute_(model, options, coll => coll.replaceOne(condition, data));
  }

  async deleteOne_(model, condition, options) {
    return this._execute_(model, options, coll => coll.deleteOne(condition));
  }

  async find_(model, condition, options) {
    let db;

    try {
      db = await this._getConnection_(options);
      let queryOptions = {};

      if (!_.isEmpty(condition.$projection)) {
        queryOptions.projection = condition.$projection;
      }

      if (!_.isEmpty(condition.$orderBy)) {
        queryOptions.sort = condition.$orderBy;
      }

      if (!_.isEmpty(condition.$offset)) {
        queryOptions.skip = condition.$offset;
      }

      if (!_.isEmpty(condition.$limit)) {
        queryOptions.limit = condition.$limit;
      }

      let query = condition.$query || {};
      console.log('query', query);
      console.log('queryOptions', queryOptions);
      return await db.collection(model).find(query, queryOptions).toArray();
    } catch (err) {
      this.log('error', err.message, {
        stack: err.stack
      });
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _execute_(model, options, executor) {
    let db;

    try {
      db = await this._getConnection_(options);
      return await executor(db.collection(model));
    } catch (err) {
      throw err;
    } finally {
      db && (await this._releaseConnection_(db, options));
    }
  }

  async _getConnection_(options) {
    return options && options.connection ? options.connection : this.connect_(options);
  }

  async _releaseConnection_(conn, options) {
    if (!options || !options.connection) {
      return this.disconnect_(conn);
    }
  }

}

module.exports = MongodbConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ydW50aW1lL2RyaXZlcnMvbW9uZ29kYi9Db25uZWN0b3IuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJ0cnlSZXF1aXJlIiwibW9uZ29kYiIsIk1vbmdvQ2xpZW50IiwiQ29ubmVjdG9yIiwiTW9uZ29kYkNvbm5lY3RvciIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvblN0cmluZyIsIm9wdGlvbnMiLCJjbGllbnQiLCJ1c2VOZXdVcmxQYXJzZXIiLCJlbmRfIiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsImNvbm5lY3RfIiwiY29ubmVjdCIsImRiIiwiZGF0YWJhc2UiLCJkaXNjb25uZWN0XyIsImNvbm4iLCJwaW5nXyIsImxpc3RDb2xsZWN0aW9ucyIsIm5hbWVPbmx5IiwidG9BcnJheSIsImVyciIsImxvZyIsInN0YWNrIiwiaW5zZXJ0T25lXyIsIm1vZGVsIiwiZGF0YSIsIl9leGVjdXRlXyIsImNvbGwiLCJpbnNlcnRPbmUiLCJmb3JjZVNlcnZlck9iamVjdElkIiwiYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uIiwiZmluZEFuZFJlcGxhY2VfIiwiY29uZGl0aW9uIiwiZmluZEFuZFJlcGxhY2UiLCJ1cHNlcnQiLCJyZXR1cm5PcmlnaW5hbCIsImZpbmRPbmVfIiwiZmluZE9uZSIsInVwZGF0ZU9uZV8iLCJ1cGRhdGVPbmUiLCIkc2V0IiwicmVwbGFjZU9uZV8iLCJyZXBsYWNlT25lIiwiZGVsZXRlT25lXyIsImRlbGV0ZU9uZSIsImZpbmRfIiwiX2dldENvbm5lY3Rpb25fIiwicXVlcnlPcHRpb25zIiwiaXNFbXB0eSIsIiRwcm9qZWN0aW9uIiwicHJvamVjdGlvbiIsIiRvcmRlckJ5Iiwic29ydCIsIiRvZmZzZXQiLCJza2lwIiwiJGxpbWl0IiwibGltaXQiLCJxdWVyeSIsIiRxdWVyeSIsImNvbnNvbGUiLCJjb2xsZWN0aW9uIiwiZmluZCIsIm1lc3NhZ2UiLCJfcmVsZWFzZUNvbm5lY3Rpb25fIiwiZXhlY3V0b3Ii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KTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwL2xpYi91dGlscy9IZWxwZXJzJyk7XG5jb25zdCBtb25nb2RiID0gdHJ5UmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgTW9uZ29DbGllbnQgPSBtb25nb2RiLk1vbmdvQ2xpZW50O1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vLi4vQ29ubmVjdG9yJyk7XG5cbi8qKlxuICogTW9uZ29kYiBkYXRhIHN0b3JhZ2UgY29ubmVjdG9yLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBDb25uZWN0b3JcbiAqL1xuY2xhc3MgTW9uZ29kYkNvbm5lY3RvciBleHRlbmRzIENvbm5lY3RvciB7XG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29wdGlvbnMudXNlUHJlcGFyZWRTdGF0ZW1lbnRdIC0gXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29ubmVjdGlvblN0cmluZywgb3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIHN1cGVyKCdtb25nb2RiJywgY29ubmVjdGlvblN0cmluZywgb3B0aW9ucyk7IFxuICAgICAgICBcbiAgICAgICAgdGhpcy5jbGllbnQgPSBuZXcgTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nLCB7dXNlTmV3VXJsUGFyc2VyOiB0cnVlfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgYWxsIGNvbm5lY3Rpb24gaW5pdGlhdGVkIGJ5IHRoaXMgY29ubmVjdG9yLlxuICAgICAqL1xuICAgIGFzeW5jIGVuZF8oKSB7XG4gICAgICAgIGlmICh0aGlzLmNsaWVudC5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNsaWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhYmFzZSBjb25uZWN0aW9uIGJhc2VkIG9uIHRoZSBkZWZhdWx0IGNvbm5lY3Rpb24gc3RyaW5nIG9mIHRoZSBjb25uZWN0b3IgYW5kIGdpdmVuIG9wdGlvbnMuICAgICBcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIC0gRXh0cmEgb3B0aW9ucyBmb3IgdGhlIGNvbm5lY3Rpb24sIG9wdGlvbmFsLlxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW29wdGlvbnMubXVsdGlwbGVTdGF0ZW1lbnRzPWZhbHNlXSAtIEFsbG93IHJ1bm5pbmcgbXVsdGlwbGUgc3RhdGVtZW50cyBhdCBhIHRpbWUuXG4gICAgICogQHByb3BlcnR5IHtib29sfSBbb3B0aW9ucy5jcmVhdGVEYXRhYmFzZT1mYWxzZV0gLSBGbGFnIHRvIHVzZWQgd2hlbiBjcmVhdGluZyBhIGRhdGFiYXNlLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxNeVNRTENvbm5lY3Rpb24+fVxuICAgICAqL1xuICAgIGFzeW5jIGNvbm5lY3RfKG9wdGlvbnMpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY29ubmVjdCgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhIGRhdGFiYXNlIGNvbm5lY3Rpb24uXG4gICAgICogQHBhcmFtIHtNeVNRTENvbm5lY3Rpb259IGNvbm4gLSBNeVNRTCBjb25uZWN0aW9uLlxuICAgICAqL1xuICAgIGFzeW5jIGRpc2Nvbm5lY3RfKGNvbm4pIHsgICAgICAgIFxuICAgICAgICB0aGlzLmNsaWVudC5jbG9zZSgpOyAgICAgICAgXG4gICAgfVxuICBcbiAgICBhc3luYyBwaW5nXygpIHsgIFxuICAgICAgICBsZXQgZGI7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gIGF3YWl0IHRoaXMuY29ubmVjdF8oKTtcbiAgICAgICAgICAgIGF3YWl0IGRiLmxpc3RDb2xsZWN0aW9ucyhudWxsLCB7IG5hbWVPbmx5OiB0cnVlIH0pLnRvQXJyYXkoKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyci5zdGFjayk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLmRpc2Nvbm5lY3RfKGRiKTtcbiAgICAgICAgfSAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBuZXcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgaW5zZXJ0T25lXyhtb2RlbCwgZGF0YSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLmluc2VydE9uZShkYXRhLCB7IGZvcmNlU2VydmVyT2JqZWN0SWQ6IHRydWUsIGJ5cGFzc0RvY3VtZW50VmFsaWRhdGlvbjogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSAoaW5zZXJ0IG9yIHVwZGF0ZSBmb3IgZXhzaXN0aW5nKSBhbiBlbnRpdHkgYW5kIHJldHVybiBvcmlnaW5hbCByZWNvcmQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZGVsIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIFxuICAgICAqIEBwYXJhbSB7Kn0gb3B0aW9ucyBcbiAgICAgKi9cbiAgICBhc3luYyBmaW5kQW5kUmVwbGFjZV8obW9kZWwsIGRhdGEsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLmZpbmRBbmRSZXBsYWNlKGNvbmRpdGlvbiwgZGF0YSwgeyB1cHNlcnQ6IHRydWUsIHJldHVybk9yaWdpbmFsOiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kT25lXyhtb2RlbCwgY29uZGl0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlXyhtb2RlbCwgb3B0aW9ucywgKGNvbGwpID0+IGNvbGwuZmluZE9uZShjb25kaXRpb24pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgYW4gZXhpc3RpbmcgZW50aXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgdXBkYXRlT25lXyhtb2RlbCwgZGF0YSwgY29uZGl0aW9uLCBvcHRpb25zKSB7IFxuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLnVwZGF0ZU9uZShjb25kaXRpb24sIHsgJHNldDogZGF0YSB9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVwbGFjZSBhbiBleGlzdGluZyBlbnRpdHkgb3IgY3JlYXRlIGEgbmV3IG9uZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIHJlcGxhY2VPbmVfKG1vZGVsLCBkYXRhLCBjb25kaXRpb24sIG9wdGlvbnMpIHsgIFxuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLnJlcGxhY2VPbmUoY29uZGl0aW9uLCBkYXRhKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIGFuIGV4aXN0aW5nIGVudGl0eS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kZWwgXG4gICAgICogQHBhcmFtIHsqfSBjb25kaXRpb24gXG4gICAgICogQHBhcmFtIHsqfSBvcHRpb25zIFxuICAgICAqL1xuICAgIGFzeW5jIGRlbGV0ZU9uZV8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZV8obW9kZWwsIG9wdGlvbnMsIChjb2xsKSA9PiBjb2xsLmRlbGV0ZU9uZShjb25kaXRpb24pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHNlbGVjdCBvcGVyYXRpb24uXG4gICAgICogQHBhcmFtIHsqfSBtb2RlbCBcbiAgICAgKiBAcGFyYW0geyp9IGNvbmRpdGlvbiBcbiAgICAgKiBAcGFyYW0geyp9IG9wdGlvbnMgXG4gICAgICovXG4gICAgYXN5bmMgZmluZF8obW9kZWwsIGNvbmRpdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBsZXQgZGI7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRiID0gYXdhaXQgdGhpcy5fZ2V0Q29ubmVjdGlvbl8ob3B0aW9ucyk7XG5cbiAgICAgICAgICAgIGxldCBxdWVyeU9wdGlvbnMgPSB7fTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uLiRwcm9qZWN0aW9uKSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wcm9qZWN0aW9uID0gY29uZGl0aW9uLiRwcm9qZWN0aW9uOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uLiRvcmRlckJ5KSkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5zb3J0ID0gY29uZGl0aW9uLiRvcmRlckJ5OyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoY29uZGl0aW9uLiRvZmZzZXQpKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNraXAgPSBjb25kaXRpb24uJG9mZnNldDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGNvbmRpdGlvbi4kbGltaXQpKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLmxpbWl0ID0gY29uZGl0aW9uLiRsaW1pdDsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBxdWVyeSA9IGNvbmRpdGlvbi4kcXVlcnkgfHwge307XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdxdWVyeScsIHF1ZXJ5KTtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coJ3F1ZXJ5T3B0aW9ucycsIHF1ZXJ5T3B0aW9ucyk7XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBkYi5jb2xsZWN0aW9uKG1vZGVsKS5maW5kKHF1ZXJ5LCBxdWVyeU9wdGlvbnMpLnRvQXJyYXkoKTtcbiAgICAgICAgfSBjYXRjaChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyci5tZXNzYWdlLCB7IHN0YWNrOiBlcnIuc3RhY2sgfSk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBkYiAmJiBhd2FpdCB0aGlzLl9yZWxlYXNlQ29ubmVjdGlvbl8oZGIsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfSAgIFxuXG4gICAgYXN5bmMgX2V4ZWN1dGVfKG1vZGVsLCBvcHRpb25zLCBleGVjdXRvcikge1xuICAgICAgICBsZXQgZGI7XG4gICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYiA9IGF3YWl0IHRoaXMuX2dldENvbm5lY3Rpb25fKG9wdGlvbnMpO1xuXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZXhlY3V0b3IoZGIuY29sbGVjdGlvbihtb2RlbCkpO1xuICAgICAgICB9IGNhdGNoKGVycikgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgZGIgJiYgYXdhaXQgdGhpcy5fcmVsZWFzZUNvbm5lY3Rpb25fKGRiLCBvcHRpb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9nZXRDb25uZWN0aW9uXyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbm5lY3Rpb24pID8gb3B0aW9ucy5jb25uZWN0aW9uIDogdGhpcy5jb25uZWN0XyhvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBfcmVsZWFzZUNvbm5lY3Rpb25fKGNvbm4sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRpc2Nvbm5lY3RfKGNvbm4pO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vbmdvZGJDb25uZWN0b3I7Il19