"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire && typeof opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && 'nonInquireFilter' in opts) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }
    });
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  get oolongConfig() {
    if (this._oolongConfig) return this._oolongConfig;
    let configFile = this.option('config');

    if (!configFile) {
      throw new Error('Oolong config file is required.');
    }

    return this._oolongConfig = fs.readJsonSync(this.app.toAbsolutePath(configFile));
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource);

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        ...options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIk9vbG9uZ0NvcmUiLCJjb25zdHJ1Y3RvciIsImFwcCIsImFwaSIsImluaXRpYWxpemVfIiwidXNhZ2VPcHRpb25zIiwiY2xvbmVEZWVwIiwiY29uZmlnIiwiY29tbWFuZExpbmVPcHRpb25zIiwiZmVhdHVyZXMiLCJzaG93VXNhZ2UiLCJlcnIiLCJpbmplY3RzIiwiYWZ0ZXJCYW5uZXIiLCJtZXNzYWdlIiwiY29tbWFuZCIsImFmdGVyQ29tbWFuZExpbmUiLCJjb21tYW5kcyIsInJlZHVjZSIsInJlc3VsdCIsImRlc2MiLCJjbWQiLCJjb25zb2xlIiwibG9nIiwiZ2V0VXNhZ2UiLCJhcmd2IiwiY2FtZWxDYXNlIiwidW5kZWZpbmVkIiwiYWN0aW9uXyIsImNvbW1hbmRPcHRpb25zIiwib3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsInBhcnNlQXJndiIsIm9wdGlvbiIsImlucXVpcmVfIiwiX2ZpbGxDb21tYW5kRGVmYXVsdHMiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvb2xvbmdDb25maWciLCJmb3JFYWNoIiwiZHJpdmVyIiwiY29ubmVjdG9ycyIsImNvbm5lY3Rvck9wdGlvbnMiLCJjb25uZWN0b3JOYW1lIiwiY29ubmVjdGlvbiIsIl9vb2xvbmdDb25maWciLCJjb25maWdGaWxlIiwicmVhZEpzb25TeW5jIiwidG9BYnNvbHV0ZVBhdGgiLCJzY2hlbWFEZXBsb3ltZW50IiwibW9kZWxNYXBwaW5nIiwiZ2V0VmFsdWVCeVBhdGgiLCJpc0VtcHR5IiwibWFwVmFsdWVzIiwibWFwcGluZyIsInNjaGVtYU5hbWUiLCJkYXRhU291cmNlIiwib3RoZXJzIiwiY29ubmVjdGlvblN0cmluZyIsImdldFJldmVyc2VPdXRwdXREaXIiLCJiYXNlRGlyIiwicHJlZml4Iiwib3ZlcnJpZGUiLCJub3ciLCJEYXRlIiwiZm9sZGVyIiwiZ2V0RnVsbFllYXIiLCJnZXRNb250aCIsImdldERhdGUiLCJvdXRwdXREaXIiLCJqb2luIiwibnVtIiwiZXhpc3RzU3luYyIsImZvbGRlcjIiLCJ0b1N0cmluZyIsInZhbGlkIiwicmVxdWlyZWQiLCJlcnJvciIsImluZm8iLCJoYXNPd25Qcm9wZXJ0eSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILElBQWxCOztBQUNBLE1BQU1JLFFBQVEsR0FBR0gsT0FBTyxDQUFDLFVBQUQsQ0FBeEI7O0FBQ0EsTUFBTUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNSyxRQUFRLEdBQUdMLE9BQU8sQ0FBQyxZQUFELENBQXhCOztBQUNBLE1BQU1NLFNBQVMsR0FBR04sT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBQ0EsTUFBTTtBQUFFTyxFQUFBQSxrQkFBRjtBQUFzQkMsRUFBQUE7QUFBdEIsSUFBMkNSLE9BQU8sQ0FBQyxlQUFELENBQXhEOztBQU1BLE1B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QUFELEVBQU9ULElBQVAsS0FBZ0I7QUFDaEQsVUFBSWtFLFFBQVEsR0FBR3pELElBQUksQ0FBQ3lELFFBQXBCOztBQUVBLFVBQUksT0FBT0EsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNoQ0EsUUFBQUEsUUFBUSxHQUFHQSxRQUFRLEVBQW5CO0FBQ0g7O0FBRUQsVUFBSUEsUUFBUSxJQUFJLEVBQUVsRSxJQUFJLElBQUksS0FBS2IsSUFBZixDQUFoQixFQUFzQztBQUNsQ0gsUUFBQUEsT0FBTyxDQUFDbUYsS0FBUixDQUFlLGFBQVluRSxJQUFLLGdCQUFoQztBQUNBaUUsUUFBQUEsS0FBSyxHQUFHLEtBQVI7QUFDSDtBQUNKLEtBWEQ7O0FBYUEsV0FBT0EsS0FBUDtBQUNIOztBQUdEbkUsRUFBQUEsb0JBQW9CLENBQUNQLGNBQUQsRUFBaUI7QUFDakNyQyxJQUFBQSxDQUFDLENBQUNxRCxNQUFGLENBQVNoQixjQUFULEVBQXlCLENBQUM2RSxJQUFELEVBQU94RSxNQUFQLEtBQWtCO0FBQ3ZDLFVBQUksQ0FBQyxLQUFLVCxJQUFMLENBQVVrRixjQUFWLENBQXlCekUsTUFBekIsQ0FBRCxJQUFxQ3dFLElBQUksQ0FBQ0MsY0FBTCxDQUFvQixlQUFwQixDQUF6QyxFQUErRTtBQUMzRSxhQUFLbEYsSUFBTCxDQUFVUyxNQUFWLElBQW9Cd0UsSUFBSSxDQUFDN0MsYUFBekI7QUFDSDtBQUNKLEtBSkQ7QUFLSDs7QUF0UFk7O0FBeVBqQitDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjdHLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7IFxuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IGlucXVpcmVyID0gcmVxdWlyZSgnaW5xdWlyZXInKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBDb21tYW5kcyA9IHJlcXVpcmUoJy4vY29tbWFuZHMnKTtcbmNvbnN0IE9vbG9uZ0FwaSA9IHJlcXVpcmUoJy4uL2xhbmcvYXBpJyk7XG5jb25zdCB7IG1ha2VEYXRhU291cmNlTmFtZSwgU3VwcG9ydGVkRHJpdmVycyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuXG4vKipcbiAqIE9vbG9uZyBjb21tYW5kIGxpbmUgaGVscGVyIGNvcmUgY2xhc3MuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgT29sb25nQ29yZSB7XG4gICAgY29uc3RydWN0b3IoYXBwKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLmFwaSA9IE9vbG9uZ0FwaTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogUmVwYXJzZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzIHdpdGggY29tbWFuZCBzcGVjaWZpYyBvcHRpb25zLlxuICAgICAqL1xuICAgIGFzeW5jIGluaXRpYWxpemVfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMudXNhZ2VPcHRpb25zID0gXy5jbG9uZURlZXAodGhpcy5hcHAuY29uZmlnLmNvbW1hbmRMaW5lT3B0aW9ucyk7XG4gICAgICAgIGxldCBjb21tYW5kTGluZU9wdGlvbnMgPSB0aGlzLmFwcC5mZWF0dXJlc1snY29tbWFuZExpbmVPcHRpb25zJ107XG5cbiAgICAgICAgdGhpcy5zaG93VXNhZ2UgPSAoZXJyKSA9PiB7XG4gICAgICAgICAgICBsZXQgaW5qZWN0cyA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckJhbm5lciA9ICgpID0+IChlcnIubWVzc2FnZSB8fCBlcnIpICsgJ1xcblxcbic7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmNvbW1hbmQgJiYgdGhpcy5jb21tYW5kICE9PSAnbWFpbicpIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQ29tbWFuZExpbmUgPSAoKSA9PiBgQ29tbWFuZCBcIiR7dGhpcy5jb21tYW5kfVwiOiBgICsgQ29tbWFuZHMuY29tbWFuZHNbdGhpcy5jb21tYW5kXSArJ1xcblxcbic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJDb21tYW5kTGluZSA9ICgpID0+ICdBdmFpbGFibGUgY29tbWFuZHM6XFxuJyArIF8ucmVkdWNlKENvbW1hbmRzLmNvbW1hbmRzLCAocmVzdWx0LCBkZXNjLCBjbWQpID0+IHJlc3VsdCArIGAgICR7Y21kfTogJHtkZXNjfVxcbmAsICcnKSArICdcXG4nXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcblxuICAgICAgICAgICAgY29uc29sZS5sb2coY29tbWFuZExpbmVPcHRpb25zLmdldFVzYWdlKHRoaXMuYXBwLCB0aGlzLnVzYWdlT3B0aW9ucywgaW5qZWN0cykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9leHRyYWN0IG1vZHVsZSBhbmQgY29tbWFuZFxuICAgICAgICBsZXQgY29tbWFuZCA9IHRoaXMuYXBwLmFyZ3YuX1swXTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuY29tbWFuZCA9IF8uY2FtZWxDYXNlKGNvbW1hbmQpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgPT09ICdjb21tYW5kcycgfHwgdGhpcy5jb21tYW5kID09PSAnb3B0aW9ucycpIHtcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuYWN0aW9uXyA9IENvbW1hbmRzW3RoaXMuY29tbWFuZF07XG5cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmFjdGlvbl8gIT09ICdmdW5jdGlvbicpIHsgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDsgICBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb21tYW5kT3B0aW9ucyA9IENvbW1hbmRzLm9wdGlvbnModGhpcyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgY29tbWFuZE9wdGlvbnMpO1xuXG4gICAgICAgIC8vcmUtcGFyc2UgYXJndW1lbnRzIGFjY29yZGluZyB0byBzZXR0aW5nc1xuICAgICAgICB0aGlzLmFyZ3YgPSBjb21tYW5kTGluZU9wdGlvbnMucGFyc2VBcmd2KHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKHRoaXMuY29tbWFuZCAhPT0gJ21haW4nICYmICF0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9uKCdzJykpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmlucXVpcmVfKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZpbGxDb21tYW5kRGVmYXVsdHMoY29tbWFuZE9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlQXJndigpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgb3B0aW9uKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXJndltuYW1lXTtcbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dVc2FnZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWN0aW9uXyh0aGlzKTtcbiAgICAgICAgfVxuICAgIH0gICAgXG5cbiAgICBhc3luYyBpbnF1aXJlXygpIHtcbiAgICAgICAgbGV0IGRvSW5xdWlyZSA9IGl0ZW0gPT4gaW5xdWlyZXIucHJvbXB0KFtpdGVtXSkudGhlbihhbnN3ZXJzID0+IHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFuc3dlcnMsIChhbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3ZbbmFtZV0gPSBhbnM7XG4gICAgICAgICAgICAgICAgbGV0IG9wdHMgPSB0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zW25hbWVdO1xuICAgICAgICAgICAgICAgIGlmIChvcHRzLmFsaWFzKSB7XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChvcHRzLmFsaWFzLCBhID0+IHsgdGhpcy5hcmd2W2FdID0gYW5zOyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTsgXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIGFzeW5jIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoKCdpbnF1aXJlJyBpbiBvcHRzKSAmJiAhdGhpcy5hcmd2W25hbWVdKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlucXVpcmUgPSBvcHRzLmlucXVpcmU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLmlucXVpcmUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5xdWlyZSA9IGF3YWl0IG9wdHMuaW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0eXBlO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcSA9IHsgbmFtZTogbmFtZSwgbWVzc2FnZTogb3B0cy5wcm9tcHRNZXNzYWdlIHx8IG9wdHMuZGVzYyB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLnByb21wdFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBvcHRzLnByb21wdFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2xpc3QnIHx8IHR5cGUgID09PSAncmF3TGlzdCcgfHwgdHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0eXBlID09PSAnZXhwYW5kJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3B0cy5jaG9pY2VzUHJvdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGNob2ljZXMgcHJvdmlkZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5jaG9pY2VzID0gYXdhaXQgb3B0cy5jaG9pY2VzUHJvdmlkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmJvb2wpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnY29uZmlybSc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2lucHV0J1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcS50eXBlID0gdHlwZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoJ3Byb21wdERlZmF1bHQnIGluIG9wdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5wcm9tcHREZWZhdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kZWZhdWx0ID0gYXdhaXQgb3B0cy5wcm9tcHREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IG9wdHMucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvSW5xdWlyZShxKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5hZnRlcklucXVpcmUgJiYgdHlwZW9mIG9wdHMuYWZ0ZXJJbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBvcHRzLmFmdGVySW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgaW4gdGhpcy5hcmd2ICYmICdub25JbnF1aXJlRmlsdGVyJyBpbiBvcHRzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYXdhaXQgb3B0cy5ub25JbnF1aXJlRmlsdGVyKHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY29ubmVjdGlvbiBzdHJpbmdzIGZyb20gYSBjb25maWcgZmlsZS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbmYgLSBPb29sb25nIGNvbmZpZyBmaWxlLlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0Q29ubmVjdGlvblN0cmluZ3MoKSB7XG4gICAgICAgIGxldCBjb25maWcgPSB0aGlzLm9vbG9uZ0NvbmZpZztcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgICAgICBcbiAgICAgICAgU3VwcG9ydGVkRHJpdmVycy5mb3JFYWNoKGRyaXZlciA9PiB7XG4gICAgICAgICAgICBsZXQgY29ubmVjdG9ycyA9IGNvbmZpZ1tkcml2ZXJdO1xuXG4gICAgICAgICAgICBpZiAoY29ubmVjdG9ycykge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGNvbm5lY3RvcnMsIChjb25uZWN0b3JPcHRpb25zLCBjb25uZWN0b3JOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFttYWtlRGF0YVNvdXJjZU5hbWUoZHJpdmVyLCBjb25uZWN0b3JOYW1lKV0gPSBjb25uZWN0b3JPcHRpb25zLmNvbm5lY3Rpb247XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0IG9vbG9uZ0NvbmZpZygpIHtcbiAgICAgICAgaWYgKHRoaXMuX29vbG9uZ0NvbmZpZykgcmV0dXJuIHRoaXMuX29vbG9uZ0NvbmZpZztcblxuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMub3B0aW9uKCdjb25maWcnKTtcbiAgICAgICAgYXNzZXJ0OiBjb25maWdGaWxlLCAnT29sb25nIGNvbmZpZyBmaWxlIGlzIHJlcXVpcmVkLic7XG5cbiAgICAgICAgcmV0dXJuICh0aGlzLl9vb2xvbmdDb25maWcgPSBmcy5yZWFkSnNvblN5bmModGhpcy5hcHAudG9BYnNvbHV0ZVBhdGgoY29uZmlnRmlsZSkpKTtcbiAgICB9XG5cbiAgICBnZXQgc2NoZW1hRGVwbG95bWVudCgpIHtcbiAgICAgICAgbGV0IG1vZGVsTWFwcGluZyA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NoZW1hRGVwbG95bWVudCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkobW9kZWxNYXBwaW5nKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcInNjaGVtYURlcGxveW1lbnRcIiBpcyBlbXB0eS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBfLm1hcFZhbHVlcyhtb2RlbE1hcHBpbmcsIChtYXBwaW5nLCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBkYXRhU291cmNlLCAuLi5vdGhlcnMgfSA9IG1hcHBpbmc7XG4gICAgXG4gICAgICAgICAgICBpZiAoIWRhdGFTb3VyY2UpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZ3VyYXRpb24gaXRlbSBcInNjaGVtYURlcGxveW1lbnQuJHtzY2hlbWFOYW1lfS5kYXRhU291cmNlXCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgbGV0IHsgY29ubmVjdGlvbiwgb3B0aW9ucyB9ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGRhdGFTb3VyY2UpO1xuICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25uZWN0aW9uIHN0cmluZyBvZiBkYXRhIHNvdXJjZSBcIiR7ZGF0YVNvdXJjZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICByZXR1cm4geyBkYXRhU291cmNlLCBjb25uZWN0aW9uU3RyaW5nOiBjb25uZWN0aW9uLCAuLi5vcHRpb25zLCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGRlZmF1bHQgb29sb25nIG91dHB1dCBwYXRoLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcmVmaXggXG4gICAgICogQHBhcmFtIHtib29sfSBvdmVycmlkZSBcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBPdXRwdXQgcGF0aCBvZiBvb2xvbmcgZ2VuZXJhdGVkIGZpbGVzLlxuICAgICAqL1xuICAgIGdldFJldmVyc2VPdXRwdXREaXIoYmFzZURpciwgcHJlZml4ID0gJycsIG92ZXJyaWRlID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBmb2xkZXIgPSBgJHtwcmVmaXh9JHtub3cuZ2V0RnVsbFllYXIoKX0tJHtub3cuZ2V0TW9udGgoKSsxfS0ke25vdy5nZXREYXRlKCl9YDtcbiAgICAgICAgbGV0IG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIpO1xuXG4gICAgICAgIGlmIChvdmVycmlkZSkgcmV0dXJuIG91dHB1dERpcjtcblxuICAgICAgICBsZXQgbnVtID0gMTtcblxuICAgICAgICB3aGlsZSAoZnMuZXhpc3RzU3luYyhvdXRwdXREaXIpKSB7XG4gICAgICAgICAgICBsZXQgZm9sZGVyMiA9IGZvbGRlciArICdfJyArICgrK251bSkudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvdXRwdXREaXI7XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgcGFyc2VkIGFuZCBmaWxsZWQgYXJndW1lbnQgb3B0aW9ucy5cbiAgICBfdmFsaWRhdGVBcmd2KCkge1xuICAgICAgICBsZXQgdmFsaWQgPSB0cnVlO1xuXG4gICAgICAgIF8uZm9yT3duKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVxdWlyZWQgPSBvcHRzLnJlcXVpcmVkO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlcXVpcmVkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZWQgPSByZXF1aXJlZCgpO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgaWYgKHJlcXVpcmVkICYmICEobmFtZSBpbiB0aGlzLmFyZ3YpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQXJndW1lbnQgXCIke25hbWV9XCIgaXMgcmVxdWlyZWQuYCk7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkO1xuICAgIH1cblxuICAgIC8vIGZpbGwgdGhlIGFyZ3Ygd2l0aCBjb21tYW5kIHNwZWNpZmljIHByb21wdCBkZWZhdWx0c1xuICAgIF9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKSB7XG4gICAgICAgIF8uZm9yT3duKGNvbW1hbmRPcHRpb25zLCAoaW5mbywgb3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYXJndi5oYXNPd25Qcm9wZXJ0eShvcHRpb24pICYmIGluZm8uaGFzT3duUHJvcGVydHkoJ3Byb21wdERlZmF1bHQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltvcHRpb25dID0gaW5mby5wcm9tcHREZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT29sb25nQ29yZTsiXX0=