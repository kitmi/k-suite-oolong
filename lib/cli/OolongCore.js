"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire && typeof opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && 'nonInquireFilter' in opts) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }
    });
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    if (this._oolongConfig) return this._oolongConfig;
    let configFile = this.option('config');

    if (!configFile) {
      throw new Error('Oolong config file is required.');
    }

    return this._oolongConfig = fs.readJsonSync(this.app.toAbsolutePath(configFile));
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        ...options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIk9vbG9uZ0NvcmUiLCJjb25zdHJ1Y3RvciIsImFwcCIsImFwaSIsImluaXRpYWxpemVfIiwidXNhZ2VPcHRpb25zIiwiY2xvbmVEZWVwIiwiY29uZmlnIiwiY29tbWFuZExpbmVPcHRpb25zIiwiZmVhdHVyZXMiLCJzaG93VXNhZ2UiLCJlcnIiLCJpbmplY3RzIiwiYWZ0ZXJCYW5uZXIiLCJtZXNzYWdlIiwiY29tbWFuZCIsImFmdGVyQ29tbWFuZExpbmUiLCJjb21tYW5kcyIsInJlZHVjZSIsInJlc3VsdCIsImRlc2MiLCJjbWQiLCJjb25zb2xlIiwibG9nIiwiZ2V0VXNhZ2UiLCJhcmd2IiwiY2FtZWxDYXNlIiwidW5kZWZpbmVkIiwiYWN0aW9uXyIsImNvbW1hbmRPcHRpb25zIiwib3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsInBhcnNlQXJndiIsIm9wdGlvbiIsImlucXVpcmVfIiwiX2ZpbGxDb21tYW5kRGVmYXVsdHMiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvb2xvbmdDb25maWciLCJmb3JFYWNoIiwiZHJpdmVyIiwiY29ubmVjdG9ycyIsImNvbm5lY3Rvck9wdGlvbnMiLCJjb25uZWN0b3JOYW1lIiwiY29ubmVjdGlvbiIsImdldFNjaGVtYXNJbkNvbmZpZyIsInNjaGVtYXMiLCJnZXRWYWx1ZUJ5UGF0aCIsImtleXMiLCJnZXREYXRhc2V0XyIsInNjcmlwdFNvdXJjZVBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsInNjaGVtYSIsImRhdGFzZXRfIiwibG9nZ2VyIiwic2NoZW1hRGVwbG95bWVudCIsIl9vb2xvbmdDb25maWciLCJjb25maWdGaWxlIiwicmVhZEpzb25TeW5jIiwibW9kZWxNYXBwaW5nIiwiaXNFbXB0eSIsIm1hcFZhbHVlcyIsIm1hcHBpbmciLCJzY2hlbWFOYW1lIiwiZGF0YVNvdXJjZSIsIm90aGVycyIsImNvbm5lY3Rpb25TdHJpbmciLCJnZXRSZXZlcnNlT3V0cHV0RGlyIiwiYmFzZURpciIsInByZWZpeCIsIm92ZXJyaWRlIiwibm93IiwiRGF0ZSIsImZvbGRlciIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwib3V0cHV0RGlyIiwiam9pbiIsIm51bSIsImV4aXN0c1N5bmMiLCJmb2xkZXIyIiwidG9TdHJpbmciLCJ2YWxpZCIsInJlcXVpcmVkIiwiZXJyb3IiLCJpbmZvIiwiaGFzT3duUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxJQUFsQjs7QUFDQSxNQUFNSSxRQUFRLEdBQUdILE9BQU8sQ0FBQyxVQUFELENBQXhCOztBQUNBLE1BQU1JLElBQUksR0FBR0osT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUssUUFBUSxHQUFHTCxPQUFPLENBQUMsWUFBRCxDQUF4Qjs7QUFDQSxNQUFNTSxTQUFTLEdBQUdOLE9BQU8s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QUNsQ0gsUUFBQUEsT0FBTyxDQUFDMkYsS0FBUixDQUFlLGFBQVkzRSxJQUFLLGdCQUFoQztBQUNBeUUsUUFBQUEsS0FBSyxHQUFHLEtBQVI7QUFDSDtBQUNKLEtBWEQ7O0FBYUEsV0FBT0EsS0FBUDtBQUNIOztBQUdEM0UsRUFBQUEsb0JBQW9CLENBQUNQLGNBQUQsRUFBaUI7QUFDakNyQyxJQUFBQSxDQUFDLENBQUNxRCxNQUFGLENBQVNoQixjQUFULEVBQXlCLENBQUNxRixJQUFELEVBQU9oRixNQUFQLEtBQWtCO0FBQ3ZDLFVBQUksQ0FBQyxLQUFLVCxJQUFMLENBQVUwRixjQUFWLENBQXlCakYsTUFBekIsQ0FBRCxJQUFxQ2dGLElBQUksQ0FBQ0MsY0FBTCxDQUFvQixlQUFwQixDQUF6QyxFQUErRTtBQUMzRSxhQUFLMUYsSUFBTCxDQUFVUyxNQUFWLElBQW9CZ0YsSUFBSSxDQUFDckQsYUFBekI7QUFDSDtBQUNKLEtBSkQ7QUFLSDs7QUE3UVk7O0FBZ1JqQnVELE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJILFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7IFxuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IGlucXVpcmVyID0gcmVxdWlyZSgnaW5xdWlyZXInKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBDb21tYW5kcyA9IHJlcXVpcmUoJy4vY29tbWFuZHMnKTtcbmNvbnN0IE9vbG9uZ0FwaSA9IHJlcXVpcmUoJy4uL2xhbmcvYXBpJyk7XG5jb25zdCB7IG1ha2VEYXRhU291cmNlTmFtZSwgU3VwcG9ydGVkRHJpdmVycyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuXG4vKipcbiAqIE9vbG9uZyBjb21tYW5kIGxpbmUgaGVscGVyIGNvcmUgY2xhc3MuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgT29sb25nQ29yZSB7XG4gICAgY29uc3RydWN0b3IoYXBwKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLmFwaSA9IE9vbG9uZ0FwaTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogUmVwYXJzZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzIHdpdGggY29tbWFuZCBzcGVjaWZpYyBvcHRpb25zLlxuICAgICAqL1xuICAgIGFzeW5jIGluaXRpYWxpemVfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMudXNhZ2VPcHRpb25zID0gXy5jbG9uZURlZXAodGhpcy5hcHAuY29uZmlnLmNvbW1hbmRMaW5lT3B0aW9ucyk7XG4gICAgICAgIGxldCBjb21tYW5kTGluZU9wdGlvbnMgPSB0aGlzLmFwcC5mZWF0dXJlc1snY29tbWFuZExpbmVPcHRpb25zJ107XG5cbiAgICAgICAgdGhpcy5zaG93VXNhZ2UgPSAoZXJyKSA9PiB7XG4gICAgICAgICAgICBsZXQgaW5qZWN0cyA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckJhbm5lciA9ICgpID0+IChlcnIubWVzc2FnZSB8fCBlcnIpICsgJ1xcblxcbic7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmNvbW1hbmQgJiYgdGhpcy5jb21tYW5kICE9PSAnbWFpbicpIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQ29tbWFuZExpbmUgPSAoKSA9PiBgQ29tbWFuZCBcIiR7dGhpcy5jb21tYW5kfVwiOiBgICsgQ29tbWFuZHMuY29tbWFuZHNbdGhpcy5jb21tYW5kXSArJ1xcblxcbic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJDb21tYW5kTGluZSA9ICgpID0+ICdBdmFpbGFibGUgY29tbWFuZHM6XFxuJyArIF8ucmVkdWNlKENvbW1hbmRzLmNvbW1hbmRzLCAocmVzdWx0LCBkZXNjLCBjbWQpID0+IHJlc3VsdCArIGAgICR7Y21kfTogJHtkZXNjfVxcbmAsICcnKSArICdcXG4nXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcblxuICAgICAgICAgICAgY29uc29sZS5sb2coY29tbWFuZExpbmVPcHRpb25zLmdldFVzYWdlKHRoaXMuYXBwLCB0aGlzLnVzYWdlT3B0aW9ucywgaW5qZWN0cykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9leHRyYWN0IG1vZHVsZSBhbmQgY29tbWFuZFxuICAgICAgICBsZXQgY29tbWFuZCA9IHRoaXMuYXBwLmFyZ3YuX1swXTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuY29tbWFuZCA9IF8uY2FtZWxDYXNlKGNvbW1hbmQpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgPT09ICdjb21tYW5kcycgfHwgdGhpcy5jb21tYW5kID09PSAnb3B0aW9ucycpIHtcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuYWN0aW9uXyA9IENvbW1hbmRzW3RoaXMuY29tbWFuZF07XG5cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmFjdGlvbl8gIT09ICdmdW5jdGlvbicpIHsgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDsgICBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb21tYW5kT3B0aW9ucyA9IENvbW1hbmRzLm9wdGlvbnModGhpcyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgY29tbWFuZE9wdGlvbnMpO1xuXG4gICAgICAgIC8vcmUtcGFyc2UgYXJndW1lbnRzIGFjY29yZGluZyB0byBzZXR0aW5nc1xuICAgICAgICB0aGlzLmFyZ3YgPSBjb21tYW5kTGluZU9wdGlvbnMucGFyc2VBcmd2KHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMpOyAgICAgICAgXG5cbiAgICAgICAgaWYgKHRoaXMuY29tbWFuZCAhPT0gJ21haW4nICYmICF0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9uKCdzJykpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmlucXVpcmVfKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZpbGxDb21tYW5kRGVmYXVsdHMoY29tbWFuZE9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlQXJndigpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgb3B0aW9uKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXJndltuYW1lXTtcbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dVc2FnZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWN0aW9uXyh0aGlzKTtcbiAgICAgICAgfVxuICAgIH0gICAgXG5cbiAgICBhc3luYyBpbnF1aXJlXygpIHtcbiAgICAgICAgbGV0IGRvSW5xdWlyZSA9IGl0ZW0gPT4gaW5xdWlyZXIucHJvbXB0KFtpdGVtXSkudGhlbihhbnN3ZXJzID0+IHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFuc3dlcnMsIChhbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3ZbbmFtZV0gPSBhbnM7XG4gICAgICAgICAgICAgICAgbGV0IG9wdHMgPSB0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zW25hbWVdO1xuICAgICAgICAgICAgICAgIGlmIChvcHRzLmFsaWFzKSB7XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChvcHRzLmFsaWFzLCBhID0+IHsgdGhpcy5hcmd2W2FdID0gYW5zOyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTsgXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIGFzeW5jIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoKCdpbnF1aXJlJyBpbiBvcHRzKSAmJiAhdGhpcy5hcmd2W25hbWVdKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlucXVpcmUgPSBvcHRzLmlucXVpcmU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLmlucXVpcmUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5xdWlyZSA9IGF3YWl0IG9wdHMuaW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0eXBlO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcSA9IHsgbmFtZTogbmFtZSwgbWVzc2FnZTogb3B0cy5wcm9tcHRNZXNzYWdlIHx8IG9wdHMuZGVzYyB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLnByb21wdFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBvcHRzLnByb21wdFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2xpc3QnIHx8IHR5cGUgID09PSAncmF3TGlzdCcgfHwgdHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0eXBlID09PSAnZXhwYW5kJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3B0cy5jaG9pY2VzUHJvdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGNob2ljZXMgcHJvdmlkZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5jaG9pY2VzID0gYXdhaXQgb3B0cy5jaG9pY2VzUHJvdmlkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmJvb2wpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnY29uZmlybSc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2lucHV0J1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcS50eXBlID0gdHlwZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoJ3Byb21wdERlZmF1bHQnIGluIG9wdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5wcm9tcHREZWZhdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kZWZhdWx0ID0gYXdhaXQgb3B0cy5wcm9tcHREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IG9wdHMucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvSW5xdWlyZShxKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5hZnRlcklucXVpcmUgJiYgdHlwZW9mIG9wdHMuYWZ0ZXJJbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBvcHRzLmFmdGVySW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgaW4gdGhpcy5hcmd2ICYmICdub25JbnF1aXJlRmlsdGVyJyBpbiBvcHRzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYXdhaXQgb3B0cy5ub25JbnF1aXJlRmlsdGVyKHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY29ubmVjdGlvbiBzdHJpbmdzIGZyb20gYSBjb25maWcgZmlsZS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbmYgLSBPb29sb25nIGNvbmZpZyBmaWxlLlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0Q29ubmVjdGlvblN0cmluZ3MoKSB7XG4gICAgICAgIGxldCBjb25maWcgPSB0aGlzLm9vbG9uZ0NvbmZpZztcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgICAgICBcbiAgICAgICAgU3VwcG9ydGVkRHJpdmVycy5mb3JFYWNoKGRyaXZlciA9PiB7XG4gICAgICAgICAgICBsZXQgY29ubmVjdG9ycyA9IGNvbmZpZ1tkcml2ZXJdO1xuXG4gICAgICAgICAgICBpZiAoY29ubmVjdG9ycykge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGNvbm5lY3RvcnMsIChjb25uZWN0b3JPcHRpb25zLCBjb25uZWN0b3JOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFttYWtlRGF0YVNvdXJjZU5hbWUoZHJpdmVyLCBjb25uZWN0b3JOYW1lKV0gPSBjb25uZWN0b3JPcHRpb25zLmNvbm5lY3Rpb247XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0U2NoZW1hc0luQ29uZmlnKCkge1xuICAgICAgICBsZXQgc2NoZW1hcyA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NoZW1hRGVwbG95bWVudCcpO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoc2NoZW1hcyk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0RGF0YXNldF8oKSB7XG4gICAgICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gdGhpcy5hcHAudG9BYnNvbHV0ZVBhdGgoVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY3JpcHRTb3VyY2VEaXInKSk7XG5cbiAgICAgICAgbGV0IHNjaGVtYSA9IHRoaXMub3B0aW9uKCdzY2hlbWEnKTsgXG4gICAgICAgIGlmICghc2NoZW1hKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNjaGVtYSBhcmd1bWVudCBpcyByZXF1aXJlZCBmb3IgbGlzdGluZyBkYXRhc2V0LmApO1xuICAgICAgICB9ICBcblxuICAgICAgICByZXR1cm4gdGhpcy5hcGkuZGF0YXNldF8oXG4gICAgICAgICAgICB7IFxuICAgICAgICAgICAgICAgIGxvZ2dlcjogdGhpcy5hcHAubG9nZ2VyLFxuICAgICAgICAgICAgICAgIHNjcmlwdFNvdXJjZVBhdGgsIFxuICAgICAgICAgICAgICAgIHNjaGVtYURlcGxveW1lbnQ6IHRoaXMuc2NoZW1hRGVwbG95bWVudCBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY2hlbWFcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXQgb29sb25nQ29uZmlnKCkge1xuICAgICAgICBpZiAodGhpcy5fb29sb25nQ29uZmlnKSByZXR1cm4gdGhpcy5fb29sb25nQ29uZmlnO1xuXG4gICAgICAgIGxldCBjb25maWdGaWxlID0gdGhpcy5vcHRpb24oJ2NvbmZpZycpO1xuICAgICAgICBhc3NlcnQ6IGNvbmZpZ0ZpbGUsICdPb2xvbmcgY29uZmlnIGZpbGUgaXMgcmVxdWlyZWQuJztcblxuICAgICAgICByZXR1cm4gKHRoaXMuX29vbG9uZ0NvbmZpZyA9IGZzLnJlYWRKc29uU3luYyh0aGlzLmFwcC50b0Fic29sdXRlUGF0aChjb25maWdGaWxlKSkpO1xuICAgIH1cblxuICAgIGdldCBzY2hlbWFEZXBsb3ltZW50KCkge1xuICAgICAgICBsZXQgbW9kZWxNYXBwaW5nID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY2hlbWFEZXBsb3ltZW50Jyk7XG5cbiAgICAgICAgaWYgKF8uaXNFbXB0eShtb2RlbE1hcHBpbmcpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wic2NoZW1hRGVwbG95bWVudFwiIGlzIGVtcHR5LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKG1vZGVsTWFwcGluZywgKG1hcHBpbmcsIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCB7IGRhdGFTb3VyY2UsIC4uLm90aGVycyB9ID0gbWFwcGluZztcbiAgICBcbiAgICAgICAgICAgIGlmICghZGF0YVNvdXJjZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29uZmlndXJhdGlvbiBpdGVtIFwic2NoZW1hRGVwbG95bWVudC4ke3NjaGVtYU5hbWV9LmRhdGFTb3VyY2VcIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICBsZXQgeyBjb25uZWN0aW9uLCBvcHRpb25zIH0gPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnZGF0YVNvdXJjZS4nICsgZGF0YVNvdXJjZSwge30pO1xuICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25uZWN0aW9uIHN0cmluZyBvZiBkYXRhIHNvdXJjZSBcIiR7ZGF0YVNvdXJjZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICByZXR1cm4geyBkYXRhU291cmNlLCBjb25uZWN0aW9uU3RyaW5nOiBjb25uZWN0aW9uLCAuLi5vcHRpb25zLCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGRlZmF1bHQgb29sb25nIG91dHB1dCBwYXRoLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcmVmaXggXG4gICAgICogQHBhcmFtIHtib29sfSBvdmVycmlkZSBcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBPdXRwdXQgcGF0aCBvZiBvb2xvbmcgZ2VuZXJhdGVkIGZpbGVzLlxuICAgICAqL1xuICAgIGdldFJldmVyc2VPdXRwdXREaXIoYmFzZURpciwgcHJlZml4ID0gJycsIG92ZXJyaWRlID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBmb2xkZXIgPSBgJHtwcmVmaXh9JHtub3cuZ2V0RnVsbFllYXIoKX0tJHtub3cuZ2V0TW9udGgoKSsxfS0ke25vdy5nZXREYXRlKCl9YDtcbiAgICAgICAgbGV0IG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIpO1xuXG4gICAgICAgIGlmIChvdmVycmlkZSkgcmV0dXJuIG91dHB1dERpcjtcblxuICAgICAgICBsZXQgbnVtID0gMTtcblxuICAgICAgICB3aGlsZSAoZnMuZXhpc3RzU3luYyhvdXRwdXREaXIpKSB7XG4gICAgICAgICAgICBsZXQgZm9sZGVyMiA9IGZvbGRlciArICdfJyArICgrK251bSkudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvdXRwdXREaXI7XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgcGFyc2VkIGFuZCBmaWxsZWQgYXJndW1lbnQgb3B0aW9ucy5cbiAgICBfdmFsaWRhdGVBcmd2KCkge1xuICAgICAgICBsZXQgdmFsaWQgPSB0cnVlO1xuXG4gICAgICAgIF8uZm9yT3duKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVxdWlyZWQgPSBvcHRzLnJlcXVpcmVkO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlcXVpcmVkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZWQgPSByZXF1aXJlZCgpO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgaWYgKHJlcXVpcmVkICYmICEobmFtZSBpbiB0aGlzLmFyZ3YpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQXJndW1lbnQgXCIke25hbWV9XCIgaXMgcmVxdWlyZWQuYCk7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkO1xuICAgIH1cblxuICAgIC8vIGZpbGwgdGhlIGFyZ3Ygd2l0aCBjb21tYW5kIHNwZWNpZmljIHByb21wdCBkZWZhdWx0c1xuICAgIF9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKSB7XG4gICAgICAgIF8uZm9yT3duKGNvbW1hbmRPcHRpb25zLCAoaW5mbywgb3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYXJndi5oYXNPd25Qcm9wZXJ0eShvcHRpb24pICYmIGluZm8uaGFzT3duUHJvcGVydHkoJ3Byb21wdERlZmF1bHQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltvcHRpb25dID0gaW5mby5wcm9tcHREZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT29sb25nQ29yZTsiXX0=