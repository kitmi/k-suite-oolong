"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire && typeof opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && 'nonInquireFilter' in opts) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }
    });
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    if (this._oolongConfig) return this._oolongConfig;
    let configFile = this.option('config');

    if (!configFile) {
      throw new Error('Oolong config file is required.');
    }

    return this._oolongConfig = fs.readJsonSync(this.app.toAbsolutePath(configFile));
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        ...options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIk9vbG9uZ0NvcmUiLCJjb25zdHJ1Y3RvciIsImFwcCIsImFwaSIsImluaXRpYWxpemVfIiwidXNhZ2VPcHRpb25zIiwiY2xvbmVEZWVwIiwiY29uZmlnIiwiY29tbWFuZExpbmVPcHRpb25zIiwiZmVhdHVyZXMiLCJzaG93VXNhZ2UiLCJlcnIiLCJpbmplY3RzIiwiYWZ0ZXJCYW5uZXIiLCJtZXNzYWdlIiwiY29tbWFuZCIsImFmdGVyQ29tbWFuZExpbmUiLCJjb21tYW5kcyIsInJlZHVjZSIsInJlc3VsdCIsImRlc2MiLCJjbWQiLCJjb25zb2xlIiwibG9nIiwiZ2V0VXNhZ2UiLCJhcmd2IiwiY2FtZWxDYXNlIiwidW5kZWZpbmVkIiwiYWN0aW9uXyIsImNvbW1hbmRPcHRpb25zIiwib3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsInBhcnNlQXJndiIsIm9wdGlvbiIsImlucXVpcmVfIiwiX2ZpbGxDb21tYW5kRGVmYXVsdHMiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvb2xvbmdDb25maWciLCJmb3JFYWNoIiwiZHJpdmVyIiwiY29ubmVjdG9ycyIsImNvbm5lY3Rvck9wdGlvbnMiLCJjb25uZWN0b3JOYW1lIiwiY29ubmVjdGlvbiIsImdldFNjaGVtYXNJbkNvbmZpZyIsInNjaGVtYXMiLCJnZXRWYWx1ZUJ5UGF0aCIsImtleXMiLCJnZXREYXRhc2V0XyIsInNjcmlwdFNvdXJjZVBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsInNjaGVtYSIsImRhdGFzZXRfIiwibG9nZ2VyIiwic2NoZW1hRGVwbG95bWVudCIsIl9vb2xvbmdDb25maWciLCJjb25maWdGaWxlIiwicmVhZEpzb25TeW5jIiwibW9kZWxNYXBwaW5nIiwiaXNFbXB0eSIsIm1hcFZhbHVlcyIsIm1hcHBpbmciLCJzY2hlbWFOYW1lIiwiZGF0YVNvdXJjZSIsIm90aGVycyIsImNvbm5lY3Rpb25TdHJpbmciLCJnZXRSZXZlcnNlT3V0cHV0RGlyIiwiYmFzZURpciIsInByZWZpeCIsIm92ZXJyaWRlIiwibm93IiwiRGF0ZSIsImZvbGRlciIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwib3V0cHV0RGlyIiwiam9pbiIsIm51bSIsImV4aXN0c1N5bmMiLCJmb2xkZXIyIiwidG9TdHJpbmciLCJ2YWxpZCIsInJlcXVpcmVkIiwiZXJyb3IiLCJpbmZvIiwiaGFzT3duUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxJQUFsQjs7QUFDQSxNQUFNSSxRQUFRLEdBQUdILE9BQU8sQ0FBQyxVQUFELENBQXhCOztBQUNBLE1BQU1JLElBQUksR0FBR0osT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUssUUFBUSxHQUFHTCxPQUFPLENBQUMsWUFBRCxDQUF4Qjs7QUFDQSxNQUFNTSxTQUFTLEdBQUdOLE9BQU8s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QUFDbENILFFBQUFBLE9BQU8sQ0FBQzJGLEtBQVIsQ0FBZSxhQUFZM0UsSUFBSyxnQkFBaEM7QUFDQXlFLFFBQUFBLEtBQUssR0FBRyxLQUFSO0FBQ0g7QUFDSixLQVhEOztBQWFBLFdBQU9BLEtBQVA7QUFDSDs7QUFHRDNFLEVBQUFBLG9CQUFvQixDQUFDUCxjQUFELEVBQWlCO0FBQ2pDckMsSUFBQUEsQ0FBQyxDQUFDcUQsTUFBRixDQUFTaEIsY0FBVCxFQUF5QixDQUFDcUYsSUFBRCxFQUFPaEYsTUFBUCxLQUFrQjtBQUN2QyxVQUFJLENBQUMsS0FBS1QsSUFBTCxDQUFVMEYsY0FBVixDQUF5QmpGLE1BQXpCLENBQUQsSUFBcUNnRixJQUFJLENBQUNDLGNBQUwsQ0FBb0IsZUFBcEIsQ0FBekMsRUFBK0U7QUFDM0UsYUFBSzFGLElBQUwsQ0FBVVMsTUFBVixJQUFvQmdGLElBQUksQ0FBQ3JELGFBQXpCO0FBQ0g7QUFDSixLQUpEO0FBS0g7O0FBN1FZOztBQWdSakJ1RCxNQUFNLENBQUNDLE9BQVAsR0FBaUJySCxVQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpOyBcbmNvbnN0IHsgXywgZnMgfSA9IFV0aWw7XG5jb25zdCBpbnF1aXJlciA9IHJlcXVpcmUoJ2lucXVpcmVyJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgQ29tbWFuZHMgPSByZXF1aXJlKCcuL2NvbW1hbmRzJyk7XG5jb25zdCBPb2xvbmdBcGkgPSByZXF1aXJlKCcuLi9sYW5nL2FwaScpO1xuY29uc3QgeyBtYWtlRGF0YVNvdXJjZU5hbWUsIFN1cHBvcnRlZERyaXZlcnMgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuLyoqXG4gKiBPb2xvbmcgY29tbWFuZCBsaW5lIGhlbHBlciBjb3JlIGNsYXNzLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIE9vbG9uZ0NvcmUge1xuICAgIGNvbnN0cnVjdG9yKGFwcCkge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5hcGkgPSBPb2xvbmdBcGk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFJlcGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50cyB3aXRoIGNvbW1hbmQgc3BlY2lmaWMgb3B0aW9ucy5cbiAgICAgKi9cbiAgICBhc3luYyBpbml0aWFsaXplXygpIHsgICAgICAgIFxuICAgICAgICB0aGlzLnVzYWdlT3B0aW9ucyA9IF8uY2xvbmVEZWVwKHRoaXMuYXBwLmNvbmZpZy5jb21tYW5kTGluZU9wdGlvbnMpO1xuICAgICAgICBsZXQgY29tbWFuZExpbmVPcHRpb25zID0gdGhpcy5hcHAuZmVhdHVyZXNbJ2NvbW1hbmRMaW5lT3B0aW9ucyddO1xuXG4gICAgICAgIHRoaXMuc2hvd1VzYWdlID0gKGVycikgPT4ge1xuICAgICAgICAgICAgbGV0IGluamVjdHMgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJCYW5uZXIgPSAoKSA9PiAoZXJyLm1lc3NhZ2UgfHwgZXJyKSArICdcXG5cXG4nO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5jb21tYW5kICYmIHRoaXMuY29tbWFuZCAhPT0gJ21haW4nKSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckNvbW1hbmRMaW5lID0gKCkgPT4gYENvbW1hbmQgXCIke3RoaXMuY29tbWFuZH1cIjogYCArIENvbW1hbmRzLmNvbW1hbmRzW3RoaXMuY29tbWFuZF0gKydcXG5cXG4nO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQ29tbWFuZExpbmUgPSAoKSA9PiAnQXZhaWxhYmxlIGNvbW1hbmRzOlxcbicgKyBfLnJlZHVjZShDb21tYW5kcy5jb21tYW5kcywgKHJlc3VsdCwgZGVzYywgY21kKSA9PiByZXN1bHQgKyBgICAke2NtZH06ICR7ZGVzY31cXG5gLCAnJykgKyAnXFxuJ1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbW1hbmRMaW5lT3B0aW9ucy5nZXRVc2FnZSh0aGlzLmFwcCwgdGhpcy51c2FnZU9wdGlvbnMsIGluamVjdHMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vZXh0cmFjdCBtb2R1bGUgYW5kIGNvbW1hbmRcbiAgICAgICAgbGV0IGNvbW1hbmQgPSB0aGlzLmFwcC5hcmd2Ll9bMF07XG4gICAgICAgIFxuICAgICAgICB0aGlzLmNvbW1hbmQgPSBfLmNhbWVsQ2FzZShjb21tYW5kKTtcblxuICAgICAgICBpZiAodGhpcy5jb21tYW5kID09PSAnY29tbWFuZHMnIHx8IHRoaXMuY29tbWFuZCA9PT0gJ29wdGlvbnMnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmFjdGlvbl8gPSBDb21tYW5kc1t0aGlzLmNvbW1hbmRdO1xuXG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5hY3Rpb25fICE9PSAnZnVuY3Rpb24nKSB7ICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSB1bmRlZmluZWQ7ICAgXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29tbWFuZE9wdGlvbnMgPSBDb21tYW5kcy5vcHRpb25zKHRoaXMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIGNvbW1hbmRPcHRpb25zKTtcblxuICAgICAgICAvL3JlLXBhcnNlIGFyZ3VtZW50cyBhY2NvcmRpbmcgdG8gc2V0dGluZ3NcbiAgICAgICAgdGhpcy5hcmd2ID0gY29tbWFuZExpbmVPcHRpb25zLnBhcnNlQXJndih0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zKTsgICAgICAgIFxuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgIT09ICdtYWluJyAmJiAhdGhpcy5vcHRpb24oJz8nKSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbigncycpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5pbnF1aXJlXygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZUFyZ3YoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIG9wdGlvbihuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyZ3ZbbmFtZV07XG4gICAgfSAgICBcblxuICAgIGFzeW5jIGV4ZWN1dGVfKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRpb24oJz8nKSkge1xuICAgICAgICAgICAgdGhpcy5zaG93VXNhZ2UoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFjdGlvbl8odGhpcyk7XG4gICAgICAgIH1cbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgaW5xdWlyZV8oKSB7XG4gICAgICAgIGxldCBkb0lucXVpcmUgPSBpdGVtID0+IGlucXVpcmVyLnByb21wdChbaXRlbV0pLnRoZW4oYW5zd2VycyA9PiB7XG4gICAgICAgICAgICBfLmZvck93bihhbnN3ZXJzLCAoYW5zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYW5zO1xuICAgICAgICAgICAgICAgIGxldCBvcHRzID0gdGhpcy51c2FnZU9wdGlvbnMub3B0aW9uc1tuYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5hbGlhcykge1xuICAgICAgICAgICAgICAgICAgICBfLmVhY2gob3B0cy5hbGlhcywgYSA9PiB7IHRoaXMuYXJndlthXSA9IGFuczsgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7IFxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIFV0aWwuZWFjaEFzeW5jXyh0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zLCBhc3luYyAob3B0cywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgaWYgKCgnaW5xdWlyZScgaW4gb3B0cykgJiYgIXRoaXMuYXJndltuYW1lXSkge1xuICAgICAgICAgICAgICAgIGxldCBpbnF1aXJlID0gb3B0cy5pbnF1aXJlO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5pbnF1aXJlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlucXVpcmUgPSBhd2FpdCBvcHRzLmlucXVpcmUoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5xdWlyZSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgdHlwZTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHEgPSB7IG5hbWU6IG5hbWUsIG1lc3NhZ2U6IG9wdHMucHJvbXB0TWVzc2FnZSB8fCBvcHRzLmRlc2MgfTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5wcm9tcHRUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gb3B0cy5wcm9tcHRUeXBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdsaXN0JyB8fCB0eXBlICA9PT0gJ3Jhd0xpc3QnIHx8IHR5cGUgPT09ICdjaGVja2JveCcgfHwgdHlwZSA9PT0gJ2V4cGFuZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMuY2hvaWNlc1Byb3ZpZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBjaG9pY2VzIHByb3ZpZGVyIScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuY2hvaWNlcyA9IGF3YWl0IG9wdHMuY2hvaWNlc1Byb3ZpZGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5ib29sKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2NvbmZpcm0nO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdpbnB1dCdcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHEudHlwZSA9IHR5cGU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCdwcm9tcHREZWZhdWx0JyBpbiBvcHRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdHMucHJvbXB0RGVmYXVsdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IGF3YWl0IG9wdHMucHJvbXB0RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmRlZmF1bHQgPSBvcHRzLnByb21wdERlZmF1bHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkb0lucXVpcmUocSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuYWZ0ZXJJbnF1aXJlICYmIHR5cGVvZiBvcHRzLmFmdGVySW5xdWlyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3B0cy5hZnRlcklucXVpcmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lIGluIHRoaXMuYXJndiAmJiAnbm9uSW5xdWlyZUZpbHRlcicgaW4gb3B0cykge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltuYW1lXSA9IGF3YWl0IG9wdHMubm9uSW5xdWlyZUZpbHRlcih0aGlzLmFyZ3ZbbmFtZV0pO1xuICAgICAgICAgICAgfSBcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGNvbm5lY3Rpb24gc3RyaW5ncyBmcm9tIGEgY29uZmlnIGZpbGUuXG4gICAgICogQHBhcmFtIHsqfSBjb25mIC0gT29vbG9uZyBjb25maWcgZmlsZS5cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldENvbm5lY3Rpb25TdHJpbmdzKCkge1xuICAgICAgICBsZXQgY29uZmlnID0gdGhpcy5vb2xvbmdDb25maWc7XG4gICAgICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIFN1cHBvcnRlZERyaXZlcnMuZm9yRWFjaChkcml2ZXIgPT4ge1xuICAgICAgICAgICAgbGV0IGNvbm5lY3RvcnMgPSBjb25maWdbZHJpdmVyXTtcblxuICAgICAgICAgICAgaWYgKGNvbm5lY3RvcnMpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihjb25uZWN0b3JzLCAoY29ubmVjdG9yT3B0aW9ucywgY29ubmVjdG9yTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbbWFrZURhdGFTb3VyY2VOYW1lKGRyaXZlciwgY29ubmVjdG9yTmFtZSldID0gY29ubmVjdG9yT3B0aW9ucy5jb25uZWN0aW9uO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGdldFNjaGVtYXNJbkNvbmZpZygpIHtcbiAgICAgICAgbGV0IHNjaGVtYXMgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjaGVtYURlcGxveW1lbnQnKTtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHNjaGVtYXMpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldERhdGFzZXRfKCkge1xuICAgICAgICBsZXQgc2NyaXB0U291cmNlUGF0aCA9IHRoaXMuYXBwLnRvQWJzb2x1dGVQYXRoKFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJykpO1xuXG4gICAgICAgIGxldCBzY2hlbWEgPSB0aGlzLm9wdGlvbignc2NoZW1hJyk7IFxuICAgICAgICBpZiAoIXNjaGVtYSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTY2hlbWEgYXJndW1lbnQgaXMgcmVxdWlyZWQgZm9yIGxpc3RpbmcgZGF0YXNldC5gKTtcbiAgICAgICAgfSAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpLmRhdGFzZXRfKFxuICAgICAgICAgICAgeyBcbiAgICAgICAgICAgICAgICBsb2dnZXI6IHRoaXMuYXBwLmxvZ2dlcixcbiAgICAgICAgICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLCBcbiAgICAgICAgICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiB0aGlzLnNjaGVtYURlcGxveW1lbnQgXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2NoZW1hXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0IG9vbG9uZ0NvbmZpZygpIHtcbiAgICAgICAgaWYgKHRoaXMuX29vbG9uZ0NvbmZpZykgcmV0dXJuIHRoaXMuX29vbG9uZ0NvbmZpZztcblxuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMub3B0aW9uKCdjb25maWcnKTtcbiAgICAgICAgYXNzZXJ0OiBjb25maWdGaWxlLCAnT29sb25nIGNvbmZpZyBmaWxlIGlzIHJlcXVpcmVkLic7XG5cbiAgICAgICAgcmV0dXJuICh0aGlzLl9vb2xvbmdDb25maWcgPSBmcy5yZWFkSnNvblN5bmModGhpcy5hcHAudG9BYnNvbHV0ZVBhdGgoY29uZmlnRmlsZSkpKTtcbiAgICB9XG5cbiAgICBnZXQgc2NoZW1hRGVwbG95bWVudCgpIHtcbiAgICAgICAgbGV0IG1vZGVsTWFwcGluZyA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NoZW1hRGVwbG95bWVudCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkobW9kZWxNYXBwaW5nKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcInNjaGVtYURlcGxveW1lbnRcIiBpcyBlbXB0eS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBfLm1hcFZhbHVlcyhtb2RlbE1hcHBpbmcsIChtYXBwaW5nLCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBkYXRhU291cmNlLCAuLi5vdGhlcnMgfSA9IG1hcHBpbmc7XG4gICAgXG4gICAgICAgICAgICBpZiAoIWRhdGFTb3VyY2UpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZ3VyYXRpb24gaXRlbSBcInNjaGVtYURlcGxveW1lbnQuJHtzY2hlbWFOYW1lfS5kYXRhU291cmNlXCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgbGV0IHsgY29ubmVjdGlvbiwgLi4ub3B0aW9ucyB9ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGRhdGFTb3VyY2UsIHt9KTtcbiAgICAgICAgICAgIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiBzdHJpbmcgb2YgZGF0YSBzb3VyY2UgXCIke2RhdGFTb3VyY2V9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgcmV0dXJuIHsgZGF0YVNvdXJjZSwgY29ubmVjdGlvblN0cmluZzogY29ubmVjdGlvbiwgb3B0aW9ucywgLi4ub3RoZXJzIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBkZWZhdWx0IG9vbG9uZyBvdXRwdXQgcGF0aC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJlZml4IFxuICAgICAqIEBwYXJhbSB7Ym9vbH0gb3ZlcnJpZGUgXG4gICAgICogQHJldHVybnMge3N0cmluZ30gT3V0cHV0IHBhdGggb2Ygb29sb25nIGdlbmVyYXRlZCBmaWxlcy5cbiAgICAgKi9cbiAgICBnZXRSZXZlcnNlT3V0cHV0RGlyKGJhc2VEaXIsIHByZWZpeCA9ICcnLCBvdmVycmlkZSA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQgZm9sZGVyID0gYCR7cHJlZml4fSR7bm93LmdldEZ1bGxZZWFyKCl9LSR7bm93LmdldE1vbnRoKCkrMX0tJHtub3cuZ2V0RGF0ZSgpfWA7XG4gICAgICAgIGxldCBvdXRwdXREaXIgPSBwYXRoLmpvaW4oYmFzZURpciwgZm9sZGVyKTtcblxuICAgICAgICBpZiAob3ZlcnJpZGUpIHJldHVybiBvdXRwdXREaXI7XG5cbiAgICAgICAgbGV0IG51bSA9IDE7XG5cbiAgICAgICAgd2hpbGUgKGZzLmV4aXN0c1N5bmMob3V0cHV0RGlyKSkge1xuICAgICAgICAgICAgbGV0IGZvbGRlcjIgPSBmb2xkZXIgKyAnXycgKyAoKytudW0pLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICBvdXRwdXREaXIgPSBwYXRoLmpvaW4oYmFzZURpciwgZm9sZGVyMik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3V0cHV0RGlyO1xuICAgIH1cblxuICAgIC8vIHZhbGlkYXRlIHBhcnNlZCBhbmQgZmlsbGVkIGFyZ3VtZW50IG9wdGlvbnMuXG4gICAgX3ZhbGlkYXRlQXJndigpIHtcbiAgICAgICAgbGV0IHZhbGlkID0gdHJ1ZTtcblxuICAgICAgICBfLmZvck93bih0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zLCAob3B0cywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlcXVpcmVkID0gb3B0cy5yZXF1aXJlZDtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1aXJlZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHJlcXVpcmVkID0gcmVxdWlyZWQoKTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlZCAmJiAhKG5hbWUgaW4gdGhpcy5hcmd2KSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEFyZ3VtZW50IFwiJHtuYW1lfVwiIGlzIHJlcXVpcmVkLmApO1xuICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB2YWxpZDtcbiAgICB9XG5cbiAgICAvLyBmaWxsIHRoZSBhcmd2IHdpdGggY29tbWFuZCBzcGVjaWZpYyBwcm9tcHQgZGVmYXVsdHNcbiAgICBfZmlsbENvbW1hbmREZWZhdWx0cyhjb21tYW5kT3B0aW9ucykge1xuICAgICAgICBfLmZvck93bihjb21tYW5kT3B0aW9ucywgKGluZm8sIG9wdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmFyZ3YuaGFzT3duUHJvcGVydHkob3B0aW9uKSAmJiBpbmZvLmhhc093blByb3BlcnR5KCdwcm9tcHREZWZhdWx0JykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3Zbb3B0aW9uXSA9IGluZm8ucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE9vbG9uZ0NvcmU7Il19