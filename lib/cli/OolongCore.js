"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

const {
  ServiceContainer
} = require('@k-suite/app');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);

        await this.startContainer();
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && opts.nonInquireFilter) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }

      if (name in this.argv && opts.onReady) {
        await opts.onReady(this.argv[name]);
      }
    });
  }

  async startContainer() {
    let configFile = this.option('config');
    let configFullPath = this.app.toAbsolutePath(configFile);

    if (!(await fs.exists(configFullPath))) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('OolongContainer', {
      workingPath: this.app.workingPath,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'loggers', 'mailer', 'settings', 'timezone', 'version']
    });
    this.container.logger = this.app.logger;
    return this.container.start_();
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    return this.container.config;
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        ...options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIlNlcnZpY2VDb250YWluZXIiLCJPb2xvbmdDb3JlIiwiY29uc3RydWN0b3IiLCJhcHAiLCJhcGkiLCJpbml0aWFsaXplXyIsInVzYWdlT3B0aW9ucyIsImNsb25lRGVlcCIsImNvbmZpZyIsImNvbW1hbmRMaW5lT3B0aW9ucyIsImZlYXR1cmVzIiwic2hvd1VzYWdlIiwiZXJyIiwiaW5qZWN0cyIsImFmdGVyQmFubmVyIiwibWVzc2FnZSIsImNvbW1hbmQiLCJhZnRlckNvbW1hbmRMaW5lIiwiY29tbWFuZHMiLCJyZWR1Y2UiLCJyZXN1bHQiLCJkZXNjIiwiY21kIiwiY29uc29sZSIsImxvZyIsImdldFVzYWdlIiwiYXJndiIsImNhbWVsQ2FzZSIsInVuZGVmaW5lZCIsImFjdGlvbl8iLCJjb21tYW5kT3B0aW9ucyIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJwYXJzZUFyZ3YiLCJvcHRpb24iLCJpbnF1aXJlXyIsIl9maWxsQ29tbWFuZERlZmF1bHRzIiwic3RhcnRDb250YWluZXIiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwib25SZWFkeSIsImNvbmZpZ0ZpbGUiLCJjb25maWdGdWxsUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiZXhpc3RzIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsImxvZ2dlciIsInN0YXJ0XyIsImdldENvbm5lY3Rpb25TdHJpbmdzIiwib29sb25nQ29uZmlnIiwiZm9yRWFjaCIsImRyaXZlciIsImNvbm5lY3RvcnMiLCJjb25uZWN0b3JPcHRpb25zIiwiY29ubmVjdG9yTmFtZSIsImNvbm5lY3Rpb24iLCJnZXRTY2hlbWFzSW5Db25maWciLCJzY2hlbWFzIiwiZ2V0VmFsdWVCeVBhdGgiLCJrZXlzIiwiZ2V0RGF0YXNldF8iLCJzY3JpcHRTb3VyY2VQYXRoIiwic2NoZW1hIiwiZGF0YXNldF8iLCJzY2hlbWFEZXBsb3ltZW50IiwibW9kZWxNYXBwaW5nIiwiaXNFbXB0eSIsIm1hcFZhbHVlcyIsIm1hcHBpbmciLCJzY2hlbWFOYW1lIiwiZGF0YVNvdXJjZSIsIm90aGVycyIsImNvbm5lY3Rpb25TdHJpbmciLCJnZXRSZXZlcnNlT3V0cHV0RGlyIiwiYmFzZURpciIsInByZWZpeCIsIm92ZXJyaWRlIiwibm93IiwiRGF0ZSIsImZvbGRlciIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwib3V0cHV0RGlyIiwiam9pbiIsIm51bSIsImV4aXN0c1N5bmMiLCJmb2xkZXIyIiwidG9TdHJpbmciLCJ2YWxpZCIsInJlcXVpcmVkIiwiZXJyb3IiLCJpbmZvIiwiaGFzT3duUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFB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LCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTsgXG5jb25zdCB7IF8sIGZzIH0gPSBVdGlsO1xuY29uc3QgaW5xdWlyZXIgPSByZXF1aXJlKCdpbnF1aXJlcicpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IENvbW1hbmRzID0gcmVxdWlyZSgnLi9jb21tYW5kcycpO1xuY29uc3QgT29sb25nQXBpID0gcmVxdWlyZSgnLi4vbGFuZy9hcGknKTtcbmNvbnN0IHsgbWFrZURhdGFTb3VyY2VOYW1lLCBTdXBwb3J0ZWREcml2ZXJzIH0gPSByZXF1aXJlKCcuLi91dGlscy9sYW5nJyk7XG5jb25zdCB7IFNlcnZpY2VDb250YWluZXIgfSA9IHJlcXVpcmUoJ0BrLXN1aXRlL2FwcCcpO1xuXG4vKipcbiAqIE9vbG9uZyBjb21tYW5kIGxpbmUgaGVscGVyIGNvcmUgY2xhc3MuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgT29sb25nQ29yZSB7XG4gICAgY29uc3RydWN0b3IoYXBwKSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLmFwaSA9IE9vbG9uZ0FwaTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogUmVwYXJzZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzIHdpdGggY29tbWFuZCBzcGVjaWZpYyBvcHRpb25zLlxuICAgICAqL1xuICAgIGFzeW5jIGluaXRpYWxpemVfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMudXNhZ2VPcHRpb25zID0gXy5jbG9uZURlZXAodGhpcy5hcHAuY29uZmlnLmNvbW1hbmRMaW5lT3B0aW9ucyk7XG4gICAgICAgIGxldCBjb21tYW5kTGluZU9wdGlvbnMgPSB0aGlzLmFwcC5mZWF0dXJlc1snY29tbWFuZExpbmVPcHRpb25zJ107XG5cbiAgICAgICAgdGhpcy5zaG93VXNhZ2UgPSAoZXJyKSA9PiB7XG4gICAgICAgICAgICBsZXQgaW5qZWN0cyA9IHt9O1xuXG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckJhbm5lciA9ICgpID0+IChlcnIubWVzc2FnZSB8fCBlcnIpICsgJ1xcblxcbic7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmNvbW1hbmQgJiYgdGhpcy5jb21tYW5kICE9PSAnbWFpbicpIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQ29tbWFuZExpbmUgPSAoKSA9PiBgQ29tbWFuZCBcIiR7dGhpcy5jb21tYW5kfVwiOiBgICsgQ29tbWFuZHMuY29tbWFuZHNbdGhpcy5jb21tYW5kXSArJ1xcblxcbic7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJDb21tYW5kTGluZSA9ICgpID0+ICdBdmFpbGFibGUgY29tbWFuZHM6XFxuJyArIF8ucmVkdWNlKENvbW1hbmRzLmNvbW1hbmRzLCAocmVzdWx0LCBkZXNjLCBjbWQpID0+IHJlc3VsdCArIGAgICR7Y21kfTogJHtkZXNjfVxcbmAsICcnKSArICdcXG4nXG4gICAgICAgICAgICB9ICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbW1hbmRMaW5lT3B0aW9ucy5nZXRVc2FnZSh0aGlzLmFwcCwgdGhpcy51c2FnZU9wdGlvbnMsIGluamVjdHMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vZXh0cmFjdCBtb2R1bGUgYW5kIGNvbW1hbmRcbiAgICAgICAgbGV0IGNvbW1hbmQgPSB0aGlzLmFwcC5hcmd2Ll9bMF07XG4gICAgICAgIFxuICAgICAgICB0aGlzLmNvbW1hbmQgPSBfLmNhbWVsQ2FzZShjb21tYW5kKTtcblxuICAgICAgICBpZiAodGhpcy5jb21tYW5kID09PSAnY29tbWFuZHMnIHx8IHRoaXMuY29tbWFuZCA9PT0gJ29wdGlvbnMnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmFjdGlvbl8gPSBDb21tYW5kc1t0aGlzLmNvbW1hbmRdO1xuXG4gICAgICAgIGlmICh0eXBlb2YgdGhpcy5hY3Rpb25fICE9PSAnZnVuY3Rpb24nKSB7ICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSB1bmRlZmluZWQ7ICAgXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29tbWFuZE9wdGlvbnMgPSBDb21tYW5kcy5vcHRpb25zKHRoaXMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIGNvbW1hbmRPcHRpb25zKTtcblxuICAgICAgICAvL3JlLXBhcnNlIGFyZ3VtZW50cyBhY2NvcmRpbmcgdG8gc2V0dGluZ3NcbiAgICAgICAgdGhpcy5hcmd2ID0gY29tbWFuZExpbmVPcHRpb25zLnBhcnNlQXJndih0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zKTsgICAgICAgIFxuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgIT09ICdtYWluJyAmJiAhdGhpcy5vcHRpb24oJz8nKSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbigncycpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5pbnF1aXJlXygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0Q29udGFpbmVyKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGVBcmd2KCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBvcHRpb24obmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcmd2W25hbWVdO1xuICAgIH0gICAgXG5cbiAgICBhc3luYyBleGVjdXRlXygpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9uKCc/JykpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1VzYWdlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25fKHRoaXMpO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGFzeW5jIGlucXVpcmVfKCkge1xuICAgICAgICBsZXQgZG9JbnF1aXJlID0gaXRlbSA9PiBpbnF1aXJlci5wcm9tcHQoW2l0ZW1dKS50aGVuKGFuc3dlcnMgPT4ge1xuICAgICAgICAgICAgXy5mb3JPd24oYW5zd2VycywgKGFucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltuYW1lXSA9IGFucztcbiAgICAgICAgICAgICAgICBsZXQgb3B0cyA9IHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnNbbmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKG9wdHMuYWxpYXMpIHtcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKG9wdHMuYWxpYXMsIGEgPT4geyB0aGlzLmFyZ3ZbYV0gPSBhbnM7IH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pOyBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBVdGlsLmVhY2hBc3luY18odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgYXN5bmMgKG9wdHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICgoJ2lucXVpcmUnIGluIG9wdHMpICYmICF0aGlzLmFyZ3ZbbmFtZV0pIHtcbiAgICAgICAgICAgICAgICBsZXQgaW5xdWlyZSA9IG9wdHMuaW5xdWlyZTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdHMuaW5xdWlyZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBpbnF1aXJlID0gYXdhaXQgb3B0cy5pbnF1aXJlKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGlucXVpcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHR5cGU7XG4gICAgICAgICAgICAgICAgICAgIGxldCBxID0geyBuYW1lOiBuYW1lLCBtZXNzYWdlOiBvcHRzLnByb21wdE1lc3NhZ2UgfHwgb3B0cy5kZXNjIH07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMucHJvbXB0VHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9IG9wdHMucHJvbXB0VHlwZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAnbGlzdCcgfHwgdHlwZSAgPT09ICdyYXdMaXN0JyB8fCB0eXBlID09PSAnY2hlY2tib3gnIHx8IHR5cGUgPT09ICdleHBhbmQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFvcHRzLmNob2ljZXNQcm92aWRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgY2hvaWNlcyBwcm92aWRlciEnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmNob2ljZXMgPSBhd2FpdCBvcHRzLmNob2ljZXNQcm92aWRlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuYm9vbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdjb25maXJtJztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnaW5wdXQnXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBxLnR5cGUgPSB0eXBlO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICgncHJvbXB0RGVmYXVsdCcgaW4gb3B0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLnByb21wdERlZmF1bHQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxLmRlZmF1bHQgPSBhd2FpdCBvcHRzLnByb21wdERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kZWZhdWx0ID0gb3B0cy5wcm9tcHREZWZhdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZG9JbnF1aXJlKHEpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmFmdGVySW5xdWlyZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3B0cy5hZnRlcklucXVpcmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lIGluIHRoaXMuYXJndiAmJiBvcHRzLm5vbklucXVpcmVGaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3ZbbmFtZV0gPSBhd2FpdCBvcHRzLm5vbklucXVpcmVGaWx0ZXIodGhpcy5hcmd2W25hbWVdKTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGlmIChuYW1lIGluIHRoaXMuYXJndiAmJiBvcHRzLm9uUmVhZHkpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBvcHRzLm9uUmVhZHkodGhpcy5hcmd2W25hbWVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRDb250YWluZXIoKSB7XG4gICAgICAgIGxldCBjb25maWdGaWxlID0gdGhpcy5vcHRpb24oJ2NvbmZpZycpO1xuICAgICAgICBcbiAgICAgICAgbGV0IGNvbmZpZ0Z1bGxQYXRoID0gdGhpcy5hcHAudG9BYnNvbHV0ZVBhdGgoY29uZmlnRmlsZSk7XG5cbiAgICAgICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGNvbmZpZ0Z1bGxQYXRoKSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29uZmlnIFwiJHtjb25maWdGaWxlfVwiIG5vdCBmb3VuZCFgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBleHROYW1lID0gcGF0aC5leHRuYW1lKGNvbmZpZ0Z1bGxQYXRoKTtcbiAgICAgICAgaWYgKGV4dE5hbWUgIT09ICcuanNvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignT25seSBzdXBwb3J0cyBKU09OIGNvbmZpZy4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb25maWdOYW1lID0gcGF0aC5iYXNlbmFtZShjb25maWdGdWxsUGF0aCwgZXh0TmFtZSk7XG4gICAgICAgIGxldCBjb25maWdQYXRoID0gcGF0aC5kaXJuYW1lKGNvbmZpZ0Z1bGxQYXRoKTtcbiAgICAgICAgbGV0IGVudkF3YXJlID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGNvbmZpZ05hbWUuZW5kc1dpdGgoJy5kZWZhdWx0JykpIHtcbiAgICAgICAgICAgIGVudkF3YXJlID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbmZpZ05hbWUgPSBjb25maWdOYW1lLnN1YnN0cigwLCBjb25maWdOYW1lLmxlbmd0aCAtIDgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIgPSBuZXcgU2VydmljZUNvbnRhaW5lcignT29sb25nQ29udGFpbmVyJywge1xuICAgICAgICAgICAgd29ya2luZ1BhdGg6IHRoaXMuYXBwLndvcmtpbmdQYXRoLFxuICAgICAgICAgICAgY29uZmlnUGF0aCxcbiAgICAgICAgICAgIGNvbmZpZ05hbWUsXG4gICAgICAgICAgICBkaXNhYmxlRW52QXdhcmVDb25maWc6ICFlbnZBd2FyZSxcbiAgICAgICAgICAgIGFsbG93ZWRGZWF0dXJlczogW1xuICAgICAgICAgICAgICAgICdjb25maWdCeUhvc3RuYW1lJywgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdkZXZDb25maWdCeUdpdFVzZXInLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnbG9nZ2VycycsXG4gICAgICAgICAgICAgICAgJ21haWxlcicsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICdzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgJ3RpbWV6b25lJyxcbiAgICAgICAgICAgICAgICAndmVyc2lvbidcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIubG9nZ2VyID0gdGhpcy5hcHAubG9nZ2VyO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY29ubmVjdGlvbiBzdHJpbmdzIGZyb20gYSBjb25maWcgZmlsZS5cbiAgICAgKiBAcGFyYW0geyp9IGNvbmYgLSBPb29sb25nIGNvbmZpZyBmaWxlLlxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0Q29ubmVjdGlvblN0cmluZ3MoKSB7XG4gICAgICAgIGxldCBjb25maWcgPSB0aGlzLm9vbG9uZ0NvbmZpZztcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgICAgICBcbiAgICAgICAgU3VwcG9ydGVkRHJpdmVycy5mb3JFYWNoKGRyaXZlciA9PiB7XG4gICAgICAgICAgICBsZXQgY29ubmVjdG9ycyA9IGNvbmZpZ1tkcml2ZXJdO1xuXG4gICAgICAgICAgICBpZiAoY29ubmVjdG9ycykge1xuICAgICAgICAgICAgICAgIF8uZm9yT3duKGNvbm5lY3RvcnMsIChjb25uZWN0b3JPcHRpb25zLCBjb25uZWN0b3JOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFttYWtlRGF0YVNvdXJjZU5hbWUoZHJpdmVyLCBjb25uZWN0b3JOYW1lKV0gPSBjb25uZWN0b3JPcHRpb25zLmNvbm5lY3Rpb247XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0U2NoZW1hc0luQ29uZmlnKCkge1xuICAgICAgICBsZXQgc2NoZW1hcyA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NoZW1hRGVwbG95bWVudCcpO1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoc2NoZW1hcyk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0RGF0YXNldF8oKSB7XG4gICAgICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gdGhpcy5hcHAudG9BYnNvbHV0ZVBhdGgoVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY3JpcHRTb3VyY2VEaXInKSk7XG5cbiAgICAgICAgbGV0IHNjaGVtYSA9IHRoaXMub3B0aW9uKCdzY2hlbWEnKTsgXG4gICAgICAgIGlmICghc2NoZW1hKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNjaGVtYSBhcmd1bWVudCBpcyByZXF1aXJlZCBmb3IgbGlzdGluZyBkYXRhc2V0LmApO1xuICAgICAgICB9ICBcblxuICAgICAgICByZXR1cm4gdGhpcy5hcGkuZGF0YXNldF8oXG4gICAgICAgICAgICB7IFxuICAgICAgICAgICAgICAgIGxvZ2dlcjogdGhpcy5hcHAubG9nZ2VyLFxuICAgICAgICAgICAgICAgIHNjcmlwdFNvdXJjZVBhdGgsIFxuICAgICAgICAgICAgICAgIHNjaGVtYURlcGxveW1lbnQ6IHRoaXMuc2NoZW1hRGVwbG95bWVudCBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY2hlbWFcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXQgb29sb25nQ29uZmlnKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb250YWluZXIuY29uZmlnO1xuICAgIH1cblxuICAgIGdldCBzY2hlbWFEZXBsb3ltZW50KCkge1xuICAgICAgICBsZXQgbW9kZWxNYXBwaW5nID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY2hlbWFEZXBsb3ltZW50Jyk7XG5cbiAgICAgICAgaWYgKF8uaXNFbXB0eShtb2RlbE1hcHBpbmcpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wic2NoZW1hRGVwbG95bWVudFwiIGlzIGVtcHR5LicpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIF8ubWFwVmFsdWVzKG1vZGVsTWFwcGluZywgKG1hcHBpbmcsIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCB7IGRhdGFTb3VyY2UsIC4uLm90aGVycyB9ID0gbWFwcGluZztcbiAgICBcbiAgICAgICAgICAgIGlmICghZGF0YVNvdXJjZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29uZmlndXJhdGlvbiBpdGVtIFwic2NoZW1hRGVwbG95bWVudC4ke3NjaGVtYU5hbWV9LmRhdGFTb3VyY2VcIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICBsZXQgeyBjb25uZWN0aW9uLCAuLi5vcHRpb25zIH0gPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnZGF0YVNvdXJjZS4nICsgZGF0YVNvdXJjZSwge30pO1xuICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25uZWN0aW9uIHN0cmluZyBvZiBkYXRhIHNvdXJjZSBcIiR7ZGF0YVNvdXJjZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICByZXR1cm4geyBkYXRhU291cmNlLCBjb25uZWN0aW9uU3RyaW5nOiBjb25uZWN0aW9uLCBvcHRpb25zLCAuLi5vdGhlcnMgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGRlZmF1bHQgb29sb25nIG91dHB1dCBwYXRoLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcmVmaXggXG4gICAgICogQHBhcmFtIHtib29sfSBvdmVycmlkZSBcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBPdXRwdXQgcGF0aCBvZiBvb2xvbmcgZ2VuZXJhdGVkIGZpbGVzLlxuICAgICAqL1xuICAgIGdldFJldmVyc2VPdXRwdXREaXIoYmFzZURpciwgcHJlZml4ID0gJycsIG92ZXJyaWRlID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBmb2xkZXIgPSBgJHtwcmVmaXh9JHtub3cuZ2V0RnVsbFllYXIoKX0tJHtub3cuZ2V0TW9udGgoKSsxfS0ke25vdy5nZXREYXRlKCl9YDtcbiAgICAgICAgbGV0IG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIpO1xuXG4gICAgICAgIGlmIChvdmVycmlkZSkgcmV0dXJuIG91dHB1dERpcjtcblxuICAgICAgICBsZXQgbnVtID0gMTtcblxuICAgICAgICB3aGlsZSAoZnMuZXhpc3RzU3luYyhvdXRwdXREaXIpKSB7XG4gICAgICAgICAgICBsZXQgZm9sZGVyMiA9IGZvbGRlciArICdfJyArICgrK251bSkudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIG91dHB1dERpciA9IHBhdGguam9pbihiYXNlRGlyLCBmb2xkZXIyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvdXRwdXREaXI7XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgcGFyc2VkIGFuZCBmaWxsZWQgYXJndW1lbnQgb3B0aW9ucy5cbiAgICBfdmFsaWRhdGVBcmd2KCkge1xuICAgICAgICBsZXQgdmFsaWQgPSB0cnVlO1xuXG4gICAgICAgIF8uZm9yT3duKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVxdWlyZWQgPSBvcHRzLnJlcXVpcmVkO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlcXVpcmVkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgcmVxdWlyZWQgPSByZXF1aXJlZCgpO1xuICAgICAgICAgICAgfSBcblxuICAgICAgICAgICAgaWYgKHJlcXVpcmVkICYmICEobmFtZSBpbiB0aGlzLmFyZ3YpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQXJndW1lbnQgXCIke25hbWV9XCIgaXMgcmVxdWlyZWQuYCk7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkO1xuICAgIH1cblxuICAgIC8vIGZpbGwgdGhlIGFyZ3Ygd2l0aCBjb21tYW5kIHNwZWNpZmljIHByb21wdCBkZWZhdWx0c1xuICAgIF9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKSB7XG4gICAgICAgIF8uZm9yT3duKGNvbW1hbmRPcHRpb25zLCAoaW5mbywgb3B0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYXJndi5oYXNPd25Qcm9wZXJ0eShvcHRpb24pICYmIGluZm8uaGFzT3duUHJvcGVydHkoJ3Byb21wdERlZmF1bHQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltvcHRpb25dID0gaW5mby5wcm9tcHREZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT29sb25nQ29yZTsiXX0=