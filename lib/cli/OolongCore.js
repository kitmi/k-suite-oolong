"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

const {
  ServiceContainer
} = require('@k-suite/app');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);

        await this.startContainer();
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !(name in this.argv)) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && opts.nonInquireFilter) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }

      if (name in this.argv && opts.onReady) {
        await opts.onReady(this.argv[name]);
      }
    });
  }

  async startContainer() {
    let configFile = this.option('config');
    let configFullPath = this.app.toAbsolutePath(configFile);

    if (!(await fs.exists(configFullPath))) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('OolongContainer', {
      workingPath: this.app.workingPath,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['configByHostname', 'devConfigByGitUser', 'loggers', 'mailer', 'settings', 'timezone', 'version', 'restClient', 'simpleCrawler', 'soapClient', 'oolong', 'dataSource']
    });
    this.container.logger = this.app.logger;
    return this.container.start_();
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    return this.container.config;
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        ...options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIlNlcnZpY2VDb250YWluZXIiLCJPb2xvbmdDb3JlIiwiY29uc3RydWN0b3IiLCJhcHAiLCJhcGkiLCJpbml0aWFsaXplXyIsInVzYWdlT3B0aW9ucyIsImNsb25lRGVlcCIsImNvbmZpZyIsImNvbW1hbmRMaW5lT3B0aW9ucyIsImZlYXR1cmVzIiwic2hvd1VzYWdlIiwiZXJyIiwiaW5qZWN0cyIsImFmdGVyQmFubmVyIiwibWVzc2FnZSIsImNvbW1hbmQiLCJhZnRlckNvbW1hbmRMaW5lIiwiY29tbWFuZHMiLCJyZWR1Y2UiLCJyZXN1bHQiLCJkZXNjIiwiY21kIiwiY29uc29sZSIsImxvZyIsImdldFVzYWdlIiwiYXJndiIsImNhbWVsQ2FzZSIsInVuZGVmaW5lZCIsImFjdGlvbl8iLCJjb21tYW5kT3B0aW9ucyIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJwYXJzZUFyZ3YiLCJvcHRpb24iLCJpbnF1aXJlXyIsIl9maWxsQ29tbWFuZERlZmF1bHRzIiwic3RhcnRDb250YWluZXIiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwib25SZWFkeSIsImNvbmZpZ0ZpbGUiLCJjb25maWdGdWxsUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiZXhpc3RzIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsImxvZ2dlciIsInN0YXJ0XyIsImdldENvbm5lY3Rpb25TdHJpbmdzIiwib29sb25nQ29uZmlnIiwiZm9yRWFjaCIsImRyaXZlciIsImNvbm5lY3RvcnMiLCJjb25uZWN0b3JPcHRpb25zIiwiY29ubmVjdG9yTmFtZSIsImNvbm5lY3Rpb24iLCJnZXRTY2hlbWFzSW5Db25maWciLCJzY2hlbWFzIiwiZ2V0VmFsdWVCeVBhdGgiLCJrZXlzIiwiZ2V0RGF0YXNldF8iLCJzY3JpcHRTb3VyY2VQYXRoIiwic2NoZW1hIiwiZGF0YXNldF8iLCJzY2hlbWFEZXBsb3ltZW50IiwibW9kZWxNYXBwaW5nIiwiaXNFbXB0eSIsIm1hcFZhbHVlcyIsIm1hcHBpbmciLCJzY2hlbWFOYW1lIiwiZGF0YVNvdXJjZSIsIm90aGVycyIsImNvbm5lY3Rpb25TdHJpbmciLCJnZXRSZXZlcnNlT3V0cHV0RGlyIiwiYmFzZURpciIsInByZWZpeCIsIm92ZXJyaWRlIiwibm93IiwiRGF0ZSIsImZvbGRlciIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwib3V0cHV0RGlyIiwiam9pbiIsIm51bSIsImV4aXN0c1N5bmMiLCJmb2xkZXIyIiwidG9TdHJpbmciLCJ2YWxpZCIsInJlcXVpcmVkIiwiZXJyb3IiLCJpbmZvIiwiaGFzT3duUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFB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S0g7O0FBN1RZOztBQWdVakJ1RSxNQUFNLENBQUNDLE9BQVAsR0FBaUJ0SSxVQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpOyBcbmNvbnN0IHsgXywgZnMgfSA9IFV0aWw7XG5jb25zdCBpbnF1aXJlciA9IHJlcXVpcmUoJ2lucXVpcmVyJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgQ29tbWFuZHMgPSByZXF1aXJlKCcuL2NvbW1hbmRzJyk7XG5jb25zdCBPb2xvbmdBcGkgPSByZXF1aXJlKCcuLi9sYW5nL2FwaScpO1xuY29uc3QgeyBtYWtlRGF0YVNvdXJjZU5hbWUsIFN1cHBvcnRlZERyaXZlcnMgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcbmNvbnN0IHsgU2VydmljZUNvbnRhaW5lciB9ID0gcmVxdWlyZSgnQGstc3VpdGUvYXBwJyk7XG5cbi8qKlxuICogT29sb25nIGNvbW1hbmQgbGluZSBoZWxwZXIgY29yZSBjbGFzcy5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBPb2xvbmdDb3JlIHtcbiAgICBjb25zdHJ1Y3RvcihhcHApIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuYXBpID0gT29sb25nQXBpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBSZXBhcnNlIGNvbW1hbmQgbGluZSBhcmd1bWVudHMgd2l0aCBjb21tYW5kIHNwZWNpZmljIG9wdGlvbnMuXG4gICAgICovXG4gICAgYXN5bmMgaW5pdGlhbGl6ZV8oKSB7ICAgICAgICBcbiAgICAgICAgdGhpcy51c2FnZU9wdGlvbnMgPSBfLmNsb25lRGVlcCh0aGlzLmFwcC5jb25maWcuY29tbWFuZExpbmVPcHRpb25zKTtcbiAgICAgICAgbGV0IGNvbW1hbmRMaW5lT3B0aW9ucyA9IHRoaXMuYXBwLmZlYXR1cmVzWydjb21tYW5kTGluZU9wdGlvbnMnXTtcblxuICAgICAgICB0aGlzLnNob3dVc2FnZSA9IChlcnIpID0+IHtcbiAgICAgICAgICAgIGxldCBpbmplY3RzID0ge307XG5cbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQmFubmVyID0gKCkgPT4gKGVyci5tZXNzYWdlIHx8IGVycikgKyAnXFxuXFxuJztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuY29tbWFuZCAmJiB0aGlzLmNvbW1hbmQgIT09ICdtYWluJykge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJDb21tYW5kTGluZSA9ICgpID0+IGBDb21tYW5kIFwiJHt0aGlzLmNvbW1hbmR9XCI6IGAgKyBDb21tYW5kcy5jb21tYW5kc1t0aGlzLmNvbW1hbmRdICsnXFxuXFxuJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckNvbW1hbmRMaW5lID0gKCkgPT4gJ0F2YWlsYWJsZSBjb21tYW5kczpcXG4nICsgXy5yZWR1Y2UoQ29tbWFuZHMuY29tbWFuZHMsIChyZXN1bHQsIGRlc2MsIGNtZCkgPT4gcmVzdWx0ICsgYCAgJHtjbWR9OiAke2Rlc2N9XFxuYCwgJycpICsgJ1xcbidcbiAgICAgICAgICAgIH0gICAgICAgICAgICBcblxuICAgICAgICAgICAgY29uc29sZS5sb2coY29tbWFuZExpbmVPcHRpb25zLmdldFVzYWdlKHRoaXMuYXBwLCB0aGlzLnVzYWdlT3B0aW9ucywgaW5qZWN0cykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9leHRyYWN0IG1vZHVsZSBhbmQgY29tbWFuZFxuICAgICAgICBsZXQgY29tbWFuZCA9IHRoaXMuYXBwLmFyZ3YuX1swXTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuY29tbWFuZCA9IF8uY2FtZWxDYXNlKGNvbW1hbmQpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgPT09ICdjb21tYW5kcycgfHwgdGhpcy5jb21tYW5kID09PSAnb3B0aW9ucycpIHtcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuYWN0aW9uXyA9IENvbW1hbmRzW3RoaXMuY29tbWFuZF07XG5cbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmFjdGlvbl8gIT09ICdmdW5jdGlvbicpIHsgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZCA9IHVuZGVmaW5lZDsgICBcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb21tYW5kT3B0aW9ucyA9IENvbW1hbmRzLm9wdGlvbnModGhpcyk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgY29tbWFuZE9wdGlvbnMpO1xuXG4gICAgICAgIC8vcmUtcGFyc2UgYXJndW1lbnRzIGFjY29yZGluZyB0byBzZXR0aW5nc1xuICAgICAgICB0aGlzLmFyZ3YgPSBjb21tYW5kTGluZU9wdGlvbnMucGFyc2VBcmd2KHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMpOyAgIFxuXG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmQgIT09ICdtYWluJyAmJiAhdGhpcy5vcHRpb24oJz8nKSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbigncycpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5pbnF1aXJlXygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9maWxsQ29tbWFuZERlZmF1bHRzKGNvbW1hbmRPcHRpb25zKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0Q29udGFpbmVyKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5fdmFsaWRhdGVBcmd2KCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBvcHRpb24obmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcmd2W25hbWVdO1xuICAgIH0gICAgXG5cbiAgICBhc3luYyBleGVjdXRlXygpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9uKCc/JykpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1VzYWdlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25fKHRoaXMpO1xuICAgICAgICB9XG4gICAgfSAgICBcblxuICAgIGFzeW5jIGlucXVpcmVfKCkge1xuICAgICAgICBsZXQgZG9JbnF1aXJlID0gaXRlbSA9PiBpbnF1aXJlci5wcm9tcHQoW2l0ZW1dKS50aGVuKGFuc3dlcnMgPT4ge1xuICAgICAgICAgICAgXy5mb3JPd24oYW5zd2VycywgKGFucywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYXJndltuYW1lXSA9IGFucztcbiAgICAgICAgICAgICAgICBsZXQgb3B0cyA9IHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnNbbmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKG9wdHMuYWxpYXMpIHtcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKG9wdHMuYWxpYXMsIGEgPT4geyB0aGlzLmFyZ3ZbYV0gPSBhbnM7IH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pOyBcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBVdGlsLmVhY2hBc3luY18odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgYXN5bmMgKG9wdHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICgoJ2lucXVpcmUnIGluIG9wdHMpICYmICEobmFtZSBpbiB0aGlzLmFyZ3YpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlucXVpcmUgPSBvcHRzLmlucXVpcmU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLmlucXVpcmUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5xdWlyZSA9IGF3YWl0IG9wdHMuaW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0eXBlO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcSA9IHsgbmFtZTogbmFtZSwgbWVzc2FnZTogb3B0cy5wcm9tcHRNZXNzYWdlIHx8IG9wdHMuZGVzYyB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLnByb21wdFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBvcHRzLnByb21wdFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2xpc3QnIHx8IHR5cGUgID09PSAncmF3TGlzdCcgfHwgdHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0eXBlID09PSAnZXhwYW5kJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3B0cy5jaG9pY2VzUHJvdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGNob2ljZXMgcHJvdmlkZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5jaG9pY2VzID0gYXdhaXQgb3B0cy5jaG9pY2VzUHJvdmlkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmJvb2wpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnY29uZmlybSc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2lucHV0J1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcS50eXBlID0gdHlwZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoJ3Byb21wdERlZmF1bHQnIGluIG9wdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5wcm9tcHREZWZhdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kZWZhdWx0ID0gYXdhaXQgb3B0cy5wcm9tcHREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IG9wdHMucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvSW5xdWlyZShxKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5hZnRlcklucXVpcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG9wdHMuYWZ0ZXJJbnF1aXJlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZSBpbiB0aGlzLmFyZ3YgJiYgb3B0cy5ub25JbnF1aXJlRmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYXdhaXQgb3B0cy5ub25JbnF1aXJlRmlsdGVyKHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmFyZ3YgJiYgb3B0cy5vblJlYWR5KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgb3B0cy5vblJlYWR5KHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0Q29udGFpbmVyKCkge1xuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMub3B0aW9uKCdjb25maWcnKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBjb25maWdGdWxsUGF0aCA9IHRoaXMuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbmZpZ0ZpbGUpO1xuXG4gICAgICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyhjb25maWdGdWxsUGF0aCkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZyBcIiR7Y29uZmlnRmlsZX1cIiBub3QgZm91bmQhYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZXh0TmFtZSA9IHBhdGguZXh0bmFtZShjb25maWdGdWxsUGF0aCk7XG4gICAgICAgIGlmIChleHROYW1lICE9PSAnLmpzb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgc3VwcG9ydHMgSlNPTiBjb25maWcuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29uZmlnTmFtZSA9IHBhdGguYmFzZW5hbWUoY29uZmlnRnVsbFBhdGgsIGV4dE5hbWUpO1xuICAgICAgICBsZXQgY29uZmlnUGF0aCA9IHBhdGguZGlybmFtZShjb25maWdGdWxsUGF0aCk7XG4gICAgICAgIGxldCBlbnZBd2FyZSA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChjb25maWdOYW1lLmVuZHNXaXRoKCcuZGVmYXVsdCcpKSB7XG4gICAgICAgICAgICBlbnZBd2FyZSA9IHRydWU7XG4gICAgICAgICAgICBjb25maWdOYW1lID0gY29uZmlnTmFtZS5zdWJzdHIoMCwgY29uZmlnTmFtZS5sZW5ndGggLSA4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFNlcnZpY2VDb250YWluZXIoJ09vbG9uZ0NvbnRhaW5lcicsIHtcbiAgICAgICAgICAgIHdvcmtpbmdQYXRoOiB0aGlzLmFwcC53b3JraW5nUGF0aCxcbiAgICAgICAgICAgIGNvbmZpZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdOYW1lLFxuICAgICAgICAgICAgZGlzYWJsZUVudkF3YXJlQ29uZmlnOiAhZW52QXdhcmUsXG4gICAgICAgICAgICBhbGxvd2VkRmVhdHVyZXM6IFtcbiAgICAgICAgICAgICAgICAnY29uZmlnQnlIb3N0bmFtZScsICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGV2Q29uZmlnQnlHaXRVc2VyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2xvZ2dlcnMnLFxuICAgICAgICAgICAgICAgICdtYWlsZXInLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnc2V0dGluZ3MnLFxuICAgICAgICAgICAgICAgICd0aW1lem9uZScsXG4gICAgICAgICAgICAgICAgJ3ZlcnNpb24nLFxuICAgICAgICAgICAgICAgICdyZXN0Q2xpZW50JyxcbiAgICAgICAgICAgICAgICAnc2ltcGxlQ3Jhd2xlcicsXG4gICAgICAgICAgICAgICAgJ3NvYXBDbGllbnQnLFxuICAgICAgICAgICAgICAgICdvb2xvbmcnLFxuICAgICAgICAgICAgICAgICdkYXRhU291cmNlJ1xuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lci5sb2dnZXIgPSB0aGlzLmFwcC5sb2dnZXI7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGFpbmVyLnN0YXJ0XygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBjb25uZWN0aW9uIHN0cmluZ3MgZnJvbSBhIGNvbmZpZyBmaWxlLlxuICAgICAqIEBwYXJhbSB7Kn0gY29uZiAtIE9vb2xvbmcgY29uZmlnIGZpbGUuXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXRDb25uZWN0aW9uU3RyaW5ncygpIHtcbiAgICAgICAgbGV0IGNvbmZpZyA9IHRoaXMub29sb25nQ29uZmlnO1xuICAgICAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgICAgIFxuICAgICAgICBTdXBwb3J0ZWREcml2ZXJzLmZvckVhY2goZHJpdmVyID0+IHtcbiAgICAgICAgICAgIGxldCBjb25uZWN0b3JzID0gY29uZmlnW2RyaXZlcl07XG5cbiAgICAgICAgICAgIGlmIChjb25uZWN0b3JzKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24oY29ubmVjdG9ycywgKGNvbm5lY3Rvck9wdGlvbnMsIGNvbm5lY3Rvck5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0W21ha2VEYXRhU291cmNlTmFtZShkcml2ZXIsIGNvbm5lY3Rvck5hbWUpXSA9IGNvbm5lY3Rvck9wdGlvbnMuY29ubmVjdGlvbjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRTY2hlbWFzSW5Db25maWcoKSB7XG4gICAgICAgIGxldCBzY2hlbWFzID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ29vbG9uZy5zY2hlbWFEZXBsb3ltZW50Jyk7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhzY2hlbWFzKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXREYXRhc2V0XygpIHtcbiAgICAgICAgbGV0IHNjcmlwdFNvdXJjZVBhdGggPSB0aGlzLmFwcC50b0Fic29sdXRlUGF0aChVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdFNvdXJjZURpcicpKTtcblxuICAgICAgICBsZXQgc2NoZW1hID0gdGhpcy5vcHRpb24oJ3NjaGVtYScpOyBcbiAgICAgICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2NoZW1hIGFyZ3VtZW50IGlzIHJlcXVpcmVkIGZvciBsaXN0aW5nIGRhdGFzZXQuYCk7XG4gICAgICAgIH0gIFxuXG4gICAgICAgIHJldHVybiB0aGlzLmFwaS5kYXRhc2V0XyhcbiAgICAgICAgICAgIHsgXG4gICAgICAgICAgICAgICAgbG9nZ2VyOiB0aGlzLmFwcC5sb2dnZXIsXG4gICAgICAgICAgICAgICAgc2NyaXB0U291cmNlUGF0aCwgXG4gICAgICAgICAgICAgICAgc2NoZW1hRGVwbG95bWVudDogdGhpcy5zY2hlbWFEZXBsb3ltZW50IFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNjaGVtYVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldCBvb2xvbmdDb25maWcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5jb25maWc7XG4gICAgfVxuXG4gICAgZ2V0IHNjaGVtYURlcGxveW1lbnQoKSB7XG4gICAgICAgIGxldCBtb2RlbE1hcHBpbmcgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjaGVtYURlcGxveW1lbnQnKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KG1vZGVsTWFwcGluZykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignXCJzY2hlbWFEZXBsb3ltZW50XCIgaXMgZW1wdHkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gXy5tYXBWYWx1ZXMobW9kZWxNYXBwaW5nLCAobWFwcGluZywgc2NoZW1hTmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHsgZGF0YVNvdXJjZSwgLi4ub3RoZXJzIH0gPSBtYXBwaW5nO1xuICAgIFxuICAgICAgICAgICAgaWYgKCFkYXRhU291cmNlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWd1cmF0aW9uIGl0ZW0gXCJzY2hlbWFEZXBsb3ltZW50LiR7c2NoZW1hTmFtZX0uZGF0YVNvdXJjZVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIGxldCB7IGNvbm5lY3Rpb24sIC4uLm9wdGlvbnMgfSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBkYXRhU291cmNlLCB7fSk7XG4gICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbm5lY3Rpb24gc3RyaW5nIG9mIGRhdGEgc291cmNlIFwiJHtkYXRhU291cmNlfVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIHJldHVybiB7IGRhdGFTb3VyY2UsIGNvbm5lY3Rpb25TdHJpbmc6IGNvbm5lY3Rpb24sIG9wdGlvbnMsIC4uLm90aGVycyB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgZGVmYXVsdCBvb2xvbmcgb3V0cHV0IHBhdGguXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHByZWZpeCBcbiAgICAgKiBAcGFyYW0ge2Jvb2x9IG92ZXJyaWRlIFxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE91dHB1dCBwYXRoIG9mIG9vbG9uZyBnZW5lcmF0ZWQgZmlsZXMuXG4gICAgICovXG4gICAgZ2V0UmV2ZXJzZU91dHB1dERpcihiYXNlRGlyLCBwcmVmaXggPSAnJywgb3ZlcnJpZGUgPSBmYWxzZSkge1xuICAgICAgICBsZXQgbm93ID0gbmV3IERhdGUoKTtcbiAgICAgICAgbGV0IGZvbGRlciA9IGAke3ByZWZpeH0ke25vdy5nZXRGdWxsWWVhcigpfS0ke25vdy5nZXRNb250aCgpKzF9LSR7bm93LmdldERhdGUoKX1gO1xuICAgICAgICBsZXQgb3V0cHV0RGlyID0gcGF0aC5qb2luKGJhc2VEaXIsIGZvbGRlcik7XG5cbiAgICAgICAgaWYgKG92ZXJyaWRlKSByZXR1cm4gb3V0cHV0RGlyO1xuXG4gICAgICAgIGxldCBudW0gPSAxO1xuXG4gICAgICAgIHdoaWxlIChmcy5leGlzdHNTeW5jKG91dHB1dERpcikpIHtcbiAgICAgICAgICAgIGxldCBmb2xkZXIyID0gZm9sZGVyICsgJ18nICsgKCsrbnVtKS50b1N0cmluZygpO1xuICAgICAgICAgICAgb3V0cHV0RGlyID0gcGF0aC5qb2luKGJhc2VEaXIsIGZvbGRlcjIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG91dHB1dERpcjtcbiAgICB9XG5cbiAgICAvLyB2YWxpZGF0ZSBwYXJzZWQgYW5kIGZpbGxlZCBhcmd1bWVudCBvcHRpb25zLlxuICAgIF92YWxpZGF0ZUFyZ3YoKSB7XG4gICAgICAgIGxldCB2YWxpZCA9IHRydWU7XG5cbiAgICAgICAgXy5mb3JPd24odGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucywgKG9wdHMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCByZXF1aXJlZCA9IG9wdHMucmVxdWlyZWQ7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVxdWlyZWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICByZXF1aXJlZCA9IHJlcXVpcmVkKCk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBpZiAocmVxdWlyZWQgJiYgIShuYW1lIGluIHRoaXMuYXJndikpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBcmd1bWVudCBcIiR7bmFtZX1cIiBpcyByZXF1aXJlZC5gKTtcbiAgICAgICAgICAgICAgICB2YWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdmFsaWQ7XG4gICAgfVxuXG4gICAgLy8gZmlsbCB0aGUgYXJndiB3aXRoIGNvbW1hbmQgc3BlY2lmaWMgcHJvbXB0IGRlZmF1bHRzXG4gICAgX2ZpbGxDb21tYW5kRGVmYXVsdHMoY29tbWFuZE9wdGlvbnMpIHtcbiAgICAgICAgXy5mb3JPd24oY29tbWFuZE9wdGlvbnMsIChpbmZvLCBvcHRpb24pID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5hcmd2Lmhhc093blByb3BlcnR5KG9wdGlvbikgJiYgaW5mby5oYXNPd25Qcm9wZXJ0eSgncHJvbXB0RGVmYXVsdCcpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W29wdGlvbl0gPSBpbmZvLnByb21wdERlZmF1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBPb2xvbmdDb3JlOyJdfQ==