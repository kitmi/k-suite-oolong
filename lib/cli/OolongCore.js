"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const inquirer = require('inquirer');

const path = require('path');

const Commands = require('./commands');

const OolongApi = require('../lang/api');

const {
  makeDataSourceName,
  SupportedDrivers
} = require('../utils/lang');

const {
  ServiceContainer
} = require('@k-suite/app');

class OolongCore {
  constructor(app) {
    this.app = app;
    this.api = OolongApi;
  }

  async initialize_() {
    this.usageOptions = _.cloneDeep(this.app.config.commandLineOptions);
    let commandLineOptions = this.app.features['commandLineOptions'];

    this.showUsage = err => {
      let injects = {};

      if (err) {
        injects.afterBanner = () => (err.message || err) + '\n\n';
      }

      if (this.command && this.command !== 'main') {
        injects.afterCommandLine = () => `Command "${this.command}": ` + Commands.commands[this.command] + '\n\n';
      } else {
        injects.afterCommandLine = () => 'Available commands:\n' + _.reduce(Commands.commands, (result, desc, cmd) => result + `  ${cmd}: ${desc}\n`, '') + '\n';
      }

      console.log(commandLineOptions.getUsage(this.app, this.usageOptions, injects));
    };

    let command = this.app.argv._[0];
    this.command = _.camelCase(command);

    if (this.command === 'commands' || this.command === 'options') {
      this.command = undefined;
      return false;
    }

    this.action_ = Commands[this.command];

    if (typeof this.action_ !== 'function') {
      this.command = undefined;
      return false;
    }

    let commandOptions = Commands.options(this);
    Object.assign(this.usageOptions.options, commandOptions);
    this.argv = commandLineOptions.parseArgv(this.usageOptions.options);

    if (this.command !== 'main' && !this.option('?')) {
      if (!this.option('s')) {
        await this.inquire_();
      } else {
        this._fillCommandDefaults(commandOptions);

        await this.startContainer();
      }

      if (!this._validateArgv()) {
        return false;
      }
    }

    return true;
  }

  option(name) {
    return this.argv[name];
  }

  async execute_() {
    if (this.option('?')) {
      this.showUsage();
    } else {
      return this.action_(this);
    }
  }

  async inquire_() {
    let doInquire = item => inquirer.prompt([item]).then(answers => {
      _.forOwn(answers, (ans, name) => {
        this.argv[name] = ans;
        let opts = this.usageOptions.options[name];

        if (opts.alias) {
          _.each(opts.alias, a => {
            this.argv[a] = ans;
          });
        }
      });
    });

    return Util.eachAsync_(this.usageOptions.options, async (opts, name) => {
      if ('inquire' in opts && !this.argv[name]) {
        let inquire = opts.inquire;

        if (typeof opts.inquire === 'function') {
          inquire = await opts.inquire();
        }

        if (inquire) {
          let type;
          let q = {
            name: name,
            message: opts.promptMessage || opts.desc
          };

          if (opts.promptType) {
            type = opts.promptType;

            if (type === 'list' || type === 'rawList' || type === 'checkbox' || type === 'expand') {
              if (!opts.choicesProvider) {
                throw new Error('Missing choices provider!');
              }

              q.choices = await opts.choicesProvider();
            }
          } else if (opts.bool) {
            type = 'confirm';
          } else {
            type = 'input';
          }

          q.type = type;

          if ('promptDefault' in opts) {
            if (typeof opts.promptDefault === 'function') {
              q.default = await opts.promptDefault();
            } else {
              q.default = opts.promptDefault;
            }
          }

          await doInquire(q);

          if (opts.afterInquire) {
            await opts.afterInquire();
          }

          console.log();
        }
      } else if (name in this.argv && opts.nonInquireFilter) {
        this.argv[name] = await opts.nonInquireFilter(this.argv[name]);
      }

      if (name in this.argv && opts.onReady) {
        await opts.onReady(this.argv[name]);
      }
    });
  }

  async startContainer() {
    let configFile = this.option('config');
    let configFullPath = this.app.toAbsolutePath(configFile);

    if (!(await fs.exists(configFullPath))) {
      throw new Error(`Config "${configFile}" not found!`);
    }

    let extName = path.extname(configFullPath);

    if (extName !== '.json') {
      throw new Error('Only supports JSON config.');
    }

    let configName = path.basename(configFullPath, extName);
    let configPath = path.dirname(configFullPath);
    let envAware = false;

    if (configName.endsWith('.default')) {
      envAware = true;
      configName = configName.substr(0, configName.length - 8);
    }

    this.container = new ServiceContainer('OolongContainer', {
      workingPath: this.app.workingPath,
      configPath,
      configName,
      disableEnvAwareConfig: !envAware,
      allowedFeatures: ['bootstrap', 'configByHostname', 'devConfigByGitUser', 'loggers', 'mailer', 'settings', 'timezone', 'version']
    });
    this.container.logger = this.app.logger;
    return this.container.start_();
  }

  getConnectionStrings() {
    let config = this.oolongConfig;
    let result = {};
    SupportedDrivers.forEach(driver => {
      let connectors = config[driver];

      if (connectors) {
        _.forOwn(connectors, (connectorOptions, connectorName) => {
          result[makeDataSourceName(driver, connectorName)] = connectorOptions.connection;
        });
      }
    });
    return result;
  }

  getSchemasInConfig() {
    let schemas = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');
    return Object.keys(schemas);
  }

  async getDataset_() {
    let scriptSourcePath = this.app.toAbsolutePath(Util.getValueByPath(this.oolongConfig, 'oolong.scriptSourceDir'));
    let schema = this.option('schema');

    if (!schema) {
      throw new Error(`Schema argument is required for listing dataset.`);
    }

    return this.api.dataset_({
      logger: this.app.logger,
      scriptSourcePath,
      schemaDeployment: this.schemaDeployment
    }, schema);
  }

  get oolongConfig() {
    return this.container.config;
  }

  get schemaDeployment() {
    let modelMapping = Util.getValueByPath(this.oolongConfig, 'oolong.schemaDeployment');

    if (_.isEmpty(modelMapping)) {
      throw new Error('"schemaDeployment" is empty.');
    }

    return _.mapValues(modelMapping, (mapping, schemaName) => {
      let {
        dataSource,
        ...others
      } = mapping;

      if (!dataSource) {
        throw new Error(`Configuration item "schemaDeployment.${schemaName}.dataSource" not found.`);
      }

      let {
        connection,
        ...options
      } = Util.getValueByPath(this.oolongConfig, 'dataSource.' + dataSource, {});

      if (!connection) {
        throw new Error(`Connection string of data source "${dataSource}" not found.`);
      }

      return {
        dataSource,
        connectionString: connection,
        options,
        ...others
      };
    });
  }

  getReverseOutputDir(baseDir, prefix = '', override = false) {
    let now = new Date();
    let folder = `${prefix}${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
    let outputDir = path.join(baseDir, folder);
    if (override) return outputDir;
    let num = 1;

    while (fs.existsSync(outputDir)) {
      let folder2 = folder + '_' + (++num).toString();
      outputDir = path.join(baseDir, folder2);
    }

    return outputDir;
  }

  _validateArgv() {
    let valid = true;

    _.forOwn(this.usageOptions.options, (opts, name) => {
      let required = opts.required;

      if (typeof required === 'function') {
        required = required();
      }

      if (required && !(name in this.argv)) {
        console.error(`Argument "${name}" is required.`);
        valid = false;
      }
    });

    return valid;
  }

  _fillCommandDefaults(commandOptions) {
    _.forOwn(commandOptions, (info, option) => {
      if (!this.argv.hasOwnProperty(option) && info.hasOwnProperty('promptDefault')) {
        this.argv[option] = info.promptDefault;
      }
    });
  }

}

module.exports = OolongCore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvT29sb25nQ29yZS5qcyJdLCJuYW1lcyI6WyJVdGlsIiwicmVxdWlyZSIsIl8iLCJmcyIsImlucXVpcmVyIiwicGF0aCIsIkNvbW1hbmRzIiwiT29sb25nQXBpIiwibWFrZURhdGFTb3VyY2VOYW1lIiwiU3VwcG9ydGVkRHJpdmVycyIsIlNlcnZpY2VDb250YWluZXIiLCJPb2xvbmdDb3JlIiwiY29uc3RydWN0b3IiLCJhcHAiLCJhcGkiLCJpbml0aWFsaXplXyIsInVzYWdlT3B0aW9ucyIsImNsb25lRGVlcCIsImNvbmZpZyIsImNvbW1hbmRMaW5lT3B0aW9ucyIsImZlYXR1cmVzIiwic2hvd1VzYWdlIiwiZXJyIiwiaW5qZWN0cyIsImFmdGVyQmFubmVyIiwibWVzc2FnZSIsImNvbW1hbmQiLCJhZnRlckNvbW1hbmRMaW5lIiwiY29tbWFuZHMiLCJyZWR1Y2UiLCJyZXN1bHQiLCJkZXNjIiwiY21kIiwiY29uc29sZSIsImxvZyIsImdldFVzYWdlIiwiYXJndiIsImNhbWVsQ2FzZSIsInVuZGVmaW5lZCIsImFjdGlvbl8iLCJjb21tYW5kT3B0aW9ucyIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJwYXJzZUFyZ3YiLCJvcHRpb24iLCJpbnF1aXJlXyIsIl9maWxsQ29tbWFuZERlZmF1bHRzIiwic3RhcnRDb250YWluZXIiLCJfdmFsaWRhdGVBcmd2IiwibmFtZSIsImV4ZWN1dGVfIiwiZG9JbnF1aXJlIiwiaXRlbSIsInByb21wdCIsInRoZW4iLCJhbnN3ZXJzIiwiZm9yT3duIiwiYW5zIiwib3B0cyIsImFsaWFzIiwiZWFjaCIsImEiLCJlYWNoQXN5bmNfIiwiaW5xdWlyZSIsInR5cGUiLCJxIiwicHJvbXB0TWVzc2FnZSIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJFcnJvciIsImNob2ljZXMiLCJib29sIiwicHJvbXB0RGVmYXVsdCIsImRlZmF1bHQiLCJhZnRlcklucXVpcmUiLCJub25JbnF1aXJlRmlsdGVyIiwib25SZWFkeSIsImNvbmZpZ0ZpbGUiLCJjb25maWdGdWxsUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiZXhpc3RzIiwiZXh0TmFtZSIsImV4dG5hbWUiLCJjb25maWdOYW1lIiwiYmFzZW5hbWUiLCJjb25maWdQYXRoIiwiZGlybmFtZSIsImVudkF3YXJlIiwiZW5kc1dpdGgiLCJzdWJzdHIiLCJsZW5ndGgiLCJjb250YWluZXIiLCJ3b3JraW5nUGF0aCIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImFsbG93ZWRGZWF0dXJlcyIsImxvZ2dlciIsInN0YXJ0XyIsImdldENvbm5lY3Rpb25TdHJpbmdzIiwib29sb25nQ29uZmlnIiwiZm9yRWFjaCIsImRyaXZlciIsImNvbm5lY3RvcnMiLCJjb25uZWN0b3JPcHRpb25zIiwiY29ubmVjdG9yTmFtZSIsImNvbm5lY3Rpb24iLCJnZXRTY2hlbWFzSW5Db25maWciLCJzY2hlbWFzIiwiZ2V0VmFsdWVCeVBhdGgiLCJrZXlzIiwiZ2V0RGF0YXNldF8iLCJzY3JpcHRTb3VyY2VQYXRoIiwic2NoZW1hIiwiZGF0YXNldF8iLCJzY2hlbWFEZXBsb3ltZW50IiwibW9kZWxNYXBwaW5nIiwiaXNFbXB0eSIsIm1hcFZhbHVlcyIsIm1hcHBpbmciLCJzY2hlbWFOYW1lIiwiZGF0YVNvdXJjZSIsIm90aGVycyIsImNvbm5lY3Rpb25TdHJpbmciLCJnZXRSZXZlcnNlT3V0cHV0RGlyIiwiYmFzZURpciIsInByZWZpeCIsIm92ZXJyaWRlIiwibm93IiwiRGF0ZSIsImZvbGRlciIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwib3V0cHV0RGlyIiwiam9pbiIsIm51bSIsImV4aXN0c1N5bmMiLCJmb2xkZXIyIiwidG9TdHJpbmciLCJ2YWxpZCIsInJlcXVpcmVkIiwiZXJyb3IiLCJpbmZvIiwiaGFzT3duUHJvcGVydHkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFB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QnRJLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7IFxuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IGlucXVpcmVyID0gcmVxdWlyZSgnaW5xdWlyZXInKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBDb21tYW5kcyA9IHJlcXVpcmUoJy4vY29tbWFuZHMnKTtcbmNvbnN0IE9vbG9uZ0FwaSA9IHJlcXVpcmUoJy4uL2xhbmcvYXBpJyk7XG5jb25zdCB7IG1ha2VEYXRhU291cmNlTmFtZSwgU3VwcG9ydGVkRHJpdmVycyB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuY29uc3QgeyBTZXJ2aWNlQ29udGFpbmVyIH0gPSByZXF1aXJlKCdAay1zdWl0ZS9hcHAnKTtcblxuLyoqXG4gKiBPb2xvbmcgY29tbWFuZCBsaW5lIGhlbHBlciBjb3JlIGNsYXNzLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIE9vbG9uZ0NvcmUge1xuICAgIGNvbnN0cnVjdG9yKGFwcCkge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICAgICAgdGhpcy5hcGkgPSBPb2xvbmdBcGk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFJlcGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50cyB3aXRoIGNvbW1hbmQgc3BlY2lmaWMgb3B0aW9ucy5cbiAgICAgKi9cbiAgICBhc3luYyBpbml0aWFsaXplXygpIHsgICAgICAgIFxuICAgICAgICB0aGlzLnVzYWdlT3B0aW9ucyA9IF8uY2xvbmVEZWVwKHRoaXMuYXBwLmNvbmZpZy5jb21tYW5kTGluZU9wdGlvbnMpO1xuICAgICAgICBsZXQgY29tbWFuZExpbmVPcHRpb25zID0gdGhpcy5hcHAuZmVhdHVyZXNbJ2NvbW1hbmRMaW5lT3B0aW9ucyddO1xuXG4gICAgICAgIHRoaXMuc2hvd1VzYWdlID0gKGVycikgPT4ge1xuICAgICAgICAgICAgbGV0IGluamVjdHMgPSB7fTtcblxuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGluamVjdHMuYWZ0ZXJCYW5uZXIgPSAoKSA9PiAoZXJyLm1lc3NhZ2UgfHwgZXJyKSArICdcXG5cXG4nO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5jb21tYW5kICYmIHRoaXMuY29tbWFuZCAhPT0gJ21haW4nKSB7XG4gICAgICAgICAgICAgICAgaW5qZWN0cy5hZnRlckNvbW1hbmRMaW5lID0gKCkgPT4gYENvbW1hbmQgXCIke3RoaXMuY29tbWFuZH1cIjogYCArIENvbW1hbmRzLmNvbW1hbmRzW3RoaXMuY29tbWFuZF0gKydcXG5cXG4nO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbmplY3RzLmFmdGVyQ29tbWFuZExpbmUgPSAoKSA9PiAnQXZhaWxhYmxlIGNvbW1hbmRzOlxcbicgKyBfLnJlZHVjZShDb21tYW5kcy5jb21tYW5kcywgKHJlc3VsdCwgZGVzYywgY21kKSA9PiByZXN1bHQgKyBgICAke2NtZH06ICR7ZGVzY31cXG5gLCAnJykgKyAnXFxuJ1xuICAgICAgICAgICAgfSAgICAgICAgICAgIFxuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjb21tYW5kTGluZU9wdGlvbnMuZ2V0VXNhZ2UodGhpcy5hcHAsIHRoaXMudXNhZ2VPcHRpb25zLCBpbmplY3RzKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvL2V4dHJhY3QgbW9kdWxlIGFuZCBjb21tYW5kXG4gICAgICAgIGxldCBjb21tYW5kID0gdGhpcy5hcHAuYXJndi5fWzBdO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5jb21tYW5kID0gXy5jYW1lbENhc2UoY29tbWFuZCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29tbWFuZCA9PT0gJ2NvbW1hbmRzJyB8fCB0aGlzLmNvbW1hbmQgPT09ICdvcHRpb25zJykge1xuICAgICAgICAgICAgdGhpcy5jb21tYW5kID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9ICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5hY3Rpb25fID0gQ29tbWFuZHNbdGhpcy5jb21tYW5kXTtcblxuICAgICAgICBpZiAodHlwZW9mIHRoaXMuYWN0aW9uXyAhPT0gJ2Z1bmN0aW9uJykgeyAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5jb21tYW5kID0gdW5kZWZpbmVkOyAgIFxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbW1hbmRPcHRpb25zID0gQ29tbWFuZHMub3B0aW9ucyh0aGlzKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zLCBjb21tYW5kT3B0aW9ucyk7XG5cbiAgICAgICAgLy9yZS1wYXJzZSBhcmd1bWVudHMgYWNjb3JkaW5nIHRvIHNldHRpbmdzXG4gICAgICAgIHRoaXMuYXJndiA9IGNvbW1hbmRMaW5lT3B0aW9ucy5wYXJzZUFyZ3YodGhpcy51c2FnZU9wdGlvbnMub3B0aW9ucyk7ICAgICAgICBcblxuICAgICAgICBpZiAodGhpcy5jb21tYW5kICE9PSAnbWFpbicgJiYgIXRoaXMub3B0aW9uKCc/JykpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb24oJ3MnKSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuaW5xdWlyZV8oKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZmlsbENvbW1hbmREZWZhdWx0cyhjb21tYW5kT3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFydENvbnRhaW5lcigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlQXJndigpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgb3B0aW9uKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXJndltuYW1lXTtcbiAgICB9ICAgIFxuXG4gICAgYXN5bmMgZXhlY3V0ZV8oKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbignPycpKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dVc2FnZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWN0aW9uXyh0aGlzKTtcbiAgICAgICAgfVxuICAgIH0gICAgXG5cbiAgICBhc3luYyBpbnF1aXJlXygpIHtcbiAgICAgICAgbGV0IGRvSW5xdWlyZSA9IGl0ZW0gPT4gaW5xdWlyZXIucHJvbXB0KFtpdGVtXSkudGhlbihhbnN3ZXJzID0+IHtcbiAgICAgICAgICAgIF8uZm9yT3duKGFuc3dlcnMsIChhbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3ZbbmFtZV0gPSBhbnM7XG4gICAgICAgICAgICAgICAgbGV0IG9wdHMgPSB0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zW25hbWVdO1xuICAgICAgICAgICAgICAgIGlmIChvcHRzLmFsaWFzKSB7XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChvcHRzLmFsaWFzLCBhID0+IHsgdGhpcy5hcmd2W2FdID0gYW5zOyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTsgXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKHRoaXMudXNhZ2VPcHRpb25zLm9wdGlvbnMsIGFzeW5jIChvcHRzLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoKCdpbnF1aXJlJyBpbiBvcHRzKSAmJiAhdGhpcy5hcmd2W25hbWVdKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlucXVpcmUgPSBvcHRzLmlucXVpcmU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRzLmlucXVpcmUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5xdWlyZSA9IGF3YWl0IG9wdHMuaW5xdWlyZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbnF1aXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0eXBlO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcSA9IHsgbmFtZTogbmFtZSwgbWVzc2FnZTogb3B0cy5wcm9tcHRNZXNzYWdlIHx8IG9wdHMuZGVzYyB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLnByb21wdFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBvcHRzLnByb21wdFR5cGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2xpc3QnIHx8IHR5cGUgID09PSAncmF3TGlzdCcgfHwgdHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0eXBlID09PSAnZXhwYW5kJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3B0cy5jaG9pY2VzUHJvdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGNob2ljZXMgcHJvdmlkZXIhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5jaG9pY2VzID0gYXdhaXQgb3B0cy5jaG9pY2VzUHJvdmlkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmJvb2wpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnY29uZmlybSc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gJ2lucHV0J1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcS50eXBlID0gdHlwZTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoJ3Byb21wdERlZmF1bHQnIGluIG9wdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cy5wcm9tcHREZWZhdWx0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcS5kZWZhdWx0ID0gYXdhaXQgb3B0cy5wcm9tcHREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEuZGVmYXVsdCA9IG9wdHMucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvSW5xdWlyZShxKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5hZnRlcklucXVpcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG9wdHMuYWZ0ZXJJbnF1aXJlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZSBpbiB0aGlzLmFyZ3YgJiYgb3B0cy5ub25JbnF1aXJlRmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmd2W25hbWVdID0gYXdhaXQgb3B0cy5ub25JbnF1aXJlRmlsdGVyKHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9IFxuXG4gICAgICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmFyZ3YgJiYgb3B0cy5vblJlYWR5KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgb3B0cy5vblJlYWR5KHRoaXMuYXJndltuYW1lXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0Q29udGFpbmVyKCkge1xuICAgICAgICBsZXQgY29uZmlnRmlsZSA9IHRoaXMub3B0aW9uKCdjb25maWcnKTtcbiAgICAgICAgXG4gICAgICAgIGxldCBjb25maWdGdWxsUGF0aCA9IHRoaXMuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbmZpZ0ZpbGUpO1xuXG4gICAgICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyhjb25maWdGdWxsUGF0aCkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZyBcIiR7Y29uZmlnRmlsZX1cIiBub3QgZm91bmQhYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZXh0TmFtZSA9IHBhdGguZXh0bmFtZShjb25maWdGdWxsUGF0aCk7XG4gICAgICAgIGlmIChleHROYW1lICE9PSAnLmpzb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgc3VwcG9ydHMgSlNPTiBjb25maWcuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29uZmlnTmFtZSA9IHBhdGguYmFzZW5hbWUoY29uZmlnRnVsbFBhdGgsIGV4dE5hbWUpO1xuICAgICAgICBsZXQgY29uZmlnUGF0aCA9IHBhdGguZGlybmFtZShjb25maWdGdWxsUGF0aCk7XG4gICAgICAgIGxldCBlbnZBd2FyZSA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChjb25maWdOYW1lLmVuZHNXaXRoKCcuZGVmYXVsdCcpKSB7XG4gICAgICAgICAgICBlbnZBd2FyZSA9IHRydWU7XG4gICAgICAgICAgICBjb25maWdOYW1lID0gY29uZmlnTmFtZS5zdWJzdHIoMCwgY29uZmlnTmFtZS5sZW5ndGggLSA4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gbmV3IFNlcnZpY2VDb250YWluZXIoJ09vbG9uZ0NvbnRhaW5lcicsIHtcbiAgICAgICAgICAgIHdvcmtpbmdQYXRoOiB0aGlzLmFwcC53b3JraW5nUGF0aCxcbiAgICAgICAgICAgIGNvbmZpZ1BhdGgsXG4gICAgICAgICAgICBjb25maWdOYW1lLFxuICAgICAgICAgICAgZGlzYWJsZUVudkF3YXJlQ29uZmlnOiAhZW52QXdhcmUsXG4gICAgICAgICAgICBhbGxvd2VkRmVhdHVyZXM6IFtcbiAgICAgICAgICAgICAgICAnYm9vdHN0cmFwJyxcbiAgICAgICAgICAgICAgICAnY29uZmlnQnlIb3N0bmFtZScsICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnZGV2Q29uZmlnQnlHaXRVc2VyJywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgJ2xvZ2dlcnMnLFxuICAgICAgICAgICAgICAgICdtYWlsZXInLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAnc2V0dGluZ3MnLFxuICAgICAgICAgICAgICAgICd0aW1lem9uZScsXG4gICAgICAgICAgICAgICAgJ3ZlcnNpb24nXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY29udGFpbmVyLmxvZ2dlciA9IHRoaXMuYXBwLmxvZ2dlcjtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb250YWluZXIuc3RhcnRfKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGNvbm5lY3Rpb24gc3RyaW5ncyBmcm9tIGEgY29uZmlnIGZpbGUuXG4gICAgICogQHBhcmFtIHsqfSBjb25mIC0gT29vbG9uZyBjb25maWcgZmlsZS5cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldENvbm5lY3Rpb25TdHJpbmdzKCkge1xuICAgICAgICBsZXQgY29uZmlnID0gdGhpcy5vb2xvbmdDb25maWc7XG4gICAgICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICAgICAgXG4gICAgICAgIFN1cHBvcnRlZERyaXZlcnMuZm9yRWFjaChkcml2ZXIgPT4ge1xuICAgICAgICAgICAgbGV0IGNvbm5lY3RvcnMgPSBjb25maWdbZHJpdmVyXTtcblxuICAgICAgICAgICAgaWYgKGNvbm5lY3RvcnMpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihjb25uZWN0b3JzLCAoY29ubmVjdG9yT3B0aW9ucywgY29ubmVjdG9yTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbbWFrZURhdGFTb3VyY2VOYW1lKGRyaXZlciwgY29ubmVjdG9yTmFtZSldID0gY29ubmVjdG9yT3B0aW9ucy5jb25uZWN0aW9uO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGdldFNjaGVtYXNJbkNvbmZpZygpIHtcbiAgICAgICAgbGV0IHNjaGVtYXMgPSBVdGlsLmdldFZhbHVlQnlQYXRoKHRoaXMub29sb25nQ29uZmlnLCAnb29sb25nLnNjaGVtYURlcGxveW1lbnQnKTtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHNjaGVtYXMpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldERhdGFzZXRfKCkge1xuICAgICAgICBsZXQgc2NyaXB0U291cmNlUGF0aCA9IHRoaXMuYXBwLnRvQWJzb2x1dGVQYXRoKFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJykpO1xuXG4gICAgICAgIGxldCBzY2hlbWEgPSB0aGlzLm9wdGlvbignc2NoZW1hJyk7IFxuICAgICAgICBpZiAoIXNjaGVtYSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTY2hlbWEgYXJndW1lbnQgaXMgcmVxdWlyZWQgZm9yIGxpc3RpbmcgZGF0YXNldC5gKTtcbiAgICAgICAgfSAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpLmRhdGFzZXRfKFxuICAgICAgICAgICAgeyBcbiAgICAgICAgICAgICAgICBsb2dnZXI6IHRoaXMuYXBwLmxvZ2dlcixcbiAgICAgICAgICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLCBcbiAgICAgICAgICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiB0aGlzLnNjaGVtYURlcGxveW1lbnQgXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2NoZW1hXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgZ2V0IG9vbG9uZ0NvbmZpZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGFpbmVyLmNvbmZpZztcbiAgICB9XG5cbiAgICBnZXQgc2NoZW1hRGVwbG95bWVudCgpIHtcbiAgICAgICAgbGV0IG1vZGVsTWFwcGluZyA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgodGhpcy5vb2xvbmdDb25maWcsICdvb2xvbmcuc2NoZW1hRGVwbG95bWVudCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkobW9kZWxNYXBwaW5nKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcInNjaGVtYURlcGxveW1lbnRcIiBpcyBlbXB0eS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBfLm1hcFZhbHVlcyhtb2RlbE1hcHBpbmcsIChtYXBwaW5nLCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgICAgICBsZXQgeyBkYXRhU291cmNlLCAuLi5vdGhlcnMgfSA9IG1hcHBpbmc7XG4gICAgXG4gICAgICAgICAgICBpZiAoIWRhdGFTb3VyY2UpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbmZpZ3VyYXRpb24gaXRlbSBcInNjaGVtYURlcGxveW1lbnQuJHtzY2hlbWFOYW1lfS5kYXRhU291cmNlXCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgbGV0IHsgY29ubmVjdGlvbiwgLi4ub3B0aW9ucyB9ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aCh0aGlzLm9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGRhdGFTb3VyY2UsIHt9KTtcbiAgICAgICAgICAgIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiBzdHJpbmcgb2YgZGF0YSBzb3VyY2UgXCIke2RhdGFTb3VyY2V9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgcmV0dXJuIHsgZGF0YVNvdXJjZSwgY29ubmVjdGlvblN0cmluZzogY29ubmVjdGlvbiwgb3B0aW9ucywgLi4ub3RoZXJzIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBkZWZhdWx0IG9vbG9uZyBvdXRwdXQgcGF0aC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJlZml4IFxuICAgICAqIEBwYXJhbSB7Ym9vbH0gb3ZlcnJpZGUgXG4gICAgICogQHJldHVybnMge3N0cmluZ30gT3V0cHV0IHBhdGggb2Ygb29sb25nIGdlbmVyYXRlZCBmaWxlcy5cbiAgICAgKi9cbiAgICBnZXRSZXZlcnNlT3V0cHV0RGlyKGJhc2VEaXIsIHByZWZpeCA9ICcnLCBvdmVycmlkZSA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQgZm9sZGVyID0gYCR7cHJlZml4fSR7bm93LmdldEZ1bGxZZWFyKCl9LSR7bm93LmdldE1vbnRoKCkrMX0tJHtub3cuZ2V0RGF0ZSgpfWA7XG4gICAgICAgIGxldCBvdXRwdXREaXIgPSBwYXRoLmpvaW4oYmFzZURpciwgZm9sZGVyKTtcblxuICAgICAgICBpZiAob3ZlcnJpZGUpIHJldHVybiBvdXRwdXREaXI7XG5cbiAgICAgICAgbGV0IG51bSA9IDE7XG5cbiAgICAgICAgd2hpbGUgKGZzLmV4aXN0c1N5bmMob3V0cHV0RGlyKSkge1xuICAgICAgICAgICAgbGV0IGZvbGRlcjIgPSBmb2xkZXIgKyAnXycgKyAoKytudW0pLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICBvdXRwdXREaXIgPSBwYXRoLmpvaW4oYmFzZURpciwgZm9sZGVyMik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3V0cHV0RGlyO1xuICAgIH1cblxuICAgIC8vIHZhbGlkYXRlIHBhcnNlZCBhbmQgZmlsbGVkIGFyZ3VtZW50IG9wdGlvbnMuXG4gICAgX3ZhbGlkYXRlQXJndigpIHtcbiAgICAgICAgbGV0IHZhbGlkID0gdHJ1ZTtcblxuICAgICAgICBfLmZvck93bih0aGlzLnVzYWdlT3B0aW9ucy5vcHRpb25zLCAob3B0cywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlcXVpcmVkID0gb3B0cy5yZXF1aXJlZDtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1aXJlZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHJlcXVpcmVkID0gcmVxdWlyZWQoKTtcbiAgICAgICAgICAgIH0gXG5cbiAgICAgICAgICAgIGlmIChyZXF1aXJlZCAmJiAhKG5hbWUgaW4gdGhpcy5hcmd2KSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEFyZ3VtZW50IFwiJHtuYW1lfVwiIGlzIHJlcXVpcmVkLmApO1xuICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB2YWxpZDtcbiAgICB9XG5cbiAgICAvLyBmaWxsIHRoZSBhcmd2IHdpdGggY29tbWFuZCBzcGVjaWZpYyBwcm9tcHQgZGVmYXVsdHNcbiAgICBfZmlsbENvbW1hbmREZWZhdWx0cyhjb21tYW5kT3B0aW9ucykge1xuICAgICAgICBfLmZvck93bihjb21tYW5kT3B0aW9ucywgKGluZm8sIG9wdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmFyZ3YuaGFzT3duUHJvcGVydHkob3B0aW9uKSAmJiBpbmZvLmhhc093blByb3BlcnR5KCdwcm9tcHREZWZhdWx0JykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyZ3Zbb3B0aW9uXSA9IGluZm8ucHJvbXB0RGVmYXVsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE9vbG9uZ0NvcmU7Il19