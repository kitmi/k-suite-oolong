"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const {
  extractDriverAndConnectorName
} = require('../utils/lang');

exports.commands = {
  'list': 'List all oolong schemas.',
  'create': 'Create database schema.',
  'config': 'Enable oolong feature and add deploy config.',
  'build': 'Generate database scripts and entity models.',
  'migrate': 'Create database structure.',
  'dataset': 'List available data set.',
  'import': 'Import data set.',
  'reverse': 'Reverse engineering from a databse.'
};

exports.options = core => {
  let cmdOptions = {};

  switch (core.command) {
    case 'list':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      break;

    case 'create':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      cmdOptions['schema'] = {
        desc: 'Specify the schema name of the database',
        alias: ['s'],
        required: true,
        inquire: true
      };
      break;

    case 'config':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      cmdOptions['schema'] = {
        desc: 'The name of the schema',
        promptMessage: 'Please select the target schema:',
        alias: ['s'],
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAppSchemas(core))
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to be deployed',
        promptMessage: 'Please select the target db:',
        alias: ['database'],
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => {
          let conns = MowaHelper.getAppDbConnections(core);

          if (_.isEmpty(conns)) {
            throw new Error('Database connections not found. Config database connection first or run "mowa db add" first.');
          }

          return conns;
        }
      };
      break;

    case 'migrate':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['r'] = {
        desc: 'Reset all data if the database exists',
        promptMessage: 'Reset existing database?',
        promptDefault: false,
        inquire: true,
        required: true,
        alias: ['reset'],
        isBool: true
      };
      break;

    case 'build':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      break;

    case 'dataset':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        promptMessage: 'Please select the target app:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAvailableAppNames(core)
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to operate',
        promptMessage: 'Please select the target db:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAppDbConnections(core)
      };
      break;

    case 'import':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        promptMessage: 'Please select the target app:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAvailableAppNames(core)
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to operate',
        promptMessage: 'Please select the target db:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAppDbConnections(core)
      };
      cmdOptions['dataSet'] = {
        desc: 'The name of the data set to import',
        promptMessage: 'Please select the target data set:',
        alias: ['ds', 'data'],
        inquire: true,
        promptType: 'list',
        choicesProvider: () => listAvailableDataSet(core, core.getOption('db'))
      };
      break;

    case 'reverse':
      let connectionStrings;
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json",
        afterInquire: () => {
          connectionStrings = core.getConnectionStrings(core.option('c'));
        }
      };
      cmdOptions['conn'] = {
        desc: 'The data source connector',
        alias: ['connector'],
        promptMessage: 'Please select the data source connector:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Object.keys(connectionStrings),
        afterInquire: () => {
          console.log('The conenction string of selected connector:', connectionStrings[core.option('conn')]);
        }
      };
      break;

    default:
      break;
  }

  return cmdOptions;
};

exports.main = core => {
  if (core.option('v')) {
    console.log('v' + core.app.version);
  } else {
    core.showUsage();
  }
};

exports.build = async core => {
  core.app.log('verbose', 'oolong build');
  let oolongConfig = core.oolongConfig;
  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let modelOutputDir = Util.getValueByPath(oolongConfig, 'oolong.modelOutputDir');

  if (!modelOutputDir) {
    throw new Error('"oolong.modelOutputDir" not found in oolong config.');
  }

  let scriptOutputDir = Util.getValueByPath(oolongConfig, 'oolong.scriptOutputDir');

  if (!scriptOutputDir) {
    throw new Error('"oolong.scriptOutputDir" not found in oolong config.');
  }

  let manifestOutputDir = Util.getValueByPath(oolongConfig, 'oolong.manifestOutputDir');
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let modelOutputPath = core.app.toAbsolutePath(modelOutputDir);
  let scriptOutputPath = core.app.toAbsolutePath(scriptOutputDir);
  let manifestOutputPath = manifestOutputDir && core.app.toAbsolutePath(manifestOutputDir);

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  let saveIntermediate = Util.getValueByPath(oolongConfig, 'oolong.saveIntermediate', false);
  return core.api.build_({
    logger: core.app.logger,
    dslSourcePath,
    modelOutputPath,
    scriptOutputPath,
    manifestOutputPath,
    useJsonSource,
    saveIntermediate,
    schemaDeployment: core.schemaDeployment
  });
};

exports.migrate = async core => {
  core.app.log('verbose', 'oolong migrate');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);

  if (!fs.existsSync(modelPath)) {
    return Promise.reject(`Model directory "${modelPath}" not found.`);
  }

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  if (!fs.existsSync(scriptSourcePath)) {
    return Promise.reject(`Database scripts directory "${scriptSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  return core.api.migrate_({
    logger: core.app.logger,
    modelPath,
    dslSourcePath,
    scriptSourcePath,
    useJsonSource,
    schemaDeployment: core.schemaDeployment
  }, core.option('reset'));
};

exports.reverse = async core => {
  core.app.log('verbose', 'oolong reverse');
  let oolongConfig = core.oolongConfig;
  let dslReverseOutputDir = Util.getValueByPath(oolongConfig, 'oolong.dslReverseOutputDir');

  if (!dslReverseOutputDir) {
    throw new Error('"oolong.dslOutputDir" not found in oolong config.');
  }

  let outputDir = core.getReverseOutputDir(core.app.toAbsolutePath(dslReverseOutputDir));
  let conn = core.option('conn');
  let [driver] = extractDriverAndConnectorName(conn);
  let connOptions = Util.getValueByPath(oolongConfig, 'dataSource.' + conn);

  if (!connOptions) {
    throw new Error("Assertion failed: connOptions");
  }

  if (typeof connOptions.reverseRules === 'string') {
    connOptions.reverseRules = require(core.app.toAbsolutePath(connOptions.reverseRules));
  }

  if (!(!connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules))) {
    throw new Error("Assertion failed: !connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules)");
  }

  return core.api.reverse_({
    logger: core.app.logger,
    dslReverseOutputDir: outputDir,
    driver,
    connOptions
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29tbWFuZHMuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZnMiLCJleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZSIsImV4cG9ydHMiLCJjb21tYW5kcyIsIm9wdGlvbnMiLCJjb3JlIiwiY21kT3B0aW9ucyIsImNvbW1hbmQiLCJkZXNjIiwicmVxdWlyZWQiLCJpbnF1aXJlIiwicHJvbXB0VHlwZSIsImNob2ljZXNQcm92aWRlciIsIlByb21pc2UiLCJyZXNvbHZlIiwiTW93YUhlbHBlciIsImdldEF2YWlsYWJsZUFwcE5hbWVzIiwiYWxpYXMiLCJwcm9tcHRNZXNzYWdlIiwiZ2V0QXBwU2NoZW1hcyIsImNvbm5zIiwiZ2V0QXBwRGJDb25uZWN0aW9ucyIsImlzRW1wdHkiLCJFcnJvciIsInByb21wdERlZmF1bHQiLCJpc0Jvb2wiLCJsaXN0QXZhaWxhYmxlRGF0YVNldCIsImdldE9wdGlvbiIsImNvbm5lY3Rpb25TdHJpbmdzIiwiYWZ0ZXJJbnF1aXJlIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvcHRpb24iLCJPYmplY3QiLCJrZXlzIiwiY29uc29sZSIsImxvZyIsIm1haW4iLCJhcHAiLCJ2ZXJzaW9uIiwic2hvd1VzYWdlIiwiYnVpbGQiLCJvb2xvbmdDb25maWciLCJkc2xTb3VyY2VEaXIiLCJnZXRWYWx1ZUJ5UGF0aCIsIm1vZGVsT3V0cHV0RGlyIiwic2NyaXB0T3V0cHV0RGlyIiwibWFuaWZlc3RPdXRwdXREaXIiLCJkc2xTb3VyY2VQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJtb2RlbE91dHB1dFBhdGgiLCJzY3JpcHRPdXRwdXRQYXRoIiwibWFuaWZlc3RPdXRwdXRQYXRoIiwiZXhpc3RzU3luYyIsInJlamVjdCIsInVzZUpzb25Tb3VyY2UiLCJzYXZlSW50ZXJtZWRpYXRlIiwiYXBpIiwiYnVpbGRfIiwibG9nZ2VyIiwic2NoZW1hRGVwbG95bWVudCIsIm1pZ3JhdGUiLCJtb2RlbERpciIsInNjcmlwdFNvdXJjZURpciIsIm1vZGVsUGF0aCIsInNjcmlwdFNvdXJjZVBhdGgiLCJtaWdyYXRlXyIsInJldmVyc2UiLCJkc2xSZXZlcnNlT3V0cHV0RGlyIiwib3V0cHV0RGlyIiwiZ2V0UmV2ZXJzZU91dHB1dERpciIsImNvbm4iLCJkcml2ZXIiLCJjb25uT3B0aW9ucyIsInJldmVyc2VSdWxlcyIsImlzUGxhaW5PYmplY3QiLCJyZXZlcnNlXyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILElBQWxCOztBQUNBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUFvQ0gsT0FBTyxDQUFDLGVBQUQsQ0FBakQ7O0FBRUFJLE9BQU8sQ0FBQ0MsUUFBUixHQUFtQjtBQUNmLFVBQVEsMEJBRE87QUFFZixZQUFVLHlCQUZLO0FBR2YsWUFBVSw4Q0FISztBQUlmLFdBQVMsOENBSk07QUFLZixhQUFXLDRCQUxJO0FBTWYsYUFBVywwQkFOSTtBQU9mLFlBQVUsa0JBUEs7QUFRZixhQUFXO0FBUkksQ0FBbkI7O0FBY0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFtQkMsSUFBRCxJQUFVO0FBQ3hCLE1BQUlDLFVBQVUsR0FBRyxFQUFqQjs7QUFFQSxVQUFRRCxJQUFJLENBQUNFLE9BQWI7QUFDSSxTQUFLLE1BQUw7QUFDSUQsTUFBQUEsVUFBVSxDQUFDLEtBQUQsQ0FBVixHQUFvQjtBQUNoQkUsUUFBQUEsSUFBSSxFQUFFLGdDQURVO0FBRWhCQyxRQUFBQSxRQUFRLEVBQUUsSUFGTTtBQUdoQkMsUUFBQUEsT0FBTyxFQUFFLElBSE87QUFJaEJDLFFBQUFBLFVBQVUsRUFBRSxNQUpJO0FBS2hCQyxRQUFBQSxlQUFlLEVBQUUsTUFBTUMsT0FBTyxDQUFDQyxPQUFSLENBQWdCQyxVQUFVLENBQUNDLG9CQUFYLENBQWdDWCxJQUFoQyxDQUFoQjtBQUxQLE9BQXBCO0FB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RSxXQWhCc0I7QUFBQTtBQUFBOztBQWtCOUIsTUFBSSxPQUFPQSxXQUFXLENBQUNDLFlBQW5CLEtBQW9DLFFBQXhDLEVBQWtEO0FBQzlDRCxJQUFBQSxXQUFXLENBQUNDLFlBQVosR0FBMkIzRSxPQUFPLENBQUNPLElBQUksQ0FBQ2dDLEdBQUwsQ0FBU1csY0FBVCxDQUF3QndCLFdBQVcsQ0FBQ0MsWUFBcEMsQ0FBRCxDQUFsQztBQUNIOztBQXBCNkIsUUFzQnRCLENBQUNELFdBQVcsQ0FBQ0MsWUFBYixJQUE2QjFFLENBQUMsQ0FBQzJFLGFBQUYsQ0FBZ0JGLFdBQVcsQ0FBQ0MsWUFBNUIsQ0F0QlA7QUFBQTtBQUFBOztBQXdCOUIsU0FBT3BFLElBQUksQ0FBQ21ELEdBQUwsQ0FBU21CLFFBQVQsQ0FBa0I7QUFDckJqQixJQUFBQSxNQUFNLEVBQUVyRCxJQUFJLENBQUNnQyxHQUFMLENBQVNxQixNQURJO0FBRXJCUyxJQUFBQSxtQkFBbUIsRUFBRUMsU0FGQTtBQUdyQkcsSUFBQUEsTUFIcUI7QUFJckJDLElBQUFBO0FBSnFCLEdBQWxCLENBQVA7QUFNSCxDQTlCRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgZnMgfSA9IFV0aWw7XG5jb25zdCB7IGV4dHJhY3REcml2ZXJBbmRDb25uZWN0b3JOYW1lIH0gPSByZXF1aXJlKCcuLi91dGlscy9sYW5nJyk7XG5cbmV4cG9ydHMuY29tbWFuZHMgPSB7XG4gICAgJ2xpc3QnOiAnTGlzdCBhbGwgb29sb25nIHNjaGVtYXMuJyxcbiAgICAnY3JlYXRlJzogJ0NyZWF0ZSBkYXRhYmFzZSBzY2hlbWEuJyxcbiAgICAnY29uZmlnJzogJ0VuYWJsZSBvb2xvbmcgZmVhdHVyZSBhbmQgYWRkIGRlcGxveSBjb25maWcuJyxcbiAgICAnYnVpbGQnOiAnR2VuZXJhdGUgZGF0YWJhc2Ugc2NyaXB0cyBhbmQgZW50aXR5IG1vZGVscy4nLFxuICAgICdtaWdyYXRlJzogJ0NyZWF0ZSBkYXRhYmFzZSBzdHJ1Y3R1cmUuJywgICAgXG4gICAgJ2RhdGFzZXQnOiAnTGlzdCBhdmFpbGFibGUgZGF0YSBzZXQuJyxcbiAgICAnaW1wb3J0JzogJ0ltcG9ydCBkYXRhIHNldC4nLFxuICAgICdyZXZlcnNlJzogJ1JldmVyc2UgZW5naW5lZXJpbmcgZnJvbSBhIGRhdGFic2UuJ1xufTtcblxuLyoqXG4gKiBAcGFyYW0ge09vbG9uZ0NvcmV9IGNvcmUgLSBPb2xvbmdDb3JlIG9iamVjdC5cbiAqL1xuZXhwb3J0cy5vcHRpb25zID0gKGNvcmUpID0+IHtcbiAgICBsZXQgY21kT3B0aW9ucyA9IHt9O1xuXG4gICAgc3dpdGNoIChjb3JlLmNvbW1hbmQpIHtcbiAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICBjbWRPcHRpb25zWydhcHAnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGFwcCB0byBvcGVyYXRlJyxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IFByb21pc2UucmVzb2x2ZShNb3dhSGVscGVyLmdldEF2YWlsYWJsZUFwcE5hbWVzKGNvcmUpKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2NyZWF0ZSc6XG4gICAgICAgICAgICBjbWRPcHRpb25zWydhcHAnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGFwcCB0byBvcGVyYXRlJyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IFByb21pc2UucmVzb2x2ZShNb3dhSGVscGVyLmdldEF2YWlsYWJsZUFwcE5hbWVzKGNvcmUpKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ3NjaGVtYSddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdTcGVjaWZ5IHRoZSBzY2hlbWEgbmFtZSBvZiB0aGUgZGF0YWJhc2UnLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbICdzJyBdLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdjb25maWcnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYXBwJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBhcHAgdG8gb3BlcmF0ZScsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoTW93YUhlbHBlci5nZXRBdmFpbGFibGVBcHBOYW1lcyhjb3JlKSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydzY2hlbWEnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIHNjaGVtYScsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgdGhlIHRhcmdldCBzY2hlbWE6JyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAncycgXSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IFByb21pc2UucmVzb2x2ZShNb3dhSGVscGVyLmdldEFwcFNjaGVtYXMoY29yZSkpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY21kT3B0aW9uc1snZGInXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGRiIHRvIGJlIGRlcGxveWVkJyxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIHNlbGVjdCB0aGUgdGFyZ2V0IGRiOicsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ2RhdGFiYXNlJyBdLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgY29ubnMgPSBNb3dhSGVscGVyLmdldEFwcERiQ29ubmVjdGlvbnMoY29yZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChfLmlzRW1wdHkoY29ubnMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlIGNvbm5lY3Rpb25zIG5vdCBmb3VuZC4gQ29uZmlnIGRhdGFiYXNlIGNvbm5lY3Rpb24gZmlyc3Qgb3IgcnVuIFwibW93YSBkYiBhZGRcIiBmaXJzdC4nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29ubnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ21pZ3JhdGUnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYyddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6IFwiT29sb25nIGNvbmZpZyBmaWxlXCIsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgXCJjb25mXCIsIFwiY29uZmlnXCIgXSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIGlucHV0IHRoZSBjb25maWcgZmlsZSBwYXRoOicsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogXCJjb25mL29vbG9uZy5qc29uXCJcbiAgICAgICAgICAgIH07ICBcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ3InXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnUmVzZXQgYWxsIGRhdGEgaWYgdGhlIGRhdGFiYXNlIGV4aXN0cycsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1Jlc2V0IGV4aXN0aW5nIGRhdGFiYXNlPycsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAncmVzZXQnIF0sXG4gICAgICAgICAgICAgICAgaXNCb29sOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnYnVpbGQnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYyddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6IFwiT29sb25nIGNvbmZpZyBmaWxlXCIsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgXCJjb25mXCIsIFwiY29uZmlnXCIgXSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIGlucHV0IHRoZSBjb25maWcgZmlsZSBwYXRoOicsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogXCJjb25mL29vbG9uZy5qc29uXCJcbiAgICAgICAgICAgIH07ICBcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2RhdGFzZXQnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYXBwJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBhcHAgdG8gb3BlcmF0ZScsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgdGhlIHRhcmdldCBhcHA6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE1vd2FIZWxwZXIuZ2V0QXZhaWxhYmxlQXBwTmFtZXMoY29yZSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydkYiddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgbmFtZSBvZiB0aGUgZGIgdG8gb3BlcmF0ZScsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgdGhlIHRhcmdldCBkYjonLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gTW93YUhlbHBlci5nZXRBcHBEYkNvbm5lY3Rpb25zKGNvcmUpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnaW1wb3J0JzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2FwcCddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgbmFtZSBvZiB0aGUgYXBwIHRvIG9wZXJhdGUnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgYXBwOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBNb3dhSGVscGVyLmdldEF2YWlsYWJsZUFwcE5hbWVzKGNvcmUpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY21kT3B0aW9uc1snZGInXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGRiIHRvIG9wZXJhdGUnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgZGI6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE1vd2FIZWxwZXIuZ2V0QXBwRGJDb25uZWN0aW9ucyhjb3JlKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2RhdGFTZXQnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGRhdGEgc2V0IHRvIGltcG9ydCcsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgdGhlIHRhcmdldCBkYXRhIHNldDonLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbICdkcycsICdkYXRhJyBdLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gbGlzdEF2YWlsYWJsZURhdGFTZXQoY29yZSwgY29yZS5nZXRPcHRpb24oJ2RiJykpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncmV2ZXJzZSc6ICAgICAgICBcbiAgICAgICAgICAgIGxldCBjb25uZWN0aW9uU3RyaW5ncztcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snYyddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6IFwiT29sb25nIGNvbmZpZyBmaWxlXCIsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgXCJjb25mXCIsIFwiY29uZmlnXCIgXSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIGlucHV0IHRoZSBjb25maWcgZmlsZSBwYXRoOicsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogXCJjb25mL29vbG9uZy5qc29uXCIsXG4gICAgICAgICAgICAgICAgYWZ0ZXJJbnF1aXJlOiAoKSA9PiB7IGNvbm5lY3Rpb25TdHJpbmdzID0gY29yZS5nZXRDb25uZWN0aW9uU3RyaW5ncyhjb3JlLm9wdGlvbignYycpKTsgfVxuICAgICAgICAgICAgfTsgICBcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snY29ubiddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgZGF0YSBzb3VyY2UgY29ubmVjdG9yJyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAnY29ubmVjdG9yJyBdLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSBkYXRhIHNvdXJjZSBjb25uZWN0b3I6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE9iamVjdC5rZXlzKGNvbm5lY3Rpb25TdHJpbmdzKSxcbiAgICAgICAgICAgICAgICBhZnRlcklucXVpcmU6ICgpID0+IHsgY29uc29sZS5sb2coJ1RoZSBjb25lbmN0aW9uIHN0cmluZyBvZiBzZWxlY3RlZCBjb25uZWN0b3I6JywgY29ubmVjdGlvblN0cmluZ3NbY29yZS5vcHRpb24oJ2Nvbm4nKV0pOyB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIC8vbW9kdWxlIGdlbmVyYWwgb3B0aW9uc1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNtZE9wdGlvbnM7XG59O1xuXG5leHBvcnRzLm1haW4gPSAoY29yZSkgPT4ge1xuICAgIGlmIChjb3JlLm9wdGlvbigndicpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCd2JyArIGNvcmUuYXBwLnZlcnNpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvcmUuc2hvd1VzYWdlKCk7XG4gICAgfVxufTtcblxuZXhwb3J0cy5idWlsZCA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBidWlsZCcpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRzbFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmRzbFNvdXJjZURpcicpO1xuICAgIGlmICghZHNsU291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsU291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG1vZGVsT3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxPdXRwdXREaXInKTtcbiAgICBpZiAoIW1vZGVsT3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0T3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0T3V0cHV0RGlyJyk7XG4gICAgaWYgKCFzY3JpcHRPdXRwdXREaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgbWFuaWZlc3RPdXRwdXREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5tYW5pZmVzdE91dHB1dERpcicpO1xuICAgIFxuICAgIGxldCBkc2xTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoZHNsU291cmNlRGlyKTsgICAgXG4gICAgbGV0IG1vZGVsT3V0cHV0UGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsT3V0cHV0RGlyKTtcbiAgICBsZXQgc2NyaXB0T3V0cHV0UGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKHNjcmlwdE91dHB1dERpcik7XG4gICAgbGV0IG1hbmlmZXN0T3V0cHV0UGF0aCA9IG1hbmlmZXN0T3V0cHV0RGlyICYmIGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1hbmlmZXN0T3V0cHV0RGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgdXNlSnNvblNvdXJjZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnVzZUpzb25Tb3VyY2UnLCBmYWxzZSk7ICAgICAgIFxuICAgIGxldCBzYXZlSW50ZXJtZWRpYXRlID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2F2ZUludGVybWVkaWF0ZScsIGZhbHNlKTsgICAgICAgXG5cbiAgICByZXR1cm4gY29yZS5hcGkuYnVpbGRfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFNvdXJjZVBhdGgsXG4gICAgICAgIG1vZGVsT3V0cHV0UGF0aCxcbiAgICAgICAgc2NyaXB0T3V0cHV0UGF0aCxcbiAgICAgICAgbWFuaWZlc3RPdXRwdXRQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzYXZlSW50ZXJtZWRpYXRlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMubWlncmF0ZSA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBtaWdyYXRlJyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgZHNsU291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuZHNsU291cmNlRGlyJyk7XG4gICAgaWYgKCFkc2xTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5kc2xTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0U291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJyk7XG4gICAgaWYgKCFzY3JpcHRTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgbW9kZWxQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgobW9kZWxEaXIpOyAgICBcbiAgICBsZXQgZHNsU291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFNvdXJjZURpcik7ICAgIFxuICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0U291cmNlRGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2RlbFBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgTW9kZWwgZGlyZWN0b3J5IFwiJHttb2RlbFBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyaXB0U291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhYmFzZSBzY3JpcHRzIGRpcmVjdG9yeSBcIiR7c2NyaXB0U291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZUpzb25Tb3VyY2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy51c2VKc29uU291cmNlJywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIGNvcmUuYXBpLm1pZ3JhdGVfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIG1vZGVsUGF0aCxcbiAgICAgICAgZHNsU291cmNlUGF0aCwgICAgICAgIFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9LCBjb3JlLm9wdGlvbigncmVzZXQnKSk7XG59O1xuXG5leHBvcnRzLnJldmVyc2UgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgcmV2ZXJzZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRzbFJldmVyc2VPdXRwdXREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kc2xSZXZlcnNlT3V0cHV0RGlyJyk7XG4gICAgaWYgKCFkc2xSZXZlcnNlT3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG91dHB1dERpciA9IGNvcmUuZ2V0UmV2ZXJzZU91dHB1dERpcihjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xSZXZlcnNlT3V0cHV0RGlyKSk7XG5cbiAgICAvL3RvZG86IHJlbG9jYXRpb24sIGFuZCBkZWVwIGNvcHkgY29ubmVjdGlvbiBvcHRpb25zXG4gICAgbGV0IGNvbm4gPSBjb3JlLm9wdGlvbignY29ubicpO1xuICAgIGxldCBbIGRyaXZlciBdID0gZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUoY29ubik7XG4gICAgbGV0IGNvbm5PcHRpb25zID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBjb25uKTtcbiAgICBhc3NlcnQ6IGNvbm5PcHRpb25zOyAgICBcblxuICAgIGlmICh0eXBlb2YgY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPSByZXF1aXJlKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcykpO1xuICAgIH0gXG5cbiAgICBhc3NlcnQ6ICFjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwgXy5pc1BsYWluT2JqZWN0KGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkucmV2ZXJzZV8oeyBcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFJldmVyc2VPdXRwdXREaXI6IG91dHB1dERpcixcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICBjb25uT3B0aW9uc1xuICAgIH0pO1xufTsiXX0=