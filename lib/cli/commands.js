"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const {
  extractDriverAndConnectorName
} = require('../utils/lang');

exports.commands = {
  'build': 'Generate database scripts and entity models.',
  'migrate': 'Create database structure.',
  'dataset': 'List available data set.',
  'import': 'Import data set.',
  'reverse': 'Reverse engineering from a databse.'
};

exports.options = core => {
  let cmdOptions = {};

  switch (core.command) {
    case 'build':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      break;

    case 'migrate':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['r'] = {
        desc: 'Reset all data if the database exists',
        promptMessage: 'Reset existing database?',
        promptDefault: false,
        inquire: true,
        required: true,
        alias: ['reset'],
        isBool: true
      };
      break;

    case 'dataset':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['schema'] = {
        desc: 'The schema to list',
        promptMessage: 'Please select a schema:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => core.getSchemasInConfig()
      };
      break;

    case 'import':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['schema'] = {
        desc: 'The schema to list',
        promptMessage: 'Please select a schema:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => core.getSchemasInConfig()
      };
      cmdOptions['dataset'] = {
        desc: 'The name of the data set to import',
        promptMessage: 'Please select the target dataset:',
        alias: ['ds', 'data'],
        inquire: true,
        promptType: 'list',
        choicesProvider: () => core.getDataset_()
      };
      break;

    case 'reverse':
      let connectionStrings;
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json",
        afterInquire: () => {
          connectionStrings = core.getConnectionStrings(core.option('c'));
        }
      };
      cmdOptions['conn'] = {
        desc: 'The data source connector',
        alias: ['connector'],
        promptMessage: 'Please select the data source connector:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Object.keys(connectionStrings),
        afterInquire: () => {
          console.log('The conenction string of selected connector:', connectionStrings[core.option('conn')]);
        }
      };
      break;

    default:
      break;
  }

  return cmdOptions;
};

exports.main = core => {
  if (core.option('v')) {
    console.log('v' + core.app.version);
  } else {
    core.showUsage();
  }
};

exports.build = async core => {
  core.app.log('verbose', 'oolong build');
  let oolongConfig = core.oolongConfig;
  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let modelOutputDir = Util.getValueByPath(oolongConfig, 'oolong.modelOutputDir');

  if (!modelOutputDir) {
    throw new Error('"oolong.modelOutputDir" not found in oolong config.');
  }

  let scriptOutputDir = Util.getValueByPath(oolongConfig, 'oolong.scriptOutputDir');

  if (!scriptOutputDir) {
    throw new Error('"oolong.scriptOutputDir" not found in oolong config.');
  }

  let manifestOutputDir = Util.getValueByPath(oolongConfig, 'oolong.manifestOutputDir');
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let modelOutputPath = core.app.toAbsolutePath(modelOutputDir);
  let scriptOutputPath = core.app.toAbsolutePath(scriptOutputDir);
  let manifestOutputPath = manifestOutputDir && core.app.toAbsolutePath(manifestOutputDir);

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  let saveIntermediate = Util.getValueByPath(oolongConfig, 'oolong.saveIntermediate', false);
  return core.api.build_({
    logger: core.app.logger,
    dslSourcePath,
    modelOutputPath,
    scriptOutputPath,
    manifestOutputPath,
    useJsonSource,
    saveIntermediate,
    schemaDeployment: core.schemaDeployment
  });
};

exports.migrate = async core => {
  core.app.log('verbose', 'oolong migrate');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);

  if (!fs.existsSync(modelPath)) {
    return Promise.reject(`Model directory "${modelPath}" not found.`);
  }

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  if (!fs.existsSync(scriptSourcePath)) {
    return Promise.reject(`Database scripts directory "${scriptSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  return core.api.migrate_({
    logger: core.app.logger,
    modelPath,
    dslSourcePath,
    scriptSourcePath,
    useJsonSource,
    schemaDeployment: core.schemaDeployment
  }, core.option('reset'));
};

exports.dataset = async core => {
  core.app.log('verbose', 'oolong dataset');
  let dataset = await core.getDataset_();
  core.app.log('info', 'Available dataset: \n' + dataset.join('\n') + '\n');
};

exports.import = async core => {
  core.app.log('verbose', 'oolong import');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);
  let schema = core.option('schema');
  let dataset = core.option('dataset');
  return core.api.import_({
    logger: core.app.logger,
    modelPath,
    scriptSourcePath,
    schemaDeployment: core.schemaDeployment
  }, schema, dataset);
};

exports.reverse = async core => {
  core.app.log('verbose', 'oolong reverse');
  let oolongConfig = core.oolongConfig;
  let dslReverseOutputDir = Util.getValueByPath(oolongConfig, 'oolong.dslReverseOutputDir');

  if (!dslReverseOutputDir) {
    throw new Error('"oolong.dslOutputDir" not found in oolong config.');
  }

  let outputDir = core.getReverseOutputDir(core.app.toAbsolutePath(dslReverseOutputDir));
  let conn = core.option('conn');
  let [driver] = extractDriverAndConnectorName(conn);
  let connOptions = Util.getValueByPath(oolongConfig, 'dataSource.' + conn);

  if (!connOptions) {
    throw new Error("Assertion failed: connOptions");
  }

  if (typeof connOptions.reverseRules === 'string') {
    connOptions.reverseRules = require(core.app.toAbsolutePath(connOptions.reverseRules));
  }

  if (!(!connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules))) {
    throw new Error("Assertion failed: !connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules)");
  }

  return core.api.reverse_({
    logger: core.app.logger,
    dslReverseOutputPath: outputDir,
    driver,
    connOptions
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29tbWFuZHMuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZnMiLCJleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZSIsImV4cG9ydHMiLCJjb21tYW5kcyIsIm9wdGlvbnMiLCJjb3JlIiwiY21kT3B0aW9ucyIsImNvbW1hbmQiLCJkZXNjIiwiYWxpYXMiLCJpbnF1aXJlIiwicHJvbXB0TWVzc2FnZSIsInByb21wdERlZmF1bHQiLCJyZXF1aXJlZCIsImlzQm9vbCIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJnZXRTY2hlbWFzSW5Db25maWciLCJnZXREYXRhc2V0XyIsImNvbm5lY3Rpb25TdHJpbmdzIiwiYWZ0ZXJJbnF1aXJlIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvcHRpb24iLCJPYmplY3QiLCJrZXlzIiwiY29uc29sZSIsImxvZyIsIm1haW4iLCJhcHAiLCJ2ZXJzaW9uIiwic2hvd1VzYWdlIiwiYnVpbGQiLCJvb2xvbmdDb25maWciLCJkc2xTb3VyY2VEaXIiLCJnZXRWYWx1ZUJ5UGF0aCIsIkVycm9yIiwibW9kZWxPdXRwdXREaXIiLCJzY3JpcHRPdXRwdXREaXIiLCJtYW5pZmVzdE91dHB1dERpciIsImRzbFNvdXJjZVBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIm1vZGVsT3V0cHV0UGF0aCIsInNjcmlwdE91dHB1dFBhdGgiLCJtYW5pZmVzdE91dHB1dFBhdGgiLCJleGlzdHNTeW5jIiwiUHJvbWlzZSIsInJlamVjdCIsInVzZUpzb25Tb3VyY2UiLCJzYXZlSW50ZXJtZWRpYXRlIiwiYXBpIiwiYnVpbGRfIiwibG9nZ2VyIiwic2NoZW1hRGVwbG95bWVudCIsIm1pZ3JhdGUiLCJtb2RlbERpciIsInNjcmlwdFNvdXJjZURpciIsIm1vZGVsUGF0aCIsInNjcmlwdFNvdXJjZVBhdGgiLCJtaWdyYXRlXyIsImRhdGFzZXQiLCJqb2luIiwiaW1wb3J0Iiwic2NoZW1hIiwiaW1wb3J0XyIsInJldmVyc2UiLCJkc2xSZXZlcnNlT3V0cHV0RGlyIiwib3V0cHV0RGlyIiwiZ2V0UmV2ZXJzZU91dHB1dERpciIsImNvbm4iLCJkcml2ZXIiLCJjb25uT3B0aW9ucyIsInJldmVyc2VSdWxlcyIsImlzUGxhaW5PYmplY3QiLCJyZXZlcnNlXyIsImRzbFJldmVyc2VPdXRwdXRQYXRoIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBWUgsSUFBbEI7O0FBQ0EsTUFBTTtBQUFFSSxFQUFBQTtBQUFGLElBQW9DSCxPQUFPLENBQUMsZUFBRCxDQUFqRDs7QUFFQUksT0FBTyxDQUFDQyxRQUFSLEdBQW1CO0FBQ2YsV0FBUyw4Q0FETTtBQUVmLGFBQVcsNEJBRkk7QUFHZixhQUFXLDBCQUhJO0FBSWYsWUFBVSxrQkFKSztBQUtmLGFBQVc7QUFMSSxDQUFuQjs7QUFXQUQsT0FBTyxDQUFDRSxPQUFSLEdBQW1CQyxJQUFELElBQVU7QUFDeEIsTUFBSUMsVUFBVSxHQUFHLEVBQWpCOztBQUVBLFVBQVFELElBQUksQ0FBQ0UsT0FBYjtBQUNJLFNBQUssT0FBTDtBQUNJRCxNQUFBQSxVQUFVLENBQUMsR0FBRCxDQUFWLEdBQWtCO0FBQ2RFLFFBQUFBLElBQUksRUFBRSxvQkFEUTtBQUVkQyxRQUFBQSxLQUFLLEVBQUUsQ0FBRSxNQUFGLEVBQVUsUUFBVixDQUZPO0FBR2RDLFFBQUFBLE9BQU8sRUFBRSxJQUhLO0FBSWRDLFFBQUFBLGFBQWEsRUFBRSxvQ0FKRDtBQUtkQyxRQUFBQSxhQUFhLEVBQUU7QUFMRCxPQUFsQjtBQU9BOztBQUVKLFNBQUssU0FBTDtBQUNJTixNQUFBQSxVQUFVLENBQUMsR0FBRCxDQUFWLEdBQWtCO0FBQ2RFLFFBQUFBLElBQUksRUFBRSxvQkFEUTtBQUVkQyxRQUFBQSxLQUFLLEVBQUUsQ0FBRSxNQUFGLEVBQVUsUUFBVixDQUZP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Q0FBeUI5RCxJQUFJLENBQUN1QixHQUFMLENBQVNZLGNBQVQsQ0FBd0J5QixtQkFBeEIsQ0FBekIsQ0FBaEI7QUFHQSxNQUFJRyxJQUFJLEdBQUcvRCxJQUFJLENBQUNpQixNQUFMLENBQVksTUFBWixDQUFYO0FBQ0EsTUFBSSxDQUFFK0MsTUFBRixJQUFhcEUsNkJBQTZCLENBQUNtRSxJQUFELENBQTlDO0FBQ0EsTUFBSUUsV0FBVyxHQUFHekUsSUFBSSxDQUFDcUMsY0FBTCxDQUFvQkYsWUFBcEIsRUFBa0MsZ0JBQWdCb0MsSUFBbEQsQ0FBbEI7O0FBZjhCLE9BZ0J0QkUsV0FoQnNCO0FBQUE7QUFBQTs7QUFrQjlCLE1BQUksT0FBT0EsV0FBVyxDQUFDQyxZQUFuQixLQUFvQyxRQUF4QyxFQUFrRDtBQUM5Q0QsSUFBQUEsV0FBVyxDQUFDQyxZQUFaLEdBQTJCekUsT0FBTyxDQUFDTyxJQUFJLENBQUN1QixHQUFMLENBQVNZLGNBQVQsQ0FBd0I4QixXQUFXLENBQUNDLFlBQXBDLENBQUQsQ0FBbEM7QUFDSDs7QUFwQjZCLFFBc0J0QixDQUFDRCxXQUFXLENBQUNDLFlBQWIsSUFBNkJ4RSxDQUFDLENBQUN5RSxhQUFGLENBQWdCRixXQUFXLENBQUNDLFlBQTVCLENBdEJQO0FBQUE7QUFBQTs7QUF3QjlCLFNBQU9sRSxJQUFJLENBQUM0QyxHQUFMLENBQVN3QixRQUFULENBQWtCO0FBQ3JCdEIsSUFBQUEsTUFBTSxFQUFFOUMsSUFBSSxDQUFDdUIsR0FBTCxDQUFTdUIsTUFESTtBQUVyQnVCLElBQUFBLG9CQUFvQixFQUFFUixTQUZEO0FBR3JCRyxJQUFBQSxNQUhxQjtBQUlyQkMsSUFBQUE7QUFKcUIsR0FBbEIsQ0FBUDtBQU1ILENBOUJEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IHsgZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuZXhwb3J0cy5jb21tYW5kcyA9IHsgICAgXG4gICAgJ2J1aWxkJzogJ0dlbmVyYXRlIGRhdGFiYXNlIHNjcmlwdHMgYW5kIGVudGl0eSBtb2RlbHMuJyxcbiAgICAnbWlncmF0ZSc6ICdDcmVhdGUgZGF0YWJhc2Ugc3RydWN0dXJlLicsICAgIFxuICAgICdkYXRhc2V0JzogJ0xpc3QgYXZhaWxhYmxlIGRhdGEgc2V0LicsXG4gICAgJ2ltcG9ydCc6ICdJbXBvcnQgZGF0YSBzZXQuJyxcbiAgICAncmV2ZXJzZSc6ICdSZXZlcnNlIGVuZ2luZWVyaW5nIGZyb20gYSBkYXRhYnNlLidcbn07XG5cbi8qKlxuICogQHBhcmFtIHtPb2xvbmdDb3JlfSBjb3JlIC0gT29sb25nQ29yZSBvYmplY3QuXG4gKi9cbmV4cG9ydHMub3B0aW9ucyA9IChjb3JlKSA9PiB7XG4gICAgbGV0IGNtZE9wdGlvbnMgPSB7fTtcblxuICAgIHN3aXRjaCAoY29yZS5jb21tYW5kKSB7XG4gICAgICAgIGNhc2UgJ2J1aWxkJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdtaWdyYXRlJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydyJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1Jlc2V0IGFsbCBkYXRhIGlmIHRoZSBkYXRhYmFzZSBleGlzdHMnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdSZXNldCBleGlzdGluZyBkYXRhYmFzZT8nLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ3Jlc2V0JyBdLFxuICAgICAgICAgICAgICAgIGlzQm9vbDogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrOyAgICAgICAgXG5cbiAgICAgICAgY2FzZSAnZGF0YXNldCc6ICAgICAgICAgICAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydjJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogXCJPb2xvbmcgY29uZmlnIGZpbGVcIixcbiAgICAgICAgICAgICAgICBhbGlhczogWyBcImNvbmZcIiwgXCJjb25maWdcIiBdLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2UgaW5wdXQgdGhlIGNvbmZpZyBmaWxlIHBhdGg6JyxcbiAgICAgICAgICAgICAgICBwcm9tcHREZWZhdWx0OiBcImNvbmYvb29sb25nLmpzb25cIlxuICAgICAgICAgICAgfTsgIFxuICAgICAgICAgICAgY21kT3B0aW9uc1snc2NoZW1hJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBzY2hlbWEgdG8gbGlzdCcsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IGEgc2NoZW1hOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBjb3JlLmdldFNjaGVtYXNJbkNvbmZpZygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnaW1wb3J0JzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydzY2hlbWEnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIHNjaGVtYSB0byBsaXN0JywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgYSBzY2hlbWE6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IGNvcmUuZ2V0U2NoZW1hc0luQ29uZmlnKClcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydkYXRhc2V0J10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBkYXRhIHNldCB0byBpbXBvcnQnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgZGF0YXNldDonLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbICdkcycsICdkYXRhJyBdLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gY29yZS5nZXREYXRhc2V0XygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncmV2ZXJzZSc6ICAgICAgICBcbiAgICAgICAgICAgIGxldCBjb25uZWN0aW9uU3RyaW5ncztcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snYyddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6IFwiT29sb25nIGNvbmZpZyBmaWxlXCIsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgXCJjb25mXCIsIFwiY29uZmlnXCIgXSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIGlucHV0IHRoZSBjb25maWcgZmlsZSBwYXRoOicsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogXCJjb25mL29vbG9uZy5qc29uXCIsXG4gICAgICAgICAgICAgICAgYWZ0ZXJJbnF1aXJlOiAoKSA9PiB7IGNvbm5lY3Rpb25TdHJpbmdzID0gY29yZS5nZXRDb25uZWN0aW9uU3RyaW5ncyhjb3JlLm9wdGlvbignYycpKTsgfVxuICAgICAgICAgICAgfTsgICBcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snY29ubiddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgZGF0YSBzb3VyY2UgY29ubmVjdG9yJyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAnY29ubmVjdG9yJyBdLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSBkYXRhIHNvdXJjZSBjb25uZWN0b3I6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE9iamVjdC5rZXlzKGNvbm5lY3Rpb25TdHJpbmdzKSxcbiAgICAgICAgICAgICAgICBhZnRlcklucXVpcmU6ICgpID0+IHsgY29uc29sZS5sb2coJ1RoZSBjb25lbmN0aW9uIHN0cmluZyBvZiBzZWxlY3RlZCBjb25uZWN0b3I6JywgY29ubmVjdGlvblN0cmluZ3NbY29yZS5vcHRpb24oJ2Nvbm4nKV0pOyB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIC8vbW9kdWxlIGdlbmVyYWwgb3B0aW9uc1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNtZE9wdGlvbnM7XG59O1xuXG5leHBvcnRzLm1haW4gPSAoY29yZSkgPT4ge1xuICAgIGlmIChjb3JlLm9wdGlvbigndicpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCd2JyArIGNvcmUuYXBwLnZlcnNpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvcmUuc2hvd1VzYWdlKCk7XG4gICAgfVxufTtcblxuZXhwb3J0cy5idWlsZCA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBidWlsZCcpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRzbFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmRzbFNvdXJjZURpcicpO1xuICAgIGlmICghZHNsU291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsU291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG1vZGVsT3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxPdXRwdXREaXInKTtcbiAgICBpZiAoIW1vZGVsT3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0T3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0T3V0cHV0RGlyJyk7XG4gICAgaWYgKCFzY3JpcHRPdXRwdXREaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgbWFuaWZlc3RPdXRwdXREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5tYW5pZmVzdE91dHB1dERpcicpO1xuICAgIFxuICAgIGxldCBkc2xTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoZHNsU291cmNlRGlyKTsgICAgXG4gICAgbGV0IG1vZGVsT3V0cHV0UGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsT3V0cHV0RGlyKTtcbiAgICBsZXQgc2NyaXB0T3V0cHV0UGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKHNjcmlwdE91dHB1dERpcik7XG4gICAgbGV0IG1hbmlmZXN0T3V0cHV0UGF0aCA9IG1hbmlmZXN0T3V0cHV0RGlyICYmIGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1hbmlmZXN0T3V0cHV0RGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgdXNlSnNvblNvdXJjZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnVzZUpzb25Tb3VyY2UnLCBmYWxzZSk7ICAgICAgIFxuICAgIGxldCBzYXZlSW50ZXJtZWRpYXRlID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2F2ZUludGVybWVkaWF0ZScsIGZhbHNlKTsgICAgICAgXG5cbiAgICByZXR1cm4gY29yZS5hcGkuYnVpbGRfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFNvdXJjZVBhdGgsXG4gICAgICAgIG1vZGVsT3V0cHV0UGF0aCxcbiAgICAgICAgc2NyaXB0T3V0cHV0UGF0aCxcbiAgICAgICAgbWFuaWZlc3RPdXRwdXRQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzYXZlSW50ZXJtZWRpYXRlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMubWlncmF0ZSA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyBtaWdyYXRlJyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgZHNsU291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuZHNsU291cmNlRGlyJyk7XG4gICAgaWYgKCFkc2xTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5kc2xTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0U291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJyk7XG4gICAgaWYgKCFzY3JpcHRTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgbW9kZWxQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgobW9kZWxEaXIpOyAgICBcbiAgICBsZXQgZHNsU291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFNvdXJjZURpcik7ICAgIFxuICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0U291cmNlRGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2RlbFBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgTW9kZWwgZGlyZWN0b3J5IFwiJHttb2RlbFBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyaXB0U291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhYmFzZSBzY3JpcHRzIGRpcmVjdG9yeSBcIiR7c2NyaXB0U291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZUpzb25Tb3VyY2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy51c2VKc29uU291cmNlJywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIGNvcmUuYXBpLm1pZ3JhdGVfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIG1vZGVsUGF0aCxcbiAgICAgICAgZHNsU291cmNlUGF0aCwgICAgICAgIFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9LCBjb3JlLm9wdGlvbigncmVzZXQnKSk7XG59O1xuXG5leHBvcnRzLmRhdGFzZXQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgZGF0YXNldCcpO1xuXG4gICAgbGV0IGRhdGFzZXQgPSBhd2FpdCBjb3JlLmdldERhdGFzZXRfKCk7XG4gICAgXG4gICAgY29yZS5hcHAubG9nKCdpbmZvJywgJ0F2YWlsYWJsZSBkYXRhc2V0OiBcXG4nICsgZGF0YXNldC5qb2luKCdcXG4nKSArICdcXG4nKTtcbn1cblxuZXhwb3J0cy5pbXBvcnQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgaW1wb3J0Jyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0U291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJyk7XG4gICAgaWYgKCFzY3JpcHRTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG4gICAgXG4gICAgbGV0IG1vZGVsUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsRGlyKTsgICAgXG4gICAgbGV0IHNjcmlwdFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChzY3JpcHRTb3VyY2VEaXIpO1xuXG4gICAgbGV0IHNjaGVtYSA9IGNvcmUub3B0aW9uKCdzY2hlbWEnKTsgICAgXG4gICAgbGV0IGRhdGFzZXQgPSBjb3JlLm9wdGlvbignZGF0YXNldCcpOyAgICBcblxuICAgIHJldHVybiBjb3JlLmFwaS5pbXBvcnRfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsICAgICAgICBcbiAgICAgICAgbW9kZWxQYXRoLFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLCAgICAgICAgXG4gICAgICAgIHNjaGVtYURlcGxveW1lbnQ6IGNvcmUuc2NoZW1hRGVwbG95bWVudFxuICAgIH0sIHNjaGVtYSwgZGF0YXNldCk7XG59XG5cbmV4cG9ydHMucmV2ZXJzZSA9IGFzeW5jIChjb3JlKSA9PiB7XG4gICAgY29yZS5hcHAubG9nKCd2ZXJib3NlJywgJ29vbG9uZyByZXZlcnNlJyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgZHNsUmV2ZXJzZU91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmRzbFJldmVyc2VPdXRwdXREaXInKTtcbiAgICBpZiAoIWRzbFJldmVyc2VPdXRwdXREaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5kc2xPdXRwdXREaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgb3V0cHV0RGlyID0gY29yZS5nZXRSZXZlcnNlT3V0cHV0RGlyKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFJldmVyc2VPdXRwdXREaXIpKTtcblxuICAgIC8vdG9kbzogcmVsb2NhdGlvbiwgYW5kIGRlZXAgY29weSBjb25uZWN0aW9uIG9wdGlvbnNcbiAgICBsZXQgY29ubiA9IGNvcmUub3B0aW9uKCdjb25uJyk7XG4gICAgbGV0IFsgZHJpdmVyIF0gPSBleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZShjb25uKTtcbiAgICBsZXQgY29ubk9wdGlvbnMgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ2RhdGFTb3VyY2UuJyArIGNvbm4pO1xuICAgIGFzc2VydDogY29ubk9wdGlvbnM7ICAgIFxuXG4gICAgaWYgKHR5cGVvZiBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyA9IHJlcXVpcmUoY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKSk7XG4gICAgfSBcblxuICAgIGFzc2VydDogIWNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyB8fCBfLmlzUGxhaW5PYmplY3QoY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzKTtcblxuICAgIHJldHVybiBjb3JlLmFwaS5yZXZlcnNlXyh7IFxuICAgICAgICBsb2dnZXI6IGNvcmUuYXBwLmxvZ2dlcixcbiAgICAgICAgZHNsUmV2ZXJzZU91dHB1dFBhdGg6IG91dHB1dERpcixcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICBjb25uT3B0aW9uc1xuICAgIH0pO1xufTsiXX0=