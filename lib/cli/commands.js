"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const {
  extractDriverAndConnectorName
} = require('../utils/lang');

exports.commands = {
  'list': 'List all oolong schemas.',
  'create': 'Create database schema.',
  'config': 'Enable oolong feature and add deploy config.',
  'build': 'Generate database scripts and entity models.',
  'migrate': 'Create database structure.',
  'dataset': 'List available data set.',
  'import': 'Import data set.',
  'reverse': 'Reverse engineering from a databse.'
};

exports.options = core => {
  let cmdOptions = {};

  switch (core.command) {
    case 'list':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      break;

    case 'create':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      cmdOptions['schema'] = {
        desc: 'Specify the schema name of the database',
        alias: ['s'],
        required: true,
        inquire: true
      };
      break;

    case 'config':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAvailableAppNames(core))
      };
      cmdOptions['schema'] = {
        desc: 'The name of the schema',
        promptMessage: 'Please select the target schema:',
        alias: ['s'],
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => Promise.resolve(MowaHelper.getAppSchemas(core))
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to be deployed',
        promptMessage: 'Please select the target db:',
        alias: ['database'],
        required: true,
        inquire: true,
        promptType: 'list',
        choicesProvider: () => {
          let conns = MowaHelper.getAppDbConnections(core);

          if (_.isEmpty(conns)) {
            throw new Error('Database connections not found. Config database connection first or run "mowa db add" first.');
          }

          return conns;
        }
      };
      break;

    case 'migrate':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['r'] = {
        desc: 'Reset all data if the database exists',
        promptMessage: 'Reset existing database?',
        promptDefault: false,
        inquire: true,
        required: true,
        alias: ['reset'],
        isBool: true
      };
      break;

    case 'build':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      break;

    case 'dataset':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        promptMessage: 'Please select the target app:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAvailableAppNames(core)
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to operate',
        promptMessage: 'Please select the target db:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAppDbConnections(core)
      };
      break;

    case 'import':
      cmdOptions['app'] = {
        desc: 'The name of the app to operate',
        promptMessage: 'Please select the target app:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAvailableAppNames(core)
      };
      cmdOptions['db'] = {
        desc: 'The name of the db to operate',
        promptMessage: 'Please select the target db:',
        inquire: true,
        promptType: 'list',
        choicesProvider: () => MowaHelper.getAppDbConnections(core)
      };
      cmdOptions['dataSet'] = {
        desc: 'The name of the data set to import',
        promptMessage: 'Please select the target data set:',
        alias: ['ds', 'data'],
        inquire: true,
        promptType: 'list',
        choicesProvider: () => listAvailableDataSet(core, core.getOption('db'))
      };
      break;

    case 'reverse':
      let connectionStrings;
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json",
        afterInquire: () => {
          connectionStrings = core.getConnectionStrings(core.option('c'));
        }
      };
      cmdOptions['conn'] = {
        desc: 'The data source connector',
        alias: ['connector'],
        promptMessage: 'Please select the data source connector:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Object.keys(connectionStrings),
        afterInquire: () => {
          console.log('The conenction string of selected connector:', connectionStrings[core.option('conn')]);
        }
      };
      break;

    default:
      break;
  }

  return cmdOptions;
};

exports.main = core => {
  if (core.option('v')) {
    console.log('v' + core.app.version);
  } else {
    core.showUsage();
  }
};

exports.build = async core => {
  core.app.log('verbose', 'oolong model');
  let oolongConfig = core.oolongConfig;
  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let modelOutputDir = Util.getValueByPath(oolongConfig, 'oolong.modelOutputDir');

  if (!modelOutputDir) {
    throw new Error('"oolong.modelOutputDir" not found in oolong config.');
  }

  let scriptOutputDir = Util.getValueByPath(oolongConfig, 'oolong.scriptOutputDir');

  if (!scriptOutputDir) {
    throw new Error('"oolong.scriptOutputDir" not found in oolong config.');
  }

  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let modelOutputPath = core.app.toAbsolutePath(modelOutputDir);
  let scriptOutputPath = core.app.toAbsolutePath(scriptOutputDir);

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  let saveIntermediate = Util.getValueByPath(oolongConfig, 'oolong.saveIntermediate', false);
  return core.api.build_({
    logger: core.app.logger,
    dslSourcePath,
    modelOutputPath,
    scriptOutputPath,
    useJsonSource,
    saveIntermediate,
    schemaDeployment: core.schemaDeployment
  });
};

exports.migrate = async core => {
  core.app.log('verbose', 'oolong deploy');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);

  if (!fs.existsSync(modelPath)) {
    return Promise.reject(`Model directory "${modelPath}" not found.`);
  }

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  if (!fs.existsSync(scriptSourcePath)) {
    return Promise.reject(`Database scripts directory "${scriptSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  return core.api.migrate_({
    logger: core.app.logger,
    modelPath,
    dslSourcePath,
    scriptSourcePath,
    useJsonSource,
    schemaDeployment: core.schemaDeployment
  }, core.option('reset'));
};

exports.reverse = async core => {
  core.app.log('verbose', 'oolong reverse');
  let oolongConfig = core.oolongConfig;
  let dslReverseOutputDir = Util.getValueByPath(oolongConfig, 'oolong.dslReverseOutputDir');

  if (!dslReverseOutputDir) {
    throw new Error('"oolong.dslOutputDir" not found in oolong config.');
  }

  let outputDir = core.getReverseOutputDir(core.app.toAbsolutePath(dslReverseOutputDir));
  let conn = core.option('conn');
  let [driver] = extractDriverAndConnectorName(conn);
  let connOptions = Util.getValueByPath(oolongConfig, 'dataSource.' + conn);

  if (!connOptions) {
    throw new Error("Assertion failed: connOptions");
  }

  if (typeof connOptions.reverseRules === 'string') {
    connOptions.reverseRules = require(core.app.toAbsolutePath(connOptions.reverseRules));
  }

  if (!(!connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules))) {
    throw new Error("Assertion failed: !connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules)");
  }

  return core.api.reverse_({
    logger: core.app.logger,
    dslReverseOutputDir: outputDir,
    driver,
    connOptions
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29tbWFuZHMuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZnMiLCJleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZSIsImV4cG9ydHMiLCJjb21tYW5kcyIsIm9wdGlvbnMiLCJjb3JlIiwiY21kT3B0aW9ucyIsImNvbW1hbmQiLCJkZXNjIiwicmVxdWlyZWQiLCJpbnF1aXJlIiwicHJvbXB0VHlwZSIsImNob2ljZXNQcm92aWRlciIsIlByb21pc2UiLCJyZXNvbHZlIiwiTW93YUhlbHBlciIsImdldEF2YWlsYWJsZUFwcE5hbWVzIiwiYWxpYXMiLCJwcm9tcHRNZXNzYWdlIiwiZ2V0QXBwU2NoZW1hcyIsImNvbm5zIiwiZ2V0QXBwRGJDb25uZWN0aW9ucyIsImlzRW1wdHkiLCJFcnJvciIsInByb21wdERlZmF1bHQiLCJpc0Jvb2wiLCJsaXN0QXZhaWxhYmxlRGF0YVNldCIsImdldE9wdGlvbiIsImNvbm5lY3Rpb25TdHJpbmdzIiwiYWZ0ZXJJbnF1aXJlIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvcHRpb24iLCJPYmplY3QiLCJrZXlzIiwiY29uc29sZSIsImxvZyIsIm1haW4iLCJhcHAiLCJ2ZXJzaW9uIiwic2hvd1VzYWdlIiwiYnVpbGQiLCJvb2xvbmdDb25maWciLCJkc2xTb3VyY2VEaXIiLCJnZXRWYWx1ZUJ5UGF0aCIsIm1vZGVsT3V0cHV0RGlyIiwic2NyaXB0T3V0cHV0RGlyIiwiZHNsU291cmNlUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwibW9kZWxPdXRwdXRQYXRoIiwic2NyaXB0T3V0cHV0UGF0aCIsImV4aXN0c1N5bmMiLCJyZWplY3QiLCJ1c2VKc29uU291cmNlIiwic2F2ZUludGVybWVkaWF0ZSIsImFwaSIsImJ1aWxkXyIsImxvZ2dlciIsInNjaGVtYURlcGxveW1lbnQiLCJtaWdyYXRlIiwibW9kZWxEaXIiLCJzY3JpcHRTb3VyY2VEaXIiLCJtb2RlbFBhdGgiLCJzY3JpcHRTb3VyY2VQYXRoIiwibWlncmF0ZV8iLCJyZXZlcnNlIiwiZHNsUmV2ZXJzZU91dHB1dERpciIsIm91dHB1dERpciIsImdldFJldmVyc2VPdXRwdXREaXIiLCJjb25uIiwiZHJpdmVyIiwiY29ubk9wdGlvbnMiLCJyZXZlcnNlUnVsZXMiLCJpc1BsYWluT2JqZWN0IiwicmV2ZXJzZV8iXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFZSCxJQUFsQjs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBO0FBQUYsSUFBb0NILE9BQU8sQ0FBQyxlQUFELENBQWpEOztBQUVBSSxPQUFPLENBQUNDLFFBQVIsR0FBbUI7QUFDZixVQUFRLDBCQURPO0FBRWYsWUFBVSx5QkFGSztBQUdmLFlBQVUsOENBSEs7QUFJZixXQUFTLDhDQUpNO0FBS2YsYUFBVyw0QkFMSTtBQU1mLGFBQVcsMEJBTkk7QUFPZixZQUFVLGtCQVBLO0FBUWYsYUFBVztBQVJJLENBQW5COztBQWNBRCxPQUFPLENBQUNFLE9BQVIsR0FBbUJDLElBQUQsSUFBVTtBQUN4QixNQUFJQyxVQUFVLEdBQUcsRUFBakI7O0FBRUEsVUFBUUQsSUFBSSxDQUFDRSxPQUFiO0FBQ0ksU0FBSyxNQUFMO0FBQ0lELE1BQUFBLFVBQVUsQ0FBQyxLQUFELENBQVYsR0FBb0I7QUFDaEJFLFFBQUFBLElBQUksRUFBRSxnQ0FEVTtBQUVoQkMsUUFBQUEsUUFBUSxFQUFFLElBRk07QUFHaEJDLFFBQUFBLE9BQU8sRUFBRSxJQUhPO0FBSWhCQyxRQUFBQSxVQUFVLEVBQUUsTUFKSTtBQUtoQkMsUUFBQUEsZUFBZSxFQUFFLE1BQU1DLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQkMsVUFBVSxDQUFDQyxvQkFBWCxDQUFnQ1gsSUFBaEMsQ0FBaEI7QUFMUCxPQUFwQjtBQU9BOztBQUVKLFNBQUssUUFBTDtBQUNJQyxNQUFBQSxVQUFVLENBQUMs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QUFiLElBQTZCeEUsQ0FBQyxDQUFDeUUsYUFBRixDQUFnQkYsV0FBVyxDQUFDQyxZQUE1QixDQXRCUDtBQUFBO0FBQUE7O0FBd0I5QixTQUFPbEUsSUFBSSxDQUFDaUQsR0FBTCxDQUFTbUIsUUFBVCxDQUFrQjtBQUNyQmpCLElBQUFBLE1BQU0sRUFBRW5ELElBQUksQ0FBQ2dDLEdBQUwsQ0FBU21CLE1BREk7QUFFckJTLElBQUFBLG1CQUFtQixFQUFFQyxTQUZBO0FBR3JCRyxJQUFBQSxNQUhxQjtBQUlyQkMsSUFBQUE7QUFKcUIsR0FBbEIsQ0FBUDtBQU1ILENBOUJEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IHsgZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuZXhwb3J0cy5jb21tYW5kcyA9IHtcbiAgICAnbGlzdCc6ICdMaXN0IGFsbCBvb2xvbmcgc2NoZW1hcy4nLFxuICAgICdjcmVhdGUnOiAnQ3JlYXRlIGRhdGFiYXNlIHNjaGVtYS4nLFxuICAgICdjb25maWcnOiAnRW5hYmxlIG9vbG9uZyBmZWF0dXJlIGFuZCBhZGQgZGVwbG95IGNvbmZpZy4nLFxuICAgICdidWlsZCc6ICdHZW5lcmF0ZSBkYXRhYmFzZSBzY3JpcHRzIGFuZCBlbnRpdHkgbW9kZWxzLicsXG4gICAgJ21pZ3JhdGUnOiAnQ3JlYXRlIGRhdGFiYXNlIHN0cnVjdHVyZS4nLFxuICAgICdkYXRhc2V0JzogJ0xpc3QgYXZhaWxhYmxlIGRhdGEgc2V0LicsXG4gICAgJ2ltcG9ydCc6ICdJbXBvcnQgZGF0YSBzZXQuJyxcbiAgICAncmV2ZXJzZSc6ICdSZXZlcnNlIGVuZ2luZWVyaW5nIGZyb20gYSBkYXRhYnNlLidcbn07XG5cbi8qKlxuICogQHBhcmFtIHtPb2xvbmdDb3JlfSBjb3JlIC0gT29sb25nQ29yZSBvYmplY3QuXG4gKi9cbmV4cG9ydHMub3B0aW9ucyA9IChjb3JlKSA9PiB7XG4gICAgbGV0IGNtZE9wdGlvbnMgPSB7fTtcblxuICAgIHN3aXRjaCAoY29yZS5jb21tYW5kKSB7XG4gICAgICAgIGNhc2UgJ2xpc3QnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYXBwJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBhcHAgdG8gb3BlcmF0ZScsXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoTW93YUhlbHBlci5nZXRBdmFpbGFibGVBcHBOYW1lcyhjb3JlKSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdjcmVhdGUnOlxuICAgICAgICAgICAgY21kT3B0aW9uc1snYXBwJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBhcHAgdG8gb3BlcmF0ZScsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoTW93YUhlbHBlci5nZXRBdmFpbGFibGVBcHBOYW1lcyhjb3JlKSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydzY2hlbWEnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnU3BlY2lmeSB0aGUgc2NoZW1hIG5hbWUgb2YgdGhlIGRhdGFiYXNlJyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAncycgXSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnY29uZmlnJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2FwcCddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgbmFtZSBvZiB0aGUgYXBwIHRvIG9wZXJhdGUnLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKE1vd2FIZWxwZXIuZ2V0QXZhaWxhYmxlQXBwTmFtZXMoY29yZSkpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY21kT3B0aW9uc1snc2NoZW1hJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBzY2hlbWEnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgc2NoZW1hOicsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ3MnIF0sXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoTW93YUhlbHBlci5nZXRBcHBTY2hlbWFzKGNvcmUpKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2RiJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBkYiB0byBiZSBkZXBsb3llZCcsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgdGhlIHRhcmdldCBkYjonLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbICdkYXRhYmFzZScgXSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbm5zID0gTW93YUhlbHBlci5nZXRBcHBEYkNvbm5lY3Rpb25zKGNvcmUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGNvbm5zKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhYmFzZSBjb25uZWN0aW9ucyBub3QgZm91bmQuIENvbmZpZyBkYXRhYmFzZSBjb25uZWN0aW9uIGZpcnN0IG9yIHJ1biBcIm1vd2EgZGIgYWRkXCIgZmlyc3QuJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbm5zO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdtaWdyYXRlJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydyJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1Jlc2V0IGFsbCBkYXRhIGlmIHRoZSBkYXRhYmFzZSBleGlzdHMnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdSZXNldCBleGlzdGluZyBkYXRhYmFzZT8nLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ3Jlc2V0JyBdLFxuICAgICAgICAgICAgICAgIGlzQm9vbDogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2J1aWxkJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdkYXRhc2V0JzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2FwcCddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgbmFtZSBvZiB0aGUgYXBwIHRvIG9wZXJhdGUnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgYXBwOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBNb3dhSGVscGVyLmdldEF2YWlsYWJsZUFwcE5hbWVzKGNvcmUpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY21kT3B0aW9uc1snZGInXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGRiIHRvIG9wZXJhdGUnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgZGI6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE1vd2FIZWxwZXIuZ2V0QXBwRGJDb25uZWN0aW9ucyhjb3JlKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2ltcG9ydCc6XG4gICAgICAgICAgICBjbWRPcHRpb25zWydhcHAnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIG5hbWUgb2YgdGhlIGFwcCB0byBvcGVyYXRlJyxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIHNlbGVjdCB0aGUgdGFyZ2V0IGFwcDonLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gTW93YUhlbHBlci5nZXRBdmFpbGFibGVBcHBOYW1lcyhjb3JlKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2RiJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBkYiB0byBvcGVyYXRlJyxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIHNlbGVjdCB0aGUgdGFyZ2V0IGRiOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBNb3dhSGVscGVyLmdldEFwcERiQ29ubmVjdGlvbnMoY29yZSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydkYXRhU2V0J10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBkYXRhIHNldCB0byBpbXBvcnQnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgZGF0YSBzZXQ6JyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAnZHMnLCAnZGF0YScgXSxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IGxpc3RBdmFpbGFibGVEYXRhU2V0KGNvcmUsIGNvcmUuZ2V0T3B0aW9uKCdkYicpKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ3JldmVyc2UnOiAgICAgICAgXG4gICAgICAgICAgICBsZXQgY29ubmVjdGlvblN0cmluZ3M7XG5cbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiLFxuICAgICAgICAgICAgICAgIGFmdGVySW5xdWlyZTogKCkgPT4geyBjb25uZWN0aW9uU3RyaW5ncyA9IGNvcmUuZ2V0Q29ubmVjdGlvblN0cmluZ3MoY29yZS5vcHRpb24oJ2MnKSk7IH1cbiAgICAgICAgICAgIH07ICAgXG5cbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2Nvbm4nXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIGRhdGEgc291cmNlIGNvbm5lY3RvcicsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ2Nvbm5lY3RvcicgXSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIHNlbGVjdCB0aGUgZGF0YSBzb3VyY2UgY29ubmVjdG9yOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBPYmplY3Qua2V5cyhjb25uZWN0aW9uU3RyaW5ncyksXG4gICAgICAgICAgICAgICAgYWZ0ZXJJbnF1aXJlOiAoKSA9PiB7IGNvbnNvbGUubG9nKCdUaGUgY29uZW5jdGlvbiBzdHJpbmcgb2Ygc2VsZWN0ZWQgY29ubmVjdG9yOicsIGNvbm5lY3Rpb25TdHJpbmdzW2NvcmUub3B0aW9uKCdjb25uJyldKTsgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAvL21vZHVsZSBnZW5lcmFsIG9wdGlvbnNcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiBjbWRPcHRpb25zO1xufTtcblxuZXhwb3J0cy5tYWluID0gKGNvcmUpID0+IHtcbiAgICBpZiAoY29yZS5vcHRpb24oJ3YnKSkge1xuICAgICAgICBjb25zb2xlLmxvZygndicgKyBjb3JlLmFwcC52ZXJzaW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb3JlLnNob3dVc2FnZSgpO1xuICAgIH1cbn07XG5cbmV4cG9ydHMuYnVpbGQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgbW9kZWwnKTtcblxuICAgIGxldCBvb2xvbmdDb25maWcgPSBjb3JlLm9vbG9uZ0NvbmZpZztcblxuICAgIGxldCBkc2xTb3VyY2VEaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kc2xTb3VyY2VEaXInKTtcbiAgICBpZiAoIWRzbFNvdXJjZURpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLmRzbFNvdXJjZURpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBtb2RlbE91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLm1vZGVsT3V0cHV0RGlyJyk7XG4gICAgaWYgKCFtb2RlbE91dHB1dERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLm1vZGVsT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IHNjcmlwdE91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdE91dHB1dERpcicpO1xuICAgIGlmICghc2NyaXB0T3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuc2NyaXB0T3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IGRzbFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xTb3VyY2VEaXIpOyAgICBcbiAgICBsZXQgbW9kZWxPdXRwdXRQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgobW9kZWxPdXRwdXREaXIpO1xuICAgIGxldCBzY3JpcHRPdXRwdXRQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0T3V0cHV0RGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgdXNlSnNvblNvdXJjZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnVzZUpzb25Tb3VyY2UnLCBmYWxzZSk7ICAgICAgIFxuICAgIGxldCBzYXZlSW50ZXJtZWRpYXRlID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2F2ZUludGVybWVkaWF0ZScsIGZhbHNlKTsgICAgICAgXG5cbiAgICByZXR1cm4gY29yZS5hcGkuYnVpbGRfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFNvdXJjZVBhdGgsXG4gICAgICAgIG1vZGVsT3V0cHV0UGF0aCxcbiAgICAgICAgc2NyaXB0T3V0cHV0UGF0aCxcbiAgICAgICAgdXNlSnNvblNvdXJjZSxcbiAgICAgICAgc2F2ZUludGVybWVkaWF0ZSxcbiAgICAgICAgc2NoZW1hRGVwbG95bWVudDogY29yZS5zY2hlbWFEZXBsb3ltZW50XG4gICAgfSk7XG59O1xuXG5leHBvcnRzLm1pZ3JhdGUgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgZGVwbG95Jyk7XG5cbiAgICBsZXQgb29sb25nQ29uZmlnID0gY29yZS5vb2xvbmdDb25maWc7XG5cbiAgICBsZXQgbW9kZWxEaXIgID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubW9kZWxEaXInKTtcbiAgICBpZiAoIW1vZGVsRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcubW9kZWxEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgZHNsU291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuZHNsU291cmNlRGlyJyk7XG4gICAgaWYgKCFkc2xTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5kc2xTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgc2NyaXB0U291cmNlRGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcuc2NyaXB0U291cmNlRGlyJyk7XG4gICAgaWYgKCFzY3JpcHRTb3VyY2VEaXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcIm9vbG9uZy5zY3JpcHRTb3VyY2VEaXJcIiBub3QgZm91bmQgaW4gb29sb25nIGNvbmZpZy4nKTtcbiAgICB9XG5cbiAgICBsZXQgbW9kZWxQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgobW9kZWxEaXIpOyAgICBcbiAgICBsZXQgZHNsU291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFNvdXJjZURpcik7ICAgIFxuICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0U291cmNlRGlyKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2RlbFBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgTW9kZWwgZGlyZWN0b3J5IFwiJHttb2RlbFBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkc2xTb3VyY2VQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERTTCBzb3VyY2UgZGlyZWN0b3J5IFwiJHtkc2xTb3VyY2VQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyaXB0U291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhYmFzZSBzY3JpcHRzIGRpcmVjdG9yeSBcIiR7c2NyaXB0U291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZUpzb25Tb3VyY2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy51c2VKc29uU291cmNlJywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIGNvcmUuYXBpLm1pZ3JhdGVfKHtcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIG1vZGVsUGF0aCxcbiAgICAgICAgZHNsU291cmNlUGF0aCwgICAgICAgIFxuICAgICAgICBzY3JpcHRTb3VyY2VQYXRoLFxuICAgICAgICB1c2VKc29uU291cmNlLFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9LCBjb3JlLm9wdGlvbigncmVzZXQnKSk7XG59O1xuXG5leHBvcnRzLnJldmVyc2UgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgcmV2ZXJzZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRzbFJldmVyc2VPdXRwdXREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kc2xSZXZlcnNlT3V0cHV0RGlyJyk7XG4gICAgaWYgKCFkc2xSZXZlcnNlT3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG91dHB1dERpciA9IGNvcmUuZ2V0UmV2ZXJzZU91dHB1dERpcihjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xSZXZlcnNlT3V0cHV0RGlyKSk7XG5cbiAgICAvL3RvZG86IHJlbG9jYXRpb24sIGFuZCBkZWVwIGNvcHkgY29ubmVjdGlvbiBvcHRpb25zXG4gICAgbGV0IGNvbm4gPSBjb3JlLm9wdGlvbignY29ubicpO1xuICAgIGxldCBbIGRyaXZlciBdID0gZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUoY29ubik7XG4gICAgbGV0IGNvbm5PcHRpb25zID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBjb25uKTtcbiAgICBhc3NlcnQ6IGNvbm5PcHRpb25zOyAgICBcblxuICAgIGlmICh0eXBlb2YgY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPSByZXF1aXJlKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcykpO1xuICAgIH0gXG5cbiAgICBhc3NlcnQ6ICFjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwgXy5pc1BsYWluT2JqZWN0KGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkucmV2ZXJzZV8oeyBcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFJldmVyc2VPdXRwdXREaXI6IG91dHB1dERpcixcbiAgICAgICAgZHJpdmVyLFxuICAgICAgICBjb25uT3B0aW9uc1xuICAgIH0pO1xufTsiXX0=