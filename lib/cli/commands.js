"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  fs
} = Util;

const {
  extractDriverAndConnectorName
} = require('../utils/lang');

exports.commands = {
  'build': 'Generate database scripts and entity models.',
  'migrate': 'Create database structure.',
  'dataset': 'List available data set.',
  'import': 'Import data set.',
  'reverse': 'Reverse engineering from a databse.',
  'listValidators': 'List all builtin validators.'
};

exports.options = core => {
  let cmdOptions = {};

  switch (core.command) {
    case 'build':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      break;

    case 'migrate':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['r'] = {
        desc: 'Reset all data if the database exists',
        promptMessage: 'Reset existing database?',
        promptDefault: false,
        inquire: true,
        required: true,
        alias: ['reset'],
        isBool: true
      };
      break;

    case 'dataset':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['schema'] = {
        desc: 'The schema to list',
        promptMessage: 'Please select a schema:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => core.getSchemasInConfig()
      };
      break;

    case 'import':
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json"
      };
      cmdOptions['schema'] = {
        desc: 'The schema to list',
        promptMessage: 'Please select a schema:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => core.getSchemasInConfig()
      };
      cmdOptions['dataset'] = {
        desc: 'The name of the data set to import',
        promptMessage: 'Please select the target dataset:',
        alias: ['ds', 'data'],
        inquire: true,
        promptType: 'list',
        choicesProvider: () => core.getDataset_()
      };
      break;

    case 'reverse':
      let connectionStrings;
      cmdOptions['c'] = {
        desc: "Oolong config file",
        alias: ["conf", "config"],
        inquire: true,
        promptMessage: 'Please input the config file path:',
        promptDefault: "conf/oolong.json",
        afterInquire: () => {
          connectionStrings = core.getConnectionStrings(core.option('c'));
        }
      };
      cmdOptions['conn'] = {
        desc: 'The data source connector',
        alias: ['connector'],
        promptMessage: 'Please select the data source connector:',
        inquire: true,
        required: true,
        promptType: 'list',
        choicesProvider: () => Object.keys(connectionStrings),
        afterInquire: () => {
          console.log('The conenction string of selected connector:', connectionStrings[core.option('conn')]);
        }
      };
      break;

    case 'listValidators':
      break;

    default:
      break;
  }

  return cmdOptions;
};

exports.main = core => {
  if (core.option('v')) {
    console.log('v' + core.app.version);
  } else {
    core.showUsage();
  }
};

exports.build = async core => {
  core.app.log('verbose', 'oolong build');
  let oolongConfig = core.oolongConfig;
  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let modelOutputDir = Util.getValueByPath(oolongConfig, 'oolong.modelOutputDir');

  if (!modelOutputDir) {
    throw new Error('"oolong.modelOutputDir" not found in oolong config.');
  }

  let scriptOutputDir = Util.getValueByPath(oolongConfig, 'oolong.scriptOutputDir');

  if (!scriptOutputDir) {
    throw new Error('"oolong.scriptOutputDir" not found in oolong config.');
  }

  let manifestOutputDir = Util.getValueByPath(oolongConfig, 'oolong.manifestOutputDir');
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let modelOutputPath = core.app.toAbsolutePath(modelOutputDir);
  let scriptOutputPath = core.app.toAbsolutePath(scriptOutputDir);
  let manifestOutputPath = manifestOutputDir && core.app.toAbsolutePath(manifestOutputDir);

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  let saveIntermediate = Util.getValueByPath(oolongConfig, 'oolong.saveIntermediate', false);
  return core.api.build_({
    logger: core.app.logger,
    dslSourcePath,
    modelOutputPath,
    scriptOutputPath,
    manifestOutputPath,
    useJsonSource,
    saveIntermediate,
    schemaDeployment: core.schemaDeployment
  });
};

exports.migrate = async core => {
  core.app.log('verbose', 'oolong migrate');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let dslSourceDir = Util.getValueByPath(oolongConfig, 'oolong.dslSourceDir');

  if (!dslSourceDir) {
    throw new Error('"oolong.dslSourceDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let dslSourcePath = core.app.toAbsolutePath(dslSourceDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);

  if (!fs.existsSync(modelPath)) {
    return Promise.reject(`Model directory "${modelPath}" not found.`);
  }

  if (!fs.existsSync(dslSourcePath)) {
    return Promise.reject(`DSL source directory "${dslSourcePath}" not found.`);
  }

  if (!fs.existsSync(scriptSourcePath)) {
    return Promise.reject(`Database scripts directory "${scriptSourcePath}" not found.`);
  }

  let useJsonSource = Util.getValueByPath(oolongConfig, 'oolong.useJsonSource', false);
  return core.api.migrate_({
    logger: core.app.logger,
    modelPath,
    dslSourcePath,
    scriptSourcePath,
    useJsonSource,
    schemaDeployment: core.schemaDeployment
  }, core.option('reset'));
};

exports.dataset = async core => {
  core.app.log('verbose', 'oolong dataset');
  let dataset = await core.getDataset_();
  core.app.log('info', 'Available dataset: \n' + dataset.join('\n') + '\n');
};

exports.import = async core => {
  core.app.log('verbose', 'oolong import');
  let oolongConfig = core.oolongConfig;
  let modelDir = Util.getValueByPath(oolongConfig, 'oolong.modelDir');

  if (!modelDir) {
    throw new Error('"oolong.modelDir" not found in oolong config.');
  }

  let scriptSourceDir = Util.getValueByPath(oolongConfig, 'oolong.scriptSourceDir');

  if (!scriptSourceDir) {
    throw new Error('"oolong.scriptSourceDir" not found in oolong config.');
  }

  let modelPath = core.app.toAbsolutePath(modelDir);
  let scriptSourcePath = core.app.toAbsolutePath(scriptSourceDir);
  let schema = core.option('schema');
  let dataset = core.option('dataset');
  return core.api.import_({
    logger: core.app.logger,
    modelPath,
    scriptSourcePath,
    schemaDeployment: core.schemaDeployment
  }, schema, dataset);
};

exports.reverse = async core => {
  core.app.log('verbose', 'oolong reverse');
  let oolongConfig = core.oolongConfig;
  let dslReverseOutputDir = Util.getValueByPath(oolongConfig, 'oolong.dslReverseOutputDir');

  if (!dslReverseOutputDir) {
    throw new Error('"oolong.dslOutputDir" not found in oolong config.');
  }

  let outputDir = core.getReverseOutputDir(core.app.toAbsolutePath(dslReverseOutputDir));
  let conn = core.option('conn');
  let [driver] = extractDriverAndConnectorName(conn);
  let connOptions = Util.getValueByPath(oolongConfig, 'dataSource.' + conn);

  if (!connOptions) {
    throw new Error("Assertion failed: connOptions");
  }

  if (typeof connOptions.reverseRules === 'string') {
    connOptions.reverseRules = require(core.app.toAbsolutePath(connOptions.reverseRules));
  }

  if (!(!connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules))) {
    throw new Error("Assertion failed: !connOptions.reverseRules || _.isPlainObject(connOptions.reverseRules)");
  }

  return core.api.reverse_({
    logger: core.app.logger,
    dslReverseOutputPath: outputDir,
    driver,
    connOptions
  });
};

exports.listValidators = async core => {
  core.app.log('verbose', 'oolong listValidators');
  let list = core.api.getValidatorList();
  core.app.log('info', 'Available validators: \n' + list.join('\n') + '\n');
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29tbWFuZHMuanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZnMiLCJleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZSIsImV4cG9ydHMiLCJjb21tYW5kcyIsIm9wdGlvbnMiLCJjb3JlIiwiY21kT3B0aW9ucyIsImNvbW1hbmQiLCJkZXNjIiwiYWxpYXMiLCJpbnF1aXJlIiwicHJvbXB0TWVzc2FnZSIsInByb21wdERlZmF1bHQiLCJyZXF1aXJlZCIsImlzQm9vbCIsInByb21wdFR5cGUiLCJjaG9pY2VzUHJvdmlkZXIiLCJnZXRTY2hlbWFzSW5Db25maWciLCJnZXREYXRhc2V0XyIsImNvbm5lY3Rpb25TdHJpbmdzIiwiYWZ0ZXJJbnF1aXJlIiwiZ2V0Q29ubmVjdGlvblN0cmluZ3MiLCJvcHRpb24iLCJPYmplY3QiLCJrZXlzIiwiY29uc29sZSIsImxvZyIsIm1haW4iLCJhcHAiLCJ2ZXJzaW9uIiwic2hvd1VzYWdlIiwiYnVpbGQiLCJvb2xvbmdDb25maWciLCJkc2xTb3VyY2VEaXIiLCJnZXRWYWx1ZUJ5UGF0aCIsIkVycm9yIiwibW9kZWxPdXRwdXREaXIiLCJzY3JpcHRPdXRwdXREaXIiLCJtYW5pZmVzdE91dHB1dERpciIsImRzbFNvdXJjZVBhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIm1vZGVsT3V0cHV0UGF0aCIsInNjcmlwdE91dHB1dFBhdGgiLCJtYW5pZmVzdE91dHB1dFBhdGgiLCJleGlzdHNTeW5jIiwiUHJvbWlzZSIsInJlamVjdCIsInVzZUpzb25Tb3VyY2UiLCJzYXZlSW50ZXJtZWRpYXRlIiwiYXBpIiwiYnVpbGRfIiwibG9nZ2VyIiwic2NoZW1hRGVwbG95bWVudCIsIm1pZ3JhdGUiLCJtb2RlbERpciIsInNjcmlwdFNvdXJjZURpciIsIm1vZGVsUGF0aCIsInNjcmlwdFNvdXJjZVBhdGgiLCJtaWdyYXRlXyIsImRhdGFzZXQiLCJqb2luIiwiaW1wb3J0Iiwic2NoZW1hIiwiaW1wb3J0XyIsInJldmVyc2UiLCJkc2xSZXZlcnNlT3V0cHV0RGlyIiwib3V0cHV0RGlyIiwiZ2V0UmV2ZXJzZU91dHB1dERpciIsImNvbm4iLCJkcml2ZXIiLCJjb25uT3B0aW9ucyIsInJldmVyc2VSdWxlcyIsImlzUGxhaW5PYmplY3QiLCJyZXZlcnNlXyIsImRzbFJldmVyc2VPdXRwdXRQYXRoIiwibGlzdFZhbGlkYXRvcnMiLCJsaXN0IiwiZ2V0VmFsaWRhdG9yTGlzdCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQVlILElBQWxCOztBQUNBLE1BQU07QUFBRUksRUFBQUE7QUFBRixJQUFvQ0gsT0FBTyxDQUFDLGVBQUQsQ0FBakQ7O0FBRUFJLE9BQU8sQ0FBQ0MsUUFBUixHQUFtQjtBQUNmLFdBQVMsOENBRE07QUFFZixhQUFXLDRCQUZJO0FBR2YsYUFBVywwQkFISTtBQUlmLFlBQVUsa0JBSks7QUFLZixhQUFXLHFDQUxJO0FBTWYsb0JBQWtCO0FBTkgsQ0FBbkI7O0FBWUFELE9BQU8sQ0FBQ0UsT0FBUixHQUFtQkMsSUFBRCxJQUFVO0FBQ3hCLE1BQUlDLFVBQVUsR0FBRyxFQUFqQjs7QUFFQSxVQUFRRCxJQUFJLENBQUNFLE9BQWI7QUFDSSxTQUFLLE9BQUw7QUFDSUQsTUFBQUEsVUFBVSxDQUFDLEdBQUQsQ0FBVixHQUFrQjtBQUNkRSxRQUFBQSxJQUFJLEVBQUUsb0JBRFE7QUFFZEMsUUFBQUEsS0FBSyxFQUFFLENBQUUsTUFBRixFQUFVLFFBQVYsQ0FGTztBQUdkQyxRQUFBQSxPQUFPLEVBQUUsSUFISztBQUlkQyxRQUFBQSxhQUFhLEVBQUUsb0NBSkQ7QUFLZEMsUUFBQUEsYUFBYSxFQUFFO0FBTEQsT0FBbEI7QUFPQTs7QUFFSixTQUFLLFNBQUw7QUFDSU4sTUFBQUEsVUFBVSxDQUFDLEdBQUQsQ0FBVixHQUFrQjtBQUNkRSxRQUFBQSxJ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SUFBSSxDQUFDdUIsR0FBTCxDQUFTRixHQUFULENBQWEsU0FBYixFQUF3Qix1QkFBeEI7QUFFQSxNQUFJa0QsSUFBSSxHQUFHdkUsSUFBSSxDQUFDNEMsR0FBTCxDQUFTNEIsZ0JBQVQsRUFBWDtBQUVBeEUsRUFBQUEsSUFBSSxDQUFDdUIsR0FBTCxDQUFTRixHQUFULENBQWEsTUFBYixFQUFxQiw2QkFBNkJrRCxJQUFJLENBQUNoQixJQUFMLENBQVUsSUFBVixDQUE3QixHQUErQyxJQUFwRTtBQUNILENBTkQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIGZzIH0gPSBVdGlsO1xuY29uc3QgeyBleHRyYWN0RHJpdmVyQW5kQ29ubmVjdG9yTmFtZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbGFuZycpO1xuXG5leHBvcnRzLmNvbW1hbmRzID0geyAgICBcbiAgICAnYnVpbGQnOiAnR2VuZXJhdGUgZGF0YWJhc2Ugc2NyaXB0cyBhbmQgZW50aXR5IG1vZGVscy4nLFxuICAgICdtaWdyYXRlJzogJ0NyZWF0ZSBkYXRhYmFzZSBzdHJ1Y3R1cmUuJywgICAgXG4gICAgJ2RhdGFzZXQnOiAnTGlzdCBhdmFpbGFibGUgZGF0YSBzZXQuJyxcbiAgICAnaW1wb3J0JzogJ0ltcG9ydCBkYXRhIHNldC4nLFxuICAgICdyZXZlcnNlJzogJ1JldmVyc2UgZW5naW5lZXJpbmcgZnJvbSBhIGRhdGFic2UuJyxcbiAgICAnbGlzdFZhbGlkYXRvcnMnOiAnTGlzdCBhbGwgYnVpbHRpbiB2YWxpZGF0b3JzLidcbn07XG5cbi8qKlxuICogQHBhcmFtIHtPb2xvbmdDb3JlfSBjb3JlIC0gT29sb25nQ29yZSBvYmplY3QuXG4gKi9cbmV4cG9ydHMub3B0aW9ucyA9IChjb3JlKSA9PiB7XG4gICAgbGV0IGNtZE9wdGlvbnMgPSB7fTtcblxuICAgIHN3aXRjaCAoY29yZS5jb21tYW5kKSB7XG4gICAgICAgIGNhc2UgJ2J1aWxkJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdtaWdyYXRlJzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydyJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1Jlc2V0IGFsbCBkYXRhIGlmIHRoZSBkYXRhYmFzZSBleGlzdHMnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdSZXNldCBleGlzdGluZyBkYXRhYmFzZT8nLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgJ3Jlc2V0JyBdLFxuICAgICAgICAgICAgICAgIGlzQm9vbDogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrOyAgICAgICAgXG5cbiAgICAgICAgY2FzZSAnZGF0YXNldCc6ICAgICAgICAgICAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydjJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogXCJPb2xvbmcgY29uZmlnIGZpbGVcIixcbiAgICAgICAgICAgICAgICBhbGlhczogWyBcImNvbmZcIiwgXCJjb25maWdcIiBdLCAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2UgaW5wdXQgdGhlIGNvbmZpZyBmaWxlIHBhdGg6JyxcbiAgICAgICAgICAgICAgICBwcm9tcHREZWZhdWx0OiBcImNvbmYvb29sb25nLmpzb25cIlxuICAgICAgICAgICAgfTsgIFxuICAgICAgICAgICAgY21kT3B0aW9uc1snc2NoZW1hJ10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBzY2hlbWEgdG8gbGlzdCcsICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IGEgc2NoZW1hOicsXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRUeXBlOiAnbGlzdCcsXG4gICAgICAgICAgICAgICAgY2hvaWNlc1Byb3ZpZGVyOiAoKSA9PiBjb3JlLmdldFNjaGVtYXNJbkNvbmZpZygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnaW1wb3J0JzpcbiAgICAgICAgICAgIGNtZE9wdGlvbnNbJ2MnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiBcIk9vbG9uZyBjb25maWcgZmlsZVwiLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbIFwiY29uZlwiLCBcImNvbmZpZ1wiIF0sICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBpbnB1dCB0aGUgY29uZmlnIGZpbGUgcGF0aDonLFxuICAgICAgICAgICAgICAgIHByb21wdERlZmF1bHQ6IFwiY29uZi9vb2xvbmcuanNvblwiXG4gICAgICAgICAgICB9OyAgXG4gICAgICAgICAgICBjbWRPcHRpb25zWydzY2hlbWEnXSA9IHtcbiAgICAgICAgICAgICAgICBkZXNjOiAnVGhlIHNjaGVtYSB0byBsaXN0JywgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcHJvbXB0TWVzc2FnZTogJ1BsZWFzZSBzZWxlY3QgYSBzY2hlbWE6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IGNvcmUuZ2V0U2NoZW1hc0luQ29uZmlnKClcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjbWRPcHRpb25zWydkYXRhc2V0J10gPSB7XG4gICAgICAgICAgICAgICAgZGVzYzogJ1RoZSBuYW1lIG9mIHRoZSBkYXRhIHNldCB0byBpbXBvcnQnLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSB0YXJnZXQgZGF0YXNldDonLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBbICdkcycsICdkYXRhJyBdLFxuICAgICAgICAgICAgICAgIGlucXVpcmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJvbXB0VHlwZTogJ2xpc3QnLFxuICAgICAgICAgICAgICAgIGNob2ljZXNQcm92aWRlcjogKCkgPT4gY29yZS5nZXREYXRhc2V0XygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncmV2ZXJzZSc6ICAgICAgICBcbiAgICAgICAgICAgIGxldCBjb25uZWN0aW9uU3RyaW5ncztcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snYyddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6IFwiT29sb25nIGNvbmZpZyBmaWxlXCIsXG4gICAgICAgICAgICAgICAgYWxpYXM6IFsgXCJjb25mXCIsIFwiY29uZmlnXCIgXSwgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5xdWlyZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcm9tcHRNZXNzYWdlOiAnUGxlYXNlIGlucHV0IHRoZSBjb25maWcgZmlsZSBwYXRoOicsXG4gICAgICAgICAgICAgICAgcHJvbXB0RGVmYXVsdDogXCJjb25mL29vbG9uZy5qc29uXCIsXG4gICAgICAgICAgICAgICAgYWZ0ZXJJbnF1aXJlOiAoKSA9PiB7IGNvbm5lY3Rpb25TdHJpbmdzID0gY29yZS5nZXRDb25uZWN0aW9uU3RyaW5ncyhjb3JlLm9wdGlvbignYycpKTsgfVxuICAgICAgICAgICAgfTsgICBcblxuICAgICAgICAgICAgY21kT3B0aW9uc1snY29ubiddID0ge1xuICAgICAgICAgICAgICAgIGRlc2M6ICdUaGUgZGF0YSBzb3VyY2UgY29ubmVjdG9yJyxcbiAgICAgICAgICAgICAgICBhbGlhczogWyAnY29ubmVjdG9yJyBdLFxuICAgICAgICAgICAgICAgIHByb21wdE1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IHRoZSBkYXRhIHNvdXJjZSBjb25uZWN0b3I6JyxcbiAgICAgICAgICAgICAgICBpbnF1aXJlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByb21wdFR5cGU6ICdsaXN0JyxcbiAgICAgICAgICAgICAgICBjaG9pY2VzUHJvdmlkZXI6ICgpID0+IE9iamVjdC5rZXlzKGNvbm5lY3Rpb25TdHJpbmdzKSxcbiAgICAgICAgICAgICAgICBhZnRlcklucXVpcmU6ICgpID0+IHsgY29uc29sZS5sb2coJ1RoZSBjb25lbmN0aW9uIHN0cmluZyBvZiBzZWxlY3RlZCBjb25uZWN0b3I6JywgY29ubmVjdGlvblN0cmluZ3NbY29yZS5vcHRpb24oJ2Nvbm4nKV0pOyB9ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2xpc3RWYWxpZGF0b3JzJzpcbiAgICAgICAgICAgIGJyZWFrOyAgICBcbiAgICAgICAgXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAvL21vZHVsZSBnZW5lcmFsIG9wdGlvbnNcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiBjbWRPcHRpb25zO1xufTtcblxuZXhwb3J0cy5tYWluID0gKGNvcmUpID0+IHtcbiAgICBpZiAoY29yZS5vcHRpb24oJ3YnKSkge1xuICAgICAgICBjb25zb2xlLmxvZygndicgKyBjb3JlLmFwcC52ZXJzaW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb3JlLnNob3dVc2FnZSgpO1xuICAgIH1cbn07XG5cbmV4cG9ydHMuYnVpbGQgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgYnVpbGQnKTtcblxuICAgIGxldCBvb2xvbmdDb25maWcgPSBjb3JlLm9vbG9uZ0NvbmZpZztcblxuICAgIGxldCBkc2xTb3VyY2VEaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kc2xTb3VyY2VEaXInKTtcbiAgICBpZiAoIWRzbFNvdXJjZURpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLmRzbFNvdXJjZURpclwiIG5vdCBmb3VuZCBpbiBvb2xvbmcgY29uZmlnLicpO1xuICAgIH1cblxuICAgIGxldCBtb2RlbE91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLm1vZGVsT3V0cHV0RGlyJyk7XG4gICAgaWYgKCFtb2RlbE91dHB1dERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLm1vZGVsT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IHNjcmlwdE91dHB1dERpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdE91dHB1dERpcicpO1xuICAgIGlmICghc2NyaXB0T3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuc2NyaXB0T3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG1hbmlmZXN0T3V0cHV0RGlyID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcubWFuaWZlc3RPdXRwdXREaXInKTtcbiAgICBcbiAgICBsZXQgZHNsU291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGRzbFNvdXJjZURpcik7ICAgIFxuICAgIGxldCBtb2RlbE91dHB1dFBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChtb2RlbE91dHB1dERpcik7XG4gICAgbGV0IHNjcmlwdE91dHB1dFBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChzY3JpcHRPdXRwdXREaXIpO1xuICAgIGxldCBtYW5pZmVzdE91dHB1dFBhdGggPSBtYW5pZmVzdE91dHB1dERpciAmJiBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChtYW5pZmVzdE91dHB1dERpcik7XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZHNsU291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEU0wgc291cmNlIGRpcmVjdG9yeSBcIiR7ZHNsU291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZUpzb25Tb3VyY2UgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy51c2VKc29uU291cmNlJywgZmFsc2UpOyAgICAgICBcbiAgICBsZXQgc2F2ZUludGVybWVkaWF0ZSA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNhdmVJbnRlcm1lZGlhdGUnLCBmYWxzZSk7ICAgICAgIFxuXG4gICAgcmV0dXJuIGNvcmUuYXBpLmJ1aWxkXyh7XG4gICAgICAgIGxvZ2dlcjogY29yZS5hcHAubG9nZ2VyLFxuICAgICAgICBkc2xTb3VyY2VQYXRoLFxuICAgICAgICBtb2RlbE91dHB1dFBhdGgsXG4gICAgICAgIHNjcmlwdE91dHB1dFBhdGgsXG4gICAgICAgIG1hbmlmZXN0T3V0cHV0UGF0aCxcbiAgICAgICAgdXNlSnNvblNvdXJjZSxcbiAgICAgICAgc2F2ZUludGVybWVkaWF0ZSxcbiAgICAgICAgc2NoZW1hRGVwbG95bWVudDogY29yZS5zY2hlbWFEZXBsb3ltZW50XG4gICAgfSk7XG59O1xuXG5leHBvcnRzLm1pZ3JhdGUgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgbWlncmF0ZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IG1vZGVsRGlyICA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLm1vZGVsRGlyJyk7XG4gICAgaWYgKCFtb2RlbERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLm1vZGVsRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IGRzbFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLmRzbFNvdXJjZURpcicpO1xuICAgIGlmICghZHNsU291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsU291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IHNjcmlwdFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdFNvdXJjZURpcicpO1xuICAgIGlmICghc2NyaXB0U291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuc2NyaXB0U291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG1vZGVsUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKG1vZGVsRGlyKTsgICAgXG4gICAgbGV0IGRzbFNvdXJjZVBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xTb3VyY2VEaXIpOyAgICBcbiAgICBsZXQgc2NyaXB0U291cmNlUGF0aCA9IGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKHNjcmlwdFNvdXJjZURpcik7XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMobW9kZWxQYXRoKSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYE1vZGVsIGRpcmVjdG9yeSBcIiR7bW9kZWxQYXRofVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZHNsU291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEU0wgc291cmNlIGRpcmVjdG9yeSBcIiR7ZHNsU291cmNlUGF0aH1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHNjcmlwdFNvdXJjZVBhdGgpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChgRGF0YWJhc2Ugc2NyaXB0cyBkaXJlY3RvcnkgXCIke3NjcmlwdFNvdXJjZVBhdGh9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGxldCB1c2VKc29uU291cmNlID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdvb2xvbmcudXNlSnNvblNvdXJjZScsIGZhbHNlKTtcblxuICAgIHJldHVybiBjb3JlLmFwaS5taWdyYXRlXyh7XG4gICAgICAgIGxvZ2dlcjogY29yZS5hcHAubG9nZ2VyLFxuICAgICAgICBtb2RlbFBhdGgsXG4gICAgICAgIGRzbFNvdXJjZVBhdGgsICAgICAgICBcbiAgICAgICAgc2NyaXB0U291cmNlUGF0aCxcbiAgICAgICAgdXNlSnNvblNvdXJjZSxcbiAgICAgICAgc2NoZW1hRGVwbG95bWVudDogY29yZS5zY2hlbWFEZXBsb3ltZW50XG4gICAgfSwgY29yZS5vcHRpb24oJ3Jlc2V0JykpO1xufTtcblxuZXhwb3J0cy5kYXRhc2V0ID0gYXN5bmMgKGNvcmUpID0+IHtcbiAgICBjb3JlLmFwcC5sb2coJ3ZlcmJvc2UnLCAnb29sb25nIGRhdGFzZXQnKTtcblxuICAgIGxldCBkYXRhc2V0ID0gYXdhaXQgY29yZS5nZXREYXRhc2V0XygpO1xuICAgIFxuICAgIGNvcmUuYXBwLmxvZygnaW5mbycsICdBdmFpbGFibGUgZGF0YXNldDogXFxuJyArIGRhdGFzZXQuam9pbignXFxuJykgKyAnXFxuJyk7XG59XG5cbmV4cG9ydHMuaW1wb3J0ID0gYXN5bmMgKGNvcmUpID0+IHtcbiAgICBjb3JlLmFwcC5sb2coJ3ZlcmJvc2UnLCAnb29sb25nIGltcG9ydCcpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IG1vZGVsRGlyICA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLm1vZGVsRGlyJyk7XG4gICAgaWYgKCFtb2RlbERpcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wib29sb25nLm1vZGVsRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IHNjcmlwdFNvdXJjZURpciA9IFV0aWwuZ2V0VmFsdWVCeVBhdGgob29sb25nQ29uZmlnLCAnb29sb25nLnNjcmlwdFNvdXJjZURpcicpO1xuICAgIGlmICghc2NyaXB0U291cmNlRGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuc2NyaXB0U291cmNlRGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuICAgIFxuICAgIGxldCBtb2RlbFBhdGggPSBjb3JlLmFwcC50b0Fic29sdXRlUGF0aChtb2RlbERpcik7ICAgIFxuICAgIGxldCBzY3JpcHRTb3VyY2VQYXRoID0gY29yZS5hcHAudG9BYnNvbHV0ZVBhdGgoc2NyaXB0U291cmNlRGlyKTtcblxuICAgIGxldCBzY2hlbWEgPSBjb3JlLm9wdGlvbignc2NoZW1hJyk7ICAgIFxuICAgIGxldCBkYXRhc2V0ID0gY29yZS5vcHRpb24oJ2RhdGFzZXQnKTsgICAgXG5cbiAgICByZXR1cm4gY29yZS5hcGkuaW1wb3J0Xyh7XG4gICAgICAgIGxvZ2dlcjogY29yZS5hcHAubG9nZ2VyLCAgICAgICAgXG4gICAgICAgIG1vZGVsUGF0aCxcbiAgICAgICAgc2NyaXB0U291cmNlUGF0aCwgICAgICAgIFxuICAgICAgICBzY2hlbWFEZXBsb3ltZW50OiBjb3JlLnNjaGVtYURlcGxveW1lbnRcbiAgICB9LCBzY2hlbWEsIGRhdGFzZXQpO1xufVxuXG5leHBvcnRzLnJldmVyc2UgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgcmV2ZXJzZScpO1xuXG4gICAgbGV0IG9vbG9uZ0NvbmZpZyA9IGNvcmUub29sb25nQ29uZmlnO1xuXG4gICAgbGV0IGRzbFJldmVyc2VPdXRwdXREaXIgPSBVdGlsLmdldFZhbHVlQnlQYXRoKG9vbG9uZ0NvbmZpZywgJ29vbG9uZy5kc2xSZXZlcnNlT3V0cHV0RGlyJyk7XG4gICAgaWYgKCFkc2xSZXZlcnNlT3V0cHV0RGlyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignXCJvb2xvbmcuZHNsT3V0cHV0RGlyXCIgbm90IGZvdW5kIGluIG9vbG9uZyBjb25maWcuJyk7XG4gICAgfVxuXG4gICAgbGV0IG91dHB1dERpciA9IGNvcmUuZ2V0UmV2ZXJzZU91dHB1dERpcihjb3JlLmFwcC50b0Fic29sdXRlUGF0aChkc2xSZXZlcnNlT3V0cHV0RGlyKSk7XG5cbiAgICAvL3RvZG86IHJlbG9jYXRpb24sIGFuZCBkZWVwIGNvcHkgY29ubmVjdGlvbiBvcHRpb25zXG4gICAgbGV0IGNvbm4gPSBjb3JlLm9wdGlvbignY29ubicpO1xuICAgIGxldCBbIGRyaXZlciBdID0gZXh0cmFjdERyaXZlckFuZENvbm5lY3Rvck5hbWUoY29ubik7XG4gICAgbGV0IGNvbm5PcHRpb25zID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChvb2xvbmdDb25maWcsICdkYXRhU291cmNlLicgKyBjb25uKTtcbiAgICBhc3NlcnQ6IGNvbm5PcHRpb25zOyAgICBcblxuICAgIGlmICh0eXBlb2YgY29ubk9wdGlvbnMucmV2ZXJzZVJ1bGVzID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgPSByZXF1aXJlKGNvcmUuYXBwLnRvQWJzb2x1dGVQYXRoKGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcykpO1xuICAgIH0gXG5cbiAgICBhc3NlcnQ6ICFjb25uT3B0aW9ucy5yZXZlcnNlUnVsZXMgfHwgXy5pc1BsYWluT2JqZWN0KGNvbm5PcHRpb25zLnJldmVyc2VSdWxlcyk7XG5cbiAgICByZXR1cm4gY29yZS5hcGkucmV2ZXJzZV8oeyBcbiAgICAgICAgbG9nZ2VyOiBjb3JlLmFwcC5sb2dnZXIsXG4gICAgICAgIGRzbFJldmVyc2VPdXRwdXRQYXRoOiBvdXRwdXREaXIsXG4gICAgICAgIGRyaXZlcixcbiAgICAgICAgY29ubk9wdGlvbnNcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMubGlzdFZhbGlkYXRvcnMgPSBhc3luYyAoY29yZSkgPT4ge1xuICAgIGNvcmUuYXBwLmxvZygndmVyYm9zZScsICdvb2xvbmcgbGlzdFZhbGlkYXRvcnMnKTtcblxuICAgIGxldCBsaXN0ID0gY29yZS5hcGkuZ2V0VmFsaWRhdG9yTGlzdCgpO1xuXG4gICAgY29yZS5hcHAubG9nKCdpbmZvJywgJ0F2YWlsYWJsZSB2YWxpZGF0b3JzOiBcXG4nICsgbGlzdC5qb2luKCdcXG4nKSArICdcXG4nKTtcbn0iXX0=