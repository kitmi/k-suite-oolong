"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable
} = require('./OolUtils');

const Dataset = require('./Dataset');

class View extends Clonable {
  constructor(linker, name, oolModule, info) {
    this.linker = linker;
    this.name = name;
    this.oolModule = oolModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.dataset) {
      this.dataset = this.linker.loadDoc(this.oolModule, this.info.dataset);
    } else {
      if (!this.info.entity) {
        throw new Error('Invalid view syntax!');
      }

      let mainEntity = this.linker.getReferencedEntity(this.oolModule, this.info.entity);
      this.dataset = new Dataset(this.linker, mainEntity.name, this.oolModule, {
        mainEntity: mainEntity.name
      });
      this.dataset.link();
    }

    if (this.info.isList) {
      this.isList = true;
    }

    if (!_.isEmpty(this.info.accept)) {
      this.params = this.info.accept.concat();
    }

    if (!_.isEmpty(this.info.selectBy)) {
      this.selectBy = this.info.selectBy.concat();
    }

    if (!_.isEmpty(this.info.groupBy)) {
      this.groupBy = this.info.groupBy.concat();
    }

    if (!_.isEmpty(this.info.orderBy)) {
      this.orderBy = this.info.orderBy.concat();
    }

    if (this.info.skip) {
      this.skip = _.isPlainObject(this.info.skip) ? Object.assign({}, this.info.skip) : this.info.skip;
    }

    if (this.info.limit) {
      this.limit = _.isPlainObject(this.info.limit) ? Object.assign({}, this.info.limit) : this.info.limit;
    }

    this.linked = true;
    return this;
  }

  inferTypeInfo(inSchema) {
    if (!_.isEmpty(this.params)) {
      let inferredParams = [];
      this.params.forEach(param => {
        if (OolUtils.isMemberAccess(param.type)) {
          let [entityName, fieldName] = param.type.split('.');

          if (!inSchema.hasEntity(entityName)) {
            throw new Error(`Parameter "${param.name}" references to an entity "${entityName}" which is not belong to the schema.`);
          }

          let entity = inSchema.entities[entityName];
          let field = entity.getEntityAttribute(fieldName);
          inferredParams.push(Object.assign(_.omit(_.toPlainObject(field), ['isReference', 'optional', 'displayName']), {
            name: param.name
          }));
        } else {
          inferredParams.push(this.linker.trackBackType(this.oolModule, param));
        }
      });
      this.params = inferredParams;
    }
  }

  getDocumentHierarchy(inSchema) {
    return inSchema.getDocumentHierachy(this.oolModule, this.dataset.name);
  }

  clone() {
    super.clone();
    let view = new View(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, view, 'dataset');
    deepCloneField(this, view, 'params');
    deepCloneField(this, view, 'selectBy');
    deepCloneField(this, view, 'groupBy');
    deepCloneField(this, view, 'orderBy');
    deepCloneField(this, view, 'skip');
    deepCloneField(this, view, 'limit');
    view.isList = this.isList;
    view.linked = true;
    return view;
  }

  toJSON() {
    return {
      name: this.name,
      dataset: this.dataset.toJSON(),
      isList: this.isList,
      params: this.params,
      selectBy: this.selectBy,
      groupBy: this.groupBy,
      orderBy: this.orderBy,
      skip: this.skip,
      limit: this.limit
    };
  }

}

module.exports = View;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1ZpZXcuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJDbG9uYWJsZSIsIkRhdGFzZXQiLCJWaWV3IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImxpbmsiLCJsaW5rZWQiLCJkYXRhc2V0IiwibG9hZERvYyIsImVudGl0eSIsIm1haW5FbnRpdHkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwiaXNMaXN0IiwiaXNFbXB0eSIsImFjY2VwdCIsInBhcmFtcyIsImNvbmNhdCIsInNlbGVjdEJ5IiwiZ3JvdXBCeSIsIm9yZGVyQnkiLCJza2lwIiwiaXNQbGFpbk9iamVjdCIsIk9iamVjdCIsImFzc2lnbiIsImxpbWl0IiwiaW5mZXJUeXBlSW5mbyIsImluU2NoZW1hIiwiaW5mZXJyZWRQYXJhbXMiLCJmb3JFYWNoIiwicGFyYW0iLCJPb2xVdGlscyIsImlzTWVtYmVyQWNjZXNzIiwidHlwZSIsImVudGl0eU5hbWUiLCJmaWVsZE5hbWUiLCJzcGxpdCIsImhhc0VudGl0eSIsIkVycm9yIiwiZW50aXRpZXMiLCJmaWVsZCIsImdldEVudGl0eUF0dHJpYnV0ZSIsInB1c2giLCJvbWl0IiwidG9QbGFpbk9iamVjdCIsInRyYWNrQmFja1R5cGUiLCJnZXREb2N1bWVudEhpZXJhcmNoeSIsImdldERvY3VtZW50SGllcmFjaHkiLCJjbG9uZSIsInZpZXciLCJ0b0pTT04iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUE7QUFBdkMsSUFBb0RILE9BQU8sQ0FBQyxZQUFELENBQWpFOztBQUVBLE1BQU1J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LElBQUFBLElBQUksQ0FBQzFDLE1BQUwsR0FBYyxJQUFkO0FBRUEsV0FBTzBDLElBQVA7QUFDSDs7QUFNREMsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsV0FBTztBQUNIL0MsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBRFI7QUFFSEssTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BQUwsQ0FBYTBDLE1BQWIsRUFGTjtBQUdIckMsTUFBQUEsTUFBTSxFQUFFLEtBQUtBLE1BSFY7QUFJSEcsTUFBQUEsTUFBTSxFQUFFLEtBQUtBLE1BSlY7QUFLSEUsTUFBQUEsUUFBUSxFQUFFLEtBQUtBLFFBTFo7QUFNSEMsTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BTlg7QUFPSEMsTUFBQUEsT0FBTyxFQUFFLEtBQUtBLE9BUFg7QUFRSEMsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBUlI7QUFTSEksTUFBQUEsS0FBSyxFQUFFLEtBQUtBO0FBVFQsS0FBUDtBQVdIOztBQTVKdUI7O0FBK0o1QjBCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBELElBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIENsb25hYmxlIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbmNvbnN0IERhdGFzZXQgPSByZXF1aXJlKCcuL0RhdGFzZXQnKTtcblxuLyoqXG4gKiBPb2xvbmcgdmlldyBjbGFzcy5cbiAqIEBjbGFzcyB7T29sb25nVmlld31cbiAqL1xuY2xhc3MgVmlldyBleHRlbmRzIENsb25hYmxlIHtcblxuICAgIGlzTGlzdCA9IGZhbHNlO1xuXG4gICAgLyoqICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7T29sb25nTGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFZpZXcgbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvb2xNb2R1bGUgLSBTb3VyY2Ugb29sIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvIC0gVmlldyBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBvb2xNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgdmlld1xuICAgICAgICAgKiBAbWVtYmVyIHtPb2xvbmdMaW5rZXJ9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmxpbmtlciA9IGxpbmtlcjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTmFtZSBvZiB0aGlzIHZpZXdcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgb29sb25nIG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9vbE1vZHVsZSA9IG9vbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgdmlld1xuICAgICAqIEByZXR1cm5zIHtPb2xvbmdWaWV3fVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIGlmICh0aGlzLmluZm8uZGF0YXNldCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhc2V0ID0gdGhpcy5saW5rZXIubG9hZERvYyh0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvLmRhdGFzZXQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXNzZXJ0OiB0aGlzLmluZm8uZW50aXR5LCAnSW52YWxpZCB2aWV3IHN5bnRheCEnO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgbWFpbkVudGl0eSA9IHRoaXMubGlua2VyLmdldFJlZmVyZW5jZWRFbnRpdHkodGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mby5lbnRpdHkpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmRhdGFzZXQgPSBuZXcgRGF0YXNldCh0aGlzLmxpbmtlciwgbWFpbkVudGl0eS5uYW1lLCB0aGlzLm9vbE1vZHVsZSwgeyBtYWluRW50aXR5OiBtYWluRW50aXR5Lm5hbWUgfSk7XG4gICAgICAgICAgICB0aGlzLmRhdGFzZXQubGluaygpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaW5mby5pc0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMuaXNMaXN0ID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5hY2NlcHQpKSB7XG4gICAgICAgICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuaW5mby5hY2NlcHQuY29uY2F0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmluZm8uc2VsZWN0QnkpKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEJ5ID0gdGhpcy5pbmZvLnNlbGVjdEJ5LmNvbmNhdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLmdyb3VwQnkpKSB7XG4gICAgICAgICAgICB0aGlzLmdyb3VwQnkgPSB0aGlzLmluZm8uZ3JvdXBCeS5jb25jYXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5vcmRlckJ5KSkge1xuICAgICAgICAgICAgdGhpcy5vcmRlckJ5ID0gdGhpcy5pbmZvLm9yZGVyQnkuY29uY2F0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLnNraXApIHtcbiAgICAgICAgICAgIHRoaXMuc2tpcCA9IF8uaXNQbGFpbk9iamVjdCh0aGlzLmluZm8uc2tpcCkgPyBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmluZm8uc2tpcCkgOiB0aGlzLmluZm8uc2tpcDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8ubGltaXQpIHtcbiAgICAgICAgICAgIHRoaXMubGltaXQgPSBfLmlzUGxhaW5PYmplY3QodGhpcy5pbmZvLmxpbWl0KSA/IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaW5mby5saW1pdCkgOiB0aGlzLmluZm8ubGltaXQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaW5mZXJUeXBlSW5mbyhpblNjaGVtYSkge1xuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLnBhcmFtcykpIHtcbiAgICAgICAgICAgIGxldCBpbmZlcnJlZFBhcmFtcyA9IFtdO1xuXG4gICAgICAgICAgICB0aGlzLnBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoT29sVXRpbHMuaXNNZW1iZXJBY2Nlc3MocGFyYW0udHlwZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IFsgZW50aXR5TmFtZSwgZmllbGROYW1lIF0gPSBwYXJhbS50eXBlLnNwbGl0KCcuJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpblNjaGVtYS5oYXNFbnRpdHkoZW50aXR5TmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFyYW1ldGVyIFwiJHtwYXJhbS5uYW1lfVwiIHJlZmVyZW5jZXMgdG8gYW4gZW50aXR5IFwiJHtlbnRpdHlOYW1lfVwiIHdoaWNoIGlzIG5vdCBiZWxvbmcgdG8gdGhlIHNjaGVtYS5gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbnRpdHkgPSBpblNjaGVtYS5lbnRpdGllc1tlbnRpdHlOYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmRpcihlbnRpdHkudG9KU09OKCksIHtkZXB0aDogOCwgY29sb3JzOiB0cnVlfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkID0gZW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShmaWVsZE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpbmZlcnJlZFBhcmFtcy5wdXNoKE9iamVjdC5hc3NpZ24oXy5vbWl0KF8udG9QbGFpbk9iamVjdChmaWVsZCksIFsnaXNSZWZlcmVuY2UnLCAnb3B0aW9uYWwnLCAnZGlzcGxheU5hbWUnXSksIHtuYW1lOiBwYXJhbS5uYW1lfSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGluZmVycmVkUGFyYW1zLnB1c2godGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLm9vbE1vZHVsZSwgcGFyYW0pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5wYXJhbXMgPSBpbmZlcnJlZFBhcmFtcztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldERvY3VtZW50SGllcmFyY2h5KGluU2NoZW1hKSB7XG4gICAgICAgIHJldHVybiBpblNjaGVtYS5nZXREb2N1bWVudEhpZXJhY2h5KHRoaXMub29sTW9kdWxlLCB0aGlzLmRhdGFzZXQubmFtZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIHZpZXcgICAgIFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdWaWV3fVxuICAgICAqL1xuICAgIGNsb25lKCkge1xuICAgICAgICBzdXBlci5jbG9uZSgpO1xuICAgICAgICBcbiAgICAgICAgbGV0IHZpZXcgPSBuZXcgVmlldyh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvKTtcblxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnZGF0YXNldCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAncGFyYW1zJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHZpZXcsICdzZWxlY3RCeScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnZ3JvdXBCeScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnb3JkZXJCeScpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnc2tpcCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCB2aWV3LCAnbGltaXQnKTtcblxuICAgICAgICB2aWV3LmlzTGlzdCA9IHRoaXMuaXNMaXN0O1xuICAgICAgICB2aWV3LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSB0aGUgdmlldyBpbnRvIGEgcGxhaW4gSlNPTiBvYmplY3RcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRvSlNPTigpIHtcbiAgICAgICAgcmV0dXJuIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIGRhdGFzZXQ6IHRoaXMuZGF0YXNldC50b0pTT04oKSxcbiAgICAgICAgICAgIGlzTGlzdDogdGhpcy5pc0xpc3QsXG4gICAgICAgICAgICBwYXJhbXM6IHRoaXMucGFyYW1zLFxuICAgICAgICAgICAgc2VsZWN0Qnk6IHRoaXMuc2VsZWN0QnksXG4gICAgICAgICAgICBncm91cEJ5OiB0aGlzLmdyb3VwQnksXG4gICAgICAgICAgICBvcmRlckJ5OiB0aGlzLm9yZGVyQnksXG4gICAgICAgICAgICBza2lwOiB0aGlzLnNraXAsXG4gICAgICAgICAgICBsaW1pdDogdGhpcy5saW1pdFxuICAgICAgICB9O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBWaWV3OyJdfQ==