"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

class Clonable {
  constructor() {
    this.linked = false;
  }

  clone() {
    if (!this.linked) {
      throw new Error('An element becomes clonable only after being linked.');
    }
  }

}

const deepClone = value => _.cloneDeepWith(value, el => el instanceof Clonable ? el.clone() : undefined);

const deepCloneField = (src, dest, field) => {
  if (field in src) dest[field] = deepClone(src[field]);
};

const isDotSeparateName = name => name.indexOf('.') > 0;

const extractDotSeparateName = name => name.split('.');

const extractReferenceBaseName = name => extractDotSeparateName(name).pop();

const prefixNaming = (prefix, name) => {
  let leftParts = _.kebabCase(prefix).split('-');

  let rightParts = _.kebabCase(name).split('-');

  let reservedLeft, reservedRight;

  if (leftParts.length > rightParts.length) {
    reservedLeft = leftParts.splice(0, leftParts.length - rightParts.length);
    reservedRight = [];
  } else {
    reservedLeft = [];
    reservedRight = rightParts.splice(leftParts.length, rightParts.length - leftParts.length);
  }

  const combine = () => _.camelCase(reservedLeft.concat(leftParts).concat(reservedRight).join('-'));

  if (_.isEqual(leftParts, rightParts)) {
    return combine();
  }

  while (leftParts.length > 0) {
    reservedLeft.push(leftParts.shift());
    reservedRight.unshift(rightParts.pop());

    if (_.isEqual(leftParts, rightParts)) {
      break;
    }
  }

  return combine();
};

const getReferenceNameIfItIs = obj => {
  if (_.isPlainObject(obj) && obj.oolType === 'ObjectReference') {
    return extractDotSeparateName(obj.name)[0];
  }

  return undefined;
};

exports.parseReferenceInDocument = (schema, doc, ref) => {
  let parts = ref.split('.');
  let parent;
  let l = parts.length;
  let entityNode, entity, field;

  for (let i = 0; i < l; i++) {
    let p = parts[i];

    if (!entityNode) {
      if (doc.entity === p) {
        entityNode = doc;
        continue;
      }

      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (entityNode && p[0] === '$') {
      entity = schema.entities[entityNode.entity];
      let attr = entity.getEntityAttribute(p);

      if (attr instanceof Field) {
        field = attr;

        if (i !== l - 1) {
          throw new Error(`Reference by path "${ref}" not found in given document.`);
        }

        return {
          entityNode,
          entity,
          field
        };
      } else {
        parent = attr;
      }

      continue;
    }

    if (parent) {
      parent = parent[p];
    } else {
      if (i === l - 1) {
        entity = schema.entities[entityNode.entity];
        field = entity.getEntityAttribute(p);
        return {
          entityNode,
          entity,
          field
        };
      }

      entityNode = entityNode.subDocuments && entityNode.subDocuments[p];

      if (!entityNode) {
        throw new Error(`Reference by path "${ref}" not found in given document.`);
      }
    }
  }

  if (!field) {
    if (typeof parent !== 'string') {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (!entity) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    field = entity.getEntityAttribute(parent);

    if (!(field instanceof Field)) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }
  }

  return {
    entityNode,
    entity,
    field
  };
};

exports.deepClone = deepClone;
exports.deepCloneField = deepCloneField;
exports.isDotSeparateName = isDotSeparateName;
exports.extractDotSeparateName = extractDotSeparateName;
exports.extractReferenceBaseName = extractReferenceBaseName;
exports.getReferenceNameIfItIs = getReferenceNameIfItIs;

exports.schemaNaming = name => _.camelCase(name);

exports.entityNaming = name => _.camelCase(name);

exports.fieldNaming = name => _.camelCase(name);

exports.prefixNaming = prefixNaming;

exports.generateDisplayName = name => _.startCase(name);

exports.formatFields = field => Array.isArray(field) ? field.join(', ') : field;

exports.Clonable = Clonable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbFV0aWxzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiQ2xvbmFibGUiLCJsaW5rZWQiLCJjbG9uZSIsImRlZXBDbG9uZSIsInZhbHVlIiwiY2xvbmVEZWVwV2l0aCIsImVsIiwidW5kZWZpbmVkIiwiZGVlcENsb25lRmllbGQiLCJzcmMiLCJkZXN0IiwiZmllbGQiLCJpc0RvdFNlcGFyYXRlTmFtZSIsIm5hbWUiLCJpbmRleE9mIiwiZXh0cmFjdERvdFNlcGFyYXRlTmFtZSIsInNwbGl0IiwiZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lIiwicG9wIiwicHJlZml4TmFtaW5nIiwicHJlZml4IiwibGVmdFBhcnRzIiwia2ViYWJDYXNlIiwicmlnaHRQYXJ0cyIsInJlc2VydmVkTGVmdCIsInJlc2VydmVkUmlnaHQiLCJsZW5ndGgiLCJzcGxpY2UiLCJjb21iaW5lIiwiY2FtZWxDYXNlIiwiY29uY2F0Iiwiam9pbiIsImlzRXF1YWwiLCJwdXNoIiwic2hpZnQiLCJ1bnNoaWZ0IiwiZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcyIsIm9iaiIsImlzUGxhaW5PYmplY3QiLCJvb2xUeXBlIiwiZXhwb3J0cyIsInBhcnNlUmVmZXJlbmNlSW5Eb2N1bWVudCIsInNjaGVtYSIsImRvYyIsInJlZiIsInBhcnRzIiwicGFyZW50IiwibCIsImVudGl0eU5vZGUiLCJlbnRpdHkiLCJpIiwicCIsIkVycm9yIiwiZW50aXRpZXMiLCJhdHRyIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwiRmllbGQiLCJzdWJEb2N1bWVudHMiLCJzY2hlbWFOYW1pbmciLCJlbnRpdHlOYW1pbmciLCJmaWVsZE5hbWluZyIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJzdGFydENhc2UiLCJmb3JtYXRGaWVsZHMiLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQVFDLE9BQU8sQ0FBQyxVQUFELENB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aEQsSUFBSSxJQUFJZixDQUFDLENBQUNnRSxTQUFGLENBQVlqRCxJQUFaLENBQXRDOztBQUNBMkIsT0FBTyxDQUFDdUIsWUFBUixHQUF1QnBELEtBQUssSUFBSXFELEtBQUssQ0FBQ0MsT0FBTixDQUFjdEQsS0FBZCxJQUF1QkEsS0FBSyxDQUFDb0IsSUFBTixDQUFXLElBQVgsQ0FBdkIsR0FBMENwQixLQUExRTs7QUFDQTZCLE9BQU8sQ0FBQ3hDLFFBQVIsR0FBbUJBLFFBQW5CIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuY2xhc3MgQ2xvbmFibGUge1xuICAgIGxpbmtlZCA9IGZhbHNlO1xuXG4gICAgY2xvbmUoKSB7ICAgICAgXG4gICAgICAgIGFzc2VydDogdGhpcy5saW5rZWQsICdBbiBlbGVtZW50IGJlY29tZXMgY2xvbmFibGUgb25seSBhZnRlciBiZWluZyBsaW5rZWQuJztcbiAgICB9XG59XG5cbmNvbnN0IGRlZXBDbG9uZSA9ICh2YWx1ZSkgPT4gXy5jbG9uZURlZXBXaXRoKHZhbHVlLCBlbCA9PiAoZWwgaW5zdGFuY2VvZiBDbG9uYWJsZSkgPyBlbC5jbG9uZSgpIDogdW5kZWZpbmVkKTtcblxuY29uc3QgZGVlcENsb25lRmllbGQgPSAoc3JjLCBkZXN0LCBmaWVsZCkgPT4ge1xuICAgIGlmIChmaWVsZCBpbiBzcmMpIGRlc3RbZmllbGRdID0gZGVlcENsb25lKHNyY1tmaWVsZF0pO1xufTtcblxuY29uc3QgaXNEb3RTZXBhcmF0ZU5hbWUgPSAobmFtZSkgPT4gKG5hbWUuaW5kZXhPZignLicpID4gMCk7XG5cbmNvbnN0IGV4dHJhY3REb3RTZXBhcmF0ZU5hbWUgPSAobmFtZSkgPT4gbmFtZS5zcGxpdCgnLicpO1xuXG5jb25zdCBleHRyYWN0UmVmZXJlbmNlQmFzZU5hbWUgPSAobmFtZSkgPT4gZXh0cmFjdERvdFNlcGFyYXRlTmFtZShuYW1lKS5wb3AoKTtcblxuY29uc3QgcHJlZml4TmFtaW5nID0gKHByZWZpeCwgbmFtZSkgPT4ge1xuICAgIGxldCBsZWZ0UGFydHMgPSBfLmtlYmFiQ2FzZShwcmVmaXgpLnNwbGl0KCctJyk7XG4gICAgbGV0IHJpZ2h0UGFydHMgPSBfLmtlYmFiQ2FzZShuYW1lKS5zcGxpdCgnLScpO1xuICAgIFxuICAgIGxldCByZXNlcnZlZExlZnQsIHJlc2VydmVkUmlnaHQ7XG5cbiAgICBpZiAobGVmdFBhcnRzLmxlbmd0aCA+IHJpZ2h0UGFydHMubGVuZ3RoKSB7XG4gICAgICAgIHJlc2VydmVkTGVmdCA9IGxlZnRQYXJ0cy5zcGxpY2UoMCwgbGVmdFBhcnRzLmxlbmd0aCAtIHJpZ2h0UGFydHMubGVuZ3RoKTtcbiAgICAgICAgcmVzZXJ2ZWRSaWdodCA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc2VydmVkTGVmdCA9IFtdO1xuICAgICAgICByZXNlcnZlZFJpZ2h0ID0gcmlnaHRQYXJ0cy5zcGxpY2UobGVmdFBhcnRzLmxlbmd0aCwgcmlnaHRQYXJ0cy5sZW5ndGggLSBsZWZ0UGFydHMubGVuZ3RoKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb21iaW5lID0gKCkgPT4gXy5jYW1lbENhc2UocmVzZXJ2ZWRMZWZ0LmNvbmNhdChsZWZ0UGFydHMpLmNvbmNhdChyZXNlcnZlZFJpZ2h0KS5qb2luKCctJykpO1xuXG4gICAgaWYgKF8uaXNFcXVhbChsZWZ0UGFydHMsIHJpZ2h0UGFydHMpKSB7XG4gICAgICAgIHJldHVybiBjb21iaW5lKCk7XG4gICAgfVxuICAgIFxuICAgIHdoaWxlIChsZWZ0UGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXNlcnZlZExlZnQucHVzaChsZWZ0UGFydHMuc2hpZnQoKSk7XG4gICAgICAgIHJlc2VydmVkUmlnaHQudW5zaGlmdChyaWdodFBhcnRzLnBvcCgpKTtcbiAgICAgICAgaWYgKF8uaXNFcXVhbChsZWZ0UGFydHMsIHJpZ2h0UGFydHMpKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH0gXG5cbiAgICByZXR1cm4gY29tYmluZSgpO1xufTtcblxuY29uc3QgZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcyA9IChvYmopID0+IHtcbiAgICBpZiAoXy5pc1BsYWluT2JqZWN0KG9iaikgJiYgb2JqLm9vbFR5cGUgPT09ICdPYmplY3RSZWZlcmVuY2UnKSB7XG4gICAgICAgIHJldHVybiBleHRyYWN0RG90U2VwYXJhdGVOYW1lKG9iai5uYW1lKVswXTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0cy5wYXJzZVJlZmVyZW5jZUluRG9jdW1lbnQgPSAoc2NoZW1hLCBkb2MsIHJlZikgPT4geyAgICBcbiAgICBsZXQgcGFydHMgPSByZWYuc3BsaXQoJy4nKTtcbiAgICBsZXQgcGFyZW50O1xuICAgIGxldCBsID0gcGFydHMubGVuZ3RoO1xuICAgIGxldCBlbnRpdHlOb2RlLCBlbnRpdHksIGZpZWxkO1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIGxldCBwID0gcGFydHNbaV07XG4gICAgICAgIFxuICAgICAgICBpZiAoIWVudGl0eU5vZGUpIHtcbiAgICAgICAgICAgIGlmIChkb2MuZW50aXR5ID09PSBwKSB7XG4gICAgICAgICAgICAgICAgZW50aXR5Tm9kZSA9IGRvYztcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlbnRpdHlOb2RlICYmIHBbMF0gPT09ICckJykge1xuICAgICAgICAgICAgZW50aXR5ID0gc2NoZW1hLmVudGl0aWVzW2VudGl0eU5vZGUuZW50aXR5XTtcbiAgICAgICAgICAgIGxldCBhdHRyID0gZW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShwKTtcblxuICAgICAgICAgICAgaWYgKGF0dHIgaW5zdGFuY2VvZiBGaWVsZCkge1xuICAgICAgICAgICAgICAgIGZpZWxkID0gYXR0cjtcbiAgICAgICAgICAgICAgICBpZiAoaSAhPT0gbC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5Tm9kZSxcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5LFxuICAgICAgICAgICAgICAgICAgICBmaWVsZFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhcmVudCA9IGF0dHI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAocGFyZW50KSB7XG4gICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnRbcF07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoaSA9PT0gbC0xKSB7XG4gICAgICAgICAgICAgICAgLy9sYXN0IHBhcnRcbiAgICAgICAgICAgICAgICBlbnRpdHkgPSBzY2hlbWEuZW50aXRpZXNbZW50aXR5Tm9kZS5lbnRpdHldO1xuICAgICAgICAgICAgICAgIGZpZWxkID0gZW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShwKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5vZGUsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eSxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbnRpdHlOb2RlID0gZW50aXR5Tm9kZS5zdWJEb2N1bWVudHMgJiYgZW50aXR5Tm9kZS5zdWJEb2N1bWVudHNbcF07XG4gICAgICAgICAgICBpZiAoIWVudGl0eU5vZGUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFmaWVsZCkge1xuICAgICAgICBpZiAodHlwZW9mIHBhcmVudCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWVudGl0eSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZpZWxkID0gZW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShwYXJlbnQpO1xuICAgICAgICBpZiAoIShmaWVsZCBpbnN0YW5jZW9mIEZpZWxkKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgICBlbnRpdHlOb2RlLFxuICAgICAgICBlbnRpdHksXG4gICAgICAgIGZpZWxkXG4gICAgfTtcbn07XG5cbmV4cG9ydHMuZGVlcENsb25lID0gZGVlcENsb25lO1xuZXhwb3J0cy5kZWVwQ2xvbmVGaWVsZCA9IGRlZXBDbG9uZUZpZWxkO1xuZXhwb3J0cy5pc0RvdFNlcGFyYXRlTmFtZSA9IGlzRG90U2VwYXJhdGVOYW1lO1xuZXhwb3J0cy5leHRyYWN0RG90U2VwYXJhdGVOYW1lID0gZXh0cmFjdERvdFNlcGFyYXRlTmFtZTtcbmV4cG9ydHMuZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lID0gZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lO1xuZXhwb3J0cy5nZXRSZWZlcmVuY2VOYW1lSWZJdElzID0gZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcztcbmV4cG9ydHMuc2NoZW1hTmFtaW5nID0gbmFtZSA9PiBfLmNhbWVsQ2FzZShuYW1lKTtcbmV4cG9ydHMuZW50aXR5TmFtaW5nID0gbmFtZSA9PiBfLmNhbWVsQ2FzZShuYW1lKTtcbmV4cG9ydHMuZmllbGROYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5wcmVmaXhOYW1pbmcgPSBwcmVmaXhOYW1pbmc7XG5leHBvcnRzLmdlbmVyYXRlRGlzcGxheU5hbWUgPSBuYW1lID0+IF8uc3RhcnRDYXNlKG5hbWUpO1xuZXhwb3J0cy5mb3JtYXRGaWVsZHMgPSBmaWVsZCA9PiBBcnJheS5pc0FycmF5KGZpZWxkKSA/IGZpZWxkLmpvaW4oJywgJykgOiBmaWVsZDtcbmV4cG9ydHMuQ2xvbmFibGUgPSBDbG9uYWJsZTsiXX0=