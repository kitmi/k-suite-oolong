"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const pluralize = require('pluralize');

class Clonable {
  constructor() {
    this.linked = false;
  }

  clone() {
    if (!this.linked) {
      throw new Error('An element becomes clonable only after being linked.');
    }
  }

}

const deepClone = value => _.cloneDeepWith(value, el => el instanceof Clonable ? el.clone() : undefined);

const deepCloneField = (src, dest, field) => {
  if (field in src) dest[field] = deepClone(src[field]);
};

const isDotSeparateName = name => name.indexOf('.') > 0;

const extractDotSeparateName = name => name.split('.');

const extractReferenceBaseName = name => extractDotSeparateName(name).pop();

const prefixNaming = (prefix, name) => {
  let leftParts = _.kebabCase(prefix).split('-');

  let rightParts = _.kebabCase(name).split('-');

  let reservedLeft, reservedRight;

  if (leftParts.length > rightParts.length) {
    reservedLeft = leftParts.splice(0, leftParts.length - rightParts.length);
    reservedRight = [];
  } else {
    reservedLeft = [];
    reservedRight = rightParts.splice(leftParts.length, rightParts.length - leftParts.length);
  }

  const combine = () => _.camelCase(reservedLeft.concat(leftParts).concat(reservedRight).join('-'));

  if (_.isEqual(leftParts, rightParts)) {
    return combine();
  }

  while (leftParts.length > 0) {
    reservedLeft.push(leftParts.shift());
    reservedRight.unshift(rightParts.pop());

    if (_.isEqual(leftParts, rightParts)) {
      break;
    }
  }

  return combine();
};

const getReferenceNameIfItIs = obj => {
  if (_.isPlainObject(obj) && obj.oolType === 'ObjectReference') {
    return extractDotSeparateName(obj.name)[0];
  }

  return undefined;
};

exports.parseReferenceInDocument = (schema, doc, ref) => {
  let parts = ref.split('.');
  let parent;
  let l = parts.length;
  let entityNode, entity, field;

  for (let i = 0; i < l; i++) {
    let p = parts[i];

    if (!entityNode) {
      if (doc.entity === p) {
        entityNode = doc;
        continue;
      }

      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (entityNode && p[0] === '$') {
      entity = schema.entities[entityNode.entity];
      let attr = entity.getEntityAttribute(p);

      if (attr instanceof Field) {
        field = attr;

        if (i !== l - 1) {
          throw new Error(`Reference by path "${ref}" not found in given document.`);
        }

        return {
          entityNode,
          entity,
          field
        };
      } else {
        parent = attr;
      }

      continue;
    }

    if (parent) {
      parent = parent[p];
    } else {
      if (i === l - 1) {
        entity = schema.entities[entityNode.entity];
        field = entity.getEntityAttribute(p);
        return {
          entityNode,
          entity,
          field
        };
      }

      entityNode = entityNode.subDocuments && entityNode.subDocuments[p];

      if (!entityNode) {
        throw new Error(`Reference by path "${ref}" not found in given document.`);
      }
    }
  }

  if (!field) {
    if (typeof parent !== 'string') {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    if (!entity) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }

    field = entity.getEntityAttribute(parent);

    if (!(field instanceof Field)) {
      throw new Error(`Reference by path "${ref}" not found in given document.`);
    }
  }

  return {
    entityNode,
    entity,
    field
  };
};

exports.pluralize = name => {
  let parts = _.kebabCase(name).split('-');

  let last = pluralize(parts.pop().toLowerCase());
  parts.push(last);
  return _.camelCase(parts.join('-'));
};

exports.deepClone = deepClone;
exports.deepCloneField = deepCloneField;
exports.isDotSeparateName = isDotSeparateName;
exports.extractDotSeparateName = extractDotSeparateName;
exports.extractReferenceBaseName = extractReferenceBaseName;
exports.getReferenceNameIfItIs = getReferenceNameIfItIs;

exports.schemaNaming = name => _.camelCase(name);

exports.entityNaming = name => _.camelCase(name);

exports.fieldNaming = name => _.camelCase(name);

exports.prefixNaming = prefixNaming;

exports.generateDisplayName = name => _.startCase(name);

exports.formatFields = field => Array.isArray(field) ? field.join(', ') : field;

exports.Clonable = Clonable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbFV0aWxzLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwicGx1cmFsaXplIiwiQ2xvbmFibGUiLCJsaW5rZWQiLCJjbG9uZSIsImRlZXBDbG9uZSIsInZhbHVlIiwiY2xvbmVEZWVwV2l0aCIsImVsIiwidW5kZWZpbmVkIiwiZGVlcENsb25lRmllbGQiLCJzcmMiLCJkZXN0IiwiZmllbGQiLCJpc0RvdFNlcGFyYXRlTmFtZSIsIm5hbWUiLCJpbmRleE9mIiwiZXh0cmFjdERvdFNlcGFyYXRlTmFtZSIsInNwbGl0IiwiZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lIiwicG9wIiwicHJlZml4TmFtaW5nIiwicHJlZml4IiwibGVmdFBhcnRzIiwia2ViYWJDYXNlIiwicmlnaHRQYXJ0cyIsInJlc2VydmVkTGVmdCIsInJlc2VydmVkUmlnaHQiLCJsZW5ndGgiLCJzcGxpY2UiLCJjb21iaW5lIiwiY2FtZWxDYXNlIiwiY29uY2F0Iiwiam9pbiIsImlzRXF1YWwiLCJwdXNoIiwic2hpZnQiLCJ1bnNoaWZ0IiwiZ2V0UmVmZXJlbmNlTmFtZUlmSXRJcyIsIm9iaiIsImlzUGxhaW5PYmplY3QiLCJvb2xUeXBlIiwiZXhwb3J0cyIsInBhcnNlUmVmZXJlbmNlSW5Eb2N1bWVudCIsInNjaGVtYSIsImRvYyIsInJlZiIsInBhcnRzIiwicGFyZW50IiwibCIsImVudGl0eU5vZGUiLCJlbnRpdHkiLCJpIiwicCIsIkVycm9yIiwiZW50aXRpZXMiLCJhdHRyIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwiRmllbGQiLCJzdWJEb2N1bWVudHMiLCJsYXN0IiwidG9Mb3dlckNhc2UiLCJzY2hlbWFOYW1pbmciLCJlbnRpdHlOYW1pbmciLCJmaWVsZE5hbWluZyIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJzdGFydENhc2UiLCJmb3JtYXRGaWVsZHMiLCJBcnJheSIsImlzQXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTTtBQUFFQSxF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QUFSLEdBQWlDQSxzQkFBakM7QUFDQXlCLE9BQU8sQ0FBQ3ZCLHdCQUFSLEdBQW1DQSx3QkFBbkM7QUFDQXVCLE9BQU8sQ0FBQ0osc0JBQVIsR0FBaUNBLHNCQUFqQzs7QUFDQUksT0FBTyxDQUFDb0IsWUFBUixHQUF1Qi9DLElBQUksSUFBSWhCLENBQUMsQ0FBQ2dDLFNBQUYsQ0FBWWhCLElBQVosQ0FBL0I7O0FBQ0EyQixPQUFPLENBQUNxQixZQUFSLEdBQXVCaEQsSUFBSSxJQUFJaEIsQ0FBQyxDQUFDZ0MsU0FBRixDQUFZaEIsSUFBWixDQUEvQjs7QUFDQTJCLE9BQU8sQ0FBQ3NCLFdBQVIsR0FBc0JqRCxJQUFJLElBQUloQixDQUFDLENBQUNnQyxTQUFGLENBQVloQixJQUFaLENBQTlCOztBQUNBMkIsT0FBTyxDQUFDckIsWUFBUixHQUF1QkEsWUFBdkI7O0FBQ0FxQixPQUFPLENBQUN1QixtQkFBUixHQUE4QmxELElBQUksSUFBSWhCLENBQUMsQ0FBQ21FLFNBQUYsQ0FBWW5ELElBQVosQ0FBdEM7O0FBQ0EyQixPQUFPLENBQUN5QixZQUFSLEdBQXVCdEQsS0FBSyxJQUFJdUQsS0FBSyxDQUFDQyxPQUFOLENBQWN4RCxLQUFkLElBQXVCQSxLQUFLLENBQUNvQixJQUFOLENBQVcsSUFBWCxDQUF2QixHQUEwQ3BCLEtBQTFFOztBQUNBNkIsT0FBTyxDQUFDeEMsUUFBUixHQUFtQkEsUUFBbkIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgcGx1cmFsaXplID0gcmVxdWlyZSgncGx1cmFsaXplJyk7XG5cbmNsYXNzIENsb25hYmxlIHtcbiAgICBsaW5rZWQgPSBmYWxzZTtcblxuICAgIGNsb25lKCkgeyAgICAgIFxuICAgICAgICBhc3NlcnQ6IHRoaXMubGlua2VkLCAnQW4gZWxlbWVudCBiZWNvbWVzIGNsb25hYmxlIG9ubHkgYWZ0ZXIgYmVpbmcgbGlua2VkLic7XG4gICAgfVxufVxuXG5jb25zdCBkZWVwQ2xvbmUgPSAodmFsdWUpID0+IF8uY2xvbmVEZWVwV2l0aCh2YWx1ZSwgZWwgPT4gKGVsIGluc3RhbmNlb2YgQ2xvbmFibGUpID8gZWwuY2xvbmUoKSA6IHVuZGVmaW5lZCk7XG5cbmNvbnN0IGRlZXBDbG9uZUZpZWxkID0gKHNyYywgZGVzdCwgZmllbGQpID0+IHtcbiAgICBpZiAoZmllbGQgaW4gc3JjKSBkZXN0W2ZpZWxkXSA9IGRlZXBDbG9uZShzcmNbZmllbGRdKTtcbn07XG5cbmNvbnN0IGlzRG90U2VwYXJhdGVOYW1lID0gKG5hbWUpID0+IChuYW1lLmluZGV4T2YoJy4nKSA+IDApO1xuXG5jb25zdCBleHRyYWN0RG90U2VwYXJhdGVOYW1lID0gKG5hbWUpID0+IG5hbWUuc3BsaXQoJy4nKTtcblxuY29uc3QgZXh0cmFjdFJlZmVyZW5jZUJhc2VOYW1lID0gKG5hbWUpID0+IGV4dHJhY3REb3RTZXBhcmF0ZU5hbWUobmFtZSkucG9wKCk7XG5cbmNvbnN0IHByZWZpeE5hbWluZyA9IChwcmVmaXgsIG5hbWUpID0+IHtcbiAgICBsZXQgbGVmdFBhcnRzID0gXy5rZWJhYkNhc2UocHJlZml4KS5zcGxpdCgnLScpO1xuICAgIGxldCByaWdodFBhcnRzID0gXy5rZWJhYkNhc2UobmFtZSkuc3BsaXQoJy0nKTtcbiAgICBcbiAgICBsZXQgcmVzZXJ2ZWRMZWZ0LCByZXNlcnZlZFJpZ2h0O1xuXG4gICAgaWYgKGxlZnRQYXJ0cy5sZW5ndGggPiByaWdodFBhcnRzLmxlbmd0aCkge1xuICAgICAgICByZXNlcnZlZExlZnQgPSBsZWZ0UGFydHMuc3BsaWNlKDAsIGxlZnRQYXJ0cy5sZW5ndGggLSByaWdodFBhcnRzLmxlbmd0aCk7XG4gICAgICAgIHJlc2VydmVkUmlnaHQgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXNlcnZlZExlZnQgPSBbXTtcbiAgICAgICAgcmVzZXJ2ZWRSaWdodCA9IHJpZ2h0UGFydHMuc3BsaWNlKGxlZnRQYXJ0cy5sZW5ndGgsIHJpZ2h0UGFydHMubGVuZ3RoIC0gbGVmdFBhcnRzLmxlbmd0aCk7XG4gICAgfVxuXG4gICAgY29uc3QgY29tYmluZSA9ICgpID0+IF8uY2FtZWxDYXNlKHJlc2VydmVkTGVmdC5jb25jYXQobGVmdFBhcnRzKS5jb25jYXQocmVzZXJ2ZWRSaWdodCkuam9pbignLScpKTtcblxuICAgIGlmIChfLmlzRXF1YWwobGVmdFBhcnRzLCByaWdodFBhcnRzKSkge1xuICAgICAgICByZXR1cm4gY29tYmluZSgpO1xuICAgIH1cbiAgICBcbiAgICB3aGlsZSAobGVmdFBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzZXJ2ZWRMZWZ0LnB1c2gobGVmdFBhcnRzLnNoaWZ0KCkpO1xuICAgICAgICByZXNlcnZlZFJpZ2h0LnVuc2hpZnQocmlnaHRQYXJ0cy5wb3AoKSk7XG4gICAgICAgIGlmIChfLmlzRXF1YWwobGVmdFBhcnRzLCByaWdodFBhcnRzKSkge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9IFxuXG4gICAgcmV0dXJuIGNvbWJpbmUoKTtcbn07XG5cbmNvbnN0IGdldFJlZmVyZW5jZU5hbWVJZkl0SXMgPSAob2JqKSA9PiB7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChvYmopICYmIG9iai5vb2xUeXBlID09PSAnT2JqZWN0UmVmZXJlbmNlJykge1xuICAgICAgICByZXR1cm4gZXh0cmFjdERvdFNlcGFyYXRlTmFtZShvYmoubmFtZSlbMF07XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydHMucGFyc2VSZWZlcmVuY2VJbkRvY3VtZW50ID0gKHNjaGVtYSwgZG9jLCByZWYpID0+IHsgICAgXG4gICAgbGV0IHBhcnRzID0gcmVmLnNwbGl0KCcuJyk7XG4gICAgbGV0IHBhcmVudDtcbiAgICBsZXQgbCA9IHBhcnRzLmxlbmd0aDtcbiAgICBsZXQgZW50aXR5Tm9kZSwgZW50aXR5LCBmaWVsZDtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgICBsZXQgcCA9IHBhcnRzW2ldO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFlbnRpdHlOb2RlKSB7XG4gICAgICAgICAgICBpZiAoZG9jLmVudGl0eSA9PT0gcCkge1xuICAgICAgICAgICAgICAgIGVudGl0eU5vZGUgPSBkb2M7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZW50aXR5Tm9kZSAmJiBwWzBdID09PSAnJCcpIHtcbiAgICAgICAgICAgIGVudGl0eSA9IHNjaGVtYS5lbnRpdGllc1tlbnRpdHlOb2RlLmVudGl0eV07XG4gICAgICAgICAgICBsZXQgYXR0ciA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocCk7XG5cbiAgICAgICAgICAgIGlmIChhdHRyIGluc3RhbmNlb2YgRmllbGQpIHtcbiAgICAgICAgICAgICAgICBmaWVsZCA9IGF0dHI7XG4gICAgICAgICAgICAgICAgaWYgKGkgIT09IGwtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5vZGUsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eSxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBhdHRyO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHBhcmVudCkge1xuICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50W3BdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGkgPT09IGwtMSkge1xuICAgICAgICAgICAgICAgIC8vbGFzdCBwYXJ0XG4gICAgICAgICAgICAgICAgZW50aXR5ID0gc2NoZW1hLmVudGl0aWVzW2VudGl0eU5vZGUuZW50aXR5XTtcbiAgICAgICAgICAgICAgICBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBlbnRpdHlOb2RlLFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHksXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW50aXR5Tm9kZSA9IGVudGl0eU5vZGUuc3ViRG9jdW1lbnRzICYmIGVudGl0eU5vZGUuc3ViRG9jdW1lbnRzW3BdO1xuICAgICAgICAgICAgaWYgKCFlbnRpdHlOb2RlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWZlcmVuY2UgYnkgcGF0aCBcIiR7cmVmfVwiIG5vdCBmb3VuZCBpbiBnaXZlbiBkb2N1bWVudC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJlbnQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZSBieSBwYXRoIFwiJHtyZWZ9XCIgbm90IGZvdW5kIGluIGdpdmVuIGRvY3VtZW50LmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFlbnRpdHkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBmaWVsZCA9IGVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUocGFyZW50KTtcbiAgICAgICAgaWYgKCEoZmllbGQgaW5zdGFuY2VvZiBGaWVsZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlIGJ5IHBhdGggXCIke3JlZn1cIiBub3QgZm91bmQgaW4gZ2l2ZW4gZG9jdW1lbnQuYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZW50aXR5Tm9kZSxcbiAgICAgICAgZW50aXR5LFxuICAgICAgICBmaWVsZFxuICAgIH07XG59O1xuXG5leHBvcnRzLnBsdXJhbGl6ZSA9IChuYW1lKSA9PiB7XG4gICAgbGV0IHBhcnRzID0gXy5rZWJhYkNhc2UobmFtZSkuc3BsaXQoJy0nKTtcbiAgICBsZXQgbGFzdCA9IHBsdXJhbGl6ZShwYXJ0cy5wb3AoKS50b0xvd2VyQ2FzZSgpKTtcbiAgICBwYXJ0cy5wdXNoKGxhc3QpO1xuICAgIHJldHVybiBfLmNhbWVsQ2FzZShwYXJ0cy5qb2luKCctJykpO1xufTtcblxuZXhwb3J0cy5kZWVwQ2xvbmUgPSBkZWVwQ2xvbmU7XG5leHBvcnRzLmRlZXBDbG9uZUZpZWxkID0gZGVlcENsb25lRmllbGQ7XG5leHBvcnRzLmlzRG90U2VwYXJhdGVOYW1lID0gaXNEb3RTZXBhcmF0ZU5hbWU7XG5leHBvcnRzLmV4dHJhY3REb3RTZXBhcmF0ZU5hbWUgPSBleHRyYWN0RG90U2VwYXJhdGVOYW1lO1xuZXhwb3J0cy5leHRyYWN0UmVmZXJlbmNlQmFzZU5hbWUgPSBleHRyYWN0UmVmZXJlbmNlQmFzZU5hbWU7XG5leHBvcnRzLmdldFJlZmVyZW5jZU5hbWVJZkl0SXMgPSBnZXRSZWZlcmVuY2VOYW1lSWZJdElzO1xuZXhwb3J0cy5zY2hlbWFOYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5lbnRpdHlOYW1pbmcgPSBuYW1lID0+IF8uY2FtZWxDYXNlKG5hbWUpO1xuZXhwb3J0cy5maWVsZE5hbWluZyA9IG5hbWUgPT4gXy5jYW1lbENhc2UobmFtZSk7XG5leHBvcnRzLnByZWZpeE5hbWluZyA9IHByZWZpeE5hbWluZztcbmV4cG9ydHMuZ2VuZXJhdGVEaXNwbGF5TmFtZSA9IG5hbWUgPT4gXy5zdGFydENhc2UobmFtZSk7XG5leHBvcnRzLmZvcm1hdEZpZWxkcyA9IGZpZWxkID0+IEFycmF5LmlzQXJyYXkoZmllbGQpID8gZmllbGQuam9pbignLCAnKSA6IGZpZWxkO1xuZXhwb3J0cy5DbG9uYWJsZSA9IENsb25hYmxlOyJdfQ==