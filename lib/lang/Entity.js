"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable,
  entityNaming,
  fieldNaming,
  prefixNaming
} = require('./OolUtils');

const Field = require('./Field');

class Entity extends Clonable {
  constructor(linker, name, oolModule, info) {
    super();
    this._events = new EventEmitter();
    this.fields = {};
    this.linker = linker;
    this.name = entityNaming(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  on(eventName, listener) {
    return this._events.on(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.base) {
      let baseEntity = this.linker.loadEntity(this.oolModule, this.info.base);

      if (!baseEntity.linked) {
        throw new Error("Assertion failed: baseEntity.linked");
      }

      this._inherit(baseEntity);
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = this.comment || generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));

        fn(this, this.linker.translateOolValue(this.oolModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.oolModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, destEntity, props) {
    if (!this.associations) {
      this.associations = {};
    }

    this.associations[name] = {
      entity: destEntity.name,
      ...props
    };
  }

  addAssocField(name, destEntity, destField) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField, ['default', 'auto', 'writeOnce', 'startFrom', 'readOnly', 'forceUpdate', 'freezeAfterNonDefault']);

    destFieldInfo.name = name;
    this.addField(name, destFieldInfo);
    this.fields[name].displayName = fieldNaming(prefixNaming(destEntity.name, destField.name));
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.oolModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (feature.name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferenceTo(entityName, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      displayName: this.displayName,
      comment: this.comment,
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    deepCloneField(baseEntity, this, 'features');
    deepCloneField(baseEntity, this, 'fields');
    deepCloneField(baseEntity, this, 'key');
    deepCloneField(baseEntity, this, 'indexes');
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsImZpZWxkTmFtaW5nIiwicHJlZml4TmFtaW5nIiwiRmllbGQiLCJFbnRpdHkiLCJjb25zdHJ1Y3RvciIsImxpbmtlciIsIm5hbWUiLCJvb2xNb2R1bGUiLCJpbmZvIiwiX2V2ZW50cyIsImZpZWxkcyIsIm9uIiwiZXZlbnROYW1lIiwibGlzdGVuZXIiLCJsaW5rIiwibGlua2VkIiwibG9nIiwiYmFzZSIsImJhc2VFbnRpdHkiLCJsb2FkRW50aXR5IiwiX2luaGVyaXQiLCJjb21tZW50IiwiZGlzcGxheU5hbWUiLCJlbWl0IiwiZmVhdHVyZXMiLCJmb3JFYWNoIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidHJhbnNsYXRlT29sVmFsdWUiLCJhcmdzIiwiZWFjaCIsImZpZWxkSW5mbyIsImZpZWxkTmFtZSIsImFkZEZpZWxkIiwia2V5IiwiQXJyYXkiLCJpc0FycmF5IiwibGVuZ3RoIiwiaXNFbXB0eSIsImludGVyZmFjZXMiLCJjbG9uZURlZXAiLCJmb3JPd24iLCJpbnRmIiwiYWNjZXB0IiwibWFwIiwicGFyYW0iLCJ0cmFja0JhY2tUeXBlIiwiaGFzSW5kZXhPbiIsImNvbmNhdCIsInNvcnQiLCJmaW5kSW5kZXgiLCJpbmRleGVzIiwiaW5kZXgiLCJmIiwiaWR4IiwiYWRkSW5kZXhlcyIsImFkZEluZGV4IiwiZmllbGQiLCJub3JtYWxpemVkRmllbGQiLCJjYW1lbENhc2UiLCJoYXNGaWVsZCIsIkVycm9yIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwiZGVzdEVudGl0eSIsInByb3BzIiwiYXNzb2NpYXRpb25zIiwiZW50aXR5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RGaWVsZCIsImxvY2FsRmllbGQiLCJkZXN0RmllbGRJbmZvIiwib21pdCIsInJhd0luZm8iLCJ0eXBlIiwiY2xvbmUiLCJmdWxsUmF3SW5mbyIsImFkZEZlYXR1cmUiLCJhbGxvd011bHRpcGxlIiwic2V0S2V5IiwiZ2V0UmVmZXJlbmNlVG8iLCJlbnRpdHlOYW1lIiwiZXhjbHVkZXMiLCJmaW5kIiwiYXNzb2MiLCJhc3NvY2lhdGlvbiIsImluZGV4T2YiLCJ0eXBlcyIsImdldEtleUZpZWxkIiwia2YiLCJ0b0pTT04iLCJtYXBWYWx1ZXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLFlBQVksR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBNUI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBUUYsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxtQkFBRjtBQUF1QkMsRUFBQUEsY0FBdkI7QUFBdUNDLEVBQUFBLFFBQXZDO0FBQWlEQyxFQUFBQSxZQUFqRDtBQUErREMsRUFBQUEsV0FBL0Q7QUFBNEVDLEVBQUFBO0FBQTVFLElBQTZGUixPQUFPLENBQUMsWUFBRCxDQUExRzs7QUFFQSxNQUFNUyxLQUFLLEdBQUdULE9BQU8sQ0FBQyxTQUFELENBQXJCOztBQVlBLE1BQU1VLE1BQU4sU0FBcUJMLFFBQXJCLENBQThCO0FBZTFCTSxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBU0MsSUFBVCxFQUFlQyxTQUFmLEVBQTBCQyxJQUExQixFQUFnQztBQUN2QztBQUR1QyxTQWQzQ0MsT0FjMkMsR0FkakMsSUFBSWpCLFlBQUosRUFjaUM7QUFBQSxTQVIzQ2tCLE1BUTJDLEdBUmxDLEVBUWtDO0FBT3ZDLFNBQUtMLE1BQUwsR0FB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Q0FBQyxJQUFELEVBQU8rRSxNQUFQLEVBQWUsWUFBZixDQUFkO0FBRUFBLElBQUFBLE1BQU0sQ0FBQzdELE1BQVAsR0FBZ0IsSUFBaEI7QUFFQSxXQUFPNkQsTUFBUDtBQUNIOztBQU1EdUIsRUFBQUEsTUFBTSxHQUFHO0FBQ0wsV0FBTztBQUNIN0YsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBRFI7QUFFSGdCLE1BQUFBLFdBQVcsRUFBRSxLQUFLQSxXQUZmO0FBR0hELE1BQUFBLE9BQU8sRUFBRSxLQUFLQSxPQUhYO0FBSUhHLE1BQUFBLFFBQVEsRUFBRSxLQUFLQSxRQUpaO0FBS0hkLE1BQUFBLE1BQU0sRUFBRWYsQ0FBQyxDQUFDeUcsU0FBRixDQUFZLEtBQUsxRixNQUFqQixFQUF5QmtELEtBQUssSUFBSUEsS0FBSyxDQUFDdUMsTUFBTixFQUFsQyxDQUxMO0FBTUh4QixNQUFBQSxZQUFZLEVBQUUsS0FBS0EsWUFOaEI7QUFPSHRDLE1BQUFBLEdBQUcsRUFBRSxLQUFLQSxHQVBQO0FBUUhpQixNQUFBQSxPQUFPLEVBQUUsS0FBS0E7QUFSWCxLQUFQO0FBVUg7O0FBRURsQyxFQUFBQSxRQUFRLENBQUNGLFVBQUQsRUFBYTtBQUNqQnJCLElBQUFBLGNBQWMsQ0FBQ3FCLFVBQUQsRUFBYSxJQUFiLEVBQW1CLFVBQW5CLENBQWQ7QUFDQXJCLElBQUFBLGNBQWMsQ0FBQ3FCLFVBQUQsRUFBYSxJQUFiLEVBQW1CLFFBQW5CLENBQWQ7QUFDQXJCLElBQUFBLGNBQWMsQ0FBQ3FCLFVBQUQsRUFBYSxJQUFiLEVBQW1CLEtBQW5CLENBQWQ7QUFDQXJCLElBQUFBLGNBQWMsQ0FBQ3FCLFVBQUQsRUFBYSxJQUFiLEVBQW1CLFNBQW5CLENBQWQ7QUFDSDs7QUFwY3lCOztBQXVjOUJtRixNQUFNLENBQUNDLE9BQVAsR0FBaUJuRyxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgZ2VuZXJhdGVEaXNwbGF5TmFtZSwgZGVlcENsb25lRmllbGQsIENsb25hYmxlLCBlbnRpdHlOYW1pbmcsIGZpZWxkTmFtaW5nLCBwcmVmaXhOYW1pbmcgfSA9IHJlcXVpcmUoJy4vT29sVXRpbHMnKTtcblxuY29uc3QgRmllbGQgPSByZXF1aXJlKCcuL0ZpZWxkJyk7XG5cbi8qKlxuICogRW50aXR5IGV2ZW50IGxpc3RlbmVyXG4gKiBAY2FsbGJhY2sgT29sb25nRW50aXR5LmV2ZW50TGlzdGVuZXJcbiAqIHJldHVybnMgeyp9XG4gKi9cblxuLyoqXG4gKiBPb2xvbmcgZW50aXR5XG4gKiBAY2xhc3MgT29sb25nRW50aXR5XG4gKi9cbmNsYXNzIEVudGl0eSBleHRlbmRzIENsb25hYmxlIHtcbiAgICBfZXZlbnRzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgLyoqXG4gICAgICogRmllbGRzIG9mIHRoZSBlbnRpdHksIG1hcCBvZiA8ZmllbGROYW1lLCBmaWVsZE9iamVjdD5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgT29sb25nRmllbGQ+fVxuICAgICAqL1xuICAgIGZpZWxkcyA9IHt9O1xuXG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge0xpbmtlcn0gbGlua2VyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IG9vbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBvb2xNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gZW50aXR5TmFtaW5nKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBvb2xvbmcgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub29sTW9kdWxlID0gb29sTW9kdWxlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSYXcgbWV0YWRhdGFcbiAgICAgICAgICogQG1lbWJlciB7T2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3RlbiBvbiBhbiBldmVudFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyfSBsaXN0ZW5lclxuICAgICAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9XG4gICAgICovXG4gICAgb24oZXZlbnROYW1lLCBsaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRzLm9uKGV2ZW50TmFtZSwgbGlzdGVuZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBlbnRpdHlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIC8vMS5pbmhlcml0IGZyb20gYmFzZSBlbnRpdHkgaWYgYW55XG4gICAgICAgIC8vMi5pbml0aWFsaXplIGZlYXR1cmVzXG4gICAgICAgIC8vMy5hZGQgZmllbGRzICAgICAgICBcbiAgICAgICAgLy80LmFwaVxuXG4gICAgICAgIC8vaW5kZXhlcyB3aWxsIHByb2Nlc3NlZCBhZnRlciBwcm9jZXNzaW5nIGZvcmVpZ24gcmVsYXRpb25zaGlwXG5cbiAgICAgICAgdGhpcy5saW5rZXIubG9nKCdkZWJ1ZycsICdMaW5raW5nIGVudGl0eSBbJyArIHRoaXMubmFtZSArICddIC4uLicpO1xuXG4gICAgICAgIGlmICh0aGlzLmluZm8uYmFzZSkge1xuICAgICAgICAgICAgLy9pbmhlcml0IGZpZWxkcywgcHJvY2Vzc2VkIGZlYXR1cmVzLCBrZXkgYW5kIGluZGV4ZXNcbiAgICAgICAgICAgIGxldCBiYXNlRW50aXR5ID0gdGhpcy5saW5rZXIubG9hZEVudGl0eSh0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvLmJhc2UpO1xuICAgICAgICAgICAgYXNzZXJ0OiBiYXNlRW50aXR5LmxpbmtlZDtcblxuICAgICAgICAgICAgdGhpcy5faW5oZXJpdChiYXNlRW50aXR5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uY29tbWVudCkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IHRoaXMuaW5mby5jb21tZW50O1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGlzcGxheU5hbWUgPSB0aGlzLmNvbW1lbnQgfHwgZ2VuZXJhdGVEaXNwbGF5TmFtZSh0aGlzLm5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2ZlYXR1cmVzTWl4aW5nSW5cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdmZWF0dXJlc01peGluZ0luJyk7XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBpZiAodGhpcy5pbmZvLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZm8uZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZU5hbWU7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVOYW1lID0gZmVhdHVyZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmUubmFtZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgZm4gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuL2VudGl0eUZlYXR1cmVzLyR7ZmVhdHVyZU5hbWV9LmpzYCkpO1xuICAgICAgICAgICAgICAgIGZuKHRoaXMsIHRoaXMubGlua2VyLnRyYW5zbGF0ZU9vbFZhbHVlKHRoaXMub29sTW9kdWxlLCBmZWF0dXJlLmFyZ3MpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYmVmb3JlQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nRmllbGRzJyk7XG5cbiAgICAgICAgLy8gcHJvY2VzcyBmaWVsZHNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5maWVsZHMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uZmllbGRzLCAoZmllbGRJbmZvLCBmaWVsZE5hbWUpID0+IHRoaXMuYWRkRmllbGQoZmllbGROYW1lLCBmaWVsZEluZm8pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2FmdGVyQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdGaWVsZHMnKTsgICBcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmtleSkge1xuICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmluZm8ua2V5O1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgJiYgdGhpcy5rZXkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmtleVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2JlZm9yZUFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdiZWZvcmVBZGRpbmdJbnRlcmZhY2VzJyk7ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5pbnRlcmZhY2VzKSkge1xuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2VzID0gXy5jbG9uZURlZXAodGhpcy5pbmZvLmludGVyZmFjZXMpO1xuXG4gICAgICAgICAgICBfLmZvck93bih0aGlzLmludGVyZmFjZXMsIChpbnRmKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoaW50Zi5hY2NlcHQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGludGYuYWNjZXB0ID0gXy5tYXAoaW50Zi5hY2NlcHQsIHBhcmFtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxpbmtlci50cmFja0JhY2tUeXBlKHRoaXMub29sTW9kdWxlLCBwYXJhbSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzJyk7ICAgICAgICBcblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhbiBpbmRleCBvbiB0aGUgZ2l2ZW4gZmllbGRzXG4gICAgICogQHBhcmFtIHthcnJheX0gZmllbGRzXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzSW5kZXhPbihmaWVsZHMpIHtcbiAgICAgICAgZmllbGRzID0gZmllbGRzLmNvbmNhdCgpO1xuICAgICAgICBmaWVsZHMuc29ydCgpO1xuXG4gICAgICAgIHJldHVybiBfLmZpbmRJbmRleCh0aGlzLmluZGV4ZXMsIGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gXy5maW5kSW5kZXgoaW5kZXguZmllbGRzLCAoZiwgaWR4KSA9PiAoZmllbGRzLmxlbmd0aCA8PSBpZHggfHwgZmllbGRzW2lkeF0gIT09IGYpKSA9PT0gLTE7XG4gICAgICAgICAgICB9KSAhPSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYWxsIGluZGV4ZXNcbiAgICAgKi9cbiAgICBhZGRJbmRleGVzKCkge1xuICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkSW5kZXgoaW5kZXgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gaW5kZXhcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2FycmF5fSBpbmRleC5maWVsZHMgLSBGaWVsZHMgb2YgdGhlIGluZGV4XG4gICAgICogQHByb3BlcnR5IHtib29sfSBpbmRleC51bmlxdWUgLSBGbGFnIG9mIHVuaXF1ZW5lc3Mgb2YgdGhlIGluZGV4XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRJbmRleChpbmRleCkge1xuICAgICAgICBpZiAoIXRoaXMuaW5kZXhlcykge1xuICAgICAgICAgICAgdGhpcy5pbmRleGVzID0gW107XG4gICAgICAgIH1cblxuICAgICAgICBpbmRleCA9IF8uY2xvbmVEZWVwKGluZGV4KTtcblxuICAgICAgICBhc3NlcnQ6IGluZGV4LmZpZWxkcztcblxuICAgICAgICBpZiAoIV8uaXNBcnJheShpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICBpbmRleC5maWVsZHMgPSBbIGluZGV4LmZpZWxkcyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZpZWxkcyA9IGluZGV4LmZpZWxkczsgXG5cbiAgICAgICAgaW5kZXguZmllbGRzID0gXy5tYXAoZmllbGRzLCBmaWVsZCA9PiB7XG5cbiAgICAgICAgICAgIGxldCBub3JtYWxpemVkRmllbGQgPSBfLmNhbWVsQ2FzZShmaWVsZCk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChub3JtYWxpemVkRmllbGQpKSB7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IHJlZmVyZW5jZXMgbm9uLWV4aXN0IGZpZWxkOiAke2ZpZWxkfSwgZW50aXR5OiAke3RoaXMubmFtZX0uYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemVkRmllbGQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGluZGV4LmZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaGFzSW5kZXhPbihpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IG9uIFske2luZGV4LmZpZWxkcy5qb2luKCcsICcpfV0gYWxyZWFkeSBleGlzdCBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmluZGV4ZXMucHVzaChpbmRleCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgZmllbGQgb2JqZWN0IGJ5IGZpZWxkIG5hbWUgb3IgZmllbGQgYWNjZXNvci5cbiAgICAgKiBAcGFyYW0gZmllbGRJZFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdGaWVsZH1cbiAgICAgKi9cbiAgICBnZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGRJZCkge1xuICAgICAgICBpZiAoZmllbGRJZFswXSA9PT0gJyQnKSB7XG4gICAgICAgICAgICBsZXQgdG9rZW4gPSBmaWVsZElkLnN1YnN0cigxKTtcblxuICAgICAgICAgICAgc3dpdGNoICh0b2tlbikge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJrZXlcIjpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW3RoaXMua2V5XTtcblxuICAgICAgICAgICAgICAgIGNhc2UgJ2ZlYXR1cmUnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcztcblxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZWQgYWNjZXNzb3IgXCIke3Rva2VufVwiIG5vdCBzdXBwb3J0ZWQhYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzRmllbGQoZmllbGRJZCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIFwiJHtmaWVsZElkfVwiIG5vdCBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuYClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW2ZpZWxkSWRdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhIGZpZWxkIHdpdGggZ2l2ZW4gbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzRmllbGQobmFtZSkge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIF8uZXZlcnkobmFtZSwgZm4gPT4gdGhpcy5oYXNGaWVsZChmbikpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5maWVsZHM7XG4gICAgfVxuXG4gICAgYWRkQXNzb2NpYXRpb24obmFtZSwgZGVzdEVudGl0eSwgcHJvcHMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYXNzb2NpYXRpb25zW25hbWVdID0ge1xuICAgICAgICAgICAgZW50aXR5OiBkZXN0RW50aXR5Lm5hbWUsXG4gICAgICAgICAgICAuLi5wcm9wc1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGFzc29jaWF0aW9uIGZpZWxkLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHl9IGRlc3RFbnRpdHlcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0ZpZWxkfSBkZXN0RmllbGRcbiAgICAgKi9cbiAgICBhZGRBc3NvY0ZpZWxkKG5hbWUsIGRlc3RFbnRpdHksIGRlc3RGaWVsZCkge1xuICAgICAgICBsZXQgbG9jYWxGaWVsZCA9IHRoaXMuZmllbGRzW25hbWVdO1xuXG4gICAgICAgIGlmIChsb2NhbEZpZWxkKSB7XG4gICAgICAgICAgICAvKlxuICAgICAgICAgICAgaWYgKCFsb2NhbEZpZWxkLmhhc1NhbWVUeXBlKGRlc3RGaWVsZC50b0pTT04oKSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSB0eXBlIG9mIHNvdXJjZSBmaWVsZCBcIiR7dGhpcy5uYW1lfS4ke25hbWV9XCIgaXMgZGlmZmVyZW50IGZyb20gdGhlIHJlZmVyZW5jZWQgZmllbGQgXCIke2Rlc3RFbnRpdHkubmFtZX0uJHtkZXN0RmllbGQubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIH0qL1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKTtcbiAgICAgICAgICAgIC8vcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRlc3RGaWVsZEluZm8gPSBfLm9taXQoZGVzdEZpZWxkLCBbJ2RlZmF1bHQnLCAnYXV0bycsICd3cml0ZU9uY2UnLCAnc3RhcnRGcm9tJywgJ3JlYWRPbmx5JywgJ2ZvcmNlVXBkYXRlJywgJ2ZyZWV6ZUFmdGVyTm9uRGVmYXVsdCddKTtcbiAgICAgICAgZGVzdEZpZWxkSW5mby5uYW1lID0gbmFtZTtcblxuICAgICAgICB0aGlzLmFkZEZpZWxkKG5hbWUsIGRlc3RGaWVsZEluZm8pOyAgICBcbiAgICAgICAgdGhpcy5maWVsZHNbbmFtZV0uZGlzcGxheU5hbWUgPSBmaWVsZE5hbWluZyhwcmVmaXhOYW1pbmcoZGVzdEVudGl0eS5uYW1lLCBkZXN0RmllbGQubmFtZSkpOyAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZpZWxkIGludG8gdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJhd0luZm9cbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEZpZWxkKG5hbWUsIHJhd0luZm8pIHsgICAgICAgIFxuICAgICAgICBpZiAodGhpcy5oYXNGaWVsZChuYW1lKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBuYW1lIFske25hbWV9XSBjb25mbGljdHMgaW4gZW50aXR5IFske3RoaXMubmFtZX1dLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgYXNzZXJ0OiByYXdJbmZvLnR5cGU7XG5cbiAgICAgICAgbGV0IGZpZWxkO1xuXG4gICAgICAgIGlmIChyYXdJbmZvIGluc3RhbmNlb2YgRmllbGQpIHtcbiAgICAgICAgICAgIGZpZWxkID0gcmF3SW5mby5jbG9uZSgpO1xuICAgICAgICAgICAgZmllbGQubmFtZSA9IG5hbWU7IC8vIHRvZG86IGRpc3BsYXlOYW1lXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgZnVsbFJhd0luZm8gPSB0aGlzLmxpbmtlci50cmFja0JhY2tUeXBlKHRoaXMub29sTW9kdWxlLCByYXdJbmZvKTtcblxuICAgICAgICAgICAgZmllbGQgPSBuZXcgRmllbGQobmFtZSwgZnVsbFJhd0luZm8pO1xuICAgICAgICAgICAgZmllbGQubGluaygpO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5maWVsZHNbbmFtZV0gPSBmaWVsZDtcblxuICAgICAgICBpZiAoIXRoaXMua2V5KSB7XG4gICAgICAgICAgICAvL21ha2UgdGhlIGZpcnN0IGZpZWxkIGFzIHRoZSBkZWZhdWx0IGtleVxuICAgICAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmVhdHVyZSBpbnRvIHRoZSBlbnRpdHksIGUuZy4gYXV0byBpbmNyZW1lbnQgaWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7Kn0gZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7Ym9vbH0gW2FsbG93TXVsdGlwbGU9ZmFsc2VdIC0gQWxsb3cgbXVsdGlwbGUgb2NjdXJyZW5jZVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmVhdHVyZShuYW1lLCBmZWF0dXJlLCBhbGxvd011bHRpcGxlKSB7XG4gICAgICAgIGlmICghdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFsbG93TXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5mZWF0dXJlc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5wdXNoKGZlYXR1cmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGZlYXR1cmUubmFtZSBpbiB0aGlzLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEdXBsaWNhdGUgZmVhdHVyZSBmb3VuZDogJHtuYW1lfS4gVHVybiBvbiBhbGxvd011bHRpcGxlIHRvIGVuYWJsZSBtdWx0aXBsZSBvY2N1cnJlbmNlIG9mIGEgZmVhdHVyZS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXSA9IGZlYXR1cmU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQga2V5IG5hbWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ3xhcnJheS48c3RyaW5nPn0gbmFtZSAtIEZpZWxkIG5hbWUgdG8gYmUgdXNlZCBhcyB0aGUga2V5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBzZXRLZXkobmFtZSkge1xuICAgICAgICB0aGlzLmtleSA9IG5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGFzc29jaWF0aW9uIGluZm8gaWYgdGhlcmUgaXMgY29ubmVjdGlvbiB0byB0aGUgZ2l2ZW4gZGVzdGluYXRpb24gZW50aXR5LlxuICAgICAqL1xuICAgIGdldFJlZmVyZW5jZVRvKGVudGl0eU5hbWUsIGV4Y2x1ZGVzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluZm8uYXNzb2NpYXRpb25zICYmIF8uZmluZChcbiAgICAgICAgICAgIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMsIGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9uICYmIGFzc29jID09PSBleGNsdWRlcy5hc3NvY2lhdGlvbikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZSAmJiBhc3NvYy50eXBlID09PSBleGNsdWRlcy50eXBlKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5hc3NvY2lhdGlvbnMgJiYgZXhjbHVkZXMuYXNzb2NpYXRpb25zLmluZGV4T2YoYXNzb2MpID4gLTEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnR5cGVzICYmIGV4Y2x1ZGVzLnR5cGVzLmluZGV4T2YoYXNzb2MudHlwZSkgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzb2MuZGVzdEVudGl0eSA9PT0gZW50aXR5TmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQga2V5IGZpZWxkIFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGdldEtleUZpZWxkKCkge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgPyB0aGlzLmtleS5tYXAoa2YgPT4gdGhpcy5maWVsZHNba2ZdKSA6IHRoaXMuZmllbGRzW3RoaXMua2V5XTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtNYXB9IFtzdGFja10gLSBSZWZlcmVuY2Ugc3RhY2sgdG8gYXZvaWQgcmVjdXJyZW5jZSBjb3B5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHsgICAgICAgIFxuICAgICAgICBzdXBlci5jbG9uZSgpO1xuXG4gICAgICAgIGxldCBlbnRpdHkgPSBuZXcgRW50aXR5KHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8pOyAgICAgICAgXG5cbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZGlzcGxheU5hbWUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29tbWVudCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmZWF0dXJlcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmaWVsZHMnKTsgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Fzc29jaWF0aW9ucycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2luZGV4ZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogdGhpcy5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRoaXMuY29tbWVudCwgICAgICAgICAgICBcbiAgICAgICAgICAgIGZlYXR1cmVzOiB0aGlzLmZlYXR1cmVzLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZmllbGRzOiBfLm1hcFZhbHVlcyh0aGlzLmZpZWxkcywgZmllbGQgPT4gZmllbGQudG9KU09OKCkpLFxuICAgICAgICAgICAgYXNzb2NpYXRpb25zOiB0aGlzLmFzc29jaWF0aW9ucyxcbiAgICAgICAgICAgIGtleTogdGhpcy5rZXksXG4gICAgICAgICAgICBpbmRleGVzOiB0aGlzLmluZGV4ZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfaW5oZXJpdChiYXNlRW50aXR5KSB7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2ZlYXR1cmVzJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKGJhc2VFbnRpdHksIHRoaXMsICdmaWVsZHMnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKGJhc2VFbnRpdHksIHRoaXMsICdpbmRleGVzJyk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVudGl0eTsiXX0=