"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  deepClone,
  Clonable,
  entityNaming
} = require('./OolUtils');

const Field = require('./Field');

const {
  FunctionalQualifiers
} = require('../runtime/types');

class Entity extends Clonable {
  constructor(linker, name, oolModule, info) {
    super();
    this._events = new EventEmitter();
    this.fields = {};
    this.linker = linker;
    this.name = entityNaming(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  on(eventName, listener) {
    return this._events.on(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.code) {
      this.code = this.info.code || this.name;
    }

    if (this.info.base) {
      let baseClasses = _.castArray(this.info.base);

      baseClasses.forEach(base => {
        let baseEntity = this.linker.loadEntity(this.oolModule, base);

        if (!baseEntity.linked) {
          throw new Error("Assertion failed: baseEntity.linked");
        }

        this._inherit(baseEntity);
      });
      this.baseClasses = baseClasses;
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.oolModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.oolModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.oolModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (feature.name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, entity, 'code');
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      code: this.code,
      displayName: this.displayName,
      comment: this.comment,
      ...(this.baseClasses ? {
        baseClasses: this.baseClasses
      } : {}),
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    let overrideInfo = {};

    if (baseEntity.baseClasses) {
      let baseClasses = baseEntity.baseClasses;

      if (this.baseClasses) {
        this.baseClasses = _.uniq(baseClasses.concat(this.baseClasses));
      } else {
        this.baseClasses = baseClasses.concat();
      }
    }

    if (baseEntity.features) {
      let baseFeatures = deepClone(baseEntity.features);
      this.features = { ...this.features,
        ...baseFeatures
      };
    }

    if (baseEntity.fields) {
      let fields = deepClone(baseEntity.fields);
      this.fields = { ...this.fields,
        ...fields
      };
    }

    deepCloneField(baseEntity, this, 'key');

    if (baseEntity.info.indexes) {
      let indexes = deepClone(baseEntity.info.indexes);

      if (this.info.indexes) {
        indexes = indexes.concat(this.info.indexes);
      }

      overrideInfo.indexes = indexes;
    }

    if (baseEntity.info.associations) {
      let assocs = deepClone(baseEntity.info.associations);
      assocs = assocs.map(assoc => {
        if (assoc.destEntity === baseEntity.name) {
          return { ...assoc,
            destEntity: this.name
          };
        }

        return assoc;
      });

      if (this.info.associations) {
        assocs = assocs.concat(this.info.associations);
      }

      overrideInfo.associations = assocs;
    }

    if (!_.isEmpty(overrideInfo)) {
      this.info = Object.freeze({ ...this.info,
        ...overrideInfo
      });
    }
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJkZWVwQ2xvbmUiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsIkZpZWxkIiwiRnVuY3Rpb25hbFF1YWxpZmllcnMiLCJFbnRpdHkiLCJjb25zdHJ1Y3RvciIsImxpbmtlciIsIm5hbWUiLCJvb2xNb2R1bGUiLCJpbmZvIiwiX2V2ZW50cyIsImZpZWxkcyIsIm9uIiwiZXZlbnROYW1lIiwibGlzdGVuZXIiLCJsaW5rIiwibGlua2VkIiwibG9nIiwiY29kZSIsImJhc2UiLCJiYXNlQ2xhc3NlcyIsImNhc3RBcnJheSIsImZvckVhY2giLCJiYXNlRW50aXR5IiwibG9hZEVudGl0eSIsIl9pbmhlcml0IiwiY29tbWVudCIsImRpc3BsYXlOYW1lIiwiZW1pdCIsImZlYXR1cmVzIiwiZmVhdHVyZSIsImZlYXR1cmVOYW1lIiwiZm4iLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZXJyIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImNhbWVsQ2FzZSIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsInR5cGUiLCJjbG9uZSIsImZ1bGxSYXdJbmZvIiwiYWRkRmVhdHVyZSIsImFsbG93TXVsdGlwbGUiLCJzZXRLZXkiLCJnZXRSZWZlcmVuY2VUbyIsImVudGl0eU5hbWUiLCJpbmNsdWRlcyIsImV4Y2x1ZGVzIiwiZmluZCIsImFzc29jIiwidmFsdWUiLCJwcm9wIiwiaXNFcXVhbCIsImFzc29jaWF0aW9uIiwiaW5kZXhPZiIsInR5cGVzIiwiZ2V0S2V5RmllbGQiLCJrZiIsImVudGl0eSIsIm1hcFZhbHVlcyIsIm92ZXJyaWRlSW5mbyIsInVuaXEiLCJiYXNlRmVhdHVyZXMiLCJhc3NvY3MiLCJmcmVlemUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLFlBQVksR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBNUI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBUUYsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxtQkFBRjtBQUF1QkMsRUFBQUEsY0FBdkI7QUFBdUNDLEVBQUFBLFNBQXZDO0FBQWtEQyxFQUFBQSxRQUFsRDtBQUE0REMsRUFBQUE7QUFBNUQsSUFBNkVQLE9BQU8sQ0FBQyxZQUFELENBQTFGOztBQUVBLE1BQU1RLEtBQUssR0FBR1IsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFUyxFQUFBQTtBQUFGLElBQTJCVCxPQUFP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Q0FBQ2QsSUFBWCxDQUFnQnNFLFlBQXBCLEVBQWtDO0FBQzlCLFVBQUl1QyxNQUFNLEdBQUd2SCxTQUFTLENBQUN3QixVQUFVLENBQUNkLElBQVgsQ0FBZ0JzRSxZQUFqQixDQUF0QjtBQUVBdUMsTUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUNqRSxHQUFQLENBQVdtRCxLQUFLLElBQUk7QUFDekIsWUFBSUEsS0FBSyxDQUFDckIsVUFBTixLQUFxQjVELFVBQVUsQ0FBQ2hCLElBQXBDLEVBQTBDO0FBQ3RDLGlCQUFPLEVBQ0gsR0FBR2lHLEtBREE7QUFFSHJCLFlBQUFBLFVBQVUsRUFBRSxLQUFLNUU7QUFGZCxXQUFQO0FBSUg7O0FBRUQsZUFBT2lHLEtBQVA7QUFDSCxPQVRRLENBQVQ7O0FBV0EsVUFBSSxLQUFLL0YsSUFBTCxDQUFVc0UsWUFBZCxFQUE0QjtBQUN4QnVDLFFBQUFBLE1BQU0sR0FBR0EsTUFBTSxDQUFDN0QsTUFBUCxDQUFjLEtBQUtoRCxJQUFMLENBQVVzRSxZQUF4QixDQUFUO0FBQ0g7O0FBRURvQyxNQUFBQSxZQUFZLENBQUNwQyxZQUFiLEdBQTRCdUMsTUFBNUI7QUFDSDs7QUFFRCxRQUFJLENBQUMxSCxDQUFDLENBQUNtRCxPQUFGLENBQVVvRSxZQUFWLENBQUwsRUFBOEI7QUFDMUIsV0FBSzFHLElBQUwsR0FBWWlGLE1BQU0sQ0FBQzZCLE1BQVAsQ0FBYyxFQUFFLEdBQUcsS0FBSzlHLElBQVY7QUFBZ0IsV0FBRzBHO0FBQW5CLE9BQWQsQ0FBWjtBQUNIO0FBQ0o7O0FBamlCeUI7O0FBb2lCOUJLLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJILE1BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lLCBkZWVwQ2xvbmVGaWVsZCwgZGVlcENsb25lLCBDbG9uYWJsZSwgZW50aXR5TmFtaW5nIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbmNvbnN0IEZpZWxkID0gcmVxdWlyZSgnLi9GaWVsZCcpO1xuY29uc3QgeyBGdW5jdGlvbmFsUXVhbGlmaWVycyB9ID0gcmVxdWlyZSgnLi4vcnVudGltZS90eXBlcycpO1xuXG4vKipcbiAqIEVudGl0eSBldmVudCBsaXN0ZW5lclxuICogQGNhbGxiYWNrIE9vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyXG4gKiByZXR1cm5zIHsqfVxuICovXG5cbi8qKlxuICogT29sb25nIGVudGl0eVxuICogQGNsYXNzIE9vbG9uZ0VudGl0eVxuICovXG5jbGFzcyBFbnRpdHkgZXh0ZW5kcyBDbG9uYWJsZSB7XG4gICAgX2V2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKlxuICAgICAqIEZpZWxkcyBvZiB0aGUgZW50aXR5LCBtYXAgb2YgPGZpZWxkTmFtZSwgZmllbGRPYmplY3Q+XG4gICAgICogQG1lbWJlciB7b2JqZWN0LjxzdHJpbmcsIE9vbG9uZ0ZpZWxkPn1cbiAgICAgKi9cbiAgICBmaWVsZHMgPSB7fTtcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtMaW5rZXJ9IGxpbmtlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBvb2xNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgb29sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IGVudGl0eU5hbWluZyhuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgb29sb25nIG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9vbE1vZHVsZSA9IG9vbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW4gb24gYW4gZXZlbnRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lcn0gbGlzdGVuZXJcbiAgICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfVxuICAgICAqL1xuICAgIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50cy5vbihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgZW50aXR5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICAvLzEuaW5oZXJpdCBmcm9tIGJhc2UgZW50aXR5IGlmIGFueVxuICAgICAgICAvLzIuaW5pdGlhbGl6ZSBmZWF0dXJlc1xuICAgICAgICAvLzMuYWRkIGZpZWxkcyAgICAgICAgXG4gICAgICAgIC8vNC5hcGlcblxuICAgICAgICAvL2luZGV4ZXMgd2lsbCBwcm9jZXNzZWQgYWZ0ZXIgcHJvY2Vzc2luZyBmb3JlaWduIHJlbGF0aW9uc2hpcFxuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBlbnRpdHkgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvZGUpIHtcbiAgICAgICAgICAgIHRoaXMuY29kZSA9IHRoaXMuaW5mby5jb2RlIHx8IHRoaXMubmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmluZm8uYmFzZSkge1xuICAgICAgICAgICAgLy9pbmhlcml0IGZpZWxkcywgcHJvY2Vzc2VkIGZlYXR1cmVzLCBrZXkgYW5kIGluZGV4ZXNcbiAgICAgICAgICAgIGxldCBiYXNlQ2xhc3NlcyA9IF8uY2FzdEFycmF5KHRoaXMuaW5mby5iYXNlKTtcbiAgICAgICAgICAgIGJhc2VDbGFzc2VzLmZvckVhY2goYmFzZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGJhc2VFbnRpdHkgPSB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHRoaXMub29sTW9kdWxlLCBiYXNlKTtcbiAgICAgICAgICAgICAgICBhc3NlcnQ6IGJhc2VFbnRpdHkubGlua2VkO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5faW5oZXJpdChiYXNlRW50aXR5KTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gYmFzZUNsYXNzZXM7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvbW1lbnQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSB0aGlzLmluZm8uY29tbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRpc3BsYXlOYW1lID0gZ2VuZXJhdGVEaXNwbGF5TmFtZSh0aGlzLm5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2ZlYXR1cmVzTWl4aW5nSW5cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdmZWF0dXJlc01peGluZ0luJyk7XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBpZiAodGhpcy5pbmZvLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZm8uZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZmVhdHVyZU5hbWU7XG5cbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVOYW1lID0gZmVhdHVyZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmUubmFtZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgZm47XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgZm4gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIGAuL2VudGl0eUZlYXR1cmVzLyR7ZmVhdHVyZU5hbWV9LmpzYCkpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICdNT0RVTEVfTk9UX0ZPVU5EJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3cgZmVhdHVyZSBcIiR7ZmVhdHVyZU5hbWV9XCIgcmVmZXJlbmNlIGluIGVudGl0eSBcIiR7dGhpcy5uYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm4odGhpcywgdGhpcy5saW5rZXIudHJhbnNsYXRlT29sVmFsdWUodGhpcy5vb2xNb2R1bGUsIGZlYXR1cmUuYXJncykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNiZWZvcmVBZGRpbmdGaWVsZHNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdiZWZvcmVBZGRpbmdGaWVsZHMnKTtcblxuICAgICAgICAvLyBwcm9jZXNzIGZpZWxkc1xuICAgICAgICBpZiAodGhpcy5pbmZvLmZpZWxkcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5maWVsZHMsIChmaWVsZEluZm8sIGZpZWxkTmFtZSkgPT4gdGhpcy5hZGRGaWVsZChmaWVsZE5hbWUsIGZpZWxkSW5mbykpO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYWZ0ZXJBZGRpbmdGaWVsZHNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ZpZWxkcycpOyAgIFxuXG4gICAgICAgIGlmICh0aGlzLmluZm8ua2V5KSB7XG4gICAgICAgICAgICB0aGlzLmtleSA9IHRoaXMuaW5mby5rZXk7XG5cbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMua2V5KSAmJiB0aGlzLmtleS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmtleSA9IHRoaXMua2V5WzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYmVmb3JlQWRkaW5nSW50ZXJmYWNlc1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZXZlbnRzLmVtaXQoJ2JlZm9yZUFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5pbmZvLmludGVyZmFjZXMpKSB7XG4gICAgICAgICAgICB0aGlzLmludGVyZmFjZXMgPSBfLmNsb25lRGVlcCh0aGlzLmluZm8uaW50ZXJmYWNlcyk7XG5cbiAgICAgICAgICAgIF8uZm9yT3duKHRoaXMuaW50ZXJmYWNlcywgKGludGYpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIV8uaXNFbXB0eShpbnRmLmFjY2VwdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaW50Zi5hY2NlcHQgPSBfLm1hcChpbnRmLmFjY2VwdCwgcGFyYW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5vb2xNb2R1bGUsIHBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNhZnRlckFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdhZnRlckFkZGluZ0ludGVyZmFjZXMnKTsgICAgICAgIFxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGFuIGluZGV4IG9uIHRoZSBnaXZlbiBmaWVsZHNcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBmaWVsZHNcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNJbmRleE9uKGZpZWxkcykge1xuICAgICAgICBmaWVsZHMgPSBmaWVsZHMuY29uY2F0KCk7XG4gICAgICAgIGZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgcmV0dXJuIF8uZmluZEluZGV4KHRoaXMuaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBfLmZpbmRJbmRleChpbmRleC5maWVsZHMsIChmLCBpZHgpID0+IChmaWVsZHMubGVuZ3RoIDw9IGlkeCB8fCBmaWVsZHNbaWR4XSAhPT0gZikpID09PSAtMTtcbiAgICAgICAgICAgIH0pICE9IC0xO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbGwgaW5kZXhlc1xuICAgICAqL1xuICAgIGFkZEluZGV4ZXMoKSB7XG4gICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuaW5mby5pbmRleGVzLCBpbmRleCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRJbmRleChpbmRleCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhbiBpbmRleFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmRleFxuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGluZGV4LmZpZWxkcyAtIEZpZWxkcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2Jvb2x9IGluZGV4LnVuaXF1ZSAtIEZsYWcgb2YgdW5pcXVlbmVzcyBvZiB0aGUgaW5kZXhcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEluZGV4KGluZGV4KSB7XG4gICAgICAgIGlmICghdGhpcy5pbmRleGVzKSB7XG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGluZGV4ID0gXy5jbG9uZURlZXAoaW5kZXgpO1xuXG4gICAgICAgIGFzc2VydDogaW5kZXguZmllbGRzO1xuXG4gICAgICAgIGlmICghXy5pc0FycmF5KGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIGluZGV4LmZpZWxkcyA9IFsgaW5kZXguZmllbGRzIF07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmllbGRzID0gaW5kZXguZmllbGRzOyBcblxuICAgICAgICBpbmRleC5maWVsZHMgPSBfLm1hcChmaWVsZHMsIGZpZWxkID0+IHtcblxuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRGaWVsZCA9IF8uY2FtZWxDYXNlKGZpZWxkKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0ZpZWxkKG5vcm1hbGl6ZWRGaWVsZCkpIHtcblxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggcmVmZXJlbmNlcyBub24tZXhpc3QgZmllbGQ6ICR7ZmllbGR9LCBlbnRpdHk6ICR7dGhpcy5uYW1lfS5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRGaWVsZDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaW5kZXguZmllbGRzLnNvcnQoKTtcblxuICAgICAgICBpZiAodGhpcy5oYXNJbmRleE9uKGluZGV4LmZpZWxkcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5kZXggb24gWyR7aW5kZXguZmllbGRzLmpvaW4oJywgJyl9XSBhbHJlYWR5IGV4aXN0IGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuaW5kZXhlcy5wdXNoKGluZGV4KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBmaWVsZCBvYmplY3QgYnkgZmllbGQgbmFtZSBvciBmaWVsZCBhY2Nlc29yLlxuICAgICAqIEBwYXJhbSBmaWVsZElkXG4gICAgICogQHJldHVybnMge09vbG9uZ0ZpZWxkfVxuICAgICAqL1xuICAgIGdldEVudGl0eUF0dHJpYnV0ZShmaWVsZElkKSB7XG4gICAgICAgIGlmIChmaWVsZElkWzBdID09PSAnJCcpIHtcbiAgICAgICAgICAgIGxldCB0b2tlbiA9IGZpZWxkSWQuc3Vic3RyKDEpO1xuXG4gICAgICAgICAgICBzd2l0Y2ggKHRva2VuKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBcImtleVwiOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbdGhpcy5rZXldO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnZmVhdHVyZSc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzO1xuXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlZCBhY2Nlc3NvciBcIiR7dG9rZW59XCIgbm90IHN1cHBvcnRlZCFgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChmaWVsZElkKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgXCIke2ZpZWxkSWR9XCIgbm90IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maWVsZHNbZmllbGRJZF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIHRoZSBlbnRpdHkgaGFzIGEgZmllbGQgd2l0aCBnaXZlbiBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNGaWVsZChuYW1lKSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5ldmVyeShuYW1lLCBmbiA9PiB0aGlzLmhhc0ZpZWxkKGZuKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmFtZSBpbiB0aGlzLmZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYXNzb2NpYXRpb24sIGRibXMtc3BlY2lmaWNcbiAgICAgKiBAcGFyYW0geyp9IG5hbWUgXG4gICAgICogQHBhcmFtIHsqfSBwcm9wcyBcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGUuZy4gbXlzcWxcbiAgICAgKiAgZW50aXR5IC0gQXNzb2NpYXRlZCBlbnRpdHkgbmFtZVxuICAgICAqICBqb2luIC0gSm9pbiB0eXBlLCBlLmcuIElOTkVSLCBMRUZULCBSSUdIVCwgT1VURVJcbiAgICAgKiAgZXhjbHVkZSAtIEV4Y2x1ZGUgaW4gb3V0cHV0IGNvbHVtbnNcbiAgICAgKiAgYWxpYXMgLSBBbGlhcyBcbiAgICAgKiAgb24gLSBPbiBjb25kaXRpb25zXG4gICAgICogIGRhdGFzZXQgLSBTdWIgcXVlcnlcbiAgICAgKiAgYXNzb2NzIC0gQ2hpbGQgYXNzb2NpYXRpb25zXG4gICAgICogIG9wdGlvbmFsIC0gT3B0aW9uYWxcbiAgICAgKiAgJ2RlZmF1bHQnIC0gRGVmYXVsdCB2YWx1ZVxuICAgICAqICBsaXN0IC0gSXMgYSBsaXN0XG4gICAgICovXG4gICAgYWRkQXNzb2NpYXRpb24obmFtZSwgcHJvcHMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSB7fTtcbiAgICAgICAgfSAgICBcblxuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLmFzc29jaWF0aW9ucykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBc3NvY2lhdGlvbiBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi4gUHJvcHM6IGAgKyBKU09OLnN0cmluZ2lmeShwcm9wcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5hc3NvY2lhdGlvbnNbbmFtZV0gPSBwcm9wcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBhc3NvY2lhdGlvbiBmaWVsZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7T29sb25nRW50aXR5fSBkZXN0RW50aXR5XG4gICAgICogQHBhcmFtIHtPb2xvbmdGaWVsZH0gZGVzdEZpZWxkXG4gICAgICovXG4gICAgYWRkQXNzb2NGaWVsZChuYW1lLCBkZXN0RW50aXR5LCBkZXN0RmllbGQsIGV4dHJhUHJvcHMpIHtcbiAgICAgICAgbGV0IGxvY2FsRmllbGQgPSB0aGlzLmZpZWxkc1tuYW1lXTtcblxuICAgICAgICBpZiAobG9jYWxGaWVsZCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWVsZCBcIiR7bmFtZX1cIiBhbHJlYWR5IGV4aXN0cyBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXN0RmllbGRJbmZvID0gXy5vbWl0KGRlc3RGaWVsZC50b0pTT04oKSwgRnVuY3Rpb25hbFF1YWxpZmllcnMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKGRlc3RGaWVsZEluZm8sIGV4dHJhUHJvcHMpOyAgICAgICBcblxuICAgICAgICB0aGlzLmFkZEZpZWxkKG5hbWUsIGRlc3RGaWVsZEluZm8pOyAgICBcbiAgICAgICAgLy90aGlzLmZpZWxkc1tuYW1lXS5kaXNwbGF5TmFtZSA9IGZpZWxkTmFtaW5nKHByZWZpeE5hbWluZyhkZXN0RW50aXR5Lm5hbWUsIGRlc3RGaWVsZC5uYW1lKSk7ICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgZmllbGQgaW50byB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmF3SW5mb1xuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgYWRkRmllbGQobmFtZSwgcmF3SW5mbykgeyAgICAgICAgXG4gICAgICAgIGlmICh0aGlzLmhhc0ZpZWxkKG5hbWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIG5hbWUgWyR7bmFtZX1dIGNvbmZsaWN0cyBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICBhc3NlcnQ6IHJhd0luZm8udHlwZTtcblxuICAgICAgICBsZXQgZmllbGQ7XG5cbiAgICAgICAgaWYgKHJhd0luZm8gaW5zdGFuY2VvZiBGaWVsZCkge1xuICAgICAgICAgICAgZmllbGQgPSByYXdJbmZvLmNsb25lKCk7XG4gICAgICAgICAgICBmaWVsZC5uYW1lID0gbmFtZTsgLy8gdG9kbzogZGlzcGxheU5hbWVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxldCBmdWxsUmF3SW5mbyA9IHRoaXMubGlua2VyLnRyYWNrQmFja1R5cGUodGhpcy5vb2xNb2R1bGUsIHJhd0luZm8pO1xuXG4gICAgICAgICAgICBmaWVsZCA9IG5ldyBGaWVsZChuYW1lLCBmdWxsUmF3SW5mbyk7XG4gICAgICAgICAgICBmaWVsZC5saW5rKCk7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLmZpZWxkc1tuYW1lXSA9IGZpZWxkO1xuXG4gICAgICAgIGlmICghdGhpcy5rZXkpIHtcbiAgICAgICAgICAgIC8vbWFrZSB0aGUgZmlyc3QgZmllbGQgYXMgdGhlIGRlZmF1bHQga2V5XG4gICAgICAgICAgICB0aGlzLmtleSA9IG5hbWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmZWF0dXJlIGludG8gdGhlIGVudGl0eSwgZS5nLiBhdXRvIGluY3JlbWVudCBpZFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtib29sfSBbYWxsb3dNdWx0aXBsZT1mYWxzZV0gLSBBbGxvdyBtdWx0aXBsZSBvY2N1cnJlbmNlXG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRGZWF0dXJlKG5hbWUsIGZlYXR1cmUsIGFsbG93TXVsdGlwbGUpIHtcbiAgICAgICAgaWYgKCF0aGlzLmZlYXR1cmVzKSB7XG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzID0ge307XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWxsb3dNdWx0aXBsZSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmZlYXR1cmVzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXSA9IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdLnB1c2goZmVhdHVyZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZmVhdHVyZS5uYW1lIGluIHRoaXMuZmVhdHVyZXMpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBmZWF0dXJlIGZvdW5kOiAke25hbWV9LiBUdXJuIG9uIGFsbG93TXVsdGlwbGUgdG8gZW5hYmxlIG11bHRpcGxlIG9jY3VycmVuY2Ugb2YgYSBmZWF0dXJlLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdID0gZmVhdHVyZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldCBrZXkgbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfGFycmF5LjxzdHJpbmc+fSBuYW1lIC0gRmllbGQgbmFtZSB0byBiZSB1c2VkIGFzIHRoZSBrZXlcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIHNldEtleShuYW1lKSB7XG4gICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgYXNzb2NpYXRpb24gaW5mbyBpZiB0aGVyZSBpcyBjb25uZWN0aW9uIHRvIHRoZSBnaXZlbiBkZXN0aW5hdGlvbiBlbnRpdHkuXG4gICAgICovXG4gICAgZ2V0UmVmZXJlbmNlVG8oZW50aXR5TmFtZSwgaW5jbHVkZXMsIGV4Y2x1ZGVzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmluZm8uYXNzb2NpYXRpb25zICYmIF8uZmluZChcbiAgICAgICAgICAgIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMsIGFzc29jID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF8uZmluZChpbmNsdWRlcywgKHZhbHVlLCBwcm9wKSA9PiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgPyAhdmFsdWUoYXNzb2NbcHJvcF0pIDogIV8uaXNFcXVhbChhc3NvY1twcm9wXSwgdmFsdWUpKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb24gJiYgYXNzb2MgPT09IGV4Y2x1ZGVzLmFzc29jaWF0aW9uKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlICYmIGFzc29jLnR5cGUgPT09IGV4Y2x1ZGVzLnR5cGUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLmFzc29jaWF0aW9ucyAmJiBleGNsdWRlcy5hc3NvY2lhdGlvbnMuaW5kZXhPZihhc3NvYykgPiAtMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMudHlwZXMgJiYgZXhjbHVkZXMudHlwZXMuaW5kZXhPZihhc3NvYy50eXBlKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5wcm9wcyAmJiBfLmZpbmQoZXhjbHVkZXMucHJvcHMsIHByb3AgPT4gYXNzb2NbcHJvcF0pKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jLmRlc3RFbnRpdHkgPT09IGVudGl0eU5hbWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGtleSBmaWVsZCBcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBnZXRLZXlGaWVsZCgpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodGhpcy5rZXkpID8gdGhpcy5rZXkubWFwKGtmID0+IHRoaXMuZmllbGRzW2tmXSkgOiB0aGlzLmZpZWxkc1t0aGlzLmtleV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIGVudGl0eVxuICAgICAqIEBwYXJhbSB7TWFwfSBbc3RhY2tdIC0gUmVmZXJlbmNlIHN0YWNrIHRvIGF2b2lkIHJlY3VycmVuY2UgY29weVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgY2xvbmUoKSB7ICAgICAgICBcbiAgICAgICAgc3VwZXIuY2xvbmUoKTtcblxuICAgICAgICBsZXQgZW50aXR5ID0gbmV3IEVudGl0eSh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvKTsgICAgICAgIFxuXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2NvZGUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZGlzcGxheU5hbWUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29tbWVudCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmZWF0dXJlcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmaWVsZHMnKTsgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Fzc29jaWF0aW9ucycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2luZGV4ZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsICAgICBcbiAgICAgICAgICAgIGNvZGU6IHRoaXMuY29kZSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb21tZW50LCAgICAgICAgICAgIFxuICAgICAgICAgICAgLi4uKHRoaXMuYmFzZUNsYXNzZXMgPyB7IGJhc2VDbGFzc2VzOiB0aGlzLmJhc2VDbGFzc2VzIH0gOiB7fSksXG4gICAgICAgICAgICBmZWF0dXJlczogdGhpcy5mZWF0dXJlcywgICAgICAgICAgICBcbiAgICAgICAgICAgIGZpZWxkczogXy5tYXBWYWx1ZXModGhpcy5maWVsZHMsIGZpZWxkID0+IGZpZWxkLnRvSlNPTigpKSxcbiAgICAgICAgICAgIGFzc29jaWF0aW9uczogdGhpcy5hc3NvY2lhdGlvbnMsXG4gICAgICAgICAgICBrZXk6IHRoaXMua2V5LFxuICAgICAgICAgICAgaW5kZXhlczogdGhpcy5pbmRleGVzXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2luaGVyaXQoYmFzZUVudGl0eSkgeyAgXG4gICAgICAgIGxldCBvdmVycmlkZUluZm8gPSB7fTtcblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5iYXNlQ2xhc3Nlcykge1xuICAgICAgICAgICAgbGV0IGJhc2VDbGFzc2VzID0gYmFzZUVudGl0eS5iYXNlQ2xhc3NlcztcblxuICAgICAgICAgICAgaWYgKHRoaXMuYmFzZUNsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2VDbGFzc2VzID0gXy51bmlxKGJhc2VDbGFzc2VzLmNvbmNhdCh0aGlzLmJhc2VDbGFzc2VzKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzZXMgPSBiYXNlQ2xhc3Nlcy5jb25jYXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChiYXNlRW50aXR5LmZlYXR1cmVzKSB7XG4gICAgICAgICAgICBsZXQgYmFzZUZlYXR1cmVzID0gZGVlcENsb25lKGJhc2VFbnRpdHkuZmVhdHVyZXMpO1xuICAgICAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHsgLi4udGhpcy5mZWF0dXJlcywgLi4uYmFzZUZlYXR1cmVzIH07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYmFzZUVudGl0eS5maWVsZHMpIHtcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSBkZWVwQ2xvbmUoYmFzZUVudGl0eS5maWVsZHMpO1xuICAgICAgICAgICAgdGhpcy5maWVsZHMgPSB7IC4uLnRoaXMuZmllbGRzLCAuLi5maWVsZHMgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2tleScpOyAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5pbmRleGVzKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXhlcyA9IGRlZXBDbG9uZShiYXNlRW50aXR5LmluZm8uaW5kZXhlcyk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmluZm8uaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIGluZGV4ZXMgPSBpbmRleGVzLmNvbmNhdCh0aGlzLmluZm8uaW5kZXhlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG92ZXJyaWRlSW5mby5pbmRleGVzID0gaW5kZXhlcztcbiAgICAgICAgfSAgICAgICAgXG5cbiAgICAgICAgaWYgKGJhc2VFbnRpdHkuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIGxldCBhc3NvY3MgPSBkZWVwQ2xvbmUoYmFzZUVudGl0eS5pbmZvLmFzc29jaWF0aW9ucyk7XG5cbiAgICAgICAgICAgIGFzc29jcyA9IGFzc29jcy5tYXAoYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhc3NvYy5kZXN0RW50aXR5ID09PSBiYXNlRW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFzc29jLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEVudGl0eTogdGhpcy5uYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFzc29jO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBhc3NvY3MgPSBhc3NvY3MuY29uY2F0KHRoaXMuaW5mby5hc3NvY2lhdGlvbnMpO1xuICAgICAgICAgICAgfSAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgb3ZlcnJpZGVJbmZvLmFzc29jaWF0aW9ucyA9IGFzc29jcztcbiAgICAgICAgfSAgICAgXG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkob3ZlcnJpZGVJbmZvKSkgeyAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmluZm8gPSBPYmplY3QuZnJlZXplKHsgLi4udGhpcy5pbmZvLCAuLi5vdmVycmlkZUluZm8gfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW50aXR5OyJdfQ==