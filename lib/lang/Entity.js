"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable,
  entityNaming,
  fieldNaming,
  prefixNaming
} = require('./OolUtils');

const Field = require('./Field');

const {
  FunctionalQualifiers
} = require('../runtime/types');

class Entity extends Clonable {
  constructor(linker, name, oolModule, info) {
    super();
    this._events = new EventEmitter();
    this.fields = {};
    this.linker = linker;
    this.name = entityNaming(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  on(eventName, listener) {
    return this._events.on(eventName, listener);
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking entity [' + this.name + '] ...');

    if (this.info.base) {
      let baseEntity = this.linker.loadEntity(this.oolModule, this.info.base);

      if (!baseEntity.linked) {
        throw new Error("Assertion failed: baseEntity.linked");
      }

      this._inherit(baseEntity);
    }

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = this.comment || generateDisplayName(this.name);

    this._events.emit('featuresMixingIn');

    if (this.info.features) {
      this.info.features.forEach(feature => {
        let featureName;

        if (typeof feature === 'string') {
          featureName = feature;
        } else {
          featureName = feature.name;
        }

        let fn;

        try {
          fn = require(path.resolve(__dirname, `./entityFeatures/${featureName}.js`));
        } catch (err) {
          if (err.code === 'MODULE_NOT_FOUND') {
            throw new Error(`Unknow feature "${featureName}" reference in entity "${this.name}"`);
          }
        }

        fn(this, this.linker.translateOolValue(this.oolModule, feature.args));
      });
    }

    this._events.emit('beforeAddingFields');

    if (this.info.fields) {
      _.each(this.info.fields, (fieldInfo, fieldName) => this.addField(fieldName, fieldInfo));
    }

    this._events.emit('afterAddingFields');

    if (this.info.key) {
      this.key = this.info.key;

      if (Array.isArray(this.key) && this.key.length === 1) {
        this.key = this.key[0];
      }
    }

    this._events.emit('beforeAddingInterfaces');

    if (!_.isEmpty(this.info.interfaces)) {
      this.interfaces = _.cloneDeep(this.info.interfaces);

      _.forOwn(this.interfaces, intf => {
        if (!_.isEmpty(intf.accept)) {
          intf.accept = _.map(intf.accept, param => {
            return this.linker.trackBackType(this.oolModule, param);
          });
        }
      });
    }

    this._events.emit('afterAddingInterfaces');

    this.linked = true;
    return this;
  }

  hasIndexOn(fields) {
    fields = fields.concat();
    fields.sort();
    return _.findIndex(this.indexes, index => {
      return _.findIndex(index.fields, (f, idx) => fields.length <= idx || fields[idx] !== f) === -1;
    }) != -1;
  }

  addIndexes() {
    if (this.info.indexes) {
      _.each(this.info.indexes, index => {
        this.addIndex(index);
      });
    }
  }

  addIndex(index) {
    if (!this.indexes) {
      this.indexes = [];
    }

    index = _.cloneDeep(index);

    if (!index.fields) {
      throw new Error("Assertion failed: index.fields");
    }

    if (!_.isArray(index.fields)) {
      index.fields = [index.fields];
    }

    let fields = index.fields;
    index.fields = _.map(fields, field => {
      let normalizedField = _.camelCase(field);

      if (!this.hasField(normalizedField)) {
        throw new Error(`Index references non-exist field: ${field}, entity: ${this.name}.`);
      }

      return normalizedField;
    });
    index.fields.sort();

    if (this.hasIndexOn(index.fields)) {
      throw new Error(`Index on [${index.fields.join(', ')}] already exist in entity [${this.name}].`);
    }

    this.indexes.push(index);
    return this;
  }

  getEntityAttribute(fieldId) {
    if (fieldId[0] === '$') {
      let token = fieldId.substr(1);

      switch (token) {
        case "key":
          return this.fields[this.key];

        case 'feature':
          return this.features;

        default:
          throw new Error(`Filed accessor "${token}" not supported!`);
      }
    } else {
      if (!this.hasField(fieldId)) {
        throw new Error(`Field "${fieldId}" not exists in entity "${this.name}".`);
      }

      return this.fields[fieldId];
    }
  }

  hasField(name) {
    if (Array.isArray(name)) {
      return _.every(name, fn => this.hasField(fn));
    }

    return name in this.fields;
  }

  addAssociation(name, props) {
    if (!this.associations) {
      this.associations = {};
    }

    if (name in this.associations) {
      throw new Error(`Association "${name}" already exists in entity "${this.name}". Props: ` + JSON.stringify(props));
    }

    this.associations[name] = props;
  }

  addAssocField(name, destEntity, destField, extraProps) {
    let localField = this.fields[name];

    if (localField) {
      throw new Error(`Field "${name}" already exists in entity "${this.name}".`);
    }

    let destFieldInfo = _.omit(destField.toJSON(), FunctionalQualifiers);

    Object.assign(destFieldInfo, extraProps);
    this.addField(name, destFieldInfo);
  }

  addField(name, rawInfo) {
    if (this.hasField(name)) {
      throw new Error(`Field name [${name}] conflicts in entity [${this.name}].`);
    }

    if (!rawInfo.type) {
      throw new Error("Assertion failed: rawInfo.type");
    }

    let field;

    if (rawInfo instanceof Field) {
      field = rawInfo.clone();
      field.name = name;
    } else {
      let fullRawInfo = this.linker.trackBackType(this.oolModule, rawInfo);
      field = new Field(name, fullRawInfo);
      field.link();
    }

    this.fields[name] = field;

    if (!this.key) {
      this.key = name;
    }

    return this;
  }

  addFeature(name, feature, allowMultiple) {
    if (!this.features) {
      this.features = {};
    }

    if (allowMultiple) {
      if (!this.features[name]) {
        this.features[name] = [];
      }

      this.features[name].push(feature);
    } else {
      if (feature.name in this.features) {
        throw new Error(`Duplicate feature found: ${name}. Turn on allowMultiple to enable multiple occurrence of a feature.`);
      }

      this.features[name] = feature;
    }

    return this;
  }

  setKey(name) {
    this.key = name;
    return this;
  }

  getReferenceTo(entityName, includes, excludes) {
    return this.info.associations && _.find(this.info.associations, assoc => {
      if (includes) {
        if (_.find(includes, (value, prop) => typeof value === 'function' ? !value(assoc[prop]) : !_.isEqual(assoc[prop], value))) return false;
      }

      if (excludes) {
        if (excludes.association && assoc === excludes.association) return false;
        if (excludes.type && assoc.type === excludes.type) return false;
        if (excludes.associations && excludes.associations.indexOf(assoc) > -1) return false;
        if (excludes.types && excludes.types.indexOf(assoc.type) > -1) return false;
        if (excludes.props && _.find(excludes.props, prop => assoc[prop])) return false;
      }

      return assoc.destEntity === entityName;
    });
  }

  getKeyField() {
    return Array.isArray(this.key) ? this.key.map(kf => this.fields[kf]) : this.fields[this.key];
  }

  clone() {
    super.clone();
    let entity = new Entity(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, entity, 'displayName');
    deepCloneField(this, entity, 'comment');
    deepCloneField(this, entity, 'features');
    deepCloneField(this, entity, 'fields');
    deepCloneField(this, entity, 'associations');
    deepCloneField(this, entity, 'key');
    deepCloneField(this, entity, 'indexes');
    deepCloneField(this, entity, 'interfaces');
    entity.linked = true;
    return entity;
  }

  toJSON() {
    return {
      name: this.name,
      displayName: this.displayName,
      comment: this.comment,
      features: this.features,
      fields: _.mapValues(this.fields, field => field.toJSON()),
      associations: this.associations,
      key: this.key,
      indexes: this.indexes
    };
  }

  _inherit(baseEntity) {
    deepCloneField(baseEntity, this, 'features');
    deepCloneField(baseEntity, this, 'fields');
    deepCloneField(baseEntity, this, 'key');
    deepCloneField(baseEntity, this, 'indexes');
  }

}

module.exports = Entity;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0VudGl0eS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsIl8iLCJnZW5lcmF0ZURpc3BsYXlOYW1lIiwiZGVlcENsb25lRmllbGQiLCJDbG9uYWJsZSIsImVudGl0eU5hbWluZyIsImZpZWxkTmFtaW5nIiwicHJlZml4TmFtaW5nIiwiRmllbGQiLCJGdW5jdGlvbmFsUXVhbGlmaWVycyIsIkVudGl0eSIsImNvbnN0cnVjdG9yIiwibGlua2VyIiwibmFtZSIsIm9vbE1vZHVsZSIsImluZm8iLCJfZXZlbnRzIiwiZmllbGRzIiwib24iLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsImxpbmsiLCJsaW5rZWQiLCJsb2ciLCJiYXNlIiwiYmFzZUVudGl0eSIsImxvYWRFbnRpdHkiLCJfaW5oZXJpdCIsImNvbW1lbnQiLCJkaXNwbGF5TmFtZSIsImVtaXQiLCJmZWF0dXJlcyIsImZvckVhY2giLCJmZWF0dXJlIiwiZmVhdHVyZU5hbWUiLCJmbiIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJjb2RlIiwiRXJyb3IiLCJ0cmFuc2xhdGVPb2xWYWx1ZSIsImFyZ3MiLCJlYWNoIiwiZmllbGRJbmZvIiwiZmllbGROYW1lIiwiYWRkRmllbGQiLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJpc0VtcHR5IiwiaW50ZXJmYWNlcyIsImNsb25lRGVlcCIsImZvck93biIsImludGYiLCJhY2NlcHQiLCJtYXAiLCJwYXJhbSIsInRyYWNrQmFja1R5cGUiLCJoYXNJbmRleE9uIiwiY29uY2F0Iiwic29ydCIsImZpbmRJbmRleCIsImluZGV4ZXMiLCJpbmRleCIsImYiLCJpZHgiLCJhZGRJbmRleGVzIiwiYWRkSW5kZXgiLCJmaWVsZCIsIm5vcm1hbGl6ZWRGaWVsZCIsImNhbWVsQ2FzZSIsImhhc0ZpZWxkIiwiam9pbiIsInB1c2giLCJnZXRFbnRpdHlBdHRyaWJ1dGUiLCJmaWVsZElkIiwidG9rZW4iLCJzdWJzdHIiLCJldmVyeSIsImFkZEFzc29jaWF0aW9uIiwicHJvcHMiLCJhc3NvY2lhdGlvbnMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWRkQXNzb2NGaWVsZCIsImRlc3RFbnRpdHkiLCJkZXN0RmllbGQiLCJleHRyYVByb3BzIiwibG9jYWxGaWVsZCIsImRlc3RGaWVsZEluZm8iLCJvbWl0IiwidG9KU09OIiwiT2JqZWN0IiwiYXNzaWduIiwicmF3SW5mbyIsInR5cGUiLCJjbG9uZSIsImZ1bGxSYXdJbmZvIiwiYWRkRmVhdHVyZSIsImFsbG93TXVsdGlwbGUiLCJzZXRLZXkiLCJnZXRSZWZlcmVuY2VUbyIsImVudGl0eU5hbWUiLCJpbmNsdWRlcyIsImV4Y2x1ZGVzIiwiZmluZCIsImFzc29jIiwidmFsdWUiLCJwcm9wIiwiaXNFcXVhbCIsImFzc29jaWF0aW9uIiwiaW5kZXhPZiIsInR5cGVzIiwiZ2V0S2V5RmllbGQiLCJrZiIsImVudGl0eSIsIm1hcFZhbHVlcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsUUFBdkM7QUFBaURDLEVBQUFBLFlBQWpEO0FBQStEQyxFQUFBQSxXQUEvRDtBQUE0RUMsRUFBQUE7QUFBNUUsSUFBNkZSLE9BQU8sQ0FBQyxZQUFELENBQTFHOztBQUVBLE1BQU1TLEtBQUssR0FBR1QsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFVSxFQUFBQTtBQUFGLElBQTJCVixPQUFPLENBQUMsa0JBQUQsQ0FBeEM7O0FBWUEsTUFBTVcsTUFBTixTQUFxQk4sUUFB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QUFBQSxXQUFXLEVBQUUsS0FBS0EsV0FGZjtBQUdIRCxNQUFBQSxPQUFPLEVBQUUsS0FBS0EsT0FIWDtBQUlIRyxNQUFBQSxRQUFRLEVBQUUsS0FBS0EsUUFKWjtBQUtIZCxNQUFBQSxNQUFNLEVBQUVoQixDQUFDLENBQUNxSCxTQUFGLENBQVksS0FBS3JHLE1BQWpCLEVBQXlCcUQsS0FBSyxJQUFJQSxLQUFLLENBQUN1QixNQUFOLEVBQWxDLENBTEw7QUFNSFYsTUFBQUEsWUFBWSxFQUFFLEtBQUtBLFlBTmhCO0FBT0hwQyxNQUFBQSxHQUFHLEVBQUUsS0FBS0EsR0FQUDtBQVFIaUIsTUFBQUEsT0FBTyxFQUFFLEtBQUtBO0FBUlgsS0FBUDtBQVVIOztBQUVEckMsRUFBQUEsUUFBUSxDQUFDRixVQUFELEVBQWE7QUFDakJ0QixJQUFBQSxjQUFjLENBQUNzQixVQUFELEVBQWEsSUFBYixFQUFtQixVQUFuQixDQUFkO0FBQ0F0QixJQUFBQSxjQUFjLENBQUNzQixVQUFELEVBQWEsSUFBYixFQUFtQixRQUFuQixDQUFkO0FBQ0F0QixJQUFBQSxjQUFjLENBQUNzQixVQUFELEVBQWEsSUFBYixFQUFtQixLQUFuQixDQUFkO0FBQ0F0QixJQUFBQSxjQUFjLENBQUNzQixVQUFELEVBQWEsSUFBYixFQUFtQixTQUFuQixDQUFkO0FBQ0g7O0FBL2R5Qjs7QUFrZTlCOEYsTUFBTSxDQUFDQyxPQUFQLEdBQWlCOUcsTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IGdlbmVyYXRlRGlzcGxheU5hbWUsIGRlZXBDbG9uZUZpZWxkLCBDbG9uYWJsZSwgZW50aXR5TmFtaW5nLCBmaWVsZE5hbWluZywgcHJlZml4TmFtaW5nIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbmNvbnN0IEZpZWxkID0gcmVxdWlyZSgnLi9GaWVsZCcpO1xuY29uc3QgeyBGdW5jdGlvbmFsUXVhbGlmaWVycyB9ID0gcmVxdWlyZSgnLi4vcnVudGltZS90eXBlcycpO1xuXG4vKipcbiAqIEVudGl0eSBldmVudCBsaXN0ZW5lclxuICogQGNhbGxiYWNrIE9vbG9uZ0VudGl0eS5ldmVudExpc3RlbmVyXG4gKiByZXR1cm5zIHsqfVxuICovXG5cbi8qKlxuICogT29sb25nIGVudGl0eVxuICogQGNsYXNzIE9vbG9uZ0VudGl0eVxuICovXG5jbGFzcyBFbnRpdHkgZXh0ZW5kcyBDbG9uYWJsZSB7XG4gICAgX2V2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKlxuICAgICAqIEZpZWxkcyBvZiB0aGUgZW50aXR5LCBtYXAgb2YgPGZpZWxkTmFtZSwgZmllbGRPYmplY3Q+XG4gICAgICogQG1lbWJlciB7b2JqZWN0LjxzdHJpbmcsIE9vbG9uZ0ZpZWxkPn1cbiAgICAgKi9cbiAgICBmaWVsZHMgPSB7fTtcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtMaW5rZXJ9IGxpbmtlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHsqfSBvb2xNb2R1bGVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5mb1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGxpbmtlciwgbmFtZSwgb29sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge09vbG9uZ0xpbmtlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubGlua2VyID0gbGlua2VyO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoaXMgZW50aXR5XG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubmFtZSA9IGVudGl0eU5hbWluZyhuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgb29sb25nIG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9vbE1vZHVsZSA9IG9vbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87ICAgICAgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW4gb24gYW4gZXZlbnRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lXG4gICAgICogQHBhcmFtIHtPb2xvbmdFbnRpdHkuZXZlbnRMaXN0ZW5lcn0gbGlzdGVuZXJcbiAgICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfVxuICAgICAqL1xuICAgIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50cy5vbihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCBsaW5raW5nIHRoaXMgZW50aXR5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICAvLzEuaW5oZXJpdCBmcm9tIGJhc2UgZW50aXR5IGlmIGFueVxuICAgICAgICAvLzIuaW5pdGlhbGl6ZSBmZWF0dXJlc1xuICAgICAgICAvLzMuYWRkIGZpZWxkcyAgICAgICAgXG4gICAgICAgIC8vNC5hcGlcblxuICAgICAgICAvL2luZGV4ZXMgd2lsbCBwcm9jZXNzZWQgYWZ0ZXIgcHJvY2Vzc2luZyBmb3JlaWduIHJlbGF0aW9uc2hpcFxuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBlbnRpdHkgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmJhc2UpIHtcbiAgICAgICAgICAgIC8vaW5oZXJpdCBmaWVsZHMsIHByb2Nlc3NlZCBmZWF0dXJlcywga2V5IGFuZCBpbmRleGVzXG4gICAgICAgICAgICBsZXQgYmFzZUVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mby5iYXNlKTtcbiAgICAgICAgICAgIGFzc2VydDogYmFzZUVudGl0eS5saW5rZWQ7XG5cbiAgICAgICAgICAgIHRoaXMuX2luaGVyaXQoYmFzZUVudGl0eSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvbW1lbnQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSB0aGlzLmluZm8uY29tbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRpc3BsYXlOYW1lID0gdGhpcy5jb21tZW50IHx8IGdlbmVyYXRlRGlzcGxheU5hbWUodGhpcy5uYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQGZpcmVzIE9vbG9uZ0VudGl0eSNmZWF0dXJlc01peGluZ0luXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnZmVhdHVyZXNNaXhpbmdJbicpO1xuXG4gICAgICAgIC8vIGxvYWQgZmVhdHVyZXNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5mZWF0dXJlcykge1xuICAgICAgICAgICAgdGhpcy5pbmZvLmZlYXR1cmVzLmZvckVhY2goZmVhdHVyZSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVOYW1lO1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmZWF0dXJlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlTmFtZSA9IGZlYXR1cmU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZU5hbWUgPSBmZWF0dXJlLm5hbWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGZuO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGZuID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBgLi9lbnRpdHlGZWF0dXJlcy8ke2ZlYXR1cmVOYW1lfS5qc2ApKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93IGZlYXR1cmUgXCIke2ZlYXR1cmVOYW1lfVwiIHJlZmVyZW5jZSBpbiBlbnRpdHkgXCIke3RoaXMubmFtZX1cImApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZuKHRoaXMsIHRoaXMubGlua2VyLnRyYW5zbGF0ZU9vbFZhbHVlKHRoaXMub29sTW9kdWxlLCBmZWF0dXJlLmFyZ3MpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYmVmb3JlQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYmVmb3JlQWRkaW5nRmllbGRzJyk7XG5cbiAgICAgICAgLy8gcHJvY2VzcyBmaWVsZHNcbiAgICAgICAgaWYgKHRoaXMuaW5mby5maWVsZHMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uZmllbGRzLCAoZmllbGRJbmZvLCBmaWVsZE5hbWUpID0+IHRoaXMuYWRkRmllbGQoZmllbGROYW1lLCBmaWVsZEluZm8pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2FmdGVyQWRkaW5nRmllbGRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdGaWVsZHMnKTsgICBcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmtleSkge1xuICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmluZm8ua2V5O1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgJiYgdGhpcy5rZXkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5rZXkgPSB0aGlzLmtleVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZmlyZXMgT29sb25nRW50aXR5I2JlZm9yZUFkZGluZ0ludGVyZmFjZXNcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuX2V2ZW50cy5lbWl0KCdiZWZvcmVBZGRpbmdJbnRlcmZhY2VzJyk7ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5pbnRlcmZhY2VzKSkge1xuICAgICAgICAgICAgdGhpcy5pbnRlcmZhY2VzID0gXy5jbG9uZURlZXAodGhpcy5pbmZvLmludGVyZmFjZXMpO1xuXG4gICAgICAgICAgICBfLmZvck93bih0aGlzLmludGVyZmFjZXMsIChpbnRmKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoaW50Zi5hY2NlcHQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGludGYuYWNjZXB0ID0gXy5tYXAoaW50Zi5hY2NlcHQsIHBhcmFtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxpbmtlci50cmFja0JhY2tUeXBlKHRoaXMub29sTW9kdWxlLCBwYXJhbSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEBmaXJlcyBPb2xvbmdFbnRpdHkjYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ldmVudHMuZW1pdCgnYWZ0ZXJBZGRpbmdJbnRlcmZhY2VzJyk7ICAgICAgICBcblxuICAgICAgICB0aGlzLmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhbiBpbmRleCBvbiB0aGUgZ2l2ZW4gZmllbGRzXG4gICAgICogQHBhcmFtIHthcnJheX0gZmllbGRzXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzSW5kZXhPbihmaWVsZHMpIHtcbiAgICAgICAgZmllbGRzID0gZmllbGRzLmNvbmNhdCgpO1xuICAgICAgICBmaWVsZHMuc29ydCgpO1xuXG4gICAgICAgIHJldHVybiBfLmZpbmRJbmRleCh0aGlzLmluZGV4ZXMsIGluZGV4ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gXy5maW5kSW5kZXgoaW5kZXguZmllbGRzLCAoZiwgaWR4KSA9PiAoZmllbGRzLmxlbmd0aCA8PSBpZHggfHwgZmllbGRzW2lkeF0gIT09IGYpKSA9PT0gLTE7XG4gICAgICAgICAgICB9KSAhPSAtMTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYWxsIGluZGV4ZXNcbiAgICAgKi9cbiAgICBhZGRJbmRleGVzKCkge1xuICAgICAgICBpZiAodGhpcy5pbmZvLmluZGV4ZXMpIHtcbiAgICAgICAgICAgIF8uZWFjaCh0aGlzLmluZm8uaW5kZXhlcywgaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkSW5kZXgoaW5kZXgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gaW5kZXhcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW5kZXhcbiAgICAgKiBAcHJvcGVydHkge2FycmF5fSBpbmRleC5maWVsZHMgLSBGaWVsZHMgb2YgdGhlIGluZGV4XG4gICAgICogQHByb3BlcnR5IHtib29sfSBpbmRleC51bmlxdWUgLSBGbGFnIG9mIHVuaXF1ZW5lc3Mgb2YgdGhlIGluZGV4XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRJbmRleChpbmRleCkge1xuICAgICAgICBpZiAoIXRoaXMuaW5kZXhlcykge1xuICAgICAgICAgICAgdGhpcy5pbmRleGVzID0gW107XG4gICAgICAgIH1cblxuICAgICAgICBpbmRleCA9IF8uY2xvbmVEZWVwKGluZGV4KTtcblxuICAgICAgICBhc3NlcnQ6IGluZGV4LmZpZWxkcztcblxuICAgICAgICBpZiAoIV8uaXNBcnJheShpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICBpbmRleC5maWVsZHMgPSBbIGluZGV4LmZpZWxkcyBdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZpZWxkcyA9IGluZGV4LmZpZWxkczsgXG5cbiAgICAgICAgaW5kZXguZmllbGRzID0gXy5tYXAoZmllbGRzLCBmaWVsZCA9PiB7XG5cbiAgICAgICAgICAgIGxldCBub3JtYWxpemVkRmllbGQgPSBfLmNhbWVsQ2FzZShmaWVsZCk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNGaWVsZChub3JtYWxpemVkRmllbGQpKSB7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IHJlZmVyZW5jZXMgbm9uLWV4aXN0IGZpZWxkOiAke2ZpZWxkfSwgZW50aXR5OiAke3RoaXMubmFtZX0uYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBub3JtYWxpemVkRmllbGQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGluZGV4LmZpZWxkcy5zb3J0KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaGFzSW5kZXhPbihpbmRleC5maWVsZHMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEluZGV4IG9uIFske2luZGV4LmZpZWxkcy5qb2luKCcsICcpfV0gYWxyZWFkeSBleGlzdCBpbiBlbnRpdHkgWyR7dGhpcy5uYW1lfV0uYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmluZGV4ZXMucHVzaChpbmRleCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgZmllbGQgb2JqZWN0IGJ5IGZpZWxkIG5hbWUgb3IgZmllbGQgYWNjZXNvci5cbiAgICAgKiBAcGFyYW0gZmllbGRJZFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdGaWVsZH1cbiAgICAgKi9cbiAgICBnZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGRJZCkge1xuICAgICAgICBpZiAoZmllbGRJZFswXSA9PT0gJyQnKSB7XG4gICAgICAgICAgICBsZXQgdG9rZW4gPSBmaWVsZElkLnN1YnN0cigxKTtcblxuICAgICAgICAgICAgc3dpdGNoICh0b2tlbikge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJrZXlcIjpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW3RoaXMua2V5XTtcblxuICAgICAgICAgICAgICAgIGNhc2UgJ2ZlYXR1cmUnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcztcblxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZWQgYWNjZXNzb3IgXCIke3Rva2VufVwiIG5vdCBzdXBwb3J0ZWQhYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaGFzRmllbGQoZmllbGRJZCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpZWxkIFwiJHtmaWVsZElkfVwiIG5vdCBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuYClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmllbGRzW2ZpZWxkSWRdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciB0aGUgZW50aXR5IGhhcyBhIGZpZWxkIHdpdGggZ2l2ZW4gbmFtZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzRmllbGQobmFtZSkge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIF8uZXZlcnkobmFtZSwgZm4gPT4gdGhpcy5oYXNGaWVsZChmbikpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5maWVsZHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGFzc29jaWF0aW9uLCBkYm1zLXNwZWNpZmljXG4gICAgICogQHBhcmFtIHsqfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7Kn0gcHJvcHMgXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBlLmcuIG15c3FsXG4gICAgICogIGVudGl0eSAtIEFzc29jaWF0ZWQgZW50aXR5IG5hbWVcbiAgICAgKiAgam9pbiAtIEpvaW4gdHlwZSwgZS5nLiBJTk5FUiwgTEVGVCwgUklHSFQsIE9VVEVSXG4gICAgICogIGV4Y2x1ZGUgLSBFeGNsdWRlIGluIG91dHB1dCBjb2x1bW5zXG4gICAgICogIGFsaWFzIC0gQWxpYXMgXG4gICAgICogIG9uIC0gT24gY29uZGl0aW9uc1xuICAgICAqICBkYXRhc2V0IC0gU3ViIHF1ZXJ5XG4gICAgICogIGFzc29jcyAtIENoaWxkIGFzc29jaWF0aW9uc1xuICAgICAqICBvcHRpb25hbCAtIE9wdGlvbmFsXG4gICAgICogICdkZWZhdWx0JyAtIERlZmF1bHQgdmFsdWVcbiAgICAgKiAgbGlzdCAtIElzIGEgbGlzdFxuICAgICAqL1xuICAgIGFkZEFzc29jaWF0aW9uKG5hbWUsIHByb3BzKSB7XG4gICAgICAgIGlmICghdGhpcy5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0ge307XG4gICAgICAgIH0gICAgXG5cbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5hc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQXNzb2NpYXRpb24gXCIke25hbWV9XCIgYWxyZWFkeSBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuIFByb3BzOiBgICsgSlNPTi5zdHJpbmdpZnkocHJvcHMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYXNzb2NpYXRpb25zW25hbWVdID0gcHJvcHM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgYXNzb2NpYXRpb24gZmllbGQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZGVzdEVudGl0eVxuICAgICAqIEBwYXJhbSB7T29sb25nRmllbGR9IGRlc3RGaWVsZFxuICAgICAqL1xuICAgIGFkZEFzc29jRmllbGQobmFtZSwgZGVzdEVudGl0eSwgZGVzdEZpZWxkLCBleHRyYVByb3BzKSB7XG4gICAgICAgIGxldCBsb2NhbEZpZWxkID0gdGhpcy5maWVsZHNbbmFtZV07XG5cbiAgICAgICAgaWYgKGxvY2FsRmllbGQpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgXCIke25hbWV9XCIgYWxyZWFkeSBleGlzdHMgaW4gZW50aXR5IFwiJHt0aGlzLm5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGVzdEZpZWxkSW5mbyA9IF8ub21pdChkZXN0RmllbGQudG9KU09OKCksIEZ1bmN0aW9uYWxRdWFsaWZpZXJzKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihkZXN0RmllbGRJbmZvLCBleHRyYVByb3BzKTsgICAgICAgIFxuXG4gICAgICAgIHRoaXMuYWRkRmllbGQobmFtZSwgZGVzdEZpZWxkSW5mbyk7ICAgIFxuICAgICAgICAvL3RoaXMuZmllbGRzW25hbWVdLmRpc3BsYXlOYW1lID0gZmllbGROYW1pbmcocHJlZml4TmFtaW5nKGRlc3RFbnRpdHkubmFtZSwgZGVzdEZpZWxkLm5hbWUpKTsgICBcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBmaWVsZCBpbnRvIHRoZSBlbnRpdHlcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByYXdJbmZvXG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBhZGRGaWVsZChuYW1lLCByYXdJbmZvKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMuaGFzRmllbGQobmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmllbGQgbmFtZSBbJHtuYW1lfV0gY29uZmxpY3RzIGluIGVudGl0eSBbJHt0aGlzLm5hbWV9XS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzc2VydDogcmF3SW5mby50eXBlO1xuXG4gICAgICAgIGxldCBmaWVsZDtcblxuICAgICAgICBpZiAocmF3SW5mbyBpbnN0YW5jZW9mIEZpZWxkKSB7XG4gICAgICAgICAgICBmaWVsZCA9IHJhd0luZm8uY2xvbmUoKTtcbiAgICAgICAgICAgIGZpZWxkLm5hbWUgPSBuYW1lOyAvLyB0b2RvOiBkaXNwbGF5TmFtZVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGZ1bGxSYXdJbmZvID0gdGhpcy5saW5rZXIudHJhY2tCYWNrVHlwZSh0aGlzLm9vbE1vZHVsZSwgcmF3SW5mbyk7XG5cbiAgICAgICAgICAgIGZpZWxkID0gbmV3IEZpZWxkKG5hbWUsIGZ1bGxSYXdJbmZvKTtcbiAgICAgICAgICAgIGZpZWxkLmxpbmsoKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZmllbGRzW25hbWVdID0gZmllbGQ7XG5cbiAgICAgICAgaWYgKCF0aGlzLmtleSkge1xuICAgICAgICAgICAgLy9tYWtlIHRoZSBmaXJzdCBmaWVsZCBhcyB0aGUgZGVmYXVsdCBrZXlcbiAgICAgICAgICAgIHRoaXMua2V5ID0gbmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIGZlYXR1cmUgaW50byB0aGUgZW50aXR5LCBlLmcuIGF1dG8gaW5jcmVtZW50IGlkXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0geyp9IGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge2Jvb2x9IFthbGxvd011bHRpcGxlPWZhbHNlXSAtIEFsbG93IG11bHRpcGxlIG9jY3VycmVuY2VcbiAgICAgKiBAcmV0dXJucyB7RW50aXR5fVxuICAgICAqL1xuICAgIGFkZEZlYXR1cmUobmFtZSwgZmVhdHVyZSwgYWxsb3dNdWx0aXBsZSkge1xuICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXMpIHtcbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChhbGxvd011bHRpcGxlKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZmVhdHVyZXNbbmFtZV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0ucHVzaChmZWF0dXJlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChmZWF0dXJlLm5hbWUgaW4gdGhpcy5mZWF0dXJlcykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRHVwbGljYXRlIGZlYXR1cmUgZm91bmQ6ICR7bmFtZX0uIFR1cm4gb24gYWxsb3dNdWx0aXBsZSB0byBlbmFibGUgbXVsdGlwbGUgb2NjdXJyZW5jZSBvZiBhIGZlYXR1cmUuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZmVhdHVyZXNbbmFtZV0gPSBmZWF0dXJlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IGtleSBuYW1lXG4gICAgICogQHBhcmFtIHtzdHJpbmd8YXJyYXkuPHN0cmluZz59IG5hbWUgLSBGaWVsZCBuYW1lIHRvIGJlIHVzZWQgYXMgdGhlIGtleVxuICAgICAqIEByZXR1cm5zIHtFbnRpdHl9XG4gICAgICovXG4gICAgc2V0S2V5KG5hbWUpIHtcbiAgICAgICAgdGhpcy5rZXkgPSBuYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBhc3NvY2lhdGlvbiBpbmZvIGlmIHRoZXJlIGlzIGNvbm5lY3Rpb24gdG8gdGhlIGdpdmVuIGRlc3RpbmF0aW9uIGVudGl0eS5cbiAgICAgKi9cbiAgICBnZXRSZWZlcmVuY2VUbyhlbnRpdHlOYW1lLCBpbmNsdWRlcywgZXhjbHVkZXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5mby5hc3NvY2lhdGlvbnMgJiYgXy5maW5kKFxuICAgICAgICAgICAgdGhpcy5pbmZvLmFzc29jaWF0aW9ucywgYXNzb2MgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXy5maW5kKGluY2x1ZGVzLCAodmFsdWUsIHByb3ApID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/ICF2YWx1ZShhc3NvY1twcm9wXSkgOiAhXy5pc0VxdWFsKGFzc29jW3Byb3BdLCB2YWx1ZSkpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy5hc3NvY2lhdGlvbiAmJiBhc3NvYyA9PT0gZXhjbHVkZXMuYXNzb2NpYXRpb24pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnR5cGUgJiYgYXNzb2MudHlwZSA9PT0gZXhjbHVkZXMudHlwZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhjbHVkZXMuYXNzb2NpYXRpb25zICYmIGV4Y2x1ZGVzLmFzc29jaWF0aW9ucy5pbmRleE9mKGFzc29jKSA+IC0xKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleGNsdWRlcy50eXBlcyAmJiBleGNsdWRlcy50eXBlcy5pbmRleE9mKGFzc29jLnR5cGUpID4gLTEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGVzLnByb3BzICYmIF8uZmluZChleGNsdWRlcy5wcm9wcywgcHJvcCA9PiBhc3NvY1twcm9wXSkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzb2MuZGVzdEVudGl0eSA9PT0gZW50aXR5TmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQga2V5IGZpZWxkIFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGdldEtleUZpZWxkKCkge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGlzLmtleSkgPyB0aGlzLmtleS5tYXAoa2YgPT4gdGhpcy5maWVsZHNba2ZdKSA6IHRoaXMuZmllbGRzW3RoaXMua2V5XTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9uZSB0aGUgZW50aXR5XG4gICAgICogQHBhcmFtIHtNYXB9IFtzdGFja10gLSBSZWZlcmVuY2Ugc3RhY2sgdG8gYXZvaWQgcmVjdXJyZW5jZSBjb3B5XG4gICAgICogQHJldHVybnMge0VudGl0eX1cbiAgICAgKi9cbiAgICBjbG9uZSgpIHsgICAgICAgIFxuICAgICAgICBzdXBlci5jbG9uZSgpO1xuXG4gICAgICAgIGxldCBlbnRpdHkgPSBuZXcgRW50aXR5KHRoaXMubGlua2VyLCB0aGlzLm5hbWUsIHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8pOyAgICAgICAgXG5cbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnZGlzcGxheU5hbWUnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQodGhpcywgZW50aXR5LCAnY29tbWVudCcpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmZWF0dXJlcycpO1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdmaWVsZHMnKTsgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2Fzc29jaWF0aW9ucycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIGVudGl0eSwgJ2luZGV4ZXMnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBlbnRpdHksICdpbnRlcmZhY2VzJyk7XG5cbiAgICAgICAgZW50aXR5LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG4gXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIHRoZSBlbnRpdHkgaW50byBhIHBsYWluIEpTT04gb2JqZWN0XG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBkaXNwbGF5TmFtZTogdGhpcy5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRoaXMuY29tbWVudCwgICAgICAgICAgICBcbiAgICAgICAgICAgIGZlYXR1cmVzOiB0aGlzLmZlYXR1cmVzLCAgICAgICAgICAgIFxuICAgICAgICAgICAgZmllbGRzOiBfLm1hcFZhbHVlcyh0aGlzLmZpZWxkcywgZmllbGQgPT4gZmllbGQudG9KU09OKCkpLFxuICAgICAgICAgICAgYXNzb2NpYXRpb25zOiB0aGlzLmFzc29jaWF0aW9ucyxcbiAgICAgICAgICAgIGtleTogdGhpcy5rZXksXG4gICAgICAgICAgICBpbmRleGVzOiB0aGlzLmluZGV4ZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfaW5oZXJpdChiYXNlRW50aXR5KSB7ICAgICAgICBcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2ZlYXR1cmVzJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKGJhc2VFbnRpdHksIHRoaXMsICdmaWVsZHMnKTtcbiAgICAgICAgZGVlcENsb25lRmllbGQoYmFzZUVudGl0eSwgdGhpcywgJ2tleScpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKGJhc2VFbnRpdHksIHRoaXMsICdpbmRleGVzJyk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVudGl0eTsiXX0=