"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  deepCloneField,
  Clonable,
  isDotSeparateName
} = require('./OolUtils');

class Dataset extends Clonable {
  constructor(linker, name, oolModule, info) {
    this.linker = linker;
    this.name = _.camelCase(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    if (this.info.entity) {
      let entity = this.linker.getReferencedEntity(this.oolModule, this.info.entity);
      this.mainEntity = entity.name;
    } else {
      let dataset = this.linker.loadDataset(this.oolModule, this.info.dataset);

      if (!dataset.linked) {
        throw new Error("Assertion failed: dataset.linked");
      }

      this.mainEntity = dataset.mainEntity;
      this.joinWith = _.cloneDeep(dataset.joinWith);
    }

    if (!_.isEmpty(this.info.joinWith)) {
      if (!this.joinWith) {
        this.joinWith = _.cloneDeep(this.info.joinWith);
      } else {
        this.joinWith = this.joinWith.concat(this.info.joinWith);
      }
    }

    this.linked = true;
    return this;
  }

  buildHierarchy(inSchema) {
    return this._flattenDataset(inSchema, this);
  }

  _flattenDataset(inSchema, dataset) {
    let hierarchy = {};
    let leftEntity = inSchema.entities[dataset.mainEntity];

    if (dataset.joinWith) {
      dataset.joinWith.forEach(joining => {
        let leftField, rightEntity, rightField;

        if (isDotSeparateName(joining.on.left)) {
          let lastPos = joining.on.left.lastIndexOf('.');
          let fieldRef = joining.on.left.substr(lastPos + 1);
          let entityRef = joining.on.left.substr(0, lastPos);

          if (entityRef === leftEntity.name) {
            leftField = leftEntity.getEntityAttribute(fieldRef);
          } else {
            throw new Error(`Unsupported syntax of left side joining field "${joining.on.left}".`);
          }
        } else {
          leftField = leftEntity.getEntityAttribute(joining.on.left);
        }

        if (joining.dataset) {
          let rightHierarchy = inSchema.getDocumentHierachy(this.oolModule, joining.dataset);

          if (isDotSeparateName(joining.on.right)) {
            let parts = joining.on.right.split('.');

            if (parts.length > 2) {
              throw new Error('Joining a document should only referencing to a field of its main entity.');
            }

            let [entityRef, fieldRef] = parts;

            if (entityRef !== rightHierarchy.entity) {
              throw new Error(`Referenced field "${joining.on.right}" not found while linking to document "${joining.dataset}".`);
            }

            if (!!hierarchy[leftField.name]) {
              throw new Error('Duplicate joinings on the same field of the left side entity.');
            }

            rightEntity = inSchema.entities[entityRef];
            rightField = rightEntity.getEntityAttribute(fieldRef);
            hierarchy[leftField.name] = Object.assign({}, rightHierarchy, {
              linkWithField: rightField.name
            });
            return;
          }

          rightEntity = inSchema.entities[joining.dataset.mainEntity];
        } else {
          rightEntity = inSchema.entities[joining.entity];

          if (isDotSeparateName(joining.on.right)) {
            throw new Error(`Referenced field "${joining.on.right}" not found while linking to entity "${joining.entity}".`);
          }
        }

        rightField = rightEntity.getEntityAttribute(joining.on.right);

        if (!!hierarchy[leftField.name]) {
          throw new Error('Duplicate joinings on the same field of the left side entity.');
        }

        hierarchy[leftField.name] = {
          oolType: 'DocumentHierarchyNode',
          entity: rightEntity.name,
          linkWithField: rightField.name
        };
      });
    }

    return {
      oolType: 'DocumentHierarchyNode',
      entity: leftEntity.name,
      subDocuments: hierarchy
    };
  }

  clone() {
    super.clone();
    let dataset = new Dataset(this.linker, this.name, this.oolModule, this.info);
    dataset.mainEntity = this.mainEntity;
    deepCloneField(this, dataset, 'joinWith');
    dataset.linked = true;
    return dataset;
  }

  toJSON() {
    return {
      name: this.name,
      mainEntity: this.mainEntity.toJSON(),
      joinWith: this.joinWith
    };
  }

}

module.exports = Dataset;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0RhdGFzZXQuanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwiaXNEb3RTZXBhcmF0ZU5hbWUiLCJEYXRhc2V0IiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImNhbWVsQ2FzZSIsImxpbmsiLCJsaW5rZWQiLCJlbnRpdHkiLCJnZXRSZWZlcmVuY2VkRW50aXR5IiwibWFpbkVudGl0eSIsImRhdGFzZXQiLCJsb2FkRGF0YXNldCIsImpvaW5XaXRoIiwiY2xvbmVEZWVwIiwiaXNFbXB0eSIsImNvbmNhdCIsImJ1aWxkSGllcmFyY2h5IiwiaW5TY2hlbWEiLCJfZmxhdHRlbkRhdGFzZXQiLCJoaWVyYXJjaHkiLCJsZWZ0RW50aXR5IiwiZW50aXRpZXMiLCJmb3JFYWNoIiwiam9pbmluZyIsImxlZnRGaWVsZCIsInJpZ2h0RW50aXR5IiwicmlnaHRGaWVsZCIsIm9uIiwibGVmdCIsImxhc3RQb3MiLCJsYXN0SW5kZXhPZiIsImZpZWxkUmVmIiwic3Vic3RyIiwiZW50aXR5UmVmIiwiZ2V0RW50aXR5QXR0cmlidXRlIiwiRXJyb3IiLCJyaWdodEhpZXJhcmNoeSIsImdldERvY3VtZW50SGllcmFjaHkiLCJyaWdodCIsInBhcnRzIiwic3BsaXQiLCJsZW5ndGgiLCJPYmplY3QiLCJhc3NpZ24iLCJsaW5rV2l0aEZpZWxkIiwib29sVHlwZSIsInN1YkRvY3VtZW50cyIsImNsb25lIiwidG9KU09OIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxjQUFGO0FBQWtCQyxFQUFBQSxRQUFsQjtBQUE0QkMsRUFBQUE7QUFBNUIsSUFBa0RILE9BQU8sQ0FBQyxZQUFELENBQS9EOztBQU1B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TSxFQUFFa0IsV0FBVyxDQUFDeEIsSUFGSTtBQUd4QjJDLFVBQUFBLGFBQWEsRUFBRWxCLFVBQVUsQ0FBQ3pCO0FBSEYsU0FBNUI7QUFLSCxPQW5FRDtBQW9FSDs7QUFFRCxXQUFPO0FBQ0g0QyxNQUFBQSxPQUFPLEVBQUUsdUJBRE47QUFFSHRDLE1BQUFBLE1BQU0sRUFBRWEsVUFBVSxDQUFDbkIsSUFGaEI7QUFHSDZDLE1BQUFBLFlBQVksRUFBRTNCO0FBSFgsS0FBUDtBQUtIOztBQU1ENEIsRUFBQUEsS0FBSyxHQUFHO0FBQ0osVUFBTUEsS0FBTjtBQUVBLFFBQUlyQyxPQUFPLEdBQUcsSUFBSVosT0FBSixDQUFZLEtBQUtFLE1BQWpCLEVBQXlCLEtBQUtDLElBQTlCLEVBQW9DLEtBQUtDLFNBQXpDLEVBQW9ELEtBQUtDLElBQXpELENBQWQ7QUFFQU8sSUFBQUEsT0FBTyxDQUFDRCxVQUFSLEdBQXFCLEtBQUtBLFVBQTFCO0FBQ0FkLElBQUFBLGNBQWMsQ0FBQyxJQUFELEVBQU9lLE9BQVAsRUFBZ0IsVUFBaEIsQ0FBZDtBQUVBQSxJQUFBQSxPQUFPLENBQUNKLE1BQVIsR0FBaUIsSUFBakI7QUFFQSxXQUFPSSxPQUFQO0FBQ0g7O0FBT0RzQyxFQUFBQSxNQUFNLEdBQUc7QUFDTCxXQUFPO0FBQ0gvQyxNQUFBQSxJQUFJLEVBQUUsS0FBS0EsSUFEUjtBQUVIUSxNQUFBQSxVQUFVLEVBQUUsS0FBS0EsVUFBTCxDQUFnQnVDLE1BQWhCLEVBRlQ7QUFHSHBDLE1BQUFBLFFBQVEsRUFBRSxLQUFLQTtBQUhaLEtBQVA7QUFLSDs7QUFsTDBCOztBQXFML0JxQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJwRCxPQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IGRlZXBDbG9uZUZpZWxkLCBDbG9uYWJsZSwgaXNEb3RTZXBhcmF0ZU5hbWUgfSA9IHJlcXVpcmUoJy4vT29sVXRpbHMnKTtcblxuLyoqXG4gKiBPb2xvbmcgZGF0YXNldCBjbGFzcy5cbiAqIEBjbGFzcyB7T29sb25nRGF0YXNldH1cbiAqL1xuY2xhc3MgRGF0YXNldCBleHRlbmRzIENsb25hYmxlIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7T29sb25nTGlua2VyfSBsaW5rZXJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIERhdGFzZXQgbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvb2xNb2R1bGUgLSBTb3VyY2Ugb29sIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvIC0gRGF0YXNldCBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBvb2xNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExpbmtlciB0byBwcm9jZXNzIHRoaXMgZG9jdW1lbnRcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBkb2N1bWVudFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm5hbWUgPSBfLmNhbWVsQ2FzZShuYW1lKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogT3duZXIgb29sb25nIG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9vbE1vZHVsZSA9IG9vbE1vZHVsZTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmF3IG1ldGFkYXRhXG4gICAgICAgICAqIEBtZW1iZXIge09iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuaW5mbyA9IGluZm87XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyB0aGlzIGRhdGFzZXRcbiAgICAgKiBAcmV0dXJucyB7T29sb25nRGF0YXNldH1cbiAgICAgKi9cbiAgICBsaW5rKCkge1xuICAgICAgICBwcmU6ICF0aGlzLmxpbmtlZDtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmVudGl0eSkge1xuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmdldFJlZmVyZW5jZWRFbnRpdHkodGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mby5lbnRpdHkpO1xuICAgICAgICAgICAgdGhpcy5tYWluRW50aXR5ID0gZW50aXR5Lm5hbWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgZGF0YXNldCA9IHRoaXMubGlua2VyLmxvYWREYXRhc2V0KHRoaXMub29sTW9kdWxlLCB0aGlzLmluZm8uZGF0YXNldCk7XG4gICAgICAgICAgICBhc3NlcnQ6IGRhdGFzZXQubGlua2VkO1xuXG4gICAgICAgICAgICB0aGlzLm1haW5FbnRpdHkgPSBkYXRhc2V0Lm1haW5FbnRpdHk7XG4gICAgICAgICAgICB0aGlzLmpvaW5XaXRoID0gXy5jbG9uZURlZXAoZGF0YXNldC5qb2luV2l0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby5qb2luV2l0aCkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5qb2luV2l0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuam9pbldpdGggPSBfLmNsb25lRGVlcCh0aGlzLmluZm8uam9pbldpdGgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmpvaW5XaXRoID0gdGhpcy5qb2luV2l0aC5jb25jYXQodGhpcy5pbmZvLmpvaW5XaXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZEhpZXJhcmNoeShpblNjaGVtYSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmxhdHRlbkRhdGFzZXQoaW5TY2hlbWEsIHRoaXMpO1xuICAgIH1cblxuICAgIF9mbGF0dGVuRGF0YXNldChpblNjaGVtYSwgZGF0YXNldCkge1xuICAgICAgICBsZXQgaGllcmFyY2h5ID0ge307XG4gICAgICAgIGxldCBsZWZ0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbZGF0YXNldC5tYWluRW50aXR5XTtcblxuICAgICAgICBpZiAoZGF0YXNldC5qb2luV2l0aCkge1xuICAgICAgICAgICAgZGF0YXNldC5qb2luV2l0aC5mb3JFYWNoKGpvaW5pbmcgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsZWZ0RmllbGQsIHJpZ2h0RW50aXR5LCByaWdodEZpZWxkO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzRG90U2VwYXJhdGVOYW1lKGpvaW5pbmcub24ubGVmdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxhc3RQb3MgPSBqb2luaW5nLm9uLmxlZnQubGFzdEluZGV4T2YoJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpZWxkUmVmID0gam9pbmluZy5vbi5sZWZ0LnN1YnN0cihsYXN0UG9zKzEpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZW50aXR5UmVmID0gam9pbmluZy5vbi5sZWZ0LnN1YnN0cigwLCBsYXN0UG9zKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5UmVmID09PSBsZWZ0RW50aXR5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnRGaWVsZCA9IGxlZnRFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKGZpZWxkUmVmKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgc3ludGF4IG9mIGxlZnQgc2lkZSBqb2luaW5nIGZpZWxkIFwiJHtqb2luaW5nLm9uLmxlZnR9XCIuYCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vZmllbGQgb2YgbGVmdEVudGl0eVxuICAgICAgICAgICAgICAgICAgICBsZWZ0RmllbGQgPSBsZWZ0RW50aXR5LmdldEVudGl0eUF0dHJpYnV0ZShqb2luaW5nLm9uLmxlZnQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChqb2luaW5nLmRhdGFzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJpZ2h0SGllcmFyY2h5ID0gaW5TY2hlbWEuZ2V0RG9jdW1lbnRIaWVyYWNoeSh0aGlzLm9vbE1vZHVsZSwgam9pbmluZy5kYXRhc2V0KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNEb3RTZXBhcmF0ZU5hbWUoam9pbmluZy5vbi5yaWdodCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwYXJ0cyA9IGpvaW5pbmcub24ucmlnaHQuc3BsaXQoJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdKb2luaW5nIGEgZG9jdW1lbnQgc2hvdWxkIG9ubHkgcmVmZXJlbmNpbmcgdG8gYSBmaWVsZCBvZiBpdHMgbWFpbiBlbnRpdHkuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBbIGVudGl0eVJlZiwgZmllbGRSZWYgXSA9IHBhcnRzO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5UmVmICE9PSByaWdodEhpZXJhcmNoeS5lbnRpdHkpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVmZXJlbmNlZCBmaWVsZCBcIiR7am9pbmluZy5vbi5yaWdodH1cIiBub3QgZm91bmQgd2hpbGUgbGlua2luZyB0byBkb2N1bWVudCBcIiR7am9pbmluZy5kYXRhc2V0fVwiLmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQ6ICFoaWVyYXJjaHlbbGVmdEZpZWxkLm5hbWVdLCAnRHVwbGljYXRlIGpvaW5pbmdzIG9uIHRoZSBzYW1lIGZpZWxkIG9mIHRoZSBsZWZ0IHNpZGUgZW50aXR5Lic7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0RW50aXR5ID0gaW5TY2hlbWEuZW50aXRpZXNbZW50aXR5UmVmXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0RmllbGQgPSByaWdodEVudGl0eS5nZXRFbnRpdHlBdHRyaWJ1dGUoZmllbGRSZWYpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHlbbGVmdEZpZWxkLm5hbWVdID0gT2JqZWN0LmFzc2lnbih7fSwgcmlnaHRIaWVyYXJjaHksIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rV2l0aEZpZWxkOiByaWdodEZpZWxkLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvL2pvaW5pbmcub24ucmlnaHQgaXMgZmllbGQgbmFtZSBvZiB0aGUgbWFpbiBlbnRpdHlcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRFbnRpdHkgPSBpblNjaGVtYS5lbnRpdGllc1tqb2luaW5nLmRhdGFzZXQubWFpbkVudGl0eV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRFbnRpdHkgPSBpblNjaGVtYS5lbnRpdGllc1tqb2luaW5nLmVudGl0eV07XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG90U2VwYXJhdGVOYW1lKGpvaW5pbmcub24ucmlnaHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlZmVyZW5jZWQgZmllbGQgXCIke2pvaW5pbmcub24ucmlnaHR9XCIgbm90IGZvdW5kIHdoaWxlIGxpbmtpbmcgdG8gZW50aXR5IFwiJHtqb2luaW5nLmVudGl0eX1cIi5gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vZmllbGQgb2YgcmlnaHRFbnRpdHlcbiAgICAgICAgICAgICAgICByaWdodEZpZWxkID0gcmlnaHRFbnRpdHkuZ2V0RW50aXR5QXR0cmlidXRlKGpvaW5pbmcub24ucmlnaHQpO1xuXG4gICAgICAgICAgICAgICAgYXNzZXJ0OiAhaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSwgJ0R1cGxpY2F0ZSBqb2luaW5ncyBvbiB0aGUgc2FtZSBmaWVsZCBvZiB0aGUgbGVmdCBzaWRlIGVudGl0eS4nO1xuXG4gICAgICAgICAgICAgICAgaGllcmFyY2h5W2xlZnRGaWVsZC5uYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgb29sVHlwZTogJ0RvY3VtZW50SGllcmFyY2h5Tm9kZScsXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eTogcmlnaHRFbnRpdHkubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbGlua1dpdGhGaWVsZDogcmlnaHRGaWVsZC5uYW1lXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG9vbFR5cGU6ICdEb2N1bWVudEhpZXJhcmNoeU5vZGUnLFxuICAgICAgICAgICAgZW50aXR5OiBsZWZ0RW50aXR5Lm5hbWUsXG4gICAgICAgICAgICBzdWJEb2N1bWVudHM6IGhpZXJhcmNoeVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb25lIHRoZSBkb2N1bWVudFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdEYXRhc2V0fVxuICAgICAqL1xuICAgIGNsb25lKCkge1xuICAgICAgICBzdXBlci5jbG9uZSgpO1xuXG4gICAgICAgIGxldCBkYXRhc2V0ID0gbmV3IERhdGFzZXQodGhpcy5saW5rZXIsIHRoaXMubmFtZSwgdGhpcy5vb2xNb2R1bGUsIHRoaXMuaW5mbyk7XG5cbiAgICAgICAgZGF0YXNldC5tYWluRW50aXR5ID0gdGhpcy5tYWluRW50aXR5O1xuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBkYXRhc2V0LCAnam9pbldpdGgnKTtcblxuICAgICAgICBkYXRhc2V0LmxpbmtlZCA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIGRhdGFzZXQ7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgdGhlIGRvY3VtZW50IGludG8gYSBwbGFpbiBKU09OIG9iamVjdFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgdG9KU09OKCkge1xuICAgICAgICByZXR1cm4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgICAgbWFpbkVudGl0eTogdGhpcy5tYWluRW50aXR5LnRvSlNPTigpLFxuICAgICAgICAgICAgam9pbldpdGg6IHRoaXMuam9pbldpdGhcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGF0YXNldDsiXX0=