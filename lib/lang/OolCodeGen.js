"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  generateDisplayName
} = require('./OolUtils');

const {
  isNothing,
  isQuotedWith
} = require('../utils/lang');

const KW_NAMESPACE = 'import';
const KW_SCHEMA = 'schema';
const KW_ENTITIES = 'entities';
const KW_ENTITY_AS_ALIAS = 'as';
const KW_TYPE_DEFINE = 'type';
const KW_ENTITY = 'entity';
const KW_CODE = 'code';
const KW_COMMENT = '--';
const KW_WITH_FEATURE = 'with';
const KW_FIELDS = 'has';
const KW_ASSOCIATIONS = 'associations';
const KW_KEY = 'key';
const KW_INDEXES = 'index';

const Types = require('../runtime/types');

const OolTypes = require('./OolTypes');

class OolCodeGen {
  static transform(json, options) {
    let codeGen = new OolCodeGen(options);
    return codeGen.generate(json);
  }

  constructor(options) {
    this.indented = 0;
    this.content = '';
    this.options = options;
  }

  generate(json) {
    this.generateObject(json);
    return this.content;
  }

  appendLine(line) {
    if (line) {
      if (arguments.length > 1) {
        line = [...arguments].join(' ');
      }

      this.content += (this.indented > 0 ? _.repeat(' ', this.indented) : '') + line + '\n';
    } else {
      this.content += '\n';
    }

    return this;
  }

  indent() {
    this.indented += 2;
    return this;
  }

  dedent() {
    const _checkPostcondition = it => {
      if (!(this.indented >= 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    this.indented -= 2;
    return _checkPostcondition(this);
  }

  generateObject(obj) {
    _.forOwn(obj, (v, k) => {
      let generateMethod = 'generate_' + k;

      if (generateMethod in this) {
        return this[generateMethod](v);
      }

      throw new Error('to be implemented, object: ' + k);
    });
  }

  generate_namespace(namespaces) {
    const _checkPostcondition2 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!Array.isArray(namespaces)) {
      throw new Error('Invalid namespaces.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (namespaces.length > 0) {
      this.appendLine(KW_NAMESPACE).indent();
      namespaces.forEach(ns => {
        this.appendLine(Util.quote(ns, "'"));
      });
      this.dedent().appendLine();
    }

    _checkPostcondition2();
  }

  generate_schema(schema) {
    const _checkPostcondition3 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(schema, (schemaInfo, name) => {
      this.appendLine(KW_SCHEMA, Util.quote(name, "'")).indent();

      if (schemaInfo.entities) {
        this.appendLine(KW_ENTITIES).indent();
        schemaInfo.entities.forEach(entityEntry => {
          if (entityEntry.alias) {
            this.appendLine(entityEntry.entity, KW_ENTITY_AS_ALIAS, entityEntry.alias);
          } else {
            this.appendLine(entityEntry.entity);
          }
        });
        this.dedent().appendLine();
      }

      this.dedent();
    });

    _checkPostcondition3();
  }

  generate_type(types) {
    const _checkPostcondition4 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(types)) {
      throw new Error('Invalid types.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (!_.isEmpty(types)) {
      this.appendLine(KW_TYPE_DEFINE).indent();

      _.forOwn(types, (type, name) => {
        let lineInfo = [name, ':', type.type];

        this._translateType(type, lineInfo);

        this.appendLine(...lineInfo);
      });

      this.dedent().appendLine();
    }

    _checkPostcondition4();
  }

  generate_field_comment(entityName, colName) {
    let colNameFullSnake = _.trimStart(_.snakeCase(colName), '_');

    let [colNameFirstWord, colNameRest] = colNameFullSnake.split('_', 2);
    let result;

    let entityNameFullSnake = _.trim(_.snakeCase(entityName), '_');

    if (_.endsWith(entityNameFullSnake, colNameFirstWord)) {
      result = entityNameFullSnake + '_' + colNameRest;
    } else {
      result = entityNameFullSnake + '_' + colNameFullSnake;
    }

    return generateDisplayName(result);
  }

  generate_entity(entities) {
    const _checkPostcondition5 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(entities)) {
      throw new Error('Invalid entities.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(entities, (entity, enityName) => {
      this.appendLine(KW_ENTITY, enityName).indent();

      if (entity.source) {
        this.appendLine(KW_CODE, Util.quote(entity.source));
      }

      this.appendLine(KW_COMMENT, Util.quote(entity.comment || generateDisplayName(enityName)));
      let hasAutoId = false;

      if (!_.isEmpty(entity.features)) {
        this.appendLine(KW_WITH_FEATURE).indent();
        entity.features.forEach(feature => {
          if (typeof feature === 'string') {
            feature = {
              name: feature
            };
          }

          if (feature.name === 'autoId') {
            hasAutoId = true;
          }

          if (feature.args) {
            this.appendLine(feature.name + '(' + feature.args.map(a => JSON.stringify(a)).join(', ') + ')');
          } else {
            this.appendLine(feature.name);
          }
        });
        this.dedent();
      }

      if (!_.isEmpty(entity.fields)) {
        this.appendLine().appendLine(KW_FIELDS).indent();

        _.forOwn(entity.fields, (field, name) => {
          if (!field.type) {
            throw new Error("Assertion failed: field.type");
          }

          let lineInfo = [];
          lineInfo.push(Types.Builtin.has(name) ? Util.quote(name) : name);

          if (field.type !== name) {
            lineInfo.push(':');
            lineInfo.push(field.type);
          }

          this._translateType(field, lineInfo);

          lineInfo.push(KW_COMMENT + ' ' + Util.quote(field.comment || this.generate_field_comment(enityName, name)));
          this.appendLine(...lineInfo);
        });

        this.dedent();
      }

      if (!_.isEmpty(entity.associations)) {
        this.appendLine().appendLine(KW_ASSOCIATIONS).indent();
        entity.associations.forEach(({
          type,
          from,
          entity,
          through
        }) => {
          if (from) {
            this.appendLine(type, Util.quote(entity, "'"), 'as', Util.quote(from, "'"));
          } else if (through) {
            this.appendLine(type, Util.quote(entity, "'"), 'through', Util.quote(through, "'"));
          } else {
            this.appendLine(type, Util.quote(entity, "'"));
          }
        });
        this.dedent();
      }

      if (entity.key && !hasAutoId) {
        let key = Array.isArray(entity.key) && entity.key.length === 1 ? entity.key[0] : entity.key;

        if (Array.isArray(key)) {
          this.appendLine().appendLine(KW_KEY, '[ ' + key.join(', ') + ' ]');
        } else {
          this.appendLine().appendLine(KW_KEY, key);
        }
      }

      if (!_.isEmpty(entity.indexes)) {
        this.appendLine().appendLine(KW_INDEXES).indent();
        entity.indexes.forEach(i => {
          let indexInfo = [];

          if (Array.isArray(i.fields)) {
            indexInfo.push('[' + i.fields.join(', ') + ']');
          } else {
            indexInfo.push(i.fields);
          }

          if (i.unique) {
            indexInfo.push('is');
            indexInfo.push('unique');
          }

          this.appendLine(...indexInfo);
        });
        this.dedent();
      }

      this.dedent();
    });

    _checkPostcondition5();
  }

  _translateType(field, lineInfo) {
    let extraTypeInfo = _.omit(field, ['type', 'modifiers', 'name']);

    _.forOwn(extraTypeInfo, (v, k) => {
      if (k === 'comment') return;

      if (typeof v === 'boolean' || isNothing(v)) {
        if (v) {
          lineInfo.push(k);
        }
      } else {
        v = _.castArray(v);
        lineInfo.push(k + '(' + this._translateArgs(v) + ')');
      }
    });

    if (field.modifiers) {
      this._translatePipedValue(lineInfo, field);
    }
  }

  _translatePipedValue(lineInfo, value) {
    if (value.modifiers) {
      value.modifiers.forEach(v => {
        switch (v.oolType) {
          case OolTypes.Lang.VALIDATOR:
            lineInfo.push('|~' + this._translateModifier(v));
            break;

          case OolTypes.Lang.PROCESSOR:
            lineInfo.push('|>' + this._translateModifier(v));
            break;

          case OolTypes.Lang.ACTIVATOR:
            lineInfo.push('|=' + this._translateModifier(v));
            break;

          default:
            throw new Error(`Unknown modifier type: "${v.oolType}"!`);
        }
      });
    }
  }

  _translateModifier(f) {
    let r = f.name;

    if (!_.isEmpty(f.args)) {
      r += '(';
      r += this._translateArgs(f.args);
      r += ')';
    }

    return r;
  }

  _translateArgs(args) {
    return args.map(a => this._translateArg(a)).join(', ');
  }

  _translateArg(a) {
    if (_.isPlainObject(a) && a.hasOwnProperty('oolType')) {
      if (a.oolType === 'PipedValue') {
        let pipeline = [this._translateArg(a.value)];

        if (a.modifiers) {
          this._translatePipedValue(pipeline, a);
        }

        return pipeline.join(' ');
      } else if (a.oolType === 'ObjectReference') {
        return '@' + a.name;
      } else {
        throw new Error('Not supported oolType: ' + a.oolType);
      }
    }

    if (typeof a === 'string' && isQuotedWith(a, '/')) return a;
    return JSON.stringify(a);
  }

}

module.exports = OolCodeGen;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbENvZGVHZW4uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZ2VuZXJhdGVEaXNwbGF5TmFtZSIsImlzTm90aGluZyIsImlzUXVvdGVkV2l0aCIsIktXX05BTUVTUEFDRSIsIktXX1NDSEVNQSIsIktXX0VOVElUSUVTIiwiS1dfRU5USVRZX0FTX0FMSUFTIiwiS1dfVFlQRV9ERUZJTkUiLCJLV19FTlRJVFkiLCJLV19DT0RFIiwiS1dfQ09NTUVOVCIsIktXX1dJVEhfRkVBVFVSRSIsIktXX0ZJRUxEUyIsIktXX0FTU09DSUFUSU9OUyIsIktXX0tFWSIsIktXX0lOREVYRVMiLCJUeXBlcyIsIk9vbFR5cGVzIiwiT29sQ29kZUdlbiIsInRyYW5zZm9ybSIsImpzb24iLCJvcHRpb25zIiwiY29kZUdlbiIsImdlbmVyYXRlIiwiY29uc3RydWN0b3IiLCJpbmRlbnRlZCIsImNvbnRlbnQiLCJnZW5lcmF0ZU9iamVjdCIsImFwcGVuZExpbmUiLCJsaW5lIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiam9pbiIsInJlcGVhdCIsImluZGVudCIsImRlZGVudCIsIm9iaiIsImZvck93biIsInYiLCJrIiwiZ2VuZXJhdGVNZXRob2QiLCJFcnJvciIsImdlbmVyYXRlX25hbWVzcGFjZSIsIm5hbWVzcGFjZXMiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwibnMiLCJxdW90ZSIsImdlbmVyYXRlX3NjaGVtYSIsInNjaGVtYSIsInNjaGVtYUluZm8iLCJuYW1lIiwiZW50aXRpZXMiLCJlbnRpdHlFbnRyeSIsImFsaWFzIiwiZW50aXR5IiwiZ2VuZXJhdGVfdHlwZSIsInR5cGVzIiwiaXNQbGFpbk9iamVjdCIsImlzRW1wdHkiLCJ0eXBlIiwibGluZUluZm8iLCJfdHJhbnNsYXRlVHlwZSIsImdlbmVyYXRlX2ZpZWxkX2NvbW1lbnQiLCJlbnRpdHlOYW1lIiwiY29sTmFtZSIsImNvbE5hbWVGdWxsU25ha2UiLCJ0cmltU3RhcnQiLCJzbmFrZUNhc2UiLCJjb2xOYW1lRmlyc3RXb3JkIiwiY29sTmFtZVJlc3QiLCJzcGxpdCIsInJlc3VsdCIsImVudGl0eU5hbWVGdWxsU25ha2UiLCJ0cmltIiwiZW5kc1dpdGgiLCJnZW5lcmF0ZV9lbnRpdHkiLCJlbml0eU5hbWUiLCJzb3VyY2UiLCJjb21tZW50IiwiaGFzQXV0b0lkIiwiZmVhdHVyZXMiLCJmZWF0dXJlIiwiYXJncyIsIm1hcCIsImEiLCJKU09OIiwic3RyaW5naWZ5IiwiZmllbGRzIiwiZmllbGQiLCJwdXNoIiwiQnVpbHRpbiIsImhhcyIsImFzc29jaWF0aW9ucyIsImZyb20iLCJ0aHJvdWdoIiwia2V5IiwiaW5kZXhlcyIsImkiLCJpbmRleEluZm8iLCJ1bmlxdWUiLCJleHRyYVR5cGVJbmZvIiwib21pdCIsImNhc3RBcnJheSIsIl90cmFuc2xhdGVBcmdzIiwibW9kaWZpZXJzIiwiX3RyYW5zbGF0ZVBpcGVkVmFsdWUiLCJ2YWx1ZSIsIm9vbFR5cGUiLCJMYW5nIiwiVkFMSURBVE9SIiwiX3RyYW5zbGF0ZU1vZGlmaWVyIiwiUFJPQ0VTU09SIiwiQUNUSVZBVE9SIiwiZiIsInIiLCJfdHJhbnNsYXRlQXJnIiwiaGFzT3duUHJvcGVydHkiLCJwaXBlbGluZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUYsSUFBZDs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBMEJGLE9BQU8sQ0FBQyxZQUFELENBQXZDOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsU0FBRjtBQUFhQyxFQUFBQTtBQUFiLElBQThCSixPQUFPLENBQUMsZUFBRCxDQUEzQzs7QUFFQSxNQUFNSyxZQUFZLEdBQUcsUUFBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsUUFBbEI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsVUFBcEI7QUFDQSxNQUFN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QXJDLENBQTBDLElBQTFDLENBQVA7QUFDSDs7QUFFRHFGLEVBQUFBLGFBQWEsQ0FBQy9CLENBQUQsRUFBSTtBQUNiLFFBQUl2RixDQUFDLENBQUM0RCxhQUFGLENBQWdCMkIsQ0FBaEIsS0FBc0JBLENBQUMsQ0FBQ2dDLGNBQUYsQ0FBaUIsU0FBakIsQ0FBMUIsRUFBdUQ7QUFDbkQsVUFBSWhDLENBQUMsQ0FBQ3VCLE9BQUYsS0FBYyxZQUFsQixFQUFnQztBQUM1QixZQUFJVSxRQUFRLEdBQUcsQ0FBRSxLQUFLRixhQUFMLENBQW1CL0IsQ0FBQyxDQUFDc0IsS0FBckIsQ0FBRixDQUFmOztBQUVBLFlBQUl0QixDQUFDLENBQUNvQixTQUFOLEVBQWlCO0FBQ2IsZUFBS0Msb0JBQUwsQ0FBMEJZLFFBQTFCLEVBQW9DakMsQ0FBcEM7QUFDSDs7QUFFRCxlQUFPaUMsUUFBUSxDQUFDdkYsSUFBVCxDQUFjLEdBQWQsQ0FBUDtBQUNILE9BUkQsTUFRTyxJQUFJc0QsQ0FBQyxDQUFDdUIsT0FBRixLQUFjLGlCQUFsQixFQUFxQztBQUN4QyxlQUFPLE1BQU12QixDQUFDLENBQUNsQyxJQUFmO0FBQ0gsT0FGTSxNQUVBO0FBQ0gsY0FBTSxJQUFJWCxLQUFKLENBQVUsNEJBQTRCNkMsQ0FBQyxDQUFDdUIsT0FBeEMsQ0FBTjtBQUNIO0FBQ0o7O0FBRUQsUUFBSSxPQUFPdkIsQ0FBUCxLQUFhLFFBQWIsSUFBeUJwRixZQUFZLENBQUNvRixDQUFELEVBQUksR0FBSixDQUF6QyxFQUFtRCxPQUFPQSxDQUFQO0FBRW5ELFdBQU9DLElBQUksQ0FBQ0MsU0FBTCxDQUFlRixDQUFmLENBQVA7QUFDSDs7QUF2Vlk7O0FBMFZqQmtDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZHLFVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBfIH0gPSBVdGlsO1xuY29uc3QgeyBnZW5lcmF0ZURpc3BsYXlOYW1lIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5jb25zdCB7IGlzTm90aGluZywgaXNRdW90ZWRXaXRoIH0gPSByZXF1aXJlKCcuLi91dGlscy9sYW5nJyk7XG5cbmNvbnN0IEtXX05BTUVTUEFDRSA9ICdpbXBvcnQnO1xuY29uc3QgS1dfU0NIRU1BID0gJ3NjaGVtYSc7XG5jb25zdCBLV19FTlRJVElFUyA9ICdlbnRpdGllcyc7XG5jb25zdCBLV19FTlRJVFlfQVNfQUxJQVMgPSAnYXMnO1xuY29uc3QgS1dfVFlQRV9ERUZJTkUgPSAndHlwZSc7XG5jb25zdCBLV19FTlRJVFkgPSAnZW50aXR5JztcbmNvbnN0IEtXX0NPREUgPSAnY29kZSc7XG5jb25zdCBLV19DT01NRU5UID0gJy0tJztcbmNvbnN0IEtXX1dJVEhfRkVBVFVSRSA9ICd3aXRoJztcbmNvbnN0IEtXX0ZJRUxEUyA9ICdoYXMnO1xuY29uc3QgS1dfQVNTT0NJQVRJT05TID0gJ2Fzc29jaWF0aW9ucyc7XG5jb25zdCBLV19LRVkgPSAna2V5JztcbmNvbnN0IEtXX0lOREVYRVMgPSAnaW5kZXgnO1xuXG5jb25zdCBUeXBlcyA9IHJlcXVpcmUoJy4uL3J1bnRpbWUvdHlwZXMnKTtcbmNvbnN0IE9vbFR5cGVzID0gcmVxdWlyZSgnLi9Pb2xUeXBlcycpO1xuXG5jbGFzcyBPb2xDb2RlR2VuIHtcbiAgICBzdGF0aWMgdHJhbnNmb3JtKGpzb24sIG9wdGlvbnMpIHtcbiAgICAgICAgbGV0IGNvZGVHZW4gPSBuZXcgT29sQ29kZUdlbihvcHRpb25zKTtcbiAgICAgICAgcmV0dXJuIGNvZGVHZW4uZ2VuZXJhdGUoanNvbik7XG4gICAgfVxuXG4gICAgaW5kZW50ZWQgPSAwO1xuICAgIGNvbnRlbnQgPSAnJztcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZShqc29uKSB7XG4gICAgICAgIHRoaXMuZ2VuZXJhdGVPYmplY3QoanNvbik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudDtcbiAgICB9XG5cbiAgICBhcHBlbmRMaW5lKGxpbmUpIHtcbiAgICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGxpbmUgPSBbIC4uLmFyZ3VtZW50c10uam9pbignICcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgKz0gKHRoaXMuaW5kZW50ZWQgPiAwID8gXy5yZXBlYXQoJyAnLCB0aGlzLmluZGVudGVkKSA6ICcnKSArIGxpbmUgKyAnXFxuJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudCArPSAnXFxuJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBpbmRlbnQoKSB7XG4gICAgICAgIHRoaXMuaW5kZW50ZWQgKz0gMjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZGVkZW50KCkge1xuICAgICAgICB0aGlzLmluZGVudGVkIC09IDI7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID49IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVPYmplY3Qob2JqKSB7XG4gICAgICAgIF8uZm9yT3duKG9iaiwgKHYsaykgPT4ge1xuICAgICAgICAgICAgbGV0IGdlbmVyYXRlTWV0aG9kID0gJ2dlbmVyYXRlXycgKyBrO1xuXG4gICAgICAgICAgICBpZiAoZ2VuZXJhdGVNZXRob2QgaW4gdGhpcykge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2dlbmVyYXRlTWV0aG9kXSh2KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0byBiZSBpbXBsZW1lbnRlZCwgb2JqZWN0OiAnICsgayk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX25hbWVzcGFjZShuYW1lc3BhY2VzKSB7XG4gICAgICAgIHByZToge1xuICAgICAgICAgICAgQXJyYXkuaXNBcnJheShuYW1lc3BhY2VzKSwgJ0ludmFsaWQgbmFtZXNwYWNlcy4nO1xuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5hbWVzcGFjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX05BTUVTUEFDRSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIG5hbWVzcGFjZXMuZm9yRWFjaChucyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKFV0aWwucXVvdGUobnMsIFwiJ1wiKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKS5hcHBlbmRMaW5lKCk7XG4gICAgICAgIH1cblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfc2NoZW1hKHNjaGVtYSkge1xuICAgICAgICBwcmU6IHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKHNjaGVtYSwgKHNjaGVtYUluZm8sIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19TQ0hFTUEsIFV0aWwucXVvdGUobmFtZSwgXCInXCIpKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgaWYgKHNjaGVtYUluZm8uZW50aXRpZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfRU5USVRJRVMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgc2NoZW1hSW5mby5lbnRpdGllcy5mb3JFYWNoKGVudGl0eUVudHJ5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eUVudHJ5LmFsaWFzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoZW50aXR5RW50cnkuZW50aXR5LCBLV19FTlRJVFlfQVNfQUxJQVMsIGVudGl0eUVudHJ5LmFsaWFzKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShlbnRpdHlFbnRyeS5lbnRpdHkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRlZGVudCgpLmFwcGVuZExpbmUoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICBwb3N0OiB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfdHlwZSh0eXBlcykge1xuICAgICAgICBwcmU6IHtcbiAgICAgICAgICAgIF8uaXNQbGFpbk9iamVjdCh0eXBlcyksICdJbnZhbGlkIHR5cGVzLic7XG4gICAgICAgICAgICB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIV8uaXNFbXB0eSh0eXBlcykpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19UWVBFX0RFRklORSkuaW5kZW50KCk7XG5cbiAgICAgICAgICAgIF8uZm9yT3duKHR5cGVzLCAodHlwZSwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsaW5lSW5mbyA9IFsgbmFtZSwgJzonLCB0eXBlLnR5cGUgXTtcblxuICAgICAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVR5cGUodHlwZSwgbGluZUluZm8pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKC4uLmxpbmVJbmZvKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmRlZGVudCgpLmFwcGVuZExpbmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9maWVsZF9jb21tZW50KGVudGl0eU5hbWUsIGNvbE5hbWUpIHtcbiAgICAgICAgbGV0IGNvbE5hbWVGdWxsU25ha2UgPSBfLnRyaW1TdGFydChfLnNuYWtlQ2FzZShjb2xOYW1lKSwgJ18nKTtcbiAgICAgICAgbGV0ICBbIGNvbE5hbWVGaXJzdFdvcmQsIGNvbE5hbWVSZXN0IF0gPSBjb2xOYW1lRnVsbFNuYWtlLnNwbGl0KCdfJywgMik7XG5cbiAgICAgICAgbGV0IHJlc3VsdDtcblxuICAgICAgICBsZXQgZW50aXR5TmFtZUZ1bGxTbmFrZSA9IF8udHJpbShfLnNuYWtlQ2FzZShlbnRpdHlOYW1lKSwgJ18nKTtcbiAgICAgICAgaWYgKF8uZW5kc1dpdGgoZW50aXR5TmFtZUZ1bGxTbmFrZSwgY29sTmFtZUZpcnN0V29yZCkpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGVudGl0eU5hbWVGdWxsU25ha2UgKyAnXycgKyBjb2xOYW1lUmVzdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGVudGl0eU5hbWVGdWxsU25ha2UgKyAnXycgKyBjb2xOYW1lRnVsbFNuYWtlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGdlbmVyYXRlRGlzcGxheU5hbWUocmVzdWx0KTtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9lbnRpdHkoZW50aXRpZXMpIHtcbiAgICAgICAgcHJlOiB7XG4gICAgICAgICAgICBfLmlzUGxhaW5PYmplY3QoZW50aXRpZXMpLCAnSW52YWxpZCBlbnRpdGllcy4nO1xuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgXy5mb3JPd24oZW50aXRpZXMsIChlbnRpdHksIGVuaXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX0VOVElUWSwgZW5pdHlOYW1lKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgaWYgKGVudGl0eS5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfQ09ERSwgVXRpbC5xdW90ZShlbnRpdHkuc291cmNlKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19DT01NRU5ULCBVdGlsLnF1b3RlKGVudGl0eS5jb21tZW50IHx8IGdlbmVyYXRlRGlzcGxheU5hbWUoZW5pdHlOYW1lKSkpO1xuXG4gICAgICAgICAgICBsZXQgaGFzQXV0b0lkID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5mZWF0dXJlcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfV0lUSF9GRUFUVVJFKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIGVudGl0eS5mZWF0dXJlcy5mb3JFYWNoKGZlYXR1cmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZlYXR1cmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlID0geyBuYW1lOiBmZWF0dXJlIH07XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoZmVhdHVyZS5uYW1lID09PSAnYXV0b0lkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGFzQXV0b0lkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmZWF0dXJlLmFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShmZWF0dXJlLm5hbWUgKyAnKCcgKyBmZWF0dXJlLmFyZ3MubWFwKGEgPT4gSlNPTi5zdHJpbmdpZnkoYSkpLmpvaW4oJywgJykgKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKGZlYXR1cmUubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19GSUVMRFMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgXy5mb3JPd24oZW50aXR5LmZpZWxkcywgKGZpZWxkLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFzc2VydDogZmllbGQudHlwZTsgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBsaW5lSW5mbyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKFR5cGVzLkJ1aWx0aW4uaGFzKG5hbWUpID8gVXRpbC5xdW90ZShuYW1lKSA6IG5hbWUpOyAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQudHlwZSAhPT0gbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaCgnOicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChmaWVsZC50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVR5cGUoZmllbGQsIGxpbmVJbmZvKTtcblxuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKEtXX0NPTU1FTlQgKyAnICcgKyBVdGlsLnF1b3RlKGZpZWxkLmNvbW1lbnQgfHwgdGhpcy5nZW5lcmF0ZV9maWVsZF9jb21tZW50KGVuaXR5TmFtZSwgbmFtZSkpKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoLi4ubGluZUluZm8pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmFzc29jaWF0aW9ucykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0FTU09DSUFUSU9OUykuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBlbnRpdHkuYXNzb2NpYXRpb25zLmZvckVhY2goKHsgdHlwZSwgZnJvbSwgZW50aXR5LCB0aHJvdWdoIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZyb20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSh0eXBlLCBVdGlsLnF1b3RlKGVudGl0eSwgXCInXCIpLCAnYXMnLCBVdGlsLnF1b3RlKGZyb20sIFwiJ1wiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhyb3VnaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKHR5cGUsIFV0aWwucXVvdGUoZW50aXR5LCBcIidcIiksICd0aHJvdWdoJywgVXRpbC5xdW90ZSh0aHJvdWdoLCBcIidcIikpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKHR5cGUsIFV0aWwucXVvdGUoZW50aXR5LCBcIidcIikpO1xuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChlbnRpdHkua2V5ICYmICFoYXNBdXRvSWQpIHtcbiAgICAgICAgICAgICAgICBsZXQga2V5ID0gKEFycmF5LmlzQXJyYXkoZW50aXR5LmtleSkgJiYgZW50aXR5LmtleS5sZW5ndGggPT09IDEpID8gZW50aXR5LmtleVswXSA6IGVudGl0eS5rZXk7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0tFWSwgJ1sgJyArIGtleS5qb2luKCcsICcpICsgJyBdJyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19LRVksIGtleSk7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmluZGV4ZXMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19JTkRFWEVTKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgICAgIGVudGl0eS5pbmRleGVzLmZvckVhY2goaSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBpbmRleEluZm8gPSBbXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKCdbJyArIGkuZmllbGRzLmpvaW4oJywgJykgKyAnXScpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhJbmZvLnB1c2goaS5maWVsZHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGkudW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleEluZm8ucHVzaCgnaXMnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKCd1bmlxdWUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSguLi5pbmRleEluZm8pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVUeXBlKGZpZWxkLCBsaW5lSW5mbykge1xuICAgICAgICBsZXQgZXh0cmFUeXBlSW5mbyA9IF8ub21pdChmaWVsZCwgWyd0eXBlJywgJ21vZGlmaWVycycsICduYW1lJ10pO1xuICAgICAgICAvL2xldCB0eXBlTWV0YSA9IFR5cGVzW2ZpZWxkLnR5cGVdO1xuICAgICAgICBfLmZvck93bihleHRyYVR5cGVJbmZvLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgLy9pZiAoIXR5cGVNZXRhLnF1YWxpZmllcnMuaW5jbHVkZXMoaykpIHtcbiAgICAgICAgICAgIC8vICAgIHRocm93IG5ldyBFcnJvcihgXCIke2t9XCIgaXMgbm90IGEgdmFsaWQgcXVhbGlmaWVyIGZvciB0eXBlIFwiJHtmaWVsZC50eXBlfVwiLmApO1xuICAgICAgICAgICAgLy99XG4gICAgICAgICAgICBpZiAoayA9PT0gJ2NvbW1lbnQnKSByZXR1cm47XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Jvb2xlYW4nIHx8IGlzTm90aGluZyh2KSkge1xuICAgICAgICAgICAgICAgIGlmICh2KSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2ID0gXy5jYXN0QXJyYXkodik7XG4gICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaChrICsgJygnICsgdGhpcy5fdHJhbnNsYXRlQXJncyh2KSArICcpJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChmaWVsZC5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgIHRoaXMuX3RyYW5zbGF0ZVBpcGVkVmFsdWUobGluZUluZm8sIGZpZWxkKTtcbiAgICAgICAgfSAgICAgICAgXG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZVBpcGVkVmFsdWUobGluZUluZm8sIHZhbHVlKSB7ICAgICAgICBcbiAgICAgICAgaWYgKHZhbHVlLm1vZGlmaWVycykge1xuICAgICAgICAgICAgdmFsdWUubW9kaWZpZXJzLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh2Lm9vbFR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBPb2xUeXBlcy5MYW5nLlZBTElEQVRPUjpcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaCgnfH4nICsgdGhpcy5fdHJhbnNsYXRlTW9kaWZpZXIodikpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBjYXNlIE9vbFR5cGVzLkxhbmcuUFJPQ0VTU09SOlxuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKCd8PicgKyB0aGlzLl90cmFuc2xhdGVNb2RpZmllcih2KSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT29sVHlwZXMuTGFuZy5BQ1RJVkFUT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3w9JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBtb2RpZmllciB0eXBlOiBcIiR7di5vb2xUeXBlfVwiIWApO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gXG4gICAgfVxuXG4gICAgX3RyYW5zbGF0ZU1vZGlmaWVyKGYpIHtcbiAgICAgICAgbGV0IHIgPSBmLm5hbWU7XG5cbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZi5hcmdzKSkge1xuICAgICAgICAgICAgciArPSAnKCc7XG5cbiAgICAgICAgICAgIHIgKz0gdGhpcy5fdHJhbnNsYXRlQXJncyhmLmFyZ3MpO1xuXG4gICAgICAgICAgICByICs9ICcpJztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVBcmdzKGFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIGFyZ3MubWFwKGEgPT4gdGhpcy5fdHJhbnNsYXRlQXJnKGEpKS5qb2luKCcsICcpO1xuICAgIH1cblxuICAgIF90cmFuc2xhdGVBcmcoYSkge1xuICAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGEpICYmIGEuaGFzT3duUHJvcGVydHkoJ29vbFR5cGUnKSkge1xuICAgICAgICAgICAgaWYgKGEub29sVHlwZSA9PT0gJ1BpcGVkVmFsdWUnKSB7XG4gICAgICAgICAgICAgICAgbGV0IHBpcGVsaW5lID0gWyB0aGlzLl90cmFuc2xhdGVBcmcoYS52YWx1ZSkgXTtcblxuICAgICAgICAgICAgICAgIGlmIChhLm1vZGlmaWVycykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl90cmFuc2xhdGVQaXBlZFZhbHVlKHBpcGVsaW5lLCBhKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcGlwZWxpbmUuam9pbignICcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhLm9vbFR5cGUgPT09ICdPYmplY3RSZWZlcmVuY2UnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdAJyArIGEubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3Qgc3VwcG9ydGVkIG9vbFR5cGU6ICcgKyBhLm9vbFR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IFxuXG4gICAgICAgIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycgJiYgaXNRdW90ZWRXaXRoKGEsICcvJykpIHJldHVybiBhO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBPb2xDb2RlR2VuOyJdfQ==