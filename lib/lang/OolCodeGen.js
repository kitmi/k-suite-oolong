"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _
} = Util;

const {
  generateDisplayName
} = require('./OolUtils');

const {
  isNothing,
  isQuotedWith
} = require('../utils/lang');

const KW_NAMESPACE = 'import';
const KW_SCHEMA = 'schema';
const KW_ENTITIES = 'entities';
const KW_ENTITY_AS_ALIAS = 'as';
const KW_TYPE_DEFINE = 'type';
const KW_ENTITY = 'entity';
const KW_CODE = 'code';
const KW_COMMENT = '--';
const KW_WITH_FEATURE = 'with';
const KW_FIELDS = 'has';
const KW_ASSOCIATIONS = 'associations';
const KW_KEY = 'key';
const KW_INDEXES = 'index';

const Types = require('../runtime/types');

const OolTypes = require('./OolTypes');

class OolCodeGen {
  static transform(json, options) {
    let codeGen = new OolCodeGen(options);
    return codeGen.generate(json);
  }

  constructor(options) {
    this.indented = 0;
    this.content = '';
    this.options = options;
  }

  generate(json) {
    this.generateObject(json);
    return this.content;
  }

  appendLine(line) {
    if (line) {
      if (arguments.length > 1) {
        line = [...arguments].join(' ');
      }

      this.content += (this.indented > 0 ? _.repeat(' ', this.indented) : '') + line + '\n';
    } else {
      this.content += '\n';
    }

    return this;
  }

  indent() {
    this.indented += 2;
    return this;
  }

  dedent() {
    const _checkPostcondition = it => {
      if (!(this.indented >= 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    this.indented -= 2;
    return _checkPostcondition(this);
  }

  generateObject(obj) {
    _.forOwn(obj, (v, k) => {
      let generateMethod = 'generate_' + k;

      if (generateMethod in this) {
        return this[generateMethod](v);
      }

      throw new Error('to be implemented, object: ' + k);
    });
  }

  generate_namespace(namespaces) {
    const _checkPostcondition2 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!Array.isArray(namespaces)) {
      throw new Error('Invalid namespaces.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (namespaces.length > 0) {
      this.appendLine(KW_NAMESPACE).indent();
      namespaces.forEach(ns => {
        this.appendLine(Util.quote(ns, "'"));
      });
      this.dedent().appendLine();
    }

    _checkPostcondition2();
  }

  generate_schema(schema) {
    const _checkPostcondition3 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(schema, (schemaInfo, name) => {
      this.appendLine(KW_SCHEMA, Util.quote(name, "'")).indent();

      if (schemaInfo.entities) {
        this.appendLine(KW_ENTITIES).indent();
        schemaInfo.entities.forEach(entityEntry => {
          if (entityEntry.alias) {
            this.appendLine(entityEntry.entity, KW_ENTITY_AS_ALIAS, entityEntry.alias);
          } else {
            this.appendLine(entityEntry.entity);
          }
        });
        this.dedent().appendLine();
      }

      this.dedent();
    });

    _checkPostcondition3();
  }

  generate_type(types) {
    const _checkPostcondition4 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(types)) {
      throw new Error('Invalid types.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    if (!_.isEmpty(types)) {
      this.appendLine(KW_TYPE_DEFINE).indent();

      _.forOwn(types, (type, name) => {
        let lineInfo = [name, ':', type.type];

        this._translateType(type, lineInfo);

        this.appendLine(...lineInfo);
      });

      this.dedent().appendLine();
    }

    _checkPostcondition4();
  }

  generate_field_comment(entityName, colName) {
    let colNameFullSnake = _.trimStart(_.snakeCase(colName), '_');

    let [colNameFirstWord, colNameRest] = colNameFullSnake.split('_', 2);
    let result;

    let entityNameFullSnake = _.trim(_.snakeCase(entityName), '_');

    if (_.endsWith(entityNameFullSnake, colNameFirstWord)) {
      result = entityNameFullSnake + '_' + colNameRest;
    } else {
      result = entityNameFullSnake + '_' + colNameFullSnake;
    }

    return generateDisplayName(result);
  }

  generate_entity(entities) {
    const _checkPostcondition5 = it => {
      if (!(this.indented == 0)) {
        throw new Error('Unexpected indented state.');
      }

      return it;
    };

    if (!_.isPlainObject(entities)) {
      throw new Error('Invalid entities.');
    }

    if (!(this.indented == 0)) {
      throw new Error('Unexpected indented state.');
    }

    _.forOwn(entities, (entity, enityName) => {
      this.appendLine(KW_ENTITY, enityName).indent();

      if (entity.source) {
        this.appendLine(KW_CODE, Util.quote(entity.source));
      }

      this.appendLine(KW_COMMENT, Util.quote(entity.comment || generateDisplayName(enityName)));
      let hasAutoId = false;

      if (!_.isEmpty(entity.features)) {
        this.appendLine(KW_WITH_FEATURE).indent();
        entity.features.forEach(feature => {
          if (typeof feature === 'string') {
            feature = {
              name: feature
            };
          }

          if (feature.name === 'autoId') {
            hasAutoId = true;
          }

          if (feature.args) {
            this.appendLine(feature.name + '(' + feature.args.map(a => JSON.stringify(a)).join(', ') + ')');
          } else {
            this.appendLine(feature.name);
          }
        });
        this.dedent();
      }

      if (!_.isEmpty(entity.fields)) {
        this.appendLine().appendLine(KW_FIELDS).indent();

        _.forOwn(entity.fields, (field, name) => {
          if (!field.type) {
            throw new Error("Assertion failed: field.type");
          }

          let lineInfo = [];
          lineInfo.push(Types.Builtin.has(name) ? Util.quote(name) : name);

          if (field.type !== name) {
            lineInfo.push(':');
            lineInfo.push(field.type);
          }

          this._translateType(field, lineInfo);

          lineInfo.push(KW_COMMENT + ' ' + (field.comment || Util.quote(this.generate_field_comment(enityName, name))));
          this.appendLine(...lineInfo);
        });

        this.dedent();
      }

      if (!_.isEmpty(entity.associations)) {
        this.appendLine().appendLine(KW_ASSOCIATIONS).indent();
        entity.associations.forEach(({
          type,
          from,
          entity,
          through
        }) => {
          if (from) {
            this.appendLine(type, Util.quote(entity, "'"), 'as', Util.quote(from, "'"));
          } else if (through) {
            this.appendLine(type, Util.quote(entity, "'"), 'through', Util.quote(through, "'"));
          } else {
            this.appendLine(type, Util.quote(entity, "'"));
          }
        });
        this.dedent();
      }

      if (entity.key && !hasAutoId) {
        let key = Array.isArray(entity.key) && entity.key.length === 1 ? entity.key[0] : entity.key;

        if (Array.isArray(key)) {
          this.appendLine().appendLine(KW_KEY, '[ ' + key.join(', ') + ' ]');
        } else {
          this.appendLine().appendLine(KW_KEY, key);
        }
      }

      if (!_.isEmpty(entity.indexes)) {
        this.appendLine().appendLine(KW_INDEXES).indent();
        entity.indexes.forEach(i => {
          let indexInfo = [];

          if (Array.isArray(i.fields)) {
            indexInfo.push('[' + i.fields.join(', ') + ']');
          } else {
            indexInfo.push(i.fields);
          }

          if (i.unique) {
            indexInfo.push('is');
            indexInfo.push('unique');
          }

          this.appendLine(...indexInfo);
        });
        this.dedent();
      }

      this.dedent();
    });

    _checkPostcondition5();
  }

  _translateType(field, lineInfo) {
    let extraTypeInfo = _.omit(field, ['type', 'modifiers', 'name']);

    _.forOwn(extraTypeInfo, (v, k) => {
      if (k === 'comment') return;

      if (typeof v === 'boolean' || isNothing(v)) {
        if (v) {
          lineInfo.push(k);
        }
      } else {
        v = _.castArray(v);
        lineInfo.push(k + '(' + this._translateArgs(v) + ')');
      }
    });

    if (field.modifiers) {
      this._translatePipedValue(lineInfo, field);
    }
  }

  _translatePipedValue(lineInfo, value) {
    if (value.modifiers) {
      value.modifiers.forEach(v => {
        switch (v.oolType) {
          case OolTypes.Lang.VALIDATOR:
            lineInfo.push('|~' + this._translateModifier(v));
            break;

          case OolTypes.Lang.PROCESSOR:
            lineInfo.push('|>' + this._translateModifier(v));
            break;

          case OolTypes.Lang.ACTIVATOR:
            lineInfo.push('|=' + this._translateModifier(v));
            break;

          default:
            throw new Error(`Unknown modifier type: "${v.oolType}"!`);
        }
      });
    }
  }

  _translateModifier(f) {
    let r = f.name;

    if (!_.isEmpty(f.args)) {
      r += '(';
      r += this._translateArgs(f.args);
      r += ')';
    }

    return r;
  }

  _translateArgs(args) {
    return args.map(a => this._translateArg(a)).join(', ');
  }

  _translateArg(a) {
    if (_.isPlainObject(a) && a.hasOwnProperty('oolType')) {
      if (a.oolType === 'PipedValue') {
        let pipeline = [this._translateArg(a.value)];

        if (a.modifiers) {
          this._translatePipedValue(pipeline, a);
        }

        return pipeline.join(' ');
      } else if (a.oolType === 'ObjectReference') {
        return '@' + a.name;
      } else {
        throw new Error('Not supported oolType: ' + a.oolType);
      }
    }

    if (typeof a === 'string' && isQuotedWith(a, '/')) return a;
    return JSON.stringify(a);
  }

}

module.exports = OolCodeGen;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL09vbENvZGVHZW4uanMiXSwibmFtZXMiOlsiVXRpbCIsInJlcXVpcmUiLCJfIiwiZ2VuZXJhdGVEaXNwbGF5TmFtZSIsImlzTm90aGluZyIsImlzUXVvdGVkV2l0aCIsIktXX05BTUVTUEFDRSIsIktXX1NDSEVNQSIsIktXX0VOVElUSUVTIiwiS1dfRU5USVRZX0FTX0FMSUFTIiwiS1dfVFlQRV9ERUZJTkUiLCJLV19FTlRJVFkiLCJLV19DT0RFIiwiS1dfQ09NTUVOVCIsIktXX1dJVEhfRkVBVFVSRSIsIktXX0ZJRUxEUyIsIktXX0FTU09DSUFUSU9OUyIsIktXX0tFWSIsIktXX0lOREVYRVMiLCJUeXBlcyIsIk9vbFR5cGVzIiwiT29sQ29kZUdlbiIsInRyYW5zZm9ybSIsImpzb24iLCJvcHRpb25zIiwiY29kZUdlbiIsImdlbmVyYXRlIiwiY29uc3RydWN0b3IiLCJpbmRlbnRlZCIsImNvbnRlbnQiLCJnZW5lcmF0ZU9iamVjdCIsImFwcGVuZExpbmUiLCJsaW5lIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiam9pbiIsInJlcGVhdCIsImluZGVudCIsImRlZGVudCIsIm9iaiIsImZvck93biIsInYiLCJrIiwiZ2VuZXJhdGVNZXRob2QiLCJFcnJvciIsImdlbmVyYXRlX25hbWVzcGFjZSIsIm5hbWVzcGFjZXMiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwibnMiLCJxdW90ZSIsImdlbmVyYXRlX3NjaGVtYSIsInNjaGVtYSIsInNjaGVtYUluZm8iLCJuYW1lIiwiZW50aXRpZXMiLCJlbnRpdHlFbnRyeSIsImFsaWFzIiwiZW50aXR5IiwiZ2VuZXJhdGVfdHlwZSIsInR5cGVzIiwiaXNQbGFpbk9iamVjdCIsImlzRW1wdHkiLCJ0eXBlIiwibGluZUluZm8iLCJfdHJhbnNsYXRlVHlwZSIsImdlbmVyYXRlX2ZpZWxkX2NvbW1lbnQiLCJlbnRpdHlOYW1lIiwiY29sTmFtZSIsImNvbE5hbWVGdWxsU25ha2UiLCJ0cmltU3RhcnQiLCJzbmFrZUNhc2UiLCJjb2xOYW1lRmlyc3RXb3JkIiwiY29sTmFtZVJlc3QiLCJzcGxpdCIsInJlc3VsdCIsImVudGl0eU5hbWVGdWxsU25ha2UiLCJ0cmltIiwiZW5kc1dpdGgiLCJnZW5lcmF0ZV9lbnRpdHkiLCJlbml0eU5hbWUiLCJzb3VyY2UiLCJjb21tZW50IiwiaGFzQXV0b0lkIiwiZmVhdHVyZXMiLCJmZWF0dXJlIiwiYXJncyIsIm1hcCIsImEiLCJKU09OIiwic3RyaW5naWZ5IiwiZmllbGRzIiwiZmllbGQiLCJwdXNoIiwiQnVpbHRpbiIsImhhcyIsImFzc29jaWF0aW9ucyIsImZyb20iLCJ0aHJvdWdoIiwia2V5IiwiaW5kZXhlcyIsImkiLCJpbmRleEluZm8iLCJ1bmlxdWUiLCJleHRyYVR5cGVJbmZvIiwib21pdCIsImNhc3RBcnJheSIsIl90cmFuc2xhdGVBcmdzIiwibW9kaWZpZXJzIiwiX3RyYW5zbGF0ZVBpcGVkVmFsdWUiLCJ2YWx1ZSIsIm9vbFR5cGUiLCJMYW5nIiwiVkFMSURBVE9SIiwiX3RyYW5zbGF0ZU1vZGlmaWVyIiwiUFJPQ0VTU09SIiwiQUNUSVZBVE9SIiwiZiIsInIiLCJfdHJhbnNsYXRlQXJnIiwiaGFzT3duUHJvcGVydHkiLCJwaXBlbGluZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBUUYsSUFBZDs7QUFDQSxNQUFNO0FBQUVHLEVBQUFBO0FBQUYsSUFBMEJGLE9BQU8sQ0FBQyxZQUFELENBQXZDOztBQUNBLE1BQU07QUFBRUcsRUFBQUEsU0FBRjtBQUFhQyxFQUFBQTtBQUFiLElBQThCSixPQUFPLENBQUMsZUFBRCxDQUEzQzs7QUFFQSxNQUFNSyxZQUFZLEdBQUcsUUFBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsUUFBbEI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsVUFBcEI7QUFDQSxNQUFN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dEQsSUFBckMsQ0FBMEMsSUFBMUMsQ0FBUDtBQUNIOztBQUVEcUYsRUFBQUEsYUFBYSxDQUFDL0IsQ0FBRCxFQUFJO0FBQ2IsUUFBSXZGLENBQUMsQ0FBQzRELGFBQUYsQ0FBZ0IyQixDQUFoQixLQUFzQkEsQ0FBQyxDQUFDZ0MsY0FBRixDQUFpQixTQUFqQixDQUExQixFQUF1RDtBQUNuRCxVQUFJaEMsQ0FBQyxDQUFDdUIsT0FBRixLQUFjLFlBQWxCLEVBQWdDO0FBQzVCLFlBQUlVLFFBQVEsR0FBRyxDQUFFLEtBQUtGLGFBQUwsQ0FBbUIvQixDQUFDLENBQUNzQixLQUFyQixDQUFGLENBQWY7O0FBRUEsWUFBSXRCLENBQUMsQ0FBQ29CLFNBQU4sRUFBaUI7QUFDYixlQUFLQyxvQkFBTCxDQUEwQlksUUFBMUIsRUFBb0NqQyxDQUFwQztBQUNIOztBQUVELGVBQU9pQyxRQUFRLENBQUN2RixJQUFULENBQWMsR0FBZCxDQUFQO0FBQ0gsT0FSRCxNQVFPLElBQUlzRCxDQUFDLENBQUN1QixPQUFGLEtBQWMsaUJBQWxCLEVBQXFDO0FBQ3hDLGVBQU8sTUFBTXZCLENBQUMsQ0FBQ2xDLElBQWY7QUFDSCxPQUZNLE1BRUE7QUFDSCxjQUFNLElBQUlYLEtBQUosQ0FBVSw0QkFBNEI2QyxDQUFDLENBQUN1QixPQUF4QyxDQUFOO0FBQ0g7QUFDSjs7QUFFRCxRQUFJLE9BQU92QixDQUFQLEtBQWEsUUFBYixJQUF5QnBGLFlBQVksQ0FBQ29GLENBQUQsRUFBSSxHQUFKLENBQXpDLEVBQW1ELE9BQU9BLENBQVA7QUFFbkQsV0FBT0MsSUFBSSxDQUFDQyxTQUFMLENBQWVGLENBQWYsQ0FBUDtBQUNIOztBQXZWWTs7QUEwVmpCa0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkcsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8gfSA9IFV0aWw7XG5jb25zdCB7IGdlbmVyYXRlRGlzcGxheU5hbWUgfSA9IHJlcXVpcmUoJy4vT29sVXRpbHMnKTtcbmNvbnN0IHsgaXNOb3RoaW5nLCBpc1F1b3RlZFdpdGggfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xhbmcnKTtcblxuY29uc3QgS1dfTkFNRVNQQUNFID0gJ2ltcG9ydCc7XG5jb25zdCBLV19TQ0hFTUEgPSAnc2NoZW1hJztcbmNvbnN0IEtXX0VOVElUSUVTID0gJ2VudGl0aWVzJztcbmNvbnN0IEtXX0VOVElUWV9BU19BTElBUyA9ICdhcyc7XG5jb25zdCBLV19UWVBFX0RFRklORSA9ICd0eXBlJztcbmNvbnN0IEtXX0VOVElUWSA9ICdlbnRpdHknO1xuY29uc3QgS1dfQ09ERSA9ICdjb2RlJztcbmNvbnN0IEtXX0NPTU1FTlQgPSAnLS0nO1xuY29uc3QgS1dfV0lUSF9GRUFUVVJFID0gJ3dpdGgnO1xuY29uc3QgS1dfRklFTERTID0gJ2hhcyc7XG5jb25zdCBLV19BU1NPQ0lBVElPTlMgPSAnYXNzb2NpYXRpb25zJztcbmNvbnN0IEtXX0tFWSA9ICdrZXknO1xuY29uc3QgS1dfSU5ERVhFUyA9ICdpbmRleCc7XG5cbmNvbnN0IFR5cGVzID0gcmVxdWlyZSgnLi4vcnVudGltZS90eXBlcycpO1xuY29uc3QgT29sVHlwZXMgPSByZXF1aXJlKCcuL09vbFR5cGVzJyk7XG5cbmNsYXNzIE9vbENvZGVHZW4ge1xuICAgIHN0YXRpYyB0cmFuc2Zvcm0oanNvbiwgb3B0aW9ucykge1xuICAgICAgICBsZXQgY29kZUdlbiA9IG5ldyBPb2xDb2RlR2VuKG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gY29kZUdlbi5nZW5lcmF0ZShqc29uKTtcbiAgICB9XG5cbiAgICBpbmRlbnRlZCA9IDA7XG4gICAgY29udGVudCA9ICcnO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucykge1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIH1cblxuICAgIGdlbmVyYXRlKGpzb24pIHtcbiAgICAgICAgdGhpcy5nZW5lcmF0ZU9iamVjdChqc29uKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50O1xuICAgIH1cblxuICAgIGFwcGVuZExpbmUobGluZSkge1xuICAgICAgICBpZiAobGluZSkge1xuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgbGluZSA9IFsgLi4uYXJndW1lbnRzXS5qb2luKCcgJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuY29udGVudCArPSAodGhpcy5pbmRlbnRlZCA+IDAgPyBfLnJlcGVhdCgnICcsIHRoaXMuaW5kZW50ZWQpIDogJycpICsgbGluZSArICdcXG4nO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50ICs9ICdcXG4nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGluZGVudCgpIHtcbiAgICAgICAgdGhpcy5pbmRlbnRlZCArPSAyO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBkZWRlbnQoKSB7XG4gICAgICAgIHRoaXMuaW5kZW50ZWQgLT0gMjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPj0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZU9iamVjdChvYmopIHtcbiAgICAgICAgXy5mb3JPd24ob2JqLCAodixrKSA9PiB7XG4gICAgICAgICAgICBsZXQgZ2VuZXJhdGVNZXRob2QgPSAnZ2VuZXJhdGVfJyArIGs7XG5cbiAgICAgICAgICAgIGlmIChnZW5lcmF0ZU1ldGhvZCBpbiB0aGlzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbZ2VuZXJhdGVNZXRob2RdKHYpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RvIGJlIGltcGxlbWVudGVkLCBvYmplY3Q6ICcgKyBrKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVfbmFtZXNwYWNlKG5hbWVzcGFjZXMpIHtcbiAgICAgICAgcHJlOiB7XG4gICAgICAgICAgICBBcnJheS5pc0FycmF5KG5hbWVzcGFjZXMpLCAnSW52YWxpZCBuYW1lc3BhY2VzLic7XG4gICAgICAgICAgICB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobmFtZXNwYWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfTkFNRVNQQUNFKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgbmFtZXNwYWNlcy5mb3JFYWNoKG5zID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoVXRpbC5xdW90ZShucywgXCInXCIpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmRlZGVudCgpLmFwcGVuZExpbmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV9zY2hlbWEoc2NoZW1hKSB7XG4gICAgICAgIHByZTogeyAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgICAgICB9XG5cbiAgICAgICAgXy5mb3JPd24oc2NoZW1hLCAoc2NoZW1hSW5mbywgbmFtZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX1NDSEVNQSwgVXRpbC5xdW90ZShuYW1lLCBcIidcIikpLmluZGVudCgpO1xuXG4gICAgICAgICAgICBpZiAoc2NoZW1hSW5mby5lbnRpdGllcykge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19FTlRJVElFUykuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBzY2hlbWFJbmZvLmVudGl0aWVzLmZvckVhY2goZW50aXR5RW50cnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5RW50cnkuYWxpYXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShlbnRpdHlFbnRyeS5lbnRpdHksIEtXX0VOVElUWV9BU19BTElBUywgZW50aXR5RW50cnkuYWxpYXMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKGVudGl0eUVudHJ5LmVudGl0eSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCkuYXBwZW5kTGluZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmRlZGVudCgpO1xuICAgICAgICB9KTsgICAgICAgIFxuXG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBnZW5lcmF0ZV90eXBlKHR5cGVzKSB7XG4gICAgICAgIHByZToge1xuICAgICAgICAgICAgXy5pc1BsYWluT2JqZWN0KHR5cGVzKSwgJ0ludmFsaWQgdHlwZXMuJztcbiAgICAgICAgICAgIHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHR5cGVzKSkge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX1RZUEVfREVGSU5FKS5pbmRlbnQoKTtcblxuICAgICAgICAgICAgXy5mb3JPd24odHlwZXMsICh0eXBlLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGxpbmVJbmZvID0gWyBuYW1lLCAnOicsIHR5cGUudHlwZSBdO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5fdHJhbnNsYXRlVHlwZSh0eXBlLCBsaW5lSW5mbyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoLi4ubGluZUluZm8pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuZGVkZW50KCkuYXBwZW5kTGluZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcG9zdDogdGhpcy5pbmRlbnRlZCA9PSAwLCAnVW5leHBlY3RlZCBpbmRlbnRlZCBzdGF0ZS4nO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX2ZpZWxkX2NvbW1lbnQoZW50aXR5TmFtZSwgY29sTmFtZSkge1xuICAgICAgICBsZXQgY29sTmFtZUZ1bGxTbmFrZSA9IF8udHJpbVN0YXJ0KF8uc25ha2VDYXNlKGNvbE5hbWUpLCAnXycpO1xuICAgICAgICBsZXQgIFsgY29sTmFtZUZpcnN0V29yZCwgY29sTmFtZVJlc3QgXSA9IGNvbE5hbWVGdWxsU25ha2Uuc3BsaXQoJ18nLCAyKTtcblxuICAgICAgICBsZXQgcmVzdWx0O1xuXG4gICAgICAgIGxldCBlbnRpdHlOYW1lRnVsbFNuYWtlID0gXy50cmltKF8uc25ha2VDYXNlKGVudGl0eU5hbWUpLCAnXycpO1xuICAgICAgICBpZiAoXy5lbmRzV2l0aChlbnRpdHlOYW1lRnVsbFNuYWtlLCBjb2xOYW1lRmlyc3RXb3JkKSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gZW50aXR5TmFtZUZ1bGxTbmFrZSArICdfJyArIGNvbE5hbWVSZXN0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0ID0gZW50aXR5TmFtZUZ1bGxTbmFrZSArICdfJyArIGNvbE5hbWVGdWxsU25ha2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZ2VuZXJhdGVEaXNwbGF5TmFtZShyZXN1bHQpO1xuICAgIH1cblxuICAgIGdlbmVyYXRlX2VudGl0eShlbnRpdGllcykge1xuICAgICAgICBwcmU6IHtcbiAgICAgICAgICAgIF8uaXNQbGFpbk9iamVjdChlbnRpdGllcyksICdJbnZhbGlkIGVudGl0aWVzLic7XG4gICAgICAgICAgICB0aGlzLmluZGVudGVkID09IDAsICdVbmV4cGVjdGVkIGluZGVudGVkIHN0YXRlLic7XG4gICAgICAgIH1cblxuICAgICAgICBfLmZvck93bihlbnRpdGllcywgKGVudGl0eSwgZW5pdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoS1dfRU5USVRZLCBlbml0eU5hbWUpLmluZGVudCgpO1xuXG4gICAgICAgICAgICBpZiAoZW50aXR5LnNvdXJjZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19DT0RFLCBVdGlsLnF1b3RlKGVudGl0eS5zb3VyY2UpKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKEtXX0NPTU1FTlQsIFV0aWwucXVvdGUoZW50aXR5LmNvbW1lbnQgfHwgZ2VuZXJhdGVEaXNwbGF5TmFtZShlbml0eU5hbWUpKSk7XG5cbiAgICAgICAgICAgIGxldCBoYXNBdXRvSWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmZlYXR1cmVzKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShLV19XSVRIX0ZFQVRVUkUpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgZW50aXR5LmZlYXR1cmVzLmZvckVhY2goZmVhdHVyZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZmVhdHVyZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUgPSB7IG5hbWU6IGZlYXR1cmUgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmZWF0dXJlLm5hbWUgPT09ICdhdXRvSWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNBdXRvSWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZlYXR1cmUuYXJncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKGZlYXR1cmUubmFtZSArICcoJyArIGZlYXR1cmUuYXJncy5tYXAoYSA9PiBKU09OLnN0cmluZ2lmeShhKSkuam9pbignLCAnKSArICcpJyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoZmVhdHVyZS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5kZWRlbnQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkoZW50aXR5LmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoKS5hcHBlbmRMaW5lKEtXX0ZJRUxEUykuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBfLmZvck93bihlbnRpdHkuZmllbGRzLCAoZmllbGQsIG5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0OiBmaWVsZC50eXBlOyAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGxpbmVJbmZvID0gW107XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goVHlwZXMuQnVpbHRpbi5oYXMobmFtZSkgPyBVdGlsLnF1b3RlKG5hbWUpIDogbmFtZSk7ICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZC50eXBlICE9PSBuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKCc6Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKGZpZWxkLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJhbnNsYXRlVHlwZShmaWVsZCwgbGluZUluZm8pO1xuXG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goS1dfQ09NTUVOVCArICcgJyArIChmaWVsZC5jb21tZW50IHx8IFV0aWwucXVvdGUodGhpcy5nZW5lcmF0ZV9maWVsZF9jb21tZW50KGVuaXR5TmFtZSwgbmFtZSkpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKC4uLmxpbmVJbmZvKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5hc3NvY2lhdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19BU1NPQ0lBVElPTlMpLmluZGVudCgpO1xuXG4gICAgICAgICAgICAgICAgZW50aXR5LmFzc29jaWF0aW9ucy5mb3JFYWNoKCh7IHR5cGUsIGZyb20sIGVudGl0eSwgdGhyb3VnaCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmcm9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUodHlwZSwgVXRpbC5xdW90ZShlbnRpdHksIFwiJ1wiKSwgJ2FzJywgVXRpbC5xdW90ZShmcm9tLCBcIidcIikpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRocm91Z2gpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSh0eXBlLCBVdGlsLnF1b3RlKGVudGl0eSwgXCInXCIpLCAndGhyb3VnaCcsIFV0aWwucXVvdGUodGhyb3VnaCwgXCInXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSh0eXBlLCBVdGlsLnF1b3RlKGVudGl0eSwgXCInXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRlZGVudCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZW50aXR5LmtleSAmJiAhaGFzQXV0b0lkKSB7XG4gICAgICAgICAgICAgICAgbGV0IGtleSA9IChBcnJheS5pc0FycmF5KGVudGl0eS5rZXkpICYmIGVudGl0eS5rZXkubGVuZ3RoID09PSAxKSA/IGVudGl0eS5rZXlbMF0gOiBlbnRpdHkua2V5O1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRMaW5lKCkuYXBwZW5kTGluZShLV19LRVksICdbICcgKyBrZXkuam9pbignLCAnKSArICcgXScpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSgpLmFwcGVuZExpbmUoS1dfS0VZLCBrZXkpO1xuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVudGl0eS5pbmRleGVzKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZSgpLmFwcGVuZExpbmUoS1dfSU5ERVhFUykuaW5kZW50KCk7XG5cbiAgICAgICAgICAgICAgICBlbnRpdHkuaW5kZXhlcy5mb3JFYWNoKGkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXhJbmZvID0gW107XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaS5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleEluZm8ucHVzaCgnWycgKyBpLmZpZWxkcy5qb2luKCcsICcpICsgJ10nKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4SW5mby5wdXNoKGkuZmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChpLnVuaXF1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhJbmZvLnB1c2goJ2lzJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleEluZm8ucHVzaCgndW5pcXVlJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUoLi4uaW5kZXhJbmZvKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZGVkZW50KCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHBvc3Q6IHRoaXMuaW5kZW50ZWQgPT0gMCwgJ1VuZXhwZWN0ZWQgaW5kZW50ZWQgc3RhdGUuJztcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlVHlwZShmaWVsZCwgbGluZUluZm8pIHtcbiAgICAgICAgbGV0IGV4dHJhVHlwZUluZm8gPSBfLm9taXQoZmllbGQsIFsndHlwZScsICdtb2RpZmllcnMnLCAnbmFtZSddKTtcbiAgICAgICAgLy9sZXQgdHlwZU1ldGEgPSBUeXBlc1tmaWVsZC50eXBlXTtcbiAgICAgICAgXy5mb3JPd24oZXh0cmFUeXBlSW5mbywgKHYsIGspID0+IHtcbiAgICAgICAgICAgIC8vaWYgKCF0eXBlTWV0YS5xdWFsaWZpZXJzLmluY2x1ZGVzKGspKSB7XG4gICAgICAgICAgICAvLyAgICB0aHJvdyBuZXcgRXJyb3IoYFwiJHtrfVwiIGlzIG5vdCBhIHZhbGlkIHF1YWxpZmllciBmb3IgdHlwZSBcIiR7ZmllbGQudHlwZX1cIi5gKTtcbiAgICAgICAgICAgIC8vfVxuICAgICAgICAgICAgaWYgKGsgPT09ICdjb21tZW50JykgcmV0dXJuO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdib29sZWFuJyB8fCBpc05vdGhpbmcodikpIHtcbiAgICAgICAgICAgICAgICBpZiAodikge1xuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKGspO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdiA9IF8uY2FzdEFycmF5KHYpO1xuICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goayArICcoJyArIHRoaXMuX3RyYW5zbGF0ZUFyZ3ModikgKyAnKScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZmllbGQubW9kaWZpZXJzKSB7XG4gICAgICAgICAgICB0aGlzLl90cmFuc2xhdGVQaXBlZFZhbHVlKGxpbmVJbmZvLCBmaWVsZCk7XG4gICAgICAgIH0gICAgICAgIFxuICAgIH1cblxuICAgIF90cmFuc2xhdGVQaXBlZFZhbHVlKGxpbmVJbmZvLCB2YWx1ZSkgeyAgICAgICAgXG4gICAgICAgIGlmICh2YWx1ZS5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgIHZhbHVlLm1vZGlmaWVycy5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAodi5vb2xUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT29sVHlwZXMuTGFuZy5WQUxJREFUT1I6XG4gICAgICAgICAgICAgICAgICAgIGxpbmVJbmZvLnB1c2goJ3x+JyArIHRoaXMuX3RyYW5zbGF0ZU1vZGlmaWVyKHYpKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBPb2xUeXBlcy5MYW5nLlBST0NFU1NPUjpcbiAgICAgICAgICAgICAgICAgICAgbGluZUluZm8ucHVzaCgnfD4nICsgdGhpcy5fdHJhbnNsYXRlTW9kaWZpZXIodikpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBjYXNlIE9vbFR5cGVzLkxhbmcuQUNUSVZBVE9SOlxuICAgICAgICAgICAgICAgICAgICBsaW5lSW5mby5wdXNoKCd8PScgKyB0aGlzLl90cmFuc2xhdGVNb2RpZmllcih2KSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gbW9kaWZpZXIgdHlwZTogXCIke3Yub29sVHlwZX1cIiFgKTtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IFxuICAgIH1cblxuICAgIF90cmFuc2xhdGVNb2RpZmllcihmKSB7XG4gICAgICAgIGxldCByID0gZi5uYW1lO1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KGYuYXJncykpIHtcbiAgICAgICAgICAgIHIgKz0gJygnO1xuXG4gICAgICAgICAgICByICs9IHRoaXMuX3RyYW5zbGF0ZUFyZ3MoZi5hcmdzKTtcblxuICAgICAgICAgICAgciArPSAnKSc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcjtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlQXJncyhhcmdzKSB7XG4gICAgICAgIHJldHVybiBhcmdzLm1hcChhID0+IHRoaXMuX3RyYW5zbGF0ZUFyZyhhKSkuam9pbignLCAnKTtcbiAgICB9XG5cbiAgICBfdHJhbnNsYXRlQXJnKGEpIHtcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChhKSAmJiBhLmhhc093blByb3BlcnR5KCdvb2xUeXBlJykpIHtcbiAgICAgICAgICAgIGlmIChhLm9vbFR5cGUgPT09ICdQaXBlZFZhbHVlJykge1xuICAgICAgICAgICAgICAgIGxldCBwaXBlbGluZSA9IFsgdGhpcy5fdHJhbnNsYXRlQXJnKGEudmFsdWUpIF07XG5cbiAgICAgICAgICAgICAgICBpZiAoYS5tb2RpZmllcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdHJhbnNsYXRlUGlwZWRWYWx1ZShwaXBlbGluZSwgYSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBpcGVsaW5lLmpvaW4oJyAnKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYS5vb2xUeXBlID09PSAnT2JqZWN0UmVmZXJlbmNlJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnQCcgKyBhLm5hbWU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IHN1cHBvcnRlZCBvb2xUeXBlOiAnICsgYS5vb2xUeXBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBcblxuICAgICAgICBpZiAodHlwZW9mIGEgPT09ICdzdHJpbmcnICYmIGlzUXVvdGVkV2l0aChhLCAnLycpKSByZXR1cm4gYTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT29sQ29kZUdlbjsiXX0=