"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const FEATURE_NAME = 'autoId';

function feature(entity, args = []) {
  let typeInfo = {
    name: 'id',
    type: 'integer',
    auto: true,
    writeOnce: true
  };
  let [options] = args;
  let featureExtra = {};

  if (options) {
    if (typeof options === 'string') {
      options = {
        name: options
      };
    }

    if (options.type) {
      switch (options.type) {
        case 'integer':
          if (options.startFrom) {
            featureExtra.startFrom = options.startFrom;
          }

          break;

        case 'uuid':
          typeInfo['type'] = 'text';
          typeInfo['fixedLength'] = 36;
          typeInfo['generator'] = 'uuid';
          break;

        case 'shortid':
          typeInfo['type'] = 'text';
          typeInfo['generator'] = 'shortid';
          break;

        case 'uniqid':
          typeInfo['type'] = 'text';

          if (options.prefix) {
            if (typeof options.prefix !== 'string') {
              throw new Error(`"prefix" option should be a string. Entity: ${entity.name}, feature: autoId`);
            }

            typeInfo['fixedLength'] = 17 + options.prefix.length;
            typeInfo['generator'] = ['uniqid', options.prefix];
          } else {
            typeInfo['fixedLength'] = 17;
            typeInfo['generator'] = 'uniqid';
          }

          break;

        case 'hyperid':
          typeInfo['type'] = 'text';
          typeInfo['fixedLength'] = 33;
          let args = ['hyperid'];
          let opt = {};

          if (options.fixedLength) {
            opt.fixedLength = options.fixedLength;
          }

          if (options.urlSafe) {
            opt.urlSafe = options.urlSafe;
          }

          if (!_.isEmpty(opt)) {
            args.push(opt);
          }

          typeInfo['generator'] = args.length > 1 ? args : args[0];
          break;

        default:
          throw new Error(`Unsupported autoId type: ${options.type}. Entity: ${entity.name}`);
      }
    } else {
      if (options.startFrom) {
        featureExtra.startFrom = options.startFrom;
      }
    }

    if (options.name) {
      typeInfo.name = options.name;
    }
  }

  let fieldName = typeInfo.name;
  entity.addFeature(FEATURE_NAME, {
    field: fieldName,
    ...featureExtra
  }).on('beforeAddingFields', () => {
    entity.addField(fieldName, typeInfo).setKey(fieldName);
  });
}

module.exports = feature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5nL2VudGl0eUZlYXR1cmVzL2F1dG9JZC5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsIkZFQVRVUkVfTkFNRSIsImZlYXR1cmUiLCJlbnRpdHkiLCJhcmdzIiwidHlwZUluZm8iLCJuYW1lIiwidHlwZSIsImF1dG8iLCJ3cml0ZU9uY2UiLCJvcHRpb25zIiwiZmVhdHVyZUV4dHJhIiwic3RhcnRGcm9tIiwicHJlZml4IiwiRXJyb3IiLCJsZW5ndGgiLCJvcHQiLCJmaXhlZExlbmd0aCIsInVybFNhZmUiLCJpc0VtcHR5IiwicHVzaCIsImZpZWxkTmFtZSIsImFkZEZlYXR1cmUiLCJmaWVsZCIsIm9uIiwiYWRkRmllbGQiLCJzZXRLZXkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFFQSxNQUFNQyxZQUFZLEdBQUcsUUFBckI7O0FBY0EsU0FBU0MsT0FBVCxDQUFpQkMsTUFBakIsRUFBeUJDLElBQUksR0FBRyxFQUFoQyxFQUFvQztBQUNoQyxNQUFJQyxRQUFRLEdBQUc7QUFDWEMsSUFBQUEsSUFBSSxFQUFFLElBREs7QUFFWEMsSUFBQUEsSUFBSSxFQUFFLFNBRks7QUFHWEMsSUFBQUEsSUFBSSxFQUFFLElBSEs7QUFJWEMsSUFBQUEsU0FBUyxFQUFFO0FBSkEsR0FBZjtBQU9BLE1BQUksQ0FBRUMsT0FBRixJQUFjTixJQUFsQjtBQUVBLE1BQUlPLFlBQVksR0FBRyxFQUFuQjs7QUFFQSxNQUFJRCxPQUFKLEVBQWE7QUFDVCxRQUFJLE9BQU9BLE9BQVAsS0FBbUIsUUFBdkIsRUFBaUM7QUFDN0JBLE1BQUFBLE9BQU8sR0FBRztBQUFFSixRQUFBQSxJQUFJLEVBQUVJO0FBQVIsT0FBVjtBQUNIOztBQUVELFFBQUlBLE9BQU8sQ0FBQ0gsSUFBWixFQUFrQjtBQUNkLGNBQVFHLE9BQU8sQ0FBQ0gs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QUFrQnJCLFlBQWxCLEVBQWdDO0FBQzVCc0IsSUFBQUEsS0FBSyxFQUFFRixTQURxQjtBQUU1QixPQUFHVjtBQUZ5QixHQUFoQyxFQUdHYSxFQUhILENBR00sb0JBSE4sRUFHNEIsTUFBTTtBQUM5QnJCLElBQUFBLE1BQU0sQ0FBQ3NCLFFBQVAsQ0FBZ0JKLFNBQWhCLEVBQTJCaEIsUUFBM0IsRUFDS3FCLE1BREwsQ0FDWUwsU0FEWjtBQUVILEdBTkQ7QUFPSDs7QUFFRE0sTUFBTSxDQUFDQyxPQUFQLEdBQWlCMUIsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jb25zdCBGRUFUVVJFX05BTUUgPSAnYXV0b0lkJztcblxuLyoqXG4gKiBBIHJ1bGUgc3BlY2lmaWVzIHRoZSBpZCBvZiBlbnRpdHkgaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQuXG4gKiBAbW9kdWxlIEVudGl0eUZlYXR1cmVfQXV0b0lkXG4gKi9cblxuLyoqXG4gKiBJbml0aWFsaXplIHRoZSBmZWF0dXJlXG4gKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZW50aXR5IC0gRW50aXR5IHRvIGFwcGx5IHRoaXMgZmVhdHVyZVxuICogQHBhcmFtIHthcnJheX0gb3B0aW9ucyAtIEF1dG8gaWQgZmllbGQgb3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLm5hbWU9J2lkJ10gLSBGaWVsZCBuYW1lXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMudHlwZT0naW50ZWdlciddIC0gRmllbGQgdHlwZVxuICovXG5mdW5jdGlvbiBmZWF0dXJlKGVudGl0eSwgYXJncyA9IFtdKSB7XG4gICAgbGV0IHR5cGVJbmZvID0ge1xuICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICB0eXBlOiAnaW50ZWdlcicsXG4gICAgICAgIGF1dG86IHRydWUsICAgICAgICBcbiAgICAgICAgd3JpdGVPbmNlOiB0cnVlXG4gICAgfTtcblxuICAgIGxldCBbIG9wdGlvbnMgXSA9IGFyZ3M7XG5cbiAgICBsZXQgZmVhdHVyZUV4dHJhID0ge307XG5cbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBvcHRpb25zID0geyBuYW1lOiBvcHRpb25zIH07XG4gICAgICAgIH0gICAgICAgIFxuXG4gICAgICAgIGlmIChvcHRpb25zLnR5cGUpIHtcbiAgICAgICAgICAgIHN3aXRjaCAob3B0aW9ucy50eXBlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAnaW50ZWdlcic6XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0YXJ0RnJvbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZUV4dHJhLnN0YXJ0RnJvbSA9IG9wdGlvbnMuc3RhcnRGcm9tO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICBjYXNlICd1dWlkJzpcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ3R5cGUnXSA9ICd0ZXh0JztcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2ZpeGVkTGVuZ3RoJ10gPSAzNjtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2dlbmVyYXRvciddID0gJ3V1aWQnO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnc2hvcnRpZCc6XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWyd0eXBlJ10gPSAndGV4dCc7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydnZW5lcmF0b3InXSA9ICdzaG9ydGlkJztcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgIGNhc2UgJ3VuaXFpZCc6XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWyd0eXBlJ10gPSAndGV4dCc7ICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5wcmVmaXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5wcmVmaXggIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInByZWZpeFwiIG9wdGlvbiBzaG91bGQgYmUgYSBzdHJpbmcuIEVudGl0eTogJHtlbnRpdHkubmFtZX0sIGZlYXR1cmU6IGF1dG9JZGApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSAgICBcblxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2ZpeGVkTGVuZ3RoJ10gPSAxNyArIG9wdGlvbnMucHJlZml4Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWydnZW5lcmF0b3InXSA9IFsgJ3VuaXFpZCcsIG9wdGlvbnMucHJlZml4IF07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snZml4ZWRMZW5ndGgnXSA9IDE3O1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2dlbmVyYXRvciddID0gJ3VuaXFpZCc7XG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICAgICAgY2FzZSAnaHlwZXJpZCc6XG4gICAgICAgICAgICAgICAgICAgIHR5cGVJbmZvWyd0eXBlJ10gPSAndGV4dCc7ICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdHlwZUluZm9bJ2ZpeGVkTGVuZ3RoJ10gPSAzMztcblxuICAgICAgICAgICAgICAgICAgICBsZXQgYXJncyA9IFsgJ2h5cGVyaWQnIF07XG4gICAgICAgICAgICAgICAgICAgIGxldCBvcHQgPSB7fTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5maXhlZExlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmZpeGVkTGVuZ3RoID0gb3B0aW9ucy5maXhlZExlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnVybFNhZmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC51cmxTYWZlID0gb3B0aW9ucy51cmxTYWZlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFfLmlzRW1wdHkob3B0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKG9wdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0eXBlSW5mb1snZ2VuZXJhdG9yJ10gPSBhcmdzLmxlbmd0aCA+IDEgPyBhcmdzIDogYXJnc1swXTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgYXV0b0lkIHR5cGU6ICR7b3B0aW9ucy50eXBlfS4gRW50aXR5OiAke2VudGl0eS5uYW1lfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RhcnRGcm9tKSB7XG4gICAgICAgICAgICAgICAgZmVhdHVyZUV4dHJhLnN0YXJ0RnJvbSA9IG9wdGlvbnMuc3RhcnRGcm9tO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IFxuICAgICAgICBcbiAgICAgICAgaWYgKG9wdGlvbnMubmFtZSkge1xuICAgICAgICAgICAgdHlwZUluZm8ubmFtZSA9IG9wdGlvbnMubmFtZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxldCBmaWVsZE5hbWUgPSB0eXBlSW5mby5uYW1lO1xuXG4gICAgZW50aXR5LmFkZEZlYXR1cmUoRkVBVFVSRV9OQU1FLCB7XG4gICAgICAgIGZpZWxkOiBmaWVsZE5hbWUsXG4gICAgICAgIC4uLmZlYXR1cmVFeHRyYSAgICAgICAgXG4gICAgfSkub24oJ2JlZm9yZUFkZGluZ0ZpZWxkcycsICgpID0+IHtcbiAgICAgICAgZW50aXR5LmFkZEZpZWxkKGZpZWxkTmFtZSwgdHlwZUluZm8pXG4gICAgICAgICAgICAuc2V0S2V5KGZpZWxkTmFtZSk7XG4gICAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmVhdHVyZTsiXX0=