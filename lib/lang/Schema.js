"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  generateDisplayName,
  deepCloneField,
  Clonable,
  schemaNaming
} = require('./OolUtils');

class Schema extends Clonable {
  constructor(linker, name, oolModule, info) {
    super();
    this.entities = {};
    this.datasets = {};
    this.views = {};
    this.linker = linker;
    this.name = schemaNaming(name);
    this.oolModule = oolModule;
    this.info = info;
  }

  link() {
    if (!!this.linked) {
      throw new Error("Function  precondition failed: !this.linked");
    }

    this.linker.log('debug', 'Linking schema [' + this.name + '] ...');

    if (this.info.comment) {
      this.comment = this.info.comment;
    }

    this.displayName = this.comment || generateDisplayName(this.name);
    this.info.entities || (this.info.entities = []);
    this.info.entities.forEach(entityEntry => {
      let entity = this.linker.loadEntity(this.oolModule, entityEntry.entity);

      if (!entity.linked) {
        throw new Error("Assertion failed: entity.linked");
      }

      this.addEntity(entity);
    });

    if (!_.isEmpty(this.info.views)) {
      this.info.views.forEach(viewName => {
        this.linker.loadView(this.oolModule, viewName);

        if (!view.linked) {
          throw new Error("Assertion failed: view.linked");
        }

        this.addView(view);
      });
    }

    this.linked = true;
    return this;
  }

  hasEntity(entityName) {
    return entityName in this.entities;
  }

  addEntity(entity) {
    if (!!this.hasEntity(entity.name)) {
      throw new Error(`Entity name [${entity.name}] conflicts in schema [${this.name}].`);
    }

    this.entities[entity.name] = entity;
    return this;
  }

  hasView(viewName) {
    return viewName in this.views;
  }

  addView(view) {
    if (!!this.hasView(view.name)) {
      throw new Error(`View name [${view.name}] conflicts in schema [${this.name}].`);
    }

    this.views[view.name] = view;
    return this;
  }

  getDocumentHierachy(fromModule, datasetName) {
    if (datasetName in this.datasets) {
      return this.datasets[datasetName];
    }

    let dataset = this.linker.loadDataset(fromModule, datasetName);
    return this.datasets[datasetName] = dataset.buildHierarchy(this);
  }

  getReferencedEntity(refererModule, entityName) {
    let entity = this.linker.loadEntity(refererModule, entityName);

    if (!this.hasEntity(entity.name)) {
      throw new Error(`Entity "${entity.name}" not exists in schema "${this.name}".`);
    }

    return entity;
  }

  ensureGetEntity(refererModule, entityName, newlyAdded) {
    let entity = this.linker.loadEntity(refererModule, entityName);

    if (!this.hasEntity(entity.name)) {
      this.addEntity(entity);

      if (newlyAdded) {
        newlyAdded.push(entity);
      }
    }

    return entity;
  }

  clone() {
    super.clone();
    let schema = new Schema(this.linker, this.name, this.oolModule, this.info);
    deepCloneField(this, schema, 'displayName');
    deepCloneField(this, schema, 'comment');
    deepCloneField(this, schema, 'entities');
    deepCloneField(this, schema, 'datasets');
    deepCloneField(this, schema, 'views');
    schema.linked = true;
    return schema;
  }

  toJSON() {
    return {
      name: this.name,
      displayName: this.displayName,
      comment: this.comment,
      entities: _.mapValues(this.entities, entity => entity.toJSON()),
      datasets: _.mapValues(this.datasets, dataset => dataset.toJSON()),
      views: _.mapValues(this.views, view => view.toJSON())
    };
  }

}

module.exports = Schema;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL1NjaGVtYS5qcyJdLCJuYW1lcyI6WyJfIiwicmVxdWlyZSIsImdlbmVyYXRlRGlzcGxheU5hbWUiLCJkZWVwQ2xvbmVGaWVsZCIsIkNsb25hYmxlIiwic2NoZW1hTmFtaW5nIiwiU2NoZW1hIiwiY29uc3RydWN0b3IiLCJsaW5rZXIiLCJuYW1lIiwib29sTW9kdWxlIiwiaW5mbyIsImVudGl0aWVzIiwiZGF0YXNldHMiLCJ2aWV3cyIsImxpbmsiLCJsaW5rZWQiLCJsb2ciLCJjb21tZW50IiwiZGlzcGxheU5hbWUiLCJmb3JFYWNoIiwiZW50aXR5RW50cnkiLCJlbnRpdHkiLCJsb2FkRW50aXR5IiwiYWRkRW50aXR5IiwiaXNFbXB0eSIsInZpZXdOYW1lIiwibG9hZFZpZXciLCJ2aWV3IiwiYWRkVmlldyIsImhhc0VudGl0eSIsImVudGl0eU5hbWUiLCJoYXNWaWV3IiwiZ2V0RG9jdW1lbnRIaWVyYWNoeSIsImZyb21Nb2R1bGUiLCJkYXRhc2V0TmFtZSIsImRhdGFzZXQiLCJsb2FkRGF0YXNldCIsImJ1aWxkSGllcmFyY2h5IiwiZ2V0UmVmZXJlbmNlZEVudGl0eSIsInJlZmVyZXJNb2R1bGUiLCJFcnJvciIsImVuc3VyZUdldEVudGl0eSIsIm5ld2x5QWRkZWQiLCJwdXNoIiwiY2xvbmUiLCJzY2hlbWEiLCJ0b0pTT04iLCJtYXBWYWx1ZXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLG1CQUFGO0FBQXVCQyxFQUFBQSxjQUF2QjtBQUF1Q0MsRUFBQUEsUUFBdkM7QUFBaURDLEVBQUFBO0FBQWpELElBQWtFSixPQUFPLENBQUMsWUFBRCxDQUEvRTs7QUFNQSxNQUFNSyxNQUFOLFNBQXFCRixRQUFyQixDQUE4QjtBQXlCMUJHLEVBQUFBLFdBQVcsQ0FBQ0MsTUFB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QUFJLElBQUlBLElBQUksQ0FBQ21CLE1BQUwsRUFBaEM7QUFOSixLQUFQO0FBUUg7O0FBak95Qjs7QUFvTzlCRSxNQUFNLENBQUNDLE9BQVAsR0FBaUI1QyxNQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB7IF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IGdlbmVyYXRlRGlzcGxheU5hbWUsIGRlZXBDbG9uZUZpZWxkLCBDbG9uYWJsZSwgc2NoZW1hTmFtaW5nIH0gPSByZXF1aXJlKCcuL09vbFV0aWxzJyk7XG5cbi8qKlxuICogT29sb25nIHNjaGVtYSBjbGFzcy5cbiAqIEBjbGFzcyBPb2xvbmdTY2hlbWFcbiAqL1xuY2xhc3MgU2NoZW1hIGV4dGVuZHMgQ2xvbmFibGUge1xuICAgIC8qKlxuICAgICAqIEVudGl0aWVzIGluIHRoaXMgc2NoZW1hLCBtYXAgb2YgPGVudGl0eU5hbWUsIGVudGl0eU9iamVjdD5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgT29sb25nRW50aXR5Pn1cbiAgICAgKi9cbiAgICBlbnRpdGllcyA9IHt9O1xuXG4gICAgLyoqXG4gICAgICogRGF0YXNldHMsIGRhdGFzZXQgPSBlbnRpdHkgKyByZWxhdGlvbnMgKyBwcm9qZWN0aW9uXG4gICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAqL1xuICAgIGRhdGFzZXRzID0ge307XG5cbiAgICAvKipcbiAgICAgKiBWaWV3cywgdmlldyA9IGRhdGFzZXQgKyBmaWx0ZXJzIFxuICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgKi9cbiAgICB2aWV3cyA9IHt9OyAgICBcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtPb2xvbmdMaW5rZXJ9IGxpbmtlclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG9vbE1vZHVsZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbmZvXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobGlua2VyLCBuYW1lLCBvb2xNb2R1bGUsIGluZm8pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogTGlua2VyIHRvIHByb2Nlc3MgdGhpcyBzY2hlbWFcbiAgICAgICAgICogQG1lbWJlciB7T29sb25nTGlua2VyfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhpcyBlbnRpdHlcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5uYW1lID0gc2NoZW1hTmFtaW5nKG5hbWUpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBPd25lciBvb2xvbmcgbW9kdWxlXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub29sTW9kdWxlID0gb29sTW9kdWxlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSYXcgbWV0YWRhdGFcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IGxpbmtpbmcgdGhpcyBzY2hlbWFcbiAgICAgKiBAcmV0dXJucyB7U2NoZW1hfVxuICAgICAqL1xuICAgIGxpbmsoKSB7XG4gICAgICAgIHByZTogIXRoaXMubGlua2VkO1xuXG4gICAgICAgIHRoaXMubGlua2VyLmxvZygnZGVidWcnLCAnTGlua2luZyBzY2hlbWEgWycgKyB0aGlzLm5hbWUgKyAnXSAuLi4nKTtcblxuICAgICAgICBpZiAodGhpcy5pbmZvLmNvbW1lbnQpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSB0aGlzLmluZm8uY29tbWVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRpc3BsYXlOYW1lID0gdGhpcy5jb21tZW50IHx8IGdlbmVyYXRlRGlzcGxheU5hbWUodGhpcy5uYW1lKTtcblxuICAgICAgICAvLzFzdCByb3VuZCwgZ2V0IGRpcmVjdCBvdXRwdXQgZW50aXRpZXNcbiAgICAgICAgdGhpcy5pbmZvLmVudGl0aWVzIHx8ICh0aGlzLmluZm8uZW50aXRpZXMgPSBbXSk7XG5cbiAgICAgICAgdGhpcy5pbmZvLmVudGl0aWVzLmZvckVhY2goZW50aXR5RW50cnkgPT4geyAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGVudGl0eSA9IHRoaXMubGlua2VyLmxvYWRFbnRpdHkodGhpcy5vb2xNb2R1bGUsIGVudGl0eUVudHJ5LmVudGl0eSk7XG4gICAgICAgICAgICBhc3NlcnQ6IGVudGl0eS5saW5rZWQ7XG5cbiAgICAgICAgICAgIHRoaXMuYWRkRW50aXR5KGVudGl0eSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuaW5mby52aWV3cykpIHtcbiAgICAgICAgICAgIHRoaXMuaW5mby52aWV3cy5mb3JFYWNoKHZpZXdOYW1lID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxpbmtlci5sb2FkVmlldyh0aGlzLm9vbE1vZHVsZSwgdmlld05hbWUpO1xuICAgICAgICAgICAgICAgIGFzc2VydDogdmlldy5saW5rZWQ7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmFkZFZpZXcodmlldyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgZW50aXR5IHdpdGggZ2l2ZW4gbmFtZSBpcyBpbiB0aGUgc2NoZW1hXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVudGl0eU5hbWVcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNFbnRpdHkoZW50aXR5TmFtZSkge1xuICAgICAgICByZXR1cm4gKGVudGl0eU5hbWUgaW4gdGhpcy5lbnRpdGllcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGFuIGVudGl0eSBpbnRvIHRoZSBzY2hlbWFcbiAgICAgKiBAcGFyYW0ge09vbG9uZ0VudGl0eX0gZW50aXR5XG4gICAgICogQHJldHVybnMge09vbG9uZ1NjaGVtYX1cbiAgICAgKi9cbiAgICBhZGRFbnRpdHkoZW50aXR5KSB7XG4gICAgICAgIHByZTogIXRoaXMuaGFzRW50aXR5KGVudGl0eS5uYW1lKSwgYEVudGl0eSBuYW1lIFske2VudGl0eS5uYW1lfV0gY29uZmxpY3RzIGluIHNjaGVtYSBbJHt0aGlzLm5hbWV9XS5gO1xuXG4gICAgICAgIHRoaXMuZW50aXRpZXNbZW50aXR5Lm5hbWVdID0gZW50aXR5O1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSB2aWV3IHdpdGggZ2l2ZW4gbmFtZSBpcyBpbiB0aGUgc2NoZW1hXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHZpZXdOYW1lXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzVmlldyh2aWV3TmFtZSkge1xuICAgICAgICByZXR1cm4gKHZpZXdOYW1lIGluIHRoaXMudmlld3MpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBhIHZpZXcgaW50byB0aGUgc2NoZW1hXG4gICAgICogQHBhcmFtIHtPb2xvbmdWaWV3fSB2aWV3IFxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdTY2hlbWF9XG4gICAgICovXG4gICAgYWRkVmlldyh2aWV3KSB7XG4gICAgICAgIHByZTogIXRoaXMuaGFzVmlldyh2aWV3Lm5hbWUpLCBgVmlldyBuYW1lIFske3ZpZXcubmFtZX1dIGNvbmZsaWN0cyBpbiBzY2hlbWEgWyR7dGhpcy5uYW1lfV0uYDtcblxuICAgICAgICB0aGlzLnZpZXdzW3ZpZXcubmFtZV0gPSB2aWV3O1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIGRvY3VtZW50IGhpZXJhcmNoeVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBmcm9tTW9kdWxlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGFzZXROYW1lXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXREb2N1bWVudEhpZXJhY2h5KGZyb21Nb2R1bGUsIGRhdGFzZXROYW1lKSB7XG4gICAgICAgIGlmIChkYXRhc2V0TmFtZSBpbiB0aGlzLmRhdGFzZXRzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0c1tkYXRhc2V0TmFtZV07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZGF0YXNldCA9IHRoaXMubGlua2VyLmxvYWREYXRhc2V0KGZyb21Nb2R1bGUsIGRhdGFzZXROYW1lKTtcbiAgICAgICAgcmV0dXJuICh0aGlzLmRhdGFzZXRzW2RhdGFzZXROYW1lXSA9IGRhdGFzZXQuYnVpbGRIaWVyYXJjaHkodGhpcykpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgcmVmZXJlbmNlZCBlbnRpdHksIGFkZCBpdCBpbnRvIHNjaGVtYSBpZiBub3QgaW4gc2NoZW1hXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZmVyZXJNb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50aXR5TmFtZVxuICAgICAqIEByZXR1cm5zIHtPb2xvbmdFbnRpdHl9XG4gICAgICovXG4gICAgZ2V0UmVmZXJlbmNlZEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbnRpdHlOYW1lKSB7XG4gICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmxpbmtlci5sb2FkRW50aXR5KHJlZmVyZXJNb2R1bGUsIGVudGl0eU5hbWUpO1xuXG4gICAgICAgIGlmICghdGhpcy5oYXNFbnRpdHkoZW50aXR5Lm5hbWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudGl0eSBcIiR7ZW50aXR5Lm5hbWV9XCIgbm90IGV4aXN0cyBpbiBzY2hlbWEgXCIke3RoaXMubmFtZX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHsqfSByZWZlcmVyTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7Kn0gZW50aXR5TmFtZSBcbiAgICAgKi9cbiAgICBlbnN1cmVHZXRFbnRpdHkocmVmZXJlck1vZHVsZSwgZW50aXR5TmFtZSwgbmV3bHlBZGRlZCkge1xuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5saW5rZXIubG9hZEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbnRpdHlOYW1lKTtcblxuICAgICAgICBpZiAoIXRoaXMuaGFzRW50aXR5KGVudGl0eS5uYW1lKSkge1xuICAgICAgICAgICAgdGhpcy5hZGRFbnRpdHkoZW50aXR5KTsgICBcblxuICAgICAgICAgICAgaWYgKG5ld2x5QWRkZWQpIHtcbiAgICAgICAgICAgICAgICBuZXdseUFkZGVkLnB1c2goZW50aXR5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvbmUgdGhlIHNjaGVtYVxuICAgICAqIEByZXR1cm5zIHtTY2hlbWF9XG4gICAgICovXG4gICAgY2xvbmUoKSB7XG4gICAgICAgIHN1cGVyLmNsb25lKCk7XG4gICAgICAgIFxuICAgICAgICBsZXQgc2NoZW1hID0gbmV3IFNjaGVtYSh0aGlzLmxpbmtlciwgdGhpcy5uYW1lLCB0aGlzLm9vbE1vZHVsZSwgdGhpcy5pbmZvKTtcbiAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2Rpc3BsYXlOYW1lJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2NvbW1lbnQnKTsgICAgICAgIFxuICAgICAgICBkZWVwQ2xvbmVGaWVsZCh0aGlzLCBzY2hlbWEsICdlbnRpdGllcycpOyAgICAgICAgXG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ2RhdGFzZXRzJyk7XG4gICAgICAgIGRlZXBDbG9uZUZpZWxkKHRoaXMsIHNjaGVtYSwgJ3ZpZXdzJyk7ICAgICAgICBcblxuICAgICAgICBzY2hlbWEubGlua2VkID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gc2NoZW1hO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSB0aGUgc2NoZW1hIGludG8gYSBwbGFpbiBKU09OIG9iamVjdFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgdG9KU09OKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgICAgZGlzcGxheU5hbWU6IHRoaXMuZGlzcGxheU5hbWUsXG4gICAgICAgICAgICBjb21tZW50OiB0aGlzLmNvbW1lbnQsICAgICAgICBcbiAgICAgICAgICAgIGVudGl0aWVzOiBfLm1hcFZhbHVlcyh0aGlzLmVudGl0aWVzLCBlbnRpdHkgPT4gZW50aXR5LnRvSlNPTigpKSwgICAgICAgICAgICBcbiAgICAgICAgICAgIGRhdGFzZXRzOiBfLm1hcFZhbHVlcyh0aGlzLmRhdGFzZXRzLCBkYXRhc2V0ID0+IGRhdGFzZXQudG9KU09OKCkpLCBcbiAgICAgICAgICAgIHZpZXdzOiBfLm1hcFZhbHVlcyh0aGlzLnZpZXdzLCB2aWV3ID0+IHZpZXcudG9KU09OKCkpIFxuICAgICAgICB9O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTY2hlbWE7Il19