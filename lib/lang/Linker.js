"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  glob
} = require('rk-utils');

const Oolong = require('./grammar/oolong');

const OolongParser = Oolong.parser;

const OolTypes = require('./OolTypes');

const Types = require('../runtime/types');

const Entity = require('./Entity');

const Schema = require('./Schema');

const View = require('./View');

const Dataset = require('./Dataset');

const ELEMENT_CLASS_MAP = {
  [OolTypes.Element.ENTITY]: Entity,
  [OolTypes.Element.VIEW]: View,
  [OolTypes.Element.DATASET]: Dataset
};
const OOLONG_SOURCE_EXT = '.ool';
const BUILTINS_PATH = path.resolve(__dirname, 'builtins');

class Linker {
  static getOolongFiles(sourceDir, useJsonSource, recursive) {
    let pattern = '*' + OOLONG_SOURCE_EXT;

    if (useJsonSource) {
      pattern += '.json';
    }

    if (recursive) {
      pattern = '**/' + pattern;
    }

    return glob.sync(path.join(sourceDir, pattern), {
      nodir: true
    });
  }

  constructor(context) {
    this.logger = context.logger;
    this.sourcePath = context.dslSourcePath;
    this.useJsonSource = context.useJsonSource || false;
    this.saveIntermediate = context.saveIntermediate || false;
    this.schemas = {};
    this._oolModules = {};
    this._elementsCache = {};
    this._mapOfReferenceToModuleId = new Map();
  }

  log(level, message, data) {
    if (!this.logger) return;

    if (data) {
      this.logger.log(level, message, data);
    } else {
      this.logger.log(level, message);
    }
  }

  isModuleLoaded(moduleId) {
    return moduleId in this._oolModules;
  }

  getModuleById(moduleId) {
    return this._oolModules[moduleId];
  }

  link(entryFileName) {
    let entryModule = this.loadModule(entryFileName);

    if (!entryModule) {
      throw new Error(`Cannot resolve file "${entryFileName}".`);
    }

    if (_.isEmpty(entryModule.schema)) {
      throw new Error('No schema defined in entry file.');
    }

    _.forOwn(entryModule.schema, (schemaInfo, schemaName) => {
      let schema = new Schema(this, schemaName, entryModule, schemaInfo);
      schema.link();

      if (this.schemas.hasOwnProperty(schemaName)) {
        throw new Error(`Duplicate schema: "${schemaName}".`);
      }

      this.schemas[schemaName] = schema;

      if (this.saveIntermediate) {
        let jsFile = path.resolve(this.sourcePath, entryFileName + '-linked.json');
        fs.writeFileSync(jsFile, JSON.stringify(schema.toJSON(), null, 4));
      }
    });
  }

  loadModule(modulePath) {
    modulePath = path.resolve(this.sourcePath, modulePath);
    let id = this.getModuleIdByPath(modulePath);

    if (this.isModuleLoaded(id)) {
      return this.getModuleById(id);
    }

    if (!fs.existsSync(modulePath)) {
      return undefined;
    }

    let ool = this._compile(modulePath);

    return this._oolModules[id] = ool;
  }

  trackBackType(oolModule, info) {
    if (Types.Builtin.has(info.type)) {
      return info;
    }

    let baseInfo = this.loadElement(oolModule, OolTypes.Element.TYPE, info.type);

    if (!Types.Builtin.has(baseInfo.type)) {
      let uniqueId = this.getElementUniqueId(oolModule, OolTypes.Element.TYPE, value.name);
      let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
      let rootTypeInfo = this.trackBackType(ownerModule, baseInfo);
      ownerModule.type[baseInfo.type] = rootTypeInfo;
      baseInfo = rootTypeInfo;
    }

    let derivedInfo = { ..._.cloneDeep(_.omit(baseInfo, ['modifiers'])),
      ..._.omit(info, ['type', 'modifiers'])
    };

    if (baseInfo.modifiers || info.modifiers) {
      derivedInfo.modifiers = [...(baseInfo.modifiers || []), ...(info.modifiers || [])];
    }

    if (!derivedInfo.subClass) {
      derivedInfo.subClass = [];
    }

    derivedInfo.subClass.push(info.type);
    return derivedInfo;
  }

  translateOolValue(oolModule, value) {
    if (_.isPlainObject(value)) {
      if (value.oolType === OolTypes.Lang.CONST_REF) {
        let refedValue = this.loadElement(oolModule, OolTypes.Element.CONST, value.name);
        let uniqueId = this.getElementUniqueId(oolModule, OolTypes.Element.CONST, value.name);
        let ownerModule = this.getModuleById(this._mapOfReferenceToModuleId.get(uniqueId));
        return this.translateOolValue(ownerModule, refedValue);
      } else if (value.oolType) {
        throw new Error(`todo: translateOolValue with type: ${value.oolType}`);
      }

      return _.mapValues(value, v => this.translateOolValue(oolModule, v));
    }

    if (Array.isArray(value)) {
      return value.map(v => this.translateOolValue(oolModule, v));
    }

    return value;
  }

  getModuleIdByPath(modulePath) {
    let isBuiltinEntity = _.startsWith(modulePath, BUILTINS_PATH);

    return isBuiltinEntity ? path.relative(BUILTINS_PATH, modulePath) : './' + path.relative(this.sourcePath, modulePath);
  }

  getElementUniqueId(refererModule, elementType, elementName) {
    return elementType + ':' + elementName + '<-' + refererModule.id;
  }

  loadEntity(refererModule, elementName) {
    let entity = this.loadElement(refererModule, OolTypes.Element.ENTITY, elementName);

    if (_.isEmpty(entity.fields)) {
      throw new Error(`Entity "${elementName}" has no any fields defined.`);
    }

    return entity;
  }

  loadType(refererModule, elementName) {
    return this.loadElement(refererModule, OolTypes.Element.TYPE, elementName);
  }

  loadDataset(refererModule, elementName) {
    return this.loadElement(refererModule, OolTypes.Element.DATASET, elementName);
  }

  loadView(refererModule, elementName) {
    return this.loadElement(refererModule, OolTypes.Element.VIEW, elementName);
  }

  loadElement(refererModule, elementType, elementName) {
    let uniqueId = this.getElementUniqueId(refererModule, elementType, elementName);

    if (uniqueId in this._elementsCache) {
      return this._elementsCache[uniqueId];
    }

    let targetModule;

    if (elementType in refererModule && elementName in refererModule[elementType]) {
      targetModule = refererModule;
    } else {
      this.log('verbose', `Searching ${elementType} "${elementName}" from "${refererModule.id}" ...`);

      let index = _.findLastIndex(refererModule.namespace, modulePath => {
        targetModule = this.loadModule(modulePath);
        return targetModule && targetModule[elementType] && elementName in targetModule[elementType];
      });

      if (index === -1) {
        throw new Error(`${elementType} "${elementName}" not found in imported namespaces. Referer: ${refererModule.id}`);
      }
    }

    this.log('verbose', `Found ${elementType} "${elementName}" in "${targetModule.id}". [OK]`);
    let elementSelfId = elementType + ':' + elementName + '@' + targetModule.id;

    if (elementSelfId in this._elementsCache) {
      return this._elementsCache[uniqueId] = this._elementsCache[elementSelfId];
    }

    if (!!this._mapOfReferenceToModuleId.has(uniqueId)) {
      throw new Error(`${elementType} "${elementName}" in "${targetModule.id}" conflicts with ${elementType} in "${this._mapOfReferenceToModuleId.get(uniqueId)}"!`);
    }

    this._mapOfReferenceToModuleId.set(uniqueId, targetModule.id);

    let elementInfo = Object.freeze(targetModule[elementType][elementName]);
    let element;

    if (elementType in ELEMENT_CLASS_MAP) {
      let ElementClass = ELEMENT_CLASS_MAP[elementType];
      element = new ElementClass(this, elementName, targetModule, elementInfo);
      element.link();
    } else {
      element = elementInfo;
    }

    this._elementsCache[elementSelfId] = element;
    this._elementsCache[uniqueId] = element;
    return element;
  }

  _compile(oolFile) {
    let jsFile;

    if (oolFile.endsWith('.json')) {
      jsFile = oolFile;
      oolFile = oolFile.substr(0, oolFile.length - 5);
    } else {
      jsFile = oolFile + '.json';
    }

    let ool, searchExt;

    if (this.useJsonSource) {
      if (!fs.existsSync(jsFile)) {
        throw new Error(`"useJsonSource" enabeld but json file "${jsFile}" not found.`);
      }

      ool = fs.readJsonSync(jsFile);
      searchExt = OOLONG_SOURCE_EXT + '.json';
    } else {
      this.log('debug', 'Compiling ' + oolFile + ' ...');

      try {
        ool = OolongParser.parse(fs.readFileSync(oolFile, 'utf8'));
      } catch (error) {
        throw new Error(`Failed to compile "${oolFile}".\n${error.message || error}`);
      }

      if (!ool) {
        throw new Error('Unknown error occurred while compiling.');
      }

      searchExt = OOLONG_SOURCE_EXT;
    }

    let baseName = path.basename(oolFile, OOLONG_SOURCE_EXT);
    let namespace = [];
    let currentPath = path.dirname(oolFile);

    function expandNs(namespaces, ns, recursive) {
      let stats = fs.statSync(ns);

      if (stats.isFile() && ns.endsWith(searchExt)) {
        namespaces.push(ns);
        return;
      }

      if (stats.isDirectory() && recursive) {
        let files = fs.readdirSync(ns);
        files.forEach(f => expandNs(namespaces, path.join(ns, f), true));
      }
    }

    if (ool.namespace) {
      ool.namespace.forEach(ns => {
        let p;

        if (ns.startsWith('<oolong>/')) {
          ns = path.join(BUILTINS_PATH, ns.substr(9));
        } else if (ns.startsWith('<source>/')) {
          ns = path.join(this.sourcePath, ns.substr(9));
        }

        if (ns.endsWith('/*')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 2));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), false));
        } else if (ns.endsWith('/**')) {
          p = path.resolve(currentPath, ns.substr(0, ns.length - 3));
          let files = fs.readdirSync(p);
          files.forEach(f => expandNs(namespace, path.join(p, f), true));
        } else {
          namespace.push(path.resolve(currentPath, _.endsWith(ns, OOLONG_SOURCE_EXT) ? ns : ns + OOLONG_SOURCE_EXT));
        }
      });
    }

    ool.namespace = namespace;
    ool.id = this.getModuleIdByPath(oolFile);
    ool.name = baseName;

    if (!this.useJsonSource && this.saveIntermediate) {
      fs.writeFileSync(jsFile, JSON.stringify(ool, null, 4));
    }

    return ool;
  }

}

module.exports = Linker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL0xpbmtlci5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImdsb2IiLCJPb2xvbmciLCJPb2xvbmdQYXJzZXIiLCJwYXJzZXIiLCJPb2xUeXBlcyIsIlR5cGVzIiwiRW50aXR5IiwiU2NoZW1hIiwiVmlldyIsIkRhdGFzZXQiLCJFTEVNRU5UX0NMQVNTX01BUCIsIkVsZW1lbnQiLCJFTlRJVFkiLCJWSUVXIiwiREFUQVNFVCIsIk9PTE9OR19TT1VSQ0VfRVhUIiwiQlVJTFRJTlNfUEFUSCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJMaW5rZXIiLCJnZXRPb2xvbmdGaWxlcyIsInNvdXJjZURpciIsInVzZUpzb25Tb3VyY2UiLCJyZWN1cnNpdmUiLCJwYXR0ZXJuIiwic3luYyIsImpvaW4iLCJub2RpciIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsImxvZ2dlciIsInNvdXJjZVBhdGgiLCJkc2xTb3VyY2VQYXRoIiwic2F2ZUludGVybWVkaWF0ZSIsInNjaGVtYXMiLCJfb29sTW9kdWxlcyIsIl9lbGVtZW50c0NhY2hlIiwiX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZCIsIk1hcCIsImxvZyIsImxldmVsIiwibWVzc2FnZSIsImRhdGEiLCJpc01vZHVsZUxvYWRlZCIsIm1vZHVsZUlkIiwiZ2V0TW9kdWxlQnlJZCIsImxpbmsiLCJlbnRyeUZpbGVOYW1lIiwiZW50cnlNb2R1bGUiLCJsb2FkTW9kdWxlIiwiRXJyb3IiLCJpc0VtcHR5Iiwic2NoZW1hIiwiZm9yT3duIiwic2NoZW1hSW5mbyIsInNjaGVtYU5hbWUiLCJoYXNPd25Qcm9wZXJ0eSIsImpzRmlsZSIsIndyaXRlRmlsZVN5bmMiLCJKU09OIiwic3RyaW5naWZ5IiwidG9KU09OIiwibW9kdWxlUGF0aCIsImlkIiwiZ2V0TW9kdWxlSWRCeVBhdGgiLCJleGlzdHNTeW5jIiwidW5kZWZpbmVkIiwib29sIiwiX2NvbXBpbGUiLCJ0cmFja0JhY2tUeXBlIiwib29sTW9kdWxlIiwiaW5mbyIsIkJ1aWx0aW4iLCJoYXMiLCJ0eXBlIiwiYmFzZUluZm8iLCJsb2FkRWxlbWVudCIsIlRZUEUiLCJ1bmlxdWVJZCIsImdldEVsZW1lbnRVbmlxdWVJZCIsInZhbHVlIiwibmFtZSIsIm93bmVyTW9kdWxlIiwiZ2V0Iiwicm9vdFR5cGVJbmZvIiwiZGVyaXZlZEluZm8iLCJjbG9uZURlZXAiLCJvbWl0IiwibW9kaWZpZXJzIiwic3ViQ2xhc3MiLCJwdXNoIiwidHJhbnNsYXRlT29sVmFsdWUiLCJpc1BsYWluT2JqZWN0Iiwib29sVHlwZSIsIkxhbmciLCJDT05TVF9SRUYiLCJyZWZlZFZhbHVlIiwiQ09OU1QiLCJtYXBWYWx1ZXMiLCJ2IiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXNCdWlsdGluRW50aXR5Iiwic3RhcnRzV2l0aCIsInJlbGF0aXZlIiwicmVmZXJlck1vZHVsZSIsImVsZW1lbnRUeXBlIiwiZWxlbWVudE5hbWUiLCJsb2FkRW50aXR5IiwiZW50aXR5IiwiZmllbGRzIiwibG9hZFR5cGUiLCJsb2FkRGF0YXNldCIsImxvYWRWaWV3IiwidGFyZ2V0TW9kdWxlIiwiaW5kZXgiLCJmaW5kTGFzdEluZGV4IiwibmFtZXNwYWNlIiwiZWxlbWVudFNlbGZJZCIsInNldCIsImVsZW1lbnRJbmZvIiwiT2JqZWN0IiwiZnJlZXplIiwiZWxlbWVudCIsIkVsZW1lbnRDbGFzcyIsIm9vbEZpbGUiLCJlbmRzV2l0aCIsInN1YnN0ciIsImxlbmd0aCIsInNlYXJjaEV4dCIsInJlYWRKc29uU3luYyIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiZXJyb3IiLCJiYXNlTmFtZSIsImJhc2VuYW1lIiwiY3VycmVudFBhdGgiLCJkaXJuYW1lIiwiZXhwYW5kTnMiLCJuYW1lc3BhY2VzIiwibnMiLCJzdGF0cyIsInN0YXRTeW5jIiwiaXNGaWxlIiwiaXNEaXJlY3RvcnkiLCJmaWxlcyIsInJlYWRkaXJTeW5jIiwiZm9yRWFjaCIsImYiLCJwIiwibW9kdWxlIiwiZXhwb3J0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QUFoQyxFQUFrRDtBQUM5Q2xDLE1BQUFBLEVBQUUsQ0FBQzJELGFBQUgsQ0FBaUJELE1BQWpCLEVBQXlCRSxJQUFJLENBQUNDLFNBQUwsQ0FBZU8sR0FBZixFQUFvQixJQUFwQixFQUEwQixDQUExQixDQUF6QjtBQUNIOztBQUVELFdBQU9BLEdBQVA7QUFDSDs7QUFyYlE7O0FBd2Jib0YsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckksTUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGdsb2IgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmNvbnN0IE9vbG9uZyA9IHJlcXVpcmUoJy4vZ3JhbW1hci9vb2xvbmcnKTtcbmNvbnN0IE9vbG9uZ1BhcnNlciA9IE9vbG9uZy5wYXJzZXI7XG5jb25zdCBPb2xUeXBlcyA9IHJlcXVpcmUoJy4vT29sVHlwZXMnKTtcbmNvbnN0IFR5cGVzID0gcmVxdWlyZSgnLi4vcnVudGltZS90eXBlcycpO1xuXG5jb25zdCBFbnRpdHkgPSByZXF1aXJlKCcuL0VudGl0eScpO1xuY29uc3QgU2NoZW1hID0gcmVxdWlyZSgnLi9TY2hlbWEnKTtcbmNvbnN0IFZpZXcgPSByZXF1aXJlKCcuL1ZpZXcnKTtcbmNvbnN0IERhdGFzZXQgPSByZXF1aXJlKCcuL0RhdGFzZXQnKTtcblxuY29uc3QgRUxFTUVOVF9DTEFTU19NQVAgPSB7XG4gICAgW09vbFR5cGVzLkVsZW1lbnQuRU5USVRZXTogRW50aXR5LFxuICAgIFtPb2xUeXBlcy5FbGVtZW50LlZJRVddOiBWaWV3LFxuICAgIFtPb2xUeXBlcy5FbGVtZW50LkRBVEFTRVRdOiBEYXRhc2V0LFxufTtcblxuY29uc3QgT09MT05HX1NPVVJDRV9FWFQgPSAnLm9vbCc7XG5jb25zdCBCVUlMVElOU19QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJ2J1aWx0aW5zJyk7XG5cbi8qKlxuICogTGlua2VyIG9mIG9vbG9uZyBEU0xcbiAqIEBjbGFzcyBPb2xvbmdMaW5rZXJcbiAqL1xuY2xhc3MgTGlua2VyIHtcbiAgICBzdGF0aWMgZ2V0T29sb25nRmlsZXMoc291cmNlRGlyLCB1c2VKc29uU291cmNlLCByZWN1cnNpdmUpIHtcbiAgICAgICAgbGV0IHBhdHRlcm4gPSAnKicgKyBPT0xPTkdfU09VUkNFX0VYVDtcblxuICAgICAgICBpZiAodXNlSnNvblNvdXJjZSkge1xuICAgICAgICAgICAgcGF0dGVybiArPSAnLmpzb24nO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlY3Vyc2l2ZSkge1xuICAgICAgICAgICAgcGF0dGVybiA9ICcqKi8nICsgcGF0dGVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBnbG9iLnN5bmMocGF0aC5qb2luKHNvdXJjZURpciwgcGF0dGVybiksIHtub2RpcjogdHJ1ZX0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmRzbFNvdXJjZVBhdGggLSBPb2xvbmcgc291cmNlIGZpbGVzIHBhdGggICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NvbnRleHQudXNlSnNvblNvdXJjZT1mYWxzZV0gLSBVc2UgLmpzb24gaW50ZXJtZWRpYXRlIHNvdXJjZSBmaWxlIGluc3RlYWQgb2YgLm9vbFxuICAgICAqIEBwcm9wZXJ0eSB7Ym9vbH0gW2NvbnRleHQuc2F2ZUludGVybWVkaWF0ZT1mYWxzZV0gLSBTYXZlIGludGVybWVkaWF0ZSBzb3VyY2UgZmlsZSB3aGlsZSBsaW5raW5nXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29udGV4dCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9nZ2VyXG4gICAgICAgICAqIEBtZW1iZXIge0xvZ2dlcn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMubG9nZ2VyID0gY29udGV4dC5sb2dnZXI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE9vbG9uZyBzb3VyY2UgZmlsZXMgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNvdXJjZVBhdGggPSBjb250ZXh0LmRzbFNvdXJjZVBhdGg7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVzZSBqc29uIG9yIG9sc1xuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy51c2VKc29uU291cmNlID0gY29udGV4dC51c2VKc29uU291cmNlIHx8IGZhbHNlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTYXZlIGludGVybWVkaWF0ZSBmaWxlc1xuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zYXZlSW50ZXJtZWRpYXRlID0gY29udGV4dC5zYXZlSW50ZXJtZWRpYXRlIHx8IGZhbHNlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMaW5rZWQgc2NoZW1hc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3QuPHN0cmluZywgU2NoZW1hPn1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2NoZW1hcyA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBQYXJzZWQgb29sb25nIGZpbGVzLCBwYXRoID0+IG1vZHVsZVxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9vb2xNb2R1bGVzID0ge307XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEVsZW1lbnQgY2FjaGUsIG1hcCBvZiA8cmVmZXJlbmNlSWQsIGVsZW1lbnQ+IGFuZCA8c2VsZklkLCBlbGVtZW50PlxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9IFxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZSA9IHt9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBNYXAgb2YgPHJlZmVyZW5jZUlkLCBtb2R1bGVJZD5cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fbWFwT2ZSZWZlcmVuY2VUb01vZHVsZUlkID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdyaXRlIGxvZ1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtZXNzYWdlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtkYXRhXVxuICAgICAqL1xuICAgIGxvZyhsZXZlbCwgbWVzc2FnZSwgZGF0YSkge1xuICAgICAgICBpZiAoIXRoaXMubG9nZ2VyKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZyhsZXZlbCwgbWVzc2FnZSwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2cobGV2ZWwsIG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIG1vZHVsZSBpcyBsb2FkZWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlSWRcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBpc01vZHVsZUxvYWRlZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gbW9kdWxlSWQgaW4gdGhpcy5fb29sTW9kdWxlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBsb2FkZWQgb29sb25lIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVJZFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0TW9kdWxlQnlJZChtb2R1bGVJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fb29sTW9kdWxlc1ttb2R1bGVJZF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgbGlua2luZyBvb2xvbmcgZmlsZXNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZW50cnlGaWxlTmFtZVxuICAgICAqL1xuICAgIGxpbmsoZW50cnlGaWxlTmFtZSkge1xuICAgICAgICAvL2NvbXBpbGUgZW50cnkgZmlsZSAgICAgICAgXG4gICAgICAgIGxldCBlbnRyeU1vZHVsZSA9IHRoaXMubG9hZE1vZHVsZShlbnRyeUZpbGVOYW1lKTtcblxuICAgICAgICBpZiAoIWVudHJ5TW9kdWxlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZXNvbHZlIGZpbGUgXCIke2VudHJ5RmlsZU5hbWV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXy5pc0VtcHR5KGVudHJ5TW9kdWxlLnNjaGVtYSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2NoZW1hIGRlZmluZWQgaW4gZW50cnkgZmlsZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF8uZm9yT3duKGVudHJ5TW9kdWxlLnNjaGVtYSwgKHNjaGVtYUluZm8sIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgICAgIGxldCBzY2hlbWEgPSBuZXcgU2NoZW1hKHRoaXMsIHNjaGVtYU5hbWUsIGVudHJ5TW9kdWxlLCBzY2hlbWFJbmZvKTtcbiAgICAgICAgICAgIHNjaGVtYS5saW5rKCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnNjaGVtYXMuaGFzT3duUHJvcGVydHkoc2NoZW1hTmFtZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBzY2hlbWE6IFwiJHtzY2hlbWFOYW1lfVwiLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zY2hlbWFzW3NjaGVtYU5hbWVdID0gc2NoZW1hO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5zYXZlSW50ZXJtZWRpYXRlKSB7XG4gICAgICAgICAgICAgICAgbGV0IGpzRmlsZSA9IHBhdGgucmVzb2x2ZSh0aGlzLnNvdXJjZVBhdGgsIGVudHJ5RmlsZU5hbWUgKyAnLWxpbmtlZC5qc29uJyk7XG4gICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhqc0ZpbGUsIEpTT04uc3RyaW5naWZ5KHNjaGVtYS50b0pTT04oKSwgbnVsbCwgNCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExvYWQgYSBvb2xvbmcgbW9kdWxlLCByZXR1cm4gdW5kZWZpbmVkIGlmIG5vdCBleGlzdFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVQYXRoXG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICovXG4gICAgbG9hZE1vZHVsZShtb2R1bGVQYXRoKSB7ICAgICAgICBcbiAgICAgICAgbW9kdWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnNvdXJjZVBhdGgsIG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIGxldCBpZCA9IHRoaXMuZ2V0TW9kdWxlSWRCeVBhdGgobW9kdWxlUGF0aCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNNb2R1bGVMb2FkZWQoaWQpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRNb2R1bGVCeUlkKGlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2R1bGVQYXRoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBvb2wgPSB0aGlzLl9jb21waWxlKG1vZHVsZVBhdGgpO1xuXG4gICAgICAgIHJldHVybiAodGhpcy5fb29sTW9kdWxlc1tpZF0gPSBvb2wpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYWNrIGJhY2sgdGhlIHR5cGUgZGVyaXZlZCBjaGFpbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gb29sTW9kdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGluZm9cbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIHRyYWNrQmFja1R5cGUob29sTW9kdWxlLCBpbmZvKSB7XG4gICAgICAgIGlmIChUeXBlcy5CdWlsdGluLmhhcyhpbmZvLnR5cGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gaW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlSW5mbyA9IHRoaXMubG9hZEVsZW1lbnQob29sTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LlRZUEUsIGluZm8udHlwZSk7XG5cbiAgICAgICAgaWYgKCFUeXBlcy5CdWlsdGluLmhhcyhiYXNlSW5mby50eXBlKSkge1xuICAgICAgICAgICAgLy90aGUgYmFzZSB0eXBlIGlzIG5vdCBhIGJ1aWx0aW4gdHlwZVxuICAgICAgICAgICAgbGV0IHVuaXF1ZUlkID0gdGhpcy5nZXRFbGVtZW50VW5pcXVlSWQob29sTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LlRZUEUsIHZhbHVlLm5hbWUpO1xuICAgICAgICAgICAgbGV0IG93bmVyTW9kdWxlID0gdGhpcy5nZXRNb2R1bGVCeUlkKHRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5nZXQodW5pcXVlSWQpKTtcbiAgICAgICAgICAgIGxldCByb290VHlwZUluZm8gPSB0aGlzLnRyYWNrQmFja1R5cGUob3duZXJNb2R1bGUsIGJhc2VJbmZvKTtcbiAgICAgICAgICAgIG93bmVyTW9kdWxlLnR5cGVbYmFzZUluZm8udHlwZV0gPSByb290VHlwZUluZm87XG4gICAgICAgICAgICBiYXNlSW5mbyA9IHJvb3RUeXBlSW5mbztcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkZXJpdmVkSW5mbyA9IHsgLi4uXy5jbG9uZURlZXAoXy5vbWl0KGJhc2VJbmZvLCBbJ21vZGlmaWVycyddKSksIC4uLl8ub21pdChpbmZvLCBbJ3R5cGUnLCAnbW9kaWZpZXJzJ10pfTtcbiAgICAgICAgaWYgKGJhc2VJbmZvLm1vZGlmaWVycyB8fCBpbmZvLm1vZGlmaWVycykge1xuICAgICAgICAgICAgZGVyaXZlZEluZm8ubW9kaWZpZXJzID0gWyAuLi4oYmFzZUluZm8ubW9kaWZpZXJzIHx8IFtdKSwgLi4uKGluZm8ubW9kaWZpZXJzIHx8IFtdKSBdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFkZXJpdmVkSW5mby5zdWJDbGFzcykge1xuICAgICAgICAgICAgZGVyaXZlZEluZm8uc3ViQ2xhc3MgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBkZXJpdmVkSW5mby5zdWJDbGFzcy5wdXNoKGluZm8udHlwZSk7XG4gICAgICAgIHJldHVybiBkZXJpdmVkSW5mbztcbiAgICB9ICAgIFxuICAgIFxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhbiB2YWx1ZSBieSBpbmZlcnJpbmcgYWxsIHRoZSByZWZlcmVuY2VzLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvb2xNb2R1bGUgXG4gICAgICogQHBhcmFtIHsqfSB2YWx1ZSBcbiAgICAgKiBAcmV0dXJucyB7Kn0gLSBUcmFuc2xhdGVkIHZhbHVlLlxuICAgICAqL1xuICAgIHRyYW5zbGF0ZU9vbFZhbHVlKG9vbE1vZHVsZSwgdmFsdWUpIHtcbiAgICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5vb2xUeXBlID09PSBPb2xUeXBlcy5MYW5nLkNPTlNUX1JFRikgeyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgcmVmZWRWYWx1ZSA9IHRoaXMubG9hZEVsZW1lbnQob29sTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LkNPTlNULCB2YWx1ZS5uYW1lKTtcbiAgICAgICAgICAgICAgICBsZXQgdW5pcXVlSWQgPSB0aGlzLmdldEVsZW1lbnRVbmlxdWVJZChvb2xNb2R1bGUsIE9vbFR5cGVzLkVsZW1lbnQuQ09OU1QsIHZhbHVlLm5hbWUpO1xuICAgICAgICAgICAgICAgIGxldCBvd25lck1vZHVsZSA9IHRoaXMuZ2V0TW9kdWxlQnlJZCh0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuZ2V0KHVuaXF1ZUlkKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT29sVmFsdWUob3duZXJNb2R1bGUsIHJlZmVkVmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5vb2xUeXBlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0b2RvOiB0cmFuc2xhdGVPb2xWYWx1ZSB3aXRoIHR5cGU6ICR7dmFsdWUub29sVHlwZX1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gXy5tYXBWYWx1ZXModmFsdWUsIHYgPT4gdGhpcy50cmFuc2xhdGVPb2xWYWx1ZShvb2xNb2R1bGUsIHYpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh2ID0+IHRoaXMudHJhbnNsYXRlT29sVmFsdWUob29sTW9kdWxlLCB2KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSB1bmlxdWUgbW9kdWxlIGlkIGJ5IHNvdXJjZSBmaWxlIHBhdGguXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVBhdGggLSBUaGUgcGF0aCBvZiBhbiBvb2xvbmcgc291cmNlIGZpbGUuXG4gICAgICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgbW9kdWxlIGlkLlxuICAgICAqL1xuICAgIGdldE1vZHVsZUlkQnlQYXRoKG1vZHVsZVBhdGgpIHsgICAgICAgIFxuICAgICAgICBsZXQgaXNCdWlsdGluRW50aXR5ID0gXy5zdGFydHNXaXRoKG1vZHVsZVBhdGgsIEJVSUxUSU5TX1BBVEgpOyAgICAgIFxuICAgICAgICByZXR1cm4gaXNCdWlsdGluRW50aXR5ID8gXG4gICAgICAgICAgICBwYXRoLnJlbGF0aXZlKEJVSUxUSU5TX1BBVEgsIG1vZHVsZVBhdGgpIDogXG4gICAgICAgICAgICAnLi8nICsgcGF0aC5yZWxhdGl2ZSh0aGlzLnNvdXJjZVBhdGgsIG1vZHVsZVBhdGgpOyAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IHRoZSB1bmlxdWUgbmFtZSBvZiBhbiBlbGVtZW50LlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWZlcmVyTW9kdWxlIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlbGVtZW50VHlwZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudE5hbWUgXG4gICAgICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgdW5pcXVlIG5hbWUgb2YgYW4gZWxlbWVudC5cbiAgICAgKi9cbiAgICBnZXRFbGVtZW50VW5pcXVlSWQocmVmZXJlck1vZHVsZSwgZWxlbWVudFR5cGUsIGVsZW1lbnROYW1lKSB7XG4gICAgICAgIHJldHVybiBlbGVtZW50VHlwZSArICc6JyArIGVsZW1lbnROYW1lICsgJzwtJyArIHJlZmVyZXJNb2R1bGUuaWQ7XG4gICAgfVxuXG4gICAgbG9hZEVudGl0eShyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LkVOVElUWSwgZWxlbWVudE5hbWUpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkoZW50aXR5LmZpZWxkcykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRW50aXR5IFwiJHtlbGVtZW50TmFtZX1cIiBoYXMgbm8gYW55IGZpZWxkcyBkZWZpbmVkLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICB9XG5cbiAgICBsb2FkVHlwZShyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LlRZUEUsIGVsZW1lbnROYW1lKTtcbiAgICB9XG5cbiAgICBsb2FkRGF0YXNldChyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LkRBVEFTRVQsIGVsZW1lbnROYW1lKTtcbiAgICB9XG5cbiAgICBsb2FkVmlldyhyZWZlcmVyTW9kdWxlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRWxlbWVudChyZWZlcmVyTW9kdWxlLCBPb2xUeXBlcy5FbGVtZW50LlZJRVcsIGVsZW1lbnROYW1lKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGFuIGVsZW1lbnQgYmFzZWQgb24gdGhlIG5hbWVzcGFjZSBjaGFpbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVmZXJlck1vZHVsZSBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZWxlbWVudFR5cGUgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGVsZW1lbnROYW1lIFxuICAgICAqL1xuICAgIGxvYWRFbGVtZW50KHJlZmVyZXJNb2R1bGUsIGVsZW1lbnRUeXBlLCBlbGVtZW50TmFtZSkge1xuICAgICAgICAvLyB0aGUgZWxlbWVudCBpZCB3aXRoIHR5cGUsIHNob3VsZCBiZSB1bmlxdWUgYW1vbmcgdGhlIHdob2xlIHNjaGVtYVxuICAgICAgICBsZXQgdW5pcXVlSWQgPSB0aGlzLmdldEVsZW1lbnRVbmlxdWVJZChyZWZlcmVyTW9kdWxlLCBlbGVtZW50VHlwZSwgZWxlbWVudE5hbWUpO1xuXG4gICAgICAgIC8vIHRoZSBlbGVtZW50IGlkICsgcmVmZXJlclxuICAgICAgICBpZiAodW5pcXVlSWQgaW4gdGhpcy5fZWxlbWVudHNDYWNoZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHRhcmdldE1vZHVsZTsgICAgICAgIFxuXG4gICAgICAgIGlmIChlbGVtZW50VHlwZSBpbiByZWZlcmVyTW9kdWxlICYmIGVsZW1lbnROYW1lIGluIHJlZmVyZXJNb2R1bGVbZWxlbWVudFR5cGVdKSB7XG4gICAgICAgICAgICAvLyBzZWUgaWYgaXQgZXhpc3RzIGluIHRoZSBzYW1lIG1vZHVsZSAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgdGFyZ2V0TW9kdWxlID0gcmVmZXJlck1vZHVsZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHNlYXJjaCByZXZlcnNlbHkgYnkgdGhlIG5hbWVzcGFjZXNcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFNlYXJjaGluZyAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgZnJvbSBcIiR7cmVmZXJlck1vZHVsZS5pZH1cIiAuLi5gKTtcblxuICAgICAgICAgICAgbGV0IGluZGV4ID0gXy5maW5kTGFzdEluZGV4KHJlZmVyZXJNb2R1bGUubmFtZXNwYWNlLCBtb2R1bGVQYXRoID0+IHtcbiAgICAgICAgICAgICAgICAvL3RoaXMubG9nKCdkZWJ1ZycsIGBMb29raW5nIGZvciAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgaW4gXCIke21vZHVsZVBhdGh9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgICAgICB0YXJnZXRNb2R1bGUgPSB0aGlzLmxvYWRNb2R1bGUobW9kdWxlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0TW9kdWxlICYmIHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV0gJiYgKGVsZW1lbnROYW1lIGluIHRhcmdldE1vZHVsZVtlbGVtZW50VHlwZV0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2VsZW1lbnRUeXBlfSBcIiR7ZWxlbWVudE5hbWV9XCIgbm90IGZvdW5kIGluIGltcG9ydGVkIG5hbWVzcGFjZXMuIFJlZmVyZXI6ICR7cmVmZXJlck1vZHVsZS5pZH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEZvdW5kICR7ZWxlbWVudFR5cGV9IFwiJHtlbGVtZW50TmFtZX1cIiBpbiBcIiR7dGFyZ2V0TW9kdWxlLmlkfVwiLiBbT0tdYCk7XG5cbiAgICAgICAgbGV0IGVsZW1lbnRTZWxmSWQgPSBlbGVtZW50VHlwZSArICc6JyArIGVsZW1lbnROYW1lICsgJ0AnICsgdGFyZ2V0TW9kdWxlLmlkO1xuICAgICAgICBpZiAoZWxlbWVudFNlbGZJZCBpbiB0aGlzLl9lbGVtZW50c0NhY2hlKSB7XG4gICAgICAgICAgICAvLyBhbHJlYWR5IGluaXRpYWxpemVkICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuX2VsZW1lbnRzQ2FjaGVbdW5pcXVlSWRdID0gdGhpcy5fZWxlbWVudHNDYWNoZVtlbGVtZW50U2VsZklkXSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhc3NlcnQgbmFtaW5nIHZhbGlkYXR5XG4gICAgICAgIGFzc2VydDogIXRoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5oYXModW5pcXVlSWQpLCBgJHtlbGVtZW50VHlwZX0gXCIke2VsZW1lbnROYW1lfVwiIGluIFwiJHt0YXJnZXRNb2R1bGUuaWR9XCIgY29uZmxpY3RzIHdpdGggJHtlbGVtZW50VHlwZX0gaW4gXCIke3RoaXMuX21hcE9mUmVmZXJlbmNlVG9Nb2R1bGVJZC5nZXQodW5pcXVlSWQpfVwiIWA7XG4gICAgICAgIFxuICAgICAgICB0aGlzLl9tYXBPZlJlZmVyZW5jZVRvTW9kdWxlSWQuc2V0KHVuaXF1ZUlkLCB0YXJnZXRNb2R1bGUuaWQpO1xuXG4gICAgICAgIC8vIHJldHJpZXZlIHRoZSBjb21waWxlZCBpbmZvXG4gICAgICAgIGxldCBlbGVtZW50SW5mbyA9IE9iamVjdC5mcmVlemUodGFyZ2V0TW9kdWxlW2VsZW1lbnRUeXBlXVtlbGVtZW50TmFtZV0pO1xuICAgICAgICBsZXQgZWxlbWVudDtcblxuICAgICAgICBpZiAoZWxlbWVudFR5cGUgaW4gRUxFTUVOVF9DTEFTU19NQVApIHtcbiAgICAgICAgICAgIC8vIGVsZW1lbnQgbmVlZCBsaW5raW5nXG4gICAgICAgICAgICBsZXQgRWxlbWVudENsYXNzID0gRUxFTUVOVF9DTEFTU19NQVBbZWxlbWVudFR5cGVdO1xuICAgICAgICAgICAgZWxlbWVudCA9IG5ldyBFbGVtZW50Q2xhc3ModGhpcywgZWxlbWVudE5hbWUsIHRhcmdldE1vZHVsZSwgZWxlbWVudEluZm8pOyAgIFxuICAgICAgICAgICAgZWxlbWVudC5saW5rKCk7ICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudEluZm87XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbGVtZW50c0NhY2hlW2VsZW1lbnRTZWxmSWRdID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5fZWxlbWVudHNDYWNoZVt1bmlxdWVJZF0gPSBlbGVtZW50O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgfVxuXG4gICAgX2NvbXBpbGUob29sRmlsZSkge1xuICAgICAgICBsZXQganNGaWxlO1xuICAgICAgICBcbiAgICAgICAgaWYgKG9vbEZpbGUuZW5kc1dpdGgoJy5qc29uJykpIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGU7XG4gICAgICAgICAgICBvb2xGaWxlID0gb29sRmlsZS5zdWJzdHIoMCwgb29sRmlsZS5sZW5ndGggLSA1KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGpzRmlsZSA9IG9vbEZpbGUgKyAnLmpzb24nO1xuICAgICAgICB9ICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG9vbCwgc2VhcmNoRXh0O1xuXG4gICAgICAgIGlmICh0aGlzLnVzZUpzb25Tb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhqc0ZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBcInVzZUpzb25Tb3VyY2VcIiBlbmFiZWxkIGJ1dCBqc29uIGZpbGUgXCIke2pzRmlsZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9vbCA9IGZzLnJlYWRKc29uU3luYyhqc0ZpbGUpO1xuICAgICAgICAgICAgc2VhcmNoRXh0ID0gT09MT05HX1NPVVJDRV9FWFQgKyAnLmpzb24nO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICB0aGlzLmxvZygnZGVidWcnLCAnQ29tcGlsaW5nICcgKyBvb2xGaWxlICsgJyAuLi4nKTsgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG9vbCA9IE9vbG9uZ1BhcnNlci5wYXJzZShmcy5yZWFkRmlsZVN5bmMob29sRmlsZSwgJ3V0ZjgnKSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGNvbXBpbGUgXCIkeyBvb2xGaWxlIH1cIi5cXG4keyBlcnJvci5tZXNzYWdlIHx8IGVycm9yIH1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIW9vbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlcnJvciBvY2N1cnJlZCB3aGlsZSBjb21waWxpbmcuJyk7XG4gICAgICAgICAgICB9ICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZWFyY2hFeHQgPSBPT0xPTkdfU09VUkNFX0VYVDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBiYXNlTmFtZSA9IHBhdGguYmFzZW5hbWUob29sRmlsZSwgT09MT05HX1NPVVJDRV9FWFQpO1xuXG4gICAgICAgIGxldCBuYW1lc3BhY2UgPSBbXTtcblxuICAgICAgICBsZXQgY3VycmVudFBhdGggPSBwYXRoLmRpcm5hbWUob29sRmlsZSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFxuICAgICAgICAgKiBAcGFyYW0geyp9IG5hbWVzcGFjZXMgLSBTZWFyY2hpbmcgcGF0aFxuICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbnMgLSBJbXBvcnQgbGluZVxuICAgICAgICAgKiBAcGFyYW0geyp9IHJlY3Vyc2l2ZSBcbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIGV4cGFuZE5zKG5hbWVzcGFjZXMsIG5zLCByZWN1cnNpdmUpIHtcbiAgICAgICAgICAgIGxldCBzdGF0cyA9IGZzLnN0YXRTeW5jKG5zKTtcblxuICAgICAgICAgICAgLy9pbXBvcnQgJy9wYXRoL3VzZXIub29sJ1xuICAgICAgICAgICAgaWYgKHN0YXRzLmlzRmlsZSgpICYmIG5zLmVuZHNXaXRoKHNlYXJjaEV4dCkpIHtcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2VzLnB1c2gobnMpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkgJiYgcmVjdXJzaXZlKSB7XG4gICAgICAgICAgICAgICAgLy9yZXN1cnNpdmUgZXhwYW5kIHN1Yi1kaXJlY3RvcnlcbiAgICAgICAgICAgICAgICBsZXQgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhucyk7XG4gICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaChmID0+IGV4cGFuZE5zKG5hbWVzcGFjZXMsIHBhdGguam9pbihucywgZiksIHRydWUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvb2wubmFtZXNwYWNlKSB7XG4gICAgICAgICAgICBvb2wubmFtZXNwYWNlLmZvckVhY2gobnMgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBwO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChucy5zdGFydHNXaXRoKCc8b29sb25nPi8nKSkge1xuICAgICAgICAgICAgICAgICAgICBucyA9IHBhdGguam9pbihCVUlMVElOU19QQVRILCBucy5zdWJzdHIoOSkpOyAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnMuc3RhcnRzV2l0aCgnPHNvdXJjZT4vJykpIHtcbiAgICAgICAgICAgICAgICAgICAgbnMgPSBwYXRoLmpvaW4odGhpcy5zb3VyY2VQYXRoLCBucy5zdWJzdHIoOSkpOyAgIFxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIGlmIChucy5lbmRzV2l0aCgnLyonKSkge1xuICAgICAgICAgICAgICAgICAgICBwID0gcGF0aC5yZXNvbHZlKGN1cnJlbnRQYXRoLCBucy5zdWJzdHIoMCwgbnMubGVuZ3RoIC0gMikpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhwKTtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaChmID0+IGV4cGFuZE5zKG5hbWVzcGFjZSwgcGF0aC5qb2luKHAsIGYpLCBmYWxzZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobnMuZW5kc1dpdGgoJy8qKicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHAgPSBwYXRoLnJlc29sdmUoY3VycmVudFBhdGgsIG5zLnN1YnN0cigwLCBucy5sZW5ndGggLSAzKSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKHApO1xuICAgICAgICAgICAgICAgICAgICBmaWxlcy5mb3JFYWNoKGYgPT4gZXhwYW5kTnMobmFtZXNwYWNlLCBwYXRoLmpvaW4ocCwgZiksIHRydWUpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2UucHVzaChwYXRoLnJlc29sdmUoY3VycmVudFBhdGgsIF8uZW5kc1dpdGgobnMsIE9PTE9OR19TT1VSQ0VfRVhUKSA/IG5zIDogbnMgKyBPT0xPTkdfU09VUkNFX0VYVCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgb29sLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcblxuICAgICAgICBvb2wuaWQgPSB0aGlzLmdldE1vZHVsZUlkQnlQYXRoKG9vbEZpbGUpOyAgICAgICAgXG4gICAgICAgIG9vbC5uYW1lID0gYmFzZU5hbWU7ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKCF0aGlzLnVzZUpzb25Tb3VyY2UgJiYgdGhpcy5zYXZlSW50ZXJtZWRpYXRlKSB7ICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoanNGaWxlLCBKU09OLnN0cmluZ2lmeShvb2wsIG51bGwsIDQpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvb2w7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IExpbmtlcjsiXX0=