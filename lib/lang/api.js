"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs,
  eachAsync_
} = Util;

const Linker = require('./Linker');

const Connector = require('../runtime/Connector');

function createConnector(context, schemaName) {
  let deployment = context.schemaDeployment[schemaName];

  if (!deployment) {
    context.logger.log('warn', `Schema "${schemaName}" has no configured deployment and is ignored in modeling.`);
    return;
  }

  let {
    dataSource,
    connectionString,
    options
  } = deployment;
  let [driver] = dataSource.split('.');
  return Connector.createConnector(driver, connectionString, {
    logger: context.logger,
    ...options
  });
}

async function importDataFiles(migrator, folderName) {
  let dataSetPath = path.join(migrator.dbScriptPath, 'data', folderName);
  let dataListFile = path.join(dataSetPath, 'index.list');

  if (!fs.existsSync(dataListFile)) {
    throw new Error(`Entry file of dataset "${folderName}" not found.`);
  }

  let dataList = fs.readFileSync(dataListFile).toString().match(/^.+$/gm);
  return eachAsync_(dataList, async line => {
    line = line.trim();

    if (line.length > 0) {
      let dataFile = path.join(dataSetPath, line);

      if (!fs.existsSync(dataFile)) {
        throw new Error(`Data file "${dataFile}" not found.`);
      }

      await migrator.load_(dataFile);
    }
  });
}

exports.build_ = async context => {
  context.logger.log('verbose', 'Start building models ...');
  let linker = new Linker(context);
  context.linker = linker;
  let schemaFiles = Linker.getOolongFiles(context.dslSourcePath, context.useJsonSource);
  schemaFiles.forEach(schemaFile => linker.link(schemaFile));
  return eachAsync_(linker.schemas, async (schema, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    let deploymentSetting = context.schemaDeployment[schemaName];

    try {
      let DbModeler = require(`../modeler/database/${connector.driver}/Modeler`);

      let dbModeler = new DbModeler(context, connector, deploymentSetting.extraOptions);
      let refinedSchema = dbModeler.modeling(schema);

      const DaoModeler = require('../modeler/Dao');

      let daoModeler = new DaoModeler(context, connector);
      await daoModeler.modeling_(refinedSchema);
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.migrate_ = async (context, reset = false) => {
  context.logger.log('verbose', 'Start deploying models ...');
  return eachAsync_(context.schemaDeployment, async (deployment, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    try {
      let Migration = require(`../migration/${connector.driver}`);

      let migration = new Migration(context, schemaName, connector);

      if (reset) {
        await migration.reset_();
      }

      await migration.create_(deployment.extraOptions);
      await importDataFiles(migration, '_init');
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.dataset_ = async (context, schemaName) => {
  let connector = createConnector(context, schemaName);

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  let dataSetPath = path.join(context.scriptSourcePath, connector.driver, connector.database, 'data');

  if (!fs.existsSync(dataSetPath)) {
    return [];
  } else {
    let dataSets = fs.readdirSync(dataSetPath);
    let validDs = [];
    dataSets.forEach(ds => {
      let indexFile = path.join(dataSetPath, ds, 'index.list');

      if (fs.existsSync(indexFile)) {
        validDs.push(ds);
      }
    });
    return validDs;
  }
};

exports.import_ = async (context, schemaName, datasetName) => {
  let connector = createConnector(context, schemaName);

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  try {
    let Migration = require(`../migration/${connector.driver}`);

    let migration = new Migration(context, schemaName, connector);
    await importDataFiles(migration, datasetName);
  } catch (error) {
    throw error;
  } finally {
    await connector.end_();
  }
};

exports.reverse_ = async context => {
  let ReserveEngineering = require(`../modeler/database/${context.driver}/ReverseEngineering`);

  let {
    connection: connectionString,
    ...options
  } = context.connOptions;
  let connector = Connector.createConnector(context.driver, connectionString, {
    logger: context.logger,
    ...options
  });

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  try {
    let modeler = new ReserveEngineering(context, connector);
    await modeler.reverse_(context.dslReverseOutputPath);
  } catch (error) {
    throw error;
  } finally {
    await connector.end_();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL2FwaS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwiTGlua2VyIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiY29udGV4dCIsInNjaGVtYU5hbWUiLCJkZXBsb3ltZW50Iiwic2NoZW1hRGVwbG95bWVudCIsImxvZ2dlciIsImxvZyIsImRhdGFTb3VyY2UiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImRyaXZlciIsInNwbGl0IiwiaW1wb3J0RGF0YUZpbGVzIiwibWlncmF0b3IiLCJmb2xkZXJOYW1lIiwiZGF0YVNldFBhdGgiLCJqb2luIiwiZGJTY3JpcHRQYXRoIiwiZGF0YUxpc3RGaWxlIiwiZXhpc3RzU3luYyIsIkVycm9yIiwiZGF0YUxpc3QiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsIm1hdGNoIiwibGluZSIsInRyaW0iLCJsZW5ndGgiLCJkYXRhRmlsZSIsImxvYWRfIiwiZXhwb3J0cyIsImJ1aWxkXyIsImxpbmtlciIsInNjaGVtYUZpbGVzIiwiZ2V0T29sb25nRmlsZXMiLCJkc2xTb3VyY2VQYXRoIiwidXNlSnNvblNvdXJjZSIsImZvckVhY2giLCJzY2hlbWFGaWxlIiwibGluayIsInNjaGVtYXMiLCJzY2hlbWEiLCJjb25uZWN0b3IiLCJkZXBsb3ltZW50U2V0dGluZyIsIkRiTW9kZWxlciIsImRiTW9kZWxlciIsImV4dHJhT3B0aW9ucyIsInJlZmluZWRTY2hlbWEiLCJtb2RlbGluZyIsIkRhb01vZGVsZXIiLCJkYW9Nb2RlbGVyIiwibW9kZWxpbmdfIiwiZXJyb3IiLCJlbmRfIiwibWlncmF0ZV8iLCJyZXNldCIsIk1pZ3JhdGlvbiIsIm1pZ3JhdGlvbiIsInJlc2V0XyIsImNyZWF0ZV8iLCJkYXRhc2V0XyIsInNjcmlwdFNvdXJjZVBhdGgiLCJkYXRhYmFzZSIsImRhdGFTZXRzIiwicmVhZGRpclN5bmMiLCJ2YWxpZERzIiwiZHMiLCJpbmRleEZpbGUiLCJwdXNoIiwiaW1wb3J0XyIsImRhdGFzZXROYW1lIiwicmV2ZXJzZV8iLCJSZXNlcnZlRW5naW5lZXJpbmciLCJjb25uZWN0aW9uIiwiY29ubk9wdGlvbnMiLCJtb2RlbGVyIiwiZHNsUmV2ZXJzZU91dHB1dFBhdGgiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBO0FBQVQsSUFBd0JILElBQTlCOztBQUVBLE1BQU1JLE1BQU0sR0FBR0wsT0FBTyxDQUFDLFVBQUQsQ0FBdEI7O0FBQ0EsTUFBTU0sU0FBUyxHQUFHTixPQUFPLENBQUMsc0JBQUQsQ0FBekI7O0FBT0MsU0FBU08sZUFBVCxDQUF5QkMsT0FBekIsRUFBa0NDLFVBQWxDLEVBQThDO0FBQzNDLE1BQUlDLFVBQVUsR0FBR0YsT0FBTyxDQUFDRyxnQkFBUixDQUF5QkYsVUFBekIsQ0FBakI7O0FBRUEsTUFBSSxDQUFDQyxVQUFMLEVBQWlCO0FBQ2JGLElBQUFBLE9BQU8sQ0FBQ0ksTUFBUixDQUFlQyxHQUFmLENBQW1CLE1BQW5CLEVBQTRCLFdBQVVKLFVBQVcsNERBQWpEO0FBQ0E7QUFDSDs7QUFFRCxNQUFJO0FBQUVLLElBQUFBLFVBQUY7QUFBY0MsSUFBQUEsZ0JBQWQ7QUFBZ0NDLElBQUFBO0FBQWhDLE1BQTRDTixVQUFoRDtBQUNBLE1BQUksQ0FBRU8sTUFBRixJQUFhSCxVQUFVLENBQUNJLEtBQVgsQ0FBaUIsR0FBakIsQ0FBakI7QUFFQSxTQUFPWixTQUFTLENBQUNDLGVBQVYsQ0FBMEJVLE1BQTFCLEVBQWtDRixnQkFBbEMsRUFBb0Q7QUFBRUgsSUFBQUEsTUFBTSxFQUFFSixPQUFPLENBQUNJLE1BQWxCO0FBQTBCLE9BQUdJO0FBQTdCLEdBQXBELENB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S0FBTjtBQUNILEdBTkQsU0FNVTtBQUNOLFVBQU1WLFNBQVMsQ0FBQ1csSUFBVixFQUFOO0FBQ0g7QUFDSixDQWhCRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgXywgZnMsIGVhY2hBc3luY18gfSA9IFV0aWw7XG5cbmNvbnN0IExpbmtlciA9IHJlcXVpcmUoJy4vTGlua2VyJyk7XG5jb25zdCBDb25uZWN0b3IgPSByZXF1aXJlKCcuLi9ydW50aW1lL0Nvbm5lY3RvcicpO1xuXG4vKipcbiAqIE9vbG9uZyBEU0wgYXBpXG4gKiBAbW9kdWxlIE9vbG9uZ1xuICovXG5cbiBmdW5jdGlvbiBjcmVhdGVDb25uZWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSkge1xuICAgIGxldCBkZXBsb3ltZW50ID0gY29udGV4dC5zY2hlbWFEZXBsb3ltZW50W3NjaGVtYU5hbWVdO1xuXG4gICAgaWYgKCFkZXBsb3ltZW50KSB7XG4gICAgICAgIGNvbnRleHQubG9nZ2VyLmxvZygnd2FybicsIGBTY2hlbWEgXCIke3NjaGVtYU5hbWV9XCIgaGFzIG5vIGNvbmZpZ3VyZWQgZGVwbG95bWVudCBhbmQgaXMgaWdub3JlZCBpbiBtb2RlbGluZy5gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCB7IGRhdGFTb3VyY2UsIGNvbm5lY3Rpb25TdHJpbmcsIG9wdGlvbnMgfSA9IGRlcGxveW1lbnQ7XG4gICAgbGV0IFsgZHJpdmVyIF0gPSBkYXRhU291cmNlLnNwbGl0KCcuJyk7XG5cbiAgICByZXR1cm4gQ29ubmVjdG9yLmNyZWF0ZUNvbm5lY3Rvcihkcml2ZXIsIGNvbm5lY3Rpb25TdHJpbmcsIHsgbG9nZ2VyOiBjb250ZXh0LmxvZ2dlciwgLi4ub3B0aW9ucyB9KTsgICAgICAgXG4gfVxuXG4gYXN5bmMgZnVuY3Rpb24gaW1wb3J0RGF0YUZpbGVzKG1pZ3JhdG9yLCBmb2xkZXJOYW1lKSB7XG4gICAgbGV0IGRhdGFTZXRQYXRoID0gcGF0aC5qb2luKG1pZ3JhdG9yLmRiU2NyaXB0UGF0aCwgJ2RhdGEnLCBmb2xkZXJOYW1lKTtcbiAgICBsZXQgZGF0YUxpc3RGaWxlID0gcGF0aC5qb2luKGRhdGFTZXRQYXRoLCAnaW5kZXgubGlzdCcpO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRhdGFMaXN0RmlsZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFbnRyeSBmaWxlIG9mIGRhdGFzZXQgXCIke2ZvbGRlck5hbWV9XCIgbm90IGZvdW5kLmApO1xuICAgIH1cblxuICAgIGxldCBkYXRhTGlzdCA9IGZzLnJlYWRGaWxlU3luYyhkYXRhTGlzdEZpbGUpLnRvU3RyaW5nKCkubWF0Y2goL14uKyQvZ20pO1xuXG4gICAgcmV0dXJuIGVhY2hBc3luY18oZGF0YUxpc3QsIGFzeW5jIGxpbmUgPT4ge1xuICAgICAgICBsaW5lID0gbGluZS50cmltKCk7XG5cbiAgICAgICAgaWYgKGxpbmUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IGRhdGFGaWxlID0gcGF0aC5qb2luKGRhdGFTZXRQYXRoLCBsaW5lKTtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkYXRhRmlsZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGEgZmlsZSBcIiR7ZGF0YUZpbGV9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCBtaWdyYXRvci5sb2FkXyhkYXRhRmlsZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiB9XG5cbi8qKlxuICogQnVpbGQgZGF0YWJhc2Ugc2NyaXB0cyBhbmQgZW50aXR5IG1vZGVscyBmcm9tIG9vbG9uZyBmaWxlcy5cbiAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gKiBAcHJvcGVydHkge0xvZ2dlcn0gY29udGV4dC5sb2dnZXIgLSBMb2dnZXIgb2JqZWN0XG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5kc2xTb3VyY2VQYXRoXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5tb2RlbE91dHB1dFBhdGggICAgICAgICBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LnNjcmlwdE91dHB1dFBhdGhcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0Lm1hbmlmZXN0T3V0cHV0UGF0aFxuICogQHByb3BlcnR5IHtib29sfSBjb250ZXh0LnVzZUpzb25Tb3VyY2VcbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0LnNjaGVtYURlcGxveW1lbnQgICBcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxuICovXG5leHBvcnRzLmJ1aWxkXyA9IGFzeW5jIChjb250ZXh0KSA9PiB7XG4gICAgY29udGV4dC5sb2dnZXIubG9nKCd2ZXJib3NlJywgJ1N0YXJ0IGJ1aWxkaW5nIG1vZGVscyAuLi4nKTtcblxuICAgIGxldCBsaW5rZXIgPSBuZXcgTGlua2VyKGNvbnRleHQpO1xuICAgIGNvbnRleHQubGlua2VyID0gbGlua2VyO1xuXG4gICAgbGV0IHNjaGVtYUZpbGVzID0gTGlua2VyLmdldE9vbG9uZ0ZpbGVzKGNvbnRleHQuZHNsU291cmNlUGF0aCwgY29udGV4dC51c2VKc29uU291cmNlKTtcbiAgICBzY2hlbWFGaWxlcy5mb3JFYWNoKHNjaGVtYUZpbGUgPT4gbGlua2VyLmxpbmsoc2NoZW1hRmlsZSkpOyAgICBcblxuICAgIHJldHVybiBlYWNoQXN5bmNfKGxpbmtlci5zY2hlbWFzLCBhc3luYyAoc2NoZW1hLCBzY2hlbWFOYW1lKSA9PiB7ICAgICAgICBcbiAgICAgICAgbGV0IGNvbm5lY3RvciA9IGNyZWF0ZUNvbm5lY3Rvcihjb250ZXh0LCBzY2hlbWFOYW1lKTtcbiAgICAgICAgYXNzZXJ0OiBjb25uZWN0b3I7XG5cbiAgICAgICAgbGV0IGRlcGxveW1lbnRTZXR0aW5nID0gY29udGV4dC5zY2hlbWFEZXBsb3ltZW50W3NjaGVtYU5hbWVdO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgRGJNb2RlbGVyID0gcmVxdWlyZShgLi4vbW9kZWxlci9kYXRhYmFzZS8ke2Nvbm5lY3Rvci5kcml2ZXJ9L01vZGVsZXJgKTtcbiAgICAgICAgICAgIGxldCBkYk1vZGVsZXIgPSBuZXcgRGJNb2RlbGVyKGNvbnRleHQsIGNvbm5lY3RvciwgZGVwbG95bWVudFNldHRpbmcuZXh0cmFPcHRpb25zKTtcbiAgICAgICAgICAgIGxldCByZWZpbmVkU2NoZW1hID0gZGJNb2RlbGVyLm1vZGVsaW5nKHNjaGVtYSk7XG5cbiAgICAgICAgICAgIGNvbnN0IERhb01vZGVsZXIgPSByZXF1aXJlKCcuLi9tb2RlbGVyL0RhbycpO1xuICAgICAgICAgICAgbGV0IGRhb01vZGVsZXIgPSBuZXcgRGFvTW9kZWxlcihjb250ZXh0LCBjb25uZWN0b3IpO1xuXG4gICAgICAgICAgICBhd2FpdCBkYW9Nb2RlbGVyLm1vZGVsaW5nXyhyZWZpbmVkU2NoZW1hKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYXdhaXQgY29ubmVjdG9yLmVuZF8oKTtcbiAgICAgICAgfSBcbiAgICB9KTsgICAgICAgICAgICBcbn07XG5cbi8qKlxuICogRGVwbG95IGRhdGFiYXNlIHNjcmlwdHMgaW50byBkYXRhYmFzZS5cbiAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gKiBAcHJvcGVydHkge0xvZ2dlcn0gY29udGV4dC5sb2dnZXIgLSBMb2dnZXIgb2JqZWN0XG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5tb2RlbFBhdGhcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmRzbFNvdXJjZVBhdGggXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5zY3JpcHRTb3VyY2VQYXRoIFxuICogQHByb3BlcnR5IHtvYmplY3R9IGNvbnRleHQuc2NoZW1hRGVwbG95bWVudCAgIFxuICogQHBhcmFtIHtib29sfSByZXNldFxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmV4cG9ydHMubWlncmF0ZV8gPSBhc3luYyAoY29udGV4dCwgcmVzZXQgPSBmYWxzZSkgPT4ge1xuICAgIGNvbnRleHQubG9nZ2VyLmxvZygndmVyYm9zZScsICdTdGFydCBkZXBsb3lpbmcgbW9kZWxzIC4uLicpO1xuXG4gICAgcmV0dXJuIGVhY2hBc3luY18oY29udGV4dC5zY2hlbWFEZXBsb3ltZW50LCBhc3luYyAoZGVwbG95bWVudCwgc2NoZW1hTmFtZSkgPT4ge1xuICAgICAgICBsZXQgY29ubmVjdG9yID0gY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUpO1xuICAgICAgICBhc3NlcnQ6IGNvbm5lY3RvcjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IE1pZ3JhdGlvbiA9IHJlcXVpcmUoYC4uL21pZ3JhdGlvbi8ke2Nvbm5lY3Rvci5kcml2ZXJ9YCk7XG4gICAgICAgICAgICBsZXQgbWlncmF0aW9uID0gbmV3IE1pZ3JhdGlvbihjb250ZXh0LCBzY2hlbWFOYW1lLCBjb25uZWN0b3IpO1xuXG4gICAgICAgICAgICBpZiAocmVzZXQpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBtaWdyYXRpb24ucmVzZXRfKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IG1pZ3JhdGlvbi5jcmVhdGVfKGRlcGxveW1lbnQuZXh0cmFPcHRpb25zKTtcblxuICAgICAgICAgICAgYXdhaXQgaW1wb3J0RGF0YUZpbGVzKG1pZ3JhdGlvbiwgJ19pbml0Jyk7ICAgICAgICAgICAgXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IGNvbm5lY3Rvci5lbmRfKCk7XG4gICAgICAgIH0gXG4gICAgfSk7XG59O1xuXG4vKipcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gKiBAcGFyYW0ge3N0cmluZ30gc2NoZW1hTmFtZVxuICovXG5leHBvcnRzLmRhdGFzZXRfID0gYXN5bmMgKGNvbnRleHQsIHNjaGVtYU5hbWUpID0+IHtcbiAgICBsZXQgY29ubmVjdG9yID0gY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUpO1xuICAgIGFzc2VydDogY29ubmVjdG9yO1xuICAgIFxuICAgIGxldCBkYXRhU2V0UGF0aCA9IHBhdGguam9pbihjb250ZXh0LnNjcmlwdFNvdXJjZVBhdGgsIGNvbm5lY3Rvci5kcml2ZXIsIGNvbm5lY3Rvci5kYXRhYmFzZSwgJ2RhdGEnKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkYXRhU2V0UGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBkYXRhU2V0cyA9IGZzLnJlYWRkaXJTeW5jKGRhdGFTZXRQYXRoKTtcbiAgICAgICAgbGV0IHZhbGlkRHMgPSBbXTtcbiAgICAgICAgZGF0YVNldHMuZm9yRWFjaChkcyA9PiB7XG4gICAgICAgICAgICBsZXQgaW5kZXhGaWxlID0gcGF0aC5qb2luKGRhdGFTZXRQYXRoLCBkcywgJ2luZGV4Lmxpc3QnKTtcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGluZGV4RmlsZSkpIHtcbiAgICAgICAgICAgICAgICB2YWxpZERzLnB1c2goZHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdmFsaWREcztcbiAgICB9XG59XG5cbi8qKlxuICogSW1wb3J0IGEgZGF0YSBzZXQgaW50byBkYXRhYmFzZVxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciAtIExvZ2dlciBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LnNjcmlwdFNvdXJjZVBhdGggIFxuICogQHBhcmFtIHtzdHJpbmd9IHNjaGVtYU5hbWVcbiAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhc2V0TmFtZVxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmV4cG9ydHMuaW1wb3J0XyA9IGFzeW5jIChjb250ZXh0LCBzY2hlbWFOYW1lLCBkYXRhc2V0TmFtZSkgPT4ge1xuICAgIGxldCBjb25uZWN0b3IgPSBjcmVhdGVDb25uZWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSk7XG4gICAgYXNzZXJ0OiBjb25uZWN0b3I7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgICAgbGV0IE1pZ3JhdGlvbiA9IHJlcXVpcmUoYC4uL21pZ3JhdGlvbi8ke2Nvbm5lY3Rvci5kcml2ZXJ9YCk7XG4gICAgICAgIGxldCBtaWdyYXRpb24gPSBuZXcgTWlncmF0aW9uKGNvbnRleHQsIHNjaGVtYU5hbWUsIGNvbm5lY3Rvcik7XG5cbiAgICAgICAgYXdhaXQgaW1wb3J0RGF0YUZpbGVzKG1pZ3JhdGlvbiwgZGF0YXNldE5hbWUpOyAgICAgICAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IGNvbm5lY3Rvci5lbmRfKCk7XG4gICAgfSBcbn07XG5cbi8qKlxuICogRXh0cmFjdCBkYXRhYmFzZSBzdHJ1Y3R1cmUgaW50byBvb2xvbmcgZHNsXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICogQHByb3BlcnR5IHtDb25uZWN0b3J9IGNvbnRleHQuY29ubmVjdG9yXG4gKiBAcHJvcGVydHkge0xvZ2dlcn0gY29udGV4dC5sb2dnZXIgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5kc2xSZXZlcnNlT3V0cHV0UGF0aCBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmRyaXZlclxuICogQHByb3BlcnR5IHtvYmplY3R9IGNvbnRleHQuY29ubk9wdGlvbnMgXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuZXhwb3J0cy5yZXZlcnNlXyA9IGFzeW5jIChjb250ZXh0KSA9PiB7ICAgXG4gICAgbGV0IFJlc2VydmVFbmdpbmVlcmluZyA9IHJlcXVpcmUoYC4uL21vZGVsZXIvZGF0YWJhc2UvJHtjb250ZXh0LmRyaXZlcn0vUmV2ZXJzZUVuZ2luZWVyaW5nYCk7XG4gICAgXG4gICAgbGV0IHsgY29ubmVjdGlvbjogY29ubmVjdGlvblN0cmluZywgLi4ub3B0aW9ucyB9ID0gY29udGV4dC5jb25uT3B0aW9uczsgIFxuICAgIGxldCBjb25uZWN0b3IgPSBDb25uZWN0b3IuY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQuZHJpdmVyLCBjb25uZWN0aW9uU3RyaW5nLCB7IGxvZ2dlcjogY29udGV4dC5sb2dnZXIsIC4uLm9wdGlvbnMgfSk7ICAgICBcbiAgICBhc3NlcnQ6IGNvbm5lY3RvcjsgIFxuXG4gICAgdHJ5IHtcbiAgICAgICAgbGV0IG1vZGVsZXIgPSBuZXcgUmVzZXJ2ZUVuZ2luZWVyaW5nKGNvbnRleHQsIGNvbm5lY3Rvcik7XG5cbiAgICAgICAgYXdhaXQgbW9kZWxlci5yZXZlcnNlXyhjb250ZXh0LmRzbFJldmVyc2VPdXRwdXRQYXRoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgICBhd2FpdCBjb25uZWN0b3IuZW5kXygpO1xuICAgIH0gXG59OyJdfQ==