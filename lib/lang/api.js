"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs,
  eachAsync_
} = Util;

const Linker = require('./Linker');

const Connector = require('../runtime/Connector');

function createConnector(context, schemaName) {
  let deployment = context.schemaDeployment[schemaName];

  if (!deployment) {
    context.logger.log('warn', `Schema "${schemaName}" has no configured deployment and is ignored in modeling.`);
    return;
  }

  let {
    dataSource,
    connectionString,
    options
  } = deployment;
  let [driver] = dataSource.split('.');
  return Connector.createConnector(driver, connectionString, {
    logger: context.logger,
    ...options
  });
}

async function importDataFiles(migrator, folderName) {
  let dataSetPath = path.join(migrator.dbScriptPath, 'data', folderName);
  let dataListFile = path.join(dataSetPath, 'index.list');

  if (!fs.existsSync(dataListFile)) {
    return;
  }

  let dataList = fs.readFileSync(dataListFile).toString().match(/^.+$/gm);
  return eachAsync_(dataList, async line => {
    line = line.trim();

    if (line.length > 0) {
      let dataFile = path.join(dataSetPath, line);

      if (!fs.existsSync(dataFile)) {
        return Promise.reject(`Data file "${dataFile}" not found.`);
      }

      await migrator.load_(dataFile);
    }
  });
}

exports.build_ = async context => {
  context.logger.log('verbose', 'Start building models ...');
  let linker = new Linker(context);
  context.linker = linker;
  let schemaFiles = Linker.getOolongFiles(context.dslSourcePath, context.useJsonSource);
  schemaFiles.forEach(schemaFile => linker.link(schemaFile));
  return eachAsync_(linker.schemas, async (schema, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    try {
      let DbModeler = require(`../modeler/database/${connector.driver}/Modeler`);

      let dbModeler = new DbModeler(context, connector);
      let refinedSchema = dbModeler.modeling(schema);

      const DaoModeler = require('../modeler/Dao');

      let daoModeler = new DaoModeler(context, connector);
      await daoModeler.modeling_(refinedSchema);
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.migrate_ = async (context, reset = false) => {
  context.logger.log('verbose', 'Start deploying models ...');
  return eachAsync_(context.schemaDeployment, async (deployment, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    try {
      let Migration = require(`../migration/${connector.driver}`);

      let migration = new Migration(context, schemaName, connector);

      if (reset) {
        await migration.reset_();
      }

      await migration.create_();
      await importDataFiles(migration, '_init');
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.import = async (context, db, dataSetDir) => {
  let [dbType] = db.split(':');
  let dataListFile = path.join(dataSetDir, 'index.list');

  if (!fs.existsSync(dataListFile)) {
    return Promise.reject(`Data entry list file "${dataListFile}" not found.`);
  }

  let dataList = fs.readFileSync(dataListFile).toString().match(/^.+$/gm);

  let Deployer = require(`../deployer/db/${dbType}.js`);

  let service = context.currentApp.getService(db);
  let deployer = new Deployer(context, service);
  return Util.eachAsync_(dataList, async line => {
    line = line.trim();

    if (line.length > 0) {
      let dataFile = path.join(dataSetDir, line);

      if (!fs.existsSync(dataFile)) {
        return Promise.reject(`Data file "${dataFile}" not found.`);
      }

      await deployer.loadData(dataFile);
    }
  });
};

exports.reverse_ = async context => {
  let ReserveEngineering = require(`../modeler/database/${context.driver}/ReverseEngineering`);

  let {
    connection: connectionString,
    ...options
  } = context.connOptions;
  let connector = Connector.createConnector(context.driver, connectionString, {
    logger: context.logger,
    ...options
  });

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  try {
    let modeler = new ReserveEngineering(context, connector);
    await modeler.reverse_(context.dslReverseOutputDir);
  } catch (error) {
    throw error;
  } finally {
    await connector.end_();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL2FwaS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwiTGlua2VyIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiY29udGV4dCIsInNjaGVtYU5hbWUiLCJkZXBsb3ltZW50Iiwic2NoZW1hRGVwbG95bWVudCIsImxvZ2dlciIsImxvZyIsImRhdGFTb3VyY2UiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImRyaXZlciIsInNwbGl0IiwiaW1wb3J0RGF0YUZpbGVzIiwibWlncmF0b3IiLCJmb2xkZXJOYW1lIiwiZGF0YVNldFBhdGgiLCJqb2luIiwiZGJTY3JpcHRQYXRoIiwiZGF0YUxpc3RGaWxlIiwiZXhpc3RzU3luYyIsImRhdGFMaXN0IiwicmVhZEZpbGVTeW5jIiwidG9TdHJpbmciLCJtYXRjaCIsImxpbmUiLCJ0cmltIiwibGVuZ3RoIiwiZGF0YUZpbGUiLCJQcm9taXNlIiwicmVqZWN0IiwibG9hZF8iLCJleHBvcnRzIiwiYnVpbGRfIiwibGlua2VyIiwic2NoZW1hRmlsZXMiLCJnZXRPb2xvbmdGaWxlcyIsImRzbFNvdXJjZVBhdGgiLCJ1c2VKc29uU291cmNlIiwiZm9yRWFjaCIsInNjaGVtYUZpbGUiLCJsaW5rIiwic2NoZW1hcyIsInNjaGVtYSIsImNvbm5lY3RvciIsIkRiTW9kZWxlciIsImRiTW9kZWxlciIsInJlZmluZWRTY2hlbWEiLCJtb2RlbGluZyIsIkRhb01vZGVsZXIiLCJkYW9Nb2RlbGVyIiwibW9kZWxpbmdfIiwiZXJyb3IiLCJlbmRfIiwibWlncmF0ZV8iLCJyZXNldCIsIk1pZ3JhdGlvbiIsIm1pZ3JhdGlvbiIsInJlc2V0XyIsImNyZWF0ZV8iLCJpbXBvcnQiLCJkYiIsImRhdGFTZXREaXIiLCJkYlR5cGUiLCJEZXBsb3llciIsInNlcnZpY2UiLCJjdXJyZW50QXBwIiwiZ2V0U2VydmljZSIsImRlcGxveWVyIiwibG9hZERhdGEiLCJyZXZlcnNlXyIsIlJlc2VydmVFbmdpbmVlcmluZyIsImNvbm5lY3Rpb24iLCJjb25uT3B0aW9ucyIsIm1vZGVsZXIiLCJkc2xSZXZlcnNlT3V0cHV0RGlyIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBRUEsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQTtBQUFULElBQXdCSCxJQUE5Qjs7QUFFQSxNQUFNSSxNQUFNLEdBQUdMLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLE1BQU1NLFNBQVMsR0FBR04sT0FBTyxDQUFDLHNCQUFELENBQXpCOztBQU9DLFNBQVNPLGVBQVQsQ0FBeUJDLE9BQXpCLEVBQWtDQyxVQUFsQyxFQUE4QztBQUMzQyxNQUFJQyxVQUFVLEdBQUdGLE9BQU8sQ0FBQ0csZ0JBQVIsQ0FBeUJGLFVBQXpCLENBQWpCOztBQUVBLE1BQUksQ0FBQ0MsVUFBTCxFQUFpQjtBQUNiRixJQUFBQSxPQUFPLENBQUNJLE1BQVIsQ0FBZUMsR0FBZixDQUFtQixNQUFuQixFQUE0QixXQUFVSixVQUFXLDREQUFqRDtBQUNBO0FBQ0g7O0FBRUQsTUFBSTtBQUFFSyxJQUFBQSxVQUFGO0FBQWNDLElBQUFBLGdCQUFkO0FBQWdDQyxJQUFBQTtBQUFoQyxNQUE0Q04sVUFBaEQ7QUFDQSxNQUFJLENBQUVPLE1BQUYsSUFBYUgsVUFBVSxDQUFDSSxLQUFYLENBQWlCLEdBQWpCLENBQWpCO0FBRUEsU0FBT1osU0FBUyxDQUFDQyxlQUFWLENBQTBCVSxNQUExQixFQUFrQ0YsZ0JBQWxDLEVBQW9EO0FBQUVILElBQUFBLE1BQU0sRUFBRUosT0FBTyxDQUFDSSxNQUFsQjtBQUEwQixPQUFHSTtBQUE3QixHQUFwRCxDQUFQO0FBQ0Y7O0FBRUQsZUFBZUcsZUFBZixDQUErQkMsUUFBL0IsRUFBeUND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bUI7QUFDbEMsTUFBSXFFLGtCQUFrQixHQUFHN0UsT0FBTyxDQUFFLHVCQUFzQlEsT0FBTyxDQUFDUyxNQUFPLHFCQUF2QyxDQUFoQzs7QUFFQSxNQUFJO0FBQUU2RCxJQUFBQSxVQUFVLEVBQUUvRCxnQkFBZDtBQUFnQyxPQUFHQztBQUFuQyxNQUErQ1IsT0FBTyxDQUFDdUUsV0FBM0Q7QUFDQSxNQUFJN0IsU0FBUyxHQUFHNUMsU0FBUyxDQUFDQyxlQUFWLENBQTBCQyxPQUFPLENBQUNTLE1BQWxDLEVBQTBDRixnQkFBMUMsRUFBNEQ7QUFBRUgsSUFBQUEsTUFBTSxFQUFFSixPQUFPLENBQUNJLE1BQWxCO0FBQTBCLE9BQUdJO0FBQTdCLEdBQTVELENBQWhCOztBQUprQyxPQUsxQmtDLFNBTDBCO0FBQUE7QUFBQTs7QUFPbEMsTUFBSTtBQUNBLFFBQUk4QixPQUFPLEdBQUcsSUFBSUgsa0JBQUosQ0FBdUJyRSxPQUF2QixFQUFnQzBDLFNBQWhDLENBQWQ7QUFFQSxVQUFNOEIsT0FBTyxDQUFDSixRQUFSLENBQWlCcEUsT0FBTyxDQUFDeUUsbUJBQXpCLENBQU47QUFDSCxHQUpELENBSUUsT0FBT3ZCLEtBQVAsRUFBYztBQUNaLFVBQU1BLEtBQU47QUFDSCxHQU5ELFNBTVU7QUFDTixVQUFNUixTQUFTLENBQUNTLElBQVYsRUFBTjtBQUNIO0FBQ0osQ0FoQkQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfIH0gPSBVdGlsO1xuXG5jb25zdCBMaW5rZXIgPSByZXF1aXJlKCcuL0xpbmtlcicpO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vcnVudGltZS9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBPb2xvbmcgRFNMIGFwaVxuICogQG1vZHVsZSBPb2xvbmdcbiAqL1xuXG4gZnVuY3Rpb24gY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUpIHtcbiAgICBsZXQgZGVwbG95bWVudCA9IGNvbnRleHQuc2NoZW1hRGVwbG95bWVudFtzY2hlbWFOYW1lXTtcblxuICAgIGlmICghZGVwbG95bWVudCkge1xuICAgICAgICBjb250ZXh0LmxvZ2dlci5sb2coJ3dhcm4nLCBgU2NoZW1hIFwiJHtzY2hlbWFOYW1lfVwiIGhhcyBubyBjb25maWd1cmVkIGRlcGxveW1lbnQgYW5kIGlzIGlnbm9yZWQgaW4gbW9kZWxpbmcuYCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgeyBkYXRhU291cmNlLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zIH0gPSBkZXBsb3ltZW50O1xuICAgIGxldCBbIGRyaXZlciBdID0gZGF0YVNvdXJjZS5zcGxpdCgnLicpO1xuXG4gICAgcmV0dXJuIENvbm5lY3Rvci5jcmVhdGVDb25uZWN0b3IoZHJpdmVyLCBjb25uZWN0aW9uU3RyaW5nLCB7IGxvZ2dlcjogY29udGV4dC5sb2dnZXIsIC4uLm9wdGlvbnMgfSk7ICAgICAgIFxuIH1cblxuIGFzeW5jIGZ1bmN0aW9uIGltcG9ydERhdGFGaWxlcyhtaWdyYXRvciwgZm9sZGVyTmFtZSkge1xuICAgIGxldCBkYXRhU2V0UGF0aCA9IHBhdGguam9pbihtaWdyYXRvci5kYlNjcmlwdFBhdGgsICdkYXRhJywgZm9sZGVyTmFtZSk7XG4gICAgbGV0IGRhdGFMaXN0RmlsZSA9IHBhdGguam9pbihkYXRhU2V0UGF0aCwgJ2luZGV4Lmxpc3QnKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhkYXRhTGlzdEZpbGUpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZGF0YUxpc3QgPSBmcy5yZWFkRmlsZVN5bmMoZGF0YUxpc3RGaWxlKS50b1N0cmluZygpLm1hdGNoKC9eLiskL2dtKTtcblxuICAgIHJldHVybiBlYWNoQXN5bmNfKGRhdGFMaXN0LCBhc3luYyBsaW5lID0+IHtcbiAgICAgICAgbGluZSA9IGxpbmUudHJpbSgpO1xuXG4gICAgICAgIGlmIChsaW5lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxldCBkYXRhRmlsZSA9IHBhdGguam9pbihkYXRhU2V0UGF0aCwgbGluZSk7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGF0YUZpbGUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhIGZpbGUgXCIke2RhdGFGaWxlfVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgbWlncmF0b3IubG9hZF8oZGF0YUZpbGUpO1xuICAgICAgICB9XG4gICAgfSk7XG4gfVxuXG4vKipcbiAqIEJ1aWxkIGRhdGFiYXNlIHNjcmlwdHMgYW5kIGVudGl0eSBtb2RlbHMgZnJvbSBvb2xvbmcgZmlsZXMuXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZHNsU291cmNlUGF0aFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQubW9kZWxPdXRwdXRQYXRoICAgICAgICAgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5zY3JpcHRPdXRwdXRQYXRoXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5tYW5pZmVzdE91dHB1dFBhdGhcbiAqIEBwcm9wZXJ0eSB7Ym9vbH0gY29udGV4dC51c2VKc29uU291cmNlXG4gKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5zY2hlbWFEZXBsb3ltZW50ICAgXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuZXhwb3J0cy5idWlsZF8gPSBhc3luYyAoY29udGV4dCkgPT4ge1xuICAgIGNvbnRleHQubG9nZ2VyLmxvZygndmVyYm9zZScsICdTdGFydCBidWlsZGluZyBtb2RlbHMgLi4uJyk7XG5cbiAgICBsZXQgbGlua2VyID0gbmV3IExpbmtlcihjb250ZXh0KTtcbiAgICBjb250ZXh0LmxpbmtlciA9IGxpbmtlcjtcblxuICAgIGxldCBzY2hlbWFGaWxlcyA9IExpbmtlci5nZXRPb2xvbmdGaWxlcyhjb250ZXh0LmRzbFNvdXJjZVBhdGgsIGNvbnRleHQudXNlSnNvblNvdXJjZSk7XG4gICAgc2NoZW1hRmlsZXMuZm9yRWFjaChzY2hlbWFGaWxlID0+IGxpbmtlci5saW5rKHNjaGVtYUZpbGUpKTsgICAgXG5cbiAgICByZXR1cm4gZWFjaEFzeW5jXyhsaW5rZXIuc2NoZW1hcywgYXN5bmMgKHNjaGVtYSwgc2NoZW1hTmFtZSkgPT4geyAgICAgICAgXG4gICAgICAgIGxldCBjb25uZWN0b3IgPSBjcmVhdGVDb25uZWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSk7XG4gICAgICAgIGFzc2VydDogY29ubmVjdG9yO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgRGJNb2RlbGVyID0gcmVxdWlyZShgLi4vbW9kZWxlci9kYXRhYmFzZS8ke2Nvbm5lY3Rvci5kcml2ZXJ9L01vZGVsZXJgKTtcbiAgICAgICAgICAgIGxldCBkYk1vZGVsZXIgPSBuZXcgRGJNb2RlbGVyKGNvbnRleHQsIGNvbm5lY3Rvcik7XG4gICAgICAgICAgICBsZXQgcmVmaW5lZFNjaGVtYSA9IGRiTW9kZWxlci5tb2RlbGluZyhzY2hlbWEpO1xuXG4gICAgICAgICAgICBjb25zdCBEYW9Nb2RlbGVyID0gcmVxdWlyZSgnLi4vbW9kZWxlci9EYW8nKTtcbiAgICAgICAgICAgIGxldCBkYW9Nb2RlbGVyID0gbmV3IERhb01vZGVsZXIoY29udGV4dCwgY29ubmVjdG9yKTtcblxuICAgICAgICAgICAgYXdhaXQgZGFvTW9kZWxlci5tb2RlbGluZ18ocmVmaW5lZFNjaGVtYSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IGNvbm5lY3Rvci5lbmRfKCk7XG4gICAgICAgIH0gXG4gICAgfSk7ICAgICAgICAgICAgXG59O1xuXG4vKipcbiAqIERlcGxveSBkYXRhYmFzZSBzY3JpcHRzIGludG8gZGF0YWJhc2UuXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQubW9kZWxQYXRoXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5kc2xTb3VyY2VQYXRoIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuc2NyaXB0U291cmNlUGF0aCBcbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjb250ZXh0LnNjaGVtYURlcGxveW1lbnQgICBcbiAqIEBwYXJhbSB7Ym9vbH0gcmVzZXRcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxuICovXG5leHBvcnRzLm1pZ3JhdGVfID0gYXN5bmMgKGNvbnRleHQsIHJlc2V0ID0gZmFsc2UpID0+IHtcbiAgICBjb250ZXh0LmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCAnU3RhcnQgZGVwbG95aW5nIG1vZGVscyAuLi4nKTtcblxuICAgIHJldHVybiBlYWNoQXN5bmNfKGNvbnRleHQuc2NoZW1hRGVwbG95bWVudCwgYXN5bmMgKGRlcGxveW1lbnQsIHNjaGVtYU5hbWUpID0+IHtcbiAgICAgICAgbGV0IGNvbm5lY3RvciA9IGNyZWF0ZUNvbm5lY3Rvcihjb250ZXh0LCBzY2hlbWFOYW1lKTtcbiAgICAgICAgYXNzZXJ0OiBjb25uZWN0b3I7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBNaWdyYXRpb24gPSByZXF1aXJlKGAuLi9taWdyYXRpb24vJHtjb25uZWN0b3IuZHJpdmVyfWApO1xuICAgICAgICAgICAgbGV0IG1pZ3JhdGlvbiA9IG5ldyBNaWdyYXRpb24oY29udGV4dCwgc2NoZW1hTmFtZSwgY29ubmVjdG9yKTtcblxuICAgICAgICAgICAgaWYgKHJlc2V0KSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgbWlncmF0aW9uLnJlc2V0XygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCBtaWdyYXRpb24uY3JlYXRlXygpO1xuXG4gICAgICAgICAgICBhd2FpdCBpbXBvcnREYXRhRmlsZXMobWlncmF0aW9uLCAnX2luaXQnKTsgICAgICAgICAgICBcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYXdhaXQgY29ubmVjdG9yLmVuZF8oKTtcbiAgICAgICAgfSBcbiAgICB9KTtcbn07XG5cbi8qKlxuICogSW1wb3J0IGEgZGF0YSBzZXQgaW50byBkYXRhYmFzZVxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciAtIExvZ2dlciBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7QXBwTW9kdWxlfSBjb250ZXh0LmN1cnJlbnRBcHAgLSBDdXJyZW50IGFwcCBtb2R1bGVcbiAqIEBwcm9wZXJ0eSB7Ym9vbH0gY29udGV4dC52ZXJib3NlIC0gVmVyYm9zZSBtb2RlXG4gKiBAcGFyYW0ge3N0cmluZ30gZGJcbiAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhU2V0RGlyXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuZXhwb3J0cy5pbXBvcnQgPSBhc3luYyAoY29udGV4dCwgZGIsIGRhdGFTZXREaXIpID0+IHtcbiAgICBsZXQgWyBkYlR5cGUsIF0gPSBkYi5zcGxpdCgnOicpO1xuXG4gICAgbGV0IGRhdGFMaXN0RmlsZSA9IHBhdGguam9pbihkYXRhU2V0RGlyLCAnaW5kZXgubGlzdCcpO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRhdGFMaXN0RmlsZSkpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBEYXRhIGVudHJ5IGxpc3QgZmlsZSBcIiR7ZGF0YUxpc3RGaWxlfVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBsZXQgZGF0YUxpc3QgPSBmcy5yZWFkRmlsZVN5bmMoZGF0YUxpc3RGaWxlKS50b1N0cmluZygpLm1hdGNoKC9eLiskL2dtKTtcbiAgICBsZXQgRGVwbG95ZXIgPSByZXF1aXJlKGAuLi9kZXBsb3llci9kYi8ke2RiVHlwZX0uanNgKTtcbiAgICBsZXQgc2VydmljZSA9IGNvbnRleHQuY3VycmVudEFwcC5nZXRTZXJ2aWNlKGRiKTtcbiAgICBsZXQgZGVwbG95ZXIgPSBuZXcgRGVwbG95ZXIoY29udGV4dCwgc2VydmljZSk7XG5cbiAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKGRhdGFMaXN0LCBhc3luYyBsaW5lID0+IHtcbiAgICAgICAgbGluZSA9IGxpbmUudHJpbSgpO1xuXG4gICAgICAgIGlmIChsaW5lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGxldCBkYXRhRmlsZSA9IHBhdGguam9pbihkYXRhU2V0RGlyLCBsaW5lKTtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkYXRhRmlsZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYERhdGEgZmlsZSBcIiR7ZGF0YUZpbGV9XCIgbm90IGZvdW5kLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCBkZXBsb3llci5sb2FkRGF0YShkYXRhRmlsZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbi8qKlxuICogRXh0cmFjdCBkYXRhYmFzZSBzdHJ1Y3R1cmUgaW50byBvb2xvbmcgZHNsXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICogQHByb3BlcnR5IHtDb25uZWN0b3J9IGNvbnRleHQuY29ubmVjdG9yXG4gKiBAcHJvcGVydHkge0xvZ2dlcn0gY29udGV4dC5sb2dnZXIgXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29udGV4dC5kc2xSZXZlcnNlT3V0cHV0RGlyIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZHJpdmVyXG4gKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5jb25uT3B0aW9ucyBcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxuICovXG5leHBvcnRzLnJldmVyc2VfID0gYXN5bmMgKGNvbnRleHQpID0+IHsgICBcbiAgICBsZXQgUmVzZXJ2ZUVuZ2luZWVyaW5nID0gcmVxdWlyZShgLi4vbW9kZWxlci9kYXRhYmFzZS8ke2NvbnRleHQuZHJpdmVyfS9SZXZlcnNlRW5naW5lZXJpbmdgKTtcbiAgICBcbiAgICBsZXQgeyBjb25uZWN0aW9uOiBjb25uZWN0aW9uU3RyaW5nLCAuLi5vcHRpb25zIH0gPSBjb250ZXh0LmNvbm5PcHRpb25zOyAgXG4gICAgbGV0IGNvbm5lY3RvciA9IENvbm5lY3Rvci5jcmVhdGVDb25uZWN0b3IoY29udGV4dC5kcml2ZXIsIGNvbm5lY3Rpb25TdHJpbmcsIHsgbG9nZ2VyOiBjb250ZXh0LmxvZ2dlciwgLi4ub3B0aW9ucyB9KTsgICAgIFxuICAgIGFzc2VydDogY29ubmVjdG9yOyAgXG5cbiAgICB0cnkge1xuICAgICAgICBsZXQgbW9kZWxlciA9IG5ldyBSZXNlcnZlRW5naW5lZXJpbmcoY29udGV4dCwgY29ubmVjdG9yKTtcblxuICAgICAgICBhd2FpdCBtb2RlbGVyLnJldmVyc2VfKGNvbnRleHQuZHNsUmV2ZXJzZU91dHB1dERpcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgICAgYXdhaXQgY29ubmVjdG9yLmVuZF8oKTtcbiAgICB9IFxufTsiXX0=