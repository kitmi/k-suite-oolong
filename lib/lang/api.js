"use strict";

require("source-map-support/register");

const path = require('path');

const Util = require('rk-utils');

const {
  _,
  fs,
  eachAsync_
} = Util;

const Linker = require('./Linker');

const Connector = require('../runtime/Connector');

function createConnector(context, schemaName) {
  let deployment = context.schemaDeployment[schemaName];

  if (!deployment) {
    context.logger.log('warn', `Schema "${schemaName}" has no configured deployment and is ignored in modeling.`);
    return;
  }

  let {
    dataSource,
    connectionString,
    options
  } = deployment;
  let [driver] = dataSource.split('.');
  console.log(driver, connectionString);
  return Connector.createConnector(driver, connectionString, {
    logger: context.logger,
    ...options
  });
}

async function importDataFiles(migrator, folderName) {
  let dataSetPath = path.join(migrator.dbScriptPath, 'data', folderName);
  let dataListFile = path.join(dataSetPath, 'index.list');

  if (!fs.existsSync(dataListFile)) {
    throw new Error(`Entry file of dataset "${folderName}" not found.`);
  }

  let dataList = fs.readFileSync(dataListFile).toString().match(/^.+$/gm);
  return eachAsync_(dataList, async line => {
    line = line.trim();

    if (line.length > 0) {
      let dataFile = path.join(dataSetPath, line);

      if (!fs.existsSync(dataFile)) {
        throw new Error(`Data file "${dataFile}" not found.`);
      }

      await migrator.load_(dataFile);
    }
  });
}

exports.build_ = async context => {
  context.logger.log('verbose', 'Start building models ...');
  let linker = new Linker(context);
  context.linker = linker;
  let schemaFiles = Linker.getOolongFiles(context.dslSourcePath, context.useJsonSource);
  schemaFiles.forEach(schemaFile => linker.link(schemaFile));
  return eachAsync_(linker.schemas, async (schema, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    let deploymentSetting = context.schemaDeployment[schemaName];

    try {
      let DbModeler = require(`../modeler/database/${connector.driver}/Modeler`);

      let dbModeler = new DbModeler(context, connector, deploymentSetting.extraOptions);
      let refinedSchema = dbModeler.modeling(schema);

      const DaoModeler = require('../modeler/Dao');

      let daoModeler = new DaoModeler(context, connector);
      await daoModeler.modeling_(refinedSchema);
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.migrate_ = async (context, reset = false) => {
  context.logger.log('verbose', 'Start deploying models ...');
  return eachAsync_(context.schemaDeployment, async (deployment, schemaName) => {
    let connector = createConnector(context, schemaName);

    if (!connector) {
      throw new Error("Assertion failed: connector");
    }

    try {
      let Migration = require(`../migration/${connector.driver}`);

      let migration = new Migration(context, schemaName, connector);

      if (reset) {
        await migration.reset_();
      }

      await migration.create_(deployment.extraOptions);
      await importDataFiles(migration, '_init');
    } catch (error) {
      throw error;
    } finally {
      await connector.end_();
    }
  });
};

exports.dataset_ = async (context, schemaName) => {
  let connector = createConnector(context, schemaName);

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  let dataSetPath = path.join(context.scriptSourcePath, connector.driver, connector.database, 'data');

  if (!fs.existsSync(dataSetPath)) {
    return [];
  } else {
    let dataSets = fs.readdirSync(dataSetPath);
    let validDs = [];
    dataSets.forEach(ds => {
      let indexFile = path.join(dataSetPath, ds, 'index.list');

      if (fs.existsSync(indexFile)) {
        validDs.push(ds);
      }
    });
    return validDs;
  }
};

exports.import_ = async (context, schemaName, datasetName) => {
  let connector = createConnector(context, schemaName);

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  try {
    let Migration = require(`../migration/${connector.driver}`);

    let migration = new Migration(context, schemaName, connector);
    await importDataFiles(migration, datasetName);
  } catch (error) {
    throw error;
  } finally {
    await connector.end_();
  }
};

exports.reverse_ = async context => {
  let ReserveEngineering = require(`../modeler/database/${context.driver}/ReverseEngineering`);

  let {
    connection: connectionString,
    ...options
  } = context.connOptions;
  let connector = Connector.createConnector(context.driver, connectionString, {
    logger: context.logger,
    ...options
  });

  if (!connector) {
    throw new Error("Assertion failed: connector");
  }

  try {
    let modeler = new ReserveEngineering(context, connector);
    await modeler.reverse_(context.dslReverseOutputPath);
  } catch (error) {
    throw error;
  } finally {
    await connector.end_();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5nL2FwaS5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIlV0aWwiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwiTGlua2VyIiwiQ29ubmVjdG9yIiwiY3JlYXRlQ29ubmVjdG9yIiwiY29udGV4dCIsInNjaGVtYU5hbWUiLCJkZXBsb3ltZW50Iiwic2NoZW1hRGVwbG95bWVudCIsImxvZ2dlciIsImxvZyIsImRhdGFTb3VyY2UiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsImRyaXZlciIsInNwbGl0IiwiY29uc29sZSIsImltcG9ydERhdGFGaWxlcyIsIm1pZ3JhdG9yIiwiZm9sZGVyTmFtZSIsImRhdGFTZXRQYXRoIiwiam9pbiIsImRiU2NyaXB0UGF0aCIsImRhdGFMaXN0RmlsZSIsImV4aXN0c1N5bmMiLCJFcnJvciIsImRhdGFMaXN0IiwicmVhZEZpbGVTeW5jIiwidG9TdHJpbmciLCJtYXRjaCIsImxpbmUiLCJ0cmltIiwibGVuZ3RoIiwiZGF0YUZpbGUiLCJsb2FkXyIsImV4cG9ydHMiLCJidWlsZF8iLCJsaW5rZXIiLCJzY2hlbWFGaWxlcyIsImdldE9vbG9uZ0ZpbGVzIiwiZHNsU291cmNlUGF0aCIsInVzZUpzb25Tb3VyY2UiLCJmb3JFYWNoIiwic2NoZW1hRmlsZSIsImxpbmsiLCJzY2hlbWFzIiwic2NoZW1hIiwiY29ubmVjdG9yIiwiZGVwbG95bWVudFNldHRpbmciLCJEYk1vZGVsZXIiLCJkYk1vZGVsZXIiLCJleHRyYU9wdGlvbnMiLCJyZWZpbmVkU2NoZW1hIiwibW9kZWxpbmciLCJEYW9Nb2RlbGVyIiwiZGFvTW9kZWxlciIsIm1vZGVsaW5nXyIsImVycm9yIiwiZW5kXyIsIm1pZ3JhdGVfIiwicmVzZXQiLCJNaWdyYXRpb24iLCJtaWdyYXRpb24iLCJyZXNldF8iLCJjcmVhdGVfIiwiZGF0YXNldF8iLCJzY3JpcHRTb3VyY2VQYXRoIiwiZGF0YWJhc2UiLCJkYXRhU2V0cyIsInJlYWRkaXJTeW5jIiwidmFsaWREcyIsImRzIiwiaW5kZXhGaWxlIiwicHVzaCIsImltcG9ydF8iLCJkYXRhc2V0TmFtZSIsInJldmVyc2VfIiwiUmVzZXJ2ZUVuZ2luZWVyaW5nIiwiY29ubmVjdGlvbiIsImNvbm5PcHRpb25zIiwibW9kZWxlciIsImRzbFJldmVyc2VPdXRwdXRQYXRoIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBRUEsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQTtBQUFULElBQXdCSCxJQUE5Qjs7QUFFQSxNQUFNSSxNQUFNLEdBQUdMLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLE1BQU1NLFNBQVMsR0FBR04sT0FBTyxDQUFDLHNCQUFELENBQXpCOztBQU9DLFNBQVNPLGVBQVQsQ0FBeUJDLE9BQXpCLEVBQWtDQyxVQUFsQyxFQUE4QztBQUMzQyxNQUFJQyxVQUFVLEdBQUdGLE9BQU8sQ0FBQ0csZ0JBQVIsQ0FBeUJGLFVBQXpCLENBQWpCOztBQUVBLE1BQUksQ0FBQ0MsVUFBTCxFQUFpQjtBQUNiRixJQUFBQSxPQUFPLENBQUNJLE1BQVIsQ0FBZUMsR0FBZixDQUFtQixNQUFuQixFQUE0QixXQUFVSixVQUFXLDREQUFqRDtBQUNBO0FBQ0g7O0FBRUQsTUFBSTtBQUFFSyxJQUFBQSxVQUFGO0FBQWNDLElBQUFBLGdCQUFkO0FBQWdDQyxJQUFBQTtBQUFoQyxNQUE0Q04sVUFBaEQ7QUFDQSxNQUFJLENBQUVPLE1BQUYsSUFBYUgsVUFBVSxDQUFDSSxLQUFYLENBQWlCLEdBQWpCLENBQWpCO0FBRUFDLEVBQUFBLE9BQU8sQ0FBQ04sR0FBUixDQUFZSSxNQUFaLEVBQW9CRixnQkFBcEI7QUFFQSxTQUFPVCxTQUFTLENBQUNDLGVBQVYsQ0FBMEJVLE1BQTFCLEVBQWtDRixnQkFBbEMsRUFBb0Q7QUFB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TyxDQUFDNEUsb0JBQXpCLENBQU47QUFDSCxHQUpELENBSUUsT0FBT3hCLEtBQVAsRUFBYztBQUNaLFVBQU1BLEtBQU47QUFDSCxHQU5ELFNBTVU7QUFDTixVQUFNVixTQUFTLENBQUNXLElBQVYsRUFBTjtBQUNIO0FBQ0osQ0FoQkQiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfIH0gPSBVdGlsO1xuXG5jb25zdCBMaW5rZXIgPSByZXF1aXJlKCcuL0xpbmtlcicpO1xuY29uc3QgQ29ubmVjdG9yID0gcmVxdWlyZSgnLi4vcnVudGltZS9Db25uZWN0b3InKTtcblxuLyoqXG4gKiBPb2xvbmcgRFNMIGFwaVxuICogQG1vZHVsZSBPb2xvbmdcbiAqL1xuXG4gZnVuY3Rpb24gY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUpIHtcbiAgICBsZXQgZGVwbG95bWVudCA9IGNvbnRleHQuc2NoZW1hRGVwbG95bWVudFtzY2hlbWFOYW1lXTtcblxuICAgIGlmICghZGVwbG95bWVudCkge1xuICAgICAgICBjb250ZXh0LmxvZ2dlci5sb2coJ3dhcm4nLCBgU2NoZW1hIFwiJHtzY2hlbWFOYW1lfVwiIGhhcyBubyBjb25maWd1cmVkIGRlcGxveW1lbnQgYW5kIGlzIGlnbm9yZWQgaW4gbW9kZWxpbmcuYCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgeyBkYXRhU291cmNlLCBjb25uZWN0aW9uU3RyaW5nLCBvcHRpb25zIH0gPSBkZXBsb3ltZW50O1xuICAgIGxldCBbIGRyaXZlciBdID0gZGF0YVNvdXJjZS5zcGxpdCgnLicpO1xuXG4gICAgY29uc29sZS5sb2coZHJpdmVyLCBjb25uZWN0aW9uU3RyaW5nKTtcblxuICAgIHJldHVybiBDb25uZWN0b3IuY3JlYXRlQ29ubmVjdG9yKGRyaXZlciwgY29ubmVjdGlvblN0cmluZywgeyBsb2dnZXI6IGNvbnRleHQubG9nZ2VyLCAuLi5vcHRpb25zIH0pOyAgICAgICBcbiB9XG5cbiBhc3luYyBmdW5jdGlvbiBpbXBvcnREYXRhRmlsZXMobWlncmF0b3IsIGZvbGRlck5hbWUpIHtcbiAgICBsZXQgZGF0YVNldFBhdGggPSBwYXRoLmpvaW4obWlncmF0b3IuZGJTY3JpcHRQYXRoLCAnZGF0YScsIGZvbGRlck5hbWUpO1xuICAgIGxldCBkYXRhTGlzdEZpbGUgPSBwYXRoLmpvaW4oZGF0YVNldFBhdGgsICdpbmRleC5saXN0Jyk7XG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGF0YUxpc3RGaWxlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudHJ5IGZpbGUgb2YgZGF0YXNldCBcIiR7Zm9sZGVyTmFtZX1cIiBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgbGV0IGRhdGFMaXN0ID0gZnMucmVhZEZpbGVTeW5jKGRhdGFMaXN0RmlsZSkudG9TdHJpbmcoKS5tYXRjaCgvXi4rJC9nbSk7XG5cbiAgICByZXR1cm4gZWFjaEFzeW5jXyhkYXRhTGlzdCwgYXN5bmMgbGluZSA9PiB7XG4gICAgICAgIGxpbmUgPSBsaW5lLnRyaW0oKTtcblxuICAgICAgICBpZiAobGluZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsZXQgZGF0YUZpbGUgPSBwYXRoLmpvaW4oZGF0YVNldFBhdGgsIGxpbmUpO1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRhdGFGaWxlKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRGF0YSBmaWxlIFwiJHtkYXRhRmlsZX1cIiBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IG1pZ3JhdG9yLmxvYWRfKGRhdGFGaWxlKTtcbiAgICAgICAgfVxuICAgIH0pO1xuIH1cblxuLyoqXG4gKiBCdWlsZCBkYXRhYmFzZSBzY3JpcHRzIGFuZCBlbnRpdHkgbW9kZWxzIGZyb20gb29sb25nIGZpbGVzLlxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciAtIExvZ2dlciBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmRzbFNvdXJjZVBhdGhcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0Lm1vZGVsT3V0cHV0UGF0aCAgICAgICAgIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuc2NyaXB0T3V0cHV0UGF0aFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQubWFuaWZlc3RPdXRwdXRQYXRoXG4gKiBAcHJvcGVydHkge2Jvb2x9IGNvbnRleHQudXNlSnNvblNvdXJjZVxuICogQHByb3BlcnR5IHtvYmplY3R9IGNvbnRleHQuc2NoZW1hRGVwbG95bWVudCAgIFxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmV4cG9ydHMuYnVpbGRfID0gYXN5bmMgKGNvbnRleHQpID0+IHtcbiAgICBjb250ZXh0LmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCAnU3RhcnQgYnVpbGRpbmcgbW9kZWxzIC4uLicpO1xuXG4gICAgbGV0IGxpbmtlciA9IG5ldyBMaW5rZXIoY29udGV4dCk7XG4gICAgY29udGV4dC5saW5rZXIgPSBsaW5rZXI7XG5cbiAgICBsZXQgc2NoZW1hRmlsZXMgPSBMaW5rZXIuZ2V0T29sb25nRmlsZXMoY29udGV4dC5kc2xTb3VyY2VQYXRoLCBjb250ZXh0LnVzZUpzb25Tb3VyY2UpO1xuICAgIHNjaGVtYUZpbGVzLmZvckVhY2goc2NoZW1hRmlsZSA9PiBsaW5rZXIubGluayhzY2hlbWFGaWxlKSk7ICAgIFxuXG4gICAgcmV0dXJuIGVhY2hBc3luY18obGlua2VyLnNjaGVtYXMsIGFzeW5jIChzY2hlbWEsIHNjaGVtYU5hbWUpID0+IHsgICAgICAgIFxuICAgICAgICBsZXQgY29ubmVjdG9yID0gY3JlYXRlQ29ubmVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUpO1xuICAgICAgICBhc3NlcnQ6IGNvbm5lY3RvcjtcblxuICAgICAgICBsZXQgZGVwbG95bWVudFNldHRpbmcgPSBjb250ZXh0LnNjaGVtYURlcGxveW1lbnRbc2NoZW1hTmFtZV07XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBEYk1vZGVsZXIgPSByZXF1aXJlKGAuLi9tb2RlbGVyL2RhdGFiYXNlLyR7Y29ubmVjdG9yLmRyaXZlcn0vTW9kZWxlcmApO1xuICAgICAgICAgICAgbGV0IGRiTW9kZWxlciA9IG5ldyBEYk1vZGVsZXIoY29udGV4dCwgY29ubmVjdG9yLCBkZXBsb3ltZW50U2V0dGluZy5leHRyYU9wdGlvbnMpO1xuICAgICAgICAgICAgbGV0IHJlZmluZWRTY2hlbWEgPSBkYk1vZGVsZXIubW9kZWxpbmcoc2NoZW1hKTtcblxuICAgICAgICAgICAgY29uc3QgRGFvTW9kZWxlciA9IHJlcXVpcmUoJy4uL21vZGVsZXIvRGFvJyk7XG4gICAgICAgICAgICBsZXQgZGFvTW9kZWxlciA9IG5ldyBEYW9Nb2RlbGVyKGNvbnRleHQsIGNvbm5lY3Rvcik7XG5cbiAgICAgICAgICAgIGF3YWl0IGRhb01vZGVsZXIubW9kZWxpbmdfKHJlZmluZWRTY2hlbWEpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhd2FpdCBjb25uZWN0b3IuZW5kXygpO1xuICAgICAgICB9IFxuICAgIH0pOyAgICAgICAgICAgIFxufTtcblxuLyoqXG4gKiBEZXBsb3kgZGF0YWJhc2Ugc2NyaXB0cyBpbnRvIGRhdGFiYXNlLlxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciAtIExvZ2dlciBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0Lm1vZGVsUGF0aFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZHNsU291cmNlUGF0aCBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LnNjcmlwdFNvdXJjZVBhdGggXG4gKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5zY2hlbWFEZXBsb3ltZW50ICAgXG4gKiBAcGFyYW0ge2Jvb2x9IHJlc2V0XG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuZXhwb3J0cy5taWdyYXRlXyA9IGFzeW5jIChjb250ZXh0LCByZXNldCA9IGZhbHNlKSA9PiB7XG4gICAgY29udGV4dC5sb2dnZXIubG9nKCd2ZXJib3NlJywgJ1N0YXJ0IGRlcGxveWluZyBtb2RlbHMgLi4uJyk7XG5cbiAgICByZXR1cm4gZWFjaEFzeW5jXyhjb250ZXh0LnNjaGVtYURlcGxveW1lbnQsIGFzeW5jIChkZXBsb3ltZW50LCBzY2hlbWFOYW1lKSA9PiB7XG4gICAgICAgIGxldCBjb25uZWN0b3IgPSBjcmVhdGVDb25uZWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSk7XG4gICAgICAgIGFzc2VydDogY29ubmVjdG9yO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgTWlncmF0aW9uID0gcmVxdWlyZShgLi4vbWlncmF0aW9uLyR7Y29ubmVjdG9yLmRyaXZlcn1gKTtcbiAgICAgICAgICAgIGxldCBtaWdyYXRpb24gPSBuZXcgTWlncmF0aW9uKGNvbnRleHQsIHNjaGVtYU5hbWUsIGNvbm5lY3Rvcik7XG5cbiAgICAgICAgICAgIGlmIChyZXNldCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IG1pZ3JhdGlvbi5yZXNldF8oKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgbWlncmF0aW9uLmNyZWF0ZV8oZGVwbG95bWVudC5leHRyYU9wdGlvbnMpO1xuXG4gICAgICAgICAgICBhd2FpdCBpbXBvcnREYXRhRmlsZXMobWlncmF0aW9uLCAnX2luaXQnKTsgICAgICAgICAgICBcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYXdhaXQgY29ubmVjdG9yLmVuZF8oKTtcbiAgICAgICAgfSBcbiAgICB9KTtcbn07XG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAqIEBwYXJhbSB7c3RyaW5nfSBzY2hlbWFOYW1lXG4gKi9cbmV4cG9ydHMuZGF0YXNldF8gPSBhc3luYyAoY29udGV4dCwgc2NoZW1hTmFtZSkgPT4ge1xuICAgIGxldCBjb25uZWN0b3IgPSBjcmVhdGVDb25uZWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSk7XG4gICAgYXNzZXJ0OiBjb25uZWN0b3I7XG4gICAgXG4gICAgbGV0IGRhdGFTZXRQYXRoID0gcGF0aC5qb2luKGNvbnRleHQuc2NyaXB0U291cmNlUGF0aCwgY29ubmVjdG9yLmRyaXZlciwgY29ubmVjdG9yLmRhdGFiYXNlLCAnZGF0YScpO1xuXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRhdGFTZXRQYXRoKSkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGRhdGFTZXRzID0gZnMucmVhZGRpclN5bmMoZGF0YVNldFBhdGgpO1xuICAgICAgICBsZXQgdmFsaWREcyA9IFtdO1xuICAgICAgICBkYXRhU2V0cy5mb3JFYWNoKGRzID0+IHtcbiAgICAgICAgICAgIGxldCBpbmRleEZpbGUgPSBwYXRoLmpvaW4oZGF0YVNldFBhdGgsIGRzLCAnaW5kZXgubGlzdCcpO1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoaW5kZXhGaWxlKSkge1xuICAgICAgICAgICAgICAgIHZhbGlkRHMucHVzaChkcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB2YWxpZERzO1xuICAgIH1cbn1cblxuLyoqXG4gKiBJbXBvcnQgYSBkYXRhIHNldCBpbnRvIGRhdGFiYXNlXG4gKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICogQHByb3BlcnR5IHtMb2dnZXJ9IGNvbnRleHQubG9nZ2VyIC0gTG9nZ2VyIG9iamVjdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuc2NyaXB0U291cmNlUGF0aCAgXG4gKiBAcGFyYW0ge3N0cmluZ30gc2NoZW1hTmFtZVxuICogQHBhcmFtIHtzdHJpbmd9IGRhdGFzZXROYW1lXG4gKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAqL1xuZXhwb3J0cy5pbXBvcnRfID0gYXN5bmMgKGNvbnRleHQsIHNjaGVtYU5hbWUsIGRhdGFzZXROYW1lKSA9PiB7XG4gICAgbGV0IGNvbm5lY3RvciA9IGNyZWF0ZUNvbm5lY3Rvcihjb250ZXh0LCBzY2hlbWFOYW1lKTtcbiAgICBhc3NlcnQ6IGNvbm5lY3RvcjtcbiAgICBcbiAgICB0cnkge1xuICAgICAgICBsZXQgTWlncmF0aW9uID0gcmVxdWlyZShgLi4vbWlncmF0aW9uLyR7Y29ubmVjdG9yLmRyaXZlcn1gKTtcbiAgICAgICAgbGV0IG1pZ3JhdGlvbiA9IG5ldyBNaWdyYXRpb24oY29udGV4dCwgc2NoZW1hTmFtZSwgY29ubmVjdG9yKTtcblxuICAgICAgICBhd2FpdCBpbXBvcnREYXRhRmlsZXMobWlncmF0aW9uLCBkYXRhc2V0TmFtZSk7ICAgICAgICAgICAgXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgICAgYXdhaXQgY29ubmVjdG9yLmVuZF8oKTtcbiAgICB9IFxufTtcblxuLyoqXG4gKiBFeHRyYWN0IGRhdGFiYXNlIHN0cnVjdHVyZSBpbnRvIG9vbG9uZyBkc2xcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gKiBAcHJvcGVydHkge0Nvbm5lY3Rvcn0gY29udGV4dC5jb25uZWN0b3JcbiAqIEBwcm9wZXJ0eSB7TG9nZ2VyfSBjb250ZXh0LmxvZ2dlciBcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZXh0LmRzbFJldmVyc2VPdXRwdXRQYXRoIFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbnRleHQuZHJpdmVyXG4gKiBAcHJvcGVydHkge29iamVjdH0gY29udGV4dC5jb25uT3B0aW9ucyBcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxuICovXG5leHBvcnRzLnJldmVyc2VfID0gYXN5bmMgKGNvbnRleHQpID0+IHsgICBcbiAgICBsZXQgUmVzZXJ2ZUVuZ2luZWVyaW5nID0gcmVxdWlyZShgLi4vbW9kZWxlci9kYXRhYmFzZS8ke2NvbnRleHQuZHJpdmVyfS9SZXZlcnNlRW5naW5lZXJpbmdgKTtcbiAgICBcbiAgICBsZXQgeyBjb25uZWN0aW9uOiBjb25uZWN0aW9uU3RyaW5nLCAuLi5vcHRpb25zIH0gPSBjb250ZXh0LmNvbm5PcHRpb25zOyAgXG4gICAgbGV0IGNvbm5lY3RvciA9IENvbm5lY3Rvci5jcmVhdGVDb25uZWN0b3IoY29udGV4dC5kcml2ZXIsIGNvbm5lY3Rpb25TdHJpbmcsIHsgbG9nZ2VyOiBjb250ZXh0LmxvZ2dlciwgLi4ub3B0aW9ucyB9KTsgICAgIFxuICAgIGFzc2VydDogY29ubmVjdG9yOyAgXG5cbiAgICB0cnkge1xuICAgICAgICBsZXQgbW9kZWxlciA9IG5ldyBSZXNlcnZlRW5naW5lZXJpbmcoY29udGV4dCwgY29ubmVjdG9yKTtcblxuICAgICAgICBhd2FpdCBtb2RlbGVyLnJldmVyc2VfKGNvbnRleHQuZHNsUmV2ZXJzZU91dHB1dFBhdGgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IGNvbm5lY3Rvci5lbmRfKCk7XG4gICAgfSBcbn07Il19