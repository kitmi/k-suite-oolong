"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  pascalCase,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(context, schemaName, connector) {
    this.logger = context.logger;
    this.modelPath = context.modelPath;
    this.scriptSourcePath = context.scriptSourcePath;
    this.schemaName = schemaName;
    this.connector = connector;
    this.dbScriptPath = path.join(this.scriptSourcePath, this.connector.driver, this.connector.database);
  }

  async reset_() {
    return this.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.connector.execute_(sqlCreate, [this.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.logger.log('info', `Created database "${this.connector.database}".`);
    } else {
      this.logger.log('warn', `Database "${this.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.logger.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.logger.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile) {
    let ext = path.extname(dataFile);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });

      if (Array.isArray(data)) {
        let entityName = path.basename(dataFile, ext);
        await this._loadSingleEntityRecords_(entityName, data);
      } else {
        await this._loadMultiEntityRecords_(data);
      }
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.logger.log('verbose', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadMultiEntityRecords_(data);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async _loadMultiEntityRecords_(data) {
    let className = pascalCase(this.schemaName);

    let Db = require(path.join(this.modelPath, className));

    let db = new Db(this.connector.connectionString, this.connector.options);

    try {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let items = Array.isArray(records) ? records : [records];
        return eachAsync_(items, item => db.model(entityName).create_(item));
      });
    } catch (error) {
      throw error;
    } finally {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
      await db.close_();
    }
  }

  async _loadSingleEntityRecords_(entityName, data) {
    let className = pascalCase(this.schemaName);

    let Db = require(path.join(this.modelPath, className));

    let db = new Db(this.connector.connectionString, this.connector.options);

    try {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, item => db.model(entityName).create_(item));
    } catch (error) {
      throw error;
    } finally {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
      await db.close_();
    }
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicGFzY2FsQ2FzZSIsInF1b3RlIiwiTXlTUUxNaWdyYXRpb24iLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJzY2hlbWFOYW1lIiwiY29ubmVjdG9yIiwibG9nZ2VyIiwibW9kZWxQYXRoIiwic2NyaXB0U291cmNlUGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwiZGIiLCJyZWR1Y2UiLCJyIiwidiIsImsiLCJ1cHBlckNhc2UiLCJ0b1N0cmluZyIsInJlc3VsdCIsIndhcm5pbmdTdGF0dXMiLCJsb2ciLCJmaWxlIiwic3FsRmlsZSIsImV4aXN0c1N5bmMiLCJFcnJvciIsInNxbCIsInRyaW0iLCJyZWFkRmlsZVN5bmMiLCJlbmNvZGluZyIsImNhc3RBcnJheSIsIm11bHRpcGxlU3RhdGVtZW50cyIsIndhcm5pbmdSb3dzIiwic3VtIiwicm93IiwibG9hZF8iLCJkYXRhRmlsZSIsImV4dCIsImV4dG5hbWUiLCJkYXRhIiwicmVhZEpzb25TeW5jIiwiQXJyYXkiLCJpc0FycmF5IiwiZW50aXR5TmFtZSIsImJhc2VuYW1lIiwiX2xvYWRTaW5nbGVFbnRpdHlSZWNvcmRzXyIsIl9sb2FkTXVsdGlFbnRpdHlSZWNvcmRzXyIsIkV4Y2VsIiwid29ya2Jvb2siLCJXb3JrYm9vayIsInhsc3giLCJyZWFkRmlsZSIsImVhY2hTaGVldCIsIndvcmtzaGVldCIsInNoZWV0SWQiLCJjb2xLZXlzIiwibmFtZSIsImVudGl0eURhdGEiLCJlYWNoUm93Iiwicm93TnVtYmVyIiwiZHJvcCIsInZhbHVlcyIsInJlY29yZCIsImZyb21QYWlycyIsInppcCIsInB1c2giLCJjbGFzc05hbWUiLCJEYiIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwicmVjb3JkcyIsIml0ZW1zIiwiaXRlbSIsIm1vZGVsIiwiZXJyb3IiLCJjbG9zZV8iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsVUFBVDtBQUFxQkMsRUFBQUEsVUFBckI7QUFBaUNDLEVBQUFBO0FBQWpDLElBQTJDTCxPQUFPLENBQUMsVUFBRCxDQUF4RDs7QUFNQSxNQUFNTSxjQUFOLENBQXFCO0FBS2pCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVUMsVUFBVixFQUFzQkMsU0FBdEIsRUFBaUM7QUFDeEMsU0FBS0MsTUFBTCxHQUFjSCxPQUFPLENBQUNHLE1BQXRCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkosT0FBTyxDQUFDSSxTQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCTCxPQUFPLENBQUNLLGdCQUFoQztBQUNBLFNBQUtKLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLSSxZQUFMLEdBQW9CZixJQUFJLENBQUNnQixJQUFMLENBQVUsS0FBS0YsZ0JBQWYsRUFBaUMsS0FBS0gsU0FBTCxDQUFlTSxNQUFoRCxFQUF3RCxLQUFLTixTQUFMLENBQWVPLFFBQXZFLENBQXBCO0FBQ0g7O0FBRUQsUUFBTUMsTUFBTixHQUFlO0FBQ1gsV0FBTyxLQUFLUixTQUFMLENBQWVTLFFBQWYsQ0FBeUIsNEJBQXpCLEVBQXNELENBQUUsS0FBS1QsU0FBTCxDQUFlTyxRQUFqQixDQUF0RCxFQUFtRjtBQUFFRyxNQUFBQSxjQUFjLEVBQUU7QUFBbEIsS0FBbkYsQ0FBUDtBQUNIOztBQUVELFFBQU1DLE9BQU4sQ0FBY0MsWUFB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QUcsSUFBSXVELEVBQUosQ0FBTyxLQUFLdkUsU0FBTCxDQUFld0UsZ0JBQXRCLEVBQXdDLEtBQUt4RSxTQUFMLENBQWV5RSxPQUF2RCxDQUFUOztBQUVBLFFBQUk7QUFDQSxZQUFNekQsRUFBRSxDQUFDaEIsU0FBSCxDQUFhUyxRQUFiLENBQXNCLDJCQUF0QixDQUFOO0FBRUEsWUFBTWhCLFVBQVUsQ0FBQ2tELElBQUQsRUFBT2lDLElBQUksSUFBSTVELEVBQUUsQ0FBQzZELEtBQUgsQ0FBUzlCLFVBQVQsRUFBcUJwQyxPQUFyQixDQUE2QmlFLElBQTdCLENBQWYsQ0FBaEI7QUFDSCxLQUpELENBSUUsT0FBT0UsS0FBUCxFQUFjO0FBQ1osWUFBTUEsS0FBTjtBQUNILEtBTkQsU0FNVTtBQUNOLFlBQU05RCxFQUFFLENBQUNoQixTQUFILENBQWFTLFFBQWIsQ0FBc0IsMkJBQXRCLENBQU47QUFDQSxZQUFNTyxFQUFFLENBQUMrRCxNQUFILEVBQU47QUFDSDtBQUNKOztBQXBKZ0I7O0FBdUpyQkMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckYsY0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgXywgZnMsIGVhY2hBc3luY18sIHBhc2NhbENhc2UsIHF1b3RlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG4vKipcbiAqIE15U1FMIG1pZ3JhdGlvbi5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBNeVNRTE1pZ3JhdGlvbiB7XG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICAgICAqIEBwYXJhbSB7Q29ubmVjdG9yfSBjb25uZWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBzY2hlbWFOYW1lLCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjtcbiAgICAgICAgdGhpcy5tb2RlbFBhdGggPSBjb250ZXh0Lm1vZGVsUGF0aDtcbiAgICAgICAgdGhpcy5zY3JpcHRTb3VyY2VQYXRoID0gY29udGV4dC5zY3JpcHRTb3VyY2VQYXRoO1xuICAgICAgICB0aGlzLnNjaGVtYU5hbWUgPSBzY2hlbWFOYW1lO1xuICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjtcblxuICAgICAgICB0aGlzLmRiU2NyaXB0UGF0aCA9IHBhdGguam9pbih0aGlzLnNjcmlwdFNvdXJjZVBhdGgsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2V0XygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKGBEUk9QIERBVEFCQVNFIElGIEVYSVNUUyA/P2AsIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UgXSwgeyBjcmVhdGVEYXRhYmFzZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGVfKGV4dHJhT3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIGxldCBzcWxGaWxlcyA9IFsgJ2VudGl0aWVzLnNxbCcsICdyZWxhdGlvbnMuc3FsJywgJ3Byb2NlZHVyZXMuc3FsJyBdO1xuXG4gICAgICAgIGxldCBzcWxDcmVhdGUgPSAnQ1JFQVRFIERBVEFCQVNFIElGIE5PVCBFWElTVFMgPz8nO1xuXG4gICAgICAgIGlmIChleHRyYU9wdGlvbnMgJiYgIV8uaXNFbXB0eShleHRyYU9wdGlvbnMuZGIpKSB7XG4gICAgICAgICAgICBzcWxDcmVhdGUgKz0gJyAnICsgXy5yZWR1Y2UoZXh0cmFPcHRpb25zLmRiLCAociwgdiwgaykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByICsgJyAnICsgXy51cHBlckNhc2UoaykgKyAnICcgKyBxdW90ZSh2LnRvU3RyaW5nKCksICdcIicpO1xuICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsQ3JlYXRlLCBcbiAgICAgICAgICAgIFsgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UgXSwgXG4gICAgICAgICAgICB7IGNyZWF0ZURhdGFiYXNlOiB0cnVlIH1cbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXN1bHQud2FybmluZ1N0YXR1cyA9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgQ3JlYXRlZCBkYXRhYmFzZSBcIiR7dGhpcy5jb25uZWN0b3IuZGF0YWJhc2V9XCIuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3dhcm4nLCBgRGF0YWJhc2UgXCIke3RoaXMuY29ubmVjdG9yLmRhdGFiYXNlfVwiIGV4aXN0cy5gKTtcbiAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIHJldHVybiBlYWNoQXN5bmNfKHNxbEZpbGVzLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNxbEZpbGUgPSBwYXRoLmpvaW4odGhpcy5kYlNjcmlwdFBhdGgsIGZpbGUpO1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNxbEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEYXRhYmFzZSBzY3JpcHQgXCIke3NxbEZpbGV9XCIgbm90IGZvdW5kLiBUcnkgcnVuIFwib29sb25nIGJ1aWxkXCIgZmlyc3QuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBzcWwgPSBfLnRyaW0oZnMucmVhZEZpbGVTeW5jKHNxbEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KSk7XG4gICAgICAgICAgICBpZiAoc3FsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gXy5jYXN0QXJyYXkoYXdhaXQgdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oc3FsLCBudWxsLCB7IG11bHRpcGxlU3RhdGVtZW50czogMSB9KSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgd2FybmluZ1Jvd3MgPSBfLnJlZHVjZShyZXN1bHQsIChzdW0sIHJvdykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzdW0gKz0gcm93Lndhcm5pbmdTdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzdW07XG4gICAgICAgICAgICAgICAgfSwgMCk7XG5cbiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1Jvd3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnd2FybicsIGAke3dhcm5pbmdSb3dzfSB3YXJuaW5nKHMpIHJlcG9ydGVkIHdoaWxlIHJ1bm5pbmcgXCIke2ZpbGV9XCIuYCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgYERhdGFiYXNlIHNjcmlwdHMgXCIke3NxbEZpbGV9XCIgcnVuIHN1Y2Nlc3NmdWxseS5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGxvYWRfKGRhdGFGaWxlKSB7XG4gICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZGF0YUZpbGUpO1xuXG4gICAgICAgIGlmIChleHQgPT09ICcuanNvbicpIHtcbiAgICAgICAgICAgIGxldCBkYXRhID0gZnMucmVhZEpzb25TeW5jKGRhdGFGaWxlLCB7ZW5jb2Rpbmc6ICd1dGY4J30pO1xuXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlOYW1lID0gcGF0aC5iYXNlbmFtZShkYXRhRmlsZSwgZXh0KTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkU2luZ2xlRW50aXR5UmVjb3Jkc18oZW50aXR5TmFtZSwgZGF0YSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRNdWx0aUVudGl0eVJlY29yZHNfKGRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGV4dCA9PT0gJy5zcWwnKSB7XG4gICAgICAgICAgICBsZXQgc3FsID0gZnMucmVhZEZpbGVTeW5jKGRhdGFGaWxlLCB7ZW5jb2Rpbmc6ICd1dGY4J30pO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKHNxbCwgbnVsbCwgeyBtdWx0aXBsZVN0YXRlbWVudHM6IDEgfSk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCBgRXhlY3V0ZWQgU1FMIGZpbGU6ICR7ZGF0YUZpbGV9YCwgcmVzdWx0KTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcueGxzeCcpIHtcblxuICAgICAgICAgICAgY29uc3QgRXhjZWwgPSByZXF1aXJlKCdleGNlbGpzJyk7XG4gICAgICAgICAgICBsZXQgd29ya2Jvb2sgPSBuZXcgRXhjZWwuV29ya2Jvb2soKTtcbiAgICAgICAgICAgIGF3YWl0IHdvcmtib29rLnhsc3gucmVhZEZpbGUoZGF0YUZpbGUpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBkYXRhID0ge307XG5cbiAgICAgICAgICAgIHdvcmtib29rLmVhY2hTaGVldCgod29ya3NoZWV0LCBzaGVldElkKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbEtleXM7XG5cbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IHdvcmtzaGVldC5uYW1lO1xuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlEYXRhID0gW107XG4gICAgICAgICAgICAgICAgZGF0YVtlbnRpdHlOYW1lXSA9IGVudGl0eURhdGE7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgd29ya3NoZWV0LmVhY2hSb3coZnVuY3Rpb24ocm93LCByb3dOdW1iZXIpIHsgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbEtleXMgPSBfLmRyb3Aocm93LnZhbHVlcyk7ICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlY29yZCA9IF8uZnJvbVBhaXJzKF8uemlwKGNvbEtleXMsIF8uZHJvcChyb3cudmFsdWVzKSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5RGF0YS5wdXNoKHJlY29yZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkTXVsdGlFbnRpdHlSZWNvcmRzXyhkYXRhKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgZGF0YSBmaWxlIGZvcm1hdC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkTXVsdGlFbnRpdHlSZWNvcmRzXyhkYXRhKSB7XG4gICAgICAgIGxldCBjbGFzc05hbWUgPSBwYXNjYWxDYXNlKHRoaXMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBEYiA9IHJlcXVpcmUocGF0aC5qb2luKHRoaXMubW9kZWxQYXRoLCBjbGFzc05hbWUpKTtcbiAgICAgICAgbGV0IGRiID0gbmV3IERiKHRoaXMuY29ubmVjdG9yLmNvbm5lY3Rpb25TdHJpbmcsIHRoaXMuY29ubmVjdG9yLm9wdGlvbnMpOyAgICBcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTA7Jyk7XG5cbiAgICAgICAgICAgIGF3YWl0IGVhY2hBc3luY18oZGF0YSwgYXN5bmMgKHJlY29yZHMsIGVudGl0eU5hbWUpID0+IHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gQXJyYXkuaXNBcnJheShyZWNvcmRzKSA/IHJlY29yZHMgOiBbIHJlY29yZHMgXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhpdGVtcywgaXRlbSA9PiBkYi5tb2RlbChlbnRpdHlOYW1lKS5jcmVhdGVfKGl0ZW0pKTsgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IGRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0xOycpO1xuICAgICAgICAgICAgYXdhaXQgZGIuY2xvc2VfKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZFNpbmdsZUVudGl0eVJlY29yZHNfKGVudGl0eU5hbWUsIGRhdGEpIHtcbiAgICAgICAgbGV0IGNsYXNzTmFtZSA9IHBhc2NhbENhc2UodGhpcy5zY2hlbWFOYW1lKTtcbiAgICAgICAgbGV0IERiID0gcmVxdWlyZShwYXRoLmpvaW4odGhpcy5tb2RlbFBhdGgsIGNsYXNzTmFtZSkpO1xuICAgICAgICBsZXQgZGIgPSBuZXcgRGIodGhpcy5jb25uZWN0b3IuY29ubmVjdGlvblN0cmluZywgdGhpcy5jb25uZWN0b3Iub3B0aW9ucyk7ICAgIFxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5jb25uZWN0b3IuZXhlY3V0ZV8oJ1NFVCBGT1JFSUdOX0tFWV9DSEVDS1M9MDsnKTtcblxuICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhkYXRhLCBpdGVtID0+IGRiLm1vZGVsKGVudGl0eU5hbWUpLmNyZWF0ZV8oaXRlbSkpOyAgXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IGRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0xOycpO1xuICAgICAgICAgICAgYXdhaXQgZGIuY2xvc2VfKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTXlTUUxNaWdyYXRpb247Il19