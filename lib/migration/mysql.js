"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  pascalCase,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(context, schemaName, connector) {
    this.logger = context.logger;
    this.modelPath = context.modelPath;
    this.scriptSourcePath = context.scriptSourcePath;
    this.schemaName = schemaName;
    this.connector = connector;
    this.dbScriptPath = path.join(this.scriptSourcePath, this.connector.driver, this.connector.database);
  }

  async reset_() {
    return this.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.connector.execute_(sqlCreate, [this.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.logger.log('info', `Created database "${this.connector.database}".`);
    } else {
      this.logger.log('warn', `Database "${this.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.logger.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.logger.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile) {
    let ext = path.extname(dataFile);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });
      await this._loadData_(data);
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.logger.log('verbose', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadData_(data);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async _loadData_(data) {
    let className = pascalCase(this.schemaName);

    let Db = require(path.join(this.modelPath, className));

    let db = new Db(this.connector.connectionString, this.connector.options);

    try {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let Model = db.model(entityName);
        let items = Array.isArray(records) ? records : [records];
        return eachAsync_(items, async item => {
          await Model.create_(item);
        });
      });
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    } catch (error) {
      throw error;
    } finally {
      await db.close_();
    }
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicGFzY2FsQ2FzZSIsInF1b3RlIiwiTXlTUUxNaWdyYXRpb24iLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJzY2hlbWFOYW1lIiwiY29ubmVjdG9yIiwibG9nZ2VyIiwibW9kZWxQYXRoIiwic2NyaXB0U291cmNlUGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwiZGIiLCJyZWR1Y2UiLCJyIiwidiIsImsiLCJ1cHBlckNhc2UiLCJ0b1N0cmluZyIsInJlc3VsdCIsIndhcm5pbmdTdGF0dXMiLCJsb2ciLCJmaWxlIiwic3FsRmlsZSIsImV4aXN0c1N5bmMiLCJFcnJvciIsInNxbCIsInRyaW0iLCJyZWFkRmlsZVN5bmMiLCJlbmNvZGluZyIsImNhc3RBcnJheSIsIm11bHRpcGxlU3RhdGVtZW50cyIsIndhcm5pbmdSb3dzIiwic3VtIiwicm93IiwibG9hZF8iLCJkYXRhRmlsZSIsImV4dCIsImV4dG5hbWUiLCJkYXRhIiwicmVhZEpzb25TeW5jIiwiX2xvYWREYXRhXyIsIkV4Y2VsIiwid29ya2Jvb2siLCJXb3JrYm9vayIsInhsc3giLCJyZWFkRmlsZSIsImVhY2hTaGVldCIsIndvcmtzaGVldCIsInNoZWV0SWQiLCJjb2xLZXlzIiwiZW50aXR5TmFtZSIsIm5hbWUiLCJlbnRpdHlEYXRhIiwiZWFjaFJvdyIsInJvd051bWJlciIsImRyb3AiLCJ2YWx1ZXMiLCJyZWNvcmQiLCJmcm9tUGFpcnMiLCJ6aXAiLCJwdXNoIiwiY2xhc3NOYW1lIiwiRGIiLCJjb25uZWN0aW9uU3RyaW5nIiwib3B0aW9ucyIsInJlY29yZHMiLCJNb2RlbCIsIm1vZGVsIiwiaXRlbXMiLCJBcnJheSIsImlzQXJyYXkiLCJpdGVtIiwiZXJyb3IiLCJjbG9zZV8iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUEsVUFBVDtBQUFxQkMsRUFBQUEsVUFBckI7QUFBaUNDLEVBQUFBO0FBQWpDLElBQTJDTCxPQUFPLENBQUMsVUFBRCxDQUF4RDs7QUFNQSxNQUFNTSxjQUFOLENBQXFCO0FBS2pCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVUMsVUFBVixFQUFzQkMsU0FBdEIsRUFBaUM7QUFDeEMsU0FBS0MsTUFBTCxHQUFjSCxPQUFPLENBQUNHLE1BQXRCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkosT0FBTyxDQUFDSSxTQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCTCxPQUFPLENBQUNLLGdCQUFoQztBQUNBLFNBQUtKLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLSSxZQUFMLEdBQW9CZixJQUFJLENBQUNnQixJQUFMLENBQVUsS0FBS0YsZ0JBQWYsRUFBaUMsS0FBS0gsU0FBTCxDQUFlTSxNQUFoRCxFQUF3RCxLQUFLTixTQUFMLENBQWVPLFFBQXZFLENBQXBCO0FBQ0g7O0FBRUQsUUFBTUMsTUFBTixHQUFlO0FBQ1gsV0FBTyxLQUFLUixTQUFMLENBQWVTLFFBQWYsQ0FBeUIsNEJBQXpCLEVBQXNELENBQUUsS0FBS1QsU0FBTCxDQUFlTyxRQUFqQixDQUF0RCxFQUFtRjtBQUFFRyxNQUFBQSxjQUFjLEVBQUU7QUFBbEIsS0FBbkYsQ0FBUDtBQUNIOztBQUVELFFBQU1DLE9BQU4sQ0FBY0MsWUFBZCxFQUE0QjtBQUN4QixRQUFJQyxRQUFRLEdBQUcsQ0FBRSxjQUFGLEVBQWtC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QixVQUFVLENBQUNrRCxJQUFELEVBQU8sT0FBTzJCLE9BQVAsRUFBZ0JmLFVBQWhCLEtBQStCO0FBQ2xELFlBQUlnQixLQUFLLEdBQUd2RCxFQUFFLENBQUN3RCxLQUFILENBQVNqQixVQUFULENBQVo7QUFDQSxZQUFJa0IsS0FBSyxHQUFHQyxLQUFLLENBQUNDLE9BQU4sQ0FBY0wsT0FBZCxJQUF5QkEsT0FBekIsR0FBbUMsQ0FBRUEsT0FBRixDQUEvQztBQUVBLGVBQU83RSxVQUFVLENBQUNnRixLQUFELEVBQVEsTUFBTUcsSUFBTixJQUFjO0FBQ25DLGdCQUFNTCxLQUFLLENBQUM1RCxPQUFOLENBQWNpRSxJQUFkLENBQU47QUFDSCxTQUZnQixDQUFqQjtBQUdILE9BUGUsQ0FBaEI7QUFTQSxZQUFNNUQsRUFBRSxDQUFDaEIsU0FBSCxDQUFhUyxRQUFiLENBQXNCLDJCQUF0QixDQUFOO0FBQ0gsS0FiRCxDQWFFLE9BQU9vRSxLQUFQLEVBQWM7QUFDWixZQUFNQSxLQUFOO0FBQ0gsS0FmRCxTQWVVO0FBQ04sWUFBTTdELEVBQUUsQ0FBQzhELE1BQUgsRUFBTjtBQUNIO0FBQ0o7O0FBbklnQjs7QUFzSXJCQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJwRixjQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgeyBfLCBmcywgZWFjaEFzeW5jXywgcGFzY2FsQ2FzZSwgcXVvdGUgfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbi8qKlxuICogTXlTUUwgbWlncmF0aW9uLlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIE15U1FMTWlncmF0aW9uIHtcbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0XG4gICAgICogQHBhcmFtIHtDb25uZWN0b3J9IGNvbm5lY3RvclxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGNvbnRleHQsIHNjaGVtYU5hbWUsIGNvbm5lY3Rvcikge1xuICAgICAgICB0aGlzLmxvZ2dlciA9IGNvbnRleHQubG9nZ2VyO1xuICAgICAgICB0aGlzLm1vZGVsUGF0aCA9IGNvbnRleHQubW9kZWxQYXRoO1xuICAgICAgICB0aGlzLnNjcmlwdFNvdXJjZVBhdGggPSBjb250ZXh0LnNjcmlwdFNvdXJjZVBhdGg7XG4gICAgICAgIHRoaXMuc2NoZW1hTmFtZSA9IHNjaGVtYU5hbWU7XG4gICAgICAgIHRoaXMuY29ubmVjdG9yID0gY29ubmVjdG9yO1xuXG4gICAgICAgIHRoaXMuZGJTY3JpcHRQYXRoID0gcGF0aC5qb2luKHRoaXMuc2NyaXB0U291cmNlUGF0aCwgdGhpcy5jb25uZWN0b3IuZHJpdmVyLCB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzZXRfKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0b3IuZXhlY3V0ZV8oYERST1AgREFUQUJBU0UgSUYgRVhJU1RTID8/YCwgWyB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSBdLCB7IGNyZWF0ZURhdGFiYXNlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZV8oZXh0cmFPcHRpb25zKSB7ICAgICAgICBcbiAgICAgICAgbGV0IHNxbEZpbGVzID0gWyAnZW50aXRpZXMuc3FsJywgJ3JlbGF0aW9ucy5zcWwnLCAncHJvY2VkdXJlcy5zcWwnIF07XG5cbiAgICAgICAgbGV0IHNxbENyZWF0ZSA9ICdDUkVBVEUgREFUQUJBU0UgSUYgTk9UIEVYSVNUUyA/Pyc7XG5cbiAgICAgICAgaWYgKGV4dHJhT3B0aW9ucyAmJiAhXy5pc0VtcHR5KGV4dHJhT3B0aW9ucy5kYikpIHtcbiAgICAgICAgICAgIHNxbENyZWF0ZSArPSAnICcgKyBfLnJlZHVjZShleHRyYU9wdGlvbnMuZGIsIChyLCB2LCBrKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHIgKyAnICcgKyBfLnVwcGVyQ2FzZShrKSArICcgJyArIHF1b3RlKHYudG9TdHJpbmcoKSwgJ1wiJyk7XG4gICAgICAgICAgICB9LCAnJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhzcWxDcmVhdGUsIFxuICAgICAgICAgICAgWyB0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZSBdLCBcbiAgICAgICAgICAgIHsgY3JlYXRlRGF0YWJhc2U6IHRydWUgfVxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgaWYgKHJlc3VsdC53YXJuaW5nU3RhdHVzID09IDApIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGBDcmVhdGVkIGRhdGFiYXNlIFwiJHt0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZX1cIi5gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnd2FybicsIGBEYXRhYmFzZSBcIiR7dGhpcy5jb25uZWN0b3IuZGF0YWJhc2V9XCIgZXhpc3RzLmApO1xuICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgcmV0dXJuIGVhY2hBc3luY18oc3FsRmlsZXMsIGFzeW5jIChmaWxlKSA9PiB7XG4gICAgICAgICAgICBsZXQgc3FsRmlsZSA9IHBhdGguam9pbih0aGlzLmRiU2NyaXB0UGF0aCwgZmlsZSk7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc3FsRmlsZSkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGFiYXNlIHNjcmlwdCBcIiR7c3FsRmlsZX1cIiBub3QgZm91bmQuIFRyeSBydW4gXCJvb2xvbmcgYnVpbGRcIiBmaXJzdC5gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHNxbCA9IF8udHJpbShmcy5yZWFkRmlsZVN5bmMoc3FsRmlsZSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKTtcbiAgICAgICAgICAgIGlmIChzcWwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBfLmNhc3RBcnJheShhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhzcWwsIG51bGwsIHsgbXVsdGlwbGVTdGF0ZW1lbnRzOiAxIH0pKTtcblxuICAgICAgICAgICAgICAgIGxldCB3YXJuaW5nUm93cyA9IF8ucmVkdWNlKHJlc3VsdCwgKHN1bSwgcm93KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN1bSArPSByb3cud2FybmluZ1N0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcblxuICAgICAgICAgICAgICAgIGlmICh3YXJuaW5nUm93cyA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCd3YXJuJywgYCR7d2FybmluZ1Jvd3N9IHdhcm5pbmcocykgcmVwb3J0ZWQgd2hpbGUgcnVubmluZyBcIiR7ZmlsZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ2luZm8nLCBgRGF0YWJhc2Ugc2NyaXB0cyBcIiR7c3FsRmlsZX1cIiBydW4gc3VjY2Vzc2Z1bGx5LmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9hZF8oZGF0YUZpbGUpIHtcbiAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShkYXRhRmlsZSk7XG5cbiAgICAgICAgaWYgKGV4dCA9PT0gJy5qc29uJykge1xuICAgICAgICAgICAgbGV0IGRhdGEgPSBmcy5yZWFkSnNvblN5bmMoZGF0YUZpbGUsIHtlbmNvZGluZzogJ3V0ZjgnfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWREYXRhXyhkYXRhKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcuc3FsJykge1xuICAgICAgICAgICAgbGV0IHNxbCA9IGZzLnJlYWRGaWxlU3luYyhkYXRhRmlsZSwge2VuY29kaW5nOiAndXRmOCd9KTtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhzcWwsIG51bGwsIHsgbXVsdGlwbGVTdGF0ZW1lbnRzOiAxIH0pO1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCd2ZXJib3NlJywgYEV4ZWN1dGVkIFNRTCBmaWxlOiAke2RhdGFGaWxlfWAsIHJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZXh0ID09PSAnLnhsc3gnKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IEV4Y2VsID0gcmVxdWlyZSgnZXhjZWxqcycpO1xuICAgICAgICAgICAgbGV0IHdvcmtib29rID0gbmV3IEV4Y2VsLldvcmtib29rKCk7XG4gICAgICAgICAgICBhd2FpdCB3b3JrYm9vay54bHN4LnJlYWRGaWxlKGRhdGFGaWxlKTsgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZGF0YSA9IHt9O1xuXG4gICAgICAgICAgICB3b3JrYm9vay5lYWNoU2hlZXQoKHdvcmtzaGVldCwgc2hlZXRJZCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb2xLZXlzO1xuXG4gICAgICAgICAgICAgICAgbGV0IGVudGl0eU5hbWUgPSB3b3Jrc2hlZXQubmFtZTtcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5RGF0YSA9IFtdO1xuICAgICAgICAgICAgICAgIGRhdGFbZW50aXR5TmFtZV0gPSBlbnRpdHlEYXRhO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHdvcmtzaGVldC5lYWNoUm93KGZ1bmN0aW9uKHJvdywgcm93TnVtYmVyKSB7ICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb2xLZXlzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xLZXlzID0gXy5kcm9wKHJvdy52YWx1ZXMpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZWNvcmQgPSBfLmZyb21QYWlycyhfLnppcChjb2xLZXlzLCBfLmRyb3Aocm93LnZhbHVlcykpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eURhdGEucHVzaChyZWNvcmQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZERhdGFfKGRhdGEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBkYXRhIGZpbGUgZm9ybWF0LicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWREYXRhXyhkYXRhKSB7XG4gICAgICAgIGxldCBjbGFzc05hbWUgPSBwYXNjYWxDYXNlKHRoaXMuc2NoZW1hTmFtZSk7XG4gICAgICAgIGxldCBEYiA9IHJlcXVpcmUocGF0aC5qb2luKHRoaXMubW9kZWxQYXRoLCBjbGFzc05hbWUpKTtcbiAgICAgICAgbGV0IGRiID0gbmV3IERiKHRoaXMuY29ubmVjdG9yLmNvbm5lY3Rpb25TdHJpbmcsIHRoaXMuY29ubmVjdG9yLm9wdGlvbnMpOyAgICAgICAgICAgIFxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5jb25uZWN0b3IuZXhlY3V0ZV8oJ1NFVCBGT1JFSUdOX0tFWV9DSEVDS1M9MDsnKTtcblxuICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhkYXRhLCBhc3luYyAocmVjb3JkcywgZW50aXR5TmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBNb2RlbCA9IGRiLm1vZGVsKGVudGl0eU5hbWUpOyAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGxldCBpdGVtcyA9IEFycmF5LmlzQXJyYXkocmVjb3JkcykgPyByZWNvcmRzIDogWyByZWNvcmRzIF07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhpdGVtcywgYXN5bmMgaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IE1vZGVsLmNyZWF0ZV8oaXRlbSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYXdhaXQgZGIuY29ubmVjdG9yLmV4ZWN1dGVfKCdTRVQgRk9SRUlHTl9LRVlfQ0hFQ0tTPTE7Jyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGF3YWl0IGRiLmNsb3NlXygpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE15U1FMTWlncmF0aW9uOyJdfQ==