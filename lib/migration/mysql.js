"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  pascalCase,
  quote
} = require('rk-utils');

class MySQLMigration {
  constructor(context, schemaName, connector) {
    this.logger = context.logger;
    this.modelPath = context.modelPath;
    this.scriptSourcePath = context.scriptSourcePath;
    this.schemaName = schemaName;
    this.connector = connector;
    this.dbScriptPath = path.join(this.scriptSourcePath, this.connector.driver, this.connector.database);
  }

  async reset_() {
    return this.connector.execute_(`DROP DATABASE IF EXISTS ??`, [this.connector.database], {
      createDatabase: true
    });
  }

  async create_(extraOptions) {
    let sqlFiles = ['entities.sql', 'relations.sql', 'procedures.sql'];
    let sqlCreate = 'CREATE DATABASE IF NOT EXISTS ??';

    if (extraOptions && !_.isEmpty(extraOptions.db)) {
      sqlCreate += ' ' + _.reduce(extraOptions.db, (r, v, k) => {
        return r + ' ' + _.upperCase(k) + ' ' + quote(v.toString(), '"');
      }, '');
    }

    let result = await this.connector.execute_(sqlCreate, [this.connector.database], {
      createDatabase: true
    });

    if (result.warningStatus == 0) {
      this.logger.log('info', `Created database "${this.connector.database}".`);
    } else {
      this.logger.log('warn', `Database "${this.connector.database}" exists.`);
    }

    return eachAsync_(sqlFiles, async file => {
      let sqlFile = path.join(this.dbScriptPath, file);

      if (!fs.existsSync(sqlFile)) {
        throw new Error(`Database script "${sqlFile}" not found. Try run "oolong build" first.`);
      }

      let sql = _.trim(fs.readFileSync(sqlFile, {
        encoding: 'utf8'
      }));

      if (sql) {
        result = _.castArray((await this.connector.execute_(sql, null, {
          multipleStatements: 1
        })));

        let warningRows = _.reduce(result, (sum, row) => {
          sum += row.warningStatus;
          return sum;
        }, 0);

        if (warningRows > 0) {
          this.logger.log('warn', `${warningRows} warning(s) reported while running "${file}".`);
        } else {
          this.logger.log('info', `Database scripts "${sqlFile}" run successfully.`);
        }
      }
    });
  }

  async load_(dataFile) {
    let ext = path.extname(dataFile);

    if (ext === '.json') {
      let data = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });
      await this._loadData_(data);
    } else if (ext === '.sql') {
      let sql = fs.readFileSync(dataFile, {
        encoding: 'utf8'
      });
      let result = await this.connector.execute_(sql, null, {
        multipleStatements: 1
      });
      this.logger.log('verbose', `Executed SQL file: ${dataFile}`, result);
    } else if (ext === '.xlsx') {
      const Excel = require('exceljs');

      let workbook = new Excel.Workbook();
      await workbook.xlsx.readFile(dataFile);
      let data = {};
      workbook.eachSheet((worksheet, sheetId) => {
        let colKeys;
        let entityName = worksheet.name;
        let entityData = [];
        data[entityName] = entityData;
        worksheet.eachRow(function (row, rowNumber) {
          console.log('Row ' + rowNumber + ' = ' + JSON.stringify(row.values));

          if (!colKeys) {
            colKeys = _.drop(row.values);
          } else {
            let record = _.fromPairs(_.zip(colKeys, _.drop(row.values)));

            entityData.push(record);
          }
        });
      });
      await this._loadData_(data);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async _loadData_(data) {
    let className = pascalCase(this.schemaName);

    let Db = require(path.join(this.modelPath, className));

    let db = new Db(this.connector.connectionString, this.connector.options);

    try {
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=0;');
      await eachAsync_(data, async (records, entityName) => {
        let Model = db.model(entityName);
        let items = Array.isArray(records) ? records : [records];
        return eachAsync_(items, async item => {
          let model = await Model.create_(item);
          this.logger.log('verbose', `Created a(n) ${entityName} entity: ${JSON.stringify(model.$pkValues)}`);
        });
      });
      await db.connector.execute_('SET FOREIGN_KEY_CHECKS=1;');
    } catch (error) {
      throw error;
    } finally {
      await db.close_();
    }
  }

}

module.exports = MySQLMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbXlzcWwuanMiXSwibmFtZXMiOlsicGF0aCIsInJlcXVpcmUiLCJfIiwiZnMiLCJlYWNoQXN5bmNfIiwicGFzY2FsQ2FzZSIsInF1b3RlIiwiTXlTUUxNaWdyYXRpb24iLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJzY2hlbWFOYW1lIiwiY29ubmVjdG9yIiwibG9nZ2VyIiwibW9kZWxQYXRoIiwic2NyaXB0U291cmNlUGF0aCIsImRiU2NyaXB0UGF0aCIsImpvaW4iLCJkcml2ZXIiLCJkYXRhYmFzZSIsInJlc2V0XyIsImV4ZWN1dGVfIiwiY3JlYXRlRGF0YWJhc2UiLCJjcmVhdGVfIiwiZXh0cmFPcHRpb25zIiwic3FsRmlsZXMiLCJzcWxDcmVhdGUiLCJpc0VtcHR5IiwiZGIiLCJyZWR1Y2UiLCJyIiwidiIsImsiLCJ1cHBlckNhc2UiLCJ0b1N0cmluZyIsInJlc3VsdCIsIndhcm5pbmdTdGF0dXMiLCJsb2ciLCJmaWxlIiwic3FsRmlsZSIsImV4aXN0c1N5bmMiLCJFcnJvciIsInNxbCIsInRyaW0iLCJyZWFkRmlsZVN5bmMiLCJlbmNvZGluZyIsImNhc3RBcnJheSIsIm11bHRpcGxlU3RhdGVtZW50cyIsIndhcm5pbmdSb3dzIiwic3VtIiwicm93IiwibG9hZF8iLCJkYXRhRmlsZSIsImV4dCIsImV4dG5hbWUiLCJkYXRhIiwicmVhZEpzb25TeW5jIiwiX2xvYWREYXRhXyIsIkV4Y2VsIiwid29ya2Jvb2siLCJXb3JrYm9vayIsInhsc3giLCJyZWFkRmlsZSIsImVhY2hTaGVldCIsIndvcmtzaGVldCIsInNoZWV0SWQiLCJjb2xLZXlzIiwiZW50aXR5TmFtZSIsIm5hbWUiLCJlbnRpdHlEYXRhIiwiZWFjaFJvdyIsInJvd051bWJlciIsImNvbnNvbGUiLCJKU09OIiwic3RyaW5naWZ5IiwidmFsdWVzIiwiZHJvcCIsInJlY29yZCIsImZyb21QYWlycyIsInppcCIsInB1c2giLCJjbGFzc05hbWUiLCJEYiIsImNvbm5lY3Rpb25TdHJpbmciLCJvcHRpb25zIiwicmVjb3JkcyIsIk1vZGVsIiwibW9kZWwiLCJpdGVtcyIsIkFycmF5IiwiaXNBcnJheSIsIml0ZW0iLCIkcGtWYWx1ZXMiLCJlcnJvciIsImNsb3NlXyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsRUFBTDtBQUFTQyxFQUFBQSxVQUFUO0FBQXFCQyxFQUFBQSxVQUFyQjtBQUFpQ0MsRUFBQUE7QUFBakMsSUFBMkNMLE9BQU8sQ0FBQyxVQUFELENBQXhEOztBQU1BLE1BQU1NLGNBQU4sQ0FBcUI7QUFLakJDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVQyxVQUFWLEVBQXNCQyxTQUF0QixFQUFpQztBQUN4QyxTQUFLQyxNQUFMLEdBQWNILE9BQU8sQ0FBQ0csTUFBdEI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCSixPQUFPLENBQUNJLFNBQXpCO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0JMLE9BQU8sQ0FBQ0ssZ0JBQWhDO0FBQ0EsU0FBS0osVUFBTCxHQUFrQkEsVUFBbEI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCQSxTQUFqQjtBQUVBLFNBQUtJLFlBQUwsR0FBb0JmLElBQUksQ0FBQ2dCLElBQUwsQ0FBVSxLQUFLRixnQkFBZixFQUFpQyxLQUFLSCxTQUFMLENBQWVNLE1BQWhELEVBQXdELEtBQUtOLFNBQUwsQ0FBZU8sUUFBdkUsQ0FBcEI7QUFDSDs7QUFFRCxRQUFNQyxNQUFOLEdBQWU7QUFDWCxXQUFPLEtBQUtSLFNBQUwsQ0FBZVMsUUFBZixDQUF5Qiw0QkFBekIsRUFBc0QsQ0FBRSxLQUFLVCxTQUFMLENBQWVPLFFBQWpCLENBQXRELEVBQW1GO0FBQUVHLE1BQUFBLGNBQWMsRUFBRTtBQUFsQixLQUFuRixDQUFQO0FBQ0g7O0FBRUQsUUFBTUMsT0FBTixDQUFjQyxZQUFkLEVB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XG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCBwYXNjYWxDYXNlLCBxdW90ZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuLyoqXG4gKiBNeVNRTCBtaWdyYXRpb24uXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgTXlTUUxNaWdyYXRpb24ge1xuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHRcbiAgICAgKiBAcGFyYW0ge0Nvbm5lY3Rvcn0gY29ubmVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoY29udGV4dCwgc2NoZW1hTmFtZSwgY29ubmVjdG9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyID0gY29udGV4dC5sb2dnZXI7XG4gICAgICAgIHRoaXMubW9kZWxQYXRoID0gY29udGV4dC5tb2RlbFBhdGg7XG4gICAgICAgIHRoaXMuc2NyaXB0U291cmNlUGF0aCA9IGNvbnRleHQuc2NyaXB0U291cmNlUGF0aDtcbiAgICAgICAgdGhpcy5zY2hlbWFOYW1lID0gc2NoZW1hTmFtZTtcbiAgICAgICAgdGhpcy5jb25uZWN0b3IgPSBjb25uZWN0b3I7XG5cbiAgICAgICAgdGhpcy5kYlNjcmlwdFBhdGggPSBwYXRoLmpvaW4odGhpcy5zY3JpcHRTb3VyY2VQYXRoLCB0aGlzLmNvbm5lY3Rvci5kcml2ZXIsIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyByZXNldF8oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3Rvci5leGVjdXRlXyhgRFJPUCBEQVRBQkFTRSBJRiBFWElTVFMgPz9gLCBbIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlIF0sIHsgY3JlYXRlRGF0YWJhc2U6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgY3JlYXRlXyhleHRyYU9wdGlvbnMpIHsgICAgICAgIFxuICAgICAgICBsZXQgc3FsRmlsZXMgPSBbICdlbnRpdGllcy5zcWwnLCAncmVsYXRpb25zLnNxbCcsICdwcm9jZWR1cmVzLnNxbCcgXTtcblxuICAgICAgICBsZXQgc3FsQ3JlYXRlID0gJ0NSRUFURSBEQVRBQkFTRSBJRiBOT1QgRVhJU1RTID8/JztcblxuICAgICAgICBpZiAoZXh0cmFPcHRpb25zICYmICFfLmlzRW1wdHkoZXh0cmFPcHRpb25zLmRiKSkge1xuICAgICAgICAgICAgc3FsQ3JlYXRlICs9ICcgJyArIF8ucmVkdWNlKGV4dHJhT3B0aW9ucy5kYiwgKHIsIHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gciArICcgJyArIF8udXBwZXJDYXNlKGspICsgJyAnICsgcXVvdGUodi50b1N0cmluZygpLCAnXCInKTtcbiAgICAgICAgICAgIH0sICcnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKHNxbENyZWF0ZSwgXG4gICAgICAgICAgICBbIHRoaXMuY29ubmVjdG9yLmRhdGFiYXNlIF0sIFxuICAgICAgICAgICAgeyBjcmVhdGVEYXRhYmFzZTogdHJ1ZSB9XG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICBpZiAocmVzdWx0Lndhcm5pbmdTdGF0dXMgPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCdpbmZvJywgYENyZWF0ZWQgZGF0YWJhc2UgXCIke3RoaXMuY29ubmVjdG9yLmRhdGFiYXNlfVwiLmApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCd3YXJuJywgYERhdGFiYXNlIFwiJHt0aGlzLmNvbm5lY3Rvci5kYXRhYmFzZX1cIiBleGlzdHMuYCk7XG4gICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICBcblxuICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhzcWxGaWxlcywgYXN5bmMgKGZpbGUpID0+IHtcbiAgICAgICAgICAgIGxldCBzcWxGaWxlID0gcGF0aC5qb2luKHRoaXMuZGJTY3JpcHRQYXRoLCBmaWxlKTtcbiAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhzcWxGaWxlKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRGF0YWJhc2Ugc2NyaXB0IFwiJHtzcWxGaWxlfVwiIG5vdCBmb3VuZC4gVHJ5IHJ1biBcIm9vbG9uZyBidWlsZFwiIGZpcnN0LmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgc3FsID0gXy50cmltKGZzLnJlYWRGaWxlU3luYyhzcWxGaWxlLCB7IGVuY29kaW5nOiAndXRmOCcgfSkpO1xuICAgICAgICAgICAgaWYgKHNxbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IF8uY2FzdEFycmF5KGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKHNxbCwgbnVsbCwgeyBtdWx0aXBsZVN0YXRlbWVudHM6IDEgfSkpO1xuXG4gICAgICAgICAgICAgICAgbGV0IHdhcm5pbmdSb3dzID0gXy5yZWR1Y2UocmVzdWx0LCAoc3VtLCByb3cpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgc3VtICs9IHJvdy53YXJuaW5nU3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3VtO1xuICAgICAgICAgICAgICAgIH0sIDApO1xuXG4gICAgICAgICAgICAgICAgaWYgKHdhcm5pbmdSb3dzID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3dhcm4nLCBgJHt3YXJuaW5nUm93c30gd2FybmluZyhzKSByZXBvcnRlZCB3aGlsZSBydW5uaW5nIFwiJHtmaWxlfVwiLmApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZygnaW5mbycsIGBEYXRhYmFzZSBzY3JpcHRzIFwiJHtzcWxGaWxlfVwiIHJ1biBzdWNjZXNzZnVsbHkuYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBsb2FkXyhkYXRhRmlsZSkge1xuICAgICAgICBsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGRhdGFGaWxlKTtcblxuICAgICAgICBpZiAoZXh0ID09PSAnLmpzb24nKSB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IGZzLnJlYWRKc29uU3luYyhkYXRhRmlsZSwge2VuY29kaW5nOiAndXRmOCd9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZERhdGFfKGRhdGEpO1xuICAgICAgICB9IGVsc2UgaWYgKGV4dCA9PT0gJy5zcWwnKSB7XG4gICAgICAgICAgICBsZXQgc3FsID0gZnMucmVhZEZpbGVTeW5jKGRhdGFGaWxlLCB7ZW5jb2Rpbmc6ICd1dGY4J30pO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKHNxbCwgbnVsbCwgeyBtdWx0aXBsZVN0YXRlbWVudHM6IDEgfSk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2coJ3ZlcmJvc2UnLCBgRXhlY3V0ZWQgU1FMIGZpbGU6ICR7ZGF0YUZpbGV9YCwgcmVzdWx0KTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcueGxzeCcpIHtcblxuICAgICAgICAgICAgY29uc3QgRXhjZWwgPSByZXF1aXJlKCdleGNlbGpzJyk7XG4gICAgICAgICAgICBsZXQgd29ya2Jvb2sgPSBuZXcgRXhjZWwuV29ya2Jvb2soKTtcbiAgICAgICAgICAgIGF3YWl0IHdvcmtib29rLnhsc3gucmVhZEZpbGUoZGF0YUZpbGUpOyAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBkYXRhID0ge307XG5cbiAgICAgICAgICAgIHdvcmtib29rLmVhY2hTaGVldCgod29ya3NoZWV0LCBzaGVldElkKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbEtleXM7XG5cbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5TmFtZSA9IHdvcmtzaGVldC5uYW1lO1xuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlEYXRhID0gW107XG4gICAgICAgICAgICAgICAgZGF0YVtlbnRpdHlOYW1lXSA9IGVudGl0eURhdGE7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgd29ya3NoZWV0LmVhY2hSb3coZnVuY3Rpb24ocm93LCByb3dOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1JvdyAnICsgcm93TnVtYmVyICsgJyA9ICcgKyBKU09OLnN0cmluZ2lmeShyb3cudmFsdWVzKSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbEtleXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbEtleXMgPSBfLmRyb3Aocm93LnZhbHVlcyk7ICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlY29yZCA9IF8uZnJvbVBhaXJzKF8uemlwKGNvbEtleXMsIF8uZHJvcChyb3cudmFsdWVzKSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZW50aXR5RGF0YS5wdXNoKHJlY29yZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkRGF0YV8oZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGRhdGEgZmlsZSBmb3JtYXQuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZERhdGFfKGRhdGEpIHtcbiAgICAgICAgbGV0IGNsYXNzTmFtZSA9IHBhc2NhbENhc2UodGhpcy5zY2hlbWFOYW1lKTtcbiAgICAgICAgbGV0IERiID0gcmVxdWlyZShwYXRoLmpvaW4odGhpcy5tb2RlbFBhdGgsIGNsYXNzTmFtZSkpO1xuICAgICAgICBsZXQgZGIgPSBuZXcgRGIodGhpcy5jb25uZWN0b3IuY29ubmVjdGlvblN0cmluZywgdGhpcy5jb25uZWN0b3Iub3B0aW9ucyk7ICAgICAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0wOycpO1xuXG4gICAgICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGRhdGEsIGFzeW5jIChyZWNvcmRzLCBlbnRpdHlOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IE1vZGVsID0gZGIubW9kZWwoZW50aXR5TmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gQXJyYXkuaXNBcnJheShyZWNvcmRzKSA/IHJlY29yZHMgOiBbIHJlY29yZHMgXTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlYWNoQXN5bmNfKGl0ZW1zLCBhc3luYyBpdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1vZGVsID0gYXdhaXQgTW9kZWwuY3JlYXRlXyhpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nKCd2ZXJib3NlJywgYENyZWF0ZWQgYShuKSAke2VudGl0eU5hbWV9IGVudGl0eTogJHtKU09OLnN0cmluZ2lmeShtb2RlbC4kcGtWYWx1ZXMpfWApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGRiLmNvbm5lY3Rvci5leGVjdXRlXygnU0VUIEZPUkVJR05fS0VZX0NIRUNLUz0xOycpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhd2FpdCBkYi5jbG9zZV8oKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNeVNRTE1pZ3JhdGlvbjsiXX0=