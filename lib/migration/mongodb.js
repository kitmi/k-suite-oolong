"use strict";

require("source-map-support/register");

const path = require('path');

const {
  _,
  fs,
  eachAsync_,
  pascalCase,
  quote
} = require('rk-utils');

class MongoDbMigration {
  constructor(context, schemaName, connector) {
    this.appModule = context.appModule;
    this.logger = context.logger;
    this.modelPath = context.modelPath;
    this.scriptSourcePath = context.scriptSourcePath;
    this.schemaName = schemaName;
    this.connector = connector;
    this.dbScriptPath = path.join(this.scriptSourcePath, this.connector.driver, this.connector.database);
  }

  async reset_() {
    return this.connector.execute_(db => db.dropDatabase());
  }

  async create_(extraOptions) {}

  async load_(dataFile) {
    let ext = path.extname(dataFile);
    let collection = path.basename(dataFile, ext);

    if (ext === '.json') {
      let docs = fs.readJsonSync(dataFile, {
        encoding: 'utf8'
      });
      await this._loadData_(collection, docs);
    } else if (ext === '.js') {
      let executor = require(dataFile);

      await executor(this.appModule, this.connector);
    } else {
      throw new Error('Unsupported data file format.');
    }
  }

  async _loadData_(collection, docs) {
    await eachAsync_(docs, doc => this.connector.insertOne_(collection, doc));
  }

}

module.exports = MongoDbMigration;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWdyYXRpb24vbW9uZ29kYi5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsIl8iLCJmcyIsImVhY2hBc3luY18iLCJwYXNjYWxDYXNlIiwicXVvdGUiLCJNb25nb0RiTWlncmF0aW9uIiwiY29uc3RydWN0b3IiLCJjb250ZXh0Iiwic2NoZW1hTmFtZSIsImNvbm5lY3RvciIsImFwcE1vZHVsZSIsImxvZ2dlciIsIm1vZGVsUGF0aCIsInNjcmlwdFNvdXJjZVBhdGgiLCJkYlNjcmlwdFBhdGgiLCJqb2luIiwiZHJpdmVyIiwiZGF0YWJhc2UiLCJyZXNldF8iLCJleGVjdXRlXyIsImRiIiwiZHJvcERhdGFiYXNlIiwiY3JlYXRlXyIsImV4dHJhT3B0aW9ucyIsImxvYWRfIiwiZGF0YUZpbGUiLCJleHQiLCJleHRuYW1lIiwiY29sbGVjdGlvbiIsImJhc2VuYW1lIiwiZG9jcyIsInJlYWRKc29uU3luYyIsImVuY29kaW5nIiwiX2xvYWREYXRhXyIsImV4ZWN1dG9yIiwiRXJyb3IiLCJkb2MiLCJpbnNlcnRPbmVfIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUMsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQSxFQUFMO0FBQVNDLEVBQUFBLFVBQVQ7QUFBcUJDLEVBQUFBLFVBQXJCO0FBQWlDQyxFQUFBQTtBQUFqQyxJQUEyQ0wsT0FBTyxDQUFDLFVBQUQsQ0FBeEQ7O0FBTUEsTUFBTU0sZ0JBQU4sQ0FBdUI7QUFLbkJDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVQyxVQUFWLEVBQXNCQyxTQUF0QixFQUFpQztBQUN4QyxTQUFLQyxTQUFMLEdBQWlCSCxPQUFPLENBQUNHLFNBQXpCO0FBQ0EsU0FBS0MsTUFBTCxHQUFjSixPQUFPLENBQUNJLE1BQXRCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkwsT0FBTyxDQUFDSyxTQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCTixPQUFPLENBQUNNLGdCQUFoQztBQUNBLFNBQUtMLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLSyxZQUFMLEdBQW9CaEIsSUFBSSxDQUFDaUIsSUFBTCxDQUFVLEtBQUtGLGdCQUFmLEVBQWlDLEtBQUtKLFNBQUwsQ0FBZU8sTUFBaEQsRUFBd0QsS0FBS1AsU0FBTCxDQUFlUSxRQUF2RSxDQUFwQjtBQUNIOztBQUVELFFBQU1DLE1BQU4sR0FBZTtBQUNYLFdBQU8sS0FBS1QsU0FBTCxDQUFlVSxRQUFmLENBQXdCQyxFQUFFLElBQUlBLEVBQUUsQ0FBQ0MsWUFBSCxFQUE5QixDQUFQO0FBQ0g7O0FBRUQsUUFBTUMsT0FBTixDQUFjQyxZQUFkLEVBQTRCLENBRTNCOztBQUVELFFBQU1DLEtBQU4sQ0FBWUMsUUFBWixFQUFzQjtBQUNsQixRQUFJQyxHQUFHLEdBQUc1QixJQUFJLENBQUM2QixPQUFMLENBQWFGLFFBQWIsQ0FBVjtBQUNBLFFBQUlHLFVBQVUsR0FBRzlCLElBQUksQ0FBQytCLFFBQUwsQ0FBY0osUUFBZCxFQUF3QkMsR0FBeEIsQ0FBakI7O0FBRUEsUUFBSUEsR0FBRyxLQUFLLE9BQVosRUFBcUI7QUFDakIsVUFBSUksSUFBSSxHQUFHN0IsRUFBRSxDQUFDOEIsWUFBSCxDQUFnQk4sUUFBaEIsRUFBMEI7QUFBQ08sUUFBQUEsUUFBUSxFQUFFO0FBQVgsT0FBMUIsQ0FBWDtBQUVBLFlBQU0sS0FBS0MsVUFBTCxDQUFnQkwsVUFBaEIsRUFBNEJFLElBQTVCLENBQU47QUFDSCxLQUpELE1BSU8sSUFBSUosR0FBRyxLQUFLLEtBQVosRUFBbUI7QUFDdEIsVUFBSVEsUUFBUSxHQUFHbkMsT0FBTyxDQUFDMEIsUUFBRCxDQUF0Qjs7QUFDQSxZQUFNUyxRQUFRLENBQUMsS0FBS3hCLFNBQU4sRUFBaUIsS0FBS0QsU0FBdEIsQ0FBZDtBQUNILEtBSE0sTUFHQTtBQUNILFlBQU0sSUFBSTBCLEtBQUosQ0FBVSwrQkFBVixDQUFOO0FBQ0g7QUFDSjs7QUFFRCxRQUFNRixVQUFOLENBQWlCTCxVQUFqQixFQUE2QkUsSUFBN0IsRUFBbUM7QUFDL0IsVUFBTTVCLFVBQVUsQ0FBQzRCLElBQUQsRUFBT00sR0FBRyxJQUFJLEtBQUszQixTQUFMLENBQWU0QixVQUFmLENBQTBCVCxVQUExQixFQUFzQ1EsR0FBdEMsQ0FBZCxDQUFoQjtBQUNIOztBQTFDa0I7O0FBNkN2QkUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbEMsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IF8sIGZzLCBlYWNoQXN5bmNfLCBwYXNjYWxDYXNlLCBxdW90ZSB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuLyoqXG4gKiBNeVNRTCBtaWdyYXRpb24uXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgTW9uZ29EYk1pZ3JhdGlvbiB7XG4gICAgLyoqICAgICBcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGV4dFxuICAgICAqIEBwYXJhbSB7Q29ubmVjdG9yfSBjb25uZWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBzY2hlbWFOYW1lLCBjb25uZWN0b3IpIHtcbiAgICAgICAgdGhpcy5hcHBNb2R1bGUgPSBjb250ZXh0LmFwcE1vZHVsZTtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBjb250ZXh0LmxvZ2dlcjtcbiAgICAgICAgdGhpcy5tb2RlbFBhdGggPSBjb250ZXh0Lm1vZGVsUGF0aDtcbiAgICAgICAgdGhpcy5zY3JpcHRTb3VyY2VQYXRoID0gY29udGV4dC5zY3JpcHRTb3VyY2VQYXRoO1xuICAgICAgICB0aGlzLnNjaGVtYU5hbWUgPSBzY2hlbWFOYW1lO1xuICAgICAgICB0aGlzLmNvbm5lY3RvciA9IGNvbm5lY3RvcjtcblxuICAgICAgICB0aGlzLmRiU2NyaXB0UGF0aCA9IHBhdGguam9pbih0aGlzLnNjcmlwdFNvdXJjZVBhdGgsIHRoaXMuY29ubmVjdG9yLmRyaXZlciwgdGhpcy5jb25uZWN0b3IuZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2V0XygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdG9yLmV4ZWN1dGVfKGRiID0+IGRiLmRyb3BEYXRhYmFzZSgpKTtcbiAgICB9XG5cbiAgICBhc3luYyBjcmVhdGVfKGV4dHJhT3B0aW9ucykgeyAgICAgICAgXG4gICAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIGxvYWRfKGRhdGFGaWxlKSB7XG4gICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZGF0YUZpbGUpO1xuICAgICAgICBsZXQgY29sbGVjdGlvbiA9IHBhdGguYmFzZW5hbWUoZGF0YUZpbGUsIGV4dCk7XG5cbiAgICAgICAgaWYgKGV4dCA9PT0gJy5qc29uJykge1xuICAgICAgICAgICAgbGV0IGRvY3MgPSBmcy5yZWFkSnNvblN5bmMoZGF0YUZpbGUsIHtlbmNvZGluZzogJ3V0ZjgnfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWREYXRhXyhjb2xsZWN0aW9uLCBkb2NzKTtcbiAgICAgICAgfSBlbHNlIGlmIChleHQgPT09ICcuanMnKSB7ICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBleGVjdXRvciA9IHJlcXVpcmUoZGF0YUZpbGUpO1xuICAgICAgICAgICAgYXdhaXQgZXhlY3V0b3IodGhpcy5hcHBNb2R1bGUsIHRoaXMuY29ubmVjdG9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgZGF0YSBmaWxlIGZvcm1hdC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkRGF0YV8oY29sbGVjdGlvbiwgZG9jcykgeyBcbiAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhkb2NzLCBkb2MgPT4gdGhpcy5jb25uZWN0b3IuaW5zZXJ0T25lXyhjb2xsZWN0aW9uLCBkb2MpKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTW9uZ29EYk1pZ3JhdGlvbjsiXX0=